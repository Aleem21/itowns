!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("$"),require("Geoportal")):"function"==typeof define&&define.amd?define("itowns",["$","Geoportal"],t):"object"==typeof exports?exports.itowns=t(require("$"),require("Geoportal")):e.itowns=t(e.$,e.Geoportal)}(this,function(e,t){return function(e){function t(i){if(r[i])return r[i].exports;var o=r[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var i,o;window.allInitialized=!1,i=[r(34),r(3),r(18),r(35)],o=function(e,t,r,i){t.init("containerITOWNS"),t.render(),i.init(),window.allInitialized=!0}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i;i=function(){var e={REVISION:"63"};return self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},e.extend=function(e,t){if(Object.keys)for(var r=Object.keys(t),i=0,o=r.length;o>i;i++){var n=r[i];Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}else{var a={}.hasOwnProperty;for(var n in t)a.call(t,n)&&(e[n]=t[n])}return e},function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!self.requestAnimationFrame;++r)self.requestAnimationFrame=self[t[r]+"RequestAnimationFrame"],self.cancelAnimationFrame=self[t[r]+"CancelAnimationFrame"]||self[t[r]+"CancelRequestAnimationFrame"];void 0===self.requestAnimationFrame&&void 0!==self.setTimeout&&(self.requestAnimationFrame=function(t){var r=Date.now(),i=Math.max(0,16-(r-e)),o=self.setTimeout(function(){t(r+i)},i);return e=r+i,o}),void 0===self.cancelAnimationFrame&&void 0!==self.clearTimeout&&(self.cancelAnimationFrame=function(e){self.clearTimeout(e)})}(),e.CullFaceNone=0,e.CullFaceBack=1,e.CullFaceFront=2,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=0,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=1,e.PCFSoftShadowMap=2,e.FrontSide=0,e.BackSide=1,e.DoubleSide=2,e.NoShading=0,e.FlatShading=1,e.SmoothShading=2,e.NoColors=0,e.FaceColors=1,e.VertexColors=2,e.NoBlending=0,e.NormalBlending=1,e.AdditiveBlending=2,e.SubtractiveBlending=3,e.MultiplyBlending=4,e.CustomBlending=5,e.AddEquation=100,e.SubtractEquation=101,e.ReverseSubtractEquation=102,e.ZeroFactor=200,e.OneFactor=201,e.SrcColorFactor=202,e.OneMinusSrcColorFactor=203,e.SrcAlphaFactor=204,e.OneMinusSrcAlphaFactor=205,e.DstAlphaFactor=206,e.OneMinusDstAlphaFactor=207,e.DstColorFactor=208,e.OneMinusDstColorFactor=209,e.SrcAlphaSaturateFactor=210,e.MultiplyOperation=0,e.MixOperation=1,e.AddOperation=2,e.UVMapping=function(){},e.CubeReflectionMapping=function(){},e.CubeRefractionMapping=function(){},e.SphericalReflectionMapping=function(){},e.SphericalRefractionMapping=function(){},e.RepeatWrapping=1e3,e.ClampToEdgeWrapping=1001,e.MirroredRepeatWrapping=1002,e.NearestFilter=1003,e.NearestMipMapNearestFilter=1004,e.NearestMipMapLinearFilter=1005,e.LinearFilter=1006,e.LinearMipMapNearestFilter=1007,e.LinearMipMapLinearFilter=1008,e.UnsignedByteType=1009,e.ByteType=1010,e.ShortType=1011,e.UnsignedShortType=1012,e.IntType=1013,e.UnsignedIntType=1014,e.FloatType=1015,e.UnsignedShort4444Type=1016,e.UnsignedShort5551Type=1017,e.UnsignedShort565Type=1018,e.AlphaFormat=1019,e.RGBFormat=1020,e.RGBAFormat=1021,e.LuminanceFormat=1022,e.LuminanceAlphaFormat=1023,e.RGB_S3TC_DXT1_Format=2001,e.RGBA_S3TC_DXT1_Format=2002,e.RGBA_S3TC_DXT3_Format=2003,e.RGBA_S3TC_DXT5_Format=2004,e.Color=function(e){return void 0!==e&&this.set(e),this},e.Color.prototype={constructor:e.Color,r:1,g:1,b:1,set:function(t){return t instanceof e.Color?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSL:function(e,t,r){if(0===t)this.r=this.g=this.b=r;else{var i=function(e,t,r){return 0>r&&(r+=1),r>1&&(r-=1),1/6>r?e+6*(t-e)*r:.5>r?t:2/3>r?e+6*(t-e)*(2/3-r):e},o=.5>=r?r*(1+t):r+t-r*t,n=2*r-o;this.r=i(n,o,e+1/3),this.g=i(n,o,e),this.b=i(n,o,e-1/3)}return this},setStyle:function(t){if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(t)){var r=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(t);return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,this}if(/^rgb\((\d+)\%, ?(\d+)\%, ?(\d+)\%\)$/i.test(t)){var r=/^rgb\((\d+)\%, ?(\d+)\%, ?(\d+)\%\)$/i.exec(t);return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,this}if(/^\#([0-9a-f]{6})$/i.test(t)){var r=/^\#([0-9a-f]{6})$/i.exec(t);return this.setHex(parseInt(r[1],16)),this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(t)){var r=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t);return this.setHex(parseInt(r[1]+r[1]+r[2]+r[2]+r[3]+r[3],16)),this}return/^(\w+)$/i.test(t)?(this.setHex(e.ColorKeywords[t]),this):void 0},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},convertGammaToLinear:function(){var e=this.r,t=this.g,r=this.b;return this.r=e*e,this.g=t*t,this.b=r*r,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(){var e={h:0,s:0,l:0};return function(){var t,r,i=this.r,o=this.g,n=this.b,a=Math.max(i,o,n),s=Math.min(i,o,n),l=(s+a)/2;if(s===a)t=0,r=0;else{var c=a-s;switch(r=.5>=l?c/(a+s):c/(2-a-s),a){case i:t=(o-n)/c+(n>o?6:0);break;case o:t=(n-i)/c+2;break;case n:t=(i-o)/c+4}t/=6}return e.h=t,e.s=r,e.l=l,e}}(),getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,r){var i=this.getHSL();return i.h+=e,i.s+=t,i.l+=r,this.setHSL(i.h,i.s,i.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e){return this.r=e[0],this.g=e[1],this.b=e[2],this},toArray:function(){return[this.r,this.g,this.b]},clone:function(){return(new e.Color).setRGB(this.r,this.g,this.b)}},e.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},e.Quaternion=function(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==i?i:1},e.Quaternion.prototype={constructor:e.Quaternion,_x:0,_y:0,_z:0,_w:0,_euler:void 0,_updateEuler:function(e){void 0!==this._euler&&this._euler.setFromQuaternion(this,void 0,!1)},get x(){return this._x},set x(e){this._x=e,this._updateEuler()},get y(){return this._y},set y(e){this._y=e,this._updateEuler()},get z(){return this._z},set z(e){this._z=e,this._updateEuler()},get w(){return this._w},set w(e){this._w=e,this._updateEuler()},set:function(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._w=i,this._updateEuler(),this},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._updateEuler(),this},setFromEuler:function(t,r){if(t instanceof e.Euler==!1)throw new Error("ERROR: Quaternion's .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");var i=Math.cos(t._x/2),o=Math.cos(t._y/2),n=Math.cos(t._z/2),a=Math.sin(t._x/2),s=Math.sin(t._y/2),l=Math.sin(t._z/2);return"XYZ"===t.order?(this._x=a*o*n+i*s*l,this._y=i*s*n-a*o*l,this._z=i*o*l+a*s*n,this._w=i*o*n-a*s*l):"YXZ"===t.order?(this._x=a*o*n+i*s*l,this._y=i*s*n-a*o*l,this._z=i*o*l-a*s*n,this._w=i*o*n+a*s*l):"ZXY"===t.order?(this._x=a*o*n-i*s*l,this._y=i*s*n+a*o*l,this._z=i*o*l+a*s*n,this._w=i*o*n-a*s*l):"ZYX"===t.order?(this._x=a*o*n-i*s*l,this._y=i*s*n+a*o*l,this._z=i*o*l-a*s*n,this._w=i*o*n+a*s*l):"YZX"===t.order?(this._x=a*o*n+i*s*l,this._y=i*s*n+a*o*l,this._z=i*o*l-a*s*n,this._w=i*o*n-a*s*l):"XZY"===t.order&&(this._x=a*o*n-i*s*l,this._y=i*s*n-a*o*l,this._z=i*o*l+a*s*n,this._w=i*o*n+a*s*l),r!==!1&&this._updateEuler(),this},setFromAxisAngle:function(e,t){var r=t/2,i=Math.sin(r);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(r),this._updateEuler(),this},setFromRotationMatrix:function(e){var t,r=e.elements,i=r[0],o=r[4],n=r[8],a=r[1],s=r[5],l=r[9],c=r[2],h=r[6],u=r[10],p=i+s+u;return p>0?(t=.5/Math.sqrt(p+1),this._w=.25/t,this._x=(h-l)*t,this._y=(n-c)*t,this._z=(a-o)*t):i>s&&i>u?(t=2*Math.sqrt(1+i-s-u),this._w=(h-l)/t,this._x=.25*t,this._y=(o+a)/t,this._z=(n+c)/t):s>u?(t=2*Math.sqrt(1+s-i-u),this._w=(n-c)/t,this._x=(o+a)/t,this._y=.25*t,this._z=(l+h)/t):(t=2*Math.sqrt(1+u-i-s),this._w=(a-o)/t,this._x=(n+c)/t,this._y=(l+h)/t,this._z=.25*t),this._updateEuler(),this},inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._updateEuler(),this},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this},multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},multiplyQuaternions:function(e,t){var r=e._x,i=e._y,o=e._z,n=e._w,a=t._x,s=t._y,l=t._z,c=t._w;return this._x=r*c+n*a+i*l-o*s,this._y=i*c+n*s+o*a-r*l,this._z=o*c+n*l+r*s-i*a,this._w=n*c-r*a-i*s-o*l,this._updateEuler(),this},multiplyVector3:function(e){return console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},slerp:function(e,t){var r=this._x,i=this._y,o=this._z,n=this._w,a=n*e._w+r*e._x+i*e._y+o*e._z;if(0>a?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=n,this._x=r,this._y=i,this._z=o,this;var s=Math.acos(a),l=Math.sqrt(1-a*a);if(Math.abs(l)<.001)return this._w=.5*(n+this._w),this._x=.5*(r+this._x),this._y=.5*(i+this._y),this._z=.5*(o+this._z),this;var c=Math.sin((1-t)*s)/l,h=Math.sin(t*s)/l;return this._w=n*c+this._w*h,this._x=r*c+this._x*h,this._y=i*c+this._y*h,this._z=o*c+this._z*h,this._updateEuler(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],this._w=e[3],this._updateEuler(),this},toArray:function(){return[this._x,this._y,this._z,this._w]},clone:function(){return new e.Quaternion(this._x,this._y,this._z,this._w)}},e.Quaternion.slerp=function(e,t,r,i){return r.copy(e).slerp(t,i)},e.Vector2=function(e,t){this.x=e||0,this.y=t||0},e.Vector2.prototype={constructor:e.Vector2,set:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScalar:function(e){return this.x+=e,this.y+=e,this},sub:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divideScalar:function(e){if(0!==e){var t=1/e;this.x*=t,this.y*=t}else this.x=0,this.y=0;return this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e){return this.x=e[0],this.y=e[1],this},toArray:function(){return[this.x,this.y]},clone:function(){return new e.Vector2(this.x,this.y)}},e.Vector3=function(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0},e.Vector3.prototype={constructor:e.Vector3,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},sub:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyMatrix3:function(e){var t=this.x,r=this.y,i=this.z,o=e.elements;return this.x=o[0]*t+o[3]*r+o[6]*i,this.y=o[1]*t+o[4]*r+o[7]*i,this.z=o[2]*t+o[5]*r+o[8]*i,this},applyMatrix4:function(e){var t=this.x,r=this.y,i=this.z,o=e.elements;return this.x=o[0]*t+o[4]*r+o[8]*i+o[12],this.y=o[1]*t+o[5]*r+o[9]*i+o[13],this.z=o[2]*t+o[6]*r+o[10]*i+o[14],this},applyProjection:function(e){var t=this.x,r=this.y,i=this.z,o=e.elements,n=1/(o[3]*t+o[7]*r+o[11]*i+o[15]);return this.x=(o[0]*t+o[4]*r+o[8]*i+o[12])*n,this.y=(o[1]*t+o[5]*r+o[9]*i+o[13])*n,this.z=(o[2]*t+o[6]*r+o[10]*i+o[14])*n,this},applyQuaternion:function(e){var t=this.x,r=this.y,i=this.z,o=e.x,n=e.y,a=e.z,s=e.w,l=s*t+n*i-a*r,c=s*r+a*t-o*i,h=s*i+o*r-n*t,u=-o*t-n*r-a*i;return this.x=l*s+u*-o+c*-a-h*-n,this.y=c*s+u*-n+h*-o-l*-a,this.z=h*s+u*-a+l*-n-c*-o,this},transformDirection:function(e){var t=this.x,r=this.y,i=this.z,o=e.elements;return this.x=o[0]*t+o[4]*r+o[8]*i,this.y=o[1]*t+o[5]*r+o[9]*i,this.z=o[2]*t+o[6]*r+o[10]*i,this.normalize(),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){if(0!==e){var t=1/e;this.x*=t,this.y*=t,this.z*=t}else this.x=0,this.y=0,this.z=0;return this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},cross:function(e,t){if(void 0!==t)return console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var r=this.x,i=this.y,o=this.z;return this.x=i*e.z-o*e.y,this.y=o*e.x-r*e.z,this.z=r*e.y-i*e.x,this},crossVectors:function(e,t){var r=e.x,i=e.y,o=e.z,n=t.x,a=t.y,s=t.z;return this.x=i*s-o*a,this.y=o*n-r*s,this.z=r*a-i*n,this},angleTo:function(t){var r=this.dot(t)/(this.length()*t.length());return Math.acos(e.Math.clamp(r,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return t*t+r*r+i*i},setEulerFromRotationMatrix:function(e,t){console.error("REMOVED: Vector3's setEulerFromRotationMatrix has been removed in favor of Euler.setFromRotationMatrix(), please update your code.")},setEulerFromQuaternion:function(e,t){console.error("REMOVED: Vector3's setEulerFromQuaternion: has been removed in favor of Euler.setFromQuaternion(), please update your code.")},getPositionFromMatrix:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},getScaleFromMatrix:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),r=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),i=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=r,this.z=i,this},getColumnFromMatrix:function(e,t){var r=4*e,i=t.elements;return this.x=i[r],this.y=i[r+1],this.z=i[r+2],this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e){return this.x=e[0],this.y=e[1],this.z=e[2],this},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new e.Vector3(this.x,this.y,this.z)}},e.extend(e.Vector3.prototype,{applyEuler:function(){var t=new e.Quaternion;return function(r){return r instanceof e.Euler==!1&&console.error("ERROR: Vector3's .applyEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code."),this.applyQuaternion(t.setFromEuler(r)),this}}(),applyAxisAngle:function(){var t=new e.Quaternion;return function(e,r){return this.applyQuaternion(t.setFromAxisAngle(e,r)),this}}(),projectOnVector:function(){var t=new e.Vector3;return function(e){t.copy(e).normalize();var r=this.dot(t);return this.copy(t).multiplyScalar(r)}}(),projectOnPlane:function(){var t=new e.Vector3;return function(e){return t.copy(this).projectOnVector(e),this.sub(t)}}(),reflect:function(){var t=new e.Vector3;return function(e){return t.copy(this).projectOnVector(e).multiplyScalar(2),this.subVectors(t,this)}}()}),e.Vector4=function(e,t,r,i){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==i?i:1},e.Vector4.prototype={constructor:e.Vector4,set:function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},sub:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,r=this.y,i=this.z,o=this.w,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*i+n[12]*o,this.y=n[1]*t+n[5]*r+n[9]*i+n[13]*o,this.z=n[2]*t+n[6]*r+n[10]*i+n[14]*o,this.w=n[3]*t+n[7]*r+n[11]*i+n[15]*o,this},divideScalar:function(e){if(0!==e){var t=1/e;this.x*=t,this.y*=t,this.z*=t,this.w*=t}else this.x=0,this.y=0,this.z=0,this.w=1;return this},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return 1e-4>t?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,r,i,o,n=.01,a=.1,s=e.elements,l=s[0],c=s[4],h=s[8],u=s[1],p=s[5],d=s[9],f=s[2],m=s[6],v=s[10];if(Math.abs(c-u)<n&&Math.abs(h-f)<n&&Math.abs(d-m)<n){if(Math.abs(c+u)<a&&Math.abs(h+f)<a&&Math.abs(d+m)<a&&Math.abs(l+p+v-3)<a)return this.set(1,0,0,0),this;t=Math.PI;var g=(l+1)/2,y=(p+1)/2,x=(v+1)/2,w=(c+u)/4,b=(h+f)/4,_=(d+m)/4;return g>y&&g>x?n>g?(r=0,i=.707106781,o=.707106781):(r=Math.sqrt(g),i=w/r,o=b/r):y>x?n>y?(r=.707106781,i=0,o=.707106781):(i=Math.sqrt(y),r=w/i,o=_/i):n>x?(r=.707106781,i=.707106781,o=0):(o=Math.sqrt(x),r=b/o,i=_/o),this.set(r,i,o,t),this}var M=Math.sqrt((m-d)*(m-d)+(h-f)*(h-f)+(u-c)*(u-c));return Math.abs(M)<.001&&(M=1),this.x=(m-d)/M,this.y=(h-f)/M,this.z=(u-c)/M,this.w=Math.acos((l+p+v-1)/2),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this.w>e.w&&(this.w=e.w),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this.w<e.w&&(this.w=e.w),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this.w<e.w?this.w=e.w:this.w>t.w&&(this.w=t.w),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e){return this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3],this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new e.Vector4(this.x,this.y,this.z,this.w)}},e.Euler=function(t,r,i,o){this._x=t||0,this._y=r||0,this._z=i||0,this._order=o||e.Euler.DefaultOrder},e.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],e.Euler.DefaultOrder="XYZ",e.Euler.prototype={constructor:e.Euler,_x:0,_y:0,_z:0,_order:e.Euler.DefaultOrder,_quaternion:void 0,_updateQuaternion:function(){void 0!==this._quaternion&&this._quaternion.setFromEuler(this,!1)},get x(){return this._x},set x(e){this._x=e,this._updateQuaternion()},get y(){return this._y},set y(e){this._y=e,this._updateQuaternion()},get z(){return this._z},set z(e){this._z=e,this._updateQuaternion()},get order(){return this._order},set order(e){this._order=e,this._updateQuaternion()},set:function(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._order=i||this._order,this._updateQuaternion(),this},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._updateQuaternion(),this},setFromRotationMatrix:function(e,t){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.elements,o=i[0],n=i[4],a=i[8],s=i[1],l=i[5],c=i[9],h=i[2],u=i[6],p=i[10];return t=t||this._order,"XYZ"===t?(this._y=Math.asin(r(a)),Math.abs(a)<.99999?(this._x=Math.atan2(-c,p),this._z=Math.atan2(-n,o)):(this._x=Math.atan2(u,l),this._z=0)):"YXZ"===t?(this._x=Math.asin(-r(c)),Math.abs(c)<.99999?(this._y=Math.atan2(a,p),this._z=Math.atan2(s,l)):(this._y=Math.atan2(-h,o),this._z=0)):"ZXY"===t?(this._x=Math.asin(r(u)),Math.abs(u)<.99999?(this._y=Math.atan2(-h,p),this._z=Math.atan2(-n,l)):(this._y=0,this._z=Math.atan2(s,o))):"ZYX"===t?(this._y=Math.asin(-r(h)),Math.abs(h)<.99999?(this._x=Math.atan2(u,p),this._z=Math.atan2(s,o)):(this._x=0,this._z=Math.atan2(-n,l))):"YZX"===t?(this._z=Math.asin(r(s)),Math.abs(s)<.99999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-h,o)):(this._x=0,this._y=Math.atan2(a,p))):"XZY"===t?(this._z=Math.asin(-r(n)),Math.abs(n)<.99999?(this._x=Math.atan2(u,l),this._y=Math.atan2(a,o)):(this._x=Math.atan2(-c,p),this._y=0)):console.warn("WARNING: Euler.setFromRotationMatrix() given unsupported order: "+t),this._order=t,this._updateQuaternion(),this},setFromQuaternion:function(e,t,r){function i(e){return Math.min(Math.max(e,-1),1)}var o=e.x*e.x,n=e.y*e.y,a=e.z*e.z,s=e.w*e.w;return t=t||this._order,"XYZ"===t?(this._x=Math.atan2(2*(e.x*e.w-e.y*e.z),s-o-n+a),this._y=Math.asin(i(2*(e.x*e.z+e.y*e.w))),this._z=Math.atan2(2*(e.z*e.w-e.x*e.y),s+o-n-a)):"YXZ"===t?(this._x=Math.asin(i(2*(e.x*e.w-e.y*e.z))),this._y=Math.atan2(2*(e.x*e.z+e.y*e.w),s-o-n+a),this._z=Math.atan2(2*(e.x*e.y+e.z*e.w),s-o+n-a)):"ZXY"===t?(this._x=Math.asin(i(2*(e.x*e.w+e.y*e.z))),this._y=Math.atan2(2*(e.y*e.w-e.z*e.x),s-o-n+a),this._z=Math.atan2(2*(e.z*e.w-e.x*e.y),s-o+n-a)):"ZYX"===t?(this._x=Math.atan2(2*(e.x*e.w+e.z*e.y),s-o-n+a),this._y=Math.asin(i(2*(e.y*e.w-e.x*e.z))),this._z=Math.atan2(2*(e.x*e.y+e.z*e.w),s+o-n-a)):"YZX"===t?(this._x=Math.atan2(2*(e.x*e.w-e.z*e.y),s-o+n-a),this._y=Math.atan2(2*(e.y*e.w-e.x*e.z),s+o-n-a),this._z=Math.asin(i(2*(e.x*e.y+e.z*e.w)))):"XZY"===t?(this._x=Math.atan2(2*(e.x*e.w+e.y*e.z),s-o+n-a),this._y=Math.atan2(2*(e.x*e.z+e.y*e.w),s+o-n-a),this._z=Math.asin(i(2*(e.z*e.w-e.x*e.y)))):console.warn("WARNING: Euler.setFromQuaternion() given unsupported order: "+t),this._order=t,r!==!1&&this._updateQuaternion(),this},reorder:function(){var t=new e.Quaternion;return function(e){t.setFromEuler(this),this.setFromQuaternion(t,e)}}(),fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._updateQuaternion(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},clone:function(){return new e.Euler(this._x,this._y,this._z,this._order)}},e.Line3=function(t,r){this.start=void 0!==t?t:new e.Vector3,this.end=void 0!==r?r:new e.Vector3},e.Line3.prototype={constructor:e.Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},center:function(t){var r=t||new e.Vector3;return r.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){var r=t||new e.Vector3;return r.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,r){var i=r||new e.Vector3;return this.delta(i).multiplyScalar(t).add(this.start)},closestPointToPointParameter:function(){var t=new e.Vector3,r=new e.Vector3;return function(i,o){t.subVectors(i,this.start),r.subVectors(this.end,this.start);var n=r.dot(r),a=r.dot(t),s=a/n;
return o&&(s=e.Math.clamp(s,0,1)),s}}(),closestPointToPoint:function(t,r,i){var o=this.closestPointToPointParameter(t,r),n=i||new e.Vector3;return this.delta(n).multiplyScalar(o).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)},clone:function(){return(new e.Line3).copy(this)}},e.Box2=function(t,r){this.min=void 0!==t?t:new e.Vector2(1/0,1/0),this.max=void 0!==r?r:new e.Vector2(-(1/0),-(1/0))},e.Box2.prototype={constructor:e.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var r=1,i=e.length;i>r;r++)t=e[r],t.x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var t=new e.Vector2;return function(e,r){var i=t.copy(r).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}}(),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-(1/0),this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(t){var r=t||new e.Vector2;return r.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){var r=t||new e.Vector2;return r.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y?!0:!1},getParameter:function(t){return new e.Vector2((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y?!1:!0},clampPoint:function(t,r){var i=r||new e.Vector2;return i.copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector2;return function(e){var r=t.copy(e).clamp(this.min,this.max);return r.sub(e).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new e.Box2).copy(this)}},e.Box3=function(t,r){this.min=void 0!==t?t:new e.Vector3(1/0,1/0,1/0),this.max=void 0!==r?r:new e.Vector3(-(1/0),-(1/0),-(1/0))},e.Box3.prototype={constructor:e.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},addPoint:function(e){e.x<this.min.x?this.min.x=e.x:e.x>this.max.x&&(this.max.x=e.x),e.y<this.min.y?this.min.y=e.y:e.y>this.max.y&&(this.max.y=e.y),e.z<this.min.z?this.min.z=e.z:e.z>this.max.z&&(this.max.z=e.z)},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var r=1,i=e.length;i>r;r++)this.addPoint(e[r])}else this.makeEmpty();return this},setFromCenterAndSize:function(){var t=new e.Vector3;return function(e,r){var i=t.copy(r).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}}(),setFromObject:function(){var t=new e.Vector3;return function(e){var r=this;return e.updateMatrixWorld(!0),this.makeEmpty(),e.traverse(function(e){if(void 0!==e.geometry&&void 0!==e.geometry.vertices)for(var i=e.geometry.vertices,o=0,n=i.length;n>o;o++)t.copy(i[o]),t.applyMatrix4(e.matrixWorld),r.expandByPoint(t)}),this}}(),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-(1/0),this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(t){var r=t||new e.Vector3;return r.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){var r=t||new e.Vector3;return r.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z?!0:!1},getParameter:function(t){return new e.Vector3((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z?!1:!0},clampPoint:function(t,r){var i=r||new e.Vector3;return i.copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector3;return function(e){var r=t.copy(e).clamp(this.min,this.max);return r.sub(e).length()}}(),getBoundingSphere:function(){var t=new e.Vector3;return function(r){var i=r||new e.Sphere;return i.center=this.center(),i.radius=.5*this.size(t).length(),i}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var t=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3];return function(e){return t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.makeEmpty(),this.setFromPoints(t),this}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new e.Box3).copy(this)}},e.Matrix3=function(e,t,r,i,o,n,a,s,l){this.elements=new Float32Array(9),this.set(void 0!==e?e:1,t||0,r||0,i||0,void 0!==o?o:1,n||0,a||0,s||0,void 0!==l?l:1)},e.Matrix3.prototype={constructor:e.Matrix3,set:function(e,t,r,i,o,n,a,s,l){var c=this.elements;return c[0]=e,c[3]=t,c[6]=r,c[1]=i,c[4]=o,c[7]=n,c[2]=a,c[5]=s,c[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},multiplyVector3:function(e){return console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(){var t=new e.Vector3;return function(e){for(var r=0,i=e.length;i>r;r+=3)t.x=e[r],t.y=e[r+1],t.z=e[r+2],t.applyMatrix3(this),e[r]=t.x,e[r+1]=t.y,e[r+2]=t.z;return e}}(),multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],r=e[1],i=e[2],o=e[3],n=e[4],a=e[5],s=e[6],l=e[7],c=e[8];return t*n*c-t*a*l-r*o*c+r*a*s+i*o*l-i*n*s},getInverse:function(e,t){var r=e.elements,i=this.elements;i[0]=r[10]*r[5]-r[6]*r[9],i[1]=-r[10]*r[1]+r[2]*r[9],i[2]=r[6]*r[1]-r[2]*r[5],i[3]=-r[10]*r[4]+r[6]*r[8],i[4]=r[10]*r[0]-r[2]*r[8],i[5]=-r[6]*r[0]+r[2]*r[4],i[6]=r[9]*r[4]-r[5]*r[8],i[7]=-r[9]*r[0]+r[1]*r[8],i[8]=r[5]*r[0]-r[1]*r[4];var o=r[0]*i[0]+r[1]*i[3]+r[2]*i[6];if(0===o){var n="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(n);return console.warn(n),this.identity(),this}return this.multiplyScalar(1/o),this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.getInverse(e).transpose(),this},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},clone:function(){var t=this.elements;return new e.Matrix3(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])}},e.Matrix4=function(e,t,r,i,o,n,a,s,l,c,h,u,p,d,f,m){this.elements=new Float32Array(16);var v=this.elements;v[0]=void 0!==e?e:1,v[4]=t||0,v[8]=r||0,v[12]=i||0,v[1]=o||0,v[5]=void 0!==n?n:1,v[9]=a||0,v[13]=s||0,v[2]=l||0,v[6]=c||0,v[10]=void 0!==h?h:1,v[14]=u||0,v[3]=p||0,v[7]=d||0,v[11]=f||0,v[15]=void 0!==m?m:1},e.Matrix4.prototype={constructor:e.Matrix4,set:function(e,t,r,i,o,n,a,s,l,c,h,u,p,d,f,m){var v=this.elements;return v[0]=e,v[4]=t,v[8]=r,v[12]=i,v[1]=o,v[5]=n,v[9]=a,v[13]=s,v[2]=l,v[6]=c,v[10]=h,v[14]=u,v[3]=p,v[7]=d,v[11]=f,v[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){return this.elements.set(e.elements),this},extractPosition:function(e){return console.warn("DEPRECATED: Matrix4's .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},copyPosition:function(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this},extractRotation:function(){var t=new e.Vector3;return function(e){var r=this.elements,i=e.elements,o=1/t.set(i[0],i[1],i[2]).length(),n=1/t.set(i[4],i[5],i[6]).length(),a=1/t.set(i[8],i[9],i[10]).length();return r[0]=i[0]*o,r[1]=i[1]*o,r[2]=i[2]*o,r[4]=i[4]*n,r[5]=i[5]*n,r[6]=i[6]*n,r[8]=i[8]*a,r[9]=i[9]*a,r[10]=i[10]*a,this}}(),makeRotationFromEuler:function(t){t instanceof e.Euler==!1&&console.error("ERROR: Matrix's .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");var r=this.elements,i=t.x,o=t.y,n=t.z,a=Math.cos(i),s=Math.sin(i),l=Math.cos(o),c=Math.sin(o),h=Math.cos(n),u=Math.sin(n);if("XYZ"===t.order){var p=a*h,d=a*u,f=s*h,m=s*u;r[0]=l*h,r[4]=-l*u,r[8]=c,r[1]=d+f*c,r[5]=p-m*c,r[9]=-s*l,r[2]=m-p*c,r[6]=f+d*c,r[10]=a*l}else if("YXZ"===t.order){var v=l*h,g=l*u,y=c*h,x=c*u;r[0]=v+x*s,r[4]=y*s-g,r[8]=a*c,r[1]=a*u,r[5]=a*h,r[9]=-s,r[2]=g*s-y,r[6]=x+v*s,r[10]=a*l}else if("ZXY"===t.order){var v=l*h,g=l*u,y=c*h,x=c*u;r[0]=v-x*s,r[4]=-a*u,r[8]=y+g*s,r[1]=g+y*s,r[5]=a*h,r[9]=x-v*s,r[2]=-a*c,r[6]=s,r[10]=a*l}else if("ZYX"===t.order){var p=a*h,d=a*u,f=s*h,m=s*u;r[0]=l*h,r[4]=f*c-d,r[8]=p*c+m,r[1]=l*u,r[5]=m*c+p,r[9]=d*c-f,r[2]=-c,r[6]=s*l,r[10]=a*l}else if("YZX"===t.order){var w=a*l,b=a*c,_=s*l,M=s*c;r[0]=l*h,r[4]=M-w*u,r[8]=_*u+b,r[1]=u,r[5]=a*h,r[9]=-s*h,r[2]=-c*h,r[6]=b*u+_,r[10]=w-M*u}else if("XZY"===t.order){var w=a*l,b=a*c,_=s*l,M=s*c;r[0]=l*h,r[4]=-u,r[8]=c*h,r[1]=w*u+M,r[5]=a*h,r[9]=b*u-_,r[2]=_*u-b,r[6]=s*h,r[10]=M*u+w}return r[3]=0,r[7]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,this},setRotationFromQuaternion:function(e){return console.warn("DEPRECATED: Matrix4's .setRotationFromQuaternion() has been deprecated in favor of makeRotationFromQuaternion.  Please update your code."),this.makeRotationFromQuaternion(e)},makeRotationFromQuaternion:function(e){var t=this.elements,r=e.x,i=e.y,o=e.z,n=e.w,a=r+r,s=i+i,l=o+o,c=r*a,h=r*s,u=r*l,p=i*s,d=i*l,f=o*l,m=n*a,v=n*s,g=n*l;return t[0]=1-(p+f),t[4]=h-g,t[8]=u+v,t[1]=h+g,t[5]=1-(c+f),t[9]=d-m,t[2]=u-v,t[6]=d+m,t[10]=1-(c+p),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var t=new e.Vector3,r=new e.Vector3,i=new e.Vector3;return function(e,o,n){var a=this.elements;return i.subVectors(e,o).normalize(),0===i.length()&&(i.z=1),t.crossVectors(n,i).normalize(),0===t.length()&&(i.x+=1e-4,t.crossVectors(n,i).normalize()),r.crossVectors(i,t),a[0]=t.x,a[4]=r.x,a[8]=i.x,a[1]=t.y,a[5]=r.y,a[9]=i.y,a[2]=t.z,a[6]=r.z,a[10]=i.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var r=e.elements,i=t.elements,o=this.elements,n=r[0],a=r[4],s=r[8],l=r[12],c=r[1],h=r[5],u=r[9],p=r[13],d=r[2],f=r[6],m=r[10],v=r[14],g=r[3],y=r[7],x=r[11],w=r[15],b=i[0],_=i[4],M=i[8],S=i[12],T=i[1],C=i[5],L=i[9],A=i[13],P=i[2],D=i[6],F=i[10],E=i[14],V=i[3],R=i[7],z=i[11],I=i[15];return o[0]=n*b+a*T+s*P+l*V,o[4]=n*_+a*C+s*D+l*R,o[8]=n*M+a*L+s*F+l*z,o[12]=n*S+a*A+s*E+l*I,o[1]=c*b+h*T+u*P+p*V,o[5]=c*_+h*C+u*D+p*R,o[9]=c*M+h*L+u*F+p*z,o[13]=c*S+h*A+u*E+p*I,o[2]=d*b+f*T+m*P+v*V,o[6]=d*_+f*C+m*D+v*R,o[10]=d*M+f*L+m*F+v*z,o[14]=d*S+f*A+m*E+v*I,o[3]=g*b+y*T+x*P+w*V,o[7]=g*_+y*C+x*D+w*R,o[11]=g*M+y*L+x*F+w*z,o[15]=g*S+y*A+x*E+w*I,this},multiplyToArray:function(e,t,r){var i=this.elements;return this.multiplyMatrices(e,t),r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=i[3],r[4]=i[4],r[5]=i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8],r[9]=i[9],r[10]=i[10],r[11]=i[11],r[12]=i[12],r[13]=i[13],r[14]=i[14],r[15]=i[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(){var t=new e.Vector3;return function(e){for(var r=0,i=e.length;i>r;r+=3)t.x=e[r],t.y=e[r+1],t.z=e[r+2],t.applyProjection(this),e[r]=t.x,e[r+1]=t.y,e[r+2]=t.z;return e}}(),rotateAxis:function(e){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("DEPRECATED: Matrix4's .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},determinant:function(){var e=this.elements,t=e[0],r=e[4],i=e[8],o=e[12],n=e[1],a=e[5],s=e[9],l=e[13],c=e[2],h=e[6],u=e[10],p=e[14],d=e[3],f=e[7],m=e[11],v=e[15];return d*(+o*s*h-i*l*h-o*a*u+r*l*u+i*a*p-r*s*p)+f*(+t*s*p-t*l*u+o*n*u-i*n*p+i*l*c-o*s*c)+m*(+t*l*h-t*a*p-o*n*h+r*n*p+o*a*c-r*l*c)+v*(-i*a*c-t*s*h+t*a*u+i*n*h-r*n*u+r*s*c)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},flattenToArrayOffset:function(e,t){var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e},getPosition:function(){var t=new e.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var e=this.elements;return t.set(e[12],e[13],e[14])}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var r=this.elements,i=e.elements,o=i[0],n=i[4],a=i[8],s=i[12],l=i[1],c=i[5],h=i[9],u=i[13],p=i[2],d=i[6],f=i[10],m=i[14],v=i[3],g=i[7],y=i[11],x=i[15];r[0]=h*m*g-u*f*g+u*d*y-c*m*y-h*d*x+c*f*x,r[4]=s*f*g-a*m*g-s*d*y+n*m*y+a*d*x-n*f*x,r[8]=a*u*g-s*h*g+s*c*y-n*u*y-a*c*x+n*h*x,r[12]=s*h*d-a*u*d-s*c*f+n*u*f+a*c*m-n*h*m,r[1]=u*f*v-h*m*v-u*p*y+l*m*y+h*p*x-l*f*x,r[5]=a*m*v-s*f*v+s*p*y-o*m*y-a*p*x+o*f*x,r[9]=s*h*v-a*u*v-s*l*y+o*u*y+a*l*x-o*h*x,r[13]=a*u*p-s*h*p+s*l*f-o*u*f-a*l*m+o*h*m,r[2]=c*m*v-u*d*v+u*p*g-l*m*g-c*p*x+l*d*x,r[6]=s*d*v-n*m*v-s*p*g+o*m*g+n*p*x-o*d*x,r[10]=n*u*v-s*c*v+s*l*g-o*u*g-n*l*x+o*c*x,r[14]=s*c*p-n*u*p-s*l*d+o*u*d+n*l*m-o*c*m,r[3]=h*d*v-c*f*v-h*p*g+l*f*g+c*p*y-l*d*y,r[7]=n*f*v-a*d*v+a*p*g-o*f*g-n*p*y+o*d*y,r[11]=a*c*v-n*h*v-a*l*g+o*h*g+n*l*y-o*c*y,r[15]=n*h*p-a*c*p+a*l*d-o*h*d-n*l*f+o*c*f;var w=o*r[0]+l*r[4]+p*r[8]+v*r[12];if(0==w){var b="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(b);return console.warn(b),this.identity(),this}return this.multiplyScalar(1/w),this},translate:function(e){console.warn("DEPRECATED: Matrix4's .translate() has been removed.")},rotateX:function(e){console.warn("DEPRECATED: Matrix4's .rotateX() has been removed.")},rotateY:function(e){console.warn("DEPRECATED: Matrix4's .rotateY() has been removed.")},rotateZ:function(e){console.warn("DEPRECATED: Matrix4's .rotateZ() has been removed.")},rotateByAxis:function(e,t){console.warn("DEPRECATED: Matrix4's .rotateByAxis() has been removed.")},scale:function(e){var t=this.elements,r=e.x,i=e.y,o=e.z;return t[0]*=r,t[4]*=i,t[8]*=o,t[1]*=r,t[5]*=i,t[9]*=o,t[2]*=r,t[6]*=i,t[10]*=o,t[3]*=r,t[7]*=i,t[11]*=o,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(r,i)))},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var r=Math.cos(t),i=Math.sin(t),o=1-r,n=e.x,a=e.y,s=e.z,l=o*n,c=o*a;return this.set(l*n+r,l*a-i*s,l*s+i*a,0,l*a+i*s,c*a+r,c*s-i*n,0,l*s-i*a,c*s+i*n,o*s*s+r,0,0,0,0,1),this},makeScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},compose:function(e,t,r){return this.makeRotationFromQuaternion(t),this.scale(r),this.setPosition(e),this},decompose:function(){var t=new e.Vector3,r=new e.Matrix4;return function(e,i,o){var n=this.elements,a=t.set(n[0],n[1],n[2]).length(),s=t.set(n[4],n[5],n[6]).length(),l=t.set(n[8],n[9],n[10]).length();e.x=n[12],e.y=n[13],e.z=n[14],r.elements.set(this.elements);var c=1/a,h=1/s,u=1/l;return r.elements[0]*=c,r.elements[1]*=c,r.elements[2]*=c,r.elements[4]*=h,r.elements[5]*=h,r.elements[6]*=h,r.elements[8]*=u,r.elements[9]*=u,r.elements[10]*=u,i.setFromRotationMatrix(r),o.x=a,o.y=s,o.z=l,this}}(),makeFrustum:function(e,t,r,i,o,n){var a=this.elements,s=2*o/(t-e),l=2*o/(i-r),c=(t+e)/(t-e),h=(i+r)/(i-r),u=-(n+o)/(n-o),p=-2*n*o/(n-o);return a[0]=s,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=l,a[9]=h,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makePerspective:function(t,r,i,o){var n=i*Math.tan(e.Math.degToRad(.5*t)),a=-n,s=a*r,l=n*r;return this.makeFrustum(s,l,a,n,i,o)},makeOrthographic:function(e,t,r,i,o,n){var a=this.elements,s=t-e,l=r-i,c=n-o,h=(t+e)/s,u=(r+i)/l,p=(n+o)/c;return a[0]=2/s,a[4]=0,a[8]=0,a[12]=-h,a[1]=0,a[5]=2/l,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2/c,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},fromArray:function(e){return this.elements.set(e),this},toArray:function(){var e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]},clone:function(){var t=this.elements;return new e.Matrix4(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}},e.Ray=function(t,r){this.origin=void 0!==t?t:new e.Vector3,this.direction=void 0!==r?r:new e.Vector3},e.Ray.prototype={constructor:e.Ray,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(t,r){var i=r||new e.Vector3;return i.copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var t=new e.Vector3;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,r){var i=r||new e.Vector3;i.subVectors(t,this.origin);var o=i.dot(this.direction);return 0>o?i.copy(this.origin):i.copy(this.direction).multiplyScalar(o).add(this.origin)},distanceToPoint:function(){var t=new e.Vector3;return function(e){var r=t.subVectors(e,this.origin).dot(this.direction);return 0>r?this.origin.distanceTo(e):(t.copy(this.direction).multiplyScalar(r).add(this.origin),t.distanceTo(e))}}(),distanceSqToSegment:function(e,t,r,i){var o,n,a,s,l=e.clone().add(t).multiplyScalar(.5),c=t.clone().sub(e).normalize(),h=.5*e.distanceTo(t),u=this.origin.clone().sub(l),p=-this.direction.dot(c),d=u.dot(this.direction),f=-u.dot(c),m=u.lengthSq(),v=Math.abs(1-p*p);if(v>=0)if(o=p*f-d,n=p*d-f,s=h*v,o>=0)if(n>=-s)if(s>=n){var g=1/v;o*=g,n*=g,a=o*(o+p*n+2*d)+n*(p*o+n+2*f)+m}else n=h,o=Math.max(0,-(p*n+d)),a=-o*o+n*(n+2*f)+m;else n=-h,o=Math.max(0,-(p*n+d)),a=-o*o+n*(n+2*f)+m;else-s>=n?(o=Math.max(0,-(-p*h+d)),n=o>0?-h:Math.min(Math.max(-h,-f),h),a=-o*o+n*(n+2*f)+m):s>=n?(o=0,n=Math.min(Math.max(-h,-f),h),a=n*(n+2*f)+m):(o=Math.max(0,-(p*h+d)),n=o>0?h:Math.min(Math.max(-h,-f),h),a=-o*o+n*(n+2*f)+m);else n=p>0?-h:h,o=Math.max(0,-(p*n+d)),a=-o*o+n*(n+2*f)+m;return r&&r.copy(this.direction.clone().multiplyScalar(o).add(this.origin)),i&&i.copy(c.clone().multiplyScalar(n).add(l)),a},isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){var t=e.distanceToPoint(this.origin);if(0===t)return!0;var r=e.normal.dot(this.direction);return 0>r*t?!0:!1},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0==t)return 0==e.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null},intersectPlane:function(e,t){var r=this.distanceToPlane(e);return null===r?null:this.at(r,t)},isIntersectionBox:function(){var t=new e.Vector3;return function(e){return null!==this.intersectBox(e,t)}}(),intersectBox:function(e,t){var r,i,o,n,a,s,l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(r=(e.min.x-u.x)*l,i=(e.max.x-u.x)*l):(r=(e.max.x-u.x)*l,i=(e.min.x-u.x)*l),c>=0?(o=(e.min.y-u.y)*c,n=(e.max.y-u.y)*c):(o=(e.max.y-u.y)*c,n=(e.min.y-u.y)*c),r>n||o>i?null:((o>r||r!==r)&&(r=o),(i>n||i!==i)&&(i=n),h>=0?(a=(e.min.z-u.z)*h,s=(e.max.z-u.z)*h):(a=(e.max.z-u.z)*h,s=(e.min.z-u.z)*h),r>s||a>i?null:((a>r||r!==r)&&(r=a),(i>s||i!==i)&&(i=s),0>i?null:this.at(r>=0?r:i,t)))},intersectTriangle:function(){var t=new e.Vector3,r=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e,n,a,s,l){r.subVectors(n,e),i.subVectors(a,e),o.crossVectors(r,i);var c,h=this.direction.dot(o);if(h>0){if(s)return null;c=1}else{if(!(0>h))return null;c=-1,h=-h}t.subVectors(this.origin,e);var u=c*this.direction.dot(i.crossVectors(t,i));if(0>u)return null;var p=c*this.direction.dot(r.cross(t));if(0>p)return null;if(u+p>h)return null;var d=-c*t.dot(o);return 0>d?null:this.at(d/h,l)}}(),applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new e.Ray).copy(this)}},e.Sphere=function(t,r){this.center=void 0!==t?t:new e.Vector3,this.radius=void 0!==r?r:0},e.Sphere.prototype={constructor:e.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var t=new e.Box3;return function(e,r){var i=this.center;void 0!==r?i.copy(r):t.setFromPoints(e).center(i);for(var o=0,n=0,a=e.length;a>n;n++)o=Math.max(o,i.distanceToSquared(e[n]));return this.radius=Math.sqrt(o),this}}(),copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},clampPoint:function(t,r){var i=this.center.distanceToSquared(t),o=r||new e.Vector3;return o.copy(t),i>this.radius*this.radius&&(o.sub(this.center).normalize(),o.multiplyScalar(this.radius).add(this.center)),o},getBoundingBox:function(t){var r=t||new e.Box3;return r.set(this.center,this.center),r.expandByScalar(this.radius),r},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new e.Sphere).copy(this)}},e.Frustum=function(t,r,i,o,n,a){this.planes=[void 0!==t?t:new e.Plane,void 0!==r?r:new e.Plane,void 0!==i?i:new e.Plane,void 0!==o?o:new e.Plane,void 0!==n?n:new e.Plane,void 0!==a?a:new e.Plane]},e.Frustum.prototype={constructor:e.Frustum,set:function(e,t,r,i,o,n){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(r),a[3].copy(i),a[4].copy(o),a[5].copy(n),this},copy:function(e){for(var t=this.planes,r=0;6>r;r++)t[r].copy(e.planes[r]);return this},setFromMatrix:function(e){var t=this.planes,r=e.elements,i=r[0],o=r[1],n=r[2],a=r[3],s=r[4],l=r[5],c=r[6],h=r[7],u=r[8],p=r[9],d=r[10],f=r[11],m=r[12],v=r[13],g=r[14],y=r[15];return t[0].setComponents(a-i,h-s,f-u,y-m).normalize(),t[1].setComponents(a+i,h+s,f+u,y+m).normalize(),t[2].setComponents(a+o,h+l,f+p,y+v).normalize(),t[3].setComponents(a-o,h-l,f-p,y-v).normalize(),t[4].setComponents(a-n,h-c,f-d,y-g).normalize(),t[5].setComponents(a+n,h+c,f+d,y+g).normalize(),this},intersectsObject:function(){var t=new e.Sphere;return function(e){var r=e.geometry;return null===r.boundingSphere&&r.computeBoundingSphere(),t.copy(r.boundingSphere),t.applyMatrix4(e.matrixWorld),this.intersectsSphere(t)}}(),intersectsSphere:function(e){for(var t=this.planes,r=e.center,i=-e.radius,o=0;6>o;o++){var n=t[o].distanceToPoint(r);if(i>n)return!1}return!0},intersectsBox:function(){var t=new e.Vector3,r=new e.Vector3;return function(e){for(var i=this.planes,o=0;6>o;o++){var n=i[o];t.x=n.normal.x>0?e.min.x:e.max.x,r.x=n.normal.x>0?e.max.x:e.min.x,t.y=n.normal.y>0?e.min.y:e.max.y,r.y=n.normal.y>0?e.max.y:e.min.y,t.z=n.normal.z>0?e.min.z:e.max.z,r.z=n.normal.z>0?e.max.z:e.min.z;var a=n.distanceToPoint(t),s=n.distanceToPoint(r);if(0>a&&0>s)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,r=0;6>r;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0},clone:function(){return(new e.Frustum).copy(this)}},e.Plane=function(t,r){this.normal=void 0!==t?t:new e.Vector3(1,0,0),this.constant=void 0!==r?r:0},e.Plane.prototype={constructor:e.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,i){return this.normal.set(e,t,r),this.constant=i,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new e.Vector3,r=new e.Vector3;return function(e,i,o){var n=t.subVectors(o,i).cross(r.subVectors(e,i)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}}(),copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(t,r){var i=this.distanceToPoint(t),o=r||new e.Vector3;return o.copy(this.normal).multiplyScalar(i)},isIntersectionLine:function(e){var t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return 0>t&&r>0||0>r&&t>0},intersectLine:function(){var t=new e.Vector3;return function(r,i){var o=i||new e.Vector3,n=r.delta(t),a=this.normal.dot(n);if(0!=a){var s=-(r.start.dot(this.normal)+this.constant)/a;if(!(0>s||s>1))return o.copy(n).multiplyScalar(s).add(r.start)}else if(0==this.distanceToPoint(r.start))return o.copy(r.start)}}(),coplanarPoint:function(t){var r=t||new e.Vector3;return r.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new e.Vector3,r=new e.Vector3;return function(i,o){o=o||(new e.Matrix3).getNormalMatrix(i);var n=t.copy(this.normal).applyMatrix3(o),a=this.coplanarPoint(r);return a.applyMatrix4(i),this.setFromNormalAndCoplanarPoint(n,a),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new e.Plane).copy(this)}},e.Math={PI2:2*Math.PI,generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=new Array(36),i=0;return function(){for(var o=0;36>o;o++)8==o||13==o||18==o||23==o?r[o]="-":14==o?r[o]="4":(2>=i&&(i=33554432+16777216*Math.random()|0),e=15&i,i>>=4,r[o]=t[19==o?3&e|8:e]);return r.join("")}}(),clamp:function(e,t,r){return t>e?t:e>r?r:e},clampBottom:function(e,t){return t>e?t:e},mapLinear:function(e,t,r,i,o){return i+(e-t)*(o-i)/(r-t)},smoothstep:function(e,t,r){return t>=e?0:e>=r?1:(e=(e-t)/(r-t),e*e*(3-2*e))},smootherstep:function(e,t,r){return t>=e?0:e>=r?1:(e=(e-t)/(r-t),e*e*e*(e*(6*e-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return 0>e?-1:e>0?1:0},degToRad:function(){var e=Math.PI/180;return function(t){return t*e}}(),radToDeg:function(){var e=180/Math.PI;return function(t){return t*e}}()},e.Spline=function(t){function r(e,t,r,i,o,n,a){var s=.5*(r-e),l=.5*(i-t);return(2*(t-r)+s+l)*a+(-3*(t-r)-2*s-l)*n+s*o+t}this.points=t;var i,o,n,a,s,l,c,h,u,p=[],d={x:0,y:0,z:0};this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return i=(this.points.length-1)*e,o=Math.floor(i),n=i-o,p[0]=0===o?o:o-1,p[1]=o,p[2]=o>this.points.length-2?this.points.length-1:o+1,p[3]=o>this.points.length-3?this.points.length-1:o+2,l=this.points[p[0]],c=this.points[p[1]],h=this.points[p[2]],u=this.points[p[3]],a=n*n,s=n*a,d.x=r(l.x,c.x,h.x,u.x,n,a,s),d.y=r(l.y,c.y,h.y,u.y,n,a,s),d.z=r(l.z,c.z,h.z,u.z,n,a,s),d},this.getControlPointsArray=function(){var e,t,r=this.points.length,i=[];for(e=0;r>e;e++)t=this.points[e],i[e]=[t.x,t.y,t.z];return i},this.getLength=function(t){var r,i,o,n,a=0,s=0,l=0,c=new e.Vector3,h=new e.Vector3,u=[],p=0;for(u[0]=0,t||(t=100),o=this.points.length*t,c.copy(this.points[0]),r=1;o>r;r++)i=r/o,n=this.getPoint(i),h.copy(n),p+=h.distanceTo(c),c.copy(n),a=(this.points.length-1)*i,s=Math.floor(a),s!=l&&(u[s]=p,l=s);return u[u.length]=p,{chunks:u,total:p}},this.reparametrizeByArcLength=function(t){var r,i,o,n,a,s,l,c,h=[],u=new e.Vector3,p=this.getLength();for(h.push(u.copy(this.points[0]).clone()),r=1;r<this.points.length;r++){for(s=p.chunks[r]-p.chunks[r-1],l=Math.ceil(t*s/p.total),n=(r-1)/(this.points.length-1),a=r/(this.points.length-1),i=1;l-1>i;i++)o=n+i*(1/l)*(a-n),c=this.getPoint(o),h.push(u.copy(c).clone());h.push(u.copy(this.points[r]).clone())}this.points=h;
}},e.Triangle=function(t,r,i){this.a=void 0!==t?t:new e.Vector3,this.b=void 0!==r?r:new e.Vector3,this.c=void 0!==i?i:new e.Vector3},e.Triangle.normal=function(){var t=new e.Vector3;return function(r,i,o,n){var a=n||new e.Vector3;a.subVectors(o,i),t.subVectors(r,i),a.cross(t);var s=a.lengthSq();return s>0?a.multiplyScalar(1/Math.sqrt(s)):a.set(0,0,0)}}(),e.Triangle.barycoordFromPoint=function(){var t=new e.Vector3,r=new e.Vector3,i=new e.Vector3;return function(o,n,a,s,l){t.subVectors(s,n),r.subVectors(a,n),i.subVectors(o,n);var c=t.dot(t),h=t.dot(r),u=t.dot(i),p=r.dot(r),d=r.dot(i),f=c*p-h*h,m=l||new e.Vector3;if(0==f)return m.set(-2,-1,-1);var v=1/f,g=(p*u-h*d)*v,y=(c*d-h*u)*v;return m.set(1-g-y,y,g)}}(),e.Triangle.containsPoint=function(){var t=new e.Vector3;return function(r,i,o,n){var a=e.Triangle.barycoordFromPoint(r,i,o,n,t);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}(),e.Triangle.prototype={constructor:e.Triangle,set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this},setFromPointsAndIndices:function(e,t,r,i){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[i]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var t=new e.Vector3,r=new e.Vector3;return function(){return t.subVectors(this.c,this.b),r.subVectors(this.a,this.b),.5*t.cross(r).length()}}(),midpoint:function(t){var r=t||new e.Vector3;return r.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(t){return e.Triangle.normal(this.a,this.b,this.c,t)},plane:function(t){var r=t||new e.Plane;return r.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(t,r){return e.Triangle.barycoordFromPoint(t,this.a,this.b,this.c,r)},containsPoint:function(t){return e.Triangle.containsPoint(t,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new e.Triangle).copy(this)}},e.Vertex=function(e){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),e},e.UV=function(t,r){return console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead."),new e.Vector2(t,r)},e.Clock=function(e){this.autoStart=void 0!==e?e:!0,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},e.Clock.prototype={constructor:e.Clock,start:function(){this.startTime=void 0!==self.performance&&void 0!==self.performance.now?self.performance.now():Date.now(),this.oldTime=this.startTime,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=void 0!==self.performance&&void 0!==self.performance.now?self.performance.now():Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}},e.EventDispatcher=function(){},e.EventDispatcher.prototype={constructor:e.EventDispatcher,apply:function(t){t.addEventListener=e.EventDispatcher.prototype.addEventListener,t.hasEventListener=e.EventDispatcher.prototype.hasEventListener,t.removeEventListener=e.EventDispatcher.prototype.removeEventListener,t.dispatchEvent=e.EventDispatcher.prototype.dispatchEvent},addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)?!0:!1},removeEventListener:function(e,t){if(void 0!==this._listeners){var r=this._listeners,i=r[e].indexOf(t);-1!==i&&r[e].splice(i,1)}},dispatchEvent:function(){var e=[];return function(t){if(void 0!==this._listeners){var r=this._listeners,i=r[t.type];if(void 0!==i){t.target=this;for(var o=i.length,n=0;o>n;n++)e[n]=i[n];for(var n=0;o>n;n++)e[n].call(this,t)}}}}()},function(e){e.Raycaster=function(t,r,i,o){this.ray=new e.Ray(t,r),this.near=i||0,this.far=o||1/0};var t=new e.Sphere,r=new e.Ray,i=(new e.Plane,new e.Vector3,new e.Vector3),o=new e.Matrix4,n=function(e,t){return e.distance-t.distance},a=new e.Vector3,s=new e.Vector3,l=new e.Vector3,c=function(n,h,u){if(n instanceof e.Sprite){i.getPositionFromMatrix(n.matrixWorld);var p=h.ray.distanceToPoint(i);if(p>n.scale.x)return u;u.push({distance:p,point:n.position,face:null,object:n})}else if(n instanceof e.LOD){i.getPositionFromMatrix(n.matrixWorld);var p=h.ray.origin.distanceTo(i);c(n.getObjectForDistance(p),h,u)}else if(n instanceof e.Mesh){var d=n.geometry;if(null===d.boundingSphere&&d.computeBoundingSphere(),t.copy(d.boundingSphere),t.applyMatrix4(n.matrixWorld),h.ray.isIntersectionSphere(t)===!1)return u;if(o.getInverse(n.matrixWorld),r.copy(h.ray).applyMatrix4(o),null!==d.boundingBox&&r.isIntersectionBox(d.boundingBox)===!1)return u;if(d instanceof e.BufferGeometry){var f=n.material;if(void 0===f)return u;if(d.dynamic===!1)return u;var m,v,g,y=h.precision;if(void 0!==d.attributes.index)for(var x=d.offsets,w=d.attributes.index.array,b=d.attributes.position.array,_=d.offsets.length,M=d.attributes.index.array.length/3,S=0;_>S;++S)for(var T=x[S].start,C=x[S].count,L=x[S].index,A=T,P=T+C;P>A;A+=3){if(m=L+w[A],v=L+w[A+1],g=L+w[A+2],a.set(b[3*m],b[3*m+1],b[3*m+2]),s.set(b[3*v],b[3*v+1],b[3*v+2]),l.set(b[3*g],b[3*g+1],b[3*g+2]),f.side===e.BackSide)var D=r.intersectTriangle(l,s,a,!0);else var D=r.intersectTriangle(a,s,l,f.side!==e.DoubleSide);if(null!==D){D.applyMatrix4(n.matrixWorld);var p=h.ray.origin.distanceTo(D);y>p||p<h.near||p>h.far||u.push({distance:p,point:D,face:null,faceIndex:null,object:n})}}else for(var x=d.offsets,b=d.attributes.position.array,_=d.offsets.length,M=d.attributes.position.array.length,A=0;M>A;A+=3){if(m=A,v=A+1,g=A+2,a.set(b[3*m],b[3*m+1],b[3*m+2]),s.set(b[3*v],b[3*v+1],b[3*v+2]),l.set(b[3*g],b[3*g+1],b[3*g+2]),f.side===e.BackSide)var D=r.intersectTriangle(l,s,a,!0);else var D=r.intersectTriangle(a,s,l,f.side!==e.DoubleSide);if(null!==D){D.applyMatrix4(n.matrixWorld);var p=h.ray.origin.distanceTo(D);y>p||p<h.near||p>h.far||u.push({distance:p,point:D,face:null,faceIndex:null,object:n})}}}else if(d instanceof e.Geometry)for(var m,v,g,F=n.material instanceof e.MeshFaceMaterial,E=F===!0?n.material.materials:null,y=h.precision,V=d.vertices,R=0,M=d.faces.length;M>R;R++){var z=d.faces[R],f=F===!0?E[z.materialIndex]:n.material;if(void 0!==f){if(m=V[z.a],v=V[z.b],g=V[z.c],f.side===e.BackSide)var D=r.intersectTriangle(g,v,m,!0);else var D=r.intersectTriangle(m,v,g,f.side!==e.DoubleSide);if(null!==D){D.applyMatrix4(n.matrixWorld);var p=h.ray.origin.distanceTo(D);y>p||p<h.near||p>h.far||u.push({distance:p,point:D,face:z,faceIndex:R,object:n})}}}}else if(n instanceof e.Line){var y=h.linePrecision,I=y*y,d=n.geometry;if(null===d.boundingSphere&&d.computeBoundingSphere(),t.copy(d.boundingSphere),t.applyMatrix4(n.matrixWorld),h.ray.isIntersectionSphere(t)===!1)return u;if(o.getInverse(n.matrixWorld),r.copy(h.ray).applyMatrix4(o),d instanceof e.Geometry)for(var V=d.vertices,U=V.length,O=new e.Vector3,B=new e.Vector3,N=n.type===e.LineStrip?1:2,A=0;U-1>A;A+=N){var k=r.distanceSqToSegment(V[A],V[A+1],B,O);if(!(k>I)){var p=r.origin.distanceTo(B);p<h.near||p>h.far||u.push({distance:p,point:O.clone().applyMatrix4(n.matrixWorld),face:null,faceIndex:null,object:n})}}}},h=function(e,t,r){for(var i=e.getDescendants(),o=0,n=i.length;n>o;o++)c(i[o],t,r)};e.Raycaster.prototype.precision=1e-4,e.Raycaster.prototype.linePrecision=1,e.Raycaster.prototype.set=function(e,t){this.ray.set(e,t)},e.Raycaster.prototype.intersectObject=function(e,t){var r=[];return t===!0&&h(e,this,r),c(e,this,r),r.sort(n),r},e.Raycaster.prototype.intersectObjects=function(e,t){for(var r=[],i=0,o=e.length;o>i;i++)c(e[i],this,r),t===!0&&h(e[i],this,r);return r.sort(n),r}}(e),e.Object3D=function(){this.id=e.Object3DIdCount++,this.uuid=e.Math.generateUUID(),this.name="",this.parent=void 0,this.children=[],this.up=new e.Vector3(0,1,0),this.position=new e.Vector3,this._rotation=new e.Euler,this._quaternion=new e.Quaternion,this.scale=new e.Vector3(1,1,1),this._rotation._quaternion=this.quaternion,this._quaternion._euler=this.rotation,this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new e.Matrix4,this.matrixWorld=new e.Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!0,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.userData={}},e.Object3D.prototype={constructor:e.Object3D,get rotation(){return this._rotation},set rotation(e){this._rotation=e,this._rotation._quaternion=this._quaternion,this._quaternion._euler=this._rotation,this._rotation._updateQuaternion()},get quaternion(){return this._quaternion},set quaternion(e){this._quaternion=e,this._quaternion._euler=this._rotation,this._rotation._quaternion=this._quaternion,this._quaternion._updateEuler()},get eulerOrder(){return console.warn("DEPRECATED: Object3D's .eulerOrder has been moved to Object3D's .rotation.order."),this.rotation.order},set eulerOrder(e){console.warn("DEPRECATED: Object3D's .eulerOrder has been moved to Object3D's .rotation.order."),this.rotation.order=e},get useQuaternion(){console.warn("DEPRECATED: Object3D's .useQuaternion has been removed. The library now uses quaternions by default.")},set useQuaternion(e){console.warn("DEPRECATED: Object3D's .useQuaternion has been removed. The library now uses quaternions by default.")},applyMatrix:function(){var t=new e.Matrix4;return function(e){this.matrix.multiplyMatrices(e,this.matrix),this.position.getPositionFromMatrix(this.matrix),this.scale.getScaleFromMatrix(this.matrix),t.extractRotation(this.matrix),this.quaternion.setFromRotationMatrix(t)}}(),setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var t=new e.Quaternion;return function(e,r){return t.setFromAxisAngle(e,r),this.quaternion.multiply(t),this}}(),rotateX:function(){var t=new e.Vector3(1,0,0);return function(e){return this.rotateOnAxis(t,e)}}(),rotateY:function(){var t=new e.Vector3(0,1,0);return function(e){return this.rotateOnAxis(t,e)}}(),rotateZ:function(){var t=new e.Vector3(0,0,1);return function(e){return this.rotateOnAxis(t,e)}}(),translateOnAxis:function(){var t=new e.Vector3;return function(e,r){return t.copy(e),t.applyQuaternion(this.quaternion),this.position.add(t.multiplyScalar(r)),this}}(),translate:function(e,t){return console.warn("DEPRECATED: Object3D's .translate() has been removed. Use .translateOnAxis( axis, distance ) instead. Note args have been changed."),this.translateOnAxis(t,e)},translateX:function(){var t=new e.Vector3(1,0,0);return function(e){return this.translateOnAxis(t,e)}}(),translateY:function(){var t=new e.Vector3(0,1,0);return function(e){return this.translateOnAxis(t,e)}}(),translateZ:function(){var t=new e.Vector3(0,0,1);return function(e){return this.translateOnAxis(t,e)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var t=new e.Matrix4;return function(e){return e.applyMatrix4(t.getInverse(this.matrixWorld))}}(),lookAt:function(){var t=new e.Matrix4;return function(e){t.lookAt(e,this.position,this.up),this.quaternion.setFromRotationMatrix(t)}}(),add:function(t){if(t===this)return void console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");if(t instanceof e.Object3D){void 0!==t.parent&&t.parent.remove(t),t.parent=this,t.dispatchEvent({type:"added"}),this.children.push(t);for(var r=this;void 0!==r.parent;)r=r.parent;void 0!==r&&r instanceof e.Scene&&r.__addObject(t)}},remove:function(t){var r=this.children.indexOf(t);if(-1!==r){t.parent=void 0,t.dispatchEvent({type:"removed"}),this.children.splice(r,1);for(var i=this;void 0!==i.parent;)i=i.parent;void 0!==i&&i instanceof e.Scene&&i.__removeObject(t)}},traverse:function(e){e(this);for(var t=0,r=this.children.length;r>t;t++)this.children[t].traverse(e)},getObjectById:function(e,t){for(var r=0,i=this.children.length;i>r;r++){var o=this.children[r];if(o.id===e)return o;if(t===!0&&(o=o.getObjectById(e,t),void 0!==o))return o}},getObjectByName:function(e,t){for(var r=0,i=this.children.length;i>r;r++){var o=this.children[r];if(o.name===e)return o;if(t===!0&&(o=o.getObjectByName(e,t),void 0!==o))return o}},getChildByName:function(e,t){return console.warn("DEPRECATED: Object3D's .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e,t)},getDescendants:function(e){void 0===e&&(e=[]),Array.prototype.push.apply(e,this.children);for(var t=0,r=this.children.length;r>t;t++)this.children[t].getDescendants(e);return e},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||e===!0)&&(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,r=this.children.length;r>t;t++)this.children[t].updateMatrixWorld(e)},clone:function(t,r){if(void 0===t&&(t=new e.Object3D),void 0===r&&(r=!0),t.name=this.name,t.up.copy(this.up),t.position.copy(this.position),t.quaternion.copy(this.quaternion),t.scale.copy(this.scale),t.renderDepth=this.renderDepth,t.rotationAutoUpdate=this.rotationAutoUpdate,t.matrix.copy(this.matrix),t.matrixWorld.copy(this.matrixWorld),t.matrixAutoUpdate=this.matrixAutoUpdate,t.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,t.visible=this.visible,t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow,t.frustumCulled=this.frustumCulled,t.userData=JSON.parse(JSON.stringify(this.userData)),r===!0)for(var i=0;i<this.children.length;i++){var o=this.children[i];t.add(o.clone())}return t}},e.EventDispatcher.prototype.apply(e.Object3D.prototype),e.Object3DIdCount=0,e.Projector=function(){function t(){if(c===w){var t=new e.RenderableObject;return x.push(t),w++,c++,t}return x[c++]}function r(){if(u===_){var t=new e.RenderableVertex;return b.push(t),_++,u++,t}return b[u++]}function i(){if(d===S){var t=new e.RenderableFace3;return M.push(t),S++,d++,t}return M[d++]}function o(){if(m===C){var t=new e.RenderableLine;return T.push(t),C++,m++,t}return T[m++]}function n(){if(g===A){var t=new e.RenderableSprite;return L.push(t),A++,g++,t}return L[g++]}function a(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function s(e,t){var r=0,i=1,o=e.z+e.w,n=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return o>=0&&n>=0&&a>=0&&s>=0?!0:0>o&&0>n||0>a&&0>s?!1:(0>o?r=Math.max(r,o/(o-n)):0>n&&(i=Math.min(i,o/(o-n))),0>a?r=Math.max(r,a/(a-s)):0>s&&(i=Math.min(i,a/(a-s))),r>i?!1:(e.lerp(t,r),t.lerp(e,1-i),!0))}var l,c,h,u,p,d,f,m,v,g,y,x=[],w=0,b=[],_=0,M=[],S=0,T=[],C=0,L=[],A=0,P={objects:[],sprites:[],lights:[],elements:[]},D=new e.Vector3,F=new e.Vector4,E=new e.Box3(new e.Vector3(-1,-1,-1),new e.Vector3(1,1,1)),V=new e.Box3,R=new Array(3),z=(new Array(4),new e.Matrix4),I=new e.Matrix4,U=new e.Matrix4,O=new e.Matrix3,B=new e.Matrix3,N=new e.Vector3,k=new e.Frustum,G=new e.Vector4,j=new e.Vector4;this.projectVector=function(e,t){return t.matrixWorldInverse.getInverse(t.matrixWorld),I.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),e.applyProjection(I)},this.unprojectVector=function(e,t){return t.projectionMatrixInverse.getInverse(t.projectionMatrix),I.multiplyMatrices(t.matrixWorld,t.projectionMatrixInverse),e.applyProjection(I)},this.pickingRay=function(t,r){t.z=-1;var i=new e.Vector3(t.x,t.y,1);return this.unprojectVector(t,r),this.unprojectVector(i,r),i.sub(t).normalize(),new e.Raycaster(t,i)};var W=function(e){return l=t(),l.id=e.id,l.object=e,null!==e.renderDepth?l.z=e.renderDepth:(D.getPositionFromMatrix(e.matrixWorld),D.applyProjection(I),l.z=D.z),l},H=function(t){if(t.visible!==!1){t instanceof e.Light?P.lights.push(t):t instanceof e.Mesh||t instanceof e.Line?(t.frustumCulled===!1||k.intersectsObject(t)===!0)&&P.objects.push(W(t)):t instanceof e.Sprite&&P.sprites.push(W(t));for(var r=0,i=t.children.length;i>r;r++)H(t.children[r])}},X=function(e,t){c=0,P.objects.length=0,P.sprites.length=0,P.lights.length=0,H(e),t===!0&&P.objects.sort(a)};this.projectScene=function(t,l,c,x){var w,_,M,S,T,C,L,A,D,W,H,q,Y,Z,K,Q,J,$,ee,te,re,ie,oe,ne,ae,se=!1;for(d=0,m=0,g=0,P.elements.length=0,t.autoUpdate===!0&&t.updateMatrixWorld(),void 0===l.parent&&l.updateMatrixWorld(),z.copy(l.matrixWorldInverse.getInverse(l.matrixWorld)),I.multiplyMatrices(l.projectionMatrix,z),B.getNormalMatrix(z),k.setFromMatrix(I),X(t,c),w=0,_=P.objects.length;_>w;w++)if(Y=P.objects[w].object,y=Y.matrixWorld,u=0,Y instanceof e.Mesh){for(Z=Y.geometry,K=Z.vertices,Q=Z.faces,ee=Z.faceVertexUvs,O.getNormalMatrix(y),ne=Y.material instanceof e.MeshFaceMaterial,ae=ne===!0?Y.material:null,M=0,S=K.length;S>M;M++){h=r(),h.positionWorld.copy(K[M]).applyMatrix4(y),h.positionScreen.copy(h.positionWorld).applyMatrix4(I);var le=1/h.positionScreen.w;h.positionScreen.x*=le,h.positionScreen.y*=le,h.positionScreen.z*=le,h.visible=!(h.positionScreen.x<-1||h.positionScreen.x>1||h.positionScreen.y<-1||h.positionScreen.y>1||h.positionScreen.z<-1||h.positionScreen.z>1)}for(T=0,C=Q.length;C>T;T++){J=Q[T];var ce=ne===!0?ae.materials[J.materialIndex]:Y.material;if(void 0!==ce){var he=ce.side;if(re=b[J.a],ie=b[J.b],oe=b[J.c],R[0]=re.positionScreen,R[1]=ie.positionScreen,R[2]=oe.positionScreen,(re.visible===!0||ie.visible===!0||oe.visible===!0||E.isIntersectionBox(V.setFromPoints(R)))&&(se=(oe.positionScreen.x-re.positionScreen.x)*(ie.positionScreen.y-re.positionScreen.y)-(oe.positionScreen.y-re.positionScreen.y)*(ie.positionScreen.x-re.positionScreen.x)<0,he===e.DoubleSide||se===(he===e.FrontSide))){for(p=i(),p.id=Y.id,p.v1.copy(re),p.v2.copy(ie),p.v3.copy(oe),p.normalModel.copy(J.normal),se!==!1||he!==e.BackSide&&he!==e.DoubleSide||p.normalModel.negate(),p.normalModel.applyMatrix3(O).normalize(),p.normalModelView.copy(p.normalModel).applyMatrix3(B),p.centroidModel.copy(J.centroid).applyMatrix4(y),$=J.vertexNormals,L=0,A=Math.min($.length,3);A>L;L++){var ue=p.vertexNormalsModel[L];ue.copy($[L]),se!==!1||he!==e.BackSide&&he!==e.DoubleSide||ue.negate(),ue.applyMatrix3(O).normalize();var pe=p.vertexNormalsModelView[L];pe.copy(ue).applyMatrix3(B)}for(p.vertexNormalsLength=$.length,D=0,W=Math.min(ee.length,3);W>D;D++)if(te=ee[D][T],void 0!==te)for(H=0,q=te.length;q>H;H++)p.uvs[D][H]=te[H];p.color=J.color,p.material=ce,N.copy(p.centroidModel).applyProjection(I),p.z=N.z,P.elements.push(p)}}}}else if(Y instanceof e.Line){U.multiplyMatrices(I,y),K=Y.geometry.vertices,re=r(),re.positionScreen.copy(K[0]).applyMatrix4(U);var de=Y.type===e.LinePieces?2:1;for(M=1,S=K.length;S>M;M++)re=r(),re.positionScreen.copy(K[M]).applyMatrix4(U),(M+1)%de>0||(ie=b[u-2],G.copy(re.positionScreen),j.copy(ie.positionScreen),s(G,j)===!0&&(G.multiplyScalar(1/G.w),j.multiplyScalar(1/j.w),f=o(),f.id=Y.id,f.v1.positionScreen.copy(G),f.v2.positionScreen.copy(j),f.z=Math.max(G.z,j.z),f.material=Y.material,Y.material.vertexColors===e.VertexColors&&(f.vertexColors[0].copy(Y.geometry.colors[M]),f.vertexColors[1].copy(Y.geometry.colors[M-1])),P.elements.push(f)))}for(w=0,_=P.sprites.length;_>w;w++)if(Y=P.sprites[w].object,y=Y.matrixWorld,Y instanceof e.Sprite){F.set(y.elements[12],y.elements[13],y.elements[14],1),F.applyMatrix4(I);var le=1/F.w;F.z*=le,F.z>-1&&F.z<1&&(v=n(),v.id=Y.id,v.x=F.x*le,v.y=F.y*le,v.z=F.z,v.object=Y,v.rotation=Y.rotation,v.scale.x=Y.scale.x*Math.abs(v.x-(F.x+l.projectionMatrix.elements[0])/(F.w+l.projectionMatrix.elements[12])),v.scale.y=Y.scale.y*Math.abs(v.y-(F.y+l.projectionMatrix.elements[5])/(F.w+l.projectionMatrix.elements[13])),v.material=Y.material,P.elements.push(v))}return x===!0&&P.elements.sort(a),P}},e.Face3=function(t,r,i,o,n,a){this.a=t,this.b=r,this.c=i,this.normal=o instanceof e.Vector3?o:new e.Vector3,this.vertexNormals=o instanceof Array?o:[],this.color=n instanceof e.Color?n:new e.Color,this.vertexColors=n instanceof Array?n:[],this.vertexTangents=[],this.materialIndex=void 0!==a?a:0,this.centroid=new e.Vector3},e.Face3.prototype={constructor:e.Face3,clone:function(){var t=new e.Face3(this.a,this.b,this.c);t.normal.copy(this.normal),t.color.copy(this.color),t.centroid.copy(this.centroid),t.materialIndex=this.materialIndex;var r,i;for(r=0,i=this.vertexNormals.length;i>r;r++)t.vertexNormals[r]=this.vertexNormals[r].clone();for(r=0,i=this.vertexColors.length;i>r;r++)t.vertexColors[r]=this.vertexColors[r].clone();for(r=0,i=this.vertexTangents.length;i>r;r++)t.vertexTangents[r]=this.vertexTangents[r].clone();return t}},e.Face4=function(t,r,i,o,n,a,s){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new e.Face3(t,r,i,n,a,s)},e.Geometry=function(){this.id=e.GeometryIdCount++,this.uuid=e.Math.generateUUID(),this.name="",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.tangentsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1},e.Geometry.prototype={constructor:e.Geometry,applyMatrix:function(t){for(var r=(new e.Matrix3).getNormalMatrix(t),i=0,o=this.vertices.length;o>i;i++){var n=this.vertices[i];n.applyMatrix4(t)}for(var i=0,o=this.faces.length;o>i;i++){var a=this.faces[i];a.normal.applyMatrix3(r).normalize();for(var s=0,l=a.vertexNormals.length;l>s;s++)a.vertexNormals[s].applyMatrix3(r).normalize();a.centroid.applyMatrix4(t)}this.boundingBox instanceof e.Box3&&this.computeBoundingBox(),this.boundingSphere instanceof e.Sphere&&this.computeBoundingSphere()},computeCentroids:function(){var e,t,r;for(e=0,t=this.faces.length;t>e;e++)r=this.faces[e],r.centroid.set(0,0,0),r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.divideScalar(3)},computeFaceNormals:function(){for(var t=new e.Vector3,r=new e.Vector3,i=0,o=this.faces.length;o>i;i++){var n=this.faces[i],a=this.vertices[n.a],s=this.vertices[n.b],l=this.vertices[n.c];t.subVectors(l,s),r.subVectors(a,s),t.cross(r),t.normalize(),n.normal.copy(t)}},computeVertexNormals:function(t){var r,i,o,n,a,s;if(void 0===this.__tmpVertices){for(this.__tmpVertices=new Array(this.vertices.length),s=this.__tmpVertices,r=0,i=this.vertices.length;i>r;r++)s[r]=new e.Vector3;for(o=0,n=this.faces.length;n>o;o++)a=this.faces[o],a.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3]}else for(s=this.__tmpVertices,r=0,i=this.vertices.length;i>r;r++)s[r].set(0,0,0);if(t){var l,c,h,u=new e.Vector3,p=new e.Vector3;new e.Vector3,new e.Vector3,new e.Vector3;for(o=0,n=this.faces.length;n>o;o++)a=this.faces[o],l=this.vertices[a.a],c=this.vertices[a.b],h=this.vertices[a.c],u.subVectors(h,c),p.subVectors(l,c),u.cross(p),s[a.a].add(u),s[a.b].add(u),s[a.c].add(u)}else for(o=0,n=this.faces.length;n>o;o++)a=this.faces[o],s[a.a].add(a.normal),s[a.b].add(a.normal),s[a.c].add(a.normal);for(r=0,i=this.vertices.length;i>r;r++)s[r].normalize();for(o=0,n=this.faces.length;n>o;o++)a=this.faces[o],a.vertexNormals[0].copy(s[a.a]),a.vertexNormals[1].copy(s[a.b]),a.vertexNormals[2].copy(s[a.c])},computeMorphNormals:function(){var t,r,i,o,n;for(i=0,o=this.faces.length;o>i;i++)for(n=this.faces[i],n.__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),t=0,r=n.vertexNormals.length;r>t;t++)n.__originalVertexNormals[t]?n.__originalVertexNormals[t].copy(n.vertexNormals[t]):n.__originalVertexNormals[t]=n.vertexNormals[t].clone();var a=new e.Geometry;for(a.faces=this.faces,t=0,r=this.morphTargets.length;r>t;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];var s,l,c=this.morphNormals[t].faceNormals,h=this.morphNormals[t].vertexNormals;for(i=0,o=this.faces.length;o>i;i++)n=this.faces[i],s=new e.Vector3,l={a:new e.Vector3,b:new e.Vector3,c:new e.Vector3},c.push(s),h.push(l)}var u=this.morphNormals[t];a.vertices=this.morphTargets[t].vertices,a.computeFaceNormals(),a.computeVertexNormals();var s,l;for(i=0,o=this.faces.length;o>i;i++)n=this.faces[i],s=u.faceNormals[i],l=u.vertexNormals[i],s.copy(n.normal),l.a.copy(n.vertexNormals[0]),l.b.copy(n.vertexNormals[1]),l.c.copy(n.vertexNormals[2])}for(i=0,o=this.faces.length;o>i;i++)n=this.faces[i],n.normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeTangents:function(){function t(e,t,r,i,o,n,a){h=e.vertices[t],u=e.vertices[r],p=e.vertices[i],d=c[o],f=c[n],m=c[a],v=u.x-h.x,g=p.x-h.x,y=u.y-h.y,x=p.y-h.y,w=u.z-h.z,b=p.z-h.z,_=f.x-d.x,M=m.x-d.x,S=f.y-d.y,T=m.y-d.y,C=1/(_*T-M*S),E.set((T*v-S*g)*C,(T*y-S*x)*C,(T*w-S*b)*C),V.set((_*g-M*v)*C,(_*x-M*y)*C,(_*b-M*w)*C),D[t].add(E),D[r].add(E),D[i].add(E),F[t].add(V),F[r].add(V),F[i].add(V)}var r,i,o,n,a,s,l,c,h,u,p,d,f,m,v,g,y,x,w,b,_,M,S,T,C,L,A,P,D=[],F=[],E=new e.Vector3,V=new e.Vector3,R=new e.Vector3,z=new e.Vector3,I=new e.Vector3;for(o=0,n=this.vertices.length;n>o;o++)D[o]=new e.Vector3,F[o]=new e.Vector3;for(r=0,i=this.faces.length;i>r;r++)l=this.faces[r],c=this.faceVertexUvs[0][r],t(this,l.a,l.b,l.c,0,1,2);var U=["a","b","c","d"];for(r=0,i=this.faces.length;i>r;r++)for(l=this.faces[r],a=0;a<Math.min(l.vertexNormals.length,3);a++)I.copy(l.vertexNormals[a]),s=l[U[a]],L=D[s],R.copy(L),R.sub(I.multiplyScalar(I.dot(L))).normalize(),z.crossVectors(l.vertexNormals[a],L),A=z.dot(F[s]),P=0>A?-1:1,l.vertexTangents[a]=new e.Vector4(R.x,R.y,R.z,P);this.hasTangents=!0},computeLineDistances:function(){for(var e=0,t=this.vertices,r=0,i=t.length;i>r;r++)r>0&&(e+=t[r].distanceTo(t[r-1])),this.lineDistances[r]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new e.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere),this.boundingSphere.setFromPoints(this.vertices)},mergeVertices:function(){var e,t,r,i,o,n,a,s,l={},c=[],h=[],u=4,p=Math.pow(10,u);for(this.__tmpVertices=void 0,r=0,i=this.vertices.length;i>r;r++)e=this.vertices[r],t=Math.round(e.x*p)+"_"+Math.round(e.y*p)+"_"+Math.round(e.z*p),void 0===l[t]?(l[t]=r,c.push(this.vertices[r]),h[r]=c.length-1):h[r]=h[l[t]];var d=[];for(r=0,i=this.faces.length;i>r;r++){o=this.faces[r],o.a=h[o.a],o.b=h[o.b],o.c=h[o.c],n=[o.a,o.b,o.c];for(var f=-1,m=0;3>m;m++)if(n[m]==n[(m+1)%3]){f=m,d.push(r);break}}for(r=d.length-1;r>=0;r--){var v=d[r];for(this.faces.splice(v,1),a=0,s=this.faceVertexUvs.length;s>a;a++)this.faceVertexUvs[a].splice(v,1)}var g=this.vertices.length-c.length;return this.vertices=c,g},clone:function(){for(var t=new e.Geometry,r=this.vertices,i=0,o=r.length;o>i;i++)t.vertices.push(r[i].clone());for(var n=this.faces,i=0,o=n.length;o>i;i++)t.faces.push(n[i].clone());for(var a=this.faceVertexUvs[0],i=0,o=a.length;o>i;i++){for(var s=a[i],l=[],c=0,h=s.length;h>c;c++)l.push(new e.Vector2(s[c].x,s[c].y));t.faceVertexUvs[0].push(l)}return t},dispose:function(){this.dispatchEvent({type:"dispose"})}},e.EventDispatcher.prototype.apply(e.Geometry.prototype),e.GeometryIdCount=0,e.BufferGeometry=function(){this.id=e.GeometryIdCount++,this.uuid=e.Math.generateUUID(),this.name="",this.attributes={},this.dynamic=!0,this.offsets=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.morphTargets=[]},e.BufferGeometry.prototype={constructor:e.BufferGeometry,addAttribute:function(e,t,r,i){this.attributes[e]={itemSize:i,array:new t(r*i)}},applyMatrix:function(t){var r,i;if(this.attributes.position&&(r=this.attributes.position.array),this.attributes.normal&&(i=this.attributes.normal.array),void 0!==r&&(t.multiplyVector3Array(r),this.verticesNeedUpdate=!0),void 0!==i){var o=(new e.Matrix3).getNormalMatrix(t);o.multiplyVector3Array(i),this.normalizeNormals(),this.normalsNeedUpdate=!0}},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new e.Box3);var t=this.attributes.position.array;if(t){var r,i,o,n=this.boundingBox;t.length>=3&&(n.min.x=n.max.x=t[0],n.min.y=n.max.y=t[1],n.min.z=n.max.z=t[2]);for(var a=3,s=t.length;s>a;a+=3)r=t[a],i=t[a+1],o=t[a+2],r<n.min.x?n.min.x=r:r>n.max.x&&(n.max.x=r),i<n.min.y?n.min.y=i:i>n.max.y&&(n.max.y=i),o<n.min.z?n.min.z=o:o>n.max.z&&(n.max.z=o)}(void 0===t||0===t.length)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0))},computeBoundingSphere:function(){var t=new e.Box3,r=new e.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere);var i=this.attributes.position.array;if(i){for(var o=this.boundingSphere.center,n=0,a=i.length;a>n;n+=3)r.set(i[n],i[n+1],i[n+2]),t.addPoint(r);t.center(o);for(var s=0,n=0,a=i.length;a>n;n+=3)r.set(i[n],i[n+1],i[n+2]),s=Math.max(s,o.distanceToSquared(r));this.boundingSphere.radius=Math.sqrt(s)}}}(),computeVertexNormals:function(){if(this.attributes.position){var t,r,i,o,n=this.attributes.position.array.length;if(void 0===this.attributes.normal)this.attributes.normal={itemSize:3,array:new Float32Array(n)};else for(t=0,r=this.attributes.normal.array.length;r>t;t++)this.attributes.normal.array[t]=0;var a,s,l,c,h,u,p=this.attributes.position.array,d=this.attributes.normal.array,f=new e.Vector3,m=new e.Vector3,v=new e.Vector3,g=new e.Vector3,y=new e.Vector3;if(this.attributes.index){var x=this.attributes.index.array,w=this.offsets;for(i=0,o=w.length;o>i;++i){var b=w[i].start,_=w[i].count,M=w[i].index;for(t=b,r=b+_;r>t;t+=3)a=M+x[t],s=M+x[t+1],l=M+x[t+2],c=p[3*a],h=p[3*a+1],u=p[3*a+2],f.set(c,h,u),c=p[3*s],h=p[3*s+1],u=p[3*s+2],m.set(c,h,u),c=p[3*l],h=p[3*l+1],u=p[3*l+2],v.set(c,h,u),g.subVectors(v,m),y.subVectors(f,m),g.cross(y),d[3*a]+=g.x,d[3*a+1]+=g.y,d[3*a+2]+=g.z,d[3*s]+=g.x,d[3*s+1]+=g.y,d[3*s+2]+=g.z,d[3*l]+=g.x,d[3*l+1]+=g.y,d[3*l+2]+=g.z}}else for(t=0,r=p.length;r>t;t+=9)c=p[t],h=p[t+1],u=p[t+2],f.set(c,h,u),c=p[t+3],h=p[t+4],u=p[t+5],m.set(c,h,u),c=p[t+6],h=p[t+7],u=p[t+8],v.set(c,h,u),g.subVectors(v,m),y.subVectors(f,m),g.cross(y),d[t]=g.x,d[t+1]=g.y,d[t+2]=g.z,d[t+3]=g.x,d[t+4]=g.y,d[t+5]=g.z,d[t+6]=g.x,d[t+7]=g.y,d[t+8]=g.z;this.normalizeNormals(),this.normalsNeedUpdate=!0}},normalizeNormals:function(){for(var e,t,r,i,o=this.attributes.normal.array,n=0,a=o.length;a>n;n+=3)e=o[n],t=o[n+1],r=o[n+2],i=1/Math.sqrt(e*e+t*t+r*r),o[n]*=i,o[n+1]*=i,o[n+2]*=i},computeTangents:function(){function t(e,t,r){d=o[3*e],f=o[3*e+1],m=o[3*e+2],v=o[3*t],g=o[3*t+1],y=o[3*t+2],x=o[3*r],w=o[3*r+1],b=o[3*r+2],_=a[2*e],M=a[2*e+1],S=a[2*t],T=a[2*t+1],C=a[2*r],L=a[2*r+1],A=v-d,P=x-d,D=g-f,F=w-f,E=y-m,V=b-m,R=S-_,z=C-_,I=T-M,U=L-M,O=1/(R*U-z*I),X.set((U*A-I*P)*O,(U*D-I*F)*O,(U*E-I*V)*O),q.set((R*P-z*A)*O,(R*F-z*D)*O,(R*V-z*E)*O),h[e].add(X),h[t].add(X),h[r].add(X),u[e].add(q),u[t].add(q),u[r].add(q)}function r(e){ie.x=n[3*e],ie.y=n[3*e+1],ie.z=n[3*e+2],oe.copy(ie),$=h[e],te.copy($),te.sub(ie.multiplyScalar(ie.dot($))).normalize(),re.crossVectors(oe,$),ee=re.dot(u[e]),J=0>ee?-1:1,c[4*e]=te.x,c[4*e+1]=te.y,c[4*e+2]=te.z,c[4*e+3]=J}if(void 0===this.attributes.index||void 0===this.attributes.position||void 0===this.attributes.normal||void 0===this.attributes.uv)return void console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");var i=this.attributes.index.array,o=this.attributes.position.array,n=this.attributes.normal.array,a=this.attributes.uv.array,s=o.length/3;if(void 0===this.attributes.tangent){var l=4*s;this.attributes.tangent={itemSize:4,array:new Float32Array(l)}}for(var c=this.attributes.tangent.array,h=[],u=[],p=0;s>p;p++)h[p]=new e.Vector3,u[p]=new e.Vector3;
var d,f,m,v,g,y,x,w,b,_,M,S,T,C,L,A,P,D,F,E,V,R,z,I,U,O,B,N,k,G,j,W,H,X=new e.Vector3,q=new e.Vector3,Y=this.offsets;for(k=0,G=Y.length;G>k;++k){var Z=Y[k].start,K=Y[k].count,Q=Y[k].index;for(B=Z,N=Z+K;N>B;B+=3)j=Q+i[B],W=Q+i[B+1],H=Q+i[B+2],t(j,W,H)}var J,$,ee,te=new e.Vector3,re=new e.Vector3,ie=new e.Vector3,oe=new e.Vector3;for(k=0,G=Y.length;G>k;++k){var Z=Y[k].start,K=Y[k].count,Q=Y[k].index;for(B=Z,N=Z+K;N>B;B+=3)j=Q+i[B],W=Q+i[B+1],H=Q+i[B+2],r(j),r(W),r(H)}this.hasTangents=!0,this.tangentsNeedUpdate=!0},clone:function(){var t=new e.BufferGeometry,r=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];for(var i in this.attributes){for(var o=this.attributes[i],n=o.array,a={itemSize:o.itemSize,numItems:o.numItems,array:null},s=0,l=r.length;l>s;s++){var c=r[s];if(n instanceof c){a.array=new c(n);break}}t.attributes[i]=a}for(var s=0,l=this.offsets.length;l>s;s++){var h=this.offsets[s];t.offsets.push({start:h.start,index:h.index,count:h.count})}return t},dispose:function(){this.dispatchEvent({type:"dispose"})}},e.EventDispatcher.prototype.apply(e.BufferGeometry.prototype),e.Camera=function(){e.Object3D.call(this),this.matrixWorldInverse=new e.Matrix4,this.projectionMatrix=new e.Matrix4,this.projectionMatrixInverse=new e.Matrix4},e.Camera.prototype=Object.create(e.Object3D.prototype),e.Camera.prototype.lookAt=function(){var t=new e.Matrix4;return function(e){t.lookAt(this.position,e,this.up),this.quaternion.setFromRotationMatrix(t)}}(),e.Camera.prototype.clone=function(t){return void 0===t&&(t=new e.Camera),e.Object3D.prototype.clone.call(this,t),t.matrixWorldInverse.copy(this.matrixWorldInverse),t.projectionMatrix.copy(this.projectionMatrix),t.projectionMatrixInverse.copy(this.projectionMatrixInverse),t},e.OrthographicCamera=function(t,r,i,o,n,a){e.Camera.call(this),this.left=t,this.right=r,this.top=i,this.bottom=o,this.near=void 0!==n?n:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()},e.OrthographicCamera.prototype=Object.create(e.Camera.prototype),e.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)},e.OrthographicCamera.prototype.clone=function(){var t=new e.OrthographicCamera;return e.Camera.prototype.clone.call(this,t),t.left=this.left,t.right=this.right,t.top=this.top,t.bottom=this.bottom,t.near=this.near,t.far=this.far,t},e.PerspectiveCamera=function(t,r,i,o){e.Camera.call(this),this.fov=void 0!==t?t:50,this.aspect=void 0!==r?r:1,this.near=void 0!==i?i:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()},e.PerspectiveCamera.prototype=Object.create(e.Camera.prototype),e.PerspectiveCamera.prototype.setLens=function(t,r){void 0===r&&(r=24),this.fov=2*e.Math.radToDeg(Math.atan(r/(2*t))),this.updateProjectionMatrix()},e.PerspectiveCamera.prototype.setViewOffset=function(e,t,r,i,o,n){this.fullWidth=e,this.fullHeight=t,this.x=r,this.y=i,this.width=o,this.height=n,this.updateProjectionMatrix()},e.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var t=this.fullWidth/this.fullHeight,r=Math.tan(e.Math.degToRad(.5*this.fov))*this.near,i=-r,o=t*i,n=t*r,a=Math.abs(n-o),s=Math.abs(r-i);this.projectionMatrix.makeFrustum(o+this.x*a/this.fullWidth,o+(this.x+this.width)*a/this.fullWidth,r-(this.y+this.height)*s/this.fullHeight,r-this.y*s/this.fullHeight,this.near,this.far)}else this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},e.PerspectiveCamera.prototype.clone=function(){var t=new e.PerspectiveCamera;return e.Camera.prototype.clone.call(this,t),t.fov=this.fov,t.aspect=this.aspect,t.near=this.near,t.far=this.far,t},e.Light=function(t){e.Object3D.call(this),this.color=new e.Color(t)},e.Light.prototype=Object.create(e.Object3D.prototype),e.Light.prototype.clone=function(t){return void 0===t&&(t=new e.Light),e.Object3D.prototype.clone.call(this,t),t.color.copy(this.color),t},e.AmbientLight=function(t){e.Light.call(this,t)},e.AmbientLight.prototype=Object.create(e.Light.prototype),e.AmbientLight.prototype.clone=function(){var t=new e.AmbientLight;return e.Light.prototype.clone.call(this,t),t},e.AreaLight=function(t,r){e.Light.call(this,t),this.normal=new e.Vector3(0,-1,0),this.right=new e.Vector3(1,0,0),this.intensity=void 0!==r?r:1,this.width=1,this.height=1,this.constantAttenuation=1.5,this.linearAttenuation=.5,this.quadraticAttenuation=.1},e.AreaLight.prototype=Object.create(e.Light.prototype),e.DirectionalLight=function(t,r){e.Light.call(this,t),this.position.set(0,1,0),this.target=new e.Object3D,this.intensity=void 0!==r?r:1,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new e.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.shadowMatrix=null},e.DirectionalLight.prototype=Object.create(e.Light.prototype),e.DirectionalLight.prototype.clone=function(){var t=new e.DirectionalLight;return e.Light.prototype.clone.call(this,t),t.target=this.target.clone(),t.intensity=this.intensity,t.castShadow=this.castShadow,t.onlyShadow=this.onlyShadow,t},e.HemisphereLight=function(t,r,i){e.Light.call(this,t),this.position.set(0,100,0),this.groundColor=new e.Color(r),this.intensity=void 0!==i?i:1},e.HemisphereLight.prototype=Object.create(e.Light.prototype),e.HemisphereLight.prototype.clone=function(){var t=new e.HemisphereLight;return e.Light.prototype.clone.call(this,t),t.groundColor.copy(this.groundColor),t.intensity=this.intensity,t},e.PointLight=function(t,r,i){e.Light.call(this,t),this.intensity=void 0!==r?r:1,this.distance=void 0!==i?i:0},e.PointLight.prototype=Object.create(e.Light.prototype),e.PointLight.prototype.clone=function(){var t=new e.PointLight;return e.Light.prototype.clone.call(this,t),t.intensity=this.intensity,t.distance=this.distance,t},e.SpotLight=function(t,r,i,o,n){e.Light.call(this,t),this.position.set(0,1,0),this.target=new e.Object3D,this.intensity=void 0!==r?r:1,this.distance=void 0!==i?i:0,this.angle=void 0!==o?o:Math.PI/3,this.exponent=void 0!==n?n:10,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.shadowMatrix=null},e.SpotLight.prototype=Object.create(e.Light.prototype),e.SpotLight.prototype.clone=function(){var t=new e.SpotLight;return e.Light.prototype.clone.call(this,t),t.target=this.target.clone(),t.intensity=this.intensity,t.distance=this.distance,t.angle=this.angle,t.exponent=this.exponent,t.castShadow=this.castShadow,t.onlyShadow=this.onlyShadow,t},e.Loader=function(t){this.showStatus=t,this.statusDomElement=t?e.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},e.Loader.prototype={constructor:e.Loader,crossOrigin:"anonymous",addStatusElement:function(){var e=document.createElement("div");return e.style.position="absolute",e.style.right="0px",e.style.top="0px",e.style.fontSize="0.8em",e.style.textAlign="left",e.style.background="rgba(0,0,0,0.25)",e.style.color="#fff",e.style.width="120px",e.style.padding="0.5em 0.5em 0.5em 0.5em",e.style.zIndex=1e3,e.innerHTML="Loading ...",e},updateProgress:function(e){var t="Loaded ";t+=e.total?(100*e.loaded/e.total).toFixed(0)+"%":(e.loaded/1e3).toFixed(2)+" KB",this.statusDomElement.innerHTML=t},extractUrlBase:function(e){var t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"},initMaterials:function(t,r){for(var i=[],o=0;o<t.length;++o)i[o]=e.Loader.prototype.createMaterial(t[o],r);return i},needsTangents:function(t){for(var r=0,i=t.length;i>r;r++){var o=t[r];if(o instanceof e.ShaderMaterial)return!0}return!1},createMaterial:function(t,r){function i(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)==t}function o(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))}function n(e,t){var r=new Image;r.onload=function(){if(i(this.width)&&i(this.height))e.image=this;else{var t=o(this.width),r=o(this.height);e.image.width=t,e.image.height=r,e.image.getContext("2d").drawImage(this,0,0,t,r)}e.needsUpdate=!0},r.crossOrigin=l.crossOrigin,r.src=t}function a(t,i,o,a,s,l,c){var h=/\.dds$/i.test(o),u=r+"/"+o;if(h){var p=e.ImageUtils.loadCompressedTexture(u);t[i]=p}else{var p=document.createElement("canvas");t[i]=new e.Texture(p)}if(t[i].sourceFile=o,a&&(t[i].repeat.set(a[0],a[1]),1!==a[0]&&(t[i].wrapS=e.RepeatWrapping),1!==a[1]&&(t[i].wrapT=e.RepeatWrapping)),s&&t[i].offset.set(s[0],s[1]),l){var d={repeat:e.RepeatWrapping,mirror:e.MirroredRepeatWrapping};void 0!==d[l[0]]&&(t[i].wrapS=d[l[0]]),void 0!==d[l[1]]&&(t[i].wrapT=d[l[1]])}c&&(t[i].anisotropy=c),h||n(t[i],u)}function s(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}var l=this,c="MeshLambertMaterial",h={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(t.shading){var u=t.shading.toLowerCase();"phong"===u?c="MeshPhongMaterial":"basic"===u&&(c="MeshBasicMaterial")}if(void 0!==t.blending&&void 0!==e[t.blending]&&(h.blending=e[t.blending]),(void 0!==t.transparent||t.opacity<1)&&(h.transparent=t.transparent),void 0!==t.depthTest&&(h.depthTest=t.depthTest),void 0!==t.depthWrite&&(h.depthWrite=t.depthWrite),void 0!==t.visible&&(h.visible=t.visible),void 0!==t.flipSided&&(h.side=e.BackSide),void 0!==t.doubleSided&&(h.side=e.DoubleSide),void 0!==t.wireframe&&(h.wireframe=t.wireframe),void 0!==t.vertexColors&&("face"===t.vertexColors?h.vertexColors=e.FaceColors:t.vertexColors&&(h.vertexColors=e.VertexColors)),t.colorDiffuse?h.color=s(t.colorDiffuse):t.DbgColor&&(h.color=t.DbgColor),t.colorSpecular&&(h.specular=s(t.colorSpecular)),t.colorAmbient&&(h.ambient=s(t.colorAmbient)),t.transparency&&(h.opacity=t.transparency),t.specularCoef&&(h.shininess=t.specularCoef),t.mapDiffuse&&r&&a(h,"map",t.mapDiffuse,t.mapDiffuseRepeat,t.mapDiffuseOffset,t.mapDiffuseWrap,t.mapDiffuseAnisotropy),t.mapLight&&r&&a(h,"lightMap",t.mapLight,t.mapLightRepeat,t.mapLightOffset,t.mapLightWrap,t.mapLightAnisotropy),t.mapBump&&r&&a(h,"bumpMap",t.mapBump,t.mapBumpRepeat,t.mapBumpOffset,t.mapBumpWrap,t.mapBumpAnisotropy),t.mapNormal&&r&&a(h,"normalMap",t.mapNormal,t.mapNormalRepeat,t.mapNormalOffset,t.mapNormalWrap,t.mapNormalAnisotropy),t.mapSpecular&&r&&a(h,"specularMap",t.mapSpecular,t.mapSpecularRepeat,t.mapSpecularOffset,t.mapSpecularWrap,t.mapSpecularAnisotropy),t.mapBumpScale&&(h.bumpScale=t.mapBumpScale),t.mapNormal){var p=e.ShaderLib.normalmap,d=e.UniformsUtils.clone(p.uniforms);d.tNormal.value=h.normalMap,t.mapNormalFactor&&d.uNormalScale.value.set(t.mapNormalFactor,t.mapNormalFactor),h.map&&(d.tDiffuse.value=h.map,d.enableDiffuse.value=!0),h.specularMap&&(d.tSpecular.value=h.specularMap,d.enableSpecular.value=!0),h.lightMap&&(d.tAO.value=h.lightMap,d.enableAO.value=!0),d.uDiffuseColor.value.setHex(h.color),d.uSpecularColor.value.setHex(h.specular),d.uAmbientColor.value.setHex(h.ambient),d.uShininess.value=h.shininess,void 0!==h.opacity&&(d.uOpacity.value=h.opacity);var f={fragmentShader:p.fragmentShader,vertexShader:p.vertexShader,uniforms:d,lights:!0,fog:!0},m=new e.ShaderMaterial(f);h.transparent&&(m.transparent=!0)}else var m=new e[c](h);return void 0!==t.DbgName&&(m.name=t.DbgName),m}},e.XHRLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.XHRLoader.prototype={constructor:e.XHRLoader,load:function(e,t,r,i){var o=this,n=new XMLHttpRequest;void 0!==t&&n.addEventListener("load",function(r){t(r.target.responseText),o.manager.itemEnd(e)},!1),void 0!==r&&n.addEventListener("progress",function(e){r(e)},!1),void 0!==i&&n.addEventListener("error",function(e){i(e)},!1),void 0!==this.crossOrigin&&(n.crossOrigin=this.crossOrigin),n.open("GET",e,!0),n.send(null),o.manager.itemStart(e)},setCrossOrigin:function(e){this.crossOrigin=e}},e.ImageLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.ImageLoader.prototype={constructor:e.ImageLoader,load:function(e,t,r,i){var o=this,n=document.createElement("img");return void 0!==t&&n.addEventListener("load",function(r){o.manager.itemEnd(e),t(this)},!1),void 0!==r&&n.addEventListener("progress",function(e){r(e)},!1),void 0!==i&&n.addEventListener("error",function(e){i(e)},!1),void 0!==this.crossOrigin&&(n.crossOrigin=this.crossOrigin),n.src=e,o.manager.itemStart(e),n},setCrossOrigin:function(e){this.crossOrigin=e}},e.JSONLoader=function(t){e.Loader.call(this,t),this.withCredentials=!1},e.JSONLoader.prototype=Object.create(e.Loader.prototype),e.JSONLoader.prototype.load=function(e,t,r){r=r&&"string"==typeof r?r:this.extractUrlBase(e),this.onLoadStart(),this.loadAjaxJSON(this,e,t,r)},e.JSONLoader.prototype.loadAjaxJSON=function(e,t,r,i,o){var n=new XMLHttpRequest,a=0;n.onreadystatechange=function(){if(n.readyState===n.DONE)if(200===n.status||0===n.status){if(n.responseText){var s=JSON.parse(n.responseText),l=e.parse(s,i);r(l.geometry,l.materials)}else console.warn("THREE.JSONLoader: ["+t+"] seems to be unreachable or file there is empty");e.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+t+"] ["+n.status+"]");else n.readyState===n.LOADING?o&&(0===a&&(a=n.getResponseHeader("Content-Length")),o({total:a,loaded:n.responseText.length})):n.readyState===n.HEADERS_RECEIVED&&void 0!==o&&(a=n.getResponseHeader("Content-Length"))},n.open("GET",t,!0),n.withCredentials=this.withCredentials,n.send(null)},e.JSONLoader.prototype.parse=function(t,r){function i(r){function i(e,t){return e&1<<t}var o,n,s,l,c,h,u,p,d,f,m,v,g,y,x,w,b,_,M,S,T,C,L,A,P,D,F,E=t.faces,V=t.vertices,R=t.normals,z=t.colors,I=0;if(void 0!==t.uvs){for(o=0;o<t.uvs.length;o++)t.uvs[o].length&&I++;for(o=0;I>o;o++)a.faceVertexUvs[o]=[]}for(l=0,c=V.length;c>l;)_=new e.Vector3,_.x=V[l++]*r,_.y=V[l++]*r,_.z=V[l++]*r,a.vertices.push(_);for(l=0,c=E.length;c>l;)if(f=E[l++],m=i(f,0),v=i(f,1),g=i(f,3),y=i(f,4),x=i(f,5),w=i(f,6),b=i(f,7),m){if(S=new e.Face3,S.a=E[l],S.b=E[l+1],S.c=E[l+3],T=new e.Face3,T.a=E[l+1],T.b=E[l+2],T.c=E[l+3],l+=4,v&&(d=E[l++],S.materialIndex=d,T.materialIndex=d),s=a.faces.length,g)for(o=0;I>o;o++)for(A=t.uvs[o],a.faceVertexUvs[o][s]=[],a.faceVertexUvs[o][s+1]=[],n=0;4>n;n++)p=E[l++],D=A[2*p],F=A[2*p+1],P=new e.Vector2(D,F),2!==n&&a.faceVertexUvs[o][s].push(P),0!==n&&a.faceVertexUvs[o][s+1].push(P);if(y&&(u=3*E[l++],S.normal.set(R[u++],R[u++],R[u]),T.normal.copy(S.normal)),x)for(o=0;4>o;o++)u=3*E[l++],L=new e.Vector3(R[u++],R[u++],R[u]),2!==o&&S.vertexNormals.push(L),0!==o&&T.vertexNormals.push(L);if(w&&(h=E[l++],C=z[h],S.color.setHex(C),T.color.setHex(C)),b)for(o=0;4>o;o++)h=E[l++],C=z[h],2!==o&&S.vertexColors.push(new e.Color(C)),0!==o&&T.vertexColors.push(new e.Color(C));a.faces.push(S),a.faces.push(T)}else{if(M=new e.Face3,M.a=E[l++],M.b=E[l++],M.c=E[l++],v&&(d=E[l++],M.materialIndex=d),s=a.faces.length,g)for(o=0;I>o;o++)for(A=t.uvs[o],a.faceVertexUvs[o][s]=[],n=0;3>n;n++)p=E[l++],D=A[2*p],F=A[2*p+1],P=new e.Vector2(D,F),a.faceVertexUvs[o][s].push(P);if(y&&(u=3*E[l++],M.normal.set(R[u++],R[u++],R[u])),x)for(o=0;3>o;o++)u=3*E[l++],L=new e.Vector3(R[u++],R[u++],R[u]),M.vertexNormals.push(L);if(w&&(h=E[l++],M.color.setHex(z[h])),b)for(o=0;3>o;o++)h=E[l++],M.vertexColors.push(new e.Color(z[h]));a.faces.push(M)}}function o(){var r,i,o,n,s,l,c,h,u,p;if(t.skinWeights)for(r=0,i=t.skinWeights.length;i>r;r+=2)o=t.skinWeights[r],n=t.skinWeights[r+1],s=0,l=0,a.skinWeights.push(new e.Vector4(o,n,s,l));if(t.skinIndices)for(r=0,i=t.skinIndices.length;i>r;r+=2)c=t.skinIndices[r],h=t.skinIndices[r+1],u=0,p=0,a.skinIndices.push(new e.Vector4(c,h,u,p));a.bones=t.bones,a.animation=t.animation,a.animations=t.animations}function n(r){if(void 0!==t.morphTargets){var i,o,n,s,l,c;for(i=0,o=t.morphTargets.length;o>i;i++)for(a.morphTargets[i]={},a.morphTargets[i].name=t.morphTargets[i].name,a.morphTargets[i].vertices=[],l=a.morphTargets[i].vertices,c=t.morphTargets[i].vertices,n=0,s=c.length;s>n;n+=3){var h=new e.Vector3;h.x=c[n]*r,h.y=c[n+1]*r,h.z=c[n+2]*r,l.push(h)}}if(void 0!==t.morphColors){var i,o,u,p,d,f,m;for(i=0,o=t.morphColors.length;o>i;i++)for(a.morphColors[i]={},a.morphColors[i].name=t.morphColors[i].name,a.morphColors[i].colors=[],d=a.morphColors[i].colors,f=t.morphColors[i].colors,u=0,p=f.length;p>u;u+=3)m=new e.Color(16755200),m.setRGB(f[u],f[u+1],f[u+2]),d.push(m)}}var a=new e.Geometry,s=void 0!==t.scale?1/t.scale:1;if(i(s),o(),n(s),a.computeCentroids(),a.computeFaceNormals(),a.computeBoundingSphere(),void 0===t.materials)return{geometry:a};var l=this.initMaterials(t.materials,r);return this.needsTangents(l)&&a.computeTangents(),{geometry:a,materials:l}},e.LoadingManager=function(e,t,r){var i=this,o=0,n=0;this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){n++},this.itemEnd=function(e){o++,void 0!==i.onProgress&&i.onProgress(e,o,n),o===n&&void 0!==i.onLoad&&i.onLoad()}},e.DefaultLoadingManager=new e.LoadingManager,e.BufferGeometryLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.BufferGeometryLoader.prototype={constructor:e.BufferGeometryLoader,load:function(t,r,i,o){var n=this,a=new e.XHRLoader;a.setCrossOrigin(this.crossOrigin),a.load(t,function(e){r(n.parse(JSON.parse(e)))})},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(t){var r=new e.BufferGeometry,i=t.attributes,o=t.offsets,n=t.boundingSphere;for(var a in i){var s=i[a];r.attributes[a]={itemSize:s.itemSize,array:new self[s.type](s.array)}}return void 0!==o&&(r.offsets=JSON.parse(JSON.stringify(o))),void 0!==n&&(r.boundingSphere=new e.Sphere((new e.Vector3).fromArray(void 0!==n.center?n.center:[0,0,0]),n.radius)),r}},e.GeometryLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.GeometryLoader.prototype={constructor:e.GeometryLoader,load:function(t,r,i,o){var n=this,a=new e.XHRLoader;a.setCrossOrigin(this.crossOrigin),a.load(t,function(e){r(n.parse(JSON.parse(e)))})},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e){}},e.MaterialLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.MaterialLoader.prototype={constructor:e.MaterialLoader,load:function(t,r,i,o){var n=this,a=new e.XHRLoader;a.setCrossOrigin(this.crossOrigin),a.load(t,function(e){r(n.parse(JSON.parse(e)))})},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(t){var r=new e[t.type];if(void 0!==t.color&&r.color.setHex(t.color),void 0!==t.ambient&&r.ambient.setHex(t.ambient),void 0!==t.emissive&&r.emissive.setHex(t.emissive),void 0!==t.specular&&r.specular.setHex(t.specular),void 0!==t.shininess&&(r.shininess=t.shininess),void 0!==t.vertexColors&&(r.vertexColors=t.vertexColors),void 0!==t.blending&&(r.blending=t.blending),void 0!==t.side&&(r.side=t.side),void 0!==t.opacity&&(r.opacity=t.opacity),void 0!==t.transparent&&(r.transparent=t.transparent),void 0!==t.wireframe&&(r.wireframe=t.wireframe),void 0!==t.materials)for(var i=0,o=t.materials.length;o>i;i++)r.materials.push(this.parse(t.materials[i]));return r}},e.ObjectLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.ObjectLoader.prototype={constructor:e.ObjectLoader,load:function(t,r,i,o){var n=this,a=new e.XHRLoader(n.manager);a.setCrossOrigin(this.crossOrigin),a.load(t,function(e){r(n.parse(JSON.parse(e)))})},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e){var t=this.parseGeometries(e.geometries),r=this.parseMaterials(e.materials),i=this.parseObject(e.object,t,r);return i},parseGeometries:function(t){var r={};if(void 0!==t)for(var i=new e.JSONLoader,o=new e.BufferGeometryLoader,n=0,a=t.length;a>n;n++){var s,l=t[n];switch(l.type){case"PlaneGeometry":s=new e.PlaneGeometry(l.width,l.height,l.widthSegments,l.heightSegments);break;case"CircleGeometry":s=new e.CircleGeometry(l.radius,l.segments);break;case"CubeGeometry":s=new e.CubeGeometry(l.width,l.height,l.depth,l.widthSegments,l.heightSegments,l.depthSegments);break;case"CylinderGeometry":s=new e.CylinderGeometry(l.radiusTop,l.radiusBottom,l.height,l.radialSegments,l.heightSegments,l.openEnded);break;case"SphereGeometry":s=new e.SphereGeometry(l.radius,l.widthSegments,l.heightSegments,l.phiStart,l.phiLength,l.thetaStart,l.thetaLength);break;case"IcosahedronGeometry":s=new e.IcosahedronGeometry(l.radius,l.detail);break;case"TorusGeometry":s=new e.TorusGeometry(l.radius,l.tube,l.radialSegments,l.tubularSegments,l.arc);break;case"TorusKnotGeometry":s=new e.TorusKnotGeometry(l.radius,l.tube,l.radialSegments,l.tubularSegments,l.p,l.q,l.heightScale);break;case"BufferGeometry":s=o.parse(l.data);break;case"Geometry":s=i.parse(l.data).geometry}s.uuid=l.uuid,void 0!==l.name&&(s.name=l.name),r[l.uuid]=s}return r},parseMaterials:function(t){var r={};if(void 0!==t)for(var i=new e.MaterialLoader,o=0,n=t.length;n>o;o++){var a=t[o],s=i.parse(a);s.uuid=a.uuid,void 0!==a.name&&(s.name=a.name),r[a.uuid]=s}return r},parseObject:function(){var t=new e.Matrix4;return function(r,i,o){var n;switch(r.type){case"Scene":n=new e.Scene;break;case"PerspectiveCamera":n=new e.PerspectiveCamera(r.fov,r.aspect,r.near,r.far);break;case"OrthographicCamera":n=new e.OrthographicCamera(r.left,r.right,r.top,r.bottom,r.near,r.far);break;case"AmbientLight":n=new e.AmbientLight(r.color);break;case"DirectionalLight":n=new e.DirectionalLight(r.color,r.intensity);break;case"PointLight":n=new e.PointLight(r.color,r.intensity,r.distance);break;case"SpotLight":n=new e.SpotLight(r.color,r.intensity,r.distance,r.angle,r.exponent);break;case"HemisphereLight":n=new e.HemisphereLight(r.color,r.groundColor,r.intensity);break;case"Mesh":var a=i[r.geometry],s=o[r.material];void 0===a&&console.error("THREE.ObjectLoader: Undefined geometry "+r.geometry),void 0===s&&console.error("THREE.ObjectLoader: Undefined material "+r.material),n=new e.Mesh(a,s);break;case"Sprite":var s=o[r.material];void 0===s&&console.error("THREE.ObjectLoader: Undefined material "+r.material),n=new e.Sprite(s);break;default:n=new e.Object3D}if(n.uuid=r.uuid,void 0!==r.name&&(n.name=r.name),void 0!==r.matrix?(t.fromArray(r.matrix),t.decompose(n.position,n.quaternion,n.scale)):(void 0!==r.position&&n.position.fromArray(r.position),void 0!==r.rotation&&n.rotation.fromArray(r.rotation),void 0!==r.scale&&n.scale.fromArray(r.scale)),void 0!==r.visible&&(n.visible=r.visible),void 0!==r.userData&&(n.userData=r.userData),void 0!==r.children)for(var l in r.children)n.add(this.parseObject(r.children[l],i,o));return n}}()},e.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){},this.geometryHandlers={},this.hierarchyHandlers={},this.addGeometryHandler("ascii",e.JSONLoader)},e.SceneLoader.prototype={constructor:e.SceneLoader,load:function(t,r,i,o){var n=this,a=new e.XHRLoader(n.manager);a.setCrossOrigin(this.crossOrigin),a.load(t,function(e){n.parse(JSON.parse(e),r,t)})},setCrossOrigin:function(e){this.crossOrigin=e},addGeometryHandler:function(e,t){this.geometryHandlers[e]={loaderClass:t}},addHierarchyHandler:function(e,t){this.hierarchyHandlers[e]={loaderClass:t}},parse:function(t,r,i){function o(e,t){return"relativeToHTML"==t?e:A+"/"+e}function n(){a(C.scene,D.objects)}function a(t,r){var i,n,s,l,c;for(var u in r){var p=C.objects[u],d=r[u];if(void 0===p){if(d.type&&d.type in L.hierarchyHandlers){if(void 0===d.loading){var f={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1},y={};for(var x in d)x in f||(y[x]=d[x]);v=C.materials[d.material],d.loading=!0;var w=L.hierarchyHandlers[d.type].loaderObject;w.options?w.load(o(d.url,D.urlBaseType),h(u,t,v,d)):w.load(o(d.url,D.urlBaseType),h(u,t,v,d),y)}}else if(void 0!==d.geometry){if(m=C.geometries[d.geometry]){var _=!1;if(v=C.materials[d.material],_=v instanceof e.ShaderMaterial,n=d.position,s=d.rotation,l=d.scale,i=d.matrix,c=d.quaternion,d.material||(v=new e.MeshFaceMaterial(C.face_materials[d.geometry])),v instanceof e.MeshFaceMaterial&&0===v.materials.length&&(v=new e.MeshFaceMaterial(C.face_materials[d.geometry])),v instanceof e.MeshFaceMaterial)for(var M=0;M<v.materials.length;M++)_=_||v.materials[M]instanceof e.ShaderMaterial;_&&m.computeTangents(),d.skin?p=new e.SkinnedMesh(m,v):d.morph?(p=new e.MorphAnimMesh(m,v),void 0!==d.duration&&(p.duration=d.duration),void 0!==d.time&&(p.time=d.time),void 0!==d.mirroredLoop&&(p.mirroredLoop=d.mirroredLoop),v.morphNormals&&m.computeMorphNormals()):p=new e.Mesh(m,v),p.name=u,i?(p.matrixAutoUpdate=!1,p.matrix.set(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15])):(p.position.fromArray(n),c?p.quaternion.fromArray(c):p.rotation.fromArray(s),p.scale.fromArray(l)),p.visible=d.visible,p.castShadow=d.castShadow,p.receiveShadow=d.receiveShadow,t.add(p),C.objects[u]=p}}else if("AmbientLight"===d.type||"PointLight"===d.type||"DirectionalLight"===d.type||"SpotLight"===d.type||"HemisphereLight"===d.type||"AreaLight"===d.type){var S=d.color,T=d.intensity,A=d.distance,P=d.position,F=d.rotation;switch(d.type){case"AmbientLight":b=new e.AmbientLight(S);break;case"PointLight":b=new e.PointLight(S,T,A),b.position.fromArray(P);break;case"DirectionalLight":b=new e.DirectionalLight(S,T),b.position.fromArray(d.direction);break;case"SpotLight":b=new e.SpotLight(S,T,A,1),b.angle=d.angle,b.position.fromArray(P),b.target.set(P[0],P[1]-A,P[2]),b.target.applyEuler(new e.Euler(F[0],F[1],F[2],"XYZ"));break;case"HemisphereLight":b=new e.DirectionalLight(S,T,A),b.target.set(P[0],P[1]-A,P[2]),b.target.applyEuler(new e.Euler(F[0],F[1],F[2],"XYZ"));break;case"AreaLight":b=new e.AreaLight(S,T),b.position.fromArray(P),b.width=d.size,b.height=d.size_y}t.add(b),b.name=u,C.lights[u]=b,C.objects[u]=b}else"PerspectiveCamera"===d.type||"OrthographicCamera"===d.type?(n=d.position,s=d.rotation,c=d.quaternion,"PerspectiveCamera"===d.type?g=new e.PerspectiveCamera(d.fov,d.aspect,d.near,d.far):"OrthographicCamera"===d.type&&(g=new e.OrthographicCamera(d.left,d.right,d.top,d.bottom,d.near,d.far)),g.name=u,g.position.fromArray(n),void 0!==c?g.quaternion.fromArray(c):void 0!==s&&g.rotation.fromArray(s),t.add(g),C.cameras[u]=g,C.objects[u]=g):(n=d.position,s=d.rotation,l=d.scale,c=d.quaternion,p=new e.Object3D,p.name=u,p.position.fromArray(n),c?p.quaternion.fromArray(c):p.rotation.fromArray(s),p.scale.fromArray(l),p.visible=void 0!==d.visible?d.visible:!1,t.add(p),C.objects[u]=p,C.empties[u]=p);if(p){if(void 0!==d.userData)for(var E in d.userData){var V=d.userData[E];p.userData[E]=V}if(void 0!==d.groups)for(var M=0;M<d.groups.length;M++){var R=d.groups[M];void 0===C.groups[R]&&(C.groups[R]=[]),C.groups[R].push(u)}}}void 0!==p&&void 0!==d.children&&a(p,d.children)}}function s(e,t,r){C.geometries[r]=e,C.face_materials[r]=t,n()}function l(e,t,r,i,o){var a=o.position,s=o.rotation,l=o.quaternion,c=o.scale;e.position.fromArray(a),l?e.quaternion.fromArray(l):e.rotation.fromArray(s),e.scale.fromArray(c),i&&e.traverse(function(e){e.material=i});var h=void 0!==o.visible?o.visible:!0;e.traverse(function(e){e.visible=h}),r.add(e),e.name=t,C.objects[t]=e,n()}function c(e){return function(t,r){t.name=e,s(t,r,e),_-=1,L.onLoadComplete(),p()}}function h(e,t,r,i){return function(o){var n;n=o.content?o.content:o.dae?o.scene:o,l(n,e,t,r,i),_-=1,L.onLoadComplete(),p()}}function u(e){return function(t,r){t.name=e,C.geometries[e]=t,C.face_materials[e]=r}}function p(){var e={totalModels:S,totalTextures:T,loadedModels:S-_,loadedTextures:T-M};L.callbackProgress(e,C),L.onLoadProgress(),0===_&&0===M&&(d(),r(C))}function d(){for(var t=0;t<P.length;t++){var r=P[t],i=C.objects[r.targetName];i?r.object.target=i:(r.object.target=new e.Object3D,C.scene.add(r.object.target)),r.object.target.userData.targetInverse=r.object}}function f(e,t){if(t(e),void 0!==e.children)for(var r in e.children)f(e.children[r],t)}var m,v,g,y,x,w,b,_,M,S,T,C,L=this,A=e.Loader.prototype.extractUrlBase(i),P=[],D=t;for(var F in this.geometryHandlers){var E=this.geometryHandlers[F].loaderClass;this.geometryHandlers[F].loaderObject=new E}for(var F in this.hierarchyHandlers){var E=this.hierarchyHandlers[F].loaderClass;this.hierarchyHandlers[F].loaderObject=new E}if(_=0,M=0,C={scene:new e.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}},D.transform){var V=D.transform.position,R=D.transform.rotation,z=D.transform.scale;V&&C.scene.position.fromArray(V),R&&C.scene.rotation.fromArray(R),z&&C.scene.scale.fromArray(z),(V||R||z)&&(C.scene.updateMatrix(),C.scene.updateMatrixWorld())}var I,U,O=function(e){M-=e,p(),L.onLoadComplete()},B=function(e){return function(){O(e)}};for(I in D.fogs)U=D.fogs[I],"linear"===U.type?y=new e.Fog(0,U.near,U.far):"exp2"===U.type&&(y=new e.FogExp2(0,U.density)),w=U.color,y.color.setRGB(w[0],w[1],w[2]),C.fogs[I]=y;var N,k;for(N in D.geometries)k=D.geometries[N],k.type in this.geometryHandlers&&(_+=1,L.onLoadStart());for(var G in D.objects)f(D.objects[G],function(e){e.type&&e.type in L.hierarchyHandlers&&(_+=1,L.onLoadStart())});S=_;for(N in D.geometries)if(k=D.geometries[N],"cube"===k.type)m=new e.CubeGeometry(k.width,k.height,k.depth,k.widthSegments,k.heightSegments,k.depthSegments),m.name=N,C.geometries[N]=m;else if("plane"===k.type)m=new e.PlaneGeometry(k.width,k.height,k.widthSegments,k.heightSegments),m.name=N,C.geometries[N]=m;else if("sphere"===k.type)m=new e.SphereGeometry(k.radius,k.widthSegments,k.heightSegments),m.name=N,C.geometries[N]=m;else if("cylinder"===k.type)m=new e.CylinderGeometry(k.topRad,k.botRad,k.height,k.radSegs,k.heightSegs),m.name=N,C.geometries[N]=m;else if("torus"===k.type)m=new e.TorusGeometry(k.radius,k.tube,k.segmentsR,k.segmentsT),m.name=N,C.geometries[N]=m;else if("icosahedron"===k.type)m=new e.IcosahedronGeometry(k.radius,k.subdivisions),m.name=N,C.geometries[N]=m;else if(k.type in this.geometryHandlers){var j={};for(var W in k)"type"!==W&&"url"!==W&&(j[W]=k[W]);var H=this.geometryHandlers[k.type].loaderObject;H.load(o(k.url,D.urlBaseType),c(N),j)}else if("embedded"===k.type){var X=D.embeds[k.id],q="";if(X.metadata=D.metadata,X){var Y=this.geometryHandlers.ascii.loaderObject,Z=Y.parse(X,q);u(N)(Z.geometry,Z.materials)}}var K,Q;for(K in D.textures)if(Q=D.textures[K],Q.url instanceof Array){M+=Q.url.length;for(var J=0;J<Q.url.length;J++)L.onLoadStart()}else M+=1,L.onLoadStart();T=M;for(K in D.textures){if(Q=D.textures[K],void 0!==Q.mapping&&void 0!==e[Q.mapping]&&(Q.mapping=new e[Q.mapping]),Q.url instanceof Array){for(var $=Q.url.length,ee=[],te=0;$>te;te++)ee[te]=o(Q.url[te],D.urlBaseType);var re=/\.dds$/i.test(ee[0]);x=re?e.ImageUtils.loadCompressedTextureCube(ee,Q.mapping,B($)):e.ImageUtils.loadTextureCube(ee,Q.mapping,B($))}else{var re=/\.dds$/i.test(Q.url),ie=o(Q.url,D.urlBaseType),oe=B(1);if(x=re?e.ImageUtils.loadCompressedTexture(ie,Q.mapping,oe):e.ImageUtils.loadTexture(ie,Q.mapping,oe),void 0!==e[Q.minFilter]&&(x.minFilter=e[Q.minFilter]),void 0!==e[Q.magFilter]&&(x.magFilter=e[Q.magFilter]),Q.anisotropy&&(x.anisotropy=Q.anisotropy),Q.repeat&&(x.repeat.set(Q.repeat[0],Q.repeat[1]),1!==Q.repeat[0]&&(x.wrapS=e.RepeatWrapping),1!==Q.repeat[1]&&(x.wrapT=e.RepeatWrapping)),Q.offset&&x.offset.set(Q.offset[0],Q.offset[1]),Q.wrap){var ne={repeat:e.RepeatWrapping,mirror:e.MirroredRepeatWrapping};void 0!==ne[Q.wrap[0]]&&(x.wrapS=ne[Q.wrap[0]]),void 0!==ne[Q.wrap[1]]&&(x.wrapT=ne[Q.wrap[1]])}}C.textures[K]=x}var ae,se,le;
for(ae in D.materials){se=D.materials[ae];for(le in se.parameters)if("envMap"===le||"map"===le||"lightMap"===le||"bumpMap"===le)se.parameters[le]=C.textures[se.parameters[le]];else if("shading"===le)se.parameters[le]="flat"===se.parameters[le]?e.FlatShading:e.SmoothShading;else if("side"===le)"double"==se.parameters[le]?se.parameters[le]=e.DoubleSide:"back"==se.parameters[le]?se.parameters[le]=e.BackSide:se.parameters[le]=e.FrontSide;else if("blending"===le)se.parameters[le]=se.parameters[le]in e?e[se.parameters[le]]:e.NormalBlending;else if("combine"===le)se.parameters[le]=se.parameters[le]in e?e[se.parameters[le]]:e.MultiplyOperation;else if("vertexColors"===le)"face"==se.parameters[le]?se.parameters[le]=e.FaceColors:se.parameters[le]&&(se.parameters[le]=e.VertexColors);else if("wrapRGB"===le){var ce=se.parameters[le];se.parameters[le]=new e.Vector3(ce[0],ce[1],ce[2])}if(void 0!==se.parameters.opacity&&se.parameters.opacity<1&&(se.parameters.transparent=!0),se.parameters.normalMap){var he=e.ShaderLib.normalmap,ue=e.UniformsUtils.clone(he.uniforms),pe=se.parameters.color,de=se.parameters.specular,fe=se.parameters.ambient,me=se.parameters.shininess;ue.tNormal.value=C.textures[se.parameters.normalMap],se.parameters.normalScale&&ue.uNormalScale.value.set(se.parameters.normalScale[0],se.parameters.normalScale[1]),se.parameters.map&&(ue.tDiffuse.value=se.parameters.map,ue.enableDiffuse.value=!0),se.parameters.envMap&&(ue.tCube.value=se.parameters.envMap,ue.enableReflection.value=!0,ue.uReflectivity.value=se.parameters.reflectivity),se.parameters.lightMap&&(ue.tAO.value=se.parameters.lightMap,ue.enableAO.value=!0),se.parameters.specularMap&&(ue.tSpecular.value=C.textures[se.parameters.specularMap],ue.enableSpecular.value=!0),se.parameters.displacementMap&&(ue.tDisplacement.value=C.textures[se.parameters.displacementMap],ue.enableDisplacement.value=!0,ue.uDisplacementBias.value=se.parameters.displacementBias,ue.uDisplacementScale.value=se.parameters.displacementScale),ue.uDiffuseColor.value.setHex(pe),ue.uSpecularColor.value.setHex(de),ue.uAmbientColor.value.setHex(fe),ue.uShininess.value=me,se.parameters.opacity&&(ue.uOpacity.value=se.parameters.opacity);var ve={fragmentShader:he.fragmentShader,vertexShader:he.vertexShader,uniforms:ue,lights:!0,fog:!0};v=new e.ShaderMaterial(ve)}else v=new e[se.type](se.parameters);v.name=ae,C.materials[ae]=v}for(ae in D.materials)if(se=D.materials[ae],se.parameters.materials){for(var ge=[],te=0;te<se.parameters.materials.length;te++){var ye=se.parameters.materials[te];ge.push(C.materials[ye])}C.materials[ae].materials=ge}n(),C.cameras&&D.defaults.camera&&(C.currentCamera=C.cameras[D.defaults.camera]),C.fogs&&D.defaults.fog&&(C.scene.fog=C.fogs[D.defaults.fog]),L.callbackSync(C),p()}},e.TextureLoader=function(t){this.manager=void 0!==t?t:e.DefaultLoadingManager},e.TextureLoader.prototype={constructor:e.TextureLoader,load:function(t,r,i,o){var n=this,a=new e.ImageLoader(n.manager);a.setCrossOrigin(this.crossOrigin),a.load(t,function(t){var i=new e.Texture(t);i.needsUpdate=!0,void 0!==r&&r(i)})},setCrossOrigin:function(e){this.crossOrigin=e}},e.Material=function(){this.id=e.MaterialIdCount++,this.uuid=e.Math.generateUUID(),this.name="",this.side=e.FrontSide,this.opacity=1,this.transparent=!1,this.blending=e.NormalBlending,this.blendSrc=e.SrcAlphaFactor,this.blendDst=e.OneMinusSrcAlphaFactor,this.blendEquation=e.AddEquation,this.depthTest=!0,this.depthWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.overdraw=0,this.visible=!0,this.needsUpdate=!0},e.Material.prototype={constructor:e.Material,setValues:function(t){if(void 0!==t)for(var r in t){var i=t[r];if(void 0!==i){if(r in this){var o=this[r];o instanceof e.Color?o.set(i):o instanceof e.Vector3&&i instanceof e.Vector3?o.copy(i):"overdraw"==r?this[r]=Number(i):this[r]=i}}else console.warn("THREE.Material: '"+r+"' parameter is undefined.")}},clone:function(t){return void 0===t&&(t=new e.Material),t.name=this.name,t.side=this.side,t.opacity=this.opacity,t.transparent=this.transparent,t.blending=this.blending,t.blendSrc=this.blendSrc,t.blendDst=this.blendDst,t.blendEquation=this.blendEquation,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.polygonOffset=this.polygonOffset,t.polygonOffsetFactor=this.polygonOffsetFactor,t.polygonOffsetUnits=this.polygonOffsetUnits,t.alphaTest=this.alphaTest,t.overdraw=this.overdraw,t.visible=this.visible,t},dispose:function(){this.dispatchEvent({type:"dispose"})}},e.EventDispatcher.prototype.apply(e.Material.prototype),e.MaterialIdCount=0,e.LineBasicMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.vertexColors=!1,this.fog=!0,this.setValues(t)},e.LineBasicMaterial.prototype=Object.create(e.Material.prototype),e.LineBasicMaterial.prototype.clone=function(){var t=new e.LineBasicMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.linewidth=this.linewidth,t.linecap=this.linecap,t.linejoin=this.linejoin,t.vertexColors=this.vertexColors,t.fog=this.fog,t},e.LineDashedMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.linewidth=1,this.scale=1,this.dashSize=3,this.gapSize=1,this.vertexColors=!1,this.fog=!0,this.setValues(t)},e.LineDashedMaterial.prototype=Object.create(e.Material.prototype),e.LineDashedMaterial.prototype.clone=function(){var t=new e.LineDashedMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.linewidth=this.linewidth,t.scale=this.scale,t.dashSize=this.dashSize,t.gapSize=this.gapSize,t.vertexColors=this.vertexColors,t.fog=this.fog,t},e.MeshBasicMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=e.NoColors,this.skinning=!1,this.morphTargets=!1,this.setValues(t)},e.MeshBasicMaterial.prototype=Object.create(e.Material.prototype),e.MeshBasicMaterial.prototype.clone=function(){var t=new e.MeshBasicMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.map=this.map,t.lightMap=this.lightMap,t.specularMap=this.specularMap,t.envMap=this.envMap,t.combine=this.combine,t.reflectivity=this.reflectivity,t.refractionRatio=this.refractionRatio,t.fog=this.fog,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.wireframeLinecap=this.wireframeLinecap,t.wireframeLinejoin=this.wireframeLinejoin,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t},e.MeshLambertMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=e.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)},e.MeshLambertMaterial.prototype=Object.create(e.Material.prototype),e.MeshLambertMaterial.prototype.clone=function(){var t=new e.MeshLambertMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.ambient.copy(this.ambient),t.emissive.copy(this.emissive),t.wrapAround=this.wrapAround,t.wrapRGB.copy(this.wrapRGB),t.map=this.map,t.lightMap=this.lightMap,t.specularMap=this.specularMap,t.envMap=this.envMap,t.combine=this.combine,t.reflectivity=this.reflectivity,t.refractionRatio=this.refractionRatio,t.fog=this.fog,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.wireframeLinecap=this.wireframeLinecap,t.wireframeLinejoin=this.wireframeLinejoin,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t.morphNormals=this.morphNormals,t},e.MeshPhongMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.specular=new e.Color(1118481),this.shininess=30,this.metal=!1,this.perPixel=!0,this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this.map=null,this.lightMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new e.Vector2(1,1),this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=e.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)},e.MeshPhongMaterial.prototype=Object.create(e.Material.prototype),e.MeshPhongMaterial.prototype.clone=function(){var t=new e.MeshPhongMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.ambient.copy(this.ambient),t.emissive.copy(this.emissive),t.specular.copy(this.specular),t.shininess=this.shininess,t.metal=this.metal,t.perPixel=this.perPixel,t.wrapAround=this.wrapAround,t.wrapRGB.copy(this.wrapRGB),t.map=this.map,t.lightMap=this.lightMap,t.bumpMap=this.bumpMap,t.bumpScale=this.bumpScale,t.normalMap=this.normalMap,t.normalScale.copy(this.normalScale),t.specularMap=this.specularMap,t.envMap=this.envMap,t.combine=this.combine,t.reflectivity=this.reflectivity,t.refractionRatio=this.refractionRatio,t.fog=this.fog,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.wireframeLinecap=this.wireframeLinecap,t.wireframeLinejoin=this.wireframeLinejoin,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t.morphNormals=this.morphNormals,t},e.MeshDepthMaterial=function(t){e.Material.call(this),this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)},e.MeshDepthMaterial.prototype=Object.create(e.Material.prototype),e.MeshDepthMaterial.prototype.clone=function(){var t=new e.MeshDepthMaterial;return e.Material.prototype.clone.call(this,t),t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t},e.MeshNormalMaterial=function(t){e.Material.call(this,t),this.shading=e.FlatShading,this.wireframe=!1,this.wireframeLinewidth=1,this.morphTargets=!1,this.setValues(t)},e.MeshNormalMaterial.prototype=Object.create(e.Material.prototype),e.MeshNormalMaterial.prototype.clone=function(){var t=new e.MeshNormalMaterial;return e.Material.prototype.clone.call(this,t),t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t},e.MeshFaceMaterial=function(e){this.materials=e instanceof Array?e:[]},e.MeshFaceMaterial.prototype.clone=function(){for(var t=new e.MeshFaceMaterial,r=0;r<this.materials.length;r++)t.materials.push(this.materials[r].clone());return t},e.ParticleSystemMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.vertexColors=!1,this.fog=!0,this.setValues(t)},e.ParticleSystemMaterial.prototype=Object.create(e.Material.prototype),e.ParticleSystemMaterial.prototype.clone=function(){var t=new e.ParticleSystemMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.map=this.map,t.size=this.size,t.sizeAttenuation=this.sizeAttenuation,t.vertexColors=this.vertexColors,t.fog=this.fog,t},e.ParticleBasicMaterial=e.ParticleSystemMaterial,e.ShaderMaterial=function(t){e.Material.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.shading=e.SmoothShading,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.vertexColors=e.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName="position",this.setValues(t)},e.ShaderMaterial.prototype=Object.create(e.Material.prototype),e.ShaderMaterial.prototype.clone=function(){var t=new e.ShaderMaterial;return e.Material.prototype.clone.call(this,t),t.fragmentShader=this.fragmentShader,t.vertexShader=this.vertexShader,t.uniforms=e.UniformsUtils.clone(this.uniforms),t.attributes=this.attributes,t.defines=this.defines,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.fog=this.fog,t.lights=this.lights,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t.morphNormals=this.morphNormals,t},e.SpriteMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.map=null,this.depthTest=!0,this.sizeAttenuation=!0,this.rotation=0,this.fog=!1,this.uvOffset=new e.Vector2(0,0),this.uvScale=new e.Vector2(1,1),this.setValues(t)},e.SpriteMaterial.prototype=Object.create(e.Material.prototype),e.SpriteMaterial.prototype.clone=function(){var t=new e.SpriteMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.map=this.map,t.rotation=this.rotation,t.uvOffset.copy(this.uvOffset),t.uvScale.copy(this.uvScale),t.fog=this.fog,t},e.SpriteCanvasMaterial=function(t){e.Material.call(this),this.color=new e.Color(16777215),this.program=function(e,t){},this.setValues(t)},e.SpriteCanvasMaterial.prototype=Object.create(e.Material.prototype),e.SpriteCanvasMaterial.prototype.clone=function(){var t=new e.SpriteCanvasMaterial;return e.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.program=this.program,t},e.ParticleCanvasMaterial=e.SpriteCanvasMaterial,e.Texture=function(t,r,i,o,n,a,s,l,c){this.id=e.TextureIdCount++,this.uuid=e.Math.generateUUID(),this.name="",this.image=t,this.mipmaps=[],this.mapping=void 0!==r?r:new e.UVMapping,this.wrapS=void 0!==i?i:e.ClampToEdgeWrapping,this.wrapT=void 0!==o?o:e.ClampToEdgeWrapping,this.magFilter=void 0!==n?n:e.LinearFilter,this.minFilter=void 0!==a?a:e.LinearMipMapLinearFilter,this.anisotropy=void 0!==c?c:1,this.format=void 0!==s?s:e.RGBAFormat,this.type=void 0!==l?l:e.UnsignedByteType,this.offset=new e.Vector2(0,0),this.repeat=new e.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},e.Texture.prototype={constructor:e.Texture,clone:function(t){return void 0===t&&(t=new e.Texture),t.image=this.image,t.mipmaps=this.mipmaps.slice(0),t.mapping=this.mapping,t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=this.flipY,t.unpackAlignment=this.unpackAlignment,t},dispose:function(){this.dispatchEvent({type:"dispose"})}},e.EventDispatcher.prototype.apply(e.Texture.prototype),e.TextureIdCount=0,e.CompressedTexture=function(t,r,i,o,n,a,s,l,c,h,u){e.Texture.call(this,null,a,s,l,c,h,o,n,u),this.image={width:r,height:i},this.mipmaps=t,this.generateMipmaps=!1},e.CompressedTexture.prototype=Object.create(e.Texture.prototype),e.CompressedTexture.prototype.clone=function(){var t=new e.CompressedTexture;return e.Texture.prototype.clone.call(this,t),t},e.DataTexture=function(t,r,i,o,n,a,s,l,c,h,u){e.Texture.call(this,null,a,s,l,c,h,o,n,u),this.image={data:t,width:r,height:i}},e.DataTexture.prototype=Object.create(e.Texture.prototype),e.DataTexture.prototype.clone=function(){var t=new e.DataTexture;return e.Texture.prototype.clone.call(this,t),t},e.ParticleSystem=function(t,r){e.Object3D.call(this),this.geometry=void 0!==t?t:new e.Geometry,this.material=void 0!==r?r:new e.ParticleSystemMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.frustumCulled=!1},e.ParticleSystem.prototype=Object.create(e.Object3D.prototype),e.ParticleSystem.prototype.clone=function(t){return void 0===t&&(t=new e.ParticleSystem(this.geometry,this.material)),t.sortParticles=this.sortParticles,e.Object3D.prototype.clone.call(this,t),t},e.Line=function(t,r,i){e.Object3D.call(this),this.geometry=void 0!==t?t:new e.Geometry,this.material=void 0!==r?r:new e.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==i?i:e.LineStrip},e.LineStrip=0,e.LinePieces=1,e.Line.prototype=Object.create(e.Object3D.prototype),e.Line.prototype.clone=function(t){return void 0===t&&(t=new e.Line(this.geometry,this.material,this.type)),e.Object3D.prototype.clone.call(this,t),t},e.Mesh=function(t,r){e.Object3D.call(this),this.geometry=void 0!==t?t:new e.Geometry,this.material=void 0!==r?r:new e.MeshBasicMaterial({color:16777215*Math.random()}),this.updateMorphTargets()},e.Mesh.prototype=Object.create(e.Object3D.prototype),e.Mesh.prototype.updateMorphTargets=function(){if(this.geometry.morphTargets.length>0){this.morphTargetBase=-1,this.morphTargetForcedOrder=[],this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var e=0,t=this.geometry.morphTargets.length;t>e;e++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[e].name]=e}},e.Mesh.prototype.getMorphTargetIndexByName=function(e){return void 0!==this.morphTargetDictionary[e]?this.morphTargetDictionary[e]:(console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+e+" does not exist. Returning 0."),0)},e.Mesh.prototype.clone=function(t){return void 0===t&&(t=new e.Mesh(this.geometry,this.material)),e.Object3D.prototype.clone.call(this,t),t},e.Bone=function(t){e.Object3D.call(this),this.skin=t,this.skinMatrix=new e.Matrix4},e.Bone.prototype=Object.create(e.Object3D.prototype),e.Bone.prototype.update=function(e,t){this.matrixAutoUpdate&&(t|=this.updateMatrix()),(t||this.matrixWorldNeedsUpdate)&&(e?this.skinMatrix.multiplyMatrices(e,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);var r,i=this.children.length;for(r=0;i>r;r++)this.children[r].update(this.skinMatrix,t)},e.SkinnedMesh=function(t,r,i){e.Mesh.call(this,t,r),this.useVertexTexture=void 0!==i?i:!0,this.identityMatrix=new e.Matrix4,this.bones=[],this.boneMatrices=[];var o,n,a,s,l,c;if(this.geometry&&void 0!==this.geometry.bones){for(o=0;o<this.geometry.bones.length;o++)a=this.geometry.bones[o],s=a.pos,l=a.rotq,c=a.scl,n=this.addBone(),n.name=a.name,n.position.set(s[0],s[1],s[2]),n.quaternion.set(l[0],l[1],l[2],l[3]),void 0!==c?n.scale.set(c[0],c[1],c[2]):n.scale.set(1,1,1);for(o=0;o<this.bones.length;o++)a=this.geometry.bones[o],n=this.bones[o],-1===a.parent?this.add(n):this.bones[a.parent].add(n);var h=this.bones.length;if(this.useVertexTexture){var u;u=h>256?64:h>64?32:h>16?16:8,this.boneTextureWidth=u,this.boneTextureHeight=u,this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4),this.boneTexture=new e.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,e.RGBAFormat,e.FloatType),this.boneTexture.minFilter=e.NearestFilter,this.boneTexture.magFilter=e.NearestFilter,this.boneTexture.generateMipmaps=!1,this.boneTexture.flipY=!1}else this.boneMatrices=new Float32Array(16*h);this.pose()}},e.SkinnedMesh.prototype=Object.create(e.Mesh.prototype),e.SkinnedMesh.prototype.addBone=function(t){return void 0===t&&(t=new e.Bone(this)),this.bones.push(t),t},e.SkinnedMesh.prototype.updateMatrixWorld=function(){var t=new e.Matrix4;return function(r){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||r)&&(this.parent?this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,r=!0);for(var i=0,o=this.children.length;o>i;i++){var n=this.children[i];n instanceof e.Bone?n.update(this.identityMatrix,!1):n.updateMatrixWorld(!0)}if(void 0==this.boneInverses){this.boneInverses=[];for(var a=0,s=this.bones.length;s>a;a++){var l=new e.Matrix4;l.getInverse(this.bones[a].skinMatrix),this.boneInverses.push(l)}}for(var a=0,s=this.bones.length;s>a;a++)t.multiplyMatrices(this.bones[a].skinMatrix,this.boneInverses[a]),t.flattenToArrayOffset(this.boneMatrices,16*a);this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)}}(),e.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0),this.normalizeSkinWeights()},e.SkinnedMesh.prototype.normalizeSkinWeights=function(){if(this.geometry instanceof e.Geometry)for(var t=0;t<this.geometry.skinIndices.length;t++){var r=this.geometry.skinWeights[t],i=1/r.lengthManhattan();i!==1/0?r.multiplyScalar(i):r.set(1)}},e.SkinnedMesh.prototype.clone=function(t){return void 0===t&&(t=new e.SkinnedMesh(this.geometry,this.material,this.useVertexTexture)),e.Mesh.prototype.clone.call(this,t),t},e.MorphAnimMesh=function(t,r){e.Mesh.call(this,t,r),this.duration=1e3,this.mirroredLoop=!1,this.time=0,this.lastKeyframe=0,this.currentKeyframe=0,this.direction=1,this.directionBackwards=!1,this.setFrameRange(0,this.geometry.morphTargets.length-1)},e.MorphAnimMesh.prototype=Object.create(e.Mesh.prototype),e.MorphAnimMesh.prototype.setFrameRange=function(e,t){this.startKeyframe=e,this.endKeyframe=t,this.length=this.endKeyframe-this.startKeyframe+1},e.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1,this.directionBackwards=!1},e.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1,this.directionBackwards=!0},e.MorphAnimMesh.prototype.parseAnimations=function(){var e=this.geometry;e.animations||(e.animations={});for(var t,r=e.animations,i=/([a-z]+)(\d+)/,o=0,n=e.morphTargets.length;n>o;o++){var a=e.morphTargets[o],s=a.name.match(i);if(s&&s.length>1){var l=s[1];s[2];r[l]||(r[l]={start:1/0,end:-(1/0)});var c=r[l];o<c.start&&(c.start=o),o>c.end&&(c.end=o),t||(t=l)}}e.firstAnimation=t},e.MorphAnimMesh.prototype.setAnimationLabel=function(e,t,r){this.geometry.animations||(this.geometry.animations={}),this.geometry.animations[e]={start:t,end:r}},e.MorphAnimMesh.prototype.playAnimation=function(e,t){var r=this.geometry.animations[e];r?(this.setFrameRange(r.start,r.end),this.duration=1e3*((r.end-r.start)/t),this.time=0):console.warn("animation["+e+"] undefined")},e.MorphAnimMesh.prototype.updateAnimation=function(t){var r=this.duration/this.length;this.time+=this.direction*t,this.mirroredLoop?(this.time>this.duration||this.time<0)&&(this.direction*=-1,this.time>this.duration&&(this.time=this.duration,this.directionBackwards=!0),this.time<0&&(this.time=0,this.directionBackwards=!1)):(this.time=this.time%this.duration,this.time<0&&(this.time+=this.duration));var i=this.startKeyframe+e.Math.clamp(Math.floor(this.time/r),0,this.length-1);i!==this.currentKeyframe&&(this.morphTargetInfluences[this.lastKeyframe]=0,this.morphTargetInfluences[this.currentKeyframe]=1,this.morphTargetInfluences[i]=0,this.lastKeyframe=this.currentKeyframe,this.currentKeyframe=i);var o=this.time%r/r;this.directionBackwards&&(o=1-o),this.morphTargetInfluences[this.currentKeyframe]=o,this.morphTargetInfluences[this.lastKeyframe]=1-o},e.MorphAnimMesh.prototype.clone=function(t){return void 0===t&&(t=new e.MorphAnimMesh(this.geometry,this.material)),t.duration=this.duration,t.mirroredLoop=this.mirroredLoop,t.time=this.time,t.lastKeyframe=this.lastKeyframe,t.currentKeyframe=this.currentKeyframe,t.direction=this.direction,t.directionBackwards=this.directionBackwards,e.Mesh.prototype.clone.call(this,t),t},e.LOD=function(){e.Object3D.call(this),this.objects=[]},e.LOD.prototype=Object.create(e.Object3D.prototype),e.LOD.prototype.addLevel=function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var r=0;r<this.objects.length&&!(t<this.objects[r].distance);r++);this.objects.splice(r,0,{distance:t,object:e}),this.add(e)},e.LOD.prototype.getObjectForDistance=function(e){for(var t=1,r=this.objects.length;r>t&&!(e<this.objects[t].distance);t++);return this.objects[t-1].object},e.LOD.prototype.update=function(){var t=new e.Vector3,r=new e.Vector3;return function(e){if(this.objects.length>1){t.getPositionFromMatrix(e.matrixWorld),r.getPositionFromMatrix(this.matrixWorld);var i=t.distanceTo(r);this.objects[0].object.visible=!0;for(var o=1,n=this.objects.length;n>o&&i>=this.objects[o].distance;o++)this.objects[o-1].object.visible=!1,this.objects[o].object.visible=!0;for(;n>o;o++)this.objects[o].object.visible=!1}}}(),e.LOD.prototype.clone=function(){},e.Sprite=function(t){e.Object3D.call(this),this.material=void 0!==t?t:new e.SpriteMaterial},e.Sprite.prototype=Object.create(e.Object3D.prototype),e.Sprite.prototype.updateMatrix=function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},e.Sprite.prototype.clone=function(t){return void 0===t&&(t=new e.Sprite(this.material)),e.Object3D.prototype.clone.call(this,t),t},e.Particle=e.Sprite,e.Scene=function(){e.Object3D.call(this),this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,this.matrixAutoUpdate=!1,this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},e.Scene.prototype=Object.create(e.Object3D.prototype),e.Scene.prototype.__addObject=function(t){if(t instanceof e.Light)-1===this.__lights.indexOf(t)&&this.__lights.push(t),t.target&&void 0===t.target.parent&&this.add(t.target);else if(!(t instanceof e.Camera||t instanceof e.Bone)){this.__objectsAdded.push(t);var r=this.__objectsRemoved.indexOf(t);-1!==r&&this.__objectsRemoved.splice(r,1)}for(var i=0;i<t.children.length;i++)this.__addObject(t.children[i])},e.Scene.prototype.__removeObject=function(t){if(t instanceof e.Light){var r=this.__lights.indexOf(t);if(-1!==r&&this.__lights.splice(r,1),t.shadowCascadeArray)for(var i=0;i<t.shadowCascadeArray.length;i++)this.__removeObject(t.shadowCascadeArray[i])}else if(!(t instanceof e.Camera)){this.__objectsRemoved.push(t);var r=this.__objectsAdded.indexOf(t);-1!==r&&this.__objectsAdded.splice(r,1)}for(var o=0;o<t.children.length;o++)this.__removeObject(t.children[o])},e.Scene.prototype.clone=function(t){return void 0===t&&(t=new e.Scene),e.Object3D.prototype.clone.call(this,t),null!==this.fog&&(t.fog=this.fog.clone()),null!==this.overrideMaterial&&(t.overrideMaterial=this.overrideMaterial.clone()),t.autoUpdate=this.autoUpdate,t.matrixAutoUpdate=this.matrixAutoUpdate,t},e.Fog=function(t,r,i){this.name="",this.color=new e.Color(t),this.near=void 0!==r?r:1,this.far=void 0!==i?i:1e3},e.Fog.prototype.clone=function(){return new e.Fog(this.color.getHex(),this.near,this.far)},e.FogExp2=function(t,r){this.name="",this.color=new e.Color(t),this.density=void 0!==r?r:25e-5},e.FogExp2.prototype.clone=function(){return new e.FogExp2(this.color.getHex(),this.density)},e.CanvasRenderer=function(t){function r(){De.setRGB(0,0,0),Fe.setRGB(0,0,0),Ee.setRGB(0,0,0);for(var t=0,r=T.length;r>t;t++){var i=T[t],o=i.color;i instanceof e.AmbientLight?De.add(o):i instanceof e.DirectionalLight?Fe.add(o):i instanceof e.PointLight&&Ee.add(o)}}function i(t,r,i){for(var o=0,n=T.length;n>o;o++){var a=T[o];if(Se.copy(a.color),a instanceof e.DirectionalLight){var s=Ve.getPositionFromMatrix(a.matrixWorld).normalize(),l=r.dot(s);if(0>=l)continue;l*=a.intensity,i.add(Se.multiplyScalar(l))}else if(a instanceof e.PointLight){var s=Ve.getPositionFromMatrix(a.matrixWorld),l=r.dot(Ve.subVectors(s,t).normalize());if(0>=l)continue;if(l*=0==a.distance?1:1-Math.min(t.distanceTo(s)/a.distance,1),0==l)continue;l*=a.intensity,i.add(Se.multiplyScalar(l))}}}function o(t,r,i){f(i.opacity),m(i.blending);var o=r.scale.x*ie,n=r.scale.y*oe;if(Pe.min.set(t.x-.5*o,t.y-.5*n),Pe.max.set(t.x+.5*o,t.y+.5*n),Le.isIntersectionBox(Pe)===!1)return void Pe.makeEmpty();if(i instanceof e.SpriteMaterial||i instanceof e.ParticleSystemMaterial)if(null!==i.map){var a=i.map.image;ne.save(),ne.translate(t.x,t.y),ne.rotate(-i.rotation),ne.scale(o,-n),ne.drawImage(a,0,0,a.width,a.height,-.5,-.5,1,1),ne.restore()}else w(i.color.getStyle()),ne.save(),ne.translate(t.x,t.y),ne.rotate(-r.rotation),ne.scale(o,n),ne.fillRect(-.5,-.5,1,1),ne.restore();else i instanceof e.SpriteCanvasMaterial&&(x(i.color.getStyle()),w(i.color.getStyle()),ne.save(),ne.translate(t.x,t.y),ne.rotate(-r.rotation),ne.scale(o,n),i.program(ne),ne.restore())}function n(t,r,i,o){if(f(o.opacity),m(o.blending),ne.beginPath(),ne.moveTo(t.positionScreen.x,t.positionScreen.y),ne.lineTo(r.positionScreen.x,r.positionScreen.y),o instanceof e.LineBasicMaterial){if(v(o.linewidth),g(o.linecap),y(o.linejoin),o.vertexColors!==e.VertexColors)x(o.color.getStyle());else{var n=i.vertexColors[0].getStyle(),a=i.vertexColors[1].getStyle();if(n===a)x(n);else{try{var s=ne.createLinearGradient(t.positionScreen.x,t.positionScreen.y,r.positionScreen.x,r.positionScreen.y);s.addColorStop(0,n),s.addColorStop(1,a)}catch(l){s=n}x(s)}}ne.stroke(),Pe.expandByScalar(2*o.linewidth)}else o instanceof e.LineDashedMaterial&&(v(o.linewidth),g(o.linecap),y(o.linejoin),x(o.color.getStyle()),b(o.dashSize,o.gapSize),ne.stroke(),Pe.expandByScalar(2*o.linewidth),b(null,null))}function a(t,r,o,n,a,d,v,g){if(J.info.render.vertices+=3,J.info.render.faces++,f(g.opacity),m(g.blending),D=t.positionScreen.x,F=t.positionScreen.y,E=r.positionScreen.x,V=r.positionScreen.y,R=o.positionScreen.x,z=o.positionScreen.y,s(D,F,E,V,R,z),(g instanceof e.MeshLambertMaterial||g instanceof e.MeshPhongMaterial)&&null===g.map)_e.copy(g.color),Me.copy(g.emissive),g.vertexColors===e.FaceColors&&_e.multiply(v.color),g.wireframe===!1&&g.shading===e.SmoothShading&&3===v.vertexNormalsLength?(ye.copy(De),xe.copy(De),we.copy(De),i(v.v1.positionWorld,v.vertexNormalsModel[0],ye),i(v.v2.positionWorld,v.vertexNormalsModel[1],xe),i(v.v3.positionWorld,v.vertexNormalsModel[2],we),ye.multiply(_e).add(Me),xe.multiply(_e).add(Me),we.multiply(_e).add(Me),be.addColors(xe,we).multiplyScalar(.5),O=p(ye,xe,we,be),u(D,F,E,V,R,z,0,0,1,0,0,1,O)):(ge.copy(De),i(v.centroidModel,v.normalModel,ge),ge.multiply(_e).add(Me),g.wireframe===!0?l(ge,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):c(ge));else if(g instanceof e.MeshBasicMaterial||g instanceof e.MeshLambertMaterial||g instanceof e.MeshPhongMaterial)null!==g.map?g.map.mapping instanceof e.UVMapping&&(B=v.uvs[0],h(D,F,E,V,R,z,B[n].x,B[n].y,B[a].x,B[a].y,B[d].x,B[d].y,g.map)):null!==g.envMap?g.envMap.mapping instanceof e.SphericalReflectionMapping&&(Ve.copy(v.vertexNormalsModelView[n]),N=.5*Ve.x+.5,k=.5*Ve.y+.5,Ve.copy(v.vertexNormalsModelView[a]),G=.5*Ve.x+.5,j=.5*Ve.y+.5,Ve.copy(v.vertexNormalsModelView[d]),W=.5*Ve.x+.5,H=.5*Ve.y+.5,h(D,F,E,V,R,z,N,k,G,j,W,H,g.envMap)):(ge.copy(g.color),g.vertexColors===e.FaceColors&&ge.multiply(v.color),g.wireframe===!0?l(ge,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):c(ge));else if(g instanceof e.MeshDepthMaterial)I=C.near,U=C.far,ye.r=ye.g=ye.b=1-_(t.positionScreen.z*t.positionScreen.w,I,U),xe.r=xe.g=xe.b=1-_(r.positionScreen.z*r.positionScreen.w,I,U),we.r=we.g=we.b=1-_(o.positionScreen.z*o.positionScreen.w,I,U),be.addColors(xe,we).multiplyScalar(.5),O=p(ye,xe,we,be),u(D,F,E,V,R,z,0,0,1,0,0,1,O);else if(g instanceof e.MeshNormalMaterial){var y;g.shading===e.FlatShading?(y=v.normalModelView,ge.setRGB(y.x,y.y,y.z).multiplyScalar(.5).addScalar(.5),g.wireframe===!0?l(ge,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):c(ge)):g.shading===e.SmoothShading&&(y=v.vertexNormalsModelView[n],ye.setRGB(y.x,y.y,y.z).multiplyScalar(.5).addScalar(.5),y=v.vertexNormalsModelView[a],xe.setRGB(y.x,y.y,y.z).multiplyScalar(.5).addScalar(.5),y=v.vertexNormalsModelView[d],we.setRGB(y.x,y.y,y.z).multiplyScalar(.5).addScalar(.5),be.addColors(xe,we).multiplyScalar(.5),O=p(ye,xe,we,be),u(D,F,E,V,R,z,0,0,1,0,0,1,O))}}function s(e,t,r,i,o,n){ne.beginPath(),ne.moveTo(e,t),ne.lineTo(r,i),ne.lineTo(o,n),ne.closePath()}function l(e,t,r,i){v(t),g(r),y(i),x(e.getStyle()),ne.stroke(),Pe.expandByScalar(2*t)}function c(e){w(e.getStyle()),
ne.fill()}function h(t,r,i,o,n,a,s,l,h,u,p,d,f){if(!(f instanceof e.DataTexture||void 0===f.image||0===f.image.width)){if(f.needsUpdate===!0){var m=f.wrapS===e.RepeatWrapping,v=f.wrapT===e.RepeatWrapping;Te[f.id]=ne.createPattern(f.image,m===!0&&v===!0?"repeat":m===!0&&v===!1?"repeat-x":m===!1&&v===!0?"repeat-y":"no-repeat"),f.needsUpdate=!1}w(void 0===Te[f.id]?"rgba(0,0,0,1)":Te[f.id]);var g,y,x,b,_,M,S,T,C=f.offset.x/f.repeat.x,L=f.offset.y/f.repeat.y,A=f.image.width*f.repeat.x,P=f.image.height*f.repeat.y;if(s=(s+C)*A,l=(1-l+L)*P,h=(h+C)*A,u=(1-u+L)*P,p=(p+C)*A,d=(1-d+L)*P,i-=t,o-=r,n-=t,a-=r,h-=s,u-=l,p-=s,d-=l,S=h*d-p*u,0===S){if(void 0===Ce[f.id]){var D=document.createElement("canvas");D.width=f.image.width,D.height=f.image.height;var F=D.getContext("2d");F.drawImage(f.image,0,0),Ce[f.id]=F.getImageData(0,0,f.image.width,f.image.height).data}var E=Ce[f.id],V=4*(Math.floor(s)+Math.floor(l)*f.image.width);return ge.setRGB(E[V]/255,E[V+1]/255,E[V+2]/255),void c(ge)}T=1/S,g=(d*i-u*n)*T,y=(d*o-u*a)*T,x=(h*n-p*i)*T,b=(h*a-p*o)*T,_=t-g*s-x*l,M=r-y*s-b*l,ne.save(),ne.transform(g,y,x,b,_,M),ne.fill(),ne.restore()}}function u(e,t,r,i,o,n,a,s,l,c,h,u,p){var d,f,m,v,g,y,x,w,b=p.width-1,_=p.height-1;a*=b,s*=_,l*=b,c*=_,h*=b,u*=_,r-=e,i-=t,o-=e,n-=t,l-=a,c-=s,h-=a,u-=s,x=l*u-h*c,w=1/x,d=(u*r-c*o)*w,f=(u*i-c*n)*w,m=(l*o-h*r)*w,v=(l*n-h*i)*w,g=e-d*a-m*s,y=t-f*a-v*s,ne.save(),ne.transform(d,f,m,v,g,y),ne.clip(),ne.drawImage(p,0,0),ne.restore()}function p(e,t,r,i){return Z[0]=255*e.r|0,Z[1]=255*e.g|0,Z[2]=255*e.b|0,Z[4]=255*t.r|0,Z[5]=255*t.g|0,Z[6]=255*t.b|0,Z[8]=255*r.r|0,Z[9]=255*r.g|0,Z[10]=255*r.b|0,Z[12]=255*i.r|0,Z[13]=255*i.g|0,Z[14]=255*i.b|0,q.putImageData(Y,0,0),Q.drawImage(X,0,0),K}function d(e,t,r){var i,o=t.x-e.x,n=t.y-e.y,a=o*o+n*n;0!==a&&(i=r/Math.sqrt(a),o*=i,n*=i,t.x+=o,t.y+=n,e.x-=o,e.y-=n)}function f(e){le!==e&&(ne.globalAlpha=e,le=e)}function m(t){ce!==t&&(t===e.NormalBlending?ne.globalCompositeOperation="source-over":t===e.AdditiveBlending?ne.globalCompositeOperation="lighter":t===e.SubtractiveBlending&&(ne.globalCompositeOperation="darker"),ce=t)}function v(e){pe!==e&&(ne.lineWidth=e,pe=e)}function g(e){de!==e&&(ne.lineCap=e,de=e)}function y(e){fe!==e&&(ne.lineJoin=e,fe=e)}function x(e){he!==e&&(ne.strokeStyle=e,he=e)}function w(e){ue!==e&&(ne.fillStyle=e,ue=e)}function b(e,t){(me!==e||ve!==t)&&(ne.setLineDash([e,t]),me=e,ve=t)}console.log("THREE.CanvasRenderer",e.REVISION);var _=e.Math.smoothstep;t=t||{};var M,S,T,C,L,A,P,D,F,E,V,R,z,I,U,O,B,N,k,G,j,W,H,X,q,Y,Z,K,Q,J=this,$=new e.Projector,ee=void 0!==t.canvas?t.canvas:document.createElement("canvas"),te=ee.width,re=ee.height,ie=Math.floor(te/2),oe=Math.floor(re/2),ne=ee.getContext("2d"),ae=new e.Color(0),se=0,le=1,ce=0,he=null,ue=null,pe=null,de=null,fe=null,me=null,ve=0,ge=(new e.RenderableVertex,new e.RenderableVertex,new e.Color),ye=new e.Color,xe=new e.Color,we=new e.Color,be=new e.Color,_e=new e.Color,Me=new e.Color,Se=new e.Color,Te={},Ce={},Le=new e.Box2,Ae=new e.Box2,Pe=new e.Box2,De=new e.Color,Fe=new e.Color,Ee=new e.Color,Ve=new e.Vector3,Re=16;X=document.createElement("canvas"),X.width=X.height=2,q=X.getContext("2d"),q.fillStyle="rgba(0,0,0,1)",q.fillRect(0,0,2,2),Y=q.getImageData(0,0,2,2),Z=Y.data,K=document.createElement("canvas"),K.width=K.height=Re,Q=K.getContext("2d"),Q.translate(-Re/2,-Re/2),Q.scale(Re,Re),Re--,void 0===ne.setLineDash&&(void 0!==ne.mozDash?ne.setLineDash=function(e){ne.mozDash=null!==e[0]?e:null}:ne.setLineDash=function(){}),this.domElement=ee,this.devicePixelRatio=void 0!==t.devicePixelRatio?t.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setSize=function(t,r,i){te=t*this.devicePixelRatio,re=r*this.devicePixelRatio,ie=Math.floor(te/2),oe=Math.floor(re/2),ee.width=te,ee.height=re,1!==this.devicePixelRatio&&i!==!1&&(ee.style.width=t+"px",ee.style.height=r+"px"),Le.set(new e.Vector2(-ie,-oe),new e.Vector2(ie,oe)),Ae.set(new e.Vector2(-ie,-oe),new e.Vector2(ie,oe)),le=1,ce=0,he=null,ue=null,pe=null,de=null,fe=null},this.setClearColor=function(t,r){ae.set(t),se=void 0!==r?r:1,Ae.set(new e.Vector2(-ie,-oe),new e.Vector2(ie,oe))},this.setClearColorHex=function(e,t){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getMaxAnisotropy=function(){return 0},this.clear=function(){ne.setTransform(1,0,0,-1,ie,oe),Ae.empty()===!1&&(Ae.intersect(Le),Ae.expandByScalar(2),1>se&&ne.clearRect(0|Ae.min.x,0|Ae.min.y,Ae.max.x-Ae.min.x|0,Ae.max.y-Ae.min.y|0),se>0&&(m(e.NormalBlending),f(1),w("rgba("+Math.floor(255*ae.r)+","+Math.floor(255*ae.g)+","+Math.floor(255*ae.b)+","+se+")"),ne.fillRect(0|Ae.min.x,0|Ae.min.y,Ae.max.x-Ae.min.x|0,Ae.max.y-Ae.min.y|0)),Ae.makeEmpty())},this.render=function(t,i){if(i instanceof e.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),ne.setTransform(1,0,0,-1,ie,oe),J.info.render.vertices=0,J.info.render.faces=0,M=$.projectScene(t,i,this.sortObjects,this.sortElements),S=M.elements,T=M.lights,C=i,r();for(var s=0,l=S.length;l>s;s++){var c=S[s],h=c.material;if(void 0!==h&&h.visible!==!1){if(Pe.makeEmpty(),c instanceof e.RenderableSprite)L=c,L.x*=ie,L.y*=oe,o(L,c,h);else if(c instanceof e.RenderableLine)L=c.v1,A=c.v2,L.positionScreen.x*=ie,L.positionScreen.y*=oe,A.positionScreen.x*=ie,A.positionScreen.y*=oe,Pe.setFromPoints([L.positionScreen,A.positionScreen]),Le.isIntersectionBox(Pe)===!0&&n(L,A,c,h);else if(c instanceof e.RenderableFace3){if(L=c.v1,A=c.v2,P=c.v3,L.positionScreen.z<-1||L.positionScreen.z>1)continue;if(A.positionScreen.z<-1||A.positionScreen.z>1)continue;if(P.positionScreen.z<-1||P.positionScreen.z>1)continue;L.positionScreen.x*=ie,L.positionScreen.y*=oe,A.positionScreen.x*=ie,A.positionScreen.y*=oe,P.positionScreen.x*=ie,P.positionScreen.y*=oe,h.overdraw>0&&(d(L.positionScreen,A.positionScreen,h.overdraw),d(A.positionScreen,P.positionScreen,h.overdraw),d(P.positionScreen,L.positionScreen,h.overdraw)),Pe.setFromPoints([L.positionScreen,A.positionScreen,P.positionScreen]),Le.isIntersectionBox(Pe)===!0&&a(L,A,P,0,1,2,c,h)}Ae.union(Pe)}}ne.setTransform(1,0,0,1,0,0)}},e.ShaderChunk={fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#ifdef USE_ENVMAP","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","uniform bool useRefract;","uniform float refractionRatio;","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","reflectVec = refract( cameraToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( cameraToVertex, normal );","}","#else","reflectVec = vReflect;","#endif","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#else","vec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif"].join("\n"),map_pars_fragment:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","vec4 texelColor = texture2D( map, vUv );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( vUv.st );","vec2 st1 = dFdy( vUv.st );","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","#else","specularStrength = 1.0;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","#else","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;","#else","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += diffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, 1.0 );","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","uniform int boneTextureWidth;","uniform int boneTextureHeight;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, float( boneTextureWidth ) );","float y = floor( j / float( boneTextureWidth ) );","float dx = 1.0 / float( boneTextureWidth );","float dy = 1.0 / float( boneTextureHeight );","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),
default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING","mvPosition = modelViewMatrix * skinned;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( morphed, 1.0 );","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal = normalMatrix * objectNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","vec3 shadowZ = vec3( shadowCoord.z );","shadowKernel[0] = vec3(lessThan(depthKernel[0], shadowZ ));","shadowKernel[0] *= vec3(0.25);","shadowKernel[1] = vec3(lessThan(depthKernel[1], shadowZ ));","shadowKernel[1] *= vec3(0.25);","shadowKernel[2] = vec3(lessThan(depthKernel[2], shadowZ ));","shadowKernel[2] *= vec3(0.25);","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","shadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor *= shadowColor;","#endif","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n")},e.UniformsUtils={merge:function(e){var t,r,i,o={};for(t=0;t<e.length;t++){i=this.clone(e[t]);for(r in i)o[r]=i[r]}return o},clone:function(t){var r,i,o,n={};for(r in t){n[r]={};for(i in t[r])o=t[r][i],o instanceof e.Color||o instanceof e.Vector2||o instanceof e.Vector3||o instanceof e.Vector4||o instanceof e.Matrix4||o instanceof e.Texture?n[r][i]=o.clone():o instanceof Array?n[r][i]=o.slice():n[r][i]=o}return n}},e.UniformsLib={common:{diffuse:{type:"c",value:new e.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new e.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new e.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new e.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new e.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new e.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}},e.ShaderLib={basic:{uniforms:e.UniformsUtils.merge([e.UniformsLib.common,e.UniformsLib.fog,e.UniformsLib.shadowmap]),vertexShader:[e.ShaderChunk.map_pars_vertex,e.ShaderChunk.lightmap_pars_vertex,e.ShaderChunk.envmap_pars_vertex,e.ShaderChunk.color_pars_vertex,e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,e.ShaderChunk.shadowmap_pars_vertex,"void main() {",e.ShaderChunk.map_vertex,e.ShaderChunk.lightmap_vertex,e.ShaderChunk.color_vertex,e.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",e.ShaderChunk.morphnormal_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.defaultnormal_vertex,"#endif",e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,e.ShaderChunk.worldpos_vertex,e.ShaderChunk.envmap_vertex,e.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;",e.ShaderChunk.color_pars_fragment,e.ShaderChunk.map_pars_fragment,e.ShaderChunk.lightmap_pars_fragment,e.ShaderChunk.envmap_pars_fragment,e.ShaderChunk.fog_pars_fragment,e.ShaderChunk.shadowmap_pars_fragment,e.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );",e.ShaderChunk.map_fragment,e.ShaderChunk.alphatest_fragment,e.ShaderChunk.specularmap_fragment,e.ShaderChunk.lightmap_fragment,e.ShaderChunk.color_fragment,e.ShaderChunk.envmap_fragment,e.ShaderChunk.shadowmap_fragment,e.ShaderChunk.linear_to_gamma_fragment,e.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:e.UniformsUtils.merge([e.UniformsLib.common,e.UniformsLib.fog,e.UniformsLib.lights,e.UniformsLib.shadowmap,{ambient:{type:"c",value:new e.Color(16777215)},emissive:{type:"c",value:new e.Color(0)},wrapRGB:{type:"v3",value:new e.Vector3(1,1,1)}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",e.ShaderChunk.map_pars_vertex,e.ShaderChunk.lightmap_pars_vertex,e.ShaderChunk.envmap_pars_vertex,e.ShaderChunk.lights_lambert_pars_vertex,e.ShaderChunk.color_pars_vertex,e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,e.ShaderChunk.shadowmap_pars_vertex,"void main() {",e.ShaderChunk.map_vertex,e.ShaderChunk.lightmap_vertex,e.ShaderChunk.color_vertex,e.ShaderChunk.morphnormal_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.defaultnormal_vertex,e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,e.ShaderChunk.worldpos_vertex,e.ShaderChunk.envmap_vertex,e.ShaderChunk.lights_lambert_vertex,e.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",e.ShaderChunk.color_pars_fragment,e.ShaderChunk.map_pars_fragment,e.ShaderChunk.lightmap_pars_fragment,e.ShaderChunk.envmap_pars_fragment,e.ShaderChunk.fog_pars_fragment,e.ShaderChunk.shadowmap_pars_fragment,e.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",e.ShaderChunk.map_fragment,e.ShaderChunk.alphatest_fragment,e.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",e.ShaderChunk.lightmap_fragment,e.ShaderChunk.color_fragment,e.ShaderChunk.envmap_fragment,e.ShaderChunk.shadowmap_fragment,e.ShaderChunk.linear_to_gamma_fragment,e.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:e.UniformsUtils.merge([e.UniformsLib.common,e.UniformsLib.bump,e.UniformsLib.normalmap,e.UniformsLib.fog,e.UniformsLib.lights,e.UniformsLib.shadowmap,{ambient:{type:"c",value:new e.Color(16777215)},emissive:{type:"c",value:new e.Color(0)},specular:{type:"c",value:new e.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new e.Vector3(1,1,1)}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",e.ShaderChunk.map_pars_vertex,e.ShaderChunk.lightmap_pars_vertex,e.ShaderChunk.envmap_pars_vertex,e.ShaderChunk.lights_phong_pars_vertex,e.ShaderChunk.color_pars_vertex,e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,e.ShaderChunk.shadowmap_pars_vertex,"void main() {",e.ShaderChunk.map_vertex,e.ShaderChunk.lightmap_vertex,e.ShaderChunk.color_vertex,e.ShaderChunk.morphnormal_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",e.ShaderChunk.worldpos_vertex,e.ShaderChunk.envmap_vertex,e.ShaderChunk.lights_phong_vertex,e.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;",e.ShaderChunk.color_pars_fragment,e.ShaderChunk.map_pars_fragment,e.ShaderChunk.lightmap_pars_fragment,e.ShaderChunk.envmap_pars_fragment,e.ShaderChunk.fog_pars_fragment,e.ShaderChunk.lights_phong_pars_fragment,e.ShaderChunk.shadowmap_pars_fragment,e.ShaderChunk.bumpmap_pars_fragment,e.ShaderChunk.normalmap_pars_fragment,e.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",e.ShaderChunk.map_fragment,e.ShaderChunk.alphatest_fragment,e.ShaderChunk.specularmap_fragment,e.ShaderChunk.lights_phong_fragment,e.ShaderChunk.lightmap_fragment,e.ShaderChunk.color_fragment,e.ShaderChunk.envmap_fragment,e.ShaderChunk.shadowmap_fragment,e.ShaderChunk.linear_to_gamma_fragment,e.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:e.UniformsUtils.merge([e.UniformsLib.particle,e.UniformsLib.shadowmap]),vertexShader:["uniform float size;","uniform float scale;",e.ShaderChunk.color_pars_vertex,e.ShaderChunk.shadowmap_pars_vertex,"void main() {",e.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","gl_Position = projectionMatrix * mvPosition;",e.ShaderChunk.worldpos_vertex,e.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",e.ShaderChunk.color_pars_fragment,e.ShaderChunk.map_particle_pars_fragment,e.ShaderChunk.fog_pars_fragment,e.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( psColor, opacity );",e.ShaderChunk.map_particle_fragment,e.ShaderChunk.alphatest_fragment,e.ShaderChunk.color_fragment,e.ShaderChunk.shadowmap_fragment,e.ShaderChunk.fog_fragment,"}"].join("\n")},dashed:{uniforms:e.UniformsUtils.merge([e.UniformsLib.common,e.UniformsLib.fog,{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;","attribute float lineDistance;","varying float vLineDistance;",e.ShaderChunk.color_pars_vertex,"void main() {",e.ShaderChunk.color_vertex,"vLineDistance = scale * lineDistance;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float totalSize;","varying float vLineDistance;",e.ShaderChunk.color_pars_fragment,e.ShaderChunk.fog_pars_fragment,"void main() {","if ( mod( vLineDistance, totalSize ) > dashSize ) {","discard;","}","gl_FragColor = vec4( diffuse, opacity );",e.ShaderChunk.color_fragment,e.ShaderChunk.fog_fragment,"}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float color = 1.0 - smoothstep( mNear, mFar, depth );","gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;",e.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize( normalMatrix * normal );",e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;","void main() {","gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );","}"].join("\n")},normalmap:{uniforms:e.UniformsUtils.merge([e.UniformsLib.fog,e.UniformsLib.lights,e.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new e.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new e.Color(16777215)},uSpecularColor:{type:"c",value:new e.Color(1118481)},uAmbientColor:{type:"c",value:new e.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new e.Vector2(0,0)},uRepeat:{type:"v2",value:new e.Vector2(1,1)},wrapRGB:{type:"v3",value:new e.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",e.ShaderChunk.shadowmap_pars_fragment,e.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, vUv );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, vUv ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;","#else","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;","#else","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",e.ShaderChunk.shadowmap_fragment,e.ShaderChunk.linear_to_gamma_fragment,e.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",e.ShaderChunk.skinning_pars_vertex,e.ShaderChunk.shadowmap_pars_vertex,"void main() {",e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING","vNormal = normalize( normalMatrix * skinnedNormal.xyz );","vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vTangent = normalize( normalMatrix * skinnedTangent.xyz );","#else","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","}"].join("\n")
},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"void main() {",e.ShaderChunk.skinbase_vertex,e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","void main() {","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","}"].join("\n")}},e.WebGLRenderer=function(t){function r(e){e.__webglVertexBuffer=ze.createBuffer(),e.__webglColorBuffer=ze.createBuffer(),ke.info.memory.geometries++}function i(e){e.__webglVertexBuffer=ze.createBuffer(),e.__webglColorBuffer=ze.createBuffer(),e.__webglLineDistanceBuffer=ze.createBuffer(),ke.info.memory.geometries++}function o(e){e.__webglVertexBuffer=ze.createBuffer(),e.__webglNormalBuffer=ze.createBuffer(),e.__webglTangentBuffer=ze.createBuffer(),e.__webglColorBuffer=ze.createBuffer(),e.__webglUVBuffer=ze.createBuffer(),e.__webglUV2Buffer=ze.createBuffer(),e.__webglSkinIndicesBuffer=ze.createBuffer(),e.__webglSkinWeightsBuffer=ze.createBuffer(),e.__webglFaceBuffer=ze.createBuffer(),e.__webglLineBuffer=ze.createBuffer();var t,r;if(e.numMorphTargets)for(e.__webglMorphTargetsBuffers=[],t=0,r=e.numMorphTargets;r>t;t++)e.__webglMorphTargetsBuffers.push(ze.createBuffer());if(e.numMorphNormals)for(e.__webglMorphNormalsBuffers=[],t=0,r=e.numMorphNormals;r>t;t++)e.__webglMorphNormalsBuffers.push(ze.createBuffer());ke.info.memory.geometries++}function n(e,t){var r=e.vertices.length,i=t.material;if(i.attributes){void 0===e.__webglCustomAttributesList&&(e.__webglCustomAttributesList=[]);for(var o in i.attributes){var n=i.attributes[o];if(!n.__webglInitialized||n.createUniqueBuffers){n.__webglInitialized=!0;var a=1;"v2"===n.type?a=2:"v3"===n.type?a=3:"v4"===n.type?a=4:"c"===n.type&&(a=3),n.size=a,n.array=new Float32Array(r*a),n.buffer=ze.createBuffer(),n.buffer.belongsToAttribute=o,n.needsUpdate=!0}e.__webglCustomAttributesList.push(n)}}}function a(e,t){var r=e.vertices.length;e.__vertexArray=new Float32Array(3*r),e.__colorArray=new Float32Array(3*r),e.__sortArray=[],e.__webglParticleCount=r,n(e,t)}function s(e,t){var r=e.vertices.length;e.__vertexArray=new Float32Array(3*r),e.__colorArray=new Float32Array(3*r),e.__lineDistanceArray=new Float32Array(1*r),e.__webglLineCount=r,n(e,t)}function l(e,t){var r=t.geometry,i=e.faces3,o=3*i.length,n=1*i.length,a=3*i.length,s=c(t,e),l=d(s),h=u(s),f=p(s);e.__vertexArray=new Float32Array(3*o),h&&(e.__normalArray=new Float32Array(3*o)),r.hasTangents&&(e.__tangentArray=new Float32Array(4*o)),f&&(e.__colorArray=new Float32Array(3*o)),l&&(r.faceVertexUvs.length>0&&(e.__uvArray=new Float32Array(2*o)),r.faceVertexUvs.length>1&&(e.__uv2Array=new Float32Array(2*o))),t.geometry.skinWeights.length&&t.geometry.skinIndices.length&&(e.__skinIndexArray=new Float32Array(4*o),e.__skinWeightArray=new Float32Array(4*o)),e.__faceArray=new Uint16Array(3*n),e.__lineArray=new Uint16Array(2*a);var m,v;if(e.numMorphTargets)for(e.__morphTargetsArrays=[],m=0,v=e.numMorphTargets;v>m;m++)e.__morphTargetsArrays.push(new Float32Array(3*o));if(e.numMorphNormals)for(e.__morphNormalsArrays=[],m=0,v=e.numMorphNormals;v>m;m++)e.__morphNormalsArrays.push(new Float32Array(3*o));if(e.__webglFaceCount=3*n,e.__webglLineCount=2*a,s.attributes){void 0===e.__webglCustomAttributesList&&(e.__webglCustomAttributesList=[]);for(var g in s.attributes){var y=s.attributes[g],x={};for(var w in y)x[w]=y[w];if(!x.__webglInitialized||x.createUniqueBuffers){x.__webglInitialized=!0;var b=1;"v2"===x.type?b=2:"v3"===x.type?b=3:"v4"===x.type?b=4:"c"===x.type&&(b=3),x.size=b,x.array=new Float32Array(o*b),x.buffer=ze.createBuffer(),x.buffer.belongsToAttribute=g,y.needsUpdate=!0,x.__original=y}e.__webglCustomAttributesList.push(x)}}e.__inittedArrays=!0}function c(t,r){return t.material instanceof e.MeshFaceMaterial?t.material.materials[r.materialIndex]:t.material}function h(t){return t&&void 0!==t.shading&&t.shading===e.SmoothShading}function u(t){return t instanceof e.MeshBasicMaterial&&!t.envMap||t instanceof e.MeshDepthMaterial?!1:h(t)?e.SmoothShading:e.FlatShading}function p(e){return e.vertexColors?e.vertexColors:!1}function d(t){return t.map||t.lightMap||t.bumpMap||t.normalMap||t.specularMap||t instanceof e.ShaderMaterial?!0:!1}function f(e){var t,r,i;for(t in e.attributes)i="index"===t?ze.ELEMENT_ARRAY_BUFFER:ze.ARRAY_BUFFER,r=e.attributes[t],void 0===r.numItems&&(r.numItems=r.array.length),r.buffer=ze.createBuffer(),ze.bindBuffer(i,r.buffer),ze.bufferData(i,r.array,ze.STATIC_DRAW)}function m(e,t,r){var i,o,n,a,s,l,c,h,u,p,d,f,m=e.vertices,v=m.length,g=e.colors,y=g.length,x=e.__vertexArray,w=e.__colorArray,b=e.__sortArray,_=e.verticesNeedUpdate,S=(e.elementsNeedUpdate,e.colorsNeedUpdate),T=e.__webglCustomAttributesList;if(r.sortParticles){for(yt.copy(gt),yt.multiply(r.matrixWorld),i=0;v>i;i++)n=m[i],xt.copy(n),xt.applyProjection(yt),b[i]=[xt.z,i];for(b.sort(M),i=0;v>i;i++)n=m[b[i][1]],a=3*i,x[a]=n.x,x[a+1]=n.y,x[a+2]=n.z;for(o=0;y>o;o++)a=3*o,l=g[b[o][1]],w[a]=l.r,w[a+1]=l.g,w[a+2]=l.b;if(T)for(c=0,h=T.length;h>c;c++)if(f=T[c],void 0===f.boundTo||"vertices"===f.boundTo)if(a=0,p=f.value.length,1===f.size)for(u=0;p>u;u++)s=b[u][1],f.array[u]=f.value[s];else if(2===f.size)for(u=0;p>u;u++)s=b[u][1],d=f.value[s],f.array[a]=d.x,f.array[a+1]=d.y,a+=2;else if(3===f.size)if("c"===f.type)for(u=0;p>u;u++)s=b[u][1],d=f.value[s],f.array[a]=d.r,f.array[a+1]=d.g,f.array[a+2]=d.b,a+=3;else for(u=0;p>u;u++)s=b[u][1],d=f.value[s],f.array[a]=d.x,f.array[a+1]=d.y,f.array[a+2]=d.z,a+=3;else if(4===f.size)for(u=0;p>u;u++)s=b[u][1],d=f.value[s],f.array[a]=d.x,f.array[a+1]=d.y,f.array[a+2]=d.z,f.array[a+3]=d.w,a+=4}else{if(_)for(i=0;v>i;i++)n=m[i],a=3*i,x[a]=n.x,x[a+1]=n.y,x[a+2]=n.z;if(S)for(o=0;y>o;o++)l=g[o],a=3*o,w[a]=l.r,w[a+1]=l.g,w[a+2]=l.b;if(T)for(c=0,h=T.length;h>c;c++)if(f=T[c],f.needsUpdate&&(void 0===f.boundTo||"vertices"===f.boundTo))if(p=f.value.length,a=0,1===f.size)for(u=0;p>u;u++)f.array[u]=f.value[u];else if(2===f.size)for(u=0;p>u;u++)d=f.value[u],f.array[a]=d.x,f.array[a+1]=d.y,a+=2;else if(3===f.size)if("c"===f.type)for(u=0;p>u;u++)d=f.value[u],f.array[a]=d.r,f.array[a+1]=d.g,f.array[a+2]=d.b,a+=3;else for(u=0;p>u;u++)d=f.value[u],f.array[a]=d.x,f.array[a+1]=d.y,f.array[a+2]=d.z,a+=3;else if(4===f.size)for(u=0;p>u;u++)d=f.value[u],f.array[a]=d.x,f.array[a+1]=d.y,f.array[a+2]=d.z,f.array[a+3]=d.w,a+=4}if((_||r.sortParticles)&&(ze.bindBuffer(ze.ARRAY_BUFFER,e.__webglVertexBuffer),ze.bufferData(ze.ARRAY_BUFFER,x,t)),(S||r.sortParticles)&&(ze.bindBuffer(ze.ARRAY_BUFFER,e.__webglColorBuffer),ze.bufferData(ze.ARRAY_BUFFER,w,t)),T)for(c=0,h=T.length;h>c;c++)f=T[c],(f.needsUpdate||r.sortParticles)&&(ze.bindBuffer(ze.ARRAY_BUFFER,f.buffer),ze.bufferData(ze.ARRAY_BUFFER,f.array,t))}function v(e,t){var r,i,o,n,a,s,l,c,h,u,p,d,f=e.vertices,m=e.colors,v=e.lineDistances,g=f.length,y=m.length,x=v.length,w=e.__vertexArray,b=e.__colorArray,_=e.__lineDistanceArray,M=e.verticesNeedUpdate,S=e.colorsNeedUpdate,T=e.lineDistancesNeedUpdate,C=e.__webglCustomAttributesList;if(M){for(r=0;g>r;r++)n=f[r],a=3*r,w[a]=n.x,w[a+1]=n.y,w[a+2]=n.z;ze.bindBuffer(ze.ARRAY_BUFFER,e.__webglVertexBuffer),ze.bufferData(ze.ARRAY_BUFFER,w,t)}if(S){for(i=0;y>i;i++)s=m[i],a=3*i,b[a]=s.r,b[a+1]=s.g,b[a+2]=s.b;ze.bindBuffer(ze.ARRAY_BUFFER,e.__webglColorBuffer),ze.bufferData(ze.ARRAY_BUFFER,b,t)}if(T){for(o=0;x>o;o++)_[o]=v[o];ze.bindBuffer(ze.ARRAY_BUFFER,e.__webglLineDistanceBuffer),ze.bufferData(ze.ARRAY_BUFFER,_,t)}if(C)for(l=0,c=C.length;c>l;l++)if(d=C[l],d.needsUpdate&&(void 0===d.boundTo||"vertices"===d.boundTo)){if(a=0,u=d.value.length,1===d.size)for(h=0;u>h;h++)d.array[h]=d.value[h];else if(2===d.size)for(h=0;u>h;h++)p=d.value[h],d.array[a]=p.x,d.array[a+1]=p.y,a+=2;else if(3===d.size)if("c"===d.type)for(h=0;u>h;h++)p=d.value[h],d.array[a]=p.r,d.array[a+1]=p.g,d.array[a+2]=p.b,a+=3;else for(h=0;u>h;h++)p=d.value[h],d.array[a]=p.x,d.array[a+1]=p.y,d.array[a+2]=p.z,a+=3;else if(4===d.size)for(h=0;u>h;h++)p=d.value[h],d.array[a]=p.x,d.array[a+1]=p.y,d.array[a+2]=p.z,d.array[a+3]=p.w,a+=4;ze.bindBuffer(ze.ARRAY_BUFFER,d.buffer),ze.bufferData(ze.ARRAY_BUFFER,d.array,t)}}function g(t,r,i,o,n){if(t.__inittedArrays){var a,s,l,c,h,f,m,v,g,y,x,w,b,_,M,S,T,C,L,A,P,D,F,E,V,R,z,I,U,O,B,N,k,G,j,W,H,X,q,Y,Z,K,Q=u(n),J=p(n),$=d(n),ee=Q===e.SmoothShading,te=0,re=0,ie=0,oe=0,ne=0,ae=0,se=0,le=0,ce=0,he=0,ue=0,pe=0,de=0,fe=t.__vertexArray,me=t.__uvArray,ve=t.__uv2Array,ge=t.__normalArray,ye=t.__tangentArray,xe=t.__colorArray,we=t.__skinIndexArray,be=t.__skinWeightArray,_e=t.__morphTargetsArrays,Me=t.__morphNormalsArrays,Se=t.__webglCustomAttributesList,Te=t.__faceArray,Ce=t.__lineArray,Le=r.geometry,Ae=Le.verticesNeedUpdate,Pe=Le.elementsNeedUpdate,De=Le.uvsNeedUpdate,Fe=Le.normalsNeedUpdate,Ee=Le.tangentsNeedUpdate,Ve=Le.colorsNeedUpdate,Re=Le.morphTargetsNeedUpdate,Ie=Le.vertices,Ue=t.faces3,Oe=Le.faces,Be=Le.faceVertexUvs[0],Ne=Le.faceVertexUvs[1],ke=(Le.colors,Le.skinIndices),Ge=Le.skinWeights,je=Le.morphTargets,We=Le.morphNormals;if(Ae){for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],w=Ie[c.a],b=Ie[c.b],_=Ie[c.c],fe[re]=w.x,fe[re+1]=w.y,fe[re+2]=w.z,fe[re+3]=b.x,fe[re+4]=b.y,fe[re+5]=b.z,fe[re+6]=_.x,fe[re+7]=_.y,fe[re+8]=_.z,re+=9;ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglVertexBuffer),ze.bufferData(ze.ARRAY_BUFFER,fe,i)}if(Re)for(j=0,W=je.length;W>j;j++){for(ue=0,a=0,s=Ue.length;s>a;a++)q=Ue[a],c=Oe[q],w=je[j].vertices[c.a],b=je[j].vertices[c.b],_=je[j].vertices[c.c],H=_e[j],H[ue]=w.x,H[ue+1]=w.y,H[ue+2]=w.z,H[ue+3]=b.x,H[ue+4]=b.y,H[ue+5]=b.z,H[ue+6]=_.x,H[ue+7]=_.y,H[ue+8]=_.z,n.morphNormals&&(ee?(Y=We[j].vertexNormals[q],C=Y.a,L=Y.b,A=Y.c):(C=We[j].faceNormals[q],L=C,A=C),X=Me[j],X[ue]=C.x,X[ue+1]=C.y,X[ue+2]=C.z,X[ue+3]=L.x,X[ue+4]=L.y,X[ue+5]=L.z,X[ue+6]=A.x,X[ue+7]=A.y,X[ue+8]=A.z),ue+=9;ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[j]),ze.bufferData(ze.ARRAY_BUFFER,_e[j],i),n.morphNormals&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphNormalsBuffers[j]),ze.bufferData(ze.ARRAY_BUFFER,Me[j],i))}if(Ge.length){for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],E=Ge[c.a],V=Ge[c.b],R=Ge[c.c],be[he]=E.x,be[he+1]=E.y,be[he+2]=E.z,be[he+3]=E.w,be[he+4]=V.x,be[he+5]=V.y,be[he+6]=V.z,be[he+7]=V.w,be[he+8]=R.x,be[he+9]=R.y,be[he+10]=R.z,be[he+11]=R.w,z=ke[c.a],I=ke[c.b],U=ke[c.c],we[he]=z.x,we[he+1]=z.y,we[he+2]=z.z,we[he+3]=z.w,we[he+4]=I.x,we[he+5]=I.y,we[he+6]=I.z,we[he+7]=I.w,we[he+8]=U.x,we[he+9]=U.y,we[he+10]=U.z,we[he+11]=U.w,he+=12;he>0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglSkinIndicesBuffer),ze.bufferData(ze.ARRAY_BUFFER,we,i),ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglSkinWeightsBuffer),ze.bufferData(ze.ARRAY_BUFFER,be,i))}if(Ve&&J){for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],m=c.vertexColors,v=c.color,3===m.length&&J===e.VertexColors?(P=m[0],D=m[1],F=m[2]):(P=v,D=v,F=v),xe[ce]=P.r,xe[ce+1]=P.g,xe[ce+2]=P.b,xe[ce+3]=D.r,xe[ce+4]=D.g,xe[ce+5]=D.b,xe[ce+6]=F.r,xe[ce+7]=F.g,xe[ce+8]=F.b,ce+=9;ce>0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglColorBuffer),ze.bufferData(ze.ARRAY_BUFFER,xe,i))}if(Ee&&Le.hasTangents){for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],g=c.vertexTangents,M=g[0],S=g[1],T=g[2],ye[se]=M.x,ye[se+1]=M.y,ye[se+2]=M.z,ye[se+3]=M.w,ye[se+4]=S.x,ye[se+5]=S.y,ye[se+6]=S.z,ye[se+7]=S.w,ye[se+8]=T.x,ye[se+9]=T.y,ye[se+10]=T.z,ye[se+11]=T.w,se+=12;ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglTangentBuffer),ze.bufferData(ze.ARRAY_BUFFER,ye,i)}if(Fe&&Q){for(a=0,s=Ue.length;s>a;a++)if(c=Oe[Ue[a]],h=c.vertexNormals,f=c.normal,3===h.length&&ee)for(O=0;3>O;O++)N=h[O],ge[ae]=N.x,ge[ae+1]=N.y,ge[ae+2]=N.z,ae+=3;else for(O=0;3>O;O++)ge[ae]=f.x,ge[ae+1]=f.y,ge[ae+2]=f.z,ae+=3;ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglNormalBuffer),ze.bufferData(ze.ARRAY_BUFFER,ge,i)}if(De&&Be&&$){for(a=0,s=Ue.length;s>a;a++)if(l=Ue[a],y=Be[l],void 0!==y)for(O=0;3>O;O++)k=y[O],me[ie]=k.x,me[ie+1]=k.y,ie+=2;ie>0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglUVBuffer),ze.bufferData(ze.ARRAY_BUFFER,me,i))}if(De&&Ne&&$){for(a=0,s=Ue.length;s>a;a++)if(l=Ue[a],x=Ne[l],void 0!==x)for(O=0;3>O;O++)G=x[O],ve[oe]=G.x,ve[oe+1]=G.y,oe+=2;oe>0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglUV2Buffer),ze.bufferData(ze.ARRAY_BUFFER,ve,i))}if(Pe){for(a=0,s=Ue.length;s>a;a++)Te[ne]=te,Te[ne+1]=te+1,Te[ne+2]=te+2,ne+=3,Ce[le]=te,Ce[le+1]=te+1,Ce[le+2]=te,Ce[le+3]=te+2,Ce[le+4]=te+1,Ce[le+5]=te+2,le+=6,te+=3;ze.bindBuffer(ze.ELEMENT_ARRAY_BUFFER,t.__webglFaceBuffer),ze.bufferData(ze.ELEMENT_ARRAY_BUFFER,Te,i),ze.bindBuffer(ze.ELEMENT_ARRAY_BUFFER,t.__webglLineBuffer),ze.bufferData(ze.ELEMENT_ARRAY_BUFFER,Ce,i)}if(Se)for(O=0,B=Se.length;B>O;O++)if(K=Se[O],K.__original.needsUpdate){if(pe=0,de=0,1===K.size){if(void 0===K.boundTo||"vertices"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],K.array[pe]=K.value[c.a],K.array[pe+1]=K.value[c.b],K.array[pe+2]=K.value[c.c],pe+=3;else if("faces"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)Z=K.value[Ue[a]],K.array[pe]=Z,K.array[pe+1]=Z,K.array[pe+2]=Z,pe+=3}else if(2===K.size){if(void 0===K.boundTo||"vertices"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],w=K.value[c.a],b=K.value[c.b],_=K.value[c.c],K.array[pe]=w.x,K.array[pe+1]=w.y,K.array[pe+2]=b.x,K.array[pe+3]=b.y,K.array[pe+4]=_.x,K.array[pe+5]=_.y,pe+=6;else if("faces"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)Z=K.value[Ue[a]],w=Z,b=Z,_=Z,K.array[pe]=w.x,K.array[pe+1]=w.y,K.array[pe+2]=b.x,K.array[pe+3]=b.y,K.array[pe+4]=_.x,K.array[pe+5]=_.y,pe+=6}else if(3===K.size){var He;if(He="c"===K.type?["r","g","b"]:["x","y","z"],void 0===K.boundTo||"vertices"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],w=K.value[c.a],b=K.value[c.b],_=K.value[c.c],K.array[pe]=w[He[0]],K.array[pe+1]=w[He[1]],K.array[pe+2]=w[He[2]],K.array[pe+3]=b[He[0]],K.array[pe+4]=b[He[1]],K.array[pe+5]=b[He[2]],K.array[pe+6]=_[He[0]],K.array[pe+7]=_[He[1]],K.array[pe+8]=_[He[2]],pe+=9;else if("faces"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)Z=K.value[Ue[a]],w=Z,b=Z,_=Z,K.array[pe]=w[He[0]],K.array[pe+1]=w[He[1]],K.array[pe+2]=w[He[2]],K.array[pe+3]=b[He[0]],K.array[pe+4]=b[He[1]],K.array[pe+5]=b[He[2]],K.array[pe+6]=_[He[0]],K.array[pe+7]=_[He[1]],K.array[pe+8]=_[He[2]],pe+=9;else if("faceVertices"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)Z=K.value[Ue[a]],w=Z[0],b=Z[1],_=Z[2],K.array[pe]=w[He[0]],K.array[pe+1]=w[He[1]],K.array[pe+2]=w[He[2]],K.array[pe+3]=b[He[0]],K.array[pe+4]=b[He[1]],K.array[pe+5]=b[He[2]],K.array[pe+6]=_[He[0]],K.array[pe+7]=_[He[1]],K.array[pe+8]=_[He[2]],pe+=9}else if(4===K.size)if(void 0===K.boundTo||"vertices"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)c=Oe[Ue[a]],w=K.value[c.a],b=K.value[c.b],_=K.value[c.c],K.array[pe]=w.x,K.array[pe+1]=w.y,K.array[pe+2]=w.z,K.array[pe+3]=w.w,K.array[pe+4]=b.x,K.array[pe+5]=b.y,K.array[pe+6]=b.z,K.array[pe+7]=b.w,K.array[pe+8]=_.x,K.array[pe+9]=_.y,K.array[pe+10]=_.z,K.array[pe+11]=_.w,pe+=12;else if("faces"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)Z=K.value[Ue[a]],w=Z,b=Z,_=Z,K.array[pe]=w.x,K.array[pe+1]=w.y,K.array[pe+2]=w.z,K.array[pe+3]=w.w,K.array[pe+4]=b.x,K.array[pe+5]=b.y,K.array[pe+6]=b.z,K.array[pe+7]=b.w,K.array[pe+8]=_.x,K.array[pe+9]=_.y,K.array[pe+10]=_.z,K.array[pe+11]=_.w,pe+=12;else if("faceVertices"===K.boundTo)for(a=0,s=Ue.length;s>a;a++)Z=K.value[Ue[a]],w=Z[0],b=Z[1],_=Z[2],K.array[pe]=w.x,K.array[pe+1]=w.y,K.array[pe+2]=w.z,K.array[pe+3]=w.w,K.array[pe+4]=b.x,K.array[pe+5]=b.y,K.array[pe+6]=b.z,K.array[pe+7]=b.w,K.array[pe+8]=_.x,K.array[pe+9]=_.y,K.array[pe+10]=_.z,K.array[pe+11]=_.w,pe+=12;ze.bindBuffer(ze.ARRAY_BUFFER,K.buffer),ze.bufferData(ze.ARRAY_BUFFER,K.array,i)}o&&(delete t.__inittedArrays,delete t.__colorArray,delete t.__normalArray,delete t.__tangentArray,delete t.__uvArray,delete t.__uv2Array,delete t.__faceArray,delete t.__vertexArray,delete t.__lineArray,delete t.__skinIndexArray,delete t.__skinWeightArray)}}function y(e,t,r){var i,o,n=e.attributes;for(i in n)o=n[i],o.needsUpdate&&("index"===i?(ze.bindBuffer(ze.ELEMENT_ARRAY_BUFFER,o.buffer),ze.bufferData(ze.ELEMENT_ARRAY_BUFFER,o.array,t)):(ze.bindBuffer(ze.ARRAY_BUFFER,o.buffer),ze.bufferData(ze.ARRAY_BUFFER,o.array,t)),o.needsUpdate=!1),r&&!o.dynamic&&(o.array=null)}function x(e){mt[e]||(ze.enableVertexAttribArray(e),mt[e]=!0)}function w(){for(var e in mt)mt[e]&&(ze.disableVertexAttribArray(e),mt[e]=!1)}function b(e,t,r){var i=e.program.attributes;if(-1!==r.morphTargetBase&&i.position>=0?(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[r.morphTargetBase]),x(i.position),ze.vertexAttribPointer(i.position,3,ze.FLOAT,!1,0,0)):i.position>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglVertexBuffer),x(i.position),ze.vertexAttribPointer(i.position,3,ze.FLOAT,!1,0,0)),r.morphTargetForcedOrder.length)for(var o=0,n=r.morphTargetForcedOrder,a=r.morphTargetInfluences;o<e.numSupportedMorphTargets&&o<n.length;)i["morphTarget"+o]>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[n[o]]),x(i["morphTarget"+o]),ze.vertexAttribPointer(i["morphTarget"+o],3,ze.FLOAT,!1,0,0)),i["morphNormal"+o]>=0&&e.morphNormals&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphNormalsBuffers[n[o]]),x(i["morphNormal"+o]),ze.vertexAttribPointer(i["morphNormal"+o],3,ze.FLOAT,!1,0,0)),r.__webglMorphTargetInfluences[o]=a[n[o]],o++;else{var s,l,c=[],a=r.morphTargetInfluences,h=a.length;for(l=0;h>l;l++)s=a[l],s>0&&c.push([s,l]);c.length>e.numSupportedMorphTargets?(c.sort(M),c.length=e.numSupportedMorphTargets):c.length>e.numSupportedMorphNormals?c.sort(M):0===c.length&&c.push([0,0]);for(var u,o=0;o<e.numSupportedMorphTargets;)c[o]?(u=c[o][1],i["morphTarget"+o]>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[u]),x(i["morphTarget"+o]),ze.vertexAttribPointer(i["morphTarget"+o],3,ze.FLOAT,!1,0,0)),i["morphNormal"+o]>=0&&e.morphNormals&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglMorphNormalsBuffers[u]),x(i["morphNormal"+o]),ze.vertexAttribPointer(i["morphNormal"+o],3,ze.FLOAT,!1,0,0)),r.__webglMorphTargetInfluences[o]=a[u]):r.__webglMorphTargetInfluences[o]=0,o++}null!==e.program.uniforms.morphTargetInfluences&&ze.uniform1fv(e.program.uniforms.morphTargetInfluences,r.__webglMorphTargetInfluences)}function _(e,t){return e.z!==t.z?t.z-e.z:e.id-t.id}function M(e,t){return t[0]-e[0]}function S(e,t,r){if(e.length)for(var i=0,o=e.length;o>i;i++)We=null,Ye=null,$e=-1,it=-1,ot=-1,Qe=-1,Je=-1,qe=-1,Xe=-1,bt=!0,e[i].render(t,r,dt,ft),We=null,Ye=null,$e=-1,it=-1,ot=-1,Qe=-1,Je=-1,qe=-1,Xe=-1,bt=!0}function T(t,r,i,o,n,a,s,l){var c,h,u,p,d,f,m;r?(d=t.length-1,f=-1,m=-1):(d=0,f=t.length,m=1);for(var v=d;v!==f;v+=m)if(c=t[v],c.render){if(h=c.object,u=c.buffer,l)p=l;else{if(p=c[i],!p)continue;s&&ke.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst),ke.setDepthTest(p.depthTest),ke.setDepthWrite(p.depthWrite),oe(p.polygonOffset,p.polygonOffsetFactor,p.polygonOffsetUnits)}ke.setMaterialFaces(p),u instanceof e.BufferGeometry?ke.renderBufferDirect(o,n,a,p,u,h):ke.renderBuffer(o,n,a,p,u,h)}}function C(e,t,r,i,o,n,a){for(var s,l,c,h=0,u=e.length;u>h;h++)if(s=e[h],l=s.object,l.visible){if(a)c=a;else{if(c=s[t],!c)continue;n&&ke.setBlending(c.blending,c.blendEquation,c.blendSrc,c.blendDst),ke.setDepthTest(c.depthTest),ke.setDepthWrite(c.depthWrite),oe(c.polygonOffset,c.polygonOffsetFactor,c.polygonOffsetUnits)}ke.renderImmediateObject(r,i,o,c,l)}}function L(e){var t=e.object,r=t.material;r.transparent?(e.transparent=r,e.opaque=null):(e.opaque=r,e.transparent=null)}function A(t){var r=t.object,i=t.buffer,o=r.geometry,n=r.material;if(n instanceof e.MeshFaceMaterial){var a=o instanceof e.BufferGeometry?0:i.materialIndex;n=n.materials[a],n.transparent?(t.transparent=n,t.opaque=null):(t.opaque=n,t.transparent=null)}else n&&(n.transparent?(t.transparent=n,t.opaque=null):(t.opaque=n,t.transparent=null))}function P(t,r){var i,o,n,a,s,l,c={},h=t.morphTargets.length,u=t.morphNormals.length,p=r instanceof e.MeshFaceMaterial;for(t.geometryGroups={},i=0,o=t.faces.length;o>i;i++)n=t.faces[i],a=p?n.materialIndex:0,void 0===c[a]&&(c[a]={hash:a,counter:0}),l=c[a].hash+"_"+c[a].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],materialIndex:a,vertices:0,numMorphTargets:h,numMorphNormals:u}),s=3,t.geometryGroups[l].vertices+s>65535&&(c[a].counter+=1,l=c[a].hash+"_"+c[a].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],materialIndex:a,vertices:0,numMorphTargets:h,numMorphNormals:u})),t.geometryGroups[l].faces3.push(i),t.geometryGroups[l].vertices+=s;t.geometryGroupsList=[];for(var d in t.geometryGroups)t.geometryGroups[d].id=Ze++,t.geometryGroupsList.push(t.geometryGroups[d])}function D(t,n){var c,h,u,p;if(void 0===t.__webglInit)if(t.__webglInit=!0,t._modelViewMatrix=new e.Matrix4,t._normalMatrix=new e.Matrix3,void 0!==t.geometry&&void 0===t.geometry.__webglInit&&(t.geometry.__webglInit=!0,t.geometry.addEventListener("dispose",zt)),h=t.geometry,void 0===h);else if(h instanceof e.BufferGeometry)f(h);else if(t instanceof e.Mesh){u=t.material,void 0===h.geometryGroups&&P(h,u);for(c in h.geometryGroups)p=h.geometryGroups[c],p.__webglVertexBuffer||(o(p),l(p,t),h.verticesNeedUpdate=!0,h.morphTargetsNeedUpdate=!0,h.elementsNeedUpdate=!0,h.uvsNeedUpdate=!0,h.normalsNeedUpdate=!0,h.tangentsNeedUpdate=!0,h.colorsNeedUpdate=!0)}else t instanceof e.Line?h.__webglVertexBuffer||(i(h),s(h,t),h.verticesNeedUpdate=!0,h.colorsNeedUpdate=!0,h.lineDistancesNeedUpdate=!0):t instanceof e.ParticleSystem&&(h.__webglVertexBuffer||(r(h),a(h,t),h.verticesNeedUpdate=!0,h.colorsNeedUpdate=!0));if(void 0===t.__webglActive){if(t instanceof e.Mesh){if(h=t.geometry,h instanceof e.BufferGeometry)F(n.__webglObjects,h,t);else if(h instanceof e.Geometry)for(c in h.geometryGroups)p=h.geometryGroups[c],F(n.__webglObjects,p,t)}else t instanceof e.Line||t instanceof e.ParticleSystem?(h=t.geometry,F(n.__webglObjects,h,t)):t instanceof e.ImmediateRenderObject||t.immediateRenderCallback?E(n.__webglObjectsImmediate,t):t instanceof e.Sprite?n.__webglSprites.push(t):t instanceof e.LensFlare&&n.__webglFlares.push(t);t.__webglActive=!0}}function F(e,t,r){e.push({id:null,buffer:t,object:r,opaque:null,transparent:null,z:0})}function E(e,t){e.push({id:null,object:t,opaque:null,transparent:null,z:0})}function V(t){var r,i,o,n=t.geometry;if(n instanceof e.BufferGeometry)y(n,ze.DYNAMIC_DRAW,!n.dynamic);else if(t instanceof e.Mesh){for(var a=0,s=n.geometryGroupsList.length;s>a;a++)r=n.geometryGroupsList[a],o=c(t,r),n.buffersNeedUpdate&&l(r,t),i=o.attributes&&R(o),(n.verticesNeedUpdate||n.morphTargetsNeedUpdate||n.elementsNeedUpdate||n.uvsNeedUpdate||n.normalsNeedUpdate||n.colorsNeedUpdate||n.tangentsNeedUpdate||i)&&g(r,t,ze.DYNAMIC_DRAW,!n.dynamic,o);n.verticesNeedUpdate=!1,n.morphTargetsNeedUpdate=!1,n.elementsNeedUpdate=!1,n.uvsNeedUpdate=!1,n.normalsNeedUpdate=!1,n.colorsNeedUpdate=!1,n.tangentsNeedUpdate=!1,n.buffersNeedUpdate=!1,o.attributes&&z(o)}else t instanceof e.Line?(o=c(t,n),i=o.attributes&&R(o),(n.verticesNeedUpdate||n.colorsNeedUpdate||n.lineDistancesNeedUpdate||i)&&v(n,ze.DYNAMIC_DRAW),n.verticesNeedUpdate=!1,n.colorsNeedUpdate=!1,n.lineDistancesNeedUpdate=!1,o.attributes&&z(o)):t instanceof e.ParticleSystem&&(o=c(t,n),i=o.attributes&&R(o),(n.verticesNeedUpdate||n.colorsNeedUpdate||t.sortParticles||i)&&m(n,ze.DYNAMIC_DRAW,t),n.verticesNeedUpdate=!1,n.colorsNeedUpdate=!1,o.attributes&&z(o))}function R(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function z(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function I(t,r){t instanceof e.Mesh||t instanceof e.ParticleSystem||t instanceof e.Line?U(r.__webglObjects,t):t instanceof e.Sprite?O(r.__webglSprites,t):t instanceof e.LensFlare?O(r.__webglFlares,t):(t instanceof e.ImmediateRenderObject||t.immediateRenderCallback)&&U(r.__webglObjectsImmediate,t),delete t.__webglActive}function U(e,t){for(var r=e.length-1;r>=0;r--)e[r].object===t&&e.splice(r,1)}function O(e,t){for(var r=e.length-1;r>=0;r--)e[r]===t&&e.splice(r,1)}function B(t,r){t.uniforms=e.UniformsUtils.clone(r.uniforms),t.vertexShader=r.vertexShader,t.fragmentShader=r.fragmentShader}function N(t,r,i,o,n){Ke=0,o.needsUpdate&&(o.program&&jt(o),ke.initMaterial(o,r,i,n),o.needsUpdate=!1),o.morphTargets&&(n.__webglMorphTargetInfluences||(n.__webglMorphTargetInfluences=new Float32Array(ke.maxMorphTargets)));var a=!1,s=o.program,l=s.uniforms,c=o.uniforms;if(s!==We&&(ze.useProgram(s),We=s,a=!0),o.id!==Xe&&(Xe=o.id,a=!0),(a||t!==Ye)&&(ze.uniformMatrix4fv(l.projectionMatrix,!1,t.projectionMatrix.elements),t!==Ye&&(Ye=t)),o.skinning)if(At&&n.useVertexTexture){if(null!==l.boneTexture){var h=Q();ze.uniform1i(l.boneTexture,h),ke.setTexture(n.boneTexture,h)}null!==l.boneTextureWidth&&ze.uniform1i(l.boneTextureWidth,n.boneTextureWidth),null!==l.boneTextureHeight&&ze.uniform1i(l.boneTextureHeight,n.boneTextureHeight)}else null!==l.boneGlobalMatrices&&ze.uniformMatrix4fv(l.boneGlobalMatrices,!1,n.boneMatrices);return a&&(i&&o.fog&&H(c,i),(o instanceof e.MeshPhongMaterial||o instanceof e.MeshLambertMaterial||o.lights)&&(bt&&(re(s,r),bt=!1),Y(c,_t)),(o instanceof e.MeshBasicMaterial||o instanceof e.MeshLambertMaterial||o instanceof e.MeshPhongMaterial)&&k(c,o),o instanceof e.LineBasicMaterial?G(c,o):o instanceof e.LineDashedMaterial?(G(c,o),j(c,o)):o instanceof e.ParticleSystemMaterial?W(c,o):o instanceof e.MeshPhongMaterial?X(c,o):o instanceof e.MeshLambertMaterial?q(c,o):o instanceof e.MeshDepthMaterial?(c.mNear.value=t.near,c.mFar.value=t.far,c.opacity.value=o.opacity):o instanceof e.MeshNormalMaterial&&(c.opacity.value=o.opacity),n.receiveShadow&&!o._shadowPass&&Z(c,r),J(s,o.uniformsList),(o instanceof e.ShaderMaterial||o instanceof e.MeshPhongMaterial||o.envMap)&&null!==l.cameraPosition&&(xt.getPositionFromMatrix(t.matrixWorld),ze.uniform3f(l.cameraPosition,xt.x,xt.y,xt.z)),(o instanceof e.MeshPhongMaterial||o instanceof e.MeshLambertMaterial||o instanceof e.ShaderMaterial||o.skinning)&&null!==l.viewMatrix&&ze.uniformMatrix4fv(l.viewMatrix,!1,t.matrixWorldInverse.elements)),K(l,n),null!==l.modelMatrix&&ze.uniformMatrix4fv(l.modelMatrix,!1,n.matrixWorld.elements),s}function k(t,r){t.opacity.value=r.opacity,ke.gammaInput?t.diffuse.value.copyGammaToLinear(r.color):t.diffuse.value=r.color,t.map.value=r.map,t.lightMap.value=r.lightMap,t.specularMap.value=r.specularMap,r.bumpMap&&(t.bumpMap.value=r.bumpMap,t.bumpScale.value=r.bumpScale),r.normalMap&&(t.normalMap.value=r.normalMap,t.normalScale.value.copy(r.normalScale));var i;if(r.map?i=r.map:r.specularMap?i=r.specularMap:r.normalMap?i=r.normalMap:r.bumpMap&&(i=r.bumpMap),void 0!==i){var o=i.offset,n=i.repeat;t.offsetRepeat.value.set(o.x,o.y,n.x,n.y)}t.envMap.value=r.envMap,t.flipEnvMap.value=r.envMap instanceof e.WebGLRenderTargetCube?1:-1,ke.gammaInput?t.reflectivity.value=r.reflectivity:t.reflectivity.value=r.reflectivity,t.refractionRatio.value=r.refractionRatio,t.combine.value=r.combine,t.useRefract.value=r.envMap&&r.envMap.mapping instanceof e.CubeRefractionMapping}function G(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function j(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function W(e,t){e.psColor.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size,e.scale.value=Ce.height/2,e.map.value=t.map}function H(t,r){t.fogColor.value=r.color,r instanceof e.Fog?(t.fogNear.value=r.near,t.fogFar.value=r.far):r instanceof e.FogExp2&&(t.fogDensity.value=r.density)}function X(e,t){e.shininess.value=t.shininess,ke.gammaInput?(e.ambient.value.copyGammaToLinear(t.ambient),e.emissive.value.copyGammaToLinear(t.emissive),e.specular.value.copyGammaToLinear(t.specular)):(e.ambient.value=t.ambient,e.emissive.value=t.emissive,e.specular.value=t.specular),t.wrapAround&&e.wrapRGB.value.copy(t.wrapRGB)}function q(e,t){ke.gammaInput?(e.ambient.value.copyGammaToLinear(t.ambient),e.emissive.value.copyGammaToLinear(t.emissive)):(e.ambient.value=t.ambient,e.emissive.value=t.emissive),t.wrapAround&&e.wrapRGB.value.copy(t.wrapRGB)}function Y(e,t){e.ambientLightColor.value=t.ambient,e.directionalLightColor.value=t.directional.colors,e.directionalLightDirection.value=t.directional.positions,e.pointLightColor.value=t.point.colors,e.pointLightPosition.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.spotLightColor.value=t.spot.colors,e.spotLightPosition.value=t.spot.positions,e.spotLightDistance.value=t.spot.distances,e.spotLightDirection.value=t.spot.directions,e.spotLightAngleCos.value=t.spot.anglesCos,e.spotLightExponent.value=t.spot.exponents,e.hemisphereLightSkyColor.value=t.hemi.skyColors,e.hemisphereLightGroundColor.value=t.hemi.groundColors,e.hemisphereLightDirection.value=t.hemi.positions}function Z(t,r){if(t.shadowMatrix)for(var i=0,o=0,n=r.length;n>o;o++){var a=r[o];a.castShadow&&(a instanceof e.SpotLight||a instanceof e.DirectionalLight&&!a.shadowCascade)&&(t.shadowMap.value[i]=a.shadowMap,t.shadowMapSize.value[i]=a.shadowMapSize,t.shadowMatrix.value[i]=a.shadowMatrix,t.shadowDarkness.value[i]=a.shadowDarkness,t.shadowBias.value[i]=a.shadowBias,i++)}}function K(e,t){ze.uniformMatrix4fv(e.modelViewMatrix,!1,t._modelViewMatrix.elements),e.normalMatrix&&ze.uniformMatrix3fv(e.normalMatrix,!1,t._normalMatrix.elements)}function Q(){var e=Ke;return e>=Mt&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+Mt),Ke+=1,e}function J(t,r){var i,o,n,a,s,l,c,h,u,p,d;for(u=0,p=r.length;p>u;u++)if(a=t.uniforms[r[u][1]])if(i=r[u][0],n=i.type,o=i.value,"i"===n)ze.uniform1i(a,o);else if("f"===n)ze.uniform1f(a,o);else if("v2"===n)ze.uniform2f(a,o.x,o.y);else if("v3"===n)ze.uniform3f(a,o.x,o.y,o.z);else if("v4"===n)ze.uniform4f(a,o.x,o.y,o.z,o.w);else if("c"===n)ze.uniform3f(a,o.r,o.g,o.b);else if("iv1"===n)ze.uniform1iv(a,o);else if("iv"===n)ze.uniform3iv(a,o);else if("fv1"===n)ze.uniform1fv(a,o);else if("fv"===n)ze.uniform3fv(a,o);else if("v2v"===n){for(void 0===i._array&&(i._array=new Float32Array(2*o.length)),c=0,h=o.length;h>c;c++)d=2*c,i._array[d]=o[c].x,i._array[d+1]=o[c].y;ze.uniform2fv(a,i._array)}else if("v3v"===n){for(void 0===i._array&&(i._array=new Float32Array(3*o.length)),c=0,h=o.length;h>c;c++)d=3*c,i._array[d]=o[c].x,i._array[d+1]=o[c].y,i._array[d+2]=o[c].z;ze.uniform3fv(a,i._array)}else if("v4v"===n){for(void 0===i._array&&(i._array=new Float32Array(4*o.length)),c=0,h=o.length;h>c;c++)d=4*c,i._array[d]=o[c].x,i._array[d+1]=o[c].y,i._array[d+2]=o[c].z,i._array[d+3]=o[c].w;ze.uniform4fv(a,i._array)}else if("m4"===n)void 0===i._array&&(i._array=new Float32Array(16)),o.flattenToArray(i._array),ze.uniformMatrix4fv(a,!1,i._array);else if("m4v"===n){for(void 0===i._array&&(i._array=new Float32Array(16*o.length)),c=0,h=o.length;h>c;c++)o[c].flattenToArrayOffset(i._array,16*c);ze.uniformMatrix4fv(a,!1,i._array)}else if("t"===n){if(s=o,l=Q(),ze.uniform1i(a,l),!s)continue;s.image instanceof Array&&6===s.image.length?fe(s,l):s instanceof e.WebGLRenderTargetCube?me(s,l):ke.setTexture(s,l)}else if("tv"===n){for(void 0===i._array&&(i._array=[]),c=0,h=i.value.length;h>c;c++)i._array[c]=Q();for(ze.uniform1iv(a,i._array),c=0,h=i.value.length;h>c;c++)s=i.value[c],l=i._array[c],s&&ke.setTexture(s,l)}else console.warn("THREE.WebGLRenderer: Unknown uniform type: "+n)}function $(e,t){e._modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld),e._normalMatrix.getNormalMatrix(e._modelViewMatrix)}function ee(e,t,r,i){e[t]=r.r*r.r*i,e[t+1]=r.g*r.g*i,
e[t+2]=r.b*r.b*i}function te(e,t,r,i){e[t]=r.r*i,e[t+1]=r.g*i,e[t+2]=r.b*i}function re(t,r){var i,o,n,a,s,l,c,h,u,p=0,d=0,f=0,m=_t,v=m.directional.colors,g=m.directional.positions,y=m.point.colors,x=m.point.positions,w=m.point.distances,b=m.spot.colors,_=m.spot.positions,M=m.spot.distances,S=m.spot.directions,T=m.spot.anglesCos,C=m.spot.exponents,L=m.hemi.skyColors,A=m.hemi.groundColors,P=m.hemi.positions,D=0,F=0,E=0,V=0,R=0,z=0,I=0,U=0,O=0,B=0,N=0,k=0;for(i=0,o=r.length;o>i;i++)if(n=r[i],!n.onlyShadow)if(a=n.color,c=n.intensity,u=n.distance,n instanceof e.AmbientLight){if(!n.visible)continue;ke.gammaInput?(p+=a.r*a.r,d+=a.g*a.g,f+=a.b*a.b):(p+=a.r,d+=a.g,f+=a.b)}else if(n instanceof e.DirectionalLight){if(R+=1,!n.visible)continue;if(wt.getPositionFromMatrix(n.matrixWorld),xt.getPositionFromMatrix(n.target.matrixWorld),wt.sub(xt),wt.normalize(),0===wt.x&&0===wt.y&&0===wt.z)continue;O=3*D,g[O]=wt.x,g[O+1]=wt.y,g[O+2]=wt.z,ke.gammaInput?ee(v,O,a,c*c):te(v,O,a,c),D+=1}else if(n instanceof e.PointLight){if(z+=1,!n.visible)continue;B=3*F,ke.gammaInput?ee(y,B,a,c*c):te(y,B,a,c),xt.getPositionFromMatrix(n.matrixWorld),x[B]=xt.x,x[B+1]=xt.y,x[B+2]=xt.z,w[F]=u,F+=1}else if(n instanceof e.SpotLight){if(I+=1,!n.visible)continue;N=3*E,ke.gammaInput?ee(b,N,a,c*c):te(b,N,a,c),xt.getPositionFromMatrix(n.matrixWorld),_[N]=xt.x,_[N+1]=xt.y,_[N+2]=xt.z,M[E]=u,wt.copy(xt),xt.getPositionFromMatrix(n.target.matrixWorld),wt.sub(xt),wt.normalize(),S[N]=wt.x,S[N+1]=wt.y,S[N+2]=wt.z,T[E]=Math.cos(n.angle),C[E]=n.exponent,E+=1}else if(n instanceof e.HemisphereLight){if(U+=1,!n.visible)continue;if(wt.getPositionFromMatrix(n.matrixWorld),wt.normalize(),0===wt.x&&0===wt.y&&0===wt.z)continue;k=3*V,P[k]=wt.x,P[k+1]=wt.y,P[k+2]=wt.z,s=n.color,l=n.groundColor,ke.gammaInput?(h=c*c,ee(L,k,s,h),ee(A,k,l,h)):(te(L,k,s,c),te(A,k,l,c)),V+=1}for(i=3*D,o=Math.max(v.length,3*R);o>i;i++)v[i]=0;for(i=3*F,o=Math.max(y.length,3*z);o>i;i++)y[i]=0;for(i=3*E,o=Math.max(b.length,3*I);o>i;i++)b[i]=0;for(i=3*V,o=Math.max(L.length,3*U);o>i;i++)L[i]=0;for(i=3*V,o=Math.max(A.length,3*U);o>i;i++)A[i]=0;m.directional.length=D,m.point.length=F,m.spot.length=E,m.hemi.length=V,m.ambient[0]=p,m.ambient[1]=d,m.ambient[2]=f}function ie(e){e!==lt&&(ze.lineWidth(e),lt=e)}function oe(e,t,r){nt!==e&&(e?ze.enable(ze.POLYGON_OFFSET_FILL):ze.disable(ze.POLYGON_OFFSET_FILL),nt=e),!e||at===t&&st===r||(ze.polygonOffset(t,r),at=t,st=r)}function ne(e){var t,r,i=[];for(var o in e)t=e[o],t!==!1&&(r="#define "+o+" "+t,i.push(r));return i.join("\n")}function ae(t,r,i,o,n,a,s,l){var c,h,u,p,d,f=[];t?f.push(t):(f.push(r),f.push(i));for(u in a)f.push(u),f.push(a[u]);for(c in s)f.push(c),f.push(s[c]);for(d=f.join(),c=0,h=Ge.length;h>c;c++){var m=Ge[c];if(m.code===d)return m.usedTimes++,m.program}var v="SHADOWMAP_TYPE_BASIC";s.shadowMapType===e.PCFShadowMap?v="SHADOWMAP_TYPE_PCF":s.shadowMapType===e.PCFSoftShadowMap&&(v="SHADOWMAP_TYPE_PCF_SOFT");var g=ne(a);p=ze.createProgram();var y=["precision "+Le+" float;","precision "+Le+" int;",g,Lt?"#define VERTEX_TEXTURES":"",ke.gammaInput?"#define GAMMA_INPUT":"",ke.gammaOutput?"#define GAMMA_OUTPUT":"",ke.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+s.maxDirLights,"#define MAX_POINT_LIGHTS "+s.maxPointLights,"#define MAX_SPOT_LIGHTS "+s.maxSpotLights,"#define MAX_HEMI_LIGHTS "+s.maxHemiLights,"#define MAX_SHADOWS "+s.maxShadows,"#define MAX_BONES "+s.maxBones,s.map?"#define USE_MAP":"",s.envMap?"#define USE_ENVMAP":"",s.lightMap?"#define USE_LIGHTMAP":"",s.bumpMap?"#define USE_BUMPMAP":"",s.normalMap?"#define USE_NORMALMAP":"",s.specularMap?"#define USE_SPECULARMAP":"",s.vertexColors?"#define USE_COLOR":"",s.skinning?"#define USE_SKINNING":"",s.useVertexTexture?"#define BONE_TEXTURE":"",s.morphTargets?"#define USE_MORPHTARGETS":"",s.morphNormals?"#define USE_MORPHNORMALS":"",s.perPixel?"#define PHONG_PER_PIXEL":"",s.wrapAround?"#define WRAP_AROUND":"",s.doubleSided?"#define DOUBLE_SIDED":"",s.flipSided?"#define FLIP_SIDED":"",s.shadowMapEnabled?"#define USE_SHADOWMAP":"",s.shadowMapEnabled?"#define "+v:"",s.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",s.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",s.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),x=["precision "+Le+" float;","precision "+Le+" int;",s.bumpMap||s.normalMap?"#extension GL_OES_standard_derivatives : enable":"",g,"#define MAX_DIR_LIGHTS "+s.maxDirLights,"#define MAX_POINT_LIGHTS "+s.maxPointLights,"#define MAX_SPOT_LIGHTS "+s.maxSpotLights,"#define MAX_HEMI_LIGHTS "+s.maxHemiLights,"#define MAX_SHADOWS "+s.maxShadows,s.alphaTest?"#define ALPHATEST "+s.alphaTest:"",ke.gammaInput?"#define GAMMA_INPUT":"",ke.gammaOutput?"#define GAMMA_OUTPUT":"",ke.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",s.useFog&&s.fog?"#define USE_FOG":"",s.useFog&&s.fogExp?"#define FOG_EXP2":"",s.map?"#define USE_MAP":"",s.envMap?"#define USE_ENVMAP":"",s.lightMap?"#define USE_LIGHTMAP":"",s.bumpMap?"#define USE_BUMPMAP":"",s.normalMap?"#define USE_NORMALMAP":"",s.specularMap?"#define USE_SPECULARMAP":"",s.vertexColors?"#define USE_COLOR":"",s.metal?"#define METAL":"",s.perPixel?"#define PHONG_PER_PIXEL":"",s.wrapAround?"#define WRAP_AROUND":"",s.doubleSided?"#define DOUBLE_SIDED":"",s.flipSided?"#define FLIP_SIDED":"",s.shadowMapEnabled?"#define USE_SHADOWMAP":"",s.shadowMapEnabled?"#define "+v:"",s.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",s.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n"),w=he("vertex",y+i),b=he("fragment",x+r);ze.attachShader(p,w),ze.attachShader(p,b),l&&ze.bindAttribLocation(p,0,l),ze.linkProgram(p),ze.getProgramParameter(p,ze.LINK_STATUS)||(console.error("Could not initialise shader\nVALIDATE_STATUS: "+ze.getProgramParameter(p,ze.VALIDATE_STATUS)+", gl error ["+ze.getError()+"]"),console.error("Program Info Log: "+ze.getProgramInfoLog(p))),ze.deleteShader(b),ze.deleteShader(w),p.uniforms={},p.attributes={};var _,M,S,T;_=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","morphTargetInfluences"],s.useVertexTexture?(_.push("boneTexture"),_.push("boneTextureWidth"),_.push("boneTextureHeight")):_.push("boneGlobalMatrices");for(M in o)_.push(M);for(se(p,_),_=["position","normal","uv","uv2","tangent","color","skinIndex","skinWeight","lineDistance"],T=0;T<s.maxMorphTargets;T++)_.push("morphTarget"+T);for(T=0;T<s.maxMorphNormals;T++)_.push("morphNormal"+T);for(S in n)_.push(S);return le(p,_),p.id=je++,Ge.push({program:p,code:d,usedTimes:1}),ke.info.memory.programs=Ge.length,p}function se(e,t){var r,i,o;for(r=0,i=t.length;i>r;r++)o=t[r],e.uniforms[o]=ze.getUniformLocation(e,o)}function le(e,t){var r,i,o;for(r=0,i=t.length;i>r;r++)o=t[r],e.attributes[o]=ze.getAttribLocation(e,o)}function ce(e){for(var t=e.split("\n"),r=0,i=t.length;i>r;r++)t[r]=r+1+": "+t[r];return t.join("\n")}function he(e,t){var r;return"fragment"===e?r=ze.createShader(ze.FRAGMENT_SHADER):"vertex"===e&&(r=ze.createShader(ze.VERTEX_SHADER)),ze.shaderSource(r,t),ze.compileShader(r),ze.getShaderParameter(r,ze.COMPILE_STATUS)?r:(console.error(ze.getShaderInfoLog(r)),console.error(ce(t)),null)}function ue(e){return 0===(e&e-1)}function pe(t,r,i){i?(ze.texParameteri(t,ze.TEXTURE_WRAP_S,we(r.wrapS)),ze.texParameteri(t,ze.TEXTURE_WRAP_T,we(r.wrapT)),ze.texParameteri(t,ze.TEXTURE_MAG_FILTER,we(r.magFilter)),ze.texParameteri(t,ze.TEXTURE_MIN_FILTER,we(r.minFilter))):(ze.texParameteri(t,ze.TEXTURE_WRAP_S,ze.CLAMP_TO_EDGE),ze.texParameteri(t,ze.TEXTURE_WRAP_T,ze.CLAMP_TO_EDGE),ze.texParameteri(t,ze.TEXTURE_MAG_FILTER,xe(r.magFilter)),ze.texParameteri(t,ze.TEXTURE_MIN_FILTER,xe(r.minFilter))),Be&&r.type!==e.FloatType&&(r.anisotropy>1||r.__oldAnisotropy)&&(ze.texParameterf(t,Be.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r.anisotropy,Ct)),r.__oldAnisotropy=r.anisotropy)}function de(e,t){if(e.width<=t&&e.height<=t)return e;var r=Math.max(e.width,e.height),i=Math.floor(e.width*t/r),o=Math.floor(e.height*t/r),n=document.createElement("canvas");n.width=i,n.height=o;var a=n.getContext("2d");return a.drawImage(e,0,0,e.width,e.height,0,0,i,o),n}function fe(t,r){if(6===t.image.length)if(t.needsUpdate){t.image.__webglTextureCube||(t.addEventListener("dispose",It),t.image.__webglTextureCube=ze.createTexture(),ke.info.memory.textures++),ze.activeTexture(ze.TEXTURE0+r),ze.bindTexture(ze.TEXTURE_CUBE_MAP,t.image.__webglTextureCube),ze.pixelStorei(ze.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var i=t instanceof e.CompressedTexture,o=[],n=0;6>n;n++)ke.autoScaleCubemaps&&!i?o[n]=de(t.image[n],Tt):o[n]=t.image[n];var a=o[0],s=ue(a.width)&&ue(a.height),l=we(t.format),c=we(t.type);pe(ze.TEXTURE_CUBE_MAP,t,s);for(var n=0;6>n;n++)if(i)for(var h,u=o[n].mipmaps,p=0,d=u.length;d>p;p++)h=u[p],t.format!==e.RGBAFormat?ze.compressedTexImage2D(ze.TEXTURE_CUBE_MAP_POSITIVE_X+n,p,l,h.width,h.height,0,h.data):ze.texImage2D(ze.TEXTURE_CUBE_MAP_POSITIVE_X+n,p,l,h.width,h.height,0,l,c,h.data);else ze.texImage2D(ze.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,l,l,c,o[n]);t.generateMipmaps&&s&&ze.generateMipmap(ze.TEXTURE_CUBE_MAP),t.needsUpdate=!1,t.onUpdate&&t.onUpdate()}else ze.activeTexture(ze.TEXTURE0+r),ze.bindTexture(ze.TEXTURE_CUBE_MAP,t.image.__webglTextureCube)}function me(e,t){ze.activeTexture(ze.TEXTURE0+t),ze.bindTexture(ze.TEXTURE_CUBE_MAP,e.__webglTexture)}function ve(e,t,r){ze.bindFramebuffer(ze.FRAMEBUFFER,e),ze.framebufferTexture2D(ze.FRAMEBUFFER,ze.COLOR_ATTACHMENT0,r,t.__webglTexture,0)}function ge(e,t){ze.bindRenderbuffer(ze.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(ze.renderbufferStorage(ze.RENDERBUFFER,ze.DEPTH_COMPONENT16,t.width,t.height),ze.framebufferRenderbuffer(ze.FRAMEBUFFER,ze.DEPTH_ATTACHMENT,ze.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(ze.renderbufferStorage(ze.RENDERBUFFER,ze.DEPTH_STENCIL,t.width,t.height),ze.framebufferRenderbuffer(ze.FRAMEBUFFER,ze.DEPTH_STENCIL_ATTACHMENT,ze.RENDERBUFFER,e)):ze.renderbufferStorage(ze.RENDERBUFFER,ze.RGBA4,t.width,t.height)}function ye(t){t instanceof e.WebGLRenderTargetCube?(ze.bindTexture(ze.TEXTURE_CUBE_MAP,t.__webglTexture),ze.generateMipmap(ze.TEXTURE_CUBE_MAP),ze.bindTexture(ze.TEXTURE_CUBE_MAP,null)):(ze.bindTexture(ze.TEXTURE_2D,t.__webglTexture),ze.generateMipmap(ze.TEXTURE_2D),ze.bindTexture(ze.TEXTURE_2D,null))}function xe(t){return t===e.NearestFilter||t===e.NearestMipMapNearestFilter||t===e.NearestMipMapLinearFilter?ze.NEAREST:ze.LINEAR}function we(t){if(t===e.RepeatWrapping)return ze.REPEAT;if(t===e.ClampToEdgeWrapping)return ze.CLAMP_TO_EDGE;if(t===e.MirroredRepeatWrapping)return ze.MIRRORED_REPEAT;if(t===e.NearestFilter)return ze.NEAREST;if(t===e.NearestMipMapNearestFilter)return ze.NEAREST_MIPMAP_NEAREST;if(t===e.NearestMipMapLinearFilter)return ze.NEAREST_MIPMAP_LINEAR;if(t===e.LinearFilter)return ze.LINEAR;if(t===e.LinearMipMapNearestFilter)return ze.LINEAR_MIPMAP_NEAREST;if(t===e.LinearMipMapLinearFilter)return ze.LINEAR_MIPMAP_LINEAR;if(t===e.UnsignedByteType)return ze.UNSIGNED_BYTE;if(t===e.UnsignedShort4444Type)return ze.UNSIGNED_SHORT_4_4_4_4;if(t===e.UnsignedShort5551Type)return ze.UNSIGNED_SHORT_5_5_5_1;if(t===e.UnsignedShort565Type)return ze.UNSIGNED_SHORT_5_6_5;if(t===e.ByteType)return ze.BYTE;if(t===e.ShortType)return ze.SHORT;if(t===e.UnsignedShortType)return ze.UNSIGNED_SHORT;if(t===e.IntType)return ze.INT;if(t===e.UnsignedIntType)return ze.UNSIGNED_INT;if(t===e.FloatType)return ze.FLOAT;if(t===e.AlphaFormat)return ze.ALPHA;if(t===e.RGBFormat)return ze.RGB;if(t===e.RGBAFormat)return ze.RGBA;if(t===e.LuminanceFormat)return ze.LUMINANCE;if(t===e.LuminanceAlphaFormat)return ze.LUMINANCE_ALPHA;if(t===e.AddEquation)return ze.FUNC_ADD;if(t===e.SubtractEquation)return ze.FUNC_SUBTRACT;if(t===e.ReverseSubtractEquation)return ze.FUNC_REVERSE_SUBTRACT;if(t===e.ZeroFactor)return ze.ZERO;if(t===e.OneFactor)return ze.ONE;if(t===e.SrcColorFactor)return ze.SRC_COLOR;if(t===e.OneMinusSrcColorFactor)return ze.ONE_MINUS_SRC_COLOR;if(t===e.SrcAlphaFactor)return ze.SRC_ALPHA;if(t===e.OneMinusSrcAlphaFactor)return ze.ONE_MINUS_SRC_ALPHA;if(t===e.DstAlphaFactor)return ze.DST_ALPHA;if(t===e.OneMinusDstAlphaFactor)return ze.ONE_MINUS_DST_ALPHA;if(t===e.DstColorFactor)return ze.DST_COLOR;if(t===e.OneMinusDstColorFactor)return ze.ONE_MINUS_DST_COLOR;if(t===e.SrcAlphaSaturateFactor)return ze.SRC_ALPHA_SATURATE;if(void 0!==Ne){if(t===e.RGB_S3TC_DXT1_Format)return Ne.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT1_Format)return Ne.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT3_Format)return Ne.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===e.RGBA_S3TC_DXT5_Format)return Ne.COMPRESSED_RGBA_S3TC_DXT5_EXT}return 0}function be(t){if(At&&t&&t.useVertexTexture)return 1024;var r=ze.getParameter(ze.MAX_VERTEX_UNIFORM_VECTORS),i=Math.floor((r-20)/4),o=i;return void 0!==t&&t instanceof e.SkinnedMesh&&(o=Math.min(t.bones.length,o),o<t.bones.length&&console.warn("WebGLRenderer: too many bones - "+t.bones.length+", this GPU supports just "+o+" (try OpenGL instead of ANGLE)")),o}function _e(t){for(var r=0,i=0,o=0,n=0,a=0,s=t.length;s>a;a++){var l=t[a];l.onlyShadow||(l instanceof e.DirectionalLight&&r++,l instanceof e.PointLight&&i++,l instanceof e.SpotLight&&o++,l instanceof e.HemisphereLight&&n++)}return{directional:r,point:i,spot:o,hemi:n}}function Me(t){for(var r=0,i=0,o=t.length;o>i;i++){var n=t[i];n.castShadow&&(n instanceof e.SpotLight&&r++,n instanceof e.DirectionalLight&&!n.shadowCascade&&r++)}return r}function Se(){try{var e={alpha:Ae,premultipliedAlpha:Pe,antialias:De,stencil:Fe,preserveDrawingBuffer:Ee};if(ze=Ce.getContext("webgl",e)||Ce.getContext("experimental-webgl",e),null===ze)throw"Error creating WebGL context."}catch(t){console.error(t)}Ie=ze.getExtension("OES_texture_float"),Ue=ze.getExtension("OES_texture_float_linear"),Oe=ze.getExtension("OES_standard_derivatives"),Be=ze.getExtension("EXT_texture_filter_anisotropic")||ze.getExtension("MOZ_EXT_texture_filter_anisotropic")||ze.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),Ne=ze.getExtension("WEBGL_compressed_texture_s3tc")||ze.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||ze.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),Ie||console.log("THREE.WebGLRenderer: Float textures not supported."),Oe||console.log("THREE.WebGLRenderer: Standard derivatives not supported."),Be||console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),Ne||console.log("THREE.WebGLRenderer: S3TC compressed textures not supported."),void 0===ze.getShaderPrecisionFormat&&(ze.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}function Te(){ze.clearColor(0,0,0,1),ze.clearDepth(1),ze.clearStencil(0),ze.enable(ze.DEPTH_TEST),ze.depthFunc(ze.LEQUAL),ze.frontFace(ze.CCW),ze.cullFace(ze.BACK),ze.enable(ze.CULL_FACE),ze.enable(ze.BLEND),ze.blendEquation(ze.FUNC_ADD),ze.blendFunc(ze.SRC_ALPHA,ze.ONE_MINUS_SRC_ALPHA),ze.viewport(ct,ht,ut,pt),ze.clearColor(Ve.r,Ve.g,Ve.b,Re)}console.log("THREE.WebGLRenderer",e.REVISION),t=t||{};var Ce=void 0!==t.canvas?t.canvas:document.createElement("canvas"),Le=void 0!==t.precision?t.precision:"highp",Ae=void 0!==t.alpha?t.alpha:!1,Pe=void 0!==t.premultipliedAlpha?t.premultipliedAlpha:!0,De=void 0!==t.antialias?t.antialias:!1,Fe=void 0!==t.stencil?t.stencil:!0,Ee=void 0!==t.preserveDrawingBuffer?t.preserveDrawingBuffer:!1,Ve=new e.Color(0),Re=0;this.domElement=Ce,this.context=null,this.devicePixelRatio=void 0!==t.devicePixelRatio?t.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.autoUpdateObjects=!0,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyBasedShading=!1,this.shadowMapEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=e.PCFShadowMap,this.shadowMapCullFace=e.CullFaceFront,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var ze,Ie,Ue,Oe,Be,Ne,ke=this,Ge=[],je=0,We=null,He=null,Xe=-1,qe=null,Ye=null,Ze=0,Ke=0,Qe=-1,Je=-1,$e=-1,et=-1,tt=-1,rt=-1,it=-1,ot=-1,nt=null,at=null,st=null,lt=null,ct=0,ht=0,ut=Ce.width,pt=Ce.height,dt=0,ft=0,mt={},vt=new e.Frustum,gt=new e.Matrix4,yt=new e.Matrix4,xt=new e.Vector3,wt=new e.Vector3,bt=!0,_t={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,anglesCos:new Array,exponents:new Array},hemi:{length:0,skyColors:new Array,groundColors:new Array,positions:new Array}};Se(),Te(),this.context=ze;var Mt=ze.getParameter(ze.MAX_TEXTURE_IMAGE_UNITS),St=ze.getParameter(ze.MAX_VERTEX_TEXTURE_IMAGE_UNITS),Tt=(ze.getParameter(ze.MAX_TEXTURE_SIZE),ze.getParameter(ze.MAX_CUBE_MAP_TEXTURE_SIZE)),Ct=Be?ze.getParameter(Be.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Lt=St>0,At=Lt&&Ie,Pt=(Ne?ze.getParameter(ze.COMPRESSED_TEXTURE_FORMATS):[],ze.getShaderPrecisionFormat(ze.VERTEX_SHADER,ze.HIGH_FLOAT)),Dt=ze.getShaderPrecisionFormat(ze.VERTEX_SHADER,ze.MEDIUM_FLOAT),Ft=(ze.getShaderPrecisionFormat(ze.VERTEX_SHADER,ze.LOW_FLOAT),ze.getShaderPrecisionFormat(ze.FRAGMENT_SHADER,ze.HIGH_FLOAT)),Et=ze.getShaderPrecisionFormat(ze.FRAGMENT_SHADER,ze.MEDIUM_FLOAT),Vt=(ze.getShaderPrecisionFormat(ze.FRAGMENT_SHADER,ze.LOW_FLOAT),ze.getShaderPrecisionFormat(ze.VERTEX_SHADER,ze.HIGH_INT),ze.getShaderPrecisionFormat(ze.VERTEX_SHADER,ze.MEDIUM_INT),ze.getShaderPrecisionFormat(ze.VERTEX_SHADER,ze.LOW_INT),ze.getShaderPrecisionFormat(ze.FRAGMENT_SHADER,ze.HIGH_INT),ze.getShaderPrecisionFormat(ze.FRAGMENT_SHADER,ze.MEDIUM_INT),ze.getShaderPrecisionFormat(ze.FRAGMENT_SHADER,ze.LOW_INT),Pt.precision>0&&Ft.precision>0),Rt=Dt.precision>0&&Et.precision>0;"highp"!==Le||Vt||(Rt?(Le="mediump",console.warn("WebGLRenderer: highp not supported, using mediump")):(Le="lowp",console.warn("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==Le||Rt||(Le="lowp",console.warn("WebGLRenderer: mediump not supported, using lowp")),this.getContext=function(){return ze},this.supportsVertexTextures=function(){return Lt},this.supportsFloatTextures=function(){return Ie},this.supportsStandardDerivatives=function(){return Oe},this.supportsCompressedTextureS3TC=function(){return Ne},this.getMaxAnisotropy=function(){return Ct},this.getPrecision=function(){return Le},this.setSize=function(e,t,r){Ce.width=e*this.devicePixelRatio,Ce.height=t*this.devicePixelRatio,1!==this.devicePixelRatio&&r!==!1&&(Ce.style.width=e+"px",Ce.style.height=t+"px"),this.setViewport(0,0,Ce.width,Ce.height)},this.setViewport=function(e,t,r,i){ct=void 0!==e?e:0,ht=void 0!==t?t:0,ut=void 0!==r?r:Ce.width,pt=void 0!==i?i:Ce.height,ze.viewport(ct,ht,ut,pt)},this.setScissor=function(e,t,r,i){ze.scissor(e,t,r,i)},this.enableScissorTest=function(e){e?ze.enable(ze.SCISSOR_TEST):ze.disable(ze.SCISSOR_TEST)},this.setClearColor=function(e,t){Ve.set(e),Re=void 0!==t?t:1,ze.clearColor(Ve.r,Ve.g,Ve.b,Re)},this.setClearColorHex=function(e,t){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return Ve},this.getClearAlpha=function(){return Re},this.clear=function(e,t,r){var i=0;(void 0===e||e)&&(i|=ze.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=ze.DEPTH_BUFFER_BIT),(void 0===r||r)&&(i|=ze.STENCIL_BUFFER_BIT),ze.clear(i)},this.clearTarget=function(e,t,r,i){this.setRenderTarget(e),this.clear(t,r,i)},this.addPostPlugin=function(e){e.init(this),this.renderPluginsPost.push(e)},this.addPrePlugin=function(e){e.init(this),this.renderPluginsPre.push(e)},this.updateShadowMap=function(e,t){We=null,$e=-1,it=-1,ot=-1,qe=-1,Xe=-1,bt=!0,Qe=-1,Je=-1,this.shadowMapPlugin.update(e,t)};var zt=function(e){var t=e.target;t.removeEventListener("dispose",zt),Nt(t)},It=function(e){var t=e.target;t.removeEventListener("dispose",It),kt(t),ke.info.memory.textures--},Ut=function(e){var t=e.target;t.removeEventListener("dispose",Ut),Gt(t),ke.info.memory.textures--},Ot=function(e){var t=e.target;t.removeEventListener("dispose",Ot),jt(t)},Bt=function(e){if(void 0!==e.__webglVertexBuffer&&ze.deleteBuffer(e.__webglVertexBuffer),void 0!==e.__webglNormalBuffer&&ze.deleteBuffer(e.__webglNormalBuffer),void 0!==e.__webglTangentBuffer&&ze.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglColorBuffer&&ze.deleteBuffer(e.__webglColorBuffer),void 0!==e.__webglUVBuffer&&ze.deleteBuffer(e.__webglUVBuffer),void 0!==e.__webglUV2Buffer&&ze.deleteBuffer(e.__webglUV2Buffer),void 0!==e.__webglSkinIndicesBuffer&&ze.deleteBuffer(e.__webglSkinIndicesBuffer),void 0!==e.__webglSkinWeightsBuffer&&ze.deleteBuffer(e.__webglSkinWeightsBuffer),void 0!==e.__webglFaceBuffer&&ze.deleteBuffer(e.__webglFaceBuffer),void 0!==e.__webglLineBuffer&&ze.deleteBuffer(e.__webglLineBuffer),void 0!==e.__webglLineDistanceBuffer&&ze.deleteBuffer(e.__webglLineDistanceBuffer),void 0!==e.__webglCustomAttributesList)for(var t in e.__webglCustomAttributesList)ze.deleteBuffer(e.__webglCustomAttributesList[t].buffer);ke.info.memory.geometries--},Nt=function(t){if(t.__webglInit=void 0,t instanceof e.BufferGeometry){var r=t.attributes;for(var i in r)void 0!==r[i].buffer&&ze.deleteBuffer(r[i].buffer);ke.info.memory.geometries--}else if(void 0!==t.geometryGroups)for(var o in t.geometryGroups){var n=t.geometryGroups[o];if(void 0!==n.numMorphTargets)for(var a=0,s=n.numMorphTargets;s>a;a++)ze.deleteBuffer(n.__webglMorphTargetsBuffers[a]);if(void 0!==n.numMorphNormals)for(var a=0,s=n.numMorphNormals;s>a;a++)ze.deleteBuffer(n.__webglMorphNormalsBuffers[a]);Bt(n)}else Bt(t)},kt=function(e){if(e.image&&e.image.__webglTextureCube)ze.deleteTexture(e.image.__webglTextureCube);else{if(!e.__webglInit)return;e.__webglInit=!1,ze.deleteTexture(e.__webglTexture)}},Gt=function(t){if(t&&t.__webglTexture)if(ze.deleteTexture(t.__webglTexture),t instanceof e.WebGLRenderTargetCube)for(var r=0;6>r;r++)ze.deleteFramebuffer(t.__webglFramebuffer[r]),ze.deleteRenderbuffer(t.__webglRenderbuffer[r]);else ze.deleteFramebuffer(t.__webglFramebuffer),ze.deleteRenderbuffer(t.__webglRenderbuffer)},jt=function(e){var t=e.program;if(void 0!==t){e.program=void 0;var r,i,o,n=!1;for(r=0,i=Ge.length;i>r;r++)if(o=Ge[r],o.program===t){o.usedTimes--,0===o.usedTimes&&(n=!0);break}if(n===!0){var a=[];for(r=0,i=Ge.length;i>r;r++)o=Ge[r],o.program!==t&&a.push(o);Ge=a,ze.deleteProgram(t),ke.info.memory.programs--}}};this.renderBufferImmediate=function(t,r,i){if(t.hasPositions&&!t.__webglVertexBuffer&&(t.__webglVertexBuffer=ze.createBuffer()),t.hasNormals&&!t.__webglNormalBuffer&&(t.__webglNormalBuffer=ze.createBuffer()),t.hasUvs&&!t.__webglUvBuffer&&(t.__webglUvBuffer=ze.createBuffer()),t.hasColors&&!t.__webglColorBuffer&&(t.__webglColorBuffer=ze.createBuffer()),t.hasPositions&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglVertexBuffer),ze.bufferData(ze.ARRAY_BUFFER,t.positionArray,ze.DYNAMIC_DRAW),ze.enableVertexAttribArray(r.attributes.position),ze.vertexAttribPointer(r.attributes.position,3,ze.FLOAT,!1,0,0)),t.hasNormals){if(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglNormalBuffer),i.shading===e.FlatShading){var o,n,a,s,l,c,h,u,p,d,f,m,v,g,y=3*t.count;for(g=0;y>g;g+=9)v=t.normalArray,s=v[g],h=v[g+1],d=v[g+2],l=v[g+3],u=v[g+4],f=v[g+5],c=v[g+6],p=v[g+7],m=v[g+8],o=(s+l+c)/3,n=(h+u+p)/3,a=(d+f+m)/3,v[g]=o,v[g+1]=n,v[g+2]=a,v[g+3]=o,v[g+4]=n,v[g+5]=a,v[g+6]=o,v[g+7]=n,v[g+8]=a}ze.bufferData(ze.ARRAY_BUFFER,t.normalArray,ze.DYNAMIC_DRAW),ze.enableVertexAttribArray(r.attributes.normal),ze.vertexAttribPointer(r.attributes.normal,3,ze.FLOAT,!1,0,0)}t.hasUvs&&i.map&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglUvBuffer),ze.bufferData(ze.ARRAY_BUFFER,t.uvArray,ze.DYNAMIC_DRAW),ze.enableVertexAttribArray(r.attributes.uv),ze.vertexAttribPointer(r.attributes.uv,2,ze.FLOAT,!1,0,0)),t.hasColors&&i.vertexColors!==e.NoColors&&(ze.bindBuffer(ze.ARRAY_BUFFER,t.__webglColorBuffer),ze.bufferData(ze.ARRAY_BUFFER,t.colorArray,ze.DYNAMIC_DRAW),ze.enableVertexAttribArray(r.attributes.color),ze.vertexAttribPointer(r.attributes.color,3,ze.FLOAT,!1,0,0)),ze.drawArrays(ze.TRIANGLES,0,t.count),t.count=0},this.renderBufferDirect=function(t,r,i,o,n,a){if(o.visible!==!1){var s,l,c,h,u=N(t,r,i,o,a),p=u.attributes,d=n.attributes,f=!1,m=o.wireframe?1:0,v=16777215*n.id+2*u.id+m;if(v!==qe&&(qe=v,f=!0),f&&w(),a instanceof e.Mesh){var g=d.index;if(g){var y=n.offsets;y.length>1&&(f=!0);for(var b=0,_=y.length;_>b;b++){var M=y[b].index;if(f){for(l in p)c=p[l],s=d[l],c>=0&&(s?(h=s.itemSize,ze.bindBuffer(ze.ARRAY_BUFFER,s.buffer),x(c),ze.vertexAttribPointer(c,h,ze.FLOAT,!1,0,M*h*4)):o.defaultAttributeValues&&(2===o.defaultAttributeValues[l].length?ze.vertexAttrib2fv(c,o.defaultAttributeValues[l]):3===o.defaultAttributeValues[l].length&&ze.vertexAttrib3fv(c,o.defaultAttributeValues[l])));ze.bindBuffer(ze.ELEMENT_ARRAY_BUFFER,g.buffer)}ze.drawElements(ze.TRIANGLES,y[b].count,ze.UNSIGNED_SHORT,2*y[b].start),ke.info.render.calls++,ke.info.render.vertices+=y[b].count,ke.info.render.faces+=y[b].count/3}}else{if(f)for(l in p)"index"!==l&&(c=p[l],s=d[l],c>=0&&(s?(h=s.itemSize,ze.bindBuffer(ze.ARRAY_BUFFER,s.buffer),x(c),ze.vertexAttribPointer(c,h,ze.FLOAT,!1,0,0)):o.defaultAttributeValues&&o.defaultAttributeValues[l]&&(2===o.defaultAttributeValues[l].length?ze.vertexAttrib2fv(c,o.defaultAttributeValues[l]):3===o.defaultAttributeValues[l].length&&ze.vertexAttrib3fv(c,o.defaultAttributeValues[l]))));var S=n.attributes.position;ze.drawArrays(ze.TRIANGLES,0,S.numItems/3),ke.info.render.calls++,ke.info.render.vertices+=S.numItems/3,ke.info.render.faces+=S.numItems/3/3}}else if(a instanceof e.ParticleSystem){if(f){for(l in p)c=p[l],s=d[l],c>=0&&(s?(h=s.itemSize,ze.bindBuffer(ze.ARRAY_BUFFER,s.buffer),x(c),ze.vertexAttribPointer(c,h,ze.FLOAT,!1,0,0)):o.defaultAttributeValues&&o.defaultAttributeValues[l]&&(2===o.defaultAttributeValues[l].length?ze.vertexAttrib2fv(c,o.defaultAttributeValues[l]):3===o.defaultAttributeValues[l].length&&ze.vertexAttrib3fv(c,o.defaultAttributeValues[l])));var S=d.position;ze.drawArrays(ze.POINTS,0,S.numItems/3),ke.info.render.calls++,ke.info.render.points+=S.numItems/3}}else if(a instanceof e.Line&&f){for(l in p)c=p[l],s=d[l],c>=0&&(s?(h=s.itemSize,ze.bindBuffer(ze.ARRAY_BUFFER,s.buffer),x(c),ze.vertexAttribPointer(c,h,ze.FLOAT,!1,0,0)):o.defaultAttributeValues&&o.defaultAttributeValues[l]&&(2===o.defaultAttributeValues[l].length?ze.vertexAttrib2fv(c,o.defaultAttributeValues[l]):3===o.defaultAttributeValues[l].length&&ze.vertexAttrib3fv(c,o.defaultAttributeValues[l])));var T=a.type===e.LineStrip?ze.LINE_STRIP:ze.LINES;ie(o.linewidth);var S=d.position;ze.drawArrays(T,0,S.numItems/3),ke.info.render.calls++,ke.info.render.points+=S.numItems}}},this.renderBuffer=function(t,r,i,o,n,a){if(o.visible!==!1){var s,l,c,h=N(t,r,i,o,a),u=h.attributes,p=!1,d=o.wireframe?1:0,f=16777215*n.id+2*h.id+d;if(f!==qe&&(qe=f,p=!0),p&&w(),!o.morphTargets&&u.position>=0?p&&(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglVertexBuffer),x(u.position),ze.vertexAttribPointer(u.position,3,ze.FLOAT,!1,0,0)):a.morphTargetBase&&b(o,n,a),p){if(n.__webglCustomAttributesList)for(l=0,c=n.__webglCustomAttributesList.length;c>l;l++)s=n.__webglCustomAttributesList[l],u[s.buffer.belongsToAttribute]>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,s.buffer),x(u[s.buffer.belongsToAttribute]),ze.vertexAttribPointer(u[s.buffer.belongsToAttribute],s.size,ze.FLOAT,!1,0,0));u.color>=0&&(a.geometry.colors.length>0||a.geometry.faces.length>0?(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglColorBuffer),x(u.color),ze.vertexAttribPointer(u.color,3,ze.FLOAT,!1,0,0)):o.defaultAttributeValues&&ze.vertexAttrib3fv(u.color,o.defaultAttributeValues.color)),u.normal>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglNormalBuffer),x(u.normal),ze.vertexAttribPointer(u.normal,3,ze.FLOAT,!1,0,0)),u.tangent>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglTangentBuffer),x(u.tangent),ze.vertexAttribPointer(u.tangent,4,ze.FLOAT,!1,0,0)),u.uv>=0&&(a.geometry.faceVertexUvs[0]?(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglUVBuffer),x(u.uv),ze.vertexAttribPointer(u.uv,2,ze.FLOAT,!1,0,0)):o.defaultAttributeValues&&ze.vertexAttrib2fv(u.uv,o.defaultAttributeValues.uv)),u.uv2>=0&&(a.geometry.faceVertexUvs[1]?(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglUV2Buffer),x(u.uv2),ze.vertexAttribPointer(u.uv2,2,ze.FLOAT,!1,0,0)):o.defaultAttributeValues&&ze.vertexAttrib2fv(u.uv2,o.defaultAttributeValues.uv2)),o.skinning&&u.skinIndex>=0&&u.skinWeight>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglSkinIndicesBuffer),x(u.skinIndex),ze.vertexAttribPointer(u.skinIndex,4,ze.FLOAT,!1,0,0),ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglSkinWeightsBuffer),x(u.skinWeight),ze.vertexAttribPointer(u.skinWeight,4,ze.FLOAT,!1,0,0)),u.lineDistance>=0&&(ze.bindBuffer(ze.ARRAY_BUFFER,n.__webglLineDistanceBuffer),x(u.lineDistance),ze.vertexAttribPointer(u.lineDistance,1,ze.FLOAT,!1,0,0))}if(a instanceof e.Mesh)o.wireframe?(ie(o.wireframeLinewidth),p&&ze.bindBuffer(ze.ELEMENT_ARRAY_BUFFER,n.__webglLineBuffer),ze.drawElements(ze.LINES,n.__webglLineCount,ze.UNSIGNED_SHORT,0)):(p&&ze.bindBuffer(ze.ELEMENT_ARRAY_BUFFER,n.__webglFaceBuffer),ze.drawElements(ze.TRIANGLES,n.__webglFaceCount,ze.UNSIGNED_SHORT,0)),ke.info.render.calls++,ke.info.render.vertices+=n.__webglFaceCount,ke.info.render.faces+=n.__webglFaceCount/3;else if(a instanceof e.Line){var m=a.type===e.LineStrip?ze.LINE_STRIP:ze.LINES;ie(o.linewidth),ze.drawArrays(m,0,n.__webglLineCount),ke.info.render.calls++}else a instanceof e.ParticleSystem&&(ze.drawArrays(ze.POINTS,0,n.__webglParticleCount),ke.info.render.calls++,ke.info.render.points+=n.__webglParticleCount)}},this.render=function(t,r,i,o){if(r instanceof e.Camera==!1)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");var n,a,s,l,c,h=t.__lights,u=t.fog;for(Xe=-1,bt=!0,t.autoUpdate===!0&&t.updateMatrixWorld(),void 0===r.parent&&r.updateMatrixWorld(),r.matrixWorldInverse.getInverse(r.matrixWorld),gt.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),vt.setFromMatrix(gt),this.autoUpdateObjects&&this.initWebGLObjects(t),S(this.renderPluginsPre,t,r),ke.info.render.calls=0,ke.info.render.vertices=0,ke.info.render.faces=0,ke.info.render.points=0,this.setRenderTarget(i),(this.autoClear||o)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),c=t.__webglObjects,n=0,a=c.length;a>n;n++)s=c[n],l=s.object,s.id=n,s.render=!1,l.visible&&((l instanceof e.Mesh||l instanceof e.ParticleSystem)&&l.frustumCulled&&!vt.intersectsObject(l)||($(l,r),A(s),s.render=!0,this.sortObjects===!0&&(null!==l.renderDepth?s.z=l.renderDepth:(xt.getPositionFromMatrix(l.matrixWorld),xt.applyProjection(gt),s.z=xt.z))));for(this.sortObjects&&c.sort(_),c=t.__webglObjectsImmediate,n=0,a=c.length;a>n;n++)s=c[n],l=s.object,l.visible&&($(l,r),L(s));if(t.overrideMaterial){var p=t.overrideMaterial;this.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst),this.setDepthTest(p.depthTest),this.setDepthWrite(p.depthWrite),oe(p.polygonOffset,p.polygonOffsetFactor,p.polygonOffsetUnits),
T(t.__webglObjects,!1,"",r,h,u,!0,p),C(t.__webglObjectsImmediate,"",r,h,u,!1,p)}else{var p=null;this.setBlending(e.NoBlending),T(t.__webglObjects,!0,"opaque",r,h,u,!1,p),C(t.__webglObjectsImmediate,"opaque",r,h,u,!1,p),T(t.__webglObjects,!1,"transparent",r,h,u,!0,p),C(t.__webglObjectsImmediate,"transparent",r,h,u,!0,p)}S(this.renderPluginsPost,t,r),i&&i.generateMipmaps&&i.minFilter!==e.NearestFilter&&i.minFilter!==e.LinearFilter&&ye(i),this.setDepthTest(!0),this.setDepthWrite(!0)},this.renderImmediateObject=function(e,t,r,i,o){var n=N(e,t,r,i,o);qe=-1,ke.setMaterialFaces(i),o.immediateRenderCallback?o.immediateRenderCallback(n,ze,vt):o.render(function(e){ke.renderBufferImmediate(e,n,i)})},this.initWebGLObjects=function(e){for(e.__webglObjects||(e.__webglObjects=[],e.__webglObjectsImmediate=[],e.__webglSprites=[],e.__webglFlares=[]);e.__objectsAdded.length;)D(e.__objectsAdded[0],e),e.__objectsAdded.splice(0,1);for(;e.__objectsRemoved.length;)I(e.__objectsRemoved[0],e),e.__objectsRemoved.splice(0,1);for(var t=0,r=e.__webglObjects.length;r>t;t++){var i=e.__webglObjects[t].object;void 0===i.__webglInit&&(void 0!==i.__webglActive&&I(i,e),D(i,e)),V(i)}},this.initMaterial=function(t,r,i,o){t.addEventListener("dispose",Ot);var n,a,s,l,c,h,u;t instanceof e.MeshDepthMaterial?u="depth":t instanceof e.MeshNormalMaterial?u="normal":t instanceof e.MeshBasicMaterial?u="basic":t instanceof e.MeshLambertMaterial?u="lambert":t instanceof e.MeshPhongMaterial?u="phong":t instanceof e.LineBasicMaterial?u="basic":t instanceof e.LineDashedMaterial?u="dashed":t instanceof e.ParticleSystemMaterial&&(u="particle_basic"),u&&B(t,e.ShaderLib[u]),l=_e(r),h=Me(r),c=be(o),s={map:!!t.map,envMap:!!t.envMap,lightMap:!!t.lightMap,bumpMap:!!t.bumpMap,normalMap:!!t.normalMap,specularMap:!!t.specularMap,vertexColors:t.vertexColors,fog:i,useFog:t.fog,fogExp:i instanceof e.FogExp2,sizeAttenuation:t.sizeAttenuation,skinning:t.skinning,maxBones:c,useVertexTexture:At&&o&&o.useVertexTexture,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:l.directional,maxPointLights:l.point,maxSpotLights:l.spot,maxHemiLights:l.hemi,maxShadows:h,shadowMapEnabled:this.shadowMapEnabled&&o.receiveShadow,shadowMapType:this.shadowMapType,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:t.alphaTest,metal:t.metal,perPixel:t.perPixel,wrapAround:t.wrapAround,doubleSided:t.side===e.DoubleSide,flipSided:t.side===e.BackSide},t.program=ae(u,t.fragmentShader,t.vertexShader,t.uniforms,t.attributes,t.defines,s,t.index0AttributeName);var p=t.program.attributes;if(t.morphTargets){t.numSupportedMorphTargets=0;var d,f="morphTarget";for(a=0;a<this.maxMorphTargets;a++)d=f+a,p[d]>=0&&t.numSupportedMorphTargets++}if(t.morphNormals){t.numSupportedMorphNormals=0;var d,f="morphNormal";for(a=0;a<this.maxMorphNormals;a++)d=f+a,p[d]>=0&&t.numSupportedMorphNormals++}t.uniformsList=[];for(n in t.uniforms)t.uniformsList.push([t.uniforms[n],n])},this.setFaceCulling=function(t,r){t===e.CullFaceNone?ze.disable(ze.CULL_FACE):(r===e.FrontFaceDirectionCW?ze.frontFace(ze.CW):ze.frontFace(ze.CCW),t===e.CullFaceBack?ze.cullFace(ze.BACK):t===e.CullFaceFront?ze.cullFace(ze.FRONT):ze.cullFace(ze.FRONT_AND_BACK),ze.enable(ze.CULL_FACE))},this.setMaterialFaces=function(t){var r=t.side===e.DoubleSide,i=t.side===e.BackSide;Qe!==r&&(r?ze.disable(ze.CULL_FACE):ze.enable(ze.CULL_FACE),Qe=r),Je!==i&&(i?ze.frontFace(ze.CW):ze.frontFace(ze.CCW),Je=i)},this.setDepthTest=function(e){it!==e&&(e?ze.enable(ze.DEPTH_TEST):ze.disable(ze.DEPTH_TEST),it=e)},this.setDepthWrite=function(e){ot!==e&&(ze.depthMask(e),ot=e)},this.setBlending=function(t,r,i,o){t!==$e&&(t===e.NoBlending?ze.disable(ze.BLEND):t===e.AdditiveBlending?(ze.enable(ze.BLEND),ze.blendEquation(ze.FUNC_ADD),ze.blendFunc(ze.SRC_ALPHA,ze.ONE)):t===e.SubtractiveBlending?(ze.enable(ze.BLEND),ze.blendEquation(ze.FUNC_ADD),ze.blendFunc(ze.ZERO,ze.ONE_MINUS_SRC_COLOR)):t===e.MultiplyBlending?(ze.enable(ze.BLEND),ze.blendEquation(ze.FUNC_ADD),ze.blendFunc(ze.ZERO,ze.SRC_COLOR)):t===e.CustomBlending?ze.enable(ze.BLEND):(ze.enable(ze.BLEND),ze.blendEquationSeparate(ze.FUNC_ADD,ze.FUNC_ADD),ze.blendFuncSeparate(ze.SRC_ALPHA,ze.ONE_MINUS_SRC_ALPHA,ze.ONE,ze.ONE_MINUS_SRC_ALPHA)),$e=t),t===e.CustomBlending?(r!==et&&(ze.blendEquation(we(r)),et=r),(i!==tt||o!==rt)&&(ze.blendFunc(we(i),we(o)),tt=i,rt=o)):(et=null,tt=null,rt=null)},this.setTexture=function(t,r){if(t.needsUpdate){t.__webglInit||(t.__webglInit=!0,t.addEventListener("dispose",It),t.__webglTexture=ze.createTexture(),ke.info.memory.textures++),ze.activeTexture(ze.TEXTURE0+r),ze.bindTexture(ze.TEXTURE_2D,t.__webglTexture),ze.pixelStorei(ze.UNPACK_FLIP_Y_WEBGL,t.flipY),ze.pixelStorei(ze.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),ze.pixelStorei(ze.UNPACK_ALIGNMENT,t.unpackAlignment);var i=t.image,o=ue(i.width)&&ue(i.height),n=we(t.format),a=we(t.type);pe(ze.TEXTURE_2D,t,o);var s,l=t.mipmaps;if(t instanceof e.DataTexture)if(l.length>0&&o){for(var c=0,h=l.length;h>c;c++)s=l[c],ze.texImage2D(ze.TEXTURE_2D,c,n,s.width,s.height,0,n,a,s.data);t.generateMipmaps=!1}else ze.texImage2D(ze.TEXTURE_2D,0,n,i.width,i.height,0,n,a,i.data);else if(t instanceof e.CompressedTexture)for(var c=0,h=l.length;h>c;c++)s=l[c],t.format!==e.RGBAFormat?ze.compressedTexImage2D(ze.TEXTURE_2D,c,n,s.width,s.height,0,s.data):ze.texImage2D(ze.TEXTURE_2D,c,n,s.width,s.height,0,n,a,s.data);else if(l.length>0&&o){for(var c=0,h=l.length;h>c;c++)s=l[c],ze.texImage2D(ze.TEXTURE_2D,c,n,n,a,s);t.generateMipmaps=!1}else ze.texImage2D(ze.TEXTURE_2D,0,n,n,a,t.image);t.generateMipmaps&&o&&ze.generateMipmap(ze.TEXTURE_2D),t.needsUpdate=!1,t.onUpdate&&t.onUpdate()}else ze.activeTexture(ze.TEXTURE0+r),ze.bindTexture(ze.TEXTURE_2D,t.__webglTexture)},this.setRenderTarget=function(t){var r=t instanceof e.WebGLRenderTargetCube;if(t&&!t.__webglFramebuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.addEventListener("dispose",Ut),t.__webglTexture=ze.createTexture(),ke.info.memory.textures++;var i=ue(t.width)&&ue(t.height),o=we(t.format),n=we(t.type);if(r){t.__webglFramebuffer=[],t.__webglRenderbuffer=[],ze.bindTexture(ze.TEXTURE_CUBE_MAP,t.__webglTexture),pe(ze.TEXTURE_CUBE_MAP,t,i);for(var a=0;6>a;a++)t.__webglFramebuffer[a]=ze.createFramebuffer(),t.__webglRenderbuffer[a]=ze.createRenderbuffer(),ze.texImage2D(ze.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,o,t.width,t.height,0,o,n,null),ve(t.__webglFramebuffer[a],t,ze.TEXTURE_CUBE_MAP_POSITIVE_X+a),ge(t.__webglRenderbuffer[a],t);i&&ze.generateMipmap(ze.TEXTURE_CUBE_MAP)}else t.__webglFramebuffer=ze.createFramebuffer(),t.shareDepthFrom?t.__webglRenderbuffer=t.shareDepthFrom.__webglRenderbuffer:t.__webglRenderbuffer=ze.createRenderbuffer(),ze.bindTexture(ze.TEXTURE_2D,t.__webglTexture),pe(ze.TEXTURE_2D,t,i),ze.texImage2D(ze.TEXTURE_2D,0,o,t.width,t.height,0,o,n,null),ve(t.__webglFramebuffer,t,ze.TEXTURE_2D),t.shareDepthFrom?t.depthBuffer&&!t.stencilBuffer?ze.framebufferRenderbuffer(ze.FRAMEBUFFER,ze.DEPTH_ATTACHMENT,ze.RENDERBUFFER,t.__webglRenderbuffer):t.depthBuffer&&t.stencilBuffer&&ze.framebufferRenderbuffer(ze.FRAMEBUFFER,ze.DEPTH_STENCIL_ATTACHMENT,ze.RENDERBUFFER,t.__webglRenderbuffer):ge(t.__webglRenderbuffer,t),i&&ze.generateMipmap(ze.TEXTURE_2D);r?ze.bindTexture(ze.TEXTURE_CUBE_MAP,null):ze.bindTexture(ze.TEXTURE_2D,null),ze.bindRenderbuffer(ze.RENDERBUFFER,null),ze.bindFramebuffer(ze.FRAMEBUFFER,null)}var s,l,c,h,u;t?(s=r?t.__webglFramebuffer[t.activeCubeFace]:t.__webglFramebuffer,l=t.width,c=t.height,h=0,u=0):(s=null,l=ut,c=pt,h=ct,u=ht),s!==He&&(ze.bindFramebuffer(ze.FRAMEBUFFER,s),ze.viewport(h,u,l,c),He=s),dt=l,ft=c},this.shadowMapPlugin=new e.ShadowMapPlugin,this.addPrePlugin(this.shadowMapPlugin),this.addPostPlugin(new e.SpritePlugin),this.addPostPlugin(new e.LensFlarePlugin)},e.WebGLRenderTarget=function(t,r,i){this.width=t,this.height=r,i=i||{},this.wrapS=void 0!==i.wrapS?i.wrapS:e.ClampToEdgeWrapping,this.wrapT=void 0!==i.wrapT?i.wrapT:e.ClampToEdgeWrapping,this.magFilter=void 0!==i.magFilter?i.magFilter:e.LinearFilter,this.minFilter=void 0!==i.minFilter?i.minFilter:e.LinearMipMapLinearFilter,this.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,this.offset=new e.Vector2(0,0),this.repeat=new e.Vector2(1,1),this.format=void 0!==i.format?i.format:e.RGBAFormat,this.type=void 0!==i.type?i.type:e.UnsignedByteType,this.depthBuffer=void 0!==i.depthBuffer?i.depthBuffer:!0,this.stencilBuffer=void 0!==i.stencilBuffer?i.stencilBuffer:!0,this.generateMipmaps=!0,this.shareDepthFrom=null},e.WebGLRenderTarget.prototype={constructor:e.WebGLRenderTarget,clone:function(){var t=new e.WebGLRenderTarget(this.width,this.height);return t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.format=this.format,t.type=this.type,t.depthBuffer=this.depthBuffer,t.stencilBuffer=this.stencilBuffer,t.generateMipmaps=this.generateMipmaps,t.shareDepthFrom=this.shareDepthFrom,t},dispose:function(){this.dispatchEvent({type:"dispose"})}},e.EventDispatcher.prototype.apply(e.WebGLRenderTarget.prototype),e.WebGLRenderTargetCube=function(t,r,i){e.WebGLRenderTarget.call(this,t,r,i),this.activeCubeFace=0},e.WebGLRenderTargetCube.prototype=Object.create(e.WebGLRenderTarget.prototype),e.RenderableVertex=function(){this.positionWorld=new e.Vector3,this.positionScreen=new e.Vector4,this.visible=!0},e.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},e.RenderableFace3=function(){this.id=0,this.v1=new e.RenderableVertex,this.v2=new e.RenderableVertex,this.v3=new e.RenderableVertex,this.centroidModel=new e.Vector3,this.normalModel=new e.Vector3,this.normalModelView=new e.Vector3,this.vertexNormalsLength=0,this.vertexNormalsModel=[new e.Vector3,new e.Vector3,new e.Vector3],this.vertexNormalsModelView=[new e.Vector3,new e.Vector3,new e.Vector3],this.color=null,this.material=null,this.uvs=[[]],this.z=0},e.RenderableObject=function(){this.id=0,this.object=null,this.z=0},e.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new e.Vector2,this.material=null},e.RenderableLine=function(){this.id=0,this.v1=new e.RenderableVertex,this.v2=new e.RenderableVertex,this.vertexColors=[new e.Color,new e.Color],this.material=null,this.z=0},e.GeometryUtils={merge:function(t,r,i){var o,n,a=t.vertices.length,s=(t.faceVertexUvs[0].length,r instanceof e.Mesh?r.geometry:r),l=t.vertices,c=s.vertices,h=t.faces,u=s.faces,p=t.faceVertexUvs[0],d=s.faceVertexUvs[0];void 0===i&&(i=0),r instanceof e.Mesh&&(r.matrixAutoUpdate&&r.updateMatrix(),o=r.matrix,n=(new e.Matrix3).getNormalMatrix(o));for(var f=0,m=c.length;m>f;f++){var v=c[f],g=v.clone();o&&g.applyMatrix4(o),l.push(g)}for(f=0,m=u.length;m>f;f++){var y,x,w,b=u[f],_=b.vertexNormals,M=b.vertexColors;y=new e.Face3(b.a+a,b.b+a,b.c+a),y.normal.copy(b.normal),n&&y.normal.applyMatrix3(n).normalize();for(var S=0,T=_.length;T>S;S++)x=_[S].clone(),n&&x.applyMatrix3(n).normalize(),y.vertexNormals.push(x);y.color.copy(b.color);for(var S=0,T=M.length;T>S;S++)w=M[S],y.vertexColors.push(w.clone());y.materialIndex=b.materialIndex+i,y.centroid.copy(b.centroid),o&&y.centroid.applyMatrix4(o),h.push(y)}for(f=0,m=d.length;m>f;f++){for(var C=d[f],L=[],S=0,T=C.length;T>S;S++)L.push(new e.Vector2(C[S].x,C[S].y));p.push(L)}},randomPointInTriangle:function(){var t=new e.Vector3;return function(r,i,o){var n=new e.Vector3,a=e.Math.random16(),s=e.Math.random16();a+s>1&&(a=1-a,s=1-s);var l=1-a-s;return n.copy(r),n.multiplyScalar(a),t.copy(i),t.multiplyScalar(s),n.add(t),t.copy(o),t.multiplyScalar(l),n.add(t),n}}(),randomPointInFace:function(t,r,i){var o,n,a;return o=r.vertices[t.a],n=r.vertices[t.b],a=r.vertices[t.c],e.GeometryUtils.randomPointInTriangle(o,n,a)},randomPointsInGeometry:function(t,r){function i(e){function t(r,i){if(r>i)return r;var o=r+Math.floor((i-r)/2);return d[o]>e?t(r,o-1):d[o]<e?t(o+1,i):o}var r=t(0,d.length-1);return r}var o,n,a,s,l,c=t.faces,h=t.vertices,u=c.length,p=0,d=[];for(n=0;u>n;n++)o=c[n],a=h[o.a],s=h[o.b],l=h[o.c],o._area=e.GeometryUtils.triangleArea(a,s,l),p+=o._area,d[n]=p;var f,m,v=[],g={};for(n=0;r>n;n++)f=e.Math.random16()*p,m=i(f),v[n]=e.GeometryUtils.randomPointInFace(c[m],t,!0),g[m]?g[m]+=1:g[m]=1;return v},triangleArea:function(){var t=new e.Vector3,r=new e.Vector3;return function(e,i,o){return t.subVectors(i,e),r.subVectors(o,e),t.cross(r),.5*t.length()}}(),center:function(t){t.computeBoundingBox();var r=t.boundingBox,i=new e.Vector3;return i.addVectors(r.min,r.max),i.multiplyScalar(-.5),t.applyMatrix((new e.Matrix4).makeTranslation(i.x,i.y,i.z)),t.computeBoundingBox(),i},triangulateQuads:function(e){var t,r,i,o,n=[],a=[];for(t=0,r=e.faceVertexUvs.length;r>t;t++)a[t]=[];for(t=0,r=e.faces.length;r>t;t++){var s=e.faces[t];for(n.push(s),i=0,o=e.faceVertexUvs.length;o>i;i++)a[i].push(e.faceVertexUvs[i][t])}e.faces=n,e.faceVertexUvs=a,e.computeCentroids(),e.computeFaceNormals(),e.computeVertexNormals(),e.hasTangents&&e.computeTangents()}},e.ImageUtils={crossOrigin:"anonymous",loadTexture:function(t,r,i,o){var n=new e.ImageLoader;n.crossOrigin=this.crossOrigin;var a=new e.Texture(void 0,r),s=n.load(t,function(){a.needsUpdate=!0,i&&i(a)});return a.image=s,a.sourceFile=t,a},loadCompressedTexture:function(t,r,i,o){var n=new e.CompressedTexture;n.mapping=r;var a=new XMLHttpRequest;return a.onload=function(){var t=a.response,r=e.ImageUtils.parseDDS(t,!0);n.format=r.format,n.mipmaps=r.mipmaps,n.image.width=r.width,n.image.height=r.height,n.generateMipmaps=!1,n.needsUpdate=!0,i&&i(n)},a.onerror=o,a.open("GET",t,!0),a.responseType="arraybuffer",a.send(null),n},loadTextureCube:function(t,r,i,o){var n=[];n.loadCount=0;var a=new e.Texture;a.image=n,void 0!==r&&(a.mapping=r),a.flipY=!1;for(var s=0,l=t.length;l>s;++s){var c=new Image;n[s]=c,c.onload=function(){n.loadCount+=1,6===n.loadCount&&(a.needsUpdate=!0,i&&i(a))},c.onerror=o,c.crossOrigin=this.crossOrigin,c.src=t[s]}return a},loadCompressedTextureCube:function(t,r,i,o){var n=[];n.loadCount=0;var a=new e.CompressedTexture;a.image=n,void 0!==r&&(a.mapping=r),a.flipY=!1,a.generateMipmaps=!1;var s=function(t,r){return function(){var o=t.response,s=e.ImageUtils.parseDDS(o,!0);r.format=s.format,r.mipmaps=s.mipmaps,r.width=s.width,r.height=s.height,n.loadCount+=1,6===n.loadCount&&(a.format=s.format,a.needsUpdate=!0,i&&i(a))}};if(t instanceof Array)for(var l=0,c=t.length;c>l;++l){var h={};n[l]=h;var u=new XMLHttpRequest;u.onload=s(u,h),u.onerror=o;var p=t[l];u.open("GET",p,!0),u.responseType="arraybuffer",u.send(null)}else{var p=t,u=new XMLHttpRequest;u.onload=function(){var t=u.response,r=e.ImageUtils.parseDDS(t,!0);if(r.isCubemap){for(var o=r.mipmaps.length/r.mipmapCount,s=0;o>s;s++){n[s]={mipmaps:[]};for(var l=0;l<r.mipmapCount;l++)n[s].mipmaps.push(r.mipmaps[s*r.mipmapCount+l]),n[s].format=r.format,n[s].width=r.width,n[s].height=r.height}a.format=r.format,a.needsUpdate=!0,i&&i(a)}},u.onerror=o,u.open("GET",p,!0),u.responseType="arraybuffer",u.send(null)}return a},loadDDSTexture:function(t,r,i,o){var n=[];n.loadCount=0;var a=new e.CompressedTexture;a.image=n,void 0!==r&&(a.mapping=r),a.flipY=!1,a.generateMipmaps=!1;var s=new XMLHttpRequest;return s.onload=function(){var t=s.response,r=e.ImageUtils.parseDDS(t,!0);if(r.isCubemap)for(var o=r.mipmaps.length/r.mipmapCount,l=0;o>l;l++){n[l]={mipmaps:[]};for(var c=0;c<r.mipmapCount;c++)n[l].mipmaps.push(r.mipmaps[l*r.mipmapCount+c]),n[l].format=r.format,n[l].width=r.width,n[l].height=r.height}else a.image.width=r.width,a.image.height=r.height,a.mipmaps=r.mipmaps;a.format=r.format,a.needsUpdate=!0,i&&i(a)},s.onerror=o,s.open("GET",t,!0),s.responseType="arraybuffer",s.send(null),a},parseDDS:function(t,r){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function o(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}function n(e,t,r,i){for(var o=r*i*4,n=new Uint8Array(e,t,o),a=new Uint8Array(o),s=0,l=0,c=0;i>c;c++)for(var h=0;r>h;h++){var u=n[l];l++;var p=n[l];l++;var d=n[l];l++;var f=n[l];l++,a[s]=d,s++,a[s]=p,s++,a[s]=u,s++,a[s]=f,s++}return a}var a={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},s=542327876,l=131072,c=512,h=4,u=i("DXT1"),p=i("DXT3"),d=i("DXT5"),f=31,m=0,v=1,g=2,y=3,x=4,w=7,b=20,_=21,M=22,S=23,T=24,C=25,L=26,A=28,P=new Int32Array(t,0,f);if(P[m]!==s)return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),a;if(!P[b]&h)return console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code"),a;var D,F=P[_],E=!1;switch(F){case u:D=8,a.format=e.RGB_S3TC_DXT1_Format;break;case p:D=16,a.format=e.RGBA_S3TC_DXT3_Format;break;case d:D=16,a.format=e.RGBA_S3TC_DXT5_Format;break;default:if(!(32==P[M]&&16711680&P[S]&&65280&P[T]&&255&P[C]&&4278190080&P[L]))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",o(F)),a;E=!0,D=64,a.format=e.RGBAFormat}a.mipmapCount=1,P[g]&l&&r!==!1&&(a.mipmapCount=Math.max(1,P[w])),a.isCubemap=P[A]&c?!0:!1,a.width=P[x],a.height=P[y];for(var V=P[v]+4,R=a.width,z=a.height,I=a.isCubemap?6:1,U=0;I>U;U++){for(var O=0;O<a.mipmapCount;O++){if(E)var B=n(t,V,R,z),N=B.length;else var N=Math.max(4,R)/4*Math.max(4,z)/4*D,B=new Uint8Array(t,V,N);var k={data:B,width:R,height:z};a.mipmaps.push(k),V+=N,R=Math.max(.5*R,1),z=Math.max(.5*z,1)}R=a.width,z=a.height}return a},getNormalMap:function(e,t){var r=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},i=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},o=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]};t=1|t;var n=e.width,a=e.height,s=document.createElement("canvas");s.width=n,s.height=a;var l=s.getContext("2d");l.drawImage(e,0,0);for(var c=l.getImageData(0,0,n,a).data,h=l.createImageData(n,a),u=h.data,p=0;n>p;p++)for(var d=0;a>d;d++){var f=0>d-1?0:d-1,m=d+1>a-1?a-1:d+1,v=0>p-1?0:p-1,g=p+1>n-1?n-1:p+1,y=[],x=[0,0,c[4*(d*n+p)]/255*t];y.push([-1,0,c[4*(d*n+v)]/255*t]),y.push([-1,-1,c[4*(f*n+v)]/255*t]),y.push([0,-1,c[4*(f*n+p)]/255*t]),y.push([1,-1,c[4*(f*n+g)]/255*t]),y.push([1,0,c[4*(d*n+g)]/255*t]),y.push([1,1,c[4*(m*n+g)]/255*t]),y.push([0,1,c[4*(m*n+p)]/255*t]),y.push([-1,1,c[4*(m*n+v)]/255*t]);for(var w=[],b=y.length,_=0;b>_;_++){var M=y[_],S=y[(_+1)%b];M=i(M,x),S=i(S,x),w.push(o(r(M,S)))}for(var T=[0,0,0],_=0;_<w.length;_++)T[0]+=w[_][0],T[1]+=w[_][1],T[2]+=w[_][2];T[0]/=w.length,T[1]/=w.length,T[2]/=w.length;var C=4*(d*n+p);u[C]=(T[0]+1)/2*255|0,u[C+1]=(T[1]+1)/2*255|0,u[C+2]=255*T[2]|0,u[C+3]=255}return l.putImageData(h,0,0),s},generateDataTexture:function(t,r,i){for(var o=t*r,n=new Uint8Array(3*o),a=Math.floor(255*i.r),s=Math.floor(255*i.g),l=Math.floor(255*i.b),c=0;o>c;c++)n[3*c]=a,n[3*c+1]=s,n[3*c+2]=l;var h=new e.DataTexture(n,t,r,e.RGBFormat);return h.needsUpdate=!0,h}},e.SceneUtils={createMultiMaterialObject:function(t,r){for(var i=new e.Object3D,o=0,n=r.length;n>o;o++)i.add(new e.Mesh(t,r[o]));return i},detach:function(e,t,r){e.applyMatrix(t.matrixWorld),t.remove(e),r.add(e)},attach:function(t,r,i){var o=new e.Matrix4;o.getInverse(i.matrixWorld),t.applyMatrix(o),r.remove(t),i.add(t)}},e.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase(),r=this;r.faces[t]=r.faces[t]||{},r.faces[t][e.cssFontWeight]=r.faces[t][e.cssFontWeight]||{},r.faces[t][e.cssFontWeight][e.cssFontStyle]=e;r.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(t){var r,i=this.getFace(),o=this.size/i.resolution,n=0,a=String(t).split(""),s=a.length,l=[];for(r=0;s>r;r++){var c=new e.Path,h=this.extractGlyphPoints(a[r],i,o,n,c);n+=h.offset,l.push(h.path)}var u=n/2;return{paths:l,offset:u}},extractGlyphPoints:function(t,r,i,o,n){var a,s,l,c,h,u,p,d,f,m,v,g,y,x,w,b,_,M,S,T=[],C=r.glyphs[t]||r.glyphs["?"];if(C){if(C.o)for(c=C._cachedOutline||(C._cachedOutline=C.o.split(" ")),u=c.length,p=i,d=i,a=0;u>a;)switch(h=c[a++]){case"m":f=c[a++]*p+o,m=c[a++]*d,n.moveTo(f,m);break;case"l":f=c[a++]*p+o,m=c[a++]*d,n.lineTo(f,m);break;case"q":if(v=c[a++]*p+o,g=c[a++]*d,w=c[a++]*p+o,b=c[a++]*d,n.quadraticCurveTo(w,b,v,g),S=T[T.length-1])for(y=S.x,x=S.y,s=1,l=this.divisions;l>=s;s++){var L=s/l;e.Shape.Utils.b2(L,y,w,v),e.Shape.Utils.b2(L,x,b,g)}break;case"b":if(v=c[a++]*p+o,g=c[a++]*d,w=c[a++]*p+o,b=c[a++]*-d,_=c[a++]*p+o,M=c[a++]*-d,n.bezierCurveTo(v,g,w,b,_,M),S=T[T.length-1])for(y=S.x,x=S.y,s=1,l=this.divisions;l>=s;s++){var L=s/l;e.Shape.Utils.b3(L,y,w,_,v),e.Shape.Utils.b3(L,x,b,M,g)}}return{offset:C.ha*i,path:n}}}},e.FontUtils.generateShapes=function(t,r){r=r||{};var i=void 0!==r.size?r.size:100,o=void 0!==r.curveSegments?r.curveSegments:4,n=void 0!==r.font?r.font:"helvetiker",a=void 0!==r.weight?r.weight:"normal",s=void 0!==r.style?r.style:"normal";e.FontUtils.size=i,e.FontUtils.divisions=o,e.FontUtils.face=n,e.FontUtils.weight=a,e.FontUtils.style=s;for(var l=e.FontUtils.drawText(t),c=l.paths,h=[],u=0,p=c.length;p>u;u++)Array.prototype.push.apply(h,c[u].toShapes());return h},function(e){var t=1e-10,r=function(e,t){var r=e.length;if(3>r)return null;var n,a,s,l=[],c=[],h=[];if(i(e)>0)for(a=0;r>a;a++)c[a]=a;else for(a=0;r>a;a++)c[a]=r-1-a;var u=r,p=2*u;for(a=u-1;u>2;){if(p--<=0)return console.log("Warning, unable to triangulate polygon!"),t?h:l;if(n=a,n>=u&&(n=0),a=n+1,a>=u&&(a=0),s=a+1,s>=u&&(s=0),o(e,n,a,s,u,c)){var d,f,m,v,g;for(d=c[n],f=c[a],m=c[s],l.push([e[d],e[f],e[m]]),h.push([c[n],c[a],c[s]]),v=a,g=a+1;u>g;v++,g++)c[v]=c[g];u--,p=2*u}}return t?h:l},i=function(e){for(var t=e.length,r=0,i=t-1,o=0;t>o;i=o++)r+=e[i].x*e[o].y-e[o].x*e[i].y;return.5*r},o=function(e,r,i,o,n,a){var s,l,c,h,u,p,d,f,m;if(l=e[a[r]].x,c=e[a[r]].y,h=e[a[i]].x,u=e[a[i]].y,p=e[a[o]].x,d=e[a[o]].y,t>(h-l)*(d-c)-(u-c)*(p-l))return!1;var v,g,y,x,w,b,_,M,S,T,C,L,A,P,D;for(v=p-h,g=d-u,y=l-p,x=c-d,w=h-l,b=u-c,s=0;n>s;s++)if(s!==r&&s!==i&&s!==o&&(f=e[a[s]].x,m=e[a[s]].y,_=f-l,M=m-c,S=f-h,T=m-u,C=f-p,L=m-d,D=v*T-g*S,A=w*M-b*_,P=y*L-x*C,D>=-t&&P>=-t&&A>=-t))return!1;return!0};return e.Triangulate=r,e.Triangulate.area=i,e}(e.FontUtils),self._typeface_js={faces:e.FontUtils.faces,loadFace:e.FontUtils.loadFace},e.typeface_js=self._typeface_js,e.Curve=function(){},e.Curve.prototype.getPoint=function(e){return console.log("Warning, getPoint() not implemented!"),null},e.Curve.prototype.getPointAt=function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},e.Curve.prototype.getPoints=function(e){e||(e=5);var t,r=[];for(t=0;e>=t;t++)r.push(this.getPoint(t/e));return r},e.Curve.prototype.getSpacedPoints=function(e){e||(e=5);var t,r=[];for(t=0;e>=t;t++)r.push(this.getPointAt(t/e));return r},e.Curve.prototype.getLength=function(){var e=this.getLengths();return e[e.length-1]},e.Curve.prototype.getLengths=function(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,r,i=[],o=this.getPoint(0),n=0;for(i.push(0),r=1;e>=r;r++)t=this.getPoint(r/e),n+=t.distanceTo(o),i.push(n),o=t;return this.cacheArcLengths=i,i},e.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},e.Curve.prototype.getUtoTmapping=function(e,t){var r,i=this.getLengths(),o=0,n=i.length;r=t?t:e*i[n-1];for(var a,s=0,l=n-1;l>=s;)if(o=Math.floor(s+(l-s)/2),a=i[o]-r,0>a)s=o+1;else{if(!(a>0)){l=o;break}l=o-1}if(o=l,i[o]==r){var c=o/(n-1);return c}var h=i[o],u=i[o+1],p=u-h,d=(r-h)/p,c=(o+d)/(n-1);return c},e.Curve.prototype.getTangent=function(e){var t=1e-4,r=e-t,i=e+t;0>r&&(r=0),i>1&&(i=1);var o=this.getPoint(r),n=this.getPoint(i),a=n.clone().sub(o);return a.normalize()},e.Curve.prototype.getTangentAt=function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},e.Curve.Utils={tangentQuadraticBezier:function(e,t,r,i){return 2*(1-e)*(r-t)+2*e*(i-r)},tangentCubicBezier:function(e,t,r,i,o){return-3*t*(1-e)*(1-e)+3*r*(1-e)*(1-e)-6*e*r*(1-e)+6*e*i*(1-e)-3*e*e*i+3*e*e*o},tangentSpline:function(e,t,r,i,o){var n=6*e*e-6*e,a=3*e*e-4*e+1,s=-6*e*e+6*e,l=3*e*e-2*e;return n+a+s+l},interpolate:function(e,t,r,i,o){var n=.5*(r-e),a=.5*(i-t),s=o*o,l=o*s;return(2*t-2*r+n+a)*l+(-3*t+3*r-2*n-a)*s+n*o+t}},e.Curve.create=function(t,r){return t.prototype=Object.create(e.Curve.prototype),t.prototype.getPoint=r,t},e.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},e.CurvePath.prototype=Object.create(e.Curve.prototype),e.CurvePath.prototype.add=function(e){this.curves.push(e)},e.CurvePath.prototype.checkConnection=function(){},e.CurvePath.prototype.closePath=function(){var t=this.curves[0].getPoint(0),r=this.curves[this.curves.length-1].getPoint(1);t.equals(r)||this.curves.push(new e.LineCurve(r,t))},e.CurvePath.prototype.getPoint=function(e){for(var t,r,i=e*this.getLength(),o=this.getCurveLengths(),n=0;n<o.length;){if(o[n]>=i){t=o[n]-i,r=this.curves[n];var a=1-t/r.getLength();return r.getPointAt(a)}n++}return null},e.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},e.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e,t=[],r=0,i=this.curves.length;for(e=0;i>e;e++)r+=this.curves[e].getLength(),t.push(r);return this.cacheLengths=t,t},e.CurvePath.prototype.getBoundingBox=function(){var t,r,i,o,n,a,s=this.getPoints();t=r=Number.NEGATIVE_INFINITY,o=n=Number.POSITIVE_INFINITY;var l,c,h,u,p=s[0]instanceof e.Vector3;for(u=p?new e.Vector3:new e.Vector2,c=0,h=s.length;h>c;c++)l=s[c],l.x>t?t=l.x:l.x<o&&(o=l.x),l.y>r?r=l.y:l.y<n&&(n=l.y),p&&(l.z>i?i=l.z:l.z<a&&(a=l.z)),u.add(l);var d={minX:o,minY:n,maxX:t,maxY:r,centroid:u.divideScalar(h)};return p&&(d.maxZ=i,d.minZ=a),d},e.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},e.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},e.CurvePath.prototype.createGeometry=function(t){for(var r=new e.Geometry,i=0;i<t.length;i++)r.vertices.push(new e.Vector3(t[i].x,t[i].y,t[i].z||0));return r},e.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},e.CurvePath.prototype.getTransformedPoints=function(e,t){var r,i,o=this.getPoints(e);for(t||(t=this.bends),r=0,i=t.length;i>r;r++)o=this.getWrapPoints(o,t[r]);return o},e.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var r,i,o=this.getSpacedPoints(e);for(t||(t=this.bends),r=0,i=t.length;i>r;r++)o=this.getWrapPoints(o,t[r]);return o},e.CurvePath.prototype.getWrapPoints=function(e,t){var r,i,o,n,a,s,l=this.getBoundingBox();for(r=0,i=e.length;i>r;r++){o=e[r],n=o.x,a=o.y,s=n/l.maxX,s=t.getUtoTmapping(s,n);var c=t.getPoint(s),h=t.getNormalVector(s).multiplyScalar(a);o.x=c.x+h.x,o.y=c.y+h.y}return e},e.Gyroscope=function(){e.Object3D.call(this)},e.Gyroscope.prototype=Object.create(e.Object3D.prototype),e.Gyroscope.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent?(this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.quaternionWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.quaternionObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.quaternionObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,r=this.children.length;r>t;t++)this.children[t].updateMatrixWorld(e)},e.Gyroscope.prototype.translationWorld=new e.Vector3,e.Gyroscope.prototype.translationObject=new e.Vector3,e.Gyroscope.prototype.quaternionWorld=new e.Quaternion,e.Gyroscope.prototype.quaternionObject=new e.Quaternion,e.Gyroscope.prototype.scaleWorld=new e.Vector3,e.Gyroscope.prototype.scaleObject=new e.Vector3,e.Path=function(t){e.CurvePath.call(this),this.actions=[],t&&this.fromPoints(t)},e.Path.prototype=Object.create(e.CurvePath.prototype),e.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},e.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,r=e.length;r>t;t++)this.lineTo(e[t].x,e[t].y)},e.Path.prototype.moveTo=function(t,r){var i=Array.prototype.slice.call(arguments);this.actions.push({action:e.PathActions.MOVE_TO,args:i})},e.Path.prototype.lineTo=function(t,r){var i=Array.prototype.slice.call(arguments),o=this.actions[this.actions.length-1].args,n=o[o.length-2],a=o[o.length-1],s=new e.LineCurve(new e.Vector2(n,a),new e.Vector2(t,r));this.curves.push(s),this.actions.push({action:e.PathActions.LINE_TO,args:i})},e.Path.prototype.quadraticCurveTo=function(t,r,i,o){var n=Array.prototype.slice.call(arguments),a=this.actions[this.actions.length-1].args,s=a[a.length-2],l=a[a.length-1],c=new e.QuadraticBezierCurve(new e.Vector2(s,l),new e.Vector2(t,r),new e.Vector2(i,o));this.curves.push(c),this.actions.push({action:e.PathActions.QUADRATIC_CURVE_TO,args:n})},e.Path.prototype.bezierCurveTo=function(t,r,i,o,n,a){var s=Array.prototype.slice.call(arguments),l=this.actions[this.actions.length-1].args,c=l[l.length-2],h=l[l.length-1],u=new e.CubicBezierCurve(new e.Vector2(c,h),new e.Vector2(t,r),new e.Vector2(i,o),new e.Vector2(n,a));this.curves.push(u),this.actions.push({action:e.PathActions.BEZIER_CURVE_TO,args:s})},e.Path.prototype.splineThru=function(t){var r=Array.prototype.slice.call(arguments),i=this.actions[this.actions.length-1].args,o=i[i.length-2],n=i[i.length-1],a=[new e.Vector2(o,n)];Array.prototype.push.apply(a,t);var s=new e.SplineCurve(a);this.curves.push(s),this.actions.push({action:e.PathActions.CSPLINE_THRU,args:r})},e.Path.prototype.arc=function(e,t,r,i,o,n){var a=this.actions[this.actions.length-1].args,s=a[a.length-2],l=a[a.length-1];this.absarc(e+s,t+l,r,i,o,n)},e.Path.prototype.absarc=function(e,t,r,i,o,n){this.absellipse(e,t,r,r,i,o,n)},e.Path.prototype.ellipse=function(e,t,r,i,o,n,a){var s=this.actions[this.actions.length-1].args,l=s[s.length-2],c=s[s.length-1];this.absellipse(e+l,t+c,r,i,o,n,a)},e.Path.prototype.absellipse=function(t,r,i,o,n,a,s){var l=Array.prototype.slice.call(arguments),c=new e.EllipseCurve(t,r,i,o,n,a,s);this.curves.push(c);var h=c.getPoint(1);l.push(h.x),l.push(h.y),this.actions.push({action:e.PathActions.ELLIPSE,args:l})},e.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);for(var r=[],i=0;e>i;i++)r.push(this.getPoint(i/e));return r},e.Path.prototype.getPoints=function(t,r){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(t,r);t=t||12;var i,o,n,a,s,l,c,h,u,p,d,f,m,v,g,y,x,w,b=[];for(i=0,o=this.actions.length;o>i;i++)switch(n=this.actions[i],a=n.action,s=n.args,a){case e.PathActions.MOVE_TO:b.push(new e.Vector2(s[0],s[1]));break;case e.PathActions.LINE_TO:b.push(new e.Vector2(s[0],s[1]));break;case e.PathActions.QUADRATIC_CURVE_TO:for(l=s[2],c=s[3],p=s[0],d=s[1],b.length>0?(v=b[b.length-1],f=v.x,m=v.y):(v=this.actions[i-1].args,f=v[v.length-2],m=v[v.length-1]),g=1;t>=g;g++)y=g/t,x=e.Shape.Utils.b2(y,f,p,l),w=e.Shape.Utils.b2(y,m,d,c),b.push(new e.Vector2(x,w));break;case e.PathActions.BEZIER_CURVE_TO:for(l=s[4],c=s[5],p=s[0],d=s[1],h=s[2],u=s[3],b.length>0?(v=b[b.length-1],f=v.x,m=v.y):(v=this.actions[i-1].args,f=v[v.length-2],m=v[v.length-1]),g=1;t>=g;g++)y=g/t,x=e.Shape.Utils.b3(y,f,p,h,l),w=e.Shape.Utils.b3(y,m,d,u,c),b.push(new e.Vector2(x,w));break;case e.PathActions.CSPLINE_THRU:v=this.actions[i-1].args;var _=new e.Vector2(v[v.length-2],v[v.length-1]),M=[_],S=t*s[0].length;M=M.concat(s[0]);var T=new e.SplineCurve(M);for(g=1;S>=g;g++)b.push(T.getPointAt(g/S));break;case e.PathActions.ARC:var C,L=s[0],A=s[1],P=s[2],D=s[3],F=s[4],E=!!s[5],V=F-D,R=2*t;
for(g=1;R>=g;g++)y=g/R,E||(y=1-y),C=D+y*V,x=L+P*Math.cos(C),w=A+P*Math.sin(C),b.push(new e.Vector2(x,w));break;case e.PathActions.ELLIPSE:var C,L=s[0],A=s[1],z=s[2],I=s[3],D=s[4],F=s[5],E=!!s[6],V=F-D,R=2*t;for(g=1;R>=g;g++)y=g/R,E||(y=1-y),C=D+y*V,x=L+z*Math.cos(C),w=A+I*Math.sin(C),b.push(new e.Vector2(x,w))}var U=b[b.length-1],O=1e-10;return Math.abs(U.x-b[0].x)<O&&Math.abs(U.y-b[0].y)<O&&b.splice(b.length-1,1),r&&b.push(b[0]),b},e.Path.prototype.toShapes=function(t){var r,i,o,n,a,s=[],l=new e.Path;for(r=0,i=this.actions.length;i>r;r++)o=this.actions[r],a=o.args,n=o.action,n==e.PathActions.MOVE_TO&&0!=l.actions.length&&(s.push(l),l=new e.Path),l[n].apply(l,a);if(0!=l.actions.length&&s.push(l),0==s.length)return[];var c,h,u,p=[];if(1==s.length)return h=s[0],u=new e.Shape,u.actions=h.actions,u.curves=h.curves,p.push(u),p;var d=!e.Shape.Utils.isClockWise(s[0].getPoints());if(d=t?!d:d)for(u=new e.Shape,r=0,i=s.length;i>r;r++)h=s[r],c=e.Shape.Utils.isClockWise(h.getPoints()),c=t?!c:c,c?(u.actions=h.actions,u.curves=h.curves,p.push(u),u=new e.Shape):u.holes.push(h);else{for(u=void 0,r=0,i=s.length;i>r;r++)h=s[r],c=e.Shape.Utils.isClockWise(h.getPoints()),c=t?!c:c,c?(u&&p.push(u),u=new e.Shape,u.actions=h.actions,u.curves=h.curves):u.holes.push(h);p.push(u)}return p},e.Shape=function(){e.Path.apply(this,arguments),this.holes=[]},e.Shape.prototype=Object.create(e.Path.prototype),e.Shape.prototype.extrude=function(t){var r=new e.ExtrudeGeometry(this,t);return r},e.Shape.prototype.makeGeometry=function(t){var r=new e.ShapeGeometry(this,t);return r},e.Shape.prototype.getPointsHoles=function(e){var t,r=this.holes.length,i=[];for(t=0;r>t;t++)i[t]=this.holes[t].getTransformedPoints(e,this.bends);return i},e.Shape.prototype.getSpacedPointsHoles=function(e){var t,r=this.holes.length,i=[];for(t=0;r>t;t++)i[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return i},e.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},e.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},e.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},e.Shape.Utils={removeHoles:function(t,r){var i,o,n,a,s,l,c,h,u,p,d,f,m,v,g,y,x=t.concat(),w=x.concat(),b=[];for(s=0;s<r.length;s++){for(c=r[s],Array.prototype.push.apply(w,c),h=Number.POSITIVE_INFINITY,l=0;l<c.length;l++){d=c[l];var _=[];for(p=0;p<x.length;p++)f=x[p],u=d.distanceToSquared(f),_.push(u),h>u&&(h=u,n=l,a=p)}i=a-1>=0?a-1:x.length-1,o=n-1>=0?n-1:c.length-1;var M=[c[n],x[a],x[i]],S=e.FontUtils.Triangulate.area(M),T=[c[n],c[o],x[a]],C=e.FontUtils.Triangulate.area(T),L=1,A=-1,P=a,D=n;a+=L,n+=A,0>a&&(a+=x.length),a%=x.length,0>n&&(n+=c.length),n%=c.length,i=a-1>=0?a-1:x.length-1,o=n-1>=0?n-1:c.length-1,M=[c[n],x[a],x[i]];var F=e.FontUtils.Triangulate.area(M);T=[c[n],c[o],x[a]];var E=e.FontUtils.Triangulate.area(T);S+C>F+E&&(a=P,n=D,0>a&&(a+=x.length),a%=x.length,0>n&&(n+=c.length),n%=c.length,i=a-1>=0?a-1:x.length-1,o=n-1>=0?n-1:c.length-1),m=x.slice(0,a),v=x.slice(a),g=c.slice(n),y=c.slice(0,n);var V=[c[n],x[a],x[i]],R=[c[n],c[o],x[a]];b.push(V),b.push(R),x=m.concat(g).concat(y).concat(v)}return{shape:x,isolatedPts:b,allpoints:w}},triangulateShape:function(t,r){var i,o,n,a,s,l,c=e.Shape.Utils.removeHoles(t,r),h=c.shape,u=c.allpoints,p=c.isolatedPts,d=e.FontUtils.Triangulate(h,!1),f={};for(i=0,o=u.length;o>i;i++)s=u[i].x+":"+u[i].y,void 0!==f[s]&&console.log("Duplicate point",s),f[s]=i;for(i=0,o=d.length;o>i;i++)for(a=d[i],n=0;3>n;n++)s=a[n].x+":"+a[n].y,l=f[s],void 0!==l&&(a[n]=l);for(i=0,o=p.length;o>i;i++)for(a=p[i],n=0;3>n;n++)s=a[n].x+":"+a[n].y,l=f[s],void 0!==l&&(a[n]=l);return d.concat(p)},isClockWise:function(t){return e.FontUtils.Triangulate.area(t)<0},b2p0:function(e,t){var r=1-e;return r*r*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,r,i){return this.b2p0(e,t)+this.b2p1(e,r)+this.b2p2(e,i)},b3p0:function(e,t){var r=1-e;return r*r*r*t},b3p1:function(e,t){var r=1-e;return 3*r*r*e*t},b3p2:function(e,t){var r=1-e;return 3*r*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,r,i,o){return this.b3p0(e,t)+this.b3p1(e,r)+this.b3p2(e,i)+this.b3p3(e,o)}},e.LineCurve=function(e,t){this.v1=e,this.v2=t},e.LineCurve.prototype=Object.create(e.Curve.prototype),e.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},e.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},e.LineCurve.prototype.getTangent=function(e){var t=this.v2.clone().sub(this.v1);return t.normalize()},e.QuadraticBezierCurve=function(e,t,r){this.v0=e,this.v1=t,this.v2=r},e.QuadraticBezierCurve.prototype=Object.create(e.Curve.prototype),e.QuadraticBezierCurve.prototype.getPoint=function(t){var r,i;return r=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),i=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),new e.Vector2(r,i)},e.QuadraticBezierCurve.prototype.getTangent=function(t){var r,i;r=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x),i=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var o=new e.Vector2(r,i);return o.normalize(),o},e.CubicBezierCurve=function(e,t,r,i){this.v0=e,this.v1=t,this.v2=r,this.v3=i},e.CubicBezierCurve.prototype=Object.create(e.Curve.prototype),e.CubicBezierCurve.prototype.getPoint=function(t){var r,i;return r=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),i=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new e.Vector2(r,i)},e.CubicBezierCurve.prototype.getTangent=function(t){var r,i;r=e.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),i=e.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var o=new e.Vector2(r,i);return o.normalize(),o},e.SplineCurve=function(e){this.points=void 0==e?[]:e},e.SplineCurve.prototype=Object.create(e.Curve.prototype),e.SplineCurve.prototype.getPoint=function(t){var r,i,o,n=new e.Vector2,a=[],s=this.points;return r=(s.length-1)*t,i=Math.floor(r),o=r-i,a[0]=0==i?i:i-1,a[1]=i,a[2]=i>s.length-2?s.length-1:i+1,a[3]=i>s.length-3?s.length-1:i+2,n.x=e.Curve.Utils.interpolate(s[a[0]].x,s[a[1]].x,s[a[2]].x,s[a[3]].x,o),n.y=e.Curve.Utils.interpolate(s[a[0]].y,s[a[1]].y,s[a[2]].y,s[a[3]].y,o),n},e.EllipseCurve=function(e,t,r,i,o,n,a){this.aX=e,this.aY=t,this.xRadius=r,this.yRadius=i,this.aStartAngle=o,this.aEndAngle=n,this.aClockwise=a},e.EllipseCurve.prototype=Object.create(e.Curve.prototype),e.EllipseCurve.prototype.getPoint=function(t){var r,i=this.aEndAngle-this.aStartAngle;0>i&&(i+=2*Math.PI),i>2*Math.PI&&(i-=2*Math.PI),r=this.aClockwise===!0?this.aEndAngle+(1-t)*(2*Math.PI-i):this.aStartAngle+t*i;var o=this.aX+this.xRadius*Math.cos(r),n=this.aY+this.yRadius*Math.sin(r);return new e.Vector2(o,n)},e.ArcCurve=function(t,r,i,o,n,a){e.EllipseCurve.call(this,t,r,i,i,o,n,a)},e.ArcCurve.prototype=Object.create(e.EllipseCurve.prototype),e.LineCurve3=e.Curve.create(function(e,t){this.v1=e,this.v2=t},function(t){var r=new e.Vector3;return r.subVectors(this.v2,this.v1),r.multiplyScalar(t),r.add(this.v1),r}),e.QuadraticBezierCurve3=e.Curve.create(function(e,t,r){this.v0=e,this.v1=t,this.v2=r},function(t){var r,i,o;return r=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),i=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),o=e.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z),new e.Vector3(r,i,o)}),e.CubicBezierCurve3=e.Curve.create(function(e,t,r,i){this.v0=e,this.v1=t,this.v2=r,this.v3=i},function(t){var r,i,o;return r=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),i=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),o=e.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new e.Vector3(r,i,o)}),e.SplineCurve3=e.Curve.create(function(e){this.points=void 0==e?[]:e},function(t){var r,i,o,n=new e.Vector3,a=[],s=this.points;r=(s.length-1)*t,i=Math.floor(r),o=r-i,a[0]=0==i?i:i-1,a[1]=i,a[2]=i>s.length-2?s.length-1:i+1,a[3]=i>s.length-3?s.length-1:i+2;var l=s[a[0]],c=s[a[1]],h=s[a[2]],u=s[a[3]];return n.x=e.Curve.Utils.interpolate(l.x,c.x,h.x,u.x,o),n.y=e.Curve.Utils.interpolate(l.y,c.y,h.y,u.y,o),n.z=e.Curve.Utils.interpolate(l.z,c.z,h.z,u.z,o),n}),e.ClosedSplineCurve3=e.Curve.create(function(e){this.points=void 0==e?[]:e},function(t){var r,i,o,n=new e.Vector3,a=[],s=this.points;return r=(s.length-0)*t,i=Math.floor(r),o=r-i,i+=i>0?0:(Math.floor(Math.abs(i)/s.length)+1)*s.length,a[0]=(i-1)%s.length,a[1]=i%s.length,a[2]=(i+1)%s.length,a[3]=(i+2)%s.length,n.x=e.Curve.Utils.interpolate(s[a[0]].x,s[a[1]].x,s[a[2]].x,s[a[3]].x,o),n.y=e.Curve.Utils.interpolate(s[a[0]].y,s[a[1]].y,s[a[2]].y,s[a[3]].y,o),n.z=e.Curve.Utils.interpolate(s[a[0]].z,s[a[1]].z,s[a[2]].z,s[a[3]].z,o),n}),e.AnimationHandler=function(){var t=[],r={},i={};i.update=function(e){for(var r=0;r<t.length;r++)t[r].update(e)},i.addToUpdate=function(e){-1===t.indexOf(e)&&t.push(e)},i.removeFromUpdate=function(e){var r=t.indexOf(e);-1!==r&&t.splice(r,1)},i.add=function(e){void 0!==r[e.name]&&console.log("THREE.AnimationHandler.add: Warning! "+e.name+" already exists in library. Overwriting."),r[e.name]=e,n(e)},i.get=function(e){return"string"==typeof e?r[e]?r[e]:(console.log("THREE.AnimationHandler.get: Couldn't find animation "+e),null):void 0},i.parse=function(t){var r=[];if(t instanceof e.SkinnedMesh)for(var i=0;i<t.bones.length;i++)r.push(t.bones[i]);else o(t,r);return r};var o=function(e,t){t.push(e);for(var r=0;r<e.children.length;r++)o(e.children[r],t)},n=function(t){if(t.initialized!==!0){for(var r=0;r<t.hierarchy.length;r++){for(var i=0;i<t.hierarchy[r].keys.length;i++)if(t.hierarchy[r].keys[i].time<0&&(t.hierarchy[r].keys[i].time=0),void 0!==t.hierarchy[r].keys[i].rot&&!(t.hierarchy[r].keys[i].rot instanceof e.Quaternion)){var o=t.hierarchy[r].keys[i].rot;t.hierarchy[r].keys[i].rot=new e.Quaternion(o[0],o[1],o[2],o[3])}if(t.hierarchy[r].keys.length&&void 0!==t.hierarchy[r].keys[0].morphTargets){for(var n={},i=0;i<t.hierarchy[r].keys.length;i++)for(var a=0;a<t.hierarchy[r].keys[i].morphTargets.length;a++){var s=t.hierarchy[r].keys[i].morphTargets[a];n[s]=-1}t.hierarchy[r].usedMorphTargets=n;for(var i=0;i<t.hierarchy[r].keys.length;i++){var l={};for(var s in n){for(var a=0;a<t.hierarchy[r].keys[i].morphTargets.length;a++)if(t.hierarchy[r].keys[i].morphTargets[a]===s){l[s]=t.hierarchy[r].keys[i].morphTargetsInfluences[a];break}a===t.hierarchy[r].keys[i].morphTargets.length&&(l[s]=0)}t.hierarchy[r].keys[i].morphTargetsInfluences=l}}for(var i=1;i<t.hierarchy[r].keys.length;i++)t.hierarchy[r].keys[i].time===t.hierarchy[r].keys[i-1].time&&(t.hierarchy[r].keys.splice(i,1),i--);for(var i=0;i<t.hierarchy[r].keys.length;i++)t.hierarchy[r].keys[i].index=i}var c=parseInt(t.length*t.fps,10);t.JIT={},t.JIT.hierarchy=[];for(var r=0;r<t.hierarchy.length;r++)t.JIT.hierarchy.push(new Array(c));t.initialized=!0}};return i.LINEAR=0,i.CATMULLROM=1,i.CATMULLROM_FORWARD=2,i}(),e.Animation=function(t,r,i){this.root=t,this.data=e.AnimationHandler.get(r),this.hierarchy=e.AnimationHandler.parse(t),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.isPaused=!0,this.loop=!0,this.interpolationType=void 0!==i?i:e.AnimationHandler.LINEAR,this.points=[],this.target=new e.Vector3},e.Animation.prototype.play=function(t,r){if(this.isPlaying===!1){this.isPlaying=!0,this.loop=void 0!==t?t:!0,this.currentTime=void 0!==r?r:0;var i,o,n=this.hierarchy.length;for(i=0;n>i;i++){o=this.hierarchy[i],o.matrixAutoUpdate=!0,void 0===o.animationCache&&(o.animationCache={},o.animationCache.prevKey={pos:0,rot:0,scl:0},o.animationCache.nextKey={pos:0,rot:0,scl:0},o.animationCache.originalMatrix=o instanceof e.Bone?o.skinMatrix:o.matrix);var a=o.animationCache.prevKey,s=o.animationCache.nextKey;a.pos=this.data.hierarchy[i].keys[0],a.rot=this.data.hierarchy[i].keys[0],a.scl=this.data.hierarchy[i].keys[0],s.pos=this.getNextKeyWith("pos",i,1),s.rot=this.getNextKeyWith("rot",i,1),s.scl=this.getNextKeyWith("scl",i,1)}this.update(0)}this.isPaused=!1,e.AnimationHandler.addToUpdate(this)},e.Animation.prototype.pause=function(){this.isPaused===!0?e.AnimationHandler.addToUpdate(this):e.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},e.Animation.prototype.stop=function(){this.isPlaying=!1,this.isPaused=!1,e.AnimationHandler.removeFromUpdate(this)},e.Animation.prototype.update=function(t){if(this.isPlaying!==!1){var r,i,o,n,a,s,l,c,h,u,p,d,f,m,v,g=["pos","rot","scl"];this.data.JIT.hierarchy;this.currentTime+=t*this.timeScale,d=this.currentTime,p=this.currentTime=this.currentTime%this.data.length,u=parseInt(Math.min(p*this.data.fps,this.data.length*this.data.fps),10);for(var y=0,x=this.hierarchy.length;x>y;y++){c=this.hierarchy[y],h=c.animationCache;for(var w=0;3>w;w++){if(r=g[w],s=h.prevKey[r],l=h.nextKey[r],l.time<=d){if(d>p){if(!this.loop)return void this.stop();for(s=this.data.hierarchy[y].keys[0],l=this.getNextKeyWith(r,y,1);l.time<p;)s=l,l=this.getNextKeyWith(r,y,l.index+1)}else do s=l,l=this.getNextKeyWith(r,y,l.index+1);while(l.time<p);h.prevKey[r]=s,h.nextKey[r]=l}c.matrixAutoUpdate=!0,c.matrixWorldNeedsUpdate=!0,i=(p-s.time)/(l.time-s.time),n=s[r],a=l[r],(0>i||i>1)&&(console.log("THREE.Animation.update: Warning! Scale out of bounds:"+i+" on bone "+y),i=0>i?0:1),"pos"===r?(o=c.position,this.interpolationType===e.AnimationHandler.LINEAR?(o.x=n[0]+(a[0]-n[0])*i,o.y=n[1]+(a[1]-n[1])*i,o.z=n[2]+(a[2]-n[2])*i):(this.interpolationType===e.AnimationHandler.CATMULLROM||this.interpolationType===e.AnimationHandler.CATMULLROM_FORWARD)&&(this.points[0]=this.getPrevKeyWith("pos",y,s.index-1).pos,this.points[1]=n,this.points[2]=a,this.points[3]=this.getNextKeyWith("pos",y,l.index+1).pos,i=.33*i+.33,f=this.interpolateCatmullRom(this.points,i),o.x=f[0],o.y=f[1],o.z=f[2],this.interpolationType===e.AnimationHandler.CATMULLROM_FORWARD&&(m=this.interpolateCatmullRom(this.points,1.01*i),this.target.set(m[0],m[1],m[2]),this.target.sub(o),this.target.y=0,this.target.normalize(),v=Math.atan2(this.target.x,this.target.z),c.rotation.set(0,v,0)))):"rot"===r?e.Quaternion.slerp(n,a,c.quaternion,i):"scl"===r&&(o=c.scale,o.x=n[0]+(a[0]-n[0])*i,o.y=n[1]+(a[1]-n[1])*i,o.z=n[2]+(a[2]-n[2])*i)}}}},e.Animation.prototype.interpolateCatmullRom=function(e,t){var r,i,o,n,a,s,l,c,h,u=[],p=[];return r=(e.length-1)*t,i=Math.floor(r),o=r-i,u[0]=0===i?i:i-1,u[1]=i,u[2]=i>e.length-2?i:i+1,u[3]=i>e.length-3?i:i+2,s=e[u[0]],l=e[u[1]],c=e[u[2]],h=e[u[3]],n=o*o,a=o*n,p[0]=this.interpolate(s[0],l[0],c[0],h[0],o,n,a),p[1]=this.interpolate(s[1],l[1],c[1],h[1],o,n,a),p[2]=this.interpolate(s[2],l[2],c[2],h[2],o,n,a),p},e.Animation.prototype.interpolate=function(e,t,r,i,o,n,a){var s=.5*(r-e),l=.5*(i-t);return(2*(t-r)+s+l)*a+(-3*(t-r)-2*s-l)*n+s*o+t},e.Animation.prototype.getNextKeyWith=function(t,r,i){var o=this.data.hierarchy[r].keys;for(this.interpolationType===e.AnimationHandler.CATMULLROM||this.interpolationType===e.AnimationHandler.CATMULLROM_FORWARD?i=i<o.length-1?i:o.length-1:i%=o.length;i<o.length;i++)if(void 0!==o[i][t])return o[i];return this.data.hierarchy[r].keys[0]},e.Animation.prototype.getPrevKeyWith=function(t,r,i){var o=this.data.hierarchy[r].keys;for(i=this.interpolationType===e.AnimationHandler.CATMULLROM||this.interpolationType===e.AnimationHandler.CATMULLROM_FORWARD?i>0?i:0:i>=0?i:i+o.length;i>=0;i--)if(void 0!==o[i][t])return o[i];return this.data.hierarchy[r].keys[o.length-1]},e.KeyFrameAnimation=function(t,r,i){this.root=t,this.data=e.AnimationHandler.get(r),this.hierarchy=e.AnimationHandler.parse(t),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.isPaused=!0,this.loop=!0,this.JITCompile=void 0!==i?i:!0;for(var o=0,n=this.hierarchy.length;n>o;o++){var a=this.data.hierarchy[o].keys,s=this.data.hierarchy[o].sids,l=this.hierarchy[o];if(a.length&&s){for(var c=0;c<s.length;c++){var h=s[c],u=this.getNextKeyWith(h,o,0);u&&u.apply(h)}l.matrixAutoUpdate=!1,this.data.hierarchy[o].node.updateMatrix(),l.matrixWorldNeedsUpdate=!0}}},e.KeyFrameAnimation.prototype.play=function(t,r){if(!this.isPlaying){this.isPlaying=!0,this.loop=void 0!==t?t:!0,this.currentTime=void 0!==r?r:0,this.startTimeMs=r,this.startTime=1e7,this.endTime=-this.startTime;var i,o,n,a=this.hierarchy.length;for(i=0;a>i;i++){o=this.hierarchy[i],n=this.data.hierarchy[i],void 0===n.animationCache&&(n.animationCache={},n.animationCache.prevKey=null,n.animationCache.nextKey=null,n.animationCache.originalMatrix=o instanceof e.Bone?o.skinMatrix:o.matrix);var s=this.data.hierarchy[i].keys;s.length&&(n.animationCache.prevKey=s[0],n.animationCache.nextKey=s[1],this.startTime=Math.min(s[0].time,this.startTime),this.endTime=Math.max(s[s.length-1].time,this.endTime))}this.update(0)}this.isPaused=!1,e.AnimationHandler.addToUpdate(this)},e.KeyFrameAnimation.prototype.pause=function(){this.isPaused?e.AnimationHandler.addToUpdate(this):e.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},e.KeyFrameAnimation.prototype.stop=function(){this.isPlaying=!1,this.isPaused=!1,e.AnimationHandler.removeFromUpdate(this);for(var t=0;t<this.data.hierarchy.length;t++){var r=this.hierarchy[t],i=this.data.hierarchy[t];if(void 0!==i.animationCache){var o=i.animationCache.originalMatrix;r instanceof e.Bone?(o.copy(r.skinMatrix),r.skinMatrix=o):(o.copy(r.matrix),r.matrix=o),delete i.animationCache}}},e.KeyFrameAnimation.prototype.update=function(t){if(this.isPlaying){var r,i,o,n,a,s,l,c,h=this.data.JIT.hierarchy;if(this.currentTime+=t*this.timeScale,l=this.currentTime,s=this.currentTime=this.currentTime%this.data.length,s<this.startTimeMs&&(s=this.currentTime=this.startTimeMs+s),a=parseInt(Math.min(s*this.data.fps,this.data.length*this.data.fps),10),c=l>s,c&&!this.loop){for(var u=0,p=this.hierarchy.length;p>u;u++){var d=this.data.hierarchy[u].keys,f=this.data.hierarchy[u].sids,m=d.length-1,v=this.hierarchy[u];if(d.length){for(var g=0;g<f.length;g++){var y=f[g],x=this.getPrevKeyWith(y,u,m);x&&x.apply(y)}this.data.hierarchy[u].node.updateMatrix(),v.matrixWorldNeedsUpdate=!0}}return void this.stop()}if(!(s<this.startTime)){for(var u=0,p=this.hierarchy.length;p>u;u++){o=this.hierarchy[u],n=this.data.hierarchy[u];var d=n.keys,w=n.animationCache;if(this.JITCompile&&void 0!==h[u][a])o instanceof e.Bone?(o.skinMatrix=h[u][a],o.matrixWorldNeedsUpdate=!1):(o.matrix=h[u][a],o.matrixWorldNeedsUpdate=!0);else if(d.length){if(this.JITCompile&&w&&(o instanceof e.Bone?o.skinMatrix=w.originalMatrix:o.matrix=w.originalMatrix),r=w.prevKey,i=w.nextKey,r&&i){if(i.time<=l){if(c&&this.loop)for(r=d[0],i=d[1];i.time<s;)r=i,i=d[r.index+1];else if(!c)for(var b=d.length-1;i.time<s&&i.index!==b;)r=i,i=d[r.index+1];w.prevKey=r,w.nextKey=i}i.time>=s?r.interpolate(i,s):r.interpolate(i,i.time)}this.data.hierarchy[u].node.updateMatrix(),o.matrixWorldNeedsUpdate=!0}}if(this.JITCompile&&void 0===h[0][a]){this.hierarchy[0].updateMatrixWorld(!0);for(var u=0;u<this.hierarchy.length;u++)this.hierarchy[u]instanceof e.Bone?h[u][a]=this.hierarchy[u].skinMatrix.clone():h[u][a]=this.hierarchy[u].matrix.clone()}}}},e.KeyFrameAnimation.prototype.getNextKeyWith=function(e,t,r){var i=this.data.hierarchy[t].keys;for(r%=i.length;r<i.length;r++)if(i[r].hasTarget(e))return i[r];return i[0]},e.KeyFrameAnimation.prototype.getPrevKeyWith=function(e,t,r){var i=this.data.hierarchy[t].keys;for(r=r>=0?r:r+i.length;r>=0;r--)if(i[r].hasTarget(e))return i[r];return i[i.length-1]},e.CubeCamera=function(t,r,i){e.Object3D.call(this);var o=90,n=1,a=new e.PerspectiveCamera(o,n,t,r);a.up.set(0,-1,0),a.lookAt(new e.Vector3(1,0,0)),this.add(a);var s=new e.PerspectiveCamera(o,n,t,r);s.up.set(0,-1,0),s.lookAt(new e.Vector3(-1,0,0)),this.add(s);var l=new e.PerspectiveCamera(o,n,t,r);l.up.set(0,0,1),l.lookAt(new e.Vector3(0,1,0)),this.add(l);var c=new e.PerspectiveCamera(o,n,t,r);c.up.set(0,0,-1),c.lookAt(new e.Vector3(0,-1,0)),this.add(c);var h=new e.PerspectiveCamera(o,n,t,r);h.up.set(0,-1,0),h.lookAt(new e.Vector3(0,0,1)),this.add(h);var u=new e.PerspectiveCamera(o,n,t,r);u.up.set(0,-1,0),u.lookAt(new e.Vector3(0,0,-1)),this.add(u),this.renderTarget=new e.WebGLRenderTargetCube(i,i,{format:e.RGBFormat,magFilter:e.LinearFilter,minFilter:e.LinearFilter}),this.updateCubeMap=function(e,t){var r=this.renderTarget,i=r.generateMipmaps;r.generateMipmaps=!1,r.activeCubeFace=0,e.render(t,a,r),r.activeCubeFace=1,e.render(t,s,r),r.activeCubeFace=2,e.render(t,l,r),r.activeCubeFace=3,e.render(t,c,r),r.activeCubeFace=4,e.render(t,h,r),r.generateMipmaps=i,r.activeCubeFace=5,e.render(t,u,r)}},e.CubeCamera.prototype=Object.create(e.Object3D.prototype),e.CombinedCamera=function(t,r,i,o,n,a,s){e.Camera.call(this),this.fov=i,this.left=-t/2,this.right=t/2,this.top=r/2,this.bottom=-r/2,this.cameraO=new e.OrthographicCamera(t/-2,t/2,r/2,r/-2,a,s),this.cameraP=new e.PerspectiveCamera(i,t/r,o,n),this.zoom=1,this.toPerspective()},e.CombinedCamera.prototype=Object.create(e.Camera.prototype),e.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inPerspectiveMode=!0,this.inOrthographicMode=!1},e.CombinedCamera.prototype.toOrthographic=function(){var e=this.fov,t=this.cameraP.aspect,r=this.cameraP.near,i=this.cameraP.far,o=(r+i)/2,n=Math.tan(e/2)*o,a=2*n,s=a*t,l=s/2;n/=this.zoom,l/=this.zoom,this.cameraO.left=-l,this.cameraO.right=l,this.cameraO.top=n,this.cameraO.bottom=-n,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPerspectiveMode=!1,this.inOrthographicMode=!0},e.CombinedCamera.prototype.setSize=function(e,t){this.cameraP.aspect=e/t,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2},e.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},e.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())},e.CombinedCamera.prototype.setLens=function(t,r){void 0===r&&(r=24);var i=2*e.Math.radToDeg(Math.atan(r/(2*t)));return this.setFov(i),i},e.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},e.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},e.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},e.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},e.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},e.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},e.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},e.CircleGeometry=function(t,r,i,o){e.Geometry.call(this),this.radius=t=t||50,this.segments=r=void 0!==r?Math.max(3,r):8,this.thetaStart=i=void 0!==i?i:0,this.thetaLength=o=void 0!==o?o:2*Math.PI;var n,a=[],s=new e.Vector3,l=new e.Vector2(.5,.5);for(this.vertices.push(s),a.push(l),n=0;r>=n;n++){var c=new e.Vector3,h=i+n/r*o;c.x=t*Math.cos(h),c.y=t*Math.sin(h),this.vertices.push(c),a.push(new e.Vector2((c.x/t+1)/2,(c.y/t+1)/2))}var u=new e.Vector3(0,0,1);for(n=1;r>=n;n++){var p=n,d=n+1,f=0;this.faces.push(new e.Face3(p,d,f,[u.clone(),u.clone(),u.clone()])),this.faceVertexUvs[0].push([a[n].clone(),a[n+1].clone(),l.clone()])}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},e.CircleGeometry.prototype=Object.create(e.Geometry.prototype),e.CubeGeometry=function(t,r,i,o,n,a){function s(t,r,i,o,n,a,s,c){var h,u,p,d=l.widthSegments,f=l.heightSegments,m=n/2,v=a/2,g=l.vertices.length;"x"===t&&"y"===r||"y"===t&&"x"===r?h="z":"x"===t&&"z"===r||"z"===t&&"x"===r?(h="y",f=l.depthSegments):("z"===t&&"y"===r||"y"===t&&"z"===r)&&(h="x",d=l.depthSegments);var y=d+1,x=f+1,w=n/d,b=a/f,_=new e.Vector3;for(_[h]=s>0?1:-1,p=0;x>p;p++)for(u=0;y>u;u++){var M=new e.Vector3;M[t]=(u*w-m)*i,M[r]=(p*b-v)*o,M[h]=s,l.vertices.push(M)}for(p=0;f>p;p++)for(u=0;d>u;u++){var S=u+y*p,T=u+y*(p+1),C=u+1+y*(p+1),L=u+1+y*p,A=new e.Vector2(u/d,1-p/f),P=new e.Vector2(u/d,1-(p+1)/f),D=new e.Vector2((u+1)/d,1-(p+1)/f),F=new e.Vector2((u+1)/d,1-p/f),E=new e.Face3(S+g,T+g,L+g);E.normal.copy(_),E.vertexNormals.push(_.clone(),_.clone(),_.clone()),E.materialIndex=c,l.faces.push(E),l.faceVertexUvs[0].push([A,P,F]),E=new e.Face3(T+g,C+g,L+g),E.normal.copy(_),E.vertexNormals.push(_.clone(),_.clone(),_.clone()),E.materialIndex=c,l.faces.push(E),l.faceVertexUvs[0].push([P.clone(),D,F.clone()])}}e.Geometry.call(this);var l=this;this.width=t,this.height=r,this.depth=i,this.widthSegments=o||1,this.heightSegments=n||1,this.depthSegments=a||1;var c=this.width/2,h=this.height/2,u=this.depth/2;s("z","y",-1,-1,this.depth,this.height,c,0),s("z","y",1,-1,this.depth,this.height,-c,1),s("x","z",1,1,this.width,this.depth,h,2),s("x","z",1,-1,this.width,this.depth,-h,3),s("x","y",1,-1,this.width,this.height,u,4),s("x","y",-1,-1,this.width,this.height,-u,5),this.computeCentroids(),this.mergeVertices()},e.CubeGeometry.prototype=Object.create(e.Geometry.prototype),e.CylinderGeometry=function(t,r,i,o,n,a){e.Geometry.call(this),this.radiusTop=t=void 0!==t?t:20,this.radiusBottom=r=void 0!==r?r:20,this.height=i=void 0!==i?i:100,this.radialSegments=o=o||8,this.heightSegments=n=n||1,this.openEnded=a=void 0!==a?a:!1;var s,l,c=i/2,h=[],u=[];for(l=0;n>=l;l++){var p=[],d=[],f=l/n,m=f*(r-t)+t;for(s=0;o>=s;s++){var v=s/o,g=new e.Vector3;g.x=m*Math.sin(v*Math.PI*2),g.y=-f*i+c,g.z=m*Math.cos(v*Math.PI*2),this.vertices.push(g),p.push(this.vertices.length-1),d.push(new e.Vector2(v,1-f))}h.push(p),u.push(d)}var y,x,w=(r-t)/i;for(s=0;o>s;s++)for(0!==t?(y=this.vertices[h[0][s]].clone(),x=this.vertices[h[0][s+1]].clone()):(y=this.vertices[h[1][s]].clone(),x=this.vertices[h[1][s+1]].clone()),y.setY(Math.sqrt(y.x*y.x+y.z*y.z)*w).normalize(),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*w).normalize(),l=0;n>l;l++){var b=h[l][s],_=h[l+1][s],M=h[l+1][s+1],S=h[l][s+1],T=y.clone(),C=y.clone(),L=x.clone(),A=x.clone(),P=u[l][s].clone(),D=u[l+1][s].clone(),F=u[l+1][s+1].clone(),E=u[l][s+1].clone();this.faces.push(new e.Face3(b,_,S,[T,C,A])),this.faceVertexUvs[0].push([P,D,E]),this.faces.push(new e.Face3(_,M,S,[C.clone(),L,A.clone()])),this.faceVertexUvs[0].push([D.clone(),F,E.clone()])}if(a===!1&&t>0)for(this.vertices.push(new e.Vector3(0,c,0)),s=0;o>s;s++){var b=h[0][s],_=h[0][s+1],M=this.vertices.length-1,T=new e.Vector3(0,1,0),C=new e.Vector3(0,1,0),L=new e.Vector3(0,1,0),P=u[0][s].clone(),D=u[0][s+1].clone(),F=new e.Vector2(D.x,0);this.faces.push(new e.Face3(b,_,M,[T,C,L])),this.faceVertexUvs[0].push([P,D,F])}if(a===!1&&r>0)for(this.vertices.push(new e.Vector3(0,-c,0)),s=0;o>s;s++){var b=h[l][s+1],_=h[l][s],M=this.vertices.length-1,T=new e.Vector3(0,-1,0),C=new e.Vector3(0,-1,0),L=new e.Vector3(0,-1,0),P=u[l][s+1].clone(),D=u[l][s].clone(),F=new e.Vector2(D.x,1);this.faces.push(new e.Face3(b,_,M,[T,C,L])),this.faceVertexUvs[0].push([P,D,F])}this.computeCentroids(),this.computeFaceNormals()},e.CylinderGeometry.prototype=Object.create(e.Geometry.prototype),e.ExtrudeGeometry=function(t,r){return"undefined"==typeof t?void(t=[]):(e.Geometry.call(this),t=t instanceof Array?t:[t],this.shapebb=t[t.length-1].getBoundingBox(),this.addShapeList(t,r),this.computeCentroids(),void this.computeFaceNormals())},e.ExtrudeGeometry.prototype=Object.create(e.Geometry.prototype),e.ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var r=e.length,i=0;r>i;i++){var o=e[i];this.addShape(o,t)}},e.ExtrudeGeometry.prototype.addShape=function(t,r){function i(e,t,r){return t||console.log("die"),t.clone().multiplyScalar(r).add(e)}function o(e,t,r){return a(e,t,r)}function n(t,r,i){var o=Math.atan2(r.y-t.y,r.x-t.x),n=Math.atan2(i.y-t.y,i.x-t.x);o>n&&(n+=2*Math.PI);var a=(o+n)/2,s=-Math.cos(a),l=-Math.sin(a),c=new e.Vector2(s,l);return c}function a(t,r,i){var o,a,s,l,c,h,u=e.ExtrudeGeometry.__v1,p=e.ExtrudeGeometry.__v2,d=e.ExtrudeGeometry.__v3,f=e.ExtrudeGeometry.__v4,m=e.ExtrudeGeometry.__v5,v=e.ExtrudeGeometry.__v6;return u.set(t.x-r.x,t.y-r.y),p.set(t.x-i.x,t.y-i.y),o=u.normalize(),a=p.normalize(),d.set(-o.y,o.x),f.set(a.y,-a.x),m.copy(t).add(d),v.copy(t).add(f),m.equals(v)?f.clone():(m.copy(r).add(d),v.copy(i).add(f),s=o.dot(f),l=v.sub(m).dot(f),0===s&&(console.log("Either infinite or no solutions!"),0===l?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),c=l/s,0>c?n(t,r,i):(h=o.multiplyScalar(c).add(m),h.sub(t).clone()))}function s(){if(_){var e=0,t=q*e;for(K=0;Y>K;K++)X=B[K],u(X[2]+t,X[1]+t,X[0]+t,!0);for(e=S+2*b,t=q*e,K=0;Y>K;K++)X=B[K],u(X[0]+t,X[1]+t,X[2]+t,!1)}else{for(K=0;Y>K;K++)X=B[K],u(X[2],X[1],X[0],!0);for(K=0;Y>K;K++)X=B[K],u(X[0]+q*S,X[1]+q*S,X[2]+q*S,!1)}}function l(){var e=0;for(c(N,e),e+=N.length,F=0,E=U.length;E>F;F++)D=U[F],c(D,e),e+=D.length}function c(e,t){var r,i;for(K=e.length;--K>=0;){r=K,i=K-1,0>i&&(i=e.length-1);var o=0,n=S+2*b;for(o=0;n>o;o++){var a=q*o,s=q*(o+1),l=t+r+a,c=t+i+a,h=t+i+s,u=t+r+s;p(l,c,h,u,e,o,n,r,i)}}}function h(t,r,i){V.vertices.push(new e.Vector3(t,r,i))}function u(i,o,n,a){i+=R,o+=R,n+=R,V.faces.push(new e.Face3(i,o,n,null,null,L));var s=a?P.generateBottomUV(V,t,r,i,o,n):P.generateTopUV(V,t,r,i,o,n);V.faceVertexUvs[0].push(s)}function p(i,o,n,a,s,l,c,h,u){i+=R,o+=R,n+=R,a+=R,V.faces.push(new e.Face3(i,o,a,null,null,A)),V.faces.push(new e.Face3(o,n,a,null,null,A));var p=P.generateSideWallUV(V,t,s,r,i,o,n,a,l,c,h,u);V.faceVertexUvs[0].push([p[0],p[1],p[3]]),V.faceVertexUvs[0].push([p[1],p[2],p[3]])}var d,f,m,v,g,y=void 0!==r.amount?r.amount:100,x=void 0!==r.bevelThickness?r.bevelThickness:6,w=void 0!==r.bevelSize?r.bevelSize:x-2,b=void 0!==r.bevelSegments?r.bevelSegments:3,_=void 0!==r.bevelEnabled?r.bevelEnabled:!0,M=void 0!==r.curveSegments?r.curveSegments:12,S=void 0!==r.steps?r.steps:1,T=r.extrudePath,C=!1,L=r.material,A=r.extrudeMaterial,P=void 0!==r.UVGenerator?r.UVGenerator:e.ExtrudeGeometry.WorldUVGenerator;this.shapebb;T&&(d=T.getSpacedPoints(S),C=!0,_=!1,f=void 0!==r.frames?r.frames:new e.TubeGeometry.FrenetFrames(T,S,!1),m=new e.Vector3,v=new e.Vector3,g=new e.Vector3),_||(b=0,x=0,w=0);var D,F,E,V=this,R=this.vertices.length,z=t.extractPoints(M),I=z.shape,U=z.holes,O=!e.Shape.Utils.isClockWise(I);if(O){for(I=I.reverse(),F=0,E=U.length;E>F;F++)D=U[F],e.Shape.Utils.isClockWise(D)&&(U[F]=D.reverse());O=!1}var B=e.Shape.Utils.triangulateShape(I,U),N=I;for(F=0,E=U.length;E>F;F++)D=U[F],I=I.concat(D);for(var k,G,j,W,H,X,q=I.length,Y=B.length,Z=(N.length,180/Math.PI,[]),K=0,Q=N.length,J=Q-1,$=K+1;Q>K;K++,J++,$++){J===Q&&(J=0),$===Q&&($=0);N[K],N[J],N[$];Z[K]=o(N[K],N[J],N[$])}var ee,te=[],re=Z.concat();for(F=0,E=U.length;E>F;F++){for(D=U[F],ee=[],K=0,Q=D.length,J=Q-1,$=K+1;Q>K;K++,J++,$++)J===Q&&(J=0),$===Q&&($=0),ee[K]=o(D[K],D[J],D[$]);te.push(ee),re=re.concat(ee)}for(k=0;b>k;k++){for(j=k/b,W=x*(1-j),G=w*Math.sin(j*Math.PI/2),K=0,Q=N.length;Q>K;K++)H=i(N[K],Z[K],G),h(H.x,H.y,-W);for(F=0,E=U.length;E>F;F++)for(D=U[F],ee=te[F],K=0,Q=D.length;Q>K;K++)H=i(D[K],ee[K],G),h(H.x,H.y,-W)}for(G=w,K=0;q>K;K++)H=_?i(I[K],re[K],G):I[K],C?(v.copy(f.normals[0]).multiplyScalar(H.x),m.copy(f.binormals[0]).multiplyScalar(H.y),g.copy(d[0]).add(v).add(m),h(g.x,g.y,g.z)):h(H.x,H.y,0);var ie;for(ie=1;S>=ie;ie++)for(K=0;q>K;K++)H=_?i(I[K],re[K],G):I[K],C?(v.copy(f.normals[ie]).multiplyScalar(H.x),m.copy(f.binormals[ie]).multiplyScalar(H.y),g.copy(d[ie]).add(v).add(m),h(g.x,g.y,g.z)):h(H.x,H.y,y/S*ie);for(k=b-1;k>=0;k--){for(j=k/b,W=x*(1-j),
G=w*Math.sin(j*Math.PI/2),K=0,Q=N.length;Q>K;K++)H=i(N[K],Z[K],G),h(H.x,H.y,y+W);for(F=0,E=U.length;E>F;F++)for(D=U[F],ee=te[F],K=0,Q=D.length;Q>K;K++)H=i(D[K],ee[K],G),C?h(H.x,H.y+d[S-1].y,d[S-1].x+W):h(H.x,H.y,y+W)}s(),l()},e.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(t,r,i,o,n,a){var s=t.vertices[o].x,l=t.vertices[o].y,c=t.vertices[n].x,h=t.vertices[n].y,u=t.vertices[a].x,p=t.vertices[a].y;return[new e.Vector2(s,l),new e.Vector2(c,h),new e.Vector2(u,p)]},generateBottomUV:function(e,t,r,i,o,n){return this.generateTopUV(e,t,r,i,o,n)},generateSideWallUV:function(t,r,i,o,n,a,s,l,c,h,u,p){var d=t.vertices[n].x,f=t.vertices[n].y,m=t.vertices[n].z,v=t.vertices[a].x,g=t.vertices[a].y,y=t.vertices[a].z,x=t.vertices[s].x,w=t.vertices[s].y,b=t.vertices[s].z,_=t.vertices[l].x,M=t.vertices[l].y,S=t.vertices[l].z;return Math.abs(f-g)<.01?[new e.Vector2(d,1-m),new e.Vector2(v,1-y),new e.Vector2(x,1-b),new e.Vector2(_,1-S)]:[new e.Vector2(f,1-m),new e.Vector2(g,1-y),new e.Vector2(w,1-b),new e.Vector2(M,1-S)]}},e.ExtrudeGeometry.__v1=new e.Vector2,e.ExtrudeGeometry.__v2=new e.Vector2,e.ExtrudeGeometry.__v3=new e.Vector2,e.ExtrudeGeometry.__v4=new e.Vector2,e.ExtrudeGeometry.__v5=new e.Vector2,e.ExtrudeGeometry.__v6=new e.Vector2,e.ShapeGeometry=function(t,r){e.Geometry.call(this),t instanceof Array==!1&&(t=[t]),this.shapebb=t[t.length-1].getBoundingBox(),this.addShapeList(t,r),this.computeCentroids(),this.computeFaceNormals()},e.ShapeGeometry.prototype=Object.create(e.Geometry.prototype),e.ShapeGeometry.prototype.addShapeList=function(e,t){for(var r=0,i=e.length;i>r;r++)this.addShape(e[r],t);return this},e.ShapeGeometry.prototype.addShape=function(t,r){void 0===r&&(r={});var i,o,n,a=void 0!==r.curveSegments?r.curveSegments:12,s=r.material,l=void 0===r.UVGenerator?e.ExtrudeGeometry.WorldUVGenerator:r.UVGenerator,c=(this.shapebb,this.vertices.length),h=t.extractPoints(a),u=h.shape,p=h.holes,d=!e.Shape.Utils.isClockWise(u);if(d){for(u=u.reverse(),i=0,o=p.length;o>i;i++)n=p[i],e.Shape.Utils.isClockWise(n)&&(p[i]=n.reverse());d=!1}var f=e.Shape.Utils.triangulateShape(u,p),m=u;for(i=0,o=p.length;o>i;i++)n=p[i],u=u.concat(n);var v,g,y=u.length,x=f.length;m.length;for(i=0;y>i;i++)v=u[i],this.vertices.push(new e.Vector3(v.x,v.y,0));for(i=0;x>i;i++){g=f[i];var w=g[0]+c,b=g[1]+c,_=g[2]+c;this.faces.push(new e.Face3(w,b,_,null,null,s)),this.faceVertexUvs[0].push(l.generateBottomUV(this,t,r,w,b,_))}},e.LatheGeometry=function(t,r,i,o){e.Geometry.call(this),r=r||12,i=i||0,o=o||2*Math.PI;for(var n=1/(t.length-1),a=1/r,s=0,l=r;l>=s;s++)for(var c=i+s*a*o,h=Math.cos(c),u=Math.sin(c),p=0,d=t.length;d>p;p++){var f=t[p],m=new e.Vector3;m.x=h*f.x-u*f.y,m.y=u*f.x+h*f.y,m.z=f.z,this.vertices.push(m)}for(var v=t.length,s=0,l=r;l>s;s++)for(var p=0,d=t.length-1;d>p;p++){var g=p+v*s,y=g,x=g+v,h=g+1+v,w=g+1,b=s*a,_=p*n,M=b+a,S=_+n;this.faces.push(new e.Face3(y,x,w)),this.faceVertexUvs[0].push([new e.Vector2(b,_),new e.Vector2(M,_),new e.Vector2(b,S)]),this.faces.push(new e.Face3(x,h,w)),this.faceVertexUvs[0].push([new e.Vector2(M,_),new e.Vector2(M,S),new e.Vector2(b,S)])}this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},e.LatheGeometry.prototype=Object.create(e.Geometry.prototype),e.PlaneGeometry=function(t,r,i,o){e.Geometry.call(this),this.width=t,this.height=r,this.widthSegments=i||1,this.heightSegments=o||1;var n,a,s=t/2,l=r/2,c=this.widthSegments,h=this.heightSegments,u=c+1,p=h+1,d=this.width/c,f=this.height/h,m=new e.Vector3(0,0,1);for(a=0;p>a;a++)for(n=0;u>n;n++){var v=n*d-s,g=a*f-l;this.vertices.push(new e.Vector3(v,-g,0))}for(a=0;h>a;a++)for(n=0;c>n;n++){var y=n+u*a,x=n+u*(a+1),w=n+1+u*(a+1),b=n+1+u*a,_=new e.Vector2(n/c,1-a/h),M=new e.Vector2(n/c,1-(a+1)/h),S=new e.Vector2((n+1)/c,1-(a+1)/h),T=new e.Vector2((n+1)/c,1-a/h),C=new e.Face3(y,x,b);C.normal.copy(m),C.vertexNormals.push(m.clone(),m.clone(),m.clone()),this.faces.push(C),this.faceVertexUvs[0].push([_,M,T]),C=new e.Face3(x,w,b),C.normal.copy(m),C.vertexNormals.push(m.clone(),m.clone(),m.clone()),this.faces.push(C),this.faceVertexUvs[0].push([M.clone(),S,T.clone()])}this.computeCentroids()},e.PlaneGeometry.prototype=Object.create(e.Geometry.prototype),e.RingGeometry=function(t,r,i,o,n,a){e.Geometry.call(this),t=t||0,r=r||50,n=void 0!==n?n:0,a=void 0!==a?a:2*Math.PI,i=void 0!==i?Math.max(3,i):8,o=void 0!==o?Math.max(3,o):8;var s,l,c=[],h=t,u=(r-t)/o;for(s=0;o>=s;s++){for(l=0;i>=l;l++){var p=new e.Vector3,d=n+l/i*a;p.x=h*Math.cos(d),p.y=h*Math.sin(d),this.vertices.push(p),c.push(new e.Vector2((p.x/r+1)/2,(p.y/r+1)/2))}h+=u}var f=new e.Vector3(0,0,1);for(s=0;o>s;s++){var m=s*i;for(l=0;i>=l;l++){var d=l+m,v=d+s,g=d+i+s,y=d+i+1+s;this.faces.push(new e.Face3(v,g,y,[f.clone(),f.clone(),f.clone()])),this.faceVertexUvs[0].push([c[v].clone(),c[g].clone(),c[y].clone()]),v=d+s,g=d+i+1+s,y=d+1+s,this.faces.push(new e.Face3(v,g,y,[f.clone(),f.clone(),f.clone()])),this.faceVertexUvs[0].push([c[v].clone(),c[g].clone(),c[y].clone()])}}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,h)},e.RingGeometry.prototype=Object.create(e.Geometry.prototype),e.SphereGeometry=function(t,r,i,o,n,a,s){e.Geometry.call(this),this.radius=t=t||50,this.widthSegments=r=Math.max(3,Math.floor(r)||8),this.heightSegments=i=Math.max(2,Math.floor(i)||6),this.phiStart=o=void 0!==o?o:0,this.phiLength=n=void 0!==n?n:2*Math.PI,this.thetaStart=a=void 0!==a?a:0,this.thetaLength=s=void 0!==s?s:Math.PI;var l,c,h=[],u=[];for(c=0;i>=c;c++){var p=[],d=[];for(l=0;r>=l;l++){var f=l/r,m=c/i,v=new e.Vector3;v.x=-t*Math.cos(o+f*n)*Math.sin(a+m*s),v.y=t*Math.cos(a+m*s),v.z=t*Math.sin(o+f*n)*Math.sin(a+m*s),this.vertices.push(v),p.push(this.vertices.length-1),d.push(new e.Vector2(f,1-m))}h.push(p),u.push(d)}for(c=0;c<this.heightSegments;c++)for(l=0;l<this.widthSegments;l++){var g=h[c][l+1],y=h[c][l],x=h[c+1][l],w=h[c+1][l+1],b=this.vertices[g].clone().normalize(),_=this.vertices[y].clone().normalize(),M=this.vertices[x].clone().normalize(),S=this.vertices[w].clone().normalize(),T=u[c][l+1].clone(),C=u[c][l].clone(),L=u[c+1][l].clone(),A=u[c+1][l+1].clone();Math.abs(this.vertices[g].y)===this.radius?(T.x=(T.x+C.x)/2,this.faces.push(new e.Face3(g,x,w,[b,M,S])),this.faceVertexUvs[0].push([T,L,A])):Math.abs(this.vertices[x].y)===this.radius?(L.x=(L.x+A.x)/2,this.faces.push(new e.Face3(g,y,x,[b,_,M])),this.faceVertexUvs[0].push([T,C,L])):(this.faces.push(new e.Face3(g,y,w,[b,_,S])),this.faceVertexUvs[0].push([T,C,A]),this.faces.push(new e.Face3(y,x,w,[_.clone(),M,S.clone()])),this.faceVertexUvs[0].push([C.clone(),L,A.clone()]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},e.SphereGeometry.prototype=Object.create(e.Geometry.prototype),e.TextGeometry=function(t,r){r=r||{};var i=e.FontUtils.generateShapes(t,r);r.amount=void 0!==r.height?r.height:50,void 0===r.bevelThickness&&(r.bevelThickness=10),void 0===r.bevelSize&&(r.bevelSize=8),void 0===r.bevelEnabled&&(r.bevelEnabled=!1),e.ExtrudeGeometry.call(this,i,r)},e.TextGeometry.prototype=Object.create(e.ExtrudeGeometry.prototype),e.TorusGeometry=function(t,r,i,o,n){e.Geometry.call(this);this.radius=t||100,this.tube=r||40,this.radialSegments=i||8,this.tubularSegments=o||6,this.arc=n||2*Math.PI;for(var a=new e.Vector3,s=[],l=[],c=0;c<=this.radialSegments;c++)for(var h=0;h<=this.tubularSegments;h++){var u=h/this.tubularSegments*this.arc,p=c/this.radialSegments*Math.PI*2;a.x=this.radius*Math.cos(u),a.y=this.radius*Math.sin(u);var d=new e.Vector3;d.x=(this.radius+this.tube*Math.cos(p))*Math.cos(u),d.y=(this.radius+this.tube*Math.cos(p))*Math.sin(u),d.z=this.tube*Math.sin(p),this.vertices.push(d),s.push(new e.Vector2(h/this.tubularSegments,c/this.radialSegments)),l.push(d.clone().sub(a).normalize())}for(var c=1;c<=this.radialSegments;c++)for(var h=1;h<=this.tubularSegments;h++){var f=(this.tubularSegments+1)*c+h-1,m=(this.tubularSegments+1)*(c-1)+h-1,v=(this.tubularSegments+1)*(c-1)+h,g=(this.tubularSegments+1)*c+h,y=new e.Face3(f,m,g,[l[f],l[m],l[g]]);y.normal.add(l[f]),y.normal.add(l[m]),y.normal.add(l[g]),y.normal.normalize(),this.faces.push(y),this.faceVertexUvs[0].push([s[f].clone(),s[m].clone(),s[g].clone()]),y=new e.Face3(m,v,g,[l[m],l[v],l[g]]),y.normal.add(l[m]),y.normal.add(l[v]),y.normal.add(l[g]),y.normal.normalize(),this.faces.push(y),this.faceVertexUvs[0].push([s[m].clone(),s[v].clone(),s[g].clone()])}this.computeCentroids()},e.TorusGeometry.prototype=Object.create(e.Geometry.prototype),e.TorusKnotGeometry=function(t,r,i,o,n,a,s){function l(t,r,i,o,n){var a=Math.cos(t),s=Math.sin(t),l=r/i*t,c=Math.cos(l),h=o*(2+c)*.5*a,u=o*(2+c)*s*.5,p=n*o*Math.sin(l)*.5;return new e.Vector3(h,u,p)}e.Geometry.call(this);var c=this;this.radius=t||100,this.tube=r||40,this.radialSegments=i||64,this.tubularSegments=o||8,this.p=n||2,this.q=a||3,this.heightScale=s||1,this.grid=new Array(this.radialSegments);for(var h=new e.Vector3,u=new e.Vector3,p=new e.Vector3,d=0;d<this.radialSegments;++d){this.grid[d]=new Array(this.tubularSegments);var f=d/this.radialSegments*2*this.p*Math.PI,m=l(f,this.q,this.p,this.radius,this.heightScale),v=l(f+.01,this.q,this.p,this.radius,this.heightScale);h.subVectors(v,m),u.addVectors(v,m),p.crossVectors(h,u),u.crossVectors(p,h),p.normalize(),u.normalize();for(var g=0;g<this.tubularSegments;++g){var y=g/this.tubularSegments*2*Math.PI,x=-this.tube*Math.cos(y),w=this.tube*Math.sin(y),b=new e.Vector3;b.x=m.x+x*u.x+w*p.x,b.y=m.y+x*u.y+w*p.y,b.z=m.z+x*u.z+w*p.z,this.grid[d][g]=c.vertices.push(b)-1}}for(var d=0;d<this.radialSegments;++d)for(var g=0;g<this.tubularSegments;++g){var _=(d+1)%this.radialSegments,M=(g+1)%this.tubularSegments,S=this.grid[d][g],T=this.grid[_][g],C=this.grid[_][M],L=this.grid[d][M],A=new e.Vector2(d/this.radialSegments,g/this.tubularSegments),P=new e.Vector2((d+1)/this.radialSegments,g/this.tubularSegments),D=new e.Vector2((d+1)/this.radialSegments,(g+1)/this.tubularSegments),F=new e.Vector2(d/this.radialSegments,(g+1)/this.tubularSegments);this.faces.push(new e.Face3(S,T,L)),this.faceVertexUvs[0].push([A,P,F]),this.faces.push(new e.Face3(T,C,L)),this.faceVertexUvs[0].push([P.clone(),D,F.clone()])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},e.TorusKnotGeometry.prototype=Object.create(e.Geometry.prototype),e.TubeGeometry=function(t,r,i,o,n){function a(t,r,i){return L.vertices.push(new e.Vector3(t,r,i))-1}e.Geometry.call(this),this.path=t,this.segments=r||64,this.radius=i||1,this.radialSegments=o||8,this.closed=n||!1,this.grid=[];var s,l,c,h,u,p,d,f,m,v,g,y,x,w,b,_,M,S,T,C,L=this,A=this.segments+1,P=new e.Vector3,D=new e.TubeGeometry.FrenetFrames(this.path,this.segments,this.closed),F=D.tangents,E=D.normals,V=D.binormals;for(this.tangents=F,this.normals=E,this.binormals=V,m=0;A>m;m++)for(this.grid[m]=[],h=m/(A-1),f=t.getPointAt(h),s=F[m],l=E[m],c=V[m],v=0;v<this.radialSegments;v++)u=v/this.radialSegments*2*Math.PI,p=-this.radius*Math.cos(u),d=this.radius*Math.sin(u),P.copy(f),P.x+=p*l.x+d*c.x,P.y+=p*l.y+d*c.y,P.z+=p*l.z+d*c.z,this.grid[m][v]=a(P.x,P.y,P.z);for(m=0;m<this.segments;m++)for(v=0;v<this.radialSegments;v++)g=this.closed?(m+1)%this.segments:m+1,y=(v+1)%this.radialSegments,x=this.grid[m][v],w=this.grid[g][v],b=this.grid[g][y],_=this.grid[m][y],M=new e.Vector2(m/this.segments,v/this.radialSegments),S=new e.Vector2((m+1)/this.segments,v/this.radialSegments),T=new e.Vector2((m+1)/this.segments,(v+1)/this.radialSegments),C=new e.Vector2(m/this.segments,(v+1)/this.radialSegments),this.faces.push(new e.Face3(x,w,_)),this.faceVertexUvs[0].push([M,S,C]),this.faces.push(new e.Face3(w,b,_)),this.faceVertexUvs[0].push([S.clone(),T,C.clone()]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},e.TubeGeometry.prototype=Object.create(e.Geometry.prototype),e.TubeGeometry.FrenetFrames=function(t,r,i){function o(){f[0]=new e.Vector3,m[0]=new e.Vector3,a=Number.MAX_VALUE,s=Math.abs(d[0].x),l=Math.abs(d[0].y),c=Math.abs(d[0].z),a>=s&&(a=s,p.set(1,0,0)),a>=l&&(a=l,p.set(0,1,0)),a>=c&&p.set(0,0,1),v.crossVectors(d[0],p).normalize(),f[0].crossVectors(d[0],v),m[0].crossVectors(d[0],f[0])}var n,a,s,l,c,h,u,p=(new e.Vector3,new e.Vector3),d=(new e.Vector3,[]),f=[],m=[],v=new e.Vector3,g=new e.Matrix4,y=r+1,x=1e-4;for(this.tangents=d,this.normals=f,this.binormals=m,h=0;y>h;h++)u=h/(y-1),d[h]=t.getTangentAt(u),d[h].normalize();for(o(),h=1;y>h;h++)f[h]=f[h-1].clone(),m[h]=m[h-1].clone(),v.crossVectors(d[h-1],d[h]),v.length()>x&&(v.normalize(),n=Math.acos(e.Math.clamp(d[h-1].dot(d[h]),-1,1)),f[h].applyMatrix4(g.makeRotationAxis(v,n))),m[h].crossVectors(d[h],f[h]);if(i)for(n=Math.acos(e.Math.clamp(f[0].dot(f[y-1]),-1,1)),n/=y-1,d[0].dot(v.crossVectors(f[0],f[y-1]))>0&&(n=-n),h=1;y>h;h++)f[h].applyMatrix4(g.makeRotationAxis(d[h],n*h)),m[h].crossVectors(d[h],f[h])},e.PolyhedronGeometry=function(t,r,i,o){function n(t){var r=t.normalize().clone();r.index=u.vertices.push(r)-1;var i=l(t)/2/Math.PI+.5,o=c(t)/Math.PI+.5;return r.uv=new e.Vector2(i,1-o),r}function a(t,r,i){var o=new e.Face3(t.index,r.index,i.index,[t.clone(),r.clone(),i.clone()]);o.centroid.add(t).add(r).add(i).divideScalar(3),u.faces.push(o);var n=l(o.centroid);u.faceVertexUvs[0].push([h(t.uv,t,n),h(r.uv,r,n),h(i.uv,i,n)])}function s(e,t){for(var r=Math.pow(2,t),i=(Math.pow(4,t),n(u.vertices[e.a])),o=n(u.vertices[e.b]),s=n(u.vertices[e.c]),l=[],c=0;r>=c;c++){l[c]=[];for(var h=n(i.clone().lerp(s,c/r)),p=n(o.clone().lerp(s,c/r)),d=r-c,f=0;d>=f;f++)0==f&&c==r?l[c][f]=h:l[c][f]=n(h.clone().lerp(p,f/d))}for(var c=0;r>c;c++)for(var f=0;2*(r-c)-1>f;f++){var m=Math.floor(f/2);f%2==0?a(l[c][m+1],l[c+1][m],l[c][m]):a(l[c][m+1],l[c+1][m+1],l[c+1][m])}}function l(e){return Math.atan2(e.z,-e.x)}function c(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}function h(t,r,i){return 0>i&&1===t.x&&(t=new e.Vector2(t.x-1,t.y)),0===r.x&&0===r.z&&(t=new e.Vector2(i/2/Math.PI+.5,t.y)),t.clone()}e.Geometry.call(this),i=i||1,o=o||0;for(var u=this,p=0,d=t.length;d>p;p++)n(new e.Vector3(t[p][0],t[p][1],t[p][2]));for(var f=this.vertices,m=[],p=0,d=r.length;d>p;p++){var v=f[r[p][0]],g=f[r[p][1]],y=f[r[p][2]];m[p]=new e.Face3(v.index,g.index,y.index,[v.clone(),g.clone(),y.clone()])}for(var p=0,d=m.length;d>p;p++)s(m[p],o);for(var p=0,d=this.faceVertexUvs[0].length;d>p;p++){var x=this.faceVertexUvs[0][p],w=x[0].x,b=x[1].x,_=x[2].x,M=Math.max(w,Math.max(b,_)),S=Math.min(w,Math.min(b,_));M>.9&&.1>S&&(.2>w&&(x[0].x+=1),.2>b&&(x[1].x+=1),.2>_&&(x[2].x+=1))}for(var p=0,d=this.vertices.length;d>p;p++)this.vertices[p].multiplyScalar(i);this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,i)},e.PolyhedronGeometry.prototype=Object.create(e.Geometry.prototype),e.IcosahedronGeometry=function(t,r){this.radius=t,this.detail=r;var i=(1+Math.sqrt(5))/2,o=[[-1,i,0],[1,i,0],[-1,-i,0],[1,-i,0],[0,-1,i],[0,1,i],[0,-1,-i],[0,1,-i],[i,0,-1],[i,0,1],[-i,0,-1],[-i,0,1]],n=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]];e.PolyhedronGeometry.call(this,o,n,t,r)},e.IcosahedronGeometry.prototype=Object.create(e.Geometry.prototype),e.OctahedronGeometry=function(t,r){var i=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],o=[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]];e.PolyhedronGeometry.call(this,i,o,t,r)},e.OctahedronGeometry.prototype=Object.create(e.Geometry.prototype),e.TetrahedronGeometry=function(t,r){var i=[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],o=[[2,1,0],[0,3,2],[1,3,0],[2,3,1]];e.PolyhedronGeometry.call(this,i,o,t,r)},e.TetrahedronGeometry.prototype=Object.create(e.Geometry.prototype),e.ParametricGeometry=function(t,r,i){e.Geometry.call(this);var o,n,a,s,l,c=this.vertices,h=this.faces,u=this.faceVertexUvs[0],p=r+1;for(o=0;i>=o;o++)for(l=o/i,n=0;r>=n;n++)s=n/r,a=t(s,l),c.push(a);var d,f,m,v,g,y,x,w;for(o=0;i>o;o++)for(n=0;r>n;n++)d=o*p+n,f=o*p+n+1,m=(o+1)*p+n+1,v=(o+1)*p+n,g=new e.Vector2(n/r,o/i),y=new e.Vector2((n+1)/r,o/i),x=new e.Vector2((n+1)/r,(o+1)/i),w=new e.Vector2(n/r,(o+1)/i),h.push(new e.Face3(d,f,v)),u.push([g,y,w]),h.push(new e.Face3(f,m,v)),u.push([y.clone(),x,w.clone()]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},e.ParametricGeometry.prototype=Object.create(e.Geometry.prototype),e.AxisHelper=function(t){t=t||1;var r=new e.Geometry;r.vertices.push(new e.Vector3,new e.Vector3(t,0,0),new e.Vector3,new e.Vector3(0,t,0),new e.Vector3,new e.Vector3(0,0,t)),r.colors.push(new e.Color(16711680),new e.Color(16755200),new e.Color(65280),new e.Color(11206400),new e.Color(255),new e.Color(43775));var i=new e.LineBasicMaterial({vertexColors:e.VertexColors});e.Line.call(this,r,i,e.LinePieces)},e.AxisHelper.prototype=Object.create(e.Line.prototype),e.ArrowHelper=function(t,r,i,o){e.Object3D.call(this),void 0===o&&(o=16776960),void 0===i&&(i=1),this.position=r;var n=new e.Geometry;n.vertices.push(new e.Vector3(0,0,0)),n.vertices.push(new e.Vector3(0,1,0)),this.line=new e.Line(n,new e.LineBasicMaterial({color:o})),this.line.matrixAutoUpdate=!1,this.add(this.line);var a=new e.CylinderGeometry(0,.05,.25,5,1);a.applyMatrix((new e.Matrix4).makeTranslation(0,.875,0)),this.cone=new e.Mesh(a,new e.MeshBasicMaterial({color:o})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(i)},e.ArrowHelper.prototype=Object.create(e.Object3D.prototype),e.ArrowHelper.prototype.setDirection=function(){var t,r=new e.Vector3;return function(e){e.y>.99999?this.quaternion.set(0,0,0,1):e.y<-.99999?this.quaternion.set(1,0,0,0):(r.set(e.z,0,-e.x).normalize(),t=Math.acos(e.y),this.quaternion.setFromAxisAngle(r,t))}}(),e.ArrowHelper.prototype.setLength=function(e){this.scale.set(e,e,e)},e.ArrowHelper.prototype.setColor=function(e){this.line.material.color.setHex(e),this.cone.material.color.setHex(e)},e.BoxHelper=function(t){var r=[new e.Vector3(1,1,1),new e.Vector3(-1,1,1),new e.Vector3(-1,-1,1),new e.Vector3(1,-1,1),new e.Vector3(1,1,-1),new e.Vector3(-1,1,-1),new e.Vector3(-1,-1,-1),new e.Vector3(1,-1,-1)];this.vertices=r;var i=new e.Geometry;i.vertices.push(r[0],r[1],r[1],r[2],r[2],r[3],r[3],r[0],r[4],r[5],r[5],r[6],r[6],r[7],r[7],r[4],r[0],r[4],r[1],r[5],r[2],r[6],r[3],r[7]),e.Line.call(this,i,new e.LineBasicMaterial({color:16776960}),e.LinePieces),void 0!==t&&this.update(t)},e.BoxHelper.prototype=Object.create(e.Line.prototype),e.BoxHelper.prototype.update=function(e){var t=e.geometry;null===t.boundingBox&&t.computeBoundingBox();var r=t.boundingBox.min,i=t.boundingBox.max,o=this.vertices;o[0].set(i.x,i.y,i.z),o[1].set(r.x,i.y,i.z),o[2].set(r.x,r.y,i.z),o[3].set(i.x,r.y,i.z),o[4].set(i.x,i.y,r.z),o[5].set(r.x,i.y,r.z),o[6].set(r.x,r.y,r.z),o[7].set(i.x,r.y,r.z),this.geometry.computeBoundingSphere(),this.geometry.verticesNeedUpdate=!0,this.matrixAutoUpdate=!1,this.matrixWorld=e.matrixWorld},e.BoundingBoxHelper=function(t,r){var i=r||8947848;this.object=t,this.box=new e.Box3,e.Mesh.call(this,new e.CubeGeometry(1,1,1),new e.MeshBasicMaterial({color:i,wireframe:!0}))},e.BoundingBoxHelper.prototype=Object.create(e.Mesh.prototype),e.BoundingBoxHelper.prototype.update=function(){this.box.setFromObject(this.object),this.box.size(this.scale),this.box.center(this.position)},e.CameraHelper=function(t){function r(e,t,r){i(e,r),i(t,r)}function i(t,r){o.vertices.push(new e.Vector3),o.colors.push(new e.Color(r)),void 0===a[t]&&(a[t]=[]),a[t].push(o.vertices.length-1)}var o=new e.Geometry,n=new e.LineBasicMaterial({color:16777215,vertexColors:e.FaceColors}),a={},s=16755200,l=16711680,c=43775,h=16777215,u=3355443;r("n1","n2",s),r("n2","n4",s),r("n4","n3",s),r("n3","n1",s),r("f1","f2",s),r("f2","f4",s),r("f4","f3",s),r("f3","f1",s),r("n1","f1",s),r("n2","f2",s),r("n3","f3",s),r("n4","f4",s),r("p","n1",l),r("p","n2",l),r("p","n3",l),r("p","n4",l),r("u1","u2",c),r("u2","u3",c),r("u3","u1",c),r("c","t",h),r("p","c",u),r("cn1","cn2",u),r("cn3","cn4",u),r("cf1","cf2",u),r("cf3","cf4",u),e.Line.call(this,o,n,e.LinePieces),this.camera=t,this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=a,this.update()},e.CameraHelper.prototype=Object.create(e.Line.prototype),e.CameraHelper.prototype.update=function(){var t=new e.Vector3,r=new e.Camera,i=new e.Projector;return function(){function e(e,n,a,s){t.set(n,a,s),i.unprojectVector(t,r);var l=o.pointMap[e];if(void 0!==l)for(var c=0,h=l.length;h>c;c++)o.geometry.vertices[l[c]].copy(t)}var o=this,n=1,a=1;r.projectionMatrix.copy(this.camera.projectionMatrix),e("c",0,0,-1),e("t",0,0,1),e("n1",-n,-a,-1),e("n2",n,-a,-1),e("n3",-n,a,-1),e("n4",n,a,-1),e("f1",-n,-a,1),e("f2",n,-a,1),e("f3",-n,a,1),e("f4",n,a,1),e("u1",.7*n,1.1*a,-1),e("u2",.7*-n,1.1*a,-1),e("u3",0,2*a,-1),e("cf1",-n,0,1),e("cf2",n,0,1),e("cf3",0,-a,1),e("cf4",0,a,1),e("cn1",-n,0,-1),e("cn2",n,0,-1),e("cn3",0,-a,-1),e("cn4",0,a,-1),this.geometry.verticesNeedUpdate=!0}}(),e.DirectionalLightHelper=function(t,r){e.Object3D.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,r=r||1;var i=new e.PlaneGeometry(r,r),o=new e.MeshBasicMaterial({wireframe:!0,fog:!1});o.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.lightPlane=new e.Mesh(i,o),this.add(this.lightPlane),i=new e.Geometry,i.vertices.push(new e.Vector3),i.vertices.push(new e.Vector3),o=new e.LineBasicMaterial({fog:!1}),o.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.targetLine=new e.Line(i,o),this.add(this.targetLine),this.update()},e.DirectionalLightHelper.prototype=Object.create(e.Object3D.prototype),e.DirectionalLightHelper.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},e.DirectionalLightHelper.prototype.update=function(){var t=new e.Vector3,r=new e.Vector3,i=new e.Vector3;return function(){t.getPositionFromMatrix(this.light.matrixWorld),r.getPositionFromMatrix(this.light.target.matrixWorld),i.subVectors(r,t),this.lightPlane.lookAt(i),this.lightPlane.material.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.targetLine.geometry.vertices[1].copy(i),this.targetLine.geometry.verticesNeedUpdate=!0,this.targetLine.material.color.copy(this.lightPlane.material.color)}}(),e.FaceNormalsHelper=function(t,r,i,o){this.object=t,this.size=r||1;for(var n=i||16776960,a=o||1,s=new e.Geometry,l=this.object.geometry.faces,c=0,h=l.length;h>c;c++)s.vertices.push(new e.Vector3),s.vertices.push(new e.Vector3);e.Line.call(this,s,new e.LineBasicMaterial({color:n,linewidth:a}),e.LinePieces),this.matrixAutoUpdate=!1,this.normalMatrix=new e.Matrix3,this.update()},e.FaceNormalsHelper.prototype=Object.create(e.Line.prototype),e.FaceNormalsHelper.prototype.update=function(t){var r=new e.Vector3;return function(e){this.object.updateMatrixWorld(!0),this.normalMatrix.getNormalMatrix(this.object.matrixWorld);for(var t=this.geometry.vertices,i=this.object.geometry.faces,o=this.object.matrixWorld,n=0,a=i.length;a>n;n++){var s=i[n];r.copy(s.normal).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size);var l=2*n;t[l].copy(s.centroid).applyMatrix4(o),t[l+1].addVectors(t[l],r)}return this.geometry.verticesNeedUpdate=!0,this}}(),e.GridHelper=function(t,r){var i=new e.Geometry,o=new e.LineBasicMaterial({vertexColors:e.VertexColors});this.color1=new e.Color(4473924),this.color2=new e.Color(8947848);for(var n=-t;t>=n;n+=r){i.vertices.push(new e.Vector3(-t,0,n),new e.Vector3(t,0,n),new e.Vector3(n,0,-t),new e.Vector3(n,0,t));var a=0===n?this.color1:this.color2;i.colors.push(a,a,a,a)}e.Line.call(this,i,o,e.LinePieces)},e.GridHelper.prototype=Object.create(e.Line.prototype),e.GridHelper.prototype.setColors=function(e,t){this.color1.set(e),this.color2.set(t),this.geometry.colorsNeedUpdate=!0},e.HemisphereLightHelper=function(t,r,i,o){e.Object3D.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.colors=[new e.Color,new e.Color];var n=new e.SphereGeometry(r,4,2);n.applyMatrix((new e.Matrix4).makeRotationX(-Math.PI/2));for(var a=0,s=8;s>a;a++)n.faces[a].color=this.colors[4>a?0:1];var l=new e.MeshBasicMaterial({vertexColors:e.FaceColors,wireframe:!0});this.lightSphere=new e.Mesh(n,l),this.add(this.lightSphere),this.update()},e.HemisphereLightHelper.prototype=Object.create(e.Object3D.prototype),e.HemisphereLightHelper.prototype.dispose=function(){this.lightSphere.geometry.dispose(),this.lightSphere.material.dispose()},e.HemisphereLightHelper.prototype.update=function(){var t=new e.Vector3;return function(){this.colors[0].copy(this.light.color).multiplyScalar(this.light.intensity),this.colors[1].copy(this.light.groundColor).multiplyScalar(this.light.intensity),this.lightSphere.lookAt(t.getPositionFromMatrix(this.light.matrixWorld).negate()),this.lightSphere.geometry.colorsNeedUpdate=!0}}(),e.PointLightHelper=function(t,r){this.light=t,this.light.updateMatrixWorld();var i=new e.SphereGeometry(r,4,2),o=new e.MeshBasicMaterial({wireframe:!0,fog:!1});o.color.copy(this.light.color).multiplyScalar(this.light.intensity),e.Mesh.call(this,i,o),this.matrixWorld=this.light.matrixWorld,this.matrixAutoUpdate=!1},e.PointLightHelper.prototype=Object.create(e.Mesh.prototype),e.PointLightHelper.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},e.PointLightHelper.prototype.update=function(){this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)},e.SpotLightHelper=function(t){e.Object3D.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1;var r=new e.CylinderGeometry(0,1,1,8,1,!0);r.applyMatrix((new e.Matrix4).makeTranslation(0,-.5,0)),r.applyMatrix((new e.Matrix4).makeRotationX(-Math.PI/2));var i=new e.MeshBasicMaterial({wireframe:!0,fog:!1});this.cone=new e.Mesh(r,i),this.add(this.cone),this.update()},e.SpotLightHelper.prototype=Object.create(e.Object3D.prototype),e.SpotLightHelper.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},e.SpotLightHelper.prototype.update=function(){var t=new e.Vector3,r=new e.Vector3;return function(){var e=this.light.distance?this.light.distance:1e4,i=e*Math.tan(this.light.angle);this.cone.scale.set(i,i,e),t.getPositionFromMatrix(this.light.matrixWorld),r.getPositionFromMatrix(this.light.target.matrixWorld),this.cone.lookAt(r.sub(t)),this.cone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)}}(),e.VertexNormalsHelper=function(t,r,i,o){this.object=t,this.size=r||1;for(var n=i||16711680,a=o||1,s=new e.Geometry,l=(t.geometry.vertices,t.geometry.faces),c=0,h=l.length;h>c;c++)for(var u=l[c],p=0,d=u.vertexNormals.length;d>p;p++)s.vertices.push(new e.Vector3),s.vertices.push(new e.Vector3);e.Line.call(this,s,new e.LineBasicMaterial({color:n,linewidth:a}),e.LinePieces),this.matrixAutoUpdate=!1,this.normalMatrix=new e.Matrix3,this.update()},e.VertexNormalsHelper.prototype=Object.create(e.Line.prototype),e.VertexNormalsHelper.prototype.update=function(t){var r=new e.Vector3;return function(e){var t=["a","b","c","d"];this.object.updateMatrixWorld(!0),this.normalMatrix.getNormalMatrix(this.object.matrixWorld);for(var i=this.geometry.vertices,o=this.object.geometry.vertices,n=this.object.geometry.faces,a=this.object.matrixWorld,s=0,l=0,c=n.length;c>l;l++)for(var h=n[l],u=0,p=h.vertexNormals.length;p>u;u++){var d=h[t[u]],f=o[d],m=h.vertexNormals[u];i[s].copy(f).applyMatrix4(a),r.copy(m).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size),r.add(i[s]),s+=1,i[s].copy(r),s+=1}return this.geometry.verticesNeedUpdate=!0,this}}(),e.VertexTangentsHelper=function(t,r,i,o){this.object=t,this.size=r||1;for(var n=i||255,a=o||1,s=new e.Geometry,l=(t.geometry.vertices,t.geometry.faces),c=0,h=l.length;h>c;c++)for(var u=l[c],p=0,d=u.vertexTangents.length;d>p;p++)s.vertices.push(new e.Vector3),s.vertices.push(new e.Vector3);e.Line.call(this,s,new e.LineBasicMaterial({color:n,linewidth:a}),e.LinePieces),this.matrixAutoUpdate=!1,this.update()},e.VertexTangentsHelper.prototype=Object.create(e.Line.prototype),e.VertexTangentsHelper.prototype.update=function(t){var r=new e.Vector3;return function(e){var t=["a","b","c","d"];this.object.updateMatrixWorld(!0);for(var i=this.geometry.vertices,o=this.object.geometry.vertices,n=this.object.geometry.faces,a=this.object.matrixWorld,s=0,l=0,c=n.length;c>l;l++)for(var h=n[l],u=0,p=h.vertexTangents.length;p>u;u++){var d=h[t[u]],f=o[d],m=h.vertexTangents[u];i[s].copy(f).applyMatrix4(a),r.copy(m).transformDirection(a).multiplyScalar(this.size),r.add(i[s]),s+=1,i[s].copy(r),s+=1}return this.geometry.verticesNeedUpdate=!0,this}}(),e.WireframeHelper=function(t){for(var r=[0,0],i={},o=function(e,t){return e-t},n=["a","b","c","d"],a=new e.Geometry,s=t.geometry.vertices,l=t.geometry.faces,c=0,h=l.length;h>c;c++)for(var u=l[c],p=0;3>p;p++){r[0]=u[n[p]],r[1]=u[n[(p+1)%3]],r.sort(o);var d=r.toString();void 0===i[d]&&(a.vertices.push(s[r[0]]),a.vertices.push(s[r[1]]),i[d]=!0)}e.Line.call(this,a,new e.LineBasicMaterial({color:16777215}),e.LinePieces),this.matrixAutoUpdate=!1,this.matrixWorld=t.matrixWorld},e.WireframeHelper.prototype=Object.create(e.Line.prototype),e.ImmediateRenderObject=function(){e.Object3D.call(this),this.render=function(e){}},e.ImmediateRenderObject.prototype=Object.create(e.Object3D.prototype),e.LensFlare=function(t,r,i,o,n){e.Object3D.call(this),this.lensFlares=[],this.positionScreen=new e.Vector3,this.customUpdateCallback=void 0,void 0!==t&&this.add(t,r,i,o,n)},e.LensFlare.prototype=Object.create(e.Object3D.prototype),e.LensFlare.prototype.add=function(t,r,i,o,n,a){void 0===r&&(r=-1),void 0===i&&(i=0),void 0===a&&(a=1),void 0===n&&(n=new e.Color(16777215)),void 0===o&&(o=e.NormalBlending),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:t,size:r,distance:i,x:0,y:0,z:0,scale:1,rotation:1,opacity:a,color:n,blending:o})},e.LensFlare.prototype.updateLensFlares=function(){var e,t,r=this.lensFlares.length,i=2*-this.positionScreen.x,o=2*-this.positionScreen.y;for(e=0;r>e;e++)t=this.lensFlares[e],t.x=this.positionScreen.x+i*t.distance,t.y=this.positionScreen.y+o*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)},e.MorphBlendMesh=function(t,r){e.Mesh.call(this,t,r),this.animationsMap={},this.animationsList=[];var i=this.geometry.morphTargets.length,o="__default",n=0,a=i-1,s=i/1;this.createAnimation(o,n,a,s),this.setAnimationWeight(o,1)},e.MorphBlendMesh.prototype=Object.create(e.Mesh.prototype),e.MorphBlendMesh.prototype.createAnimation=function(e,t,r,i){var o={startFrame:t,endFrame:r,length:r-t+1,fps:i,duration:(r-t)/i,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=o,this.animationsList.push(o)},e.MorphBlendMesh.prototype.autoCreateAnimations=function(e){for(var t,r=/([a-z]+)(\d+)/,i={},o=this.geometry,n=0,a=o.morphTargets.length;a>n;n++){var s=o.morphTargets[n],l=s.name.match(r);if(l&&l.length>1){var c=l[1];l[2];i[c]||(i[c]={start:1/0,end:-(1/0)});var h=i[c];n<h.start&&(h.start=n),n>h.end&&(h.end=n),t||(t=c)}}for(var c in i){var h=i[c];this.createAnimation(c,h.start,h.end,e)}this.firstAnimation=t},e.MorphBlendMesh.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},e.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},e.MorphBlendMesh.prototype.setAnimationFPS=function(e,t){var r=this.animationsMap[e];r&&(r.fps=t,r.duration=(r.end-r.start)/r.fps)},e.MorphBlendMesh.prototype.setAnimationDuration=function(e,t){var r=this.animationsMap[e];r&&(r.duration=t,r.fps=(r.end-r.start)/r.duration)},e.MorphBlendMesh.prototype.setAnimationWeight=function(e,t){var r=this.animationsMap[e];
r&&(r.weight=t)},e.MorphBlendMesh.prototype.setAnimationTime=function(e,t){var r=this.animationsMap[e];r&&(r.time=t)},e.MorphBlendMesh.prototype.getAnimationTime=function(e){var t=0,r=this.animationsMap[e];return r&&(t=r.time),t},e.MorphBlendMesh.prototype.getAnimationDuration=function(e){var t=-1,r=this.animationsMap[e];return r&&(t=r.duration),t},e.MorphBlendMesh.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("animation["+e+"] undefined")},e.MorphBlendMesh.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},e.MorphBlendMesh.prototype.update=function(t){for(var r=0,i=this.animationsList.length;i>r;r++){var o=this.animationsList[r];if(o.active){var n=o.duration/o.length;o.time+=o.direction*t,o.mirroredLoop?(o.time>o.duration||o.time<0)&&(o.direction*=-1,o.time>o.duration&&(o.time=o.duration,o.directionBackwards=!0),o.time<0&&(o.time=0,o.directionBackwards=!1)):(o.time=o.time%o.duration,o.time<0&&(o.time+=o.duration));var a=o.startFrame+e.Math.clamp(Math.floor(o.time/n),0,o.length-1),s=o.weight;a!==o.currentFrame&&(this.morphTargetInfluences[o.lastFrame]=0,this.morphTargetInfluences[o.currentFrame]=1*s,this.morphTargetInfluences[a]=0,o.lastFrame=o.currentFrame,o.currentFrame=a);var l=o.time%n/n;o.directionBackwards&&(l=1-l),this.morphTargetInfluences[o.currentFrame]=l*s,this.morphTargetInfluences[o.lastFrame]=(1-l)*s}}},e.LensFlarePlugin=function(){function t(e,t){var i=r.createProgram(),o=r.createShader(r.FRAGMENT_SHADER),n=r.createShader(r.VERTEX_SHADER),a="precision "+t+" float;\n";return r.shaderSource(o,a+e.fragmentShader),r.shaderSource(n,a+e.vertexShader),r.compileShader(o),r.compileShader(n),r.attachShader(i,o),r.attachShader(i,n),r.linkProgram(i),i}var r,i,o,n={};this.init=function(a){r=a.context,i=a,o=a.getPrecision(),n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var s=0;n.vertices[s++]=-1,n.vertices[s++]=-1,n.vertices[s++]=0,n.vertices[s++]=0,n.vertices[s++]=1,n.vertices[s++]=-1,n.vertices[s++]=1,n.vertices[s++]=0,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=-1,n.vertices[s++]=1,n.vertices[s++]=0,n.vertices[s++]=1,s=0,n.faces[s++]=0,n.faces[s++]=1,n.faces[s++]=2,n.faces[s++]=0,n.faces[s++]=2,n.faces[s++]=3,n.vertexBuffer=r.createBuffer(),n.elementBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,n.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,n.vertices,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n.elementBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,n.faces,r.STATIC_DRAW),n.tempTexture=r.createTexture(),n.occlusionTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,n.tempTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGB,16,16,0,r.RGB,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.bindTexture(r.TEXTURE_2D,n.occlusionTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,16,16,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0?(n.hasVertexTexture=!1,n.program=t(e.ShaderFlares.lensFlare,o)):(n.hasVertexTexture=!0,n.program=t(e.ShaderFlares.lensFlareVertexTexture,o)),n.attributes={},n.uniforms={},n.attributes.vertex=r.getAttribLocation(n.program,"position"),n.attributes.uv=r.getAttribLocation(n.program,"uv"),n.uniforms.renderType=r.getUniformLocation(n.program,"renderType"),n.uniforms.map=r.getUniformLocation(n.program,"map"),n.uniforms.occlusionMap=r.getUniformLocation(n.program,"occlusionMap"),n.uniforms.opacity=r.getUniformLocation(n.program,"opacity"),n.uniforms.color=r.getUniformLocation(n.program,"color"),n.uniforms.scale=r.getUniformLocation(n.program,"scale"),n.uniforms.rotation=r.getUniformLocation(n.program,"rotation"),n.uniforms.screenPosition=r.getUniformLocation(n.program,"screenPosition")},this.render=function(t,o,a,s){var l=t.__webglFlares,c=l.length;if(c){var h=new e.Vector3,u=s/a,p=.5*a,d=.5*s,f=16/s,m=new e.Vector2(f*u,f),v=new e.Vector3(1,1,0),g=new e.Vector2(1,1),y=n.uniforms,x=n.attributes;r.useProgram(n.program),r.enableVertexAttribArray(n.attributes.vertex),r.enableVertexAttribArray(n.attributes.uv),r.uniform1i(y.occlusionMap,0),r.uniform1i(y.map,1),r.bindBuffer(r.ARRAY_BUFFER,n.vertexBuffer),r.vertexAttribPointer(x.vertex,2,r.FLOAT,!1,16,0),r.vertexAttribPointer(x.uv,2,r.FLOAT,!1,16,8),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n.elementBuffer),r.disable(r.CULL_FACE),r.depthMask(!1);var w,b,_,M,S;for(w=0;c>w;w++)if(f=16/s,m.set(f*u,f),M=l[w],h.set(M.matrixWorld.elements[12],M.matrixWorld.elements[13],M.matrixWorld.elements[14]),h.applyMatrix4(o.matrixWorldInverse),h.applyProjection(o.projectionMatrix),v.copy(h),g.x=v.x*p+p,g.y=v.y*d+d,n.hasVertexTexture||g.x>0&&g.x<a&&g.y>0&&g.y<s)for(r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,n.tempTexture),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGB,g.x-8,g.y-8,16,16,0),r.uniform1i(y.renderType,0),r.uniform2f(y.scale,m.x,m.y),r.uniform3f(y.screenPosition,v.x,v.y,v.z),r.disable(r.BLEND),r.enable(r.DEPTH_TEST),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,n.occlusionTexture),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGBA,g.x-8,g.y-8,16,16,0),r.uniform1i(y.renderType,1),r.disable(r.DEPTH_TEST),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,n.tempTexture),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0),M.positionScreen.copy(v),M.customUpdateCallback?M.customUpdateCallback(M):M.updateLensFlares(),r.uniform1i(y.renderType,2),r.enable(r.BLEND),b=0,_=M.lensFlares.length;_>b;b++)S=M.lensFlares[b],S.opacity>.001&&S.scale>.001&&(v.x=S.x,v.y=S.y,v.z=S.z,f=S.size*S.scale/s,m.x=f*u,m.y=f,r.uniform3f(y.screenPosition,v.x,v.y,v.z),r.uniform2f(y.scale,m.x,m.y),r.uniform1f(y.rotation,S.rotation),r.uniform1f(y.opacity,S.opacity),r.uniform3f(y.color,S.color.r,S.color.g,S.color.b),i.setBlending(S.blending,S.blendEquation,S.blendSrc,S.blendDst),i.setTexture(S.texture,1),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0));r.enable(r.CULL_FACE),r.enable(r.DEPTH_TEST),r.depthMask(!0)}}},e.ShadowMapPlugin=function(){function t(t,r){var i=new e.DirectionalLight;i.isVirtual=!0,i.onlyShadow=!0,i.castShadow=!0,i.shadowCameraNear=t.shadowCameraNear,i.shadowCameraFar=t.shadowCameraFar,i.shadowCameraLeft=t.shadowCameraLeft,i.shadowCameraRight=t.shadowCameraRight,i.shadowCameraBottom=t.shadowCameraBottom,i.shadowCameraTop=t.shadowCameraTop,i.shadowCameraVisible=t.shadowCameraVisible,i.shadowDarkness=t.shadowDarkness,i.shadowBias=t.shadowCascadeBias[r],i.shadowMapWidth=t.shadowCascadeWidth[r],i.shadowMapHeight=t.shadowCascadeHeight[r],i.pointsWorld=[],i.pointsFrustum=[];for(var o=i.pointsWorld,n=i.pointsFrustum,a=0;8>a;a++)o[a]=new e.Vector3,n[a]=new e.Vector3;var s=t.shadowCascadeNearZ[r],l=t.shadowCascadeFarZ[r];return n[0].set(-1,-1,s),n[1].set(1,-1,s),n[2].set(-1,1,s),n[3].set(1,1,s),n[4].set(-1,-1,l),n[5].set(1,-1,l),n[6].set(-1,1,l),n[7].set(1,1,l),i}function r(e,t){var r=e.shadowCascadeArray[t];r.position.copy(e.position),r.target.position.copy(e.target.position),r.lookAt(r.target),r.shadowCameraVisible=e.shadowCameraVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[t];var i=e.shadowCascadeNearZ[t],o=e.shadowCascadeFarZ[t],n=r.pointsFrustum;n[0].z=i,n[1].z=i,n[2].z=i,n[3].z=i,n[4].z=o,n[5].z=o,n[6].z=o,n[7].z=o}function i(t,r){var i=r.shadowCamera,o=r.pointsFrustum,n=r.pointsWorld;d.set(1/0,1/0,1/0),f.set(-(1/0),-(1/0),-(1/0));for(var a=0;8>a;a++){var s=n[a];s.copy(o[a]),e.ShadowMapPlugin.__projector.unprojectVector(s,t),s.applyMatrix4(i.matrixWorldInverse),s.x<d.x&&(d.x=s.x),s.x>f.x&&(f.x=s.x),s.y<d.y&&(d.y=s.y),s.y>f.y&&(f.y=s.y),s.z<d.z&&(d.z=s.z),s.z>f.z&&(f.z=s.z)}i.left=d.x,i.right=f.x,i.top=f.y,i.bottom=d.y,i.updateProjectionMatrix()}function o(t){return t.material instanceof e.MeshFaceMaterial?t.material.materials[0]:t.material}var n,a,s,l,c,h,u=new e.Frustum,p=new e.Matrix4,d=new e.Vector3,f=new e.Vector3,m=new e.Vector3;this.init=function(t){n=t.context,a=t;var r=e.ShaderLib.depthRGBA,i=e.UniformsUtils.clone(r.uniforms);s=new e.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:i}),l=new e.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:i,morphTargets:!0}),c=new e.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:i,skinning:!0}),h=new e.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:i,morphTargets:!0,skinning:!0}),s._shadowPass=!0,l._shadowPass=!0,c._shadowPass=!0,h._shadowPass=!0},this.render=function(e,t){a.shadowMapEnabled&&a.shadowMapAutoUpdate&&this.update(e,t)},this.update=function(d,f){var v,g,y,x,w,b,_,M,S,T,C,L,A,P,D=[],F=0,E=null;for(n.clearColor(1,1,1,1),n.disable(n.BLEND),n.enable(n.CULL_FACE),n.frontFace(n.CCW),a.shadowMapCullFace===e.CullFaceFront?n.cullFace(n.FRONT):n.cullFace(n.BACK),a.setDepthTest(!0),v=0,g=d.__lights.length;g>v;v++)if(A=d.__lights[v],A.castShadow)if(A instanceof e.DirectionalLight&&A.shadowCascade)for(w=0;w<A.shadowCascadeCount;w++){var V;if(A.shadowCascadeArray[w])V=A.shadowCascadeArray[w];else{V=t(A,w),V.originalCamera=f;var R=new e.Gyroscope;R.position=A.shadowCascadeOffset,R.add(V),R.add(V.target),f.add(R),A.shadowCascadeArray[w]=V,console.log("Created virtualLight",V)}r(A,w),D[F]=V,F++}else D[F]=A,F++;for(v=0,g=D.length;g>v;v++){if(A=D[v],!A.shadowMap){var z=e.LinearFilter;a.shadowMapType===e.PCFSoftShadowMap&&(z=e.NearestFilter);var I={minFilter:z,magFilter:z,format:e.RGBAFormat};A.shadowMap=new e.WebGLRenderTarget(A.shadowMapWidth,A.shadowMapHeight,I),A.shadowMapSize=new e.Vector2(A.shadowMapWidth,A.shadowMapHeight),A.shadowMatrix=new e.Matrix4}if(!A.shadowCamera){if(A instanceof e.SpotLight)A.shadowCamera=new e.PerspectiveCamera(A.shadowCameraFov,A.shadowMapWidth/A.shadowMapHeight,A.shadowCameraNear,A.shadowCameraFar);else{if(!(A instanceof e.DirectionalLight)){console.error("Unsupported light type for shadow");continue}A.shadowCamera=new e.OrthographicCamera(A.shadowCameraLeft,A.shadowCameraRight,A.shadowCameraTop,A.shadowCameraBottom,A.shadowCameraNear,A.shadowCameraFar)}d.add(A.shadowCamera),d.autoUpdate===!0&&d.updateMatrixWorld()}for(A.shadowCameraVisible&&!A.cameraHelper&&(A.cameraHelper=new e.CameraHelper(A.shadowCamera),A.shadowCamera.add(A.cameraHelper)),A.isVirtual&&V.originalCamera==f&&i(f,A),b=A.shadowMap,_=A.shadowMatrix,M=A.shadowCamera,M.position.getPositionFromMatrix(A.matrixWorld),m.getPositionFromMatrix(A.target.matrixWorld),M.lookAt(m),M.updateMatrixWorld(),M.matrixWorldInverse.getInverse(M.matrixWorld),A.cameraHelper&&(A.cameraHelper.visible=A.shadowCameraVisible),A.shadowCameraVisible&&A.cameraHelper.update(),_.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),_.multiply(M.projectionMatrix),_.multiply(M.matrixWorldInverse),p.multiplyMatrices(M.projectionMatrix,M.matrixWorldInverse),u.setFromMatrix(p),a.setRenderTarget(b),a.clear(),P=d.__webglObjects,y=0,x=P.length;x>y;y++)C=P[y],L=C.object,C.render=!1,L.visible&&L.castShadow&&((L instanceof e.Mesh||L instanceof e.ParticleSystem)&&L.frustumCulled&&!u.intersectsObject(L)||(L._modelViewMatrix.multiplyMatrices(M.matrixWorldInverse,L.matrixWorld),C.render=!0));var U,O,B;for(y=0,x=P.length;x>y;y++)C=P[y],C.render&&(L=C.object,S=C.buffer,U=o(L),O=L.geometry.morphTargets.length>0&&U.morphTargets,B=L instanceof e.SkinnedMesh&&U.skinning,T=L.customDepthMaterial?L.customDepthMaterial:B?O?h:c:O?l:s,S instanceof e.BufferGeometry?a.renderBufferDirect(M,d.__lights,E,T,S,L):a.renderBuffer(M,d.__lights,E,T,S,L));for(P=d.__webglObjectsImmediate,y=0,x=P.length;x>y;y++)C=P[y],L=C.object,L.visible&&L.castShadow&&(L._modelViewMatrix.multiplyMatrices(M.matrixWorldInverse,L.matrixWorld),a.renderImmediateObject(M,d.__lights,E,s,L))}var N=a.getClearColor(),k=a.getClearAlpha();n.clearColor(N.r,N.g,N.b,k),n.enable(n.BLEND),a.shadowMapCullFace===e.CullFaceFront&&n.cullFace(n.BACK)}},e.ShadowMapPlugin.__projector=new e.Projector,e.SpritePlugin=function(){function t(){var e=i.createProgram(),t=i.createShader(i.VERTEX_SHADER),r=i.createShader(i.FRAGMENT_SHADER);return i.shaderSource(t,["precision "+o.getPrecision()+" float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","uniform vec2 halfViewport;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),i.shaderSource(r,["precision "+o.getPrecision()+" float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),i.compileShader(t),i.compileShader(r),i.attachShader(e,t),i.attachShader(e,r),i.linkProgram(e),e}function r(e,t){return e.z!==t.z?t.z-e.z:t.id-e.id}var i,o,n,a,s,l,c,h,u,p;this.init=function(r){i=r.context,o=r,a=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),s=new Uint16Array([0,1,2,0,2,3]),l=i.createBuffer(),c=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,a,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,c),i.bufferData(i.ELEMENT_ARRAY_BUFFER,s,i.STATIC_DRAW),h=t(),u={position:i.getAttribLocation(h,"position"),uv:i.getAttribLocation(h,"uv")},p={uvOffset:i.getUniformLocation(h,"uvOffset"),uvScale:i.getUniformLocation(h,"uvScale"),rotation:i.getUniformLocation(h,"rotation"),scale:i.getUniformLocation(h,"scale"),halfViewport:i.getUniformLocation(h,"halfViewport"),color:i.getUniformLocation(h,"color"),map:i.getUniformLocation(h,"map"),opacity:i.getUniformLocation(h,"opacity"),modelViewMatrix:i.getUniformLocation(h,"modelViewMatrix"),projectionMatrix:i.getUniformLocation(h,"projectionMatrix"),fogType:i.getUniformLocation(h,"fogType"),fogDensity:i.getUniformLocation(h,"fogDensity"),fogNear:i.getUniformLocation(h,"fogNear"),fogFar:i.getUniformLocation(h,"fogFar"),fogColor:i.getUniformLocation(h,"fogColor"),alphaTest:i.getUniformLocation(h,"alphaTest")};var d=document.createElement("canvas");d.width=8,d.height=8;var f=d.getContext("2d");f.fillStyle="#ffffff",f.fillRect(0,0,d.width,d.height),n=new e.Texture(d),n.needsUpdate=!0},this.render=function(t,a,s,d){var f=t.__webglSprites,m=f.length;if(m){var v=.5*s,g=.5*d;i.useProgram(h),i.enableVertexAttribArray(u.position),i.enableVertexAttribArray(u.uv),i.disable(i.CULL_FACE),i.enable(i.BLEND),i.bindBuffer(i.ARRAY_BUFFER,l),i.vertexAttribPointer(u.position,2,i.FLOAT,!1,16,0),i.vertexAttribPointer(u.uv,2,i.FLOAT,!1,16,8),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,c),i.uniformMatrix4fv(p.projectionMatrix,!1,a.projectionMatrix.elements),i.activeTexture(i.TEXTURE0),i.uniform1i(p.map,0);var y=0,x=0,w=t.fog;w?(i.uniform3f(p.fogColor,w.color.r,w.color.g,w.color.b),w instanceof e.Fog?(i.uniform1f(p.fogNear,w.near),i.uniform1f(p.fogFar,w.far),i.uniform1i(p.fogType,1),y=1,x=1):w instanceof e.FogExp2&&(i.uniform1f(p.fogDensity,w.density),i.uniform1i(p.fogType,2),y=2,x=2)):(i.uniform1i(p.fogType,0),y=0,x=0);var b,_,M,S,T=[];for(b=0;m>b;b++)_=f[b],M=_.material,_.visible!==!1&&(_._modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,_.matrixWorld),_.z=-_._modelViewMatrix.elements[14]);for(f.sort(r),b=0;m>b;b++)_=f[b],_.visible!==!1&&(M=_.material,i.uniform1f(p.alphaTest,M.alphaTest),i.uniformMatrix4fv(p.modelViewMatrix,!1,_._modelViewMatrix.elements),T[0]=_.scale.x,T[1]=_.scale.y,S=t.fog&&M.fog?x:0,y!==S&&(i.uniform1i(p.fogType,S),y=S),i.uniform2f(p.uvScale,M.uvScale.x,M.uvScale.y),i.uniform2f(p.uvOffset,M.uvOffset.x,M.uvOffset.y),i.uniform1f(p.opacity,M.opacity),i.uniform3f(p.color,M.color.r,M.color.g,M.color.b),i.uniform1f(p.rotation,M.rotation),i.uniform2fv(p.scale,T),i.uniform2f(p.halfViewport,v,g),o.setBlending(M.blending,M.blendEquation,M.blendSrc,M.blendDst),o.setDepthTest(M.depthTest),o.setDepthWrite(M.depthWrite),M.map&&M.map.image&&M.map.image.width?o.setTexture(M.map,0):o.setTexture(n,0),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0));i.enable(i.CULL_FACE)}}},e.DepthPassPlugin=function(){function t(t){return t.material instanceof e.MeshFaceMaterial?t.material.materials[0]:t.material}this.enabled=!1,this.renderTarget=null;var r,i,o,n,a,s,l=new e.Frustum,c=new e.Matrix4;this.init=function(t){r=t.context,i=t;var l=e.ShaderLib.depthRGBA,c=e.UniformsUtils.clone(l.uniforms);o=new e.ShaderMaterial({fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,uniforms:c}),n=new e.ShaderMaterial({fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,uniforms:c,morphTargets:!0}),a=new e.ShaderMaterial({fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,uniforms:c,skinning:!0}),s=new e.ShaderMaterial({fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,uniforms:c,morphTargets:!0,skinning:!0}),o._shadowPass=!0,n._shadowPass=!0,a._shadowPass=!0,s._shadowPass=!0},this.render=function(e,t){this.enabled&&this.update(e,t)},this.update=function(h,u){var p,d,f,m,v,g,y,x=null;for(r.clearColor(1,1,1,1),r.disable(r.BLEND),i.setDepthTest(!0),h.autoUpdate===!0&&h.updateMatrixWorld(),u.matrixWorldInverse.getInverse(u.matrixWorld),c.multiplyMatrices(u.projectionMatrix,u.matrixWorldInverse),l.setFromMatrix(c),i.setRenderTarget(this.renderTarget),i.clear(),y=h.__webglObjects,p=0,d=y.length;d>p;p++)v=y[p],g=v.object,v.render=!1,g.visible&&((g instanceof e.Mesh||g instanceof e.ParticleSystem)&&g.frustumCulled&&!l.intersectsObject(g)||(g._modelViewMatrix.multiplyMatrices(u.matrixWorldInverse,g.matrixWorld),v.render=!0));var w,b,_;for(p=0,d=y.length;d>p;p++)if(v=y[p],v.render){if(g=v.object,f=v.buffer,g instanceof e.ParticleSystem&&!g.customDepthMaterial)continue;w=t(g),w&&i.setMaterialFaces(g.material),b=g.geometry.morphTargets.length>0&&w.morphTargets,_=g instanceof e.SkinnedMesh&&w.skinning,m=g.customDepthMaterial?g.customDepthMaterial:_?b?s:a:b?n:o,f instanceof e.BufferGeometry?i.renderBufferDirect(u,h.__lights,x,m,f,g):i.renderBuffer(u,h.__lights,x,m,f,g)}for(y=h.__webglObjectsImmediate,p=0,d=y.length;d>p;p++)v=y[p],g=v.object,g.visible&&(g._modelViewMatrix.multiplyMatrices(u.matrixWorldInverse,g.matrixWorld),i.renderImmediateObject(u,h.__lights,x,o,g));var M=i.getClearColor(),S=i.getClearAlpha();r.clearColor(M.r,M.g,M.b,S),r.enable(r.BLEND)}},e.ShaderFlares={lensFlareVertexTexture:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},lensFlare:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform lowp int renderType;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a;","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a;","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a;","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}},e.CSS3DObject=function(t){e.Object3D.call(this),this.element=t,this.element.style.position="absolute",this.element.style.WebkitTransformStyle="preserve-3d",this.element.style.MozTransformStyle="preserve-3d",this.element.style.oTransformStyle="preserve-3d",this.element.style.transformStyle="preserve-3d",this.addEventListener("removed",function(e){if(null!==this.element.parentNode){this.element.parentNode.removeChild(this.element);for(var t=0,r=this.children.length;r>t;t++)this.children[t].dispatchEvent(e)}})},e.CSS3DObject.prototype=Object.create(e.Object3D.prototype),e.CSS3DSprite=function(t){e.CSS3DObject.call(this,t)},e.CSS3DSprite.prototype=Object.create(e.CSS3DObject.prototype),e.CSS3DRenderer=function(){console.log("THREE.CSS3DRenderer",e.REVISION);var t,r,i,o,n=new e.Matrix4,a=document.createElement("div");a.style.overflow="hidden",a.style.WebkitTransformStyle="preserve-3d",a.style.MozTransformStyle="preserve-3d",a.style.oTransformStyle="preserve-3d",a.style.transformStyle="preserve-3d",this.domElement=a;var s=document.createElement("div");s.style.WebkitTransformStyle="preserve-3d",s.style.MozTransformStyle="preserve-3d",s.style.oTransformStyle="preserve-3d",s.style.transformStyle="preserve-3d",a.appendChild(s),this.setSize=function(e,n){t=e,r=n,i=t/2,o=r/2,a.style.width=e+"px",a.style.height=n+"px",s.style.width=e+"px",s.style.height=n+"px"};var l=function(e){return Math.abs(e)<1e-6?0:e},c=function(e){var t=e.elements;return"matrix3d("+l(t[0])+","+l(-t[1])+","+l(t[2])+","+l(t[3])+","+l(t[4])+","+l(-t[5])+","+l(t[6])+","+l(t[7])+","+l(t[8])+","+l(-t[9])+","+l(t[10])+","+l(t[11])+","+l(t[12])+","+l(-t[13])+","+l(t[14])+","+l(t[15])+")"},h=function(e){var t=e.elements;return"translate3d(-50%,-50%,0) matrix3d("+l(t[0])+","+l(t[1])+","+l(t[2])+","+l(t[3])+","+l(-t[4])+","+l(-t[5])+","+l(-t[6])+","+l(-t[7])+","+l(t[8])+","+l(t[9])+","+l(t[10])+","+l(t[11])+","+l(t[12])+","+l(t[13])+","+l(t[14])+","+l(t[15])+")"},u=function(t,r){if(t instanceof e.CSS3DObject){var i;t instanceof e.CSS3DSprite?(n.copy(r.matrixWorldInverse),n.transpose(),n.copyPosition(t.matrixWorld),n.scale(t.scale),n.elements[3]=0,n.elements[7]=0,n.elements[11]=0,n.elements[15]=1,i=h(n)):i=h(t.matrixWorld);var o=t.element;o.style.WebkitTransform=i,o.style.MozTransform=i,o.style.oTransform=i,o.style.transform=i,o.parentNode!==s&&s.appendChild(o)}for(var a=0,l=t.children.length;l>a;a++)u(t.children[a],r)};this.render=function(t,n){var l=.5/Math.tan(e.Math.degToRad(.5*n.fov))*r;a.style.WebkitPerspective=l+"px",a.style.MozPerspective=l+"px",a.style.oPerspective=l+"px",a.style.perspective=l+"px",t.updateMatrixWorld(),void 0===n.parent&&n.updateMatrixWorld(),n.matrixWorldInverse.getInverse(n.matrixWorld);var h="translate3d(0,0,"+l+"px)"+c(n.matrixWorldInverse)+" translate3d("+i+"px,"+o+"px, 0)";s.style.WebkitTransform=h,s.style.MozTransform=h,s.style.oTransform=h,s.style.transform=h,u(t,n)}},e}.call(t,r,t,e),!(void 0!==i&&(e.exports=i))},function(e,t,r){var i,o;i=[r(1),r(5),r(4),r(9),r(11),r(6),r(27)],o=function(e,t,i,o,n,a){function s(){var e={mode:"normal",territory:"FXX"};if(p=new Geoportal.Viewer.Default(_mapDivId,e,OpenLayers.Util.extend(e,void 0===window.gGEOPORTALRIGHTSMANAGEMENT?{apiKey:"cleok"}:gGEOPORTALRIGHTSMANAGEMENT)),!p)throw new Error("Failed to intilise the Geoportal viewer");for(var t=[p.getMap().getControlsByClass("Geoportal.Control.PermanentLogo")[0],p.getMap().getControlsByClass("Geoportal.Control.Logo")[0],p.getMap().getControlsByClass("Geoportal.Control.TermsOfService")[0]],r=0,i=t.length;i>r;r++)p.getMap().removeControl(t[r]);try{p.addGeoportalLayer("GEOGRAPHICALGRIDSYSTEMS.MAPS",{}),p.addGeoportalLayer("ORTHOIMAGERY.ORTHOPHOTOS",{})}catch(o){console.error("Something went wrong while loading one of the Geoportal layer")}d=new OpenLayers.Layer.Vector("Current Position"),p.getMap().addLayer(d);var a=new OpenLayers.Geometry.Point(u.easting,u.northing);a=a.transform(new OpenLayers.Projection("EPSG:2154"),p.getMap().getProjectionObject());var s=new OpenLayers.Feature.Vector(a,{},{externalGraphic:"images/position.png",graphicWidth:35,graphicHeight:71});d.addFeatures([s]),OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!0,pixelTolerance:0,stopSingle:!1,stopDouble:!1},handleRightClicks:!0,initialize:function(e){document.getElementById("geoportailDiv").oncontextmenu=function(e){return e=e?e:window.event,e.preventDefault?void e.preventDefault():!1},this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){var t=p.getMap().getLonLatFromPixel(e.xy);t.transform(p.getMap().getProjectionObject(),new OpenLayers.Projection("EPSG:2154")),n.goToClosestPosition({x:t.lon,y:0,z:t.lat},{distance:100})}});var l=new OpenLayers.Control.Click;p.getMap().addControl(l),l.activate(),c===!0&&(f=new OpenLayers.Layer.Vector("Zone Accquisition"),m=new OpenLayers.Layer.Vector("Biking Navigation"),p.getMap().addLayer(m),v=new OpenLayers.Layer.Vector("Laser Mesure"),p.getMap().addLayer(v),g=new OpenLayers.Layer.Vector("geovelo"),p.getMap().addLayer(g),_=new OpenLayers.Control.SelectFeature(f,{onSelect:function(e){b=e;var t=new OpenLayers.Popup.FramedCloud("Pano",e.geometry.getBounds().getCenterLonLat(),null,"<div style='font-size:.8em'>\n	                            <p>Easting : "+e.attributes.easting+"</p>\n	                            <p>Northing : "+e.attributes.northing+"\n	                            <p>Distance to position : "+e.attributes.distance+"<p>\n	                            <p>Orientation to position : "+e.attributes.orientation+"<p>\n	                        </div>",null,!0,function(e){_.unselect(b)});e.popup=t},onUnselect:function(e){p.getMap().removePopup(e.popup),e.popup.destroy(),e.popup=null},hover:!1}),p.getMap().addLayer(f));var h=a.clone();h.transform(p.getMap().getProjectionObject(),new OpenLayers.Projection("CRS:84")),p.getMap().setCenterAtLonLat(h.x,h.y,17),p.openToolsPanel(!1),p.openLayersPanel(!1),p.setInformationPanelVisibility(!1),p.setToolsPanelVisibility(!1),w=!0,x=!1}function l(){var e=Geoportal.GeoRMHandler.getConfig([h],null,"http://gpp3-wxs.ign.fr/autoconf/$key$/",{onContractsComplete:s});0==e&&console.error("IT.Mapping.addGeoportalMap: no contract sent")}var c=!0,h="",u={},p=null,d=null,f=null,m=null,v=null,g=null,y=!1,x=!1,w=!1,b=null,_=null,M={x:-20037508,y:20037508},S=76.43702828517624,T=[],C=[],L={MOVE:function(){A.movePositionOnMap()}},A={init:function(e,t,r){_mapDivId=e,h=t,u={easting:parseFloat(r.easting),northing:parseFloat(r.northing)},parseFloat(r.heading)||0,l()},rotatePositionMarker:function(e){var t=d.features[0];t.style.rotation=180*e/Math.PI%360;for(var r=0,i=d.features.length;i>r;r++)d.drawFeature(d.features[r])},movePositionOnMap:function(e){"undefined"==typeof e&&(e={x:o.getPanoInfos().easting-u.easting,y:o.getPanoInfos().northing-u.northing}),u.easting=u.easting+e.x,u.northing=u.northing+e.y;var t=p.getMap(),r=d.features[0].geometry;r.transform(t.getProjectionObject(),new OpenLayers.Projection("EPSG:2154")),r.move(e.x,e.y),r.transform(new OpenLayers.Projection("EPSG:2154"),t.getProjectionObject()),d.drawFeature(d.features[0]);var i=new OpenLayers.LonLat(r.x,r.y);t.setCenter(i)},getCurrentPosition:function(){return new e.Vector3(u.easting,0,u.northing)},addPanoPosition:function(e){if(1==w){var t=new OpenLayers.Geometry.Point(e.easting,e.northing);t=t.transform(new OpenLayers.Projection("EPSG:2154"),p.getMap().getProjectionObject());var r={pointRadius:2},i=new OpenLayers.Feature.Vector(t,e,r);f.addFeatures([i])}else if(null==p&&1==x){var o=this;window.setTimeout(function(){o.addPanoPosition(e)},200)}},inMap:function(e,t){i.inDivArea(e,t,"#"+_mapDivId)},hasPanoramixLayer:function(){return null!=f},cleanPanoramix:function(){f.removeAllFeatures()},isDragging:function(){return y},drawSegment:function(e,t){if(e.z&&t.z)var r=new OpenLayers.Geometry.Point(e.x,e.z),i=new OpenLayers.Geometry.Point(t.x,t.z);else var r=new OpenLayers.Geometry.Point(e.x,e.y),i=new OpenLayers.Geometry.Point(t.x,t.y);r=r.transform(new OpenLayers.Projection("CRS:84"),p.getMap().getProjectionObject()),i=i.transform(new OpenLayers.Projection("CRS:84"),p.getMap().getProjectionObject());var o={strokeWidth:1,strokeColor:"#ff0000"},n=new OpenLayers.Geometry.LineString([r,i]),a=new OpenLayers.Feature.Vector(n,{},o);m.addFeatures([a])},processEvent:function(e){L[e]&&L[e]()},addPointAtPosition:function(e,t){t=t||"CRS:84";var r={pointRadius:2,strokeColor:"#cc00cc"};if(e.z)var i=new OpenLayers.Geometry.Point(e.x,e.z);else var i=new OpenLayers.Geometry.Point(e.x,e.y);i=i.transform(new OpenLayers.Projection(t),p.getMap().getProjectionObject());var o=new OpenLayers.Feature.Vector(i,null,r);m.addFeatures([o])},addPointOnMap:function(e,t,r,i,o){t=t||"CRS:84";var n=new OpenLayers.Geometry.Point(e.x,e.z);n=n.transform(new OpenLayers.Projection(t),p.getMap().getProjectionObject());
var a=new OpenLayers.Feature.Vector(n,{name:o},i);r.addFeatures([a])},convertCoord:function(e,t,r){var i=new OpenLayers.Geometry.Point(e.x,e.y);return i=i.transform(new OpenLayers.Projection(t),new OpenLayers.Projection(r))},convertCoordVec3:function(t,r,i){var o=new OpenLayers.Geometry.Point(t.x,t.z);return o=o.transform(new OpenLayers.Projection(r),new OpenLayers.Projection(i)),new e.Vector3(o.x,t.y,o.y)},buildOLSRequest:function(e,t){var r='<?xml version="1.0" encoding="UTF-8"?><XLS xmlns:gml="http://www.opengis.net/gml"	                       xmlns="http://www.opengis.net/xls" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"	                       version="1.2"  xsi:schemaLocation="http://www.opengis.net/xls http://schemas.opengis.net/ols/1.2/olsAll.xsd">	                       <RequestHeader srsName="epsg:2154"/><Request maximumResponses="10" methodName="GeocodeRequest" version="1.2">';return t?(r+=' <ReverseGeocodeRequest><!-- countryCode="StreetAddress" --><ReverseGeocodePreference>StreetAddress</ReverseGeocodePreference><Position><gml:Point><gml:pos>',r+=e+"</gml:pos></gml:Point></Position></ReverseGeocodeRequest></Request></XLS>"):(r+='<GeocodeRequest><Address countryCode="StreetAddress,PositionOfInterest"><freeFormAddress>',r+=e+"</freeFormAddress></Address></GeocodeRequest></Request></XLS>"),encodeURI(r)},sendOLSRequest:function(e,i){if(""!==e){var n;n=i?this.buildOLSRequest(e,!0):this.buildOLSRequest(e,!1),t.getJSON("http://wxs.ign.fr/"+a.geoAPIKey+"/geoportail/ols?xls="+n+"&output=json&callback=?").done(function(e){var n=new OpenLayers.Format.XLS,a=n.read(e.xml);if(a.getNbBodies()>0)if(i){var s=a.getBodies()[0].getResponseParameters();if(s.getNbReverseGeocodedLocations()>0){var l=s.getReverseGeocodedLocations()[0];l=l.address.toString().replace("[Ville]",""),l=l.substring(0,l.indexOf("[")),l=l.substring(0,l.lastIndexOf(",")),t(".localisation-text").text(l+"   |   Easting : "+o.getPanoInfos().easting+" - Northing : "+o.getPanoInfos().northing+" (lambert 93)")}}else{var s=a.getBodies()[0].getResponseParameters().getGeocodeResponseList()[0];if(s.getNbGeocodedAddresses()>0){var c=s.getGeocodedAddresses()[0].lonlat;console.log("pos",c),r(11).goToClosestPosition({x:c.y,y:0,z:c.x},{distance:250})}}}).fail(function(e){console.error("something went wrong")})}},create3DCarto:function(e,t,r){return this.loadTilesAroundPos(e,t,r),T},loadTilesAroundPos:function(e,t,r){var i=this.getTileCoordAtPos(e,t),o=i.x*S+M.x,n=-i.y*S+M.y;console.log("tilPosMercator",o,n);for(var a={x:i.x,y:i.y},s=-r;r>s;++s)for(var l=-r;r>l;++l){var c=o+s*S,h=n+l*S,u=this.convertCoord({x:c,y:h},"EPSG:3857","EPSG:2154"),p={x:a.x+s,y:a.y-l};this.loadTileAtCoord({x:p.x,y:p.y},t,{x:u.x,y:u.y})}},computeSizeTile:function(e){var t=1066.3647919248917;switch(e){case 19:t=1066.3647919248917;break;case 18:t=2132.729583849784;break;case 17:t=4265.459167699568;break;case 16:t=8530.918335399136;break;case 15:t=17061.83667079827;break;case 14:t=34123.67334159654}var r=.28*t/1e3*256;return r},getTileCoordAtPos:function(e,t){var r={x:0,y:0},i=this.convertCoord(e,"EPSG:2154","EPSG:3857"),o=i.x-M.x,n=M.y-i.y;return r.x=Math.floor(o/t),r.y=Math.floor(n/t),{x:r.x,y:r.y}},loadTileAtCoord:function(e,t,r){this.getTileImgURL(t,e.y,e.x,r)},getTileImgURL:function(e,t,r,i){var o="png",n="z0sxz2r5pnuy669h11vlm982",a="http://wxs-i.ign.fr/"+n;a+="/geoportail/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX=",a+=e+"&TILEROW="+t+"&TILECOL="+r+"&FORMAT=image%2F"+o,console.log(a),T.push(a),C.push(i)},getViewer:function(){return p},loadTilesAroundPosWMS:function(e,t,r){var i=this.getTileCoordAtPos(e,t),o=i.x*S+M.x,n=-i.y*S+M.y;console.log("tilPosMercator",o,n);for(var a={x:i.x,y:i.y},s=-r;r>s;++s)for(var l=-r;r>l;++l){var c=o+s*S,h=n+l*S,u=this.convertCoord({x:c,y:h},"EPSG:3857","EPSG:2154"),p={x:a.x+s,y:a.y-l};this.loadTileAtCoord({x:p.x,y:p.y},t,{x:u.x,y:u.y})}},getArrayTiles:function(){return T},getArrayPosTiles:function(){return C},showZoneAccquisition:function(){var e=this,r={pointRadius:6,fill:!0,fillColor:"rgba(0,127,127,0.75)",fillOpacity:.5,stroke:!1};null!=p?t.post("php/getAllPanoPos.php",function(e){for(var t=JSON.parse(e),i=0;i<t.length;i++)A.addPointOnMap(t[i],"EPSG:2154",f,r)}):window.setTimeout(function(){e.showZoneAccquisition()},200),console.log("add zone accquisition!")},getLayerFromName:function(e){var t;switch(e){case"geovelo":t=g;break;default:t=v}return t},showPointMeasureOnMap:function(e,t,r,i){var o=this,r=this.getLayerFromName(r)||v;t=t||{pointRadius:3,fill:!0,fillColor:"#ff00ff",fillOpacity:.7,stroke:!1},null!=p?A.addPointOnMap(e,"EPSG:2154",r,t,i):window.setTimeout(function(){o.showPointMeasureOnMap(e,null,r,t,i)},200)},showLineMeasureOnMap:function(e,t,r,i,o){var n=this;i=i||"CRS:84",o=o||{strokeWidth:1.5,strokeColor:"#ffaa00"},null!=p?A.drawLineOnMap(e,t,r,i,o):window.setTimeout(function(){n.showLineMeasureOnMap(e,t,r,i,o)},200)},drawLineOnMap:function(e,t,r,i,o){var n=new OpenLayers.Geometry.Point(e.x,e.z);n=n.transform(new OpenLayers.Projection(i),p.getMap().getProjectionObject());var a=new OpenLayers.Geometry.Point(t.x,t.z);a=a.transform(new OpenLayers.Projection(i),p.getMap().getProjectionObject());var s=new OpenLayers.Geometry.LineString([n,a]),l=new OpenLayers.Feature.Vector(s,{},o);r.addFeatures([l])},removeAllFeature:function(e){e.removeAllFeatures()},getLaserLayer:function(){return v},getItineraryLayer:function(){return m}};return A}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1),r(5),r(4),r(42)],o=function(e,t,r,i){function o(){c=R/z,l=80,h=.2,u=1e4,y=.1,L=new e.Vector3(0,0,-1e5),C=new e.Vector3(0,0,0),s=new e.PerspectiveCamera(l,c,h,u),s.lookAt(new e.Vector3(0,0,0)),s.position.x=0,s.position.y=.6,s.position.z=0,s.scale=new e.Vector3(1,1,-1),D=0,P=0,A=1e5}function n(t,r){var i=new e.MeshPhongMaterial({ambient:13421772}),o=new e.Mesh(t,i);return o.name=r,o.position=new e.Vector3(s.position.x,s.position.y-.6,s.position.z+.7),$.rotateY(P,o),I.add(o),o}var a,s=null,l=null,c=null,h=null,u=1e4,p=250,d=null,f=null,m=1,v=!1,g=0,y=.01,x=.04,w=!1,b=!1,_=null,M=null,S=null,T=null,C=null,L=null,A=null,P=null,D=null,F={x:0,y:.6,z:0},E={x:0},V="#",R=null,z=null,I=null,U=null,O=null,B=null,N=!1,k=null,G=null,j=null,W=null,H={enabled:!1,guiBool:!0},X={climate:!1,sharpen:!1,brightness:!1,hdr:!1},q=null,Y=200,Z=[],K=null,Q=[],J=null;_states={ON_GIZMO:!1,MESH_MANIPULATION:!1,MULTIMEDIA_MANIPULATION:!1},_statesHandler={MESH_MANIPULATION:function(e){e!==_states.MESH_MANIPULATION&&(_currentGizmo.toggleAxis(e),e===!0?_currentGizmo.toggleDisplay(!1):$.setGizmoToMesh(_currentGizmo.selectedMesh))}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var $={init:function(r){R=window.innerWidth,z=window.innerHeight,o(),I=new e.Scene,I.add(s),I.add(new e.AmbientLight(13421772)),O=new e.WebGLRenderer({preserveDrawingBuffer:!0,antialias:!0,alpha:!0}),O.setSize(R/m,z/m),O.setClearColor(new e.Color(0,1)),V+=r,$container=t(V),$container.append(O.domElement);var i=O.domElement;i.id="canvasWEBGL",i.style.width=window.innerWidth+"px",i.style.height=window.innerHeight+"px",i.style.zIndex="-1",J=new e.Mesh(new e.PlaneGeometry(1e3,1e3,100,100),new e.MeshBasicMaterial({wireframe:!0,color:13421772,side:e.DoubleSide})),J.rotation.x=.5*-Math.PI,J.position.y=-50,t(window).resize(function(){s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),R=window.innerWidth/m,z=window.innerHeight/m,O.setSize(R,z);var e=O.domElement;e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px"}),this.initPostprocessing(),N=!0},initPostprocessing:function(){j=new e.EffectComposer(O),W=new e.MeshDepthMaterial,W.side=e.DoubleSide,a=new e.RenderPass(I,s);var t={minFilter:e.LinearMipMapLinear,magFilter:e.LinearMipMapLinear,format:e.RGBAFormat,antialias:!0};H.rtTextureDepth=new e.WebGLRenderTarget(R,z,t),H.rtTextureColor=new e.WebGLRenderTarget(R,z,t),d=new e.ShaderPass(e.ItownsDepthShader),d.uniforms.maxblur.value=100,d.uniforms.tColor.value=H.rtTextureColor,d.uniforms.tDepth.value=H.rtTextureDepth,d.uniforms.effectIntensity.value=g,d.uniforms.indice_time.value=0,d.enabled=!1,d.renderToScreen=!1,Z.push(d);var r=new e.ShaderPass(e.HueSaturationShader);r.enabled=!1,r.renderToScreen=!1,Z.push(r),j.addPass(a),j.addPass(d),j.addPass(r),H.textureOriginal=new e.WebGLRenderTarget(R,z,t),H.textureBlurred=new e.WebGLRenderTarget(R,z,t);var i=new e.ShaderPass(e.blurTriangleX);i.uniforms.radius.value=50,i.uniforms.resolutionW.value=R,i.enabled=!1,i.renderToScreen=!1,Z.push(i);var o=new e.ShaderPass(e.blurTriangleY);o.uniforms.radius.value=50,o.uniforms.resolutionH.value=z,o.enabled=!1,o.renderToScreen=!1,Z.push(o),j.addPass(i),j.addPass(o),f=new e.ShaderPass(e.ItownsToneMapping),f.uniforms.tColor.value=H.textureOriginal,f.enabled=!1,f.renderToScreen=!1,Z.push(f),j.addPass(f);var n=new e.ShaderPass(e.ItownsSharpening);n.enabled=!1,n.renderToScreen=!1,Z.push(n),j.addPass(n)},addFogEffect:function(){d.enabled=!0,this.updateEffectRenderToScene(),H.enabled=this.updateEffectRenderToScene()},removeFogEffect:function(){d.enabled=!1,H.enabled=this.updateEffectRenderToScene()},setPostProcessingOn:function(e){H.enabled=e,H.guiBool=e},addPostProcess:function(){Z[5].enabled=!0,H.enabled=this.updateEffectRenderToScene()},setAnaglyphOnOff:function(){null==q?(q=new e.AnaglyphEffect(O,Y),q.setSize(window.innerWidth,window.innerHeight)):q=null,H.enabled=this.updateEffectRenderToScene()},switch3DGlasses:function(){q&&q.switchMaterial()},setBase3DGlasses:function(e){Y=e,q&&q.setFocalLength(e,s)},removePostProcess:function(e){Z[5].enabled=!1,H.enabled=this.updateEffectRenderToScene()},addHueSaturation:function(){Z[1].enabled=!0,H.enabled=this.updateEffectRenderToScene()},removeHueSaturation:function(){Z[1].enabled=!1,H.enabled=this.updateEffectRenderToScene()},setSaturationValue:function(e){Z[1].enabled||this.addHueSaturation(),Z[1].uniforms.saturation.value=(e-100)/100},setHueValue:function(e){Z[1].enabled||this.addHueSaturation(),Z[1].uniforms.hue.value=(e-100)/100},setContrastValue:function(e){Z[1].enabled||this.addHueSaturation(),Z[1].uniforms.contrast.value=e/100},setBrightnessValue:function(e){Z[1].enabled||this.addHueSaturation(),Z[1].uniforms.brightness.value=e/100},setToneMapping:function(e){Z[4].enabled||this.addToneMapping()},addToneMapping:function(){this.addHueSaturation(),this.setSaturationValue(26),this.setBrightnessValue(170),Z[2].enabled=!0,Z[3].enabled=!0,Z[4].enabled=!0,H.enabled=this.updateEffectRenderToScene()},removeToneMapping:function(){Z[2].enabled=!1,Z[3].enabled=!1,Z[4].enabled=!1,H.enabled=this.updateEffectRenderToScene(),this.setSaturationValue(100),this.setBrightnessValue(100)},checkIfMobile:function(e){(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||e)&&(v=!0,m=2,console.log("mobile version"))},setReso:function(){2==m?this.setLowReso(0):this.setLowReso(1),this.adaptWindowResolution()},setLowReso:function(e){e?(m=2,v=!0):(m=1,v=!1),this.adaptWindowResolution()},adaptWindowResolution:function(){s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),R=window.innerWidth/m,z=window.innerHeight/m,O.setSize(R,z);var e=O.domElement;e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px"},setNodeControllerOn:function(e){console.log("setNodeControllerOn",e),b=e},getNodeControllerOn:function(){return console.log("node controller",b),b},render:function(){requestAnimFrame($.render),w?($.orbitCamera(_),$.lookAtScaleOk(_)):(s.position.x+=(F.x-s.position.x)*x,s.position.z+=(F.z-s.position.z)*x,s.position.y+=(F.y-s.position.y)*x,C.x+=(L.x-C.x)*y,C.y+=(L.y-C.y)*y,C.z+=(L.z-C.z)*y,s.lookAt(C)),H.enabled?(X.climate&&(O.clear(),K&&(K.material.uniforms.time.value+=1/60,K.render()),I.overrideMaterial=null,O.render(I,s,H.rtTextureColor,!0),s.far=p,I.overrideMaterial=W,O.render(I,s,H.rtTextureDepth,!0),s.far=u),null!=q?q.render(I,s):(f.enabled&&(O.clear(),I.overrideMaterial=null,O.render(I,s,H.textureOriginal,!0)),j.render())):(K&&(K.material.uniforms.time.value+=1/60,K.render()),O.render(I,s))},renderOnce:function(){O.render(I,s)},renderToTexture:function(e,t,r,i){O.render(e,t,r,i)},getState:function(e){if(_states.hasOwnProperty(e)===!1)throw TypeError("Undefined state "+e+" in graphic engine");return _states[e]},setState:function(e,t){if(_states.hasOwnProperty(e)===!1)throw TypeError("Undefined state "+e+" in graphic engine");"undefined"!=typeof _statesHandler[e]&&_statesHandler[e](t),_states[e]=t===!1||t===!0?t:!1},getIntersected:function(t,i,o){var n=r.toNDC(t,i),a=new e.Vector3(n.x,n.y,1),l=new e.Projector,c=l.pickingRay(a,s);return c.intersectObjects(o)},addToScene:function(e){I.add(e)},addDemoMesh:function(t){switch(t.position=new e.Vector3(s.position.x,s.position.y-.6,s.position.z+.7),this.rotateY(P,t),t.rotation.x=-Math.PI/2,t.name.split("_")[0]){case"tree":t.scale.multiplyScalar(.125);break;case"bench":t.scale.multiplyScalar(.01),t.rotation.z=-Math.PI/4;break;case"light":t.scale.multiplyScalar(.125)}I.add(t)},addCube:function(t){return n(new e.CubeGeometry(.25,.25,.25),t)},addSphere:function(t){return n(new e.SphereGeometry(.25,16,12),t)},addCylinder:function(t){return n(new e.CylinderGeometry(.15,.15,.5,16,16),t)},addTextPanel:function(t,r,i,o){if("undefined"==typeof t||"undefined"==typeof r)throw TypeError("one argument is undefined");var o=o||.0015,n=new e.PlaneGeometry(t.width,t.height),a=new e.MeshBasicMaterial({map:new e.Texture(t),transparent:!0,depthTest:!1,depthWrite:!1,side:e.DoubleSide});a.map.needsUpdate=!0;var l=new e.Mesh(n,a);return l.name=i,l.id=i,l.position=new e.Vector3(r.x,r.y,r.z),l.quaternion=s.quaternion,l.scale.multiplyScalar(o),Q.push(l),I.add(l),l},removeTextPanels:function(){for(var e=Q.length;e>0;)I.remove(Q.pop()),e--},removeTextPanelFromName:function(e){I.remove(I.getObjectById(e,!0))},getLastTextPanel:function(){return Q[Q.length-1]},removeFromScene:function(e){I.remove(e)},drawSphereTest:function(t){var r,i;"undefined"!=typeof t&&(r=t.ray||50,i=t.position);var o=new e.Mesh(new e.SphereGeometry(r,8,8),new e.MeshBasicMaterial({color:16711680}));"undefined"!=typeof i&&(o.position=i.clone()),I.add(o)},drawRay:function(t,r){t=t/window.innerWidth*2-1,r=2*-(r/window.innerHeight)+1;var i=new e.Vector3(t,r,1),o=new e.Projector;o.unprojectVector(i,s);var n=new e.Geometry;n.vertices.push(s.position),n.vertices.push(i);var a=new e.LineBasicMaterial({color:16711680,linewidth:3}),l=new e.Line(n,a);I.add(l)},drawCam:function(){T?(I.remove(T),T=null):(T=new e.CameraHelper(s),I.add(T))},drawBB:function(t){var r=t.getChildByName(t.name+"_bb");if(r)r.visible=!0;else{t.geometry.computeBoundingBox();var i=t.geometry.boundingBox,o=new e.CubeGeometry(i.max.x-i.min.x+.025,i.max.y-i.min.y+.025,i.max.z-i.min.z+.025),n=new e.Mesh(o,new e.MeshBasicMaterial({color:16777215,wireframe:!0}));n.name=t.name+"_bb",t.add(n)}},hideBB:function(e){var t=e.getChildByName(e.name+"_bb");t&&(t.visible=!1)},switchSceneAxis:function(){null==U?(U=new e.AxisHelper,U.scale.set(10,10,10),I.add(U)):(I.remove(U),U=null)},rotateY:function(t,i){var o=s.position.x,n=s.position.z,a=(new e.Matrix4).makeTranslation(o,0,n);a=r.rotateY(a,t),a=r.translate(a,new e.Vector3(-o,0,-n)),i.position=i.position.applyMatrix4(a)},translateCamera:function(t,r,i){if("undefined"==typeof t||"undefined"==typeof r||"undefined"==typeof i)throw TypeError("one or many coordinate is/are undefined");var o=new e.Vector3(t,r,i);"52"===e.REVISION?s.position.addSelf(o):s.position.add(o)},translateCameraSmoothly:function(e,t,r){if("undefined"==typeof e||"undefined"==typeof t||"undefined"==typeof r)throw TypeError("one or many coordinate is/are undefined");-10001==e?F.y=t:(F.x=e,F.y=t,F.z=r)},orbitCamera:function(t,r,i){var r=r||.001;P+=r;var o=300,n=-o*Math.sin(P)+t.x,a=-o*Math.cos(P)+t.z,l=o*Math.tan(D)+t.y;F.x=n,F.y=l+120,F.z=a,C=t.clone()||new e.Vector3(-100,0,0),L=t.clone()||new e.Vector3(-100,0,0),s.position.x+=(F.x-s.position.x)*x,s.position.z+=(F.z-s.position.z)*x,s.position.y+=(F.y-s.position.y)*x,C.x+=(L.x-C.x)*y,C.y+=(L.y-C.y)*y,C.z+=(L.z-C.z)*y},cameraFollowItinerary:function(e){},lookAtScaleOk:function(t){t=t||new e.Vector3(0,0,0);var i=new e.Matrix4;i.lookAt(s.position,t,new e.Vector3(0,1,0)),i=r.rotateY(i,Math.PI),s.quaternion.setFromRotationMatrix(i)},setCameraOrthoVerticale:function(e){this.translateCameraSmoothly(e.x,e.y,e.z)},setOrbitCameraOn:function(e){_=e||s.position.clone(),w?(F=M,C=S):(M=s.position.clone(),S=C.clone(),s.position.y<80&&(s.position.y=120)),w=!w},cameraZoom:function(e){var t=s.fov+e;t>10&&160>t&&(s.fov=t,s.updateProjectionMatrix())},toggleGrid:function(e){e===!0?I.add(J):I.remove(J)},getPositionCloserToCam:function(t,r){return new e.Vector3(t.x-r*(t.x-s.position.x),t.y-r*(t.y-s.position.y),t.z-r*(t.z-s.position.z))},cameraLookAtPosition:function(e,t,r,i,o,n){var a=Math.atan2(e-i,r-n),s=Math.sqrt((e-i)*(e-i)+(r-n)*(r-n)),l=-Math.atan2(t-o,s);this.setCameraLonLatAngle(a,l);var c=-A*Math.sin(a),h=-A*Math.cos(a),u=A*Math.tan(l);this.setWantedCamRotation(c,u,h)},cameraLookAtHeading:function(e,t,r,i){var i=(i-90)/180*Math.PI,o=A*Math.cos(i),n=A*Math.sin(i);this.cameraLookAtPosition(e,t,r,o,t,n)},cameraLookAtYawPitch:function(e,t,r,i,o){var i=(i-90)/180*Math.PI,o=o/180*Math.PI,n=A*Math.cos(i),a=A*Math.sin(i),s=A*Math.tan(o);this.cameraLookAtPosition(e,t,r,n,s,a)},cameraLookHorizontally:function(){D=0,L.y=0},tiltCamera:function(e){s.rotation.z=e,s.updateProjectionMatrix()},getProjectedRay:function(t,i,o){var n=r.toNDC(t,i),a=new e.Projector,l=new e.Vector3(n.x,n.y,1);return a.unprojectVector(l,s),"undefined"!=typeof o&&l.normalize().multiplyScalar(o),l},getScene:function(){return I},getContext:function(){return O.getContext("experimental-webgl",{preserveDrawingBuffer:!0})},getRenderer:function(){return O},getCameraPosition:function(){return s.position.clone()},getCamera:function(){return s},getSpeedTurnCam:function(){return y},getSpeedTransCam:function(){return x},getTranslatCam:function(){return F},getCameraFov:function(){return s.fov},setCameraFov:function(e){s.fov=e,s.updateProjectionMatrix()},getAngleCameraLat:function(){return D},getAngleCameraLon:function(){return P},setCameraLonLatAngle:function(e,t){P=e,D=t},setWantedCamRotation:function(e,t,r){L.x=e,L.y=t,L.z=r},getCameraYawPitch:function(){return{yaw:P,pitch:D}},getTargetDist:function(){return A},getWinWith:function(){return R},getWinHeight:function(){return z},setZero:function(t){console.log("set Zero at",t),B=t instanceof e.Vector3?t:new e.Vector3(t.x,t.y,t.z)},getZero:function(){return B},getZeroAsVec3D:function(){return new e.Vector3(parseFloat(B.x),parseFloat(B.y),parseFloat(B.z))},getTrip:function(){return E},getClearColor:function(e){return O.getClearColor()},setSpeedTurnCam:function(e){y=e},setSpeedTransCam:function(e){x=e},setCameraPosition:function(){var e=arguments.length;1===e?s.position.set(arguments[0].x,arguments[0].y,arguments[0].z):3===e?s.position.set(arguments[0],arguments[1],arguments[2]):console.warn("No parameters passe through function"+arguments.callee)},setClearColor:function(e){O.setClearColor(e)},setFarFog:function(e){p=e},setIntensityEffect:function(e){g=e,d.uniforms.effectIntensity.value=g},setTimeEffect:function(e){d.uniforms.indice_time.value=e},setEffectsClimateOn:function(e){e?(this.addFogEffect(),this.addLensFlare()):(this.removeFogEffect(),this.removeLensFlare()),X.climate=e,d.enabled=e,I.overrideMaterial=null,O.clear(),s.far=u,H.enabled=this.updateEffectRenderToScene()},setWaterOn:function(){var t=new e.DirectionalLight(16777045,1);t.position.set(-600,300,600),I.add(t);var r=new e.ImageUtils.loadTexture("images/waternormals.jpg");r.wrapS=r.wrapT=e.RepeatWrapping,K=new e.Water(O,s,I,{textureWidth:256,textureHeight:256,waterNormals:r,alpha:1,sunDirection:t.position.normalize(),sunColor:16777215,waterColor:7695,betaVersion:0,side:e.DoubleSide});var i=new e.Mesh(new e.PlaneGeometry(2e3,2e3,100,100),K.material);i.add(this.ms_Water),i.rotation.x=.5*-Math.PI,I.add(i),i.position.y-=6.5},updateWater:function(){K.material.uniforms.time.value+=1/60,K.render()},updateEffectRenderToScene:function(){for(var e=!1,t=Z.length-1;!e&&t>=0;)e=1==Z[t].enabled,e&&(Z[t].renderToScreen=!0),t--;for(;t>=0;)Z[t].renderToScreen=!1,t--;return e&&H.guiBool||null!=q&&H.guiBool},addLensFlare:function(){function t(t,r,a,s,l,c){console.log("sun added at position: ",s,l,c),G=new e.PointLight(16777215,1.5,4500),G.color.setHSL(t,r,a),G.position.set(s,l,c);var h=new e.Color(16777215);h.setHSL(t,r,a+.5),k=new e.LensFlare(i,700,0,e.AdditiveBlending,h),k.add(o,512,0,e.AdditiveBlending),k.add(o,512,0,e.AdditiveBlending),k.add(o,512,0,e.AdditiveBlending),k.add(n,60,.6,e.AdditiveBlending),k.add(n,70,.7,e.AdditiveBlending),k.add(n,120,.9,e.AdditiveBlending),k.add(n,700,6,e.AdditiveBlending),k.position=G.position,I.add(k)}var i=e.ImageUtils.loadTexture("../../images/lensflare/lensflare0.png"),o=e.ImageUtils.loadTexture("../../images/lensflare/lensflare2.png"),n=e.ImageUtils.loadTexture("../../images/lensflare/lensflare3.png"),a=r.getSunPositionInScene((new Date).getTime());t(.995,.5,.9,a.x,a.y,a.z)},addClouds:function(){var t=new e.CloudShader,r=t.showClouds();I.add(r)},removeLensFlare:function(){I.remove(k)},setLensFlareIntensity:function(e){if(k){k.opacity=.6+(1-e/100)/.4;for(var t=0;t<k.lensFlares.length;++t)k.lensFlares[t].opacity=k.opacity}},initialized:function(){return N},isMobileEnvironment:function(){return v},setMobileEnvironment:function(e){v=e},getContainerID:function(){return V}};return $}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var o,n;o=[r(18),r(27)],n=function(e){_P=function(e,t){this.x=e,this.y=t,this.flag=!1},_P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},_P.dist=function(e,t){var r=t.x-e.x,i=t.y-e.y;return Math.sqrt(r*r+i*i)};var t={snd:null,snd2:null,toHex:function(e,t){var r,i=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],o="",t=t||2;do r=15&e,e>>=4,o=i[r]+o;while(e);return o.length<t&&(o=new Array(t-o.length+1).join("0")+o),"0x"+o},getOffset:function(e){var t=0,r=0;do t+=e.offsetTop,r+=e.offsetLeft;while(e=e.offsetParent);return{top:t,left:r}},rad2Deg:function(e){return 180*e/Math.PI%360},deg2Rad:function(e){return Math.PI*e/180%(2*Math.PI)},angleDiff:function(e,t){var r=e-t;return r<-Math.PI?r+=2*Math.PI:r>Math.PI&&(r-=2*Math.PI),Math.abs(r)},parseParams:function(){var e={},t=window.location.search.substr(1).split("&");for(i=0;i<t.length;i++)data=t[i].split("="),e[data[0].toLowerCase()]=data[1];return e.panoname=e.panoname||"TerMob2-130116_0923-00-00002_0000623",e.easting=e.easting||651110,e.northing=e.northing||6861835,e.heading=e.heading||0,e.duree=e.duree||"25",e.particlesize=e.particlesize||"0.01",e.mobile="true"==e.mobile||!1,e.nc="true"==e.nc||!1,"undefined"==typeof e.debug||"true"!==e.debug?e.debug=!1:e.debug=!0,e},getInitialInfoAndLoad:function(e){if("undefined"==typeof e){var t=new IT.RequestGIS("php/getInfoFromName.php?panoname="+params.panoname);t.sendCommand(IT.Utils.getInitialInfoAndLoad)}else{var r={};r.easting=e[0].split("=")[1],r.northing=e[1].split("=")[1],r.altitude=e[2].split("=")[1],r.heading=e[3].split("=")[1],r.pitch=e[4].split("=")[1],r.roll=e[5].split("=")[1];var i=e[6].split("=")[1].split(":");r.hour=i[0],r.second=60*parseInt(i[1])+parseInt(i[2]),r.near_address_num=e[7].split("=")[1],r.near_address_name=e[8].split("=")[1],r.date=e[9].split("=")[1].replace(/-/g,"_").trim();var o=pano.panoInfo.easting,n=pano.panoInfo.altitude,a=pano.panoInfo.northing;pano.name=params.panoname,pano.url=serverInfos.url+serverInfos.iipService+"/"+params.panoname+".jp2",pano.panoInfo.easting=r.easting,pano.panoInfo.northing=r.northing,pano.panoInfo.altitude=r.altitude,pano.panoInfo.pan_xml_heading_pp=r.heading,pano.panoInfo.pan_xml_pitch_pp=r.pitch,pano.panoInfo.pan_xml_roll_pp=r.roll,pano.loadUrl(pano.url),console.log(pano.panoInfo.easting-initialInfo.easting),pano.updateGlobalPano(new THREE.Vector3(pano.panoInfo.easting-initialInfo.easting,pano.panoInfo.altitude-initialInfo.altitude,pano.panoInfo.northing-initialInfo.northing),new THREE.Vector3(IT.Utils.deg2Rad(pano.panoInfo.pan_xml_roll_pp),IT.Utils.deg2Rad(pano.panoInfo.pan_xml_heading_pp),IT.Utils.deg2Rad(pano.panoInfo.pan_xml_pitch_pp)));var s={x:pano.panoInfo.easting-o,y:pano.panoInfo.altitude-n,z:pano.panoInfo.northing-a};translatX+=s.x,translatY+=s.y,translatZ+=s.z,camera.position.x=translatX,camera.position.y=translatY,camera.position.z=translatZ,map&&map.movePositionOnMap(s),IT.Utils.cameraLookAtPosition(intersectionX,intersectionY,intersectionZ,camera.position.x,camera.position.y,camera.position.z)}},cameraLookAtPosition:function(e,t,r,i,o,n,a){var s=Math.atan2(e-i,r-n);anglecameraLon=s;var l=-distTarget*Math.sin(anglecameraLon),c=-distTarget*Math.cos(anglecameraLon),h=Math.sqrt((e-i)*(e-i)+(r-n)*(r-n)),u=Math.atan2(t-o,h);console.log(u),anglecameraLat=-u;var p=-distTarget*Math.sin(u);camrotxwanted=l,camrotywanted=p,camrotzwanted=c},outputMatrix4:function(e){console.debug(e.elements[0]+" "+e.elements[4]+" "+e.elements[8]+" "+e.elements[12]+"\n"+e.elements[1]+" "+e.elements[5]+" "+e.elements[9]+" "+e.elements[13]+"\n"+e.elements[2]+" "+e.elements[6]+" "+e.elements[10]+" "+e.elements[14]+"\n"+e.elements[3]+" "+e.elements[7]+" "+e.elements[11]+" "+e.elements[15])},inDivArea:function(e,r,i){var o=$(i)[0],n=!1,a=t.getOffset(o);return e>=a.left&&e<=a.left+o.offsetWidth&&r>=a.top&&r<=a.top+o.offsetHeight&&(n=!0),n},clamp:function(e,t){return e<t.min&&(e=rangemin),e>max&&(e=max),e},clampMin:function(e,t){return t>e?t:e},clampMax:function(e,t){return e>t?t:e},toNDC:function(e,t){return{x:e/window.innerWidth*2-1,y:2*-(t/window.innerHeight)+1}},toScreenSpace:function(e,t){return{x:(e+1)/2*window.innerWidth,y:-(t-1)/2*window.innerHeigth}},notYetImplemented:function(){throw new Error("Not yet implented !")},noPanoramic:function(){alert("No panoramic found at that position")},loadTexture:function(e){var t=new THREE.Texture(texture_placeholder),r=new THREE.MeshBasicMaterial({map:t,overdraw:!0}),i=new Image;return i.onload=function(){t.needsUpdate=!0,r.map.image=this,render()},i.src=e,r},translate:function(e,t){var r=e.elements,i=t.x,o=t.y,n=t.z;return r[12]=r[0]*i+r[4]*o+r[8]*n+r[12],r[13]=r[1]*i+r[5]*o+r[9]*n+r[13],r[14]=r[2]*i+r[6]*o+r[10]*n+r[14],r[15]=r[3]*i+r[7]*o+r[11]*n+r[15],e},rotateX:function(e,t){var r=e.elements,i=r[4],o=r[5],n=r[6],a=r[7],s=r[8],l=r[9],c=r[10],h=r[11],u=Math.cos(t),p=Math.sin(t);return r[4]=u*i+p*s,r[5]=u*o+p*l,r[6]=u*n+p*c,r[7]=u*a+p*h,r[8]=u*s-p*i,r[9]=u*l-p*o,r[10]=u*c-p*n,r[11]=u*h-p*a,e},rotateY:function(e,t){var r=e.elements,i=r[0],o=r[1],n=r[2],a=r[3],s=r[8],l=r[9],c=r[10],h=r[11],u=Math.cos(t),p=Math.sin(t);return r[0]=u*i-p*s,r[1]=u*o-p*l,r[2]=u*n-p*c,r[3]=u*a-p*h,r[8]=u*s+p*i,r[9]=u*l+p*o,r[10]=u*c+p*n,r[11]=u*h+p*a,e},rotateZ:function(e,t){var r=e.elements,i=r[0],o=r[1],n=r[2],a=r[3],s=r[4],l=r[5],c=r[6],h=r[7],u=Math.cos(t),p=Math.sin(t);return r[0]=u*i+p*s,r[1]=u*o+p*l,r[2]=u*n+p*c,r[3]=u*a+p*h,r[4]=u*s-p*i,r[5]=u*l-p*o,r[6]=u*c-p*n,r[7]=u*h-p*a,e},rotateByAxis:function(e,t,r){var i=e.elements;if(1===t.x&&0===t.y&&0===t.z)return this.rotateX(e,r);if(0===t.x&&1===t.y&&0===t.z)return this.rotateY(e,r);if(0===t.x&&0===t.y&&1===t.z)return this.rotateZ(e,r);var o=t.x,n=t.y,a=t.z,s=Math.sqrt(o*o+n*n+a*a);o/=s,n/=s,a/=s;var l=o*o,c=n*n,h=a*a,u=Math.cos(r),p=Math.sin(r),d=1-u,f=o*n*d,m=o*a*d,v=n*a*d,g=o*p,y=n*p,x=a*p,w=l+(1-l)*u,b=f+x,_=m-y,M=f-x,S=c+(1-c)*u,T=v+g,C=m+y,L=v-g,A=h+(1-h)*u,P=i[0],D=i[1],F=i[2],E=i[3],V=i[4],R=i[5],z=i[6],I=i[7],U=i[8],O=i[9],B=i[10],N=i[11];return i[0]=w*P+b*V+_*U,i[1]=w*D+b*R+_*O,i[2]=w*F+b*z+_*B,i[3]=w*E+b*I+_*N,i[4]=M*P+S*V+T*U,i[5]=M*D+S*R+T*O,i[6]=M*F+S*z+T*B,i[7]=M*E+S*I+T*N,i[8]=C*P+L*V+A*U,i[9]=C*D+L*R+A*O,i[10]=C*F+L*z+A*B,i[11]=C*E+L*I+A*N,e},invMatrix2x2:function(e,t,r,i){var o=new Array(4),n=1/(e*i-t*r);return o[0]=n*i,o[1]=-n*t,o[2]=-n*r,o[3]=n*e,o},invMatrix3x3:function(e,t,r,i,o,n,a,s,l){detA=1/(e(l*o-s*n)-i(l*t-s*r)+a*(n*t-o*r));var c=new Array(9);return c[0]=detA*(l*o-s*n),c[1]=-detA*(l*t-s*r),c[2]=detA*(n*t-o*r),c[3]=-detA*(l*i-a*n),c[4]=detA*(l*e-a*r),c[5]=-detA*(n*e-i*r),c[6]=detA*(s*i-a*o),c[7]=-detA*(s*e-a*t),c[8]=detA*(o*e-i*t),c},invMatrix4x4:function(e,t){var t=new Array(16),r=e[10]*e[15],i=e[14]*e[11],o=e[6]*e[15],n=e[14]*e[7],a=e[6]*e[11],s=e[10]*e[7],l=e[2]*e[15],c=e[14]*e[3],h=e[2]*e[11],u=e[10]*e[3],p=e[2]*e[7],d=e[6]*e[3],f=e[8]*e[13],m=e[12]*e[9],v=e[4]*e[13],g=e[12]*e[5],y=e[4]*e[9],x=e[8]*e[5],w=e[0]*e[13],b=e[12]*e[1],_=e[0]*e[9],M=e[8]*e[1],S=e[0]*e[5],T=e[4]*e[1],C=r*e[5]+n*e[9]+a*e[13]-(i*e[5]+o*e[9]+s*e[13]),L=i*e[1]+l*e[9]+u*e[13]-(r*e[1]+c*e[9]+h*e[13]),A=o*e[1]+c*e[5]+p*e[13]-(n*e[1]+l*e[5]+d*e[13]),P=s*e[1]+h*e[5]+d*e[9]-(a*e[1]+u*e[5]+p*e[9]),D=e[0]*C+e[4]*L+e[8]*A+e[12]*P;if(Math.abs(D)<1e-5){if(console.log("Warning can't inverse matrix "+e),void 0!==t)return!1;t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}var F=1/D,E=F*C,V=F*L,R=F*A,z=F*P,I=F*(i*e[4]+o*e[8]+s*e[12]-(r*e[4]+n*e[8]+a*e[12])),U=F*(r*e[0]+c*e[8]+h*e[12]-(i*e[0]+l*e[8]+u*e[12])),O=F*(n*e[0]+l*e[4]+d*e[12]-(o*e[0]+c*e[4]+p*e[12])),B=F*(a*e[0]+u*e[4]+p*e[8]-(s*e[0]+h*e[4]+d*e[8])),N=F*(f*e[7]+g*e[11]+y*e[15]-(m*e[7]+v*e[11]+x*e[15])),k=F*(m*e[3]+w*e[11]+M*e[15]-(f*e[3]+b*e[11]+_*e[15])),G=F*(v*e[3]+b*e[7]+S*e[15]-(g*e[3]+w*e[7]+T*e[15])),j=F*(x*e[3]+_*e[7]+T*e[11]-(y*e[3]+M*e[7]+S*e[11])),W=F*(v*e[10]+x*e[14]+m*e[6]-(y*e[14]+f*e[6]+g*e[10])),H=F*(_*e[14]+f*e[2]+b*e[10]-(w*e[10]+M*e[14]+m*e[2])),X=F*(w*e[6]+T*e[14]+g*e[2]-(S*e[14]+v*e[2]+b*e[6])),q=F*(S*e[10]+y*e[2]+M*e[6]-(_*e[6]+T*e[10]+x*e[2]));return t[0]=E,t[1]=V,t[2]=R,t[3]=z,t[4]=I,t[5]=U,t[6]=O,t[7]=B,t[8]=N,t[9]=k,t[10]=G,t[11]=j,t[12]=W,t[13]=H,t[14]=X,t[15]=q,t},Raycast:function(e,t,r,i,o,n,a){var s=e.length,l=new _P(0,0),c=new _P(0,0),h=new _P(0,0),u=new _P(0,0),p=new _P(0,0);l.x=r,l.y=i,c.x=r+o,c.y=i+n,null==a&&(a={dist:0,edge:0,line:{x1:0,y1:0,x2:0,y2:0},intersectPt:{x:0,y:0},norm:{x:0,y:0},refl:{x:0,y:0}}),a.dist=1/0;for(var d,f=0;s>f;f+=2)if(d=f/2,t[d]===t[d+1]){h.x=e[f],h.y=e[f+1],u.x=e[f+2],u.y=e[f+3];var m=this.RayLineIntersection(l,c,h,u,p);m&&this.updateISC(o,n,l,h,u,p,f/2,a,m)}return a.dist!=1/0?a:null},Raycast2:function(e,t,r){var i=e.length,o=new _P(0,0),n=new _P(0,0),a=new _P(0,0),s=new _P(0,0),l=new _P(0,0);o.x=t.x,o.y=t.z,n.x=r.x,n.y=r.z;var c={dist:0,edge:0,line:{x1:0,y1:0,x2:0,y2:0},intersectPt:{x:0,y:0},norm:{x:0,y:0},refl:{x:0,y:0}};c.dist=1/0;for(var h=0;i>h;h+=2){a.x=e[h].x,a.y=e[h].z,s.x=e[h+1].x,s.y=e[h+1].z;var u=this.RayLineIntersection(o,n,a,s,l);u&&this.updateISC(r.x,r.y,o,a,s,l,h/2,c,u)}return c.dist!=1/0?c:null},RayLineIntersection:function(e,t,r,i,o){var n=e.x-t.x,a=r.x-i.x,s=e.y-t.y,l=r.y-i.y,c=n*l-s*a;if(0==c)return null;var h=e.x*t.y-e.y*t.x,u=r.x*i.y-r.y*i.x,p=o,d=1/c;return p.x=(h*a-n*u)*d,p.y=(h*l-s*u)*d,this.InRect(p,r,i)?s>0&&p.y>e.y||0>s&&p.y<e.y?null:n>0&&p.x>e.x||0>n&&p.x<e.x?null:p:null},InRect:function(e,t,r){return t.x==r.x?e.y>=Math.min(t.y,r.y)&&e.y<=Math.max(t.y,r.y):t.y==r.y?e.x>=Math.min(t.x,r.x)&&e.x<=Math.max(t.x,r.x):e.x>=Math.min(t.x,r.x)&&e.x<=Math.max(t.x,r.x)&&e.y>=Math.min(t.y,r.y)&&e.y<=Math.max(t.y,r.y)?!0:!1},updateISC:function(e,t,r,i,o,n,a,s,l){var c=_P.dist(r,n);if(c<s.dist){var h=1/_P.dist(i,o),u=-(o.y-i.y)*h,p=(o.x-i.x)*h,d=2*(e*u+t*p);s.dist=c,s.norm.x=u,s.norm.y=p,s.refl.x=-d*u+e,s.refl.y=-d*p+t,s.edge=a,s.line.x1=i.x,s.line.y1=i.y,s.line.x2=o.x,s.line.y2=o.y,s.intersectPt.x=l.x,s.intersectPt.y=l.y}},projectPointOnLine:function(e,t){var r=e.length,i=new _P(0,0),o=new _P(0,0),n=new _P(0,0);new _P(0,0);i.x=t.x,i.y=t.z;for(var a={dist:1/0,edge:0,line:{x1:0,y1:0,x2:0,y2:0},point:{x:0,y:0},norm:{x:0,y:0}},s=0;r>s;s+=2)o.x=e[s].x,o.y=e[s].z,n.x=e[s+1].x,n.y=e[s+1].z,this.pointLineDist(i,o,n,s>>1,a);var l=1/a.dist;return a.norm.x=(t.x-a.point.x)*l,
a.norm.y=(t.z-a.point.y)*l,a},pointLineDist:function(e,t,r,i,o){var n,a,s=e.x,l=e.y,c=t.x,h=t.y,u=r.x,p=r.y,d=s-c,f=l-h,m=u-c,v=p-h,g=d*m+f*v,y=m*m+v*v,x=g/y;0>x||c==u&&h==p?(n=c,a=h):x>1?(n=u,a=p):(n=c+x*m,a=h+x*v);var w=s-n,b=l-a,_=Math.sqrt(w*w+b*b);_<o.dist&&(o.dist=_,o.edge=i,o.point.x=n,o.point.y=a,o.line.x1=t.x,o.line.y1=t.y,o.line.x2=r.x,o.line.y2=r.y)},slice:function(e,t,r,i,o){if(this.ContainsPoint(e,t,r)||this.ContainsPoint(e,i,o))return[e.slice(0)];for(var n=new _P(t,r),a=new _P(i,o),s=[],l=[],c=0;c<e.length;c+=2)l.push(new _P(e[c],e[c+1]));for(var c=0;c<l.length;c++){var h=new _P(0,0);h=this._GetLineIntersection(n,a,l[c],l[(c+1)%l.length],h),h&&(h.flag=!0,s.push(h),l.splice(c+1,0,h),c++)}if(0==s.length)return[e.slice(0)];var u=function(e,t){return _P.dist(n,e)-_P.dist(n,t)};s.sort(u);for(var p=[],d=0;s.length>0;){var f=(l.length,s[0]),m=s[1],v=l.indexOf(f),g=l.indexOf(m),y=!1;if(this._firstWithFlag(l,v)==g?y=!0:(f=s[1],m=s[0],v=l.indexOf(f),g=l.indexOf(m),this._firstWithFlag(l,v)==g&&(y=!0)),y){d--;var x=this._getPoints(l,v,g);p.push(x),l=this._getPoints(l,g,v),f.flag=m.flag=!1,s.splice(0,2),0==s.length&&p.push(l)}else d++,s.reverse();if(d>1)break}for(var w=[],c=0;c<p.length;c++){for(var b=p[c],_=[],M=0;M<b.length;M++)_.push(b[M].x,b[M].y);w.push(_)}return w},containsPoint:function(e,t,r){for(var i,o,n=e.length>>1,a=e[2*n-2]-t,s=e[2*n-1]-r,l=0,c=0;n>c;c++)if(i=a,o=s,a=e[2*c]-t,s=e[2*c+1]-r,!(0>o&&0>s||o>=0&&s>=0||0>i&&0>a)){var h=i+(a-i)*-o/(s-o);h>0&&l++}return 1==(1&l)},extractLineStringInsidePoly:function(e,t,r){var i=[];if(e.length!==t.length)return console.warn("poly bounding box have wrong structure!!!"),!1;for(var o=[],n=0;n<e.length;n++)o.push(e[n]),o.push(t[n]);for(var n=0;n<r.length-4;n+=4)this.containsPoint(o,r[n],r[n+1])&&this.containsPoint(o,r[n+2],r[n+3])&&(i.push(r[n]),i.push(r[n+1]),i.push(r[n+2]),i.push(r[n+3]));return i},convex:function(e,t,r,i,o,n){return(t-i)*(o-r)+(r-e)*(n-i)>=0},polyIsConvex:function(e){if(e.length<6)return!0;for(var t=e.length-4,r=0;t>r;r+=2)if(!this.convex(e[r],e[r+1],e[r+2],e[r+3],e[r+4],e[r+5]))return!1;return this.convex(e[t],e[t+1],e[t+2],e[t+3],e[0],e[1])&&this.convex(e[t+2],e[t+3],e[0],e[1],e[2],e[3])?!0:!1},getLineIntersection:function(e,t,r,i,o){var n=e.x-t.x,a=r.x-i.x,s=e.y-t.y,l=r.y-i.y,c=n*l-s*a;if(0==c)return null;var h=e.x*t.y-e.y*t.x,u=r.x*i.y-r.y*i.x,p=o;return p.x=(h*a-n*u)/c,p.y=(h*l-s*u)/c,this.InRect(p,e,t)&&this.InRect(p,r,i)?p:null},getAreaPoly:function(e){if(e.length<6)return 0;for(var t=e.length-2,r=0,i=0;t>i;i+=2)r+=(e[i+2]-e[i])*(e[i+1]+e[i+3]);return r+=(e[0]-e[t])*(e[t+1]+e[1]),.5*-r},removDuplicateArray:function(e){for(var t={},r=0;r<e.length;r++)t[e[r]]=!0;var i=[];for(var o in t)i.push(o);return i},checkSign:function(e,t){return e*t>=0},getLineIntersection2:function(e,t,r,i){var o,n,a,s,l,c,h,u,p,d,f,m,v,g=e.x,y=e.y,x=t.x,w=t.y,b=r.x,_=r.y,M=i.x,S=i.y;if(o=w-y,a=g-x,l=x*y-g*w,p=o*b+a*_+l,d=o*M+a*S+l,0!=p&&0!=d&&this.checkSign(p,d))return-1;if(n=S-_,s=b-M,c=M*_-b*S,h=n*g+s*y+c,u=n*x+s*w+c,0!=h&&0!=u&&this.checkSign(h,u))return-1;if(f=o*s-n*a,0==f)return-1;m=0>f?-f/2:f/2;var T={x:0,y:0,dist:0};return v=a*c-s*l,0>v?T.x=(v-m)/f:T.x=(v+m)/f,v=n*l-o*c,0>v?T.y=(v-m)/f:T.y=(v+m)/f,T.dist=Math.sqrt((T.x-e.x)*(T.x-e.x)+(T.y-e.y)*(T.y-e.y)),T},getIntersectLinePoly:function(e,t,r){var i=e.length,o=new _P(0,0),n=new _P(0,0),a=new _P(0,0),s=new _P(0,0),l=new _P(0,0);o.x=t.x,o.y=t.z,n.x=r.x,n.y=r.z;for(var c=1/0,h=0;i>h;h+=2){a.x=e[h].x,a.y=e[h].z,s.x=e[h+1].x,s.y=e[h+1].z;var u=this.getLineIntersection2(o,n,a,s);-1!==u&&(u.dist<c&&(l.x=u.x,l.y=u.y),c=u.dist)}return l},lambert93ToWGS:function(e){var t=new OpenLayers.LonLat(e.x,e.y);return t.transform(new OpenLayers.Projection("EPSG:2154"),new OpenLayers.Projection("CRS:84")),t},wgsToLambert93:function(e){var t=new OpenLayers.LonLat(e.lon,e.lat);return t.transform(new OpenLayers.Projection("CRS:84"),new OpenLayers.Projection("EPSG:2154")),{x:t.lon,y:t.lat}},cardan_cubic_roots:function(e,t,r,i){if(0==e)return this.quadratic_roots(t,r,i);var o=-t/(3*e),n=e*e,a=t*t,s=e*n,l=t*a,c=r/e-a/(3*n),h=l/(13.5*s)+i/e-t*r/(3*n);if(0==c){var u=this.cubic_root(-h)+o;return[u,u,u]}var p=c*c*c*4/27,d=h*h+p;if(d>0){var f=Math.sqrt(d),m=this.cubic_root((-h+f)/2),v=this.cubic_root((-h-f)/2);return[m+v+o]}if(0==d){var g=3*h/c,y=o+g,x=o-.5*g;return[y,x,x]}var w=Math.acos(-h/Math.sqrt(p)),b=2*Math.sqrt(-c/3);return[b*Math.cos(w/3)+o,b*Math.cos((w+Math.PI)/3)+o,b*Math.cos((w+2*Math.PI)/3)+o]},quadratic_roots:function(e,t,r){var i=t*t-4*e*r;if(0>i)return[];var o=-t/(2*e);if(0==i)return[o];var n=Math.sqrt(i)/(2*e);return[o-n,o+n]},sgn:function(e){return(e>0)-(0>e)},cubic_root:function(e){return this.sgn(e)*Math.pow(Math.abs(e),1/3)},getSunPosition:function(){function e(e){return e.valueOf()/y-.5+x}function t(t){return e(t)-w}function r(e,t){return v(p(e)*d(b)-f(t)*p(b),d(e))}function i(e,t){return m(p(t)*d(b)+d(t)*p(b)*p(e))}function o(e,t,r){return v(p(e),d(e)*p(t)-f(r)*d(t))}function n(e,t,r){return m(p(t)*p(r)+d(t)*d(r)*d(e))}function a(e,t){return g*(280.16+360.9856235*e)-t}function s(e){return g*(357.5291+.98560028*e)}function l(e){return g*(1.9148*p(e)+.02*p(2*e)+3e-4*p(3*e))}function c(e,t){var r=102.9372*g;return e+t+r+u}var h=Math,u=h.PI,p=h.sin,d=h.cos,f=h.tan,m=h.asin,v=h.atan2,g=u/180,y=864e5,x=2440588,w=2451545,b=23.4397*g;return function(e,h,p){var d=g*-p,f=g*h,m=t(e),v=s(m),y=l(v),x=c(v,y),w=i(x,0),b=r(x,0),_=a(m,d),M=_-b;return{altitude:n(M,f,w),azimuth:o(M,f,w)+u}}},getSunPositionInScene:function(e,i,o){if(void 0==i){var n=r(2).convertCoordVec3(r(2).getCurrentPosition(),"EPSG:2154","CRS:84");i=n.z,o=n.x}var a=t.getSunPosition()(e,i,o),s=2e3,l={x:0,y:0};l.x=Math.sin(a.azimuth)*s,l.y=Math.cos(a.azimuth)*s;var c=Math.sin(a.altitude)*s;return{x:l.x,y:c,z:l.y}}};return t}.apply(t,o),!(void 0!==n&&(e.exports=n))},function(t,r){t.exports=e},function(e,t,r){var i;i=function(){var e="stereopolis",t={init:function(t){e=t},dataURL:{defaultUrlMetaDataProviderPos:"php/getInfosFromPos.php?",defaultUrlMetaDataProviderName:"php/getInfosFromName.php?",defaultUrlImageFile:"",defaultUrlMetaProviderSensor:"php/getSensorsInfos.php",defaultUrlBuildingFootprint:"http://wxs.ign.fr/",defaultUrlDTM:"php/getDTM.php?",defaultUrlPointCloud:"http://www.itowns.fr/viewer/",defaultUrl3DBuilding:"http://www.itowns.fr/viewer/Bati3D_LOB/Version4LODS/"},phpDir:"php/",set conf(t){e="dell"===t?"dell":"stereopolis"},serverList:["stereopolis","dell"],server:{dell:{url:"http://DEL1101W001",iipService:""},stereopolis:{url:"http://www.itowns.fr",iipService:""},get url(){return this[e].url},get iipService(){return this[e].iipService}},geoAPIKey:""};return t}.call(t,r,t,e),!(void 0!==i&&(e.exports=i))},function(e,t,r){var i,o;i=[r(1),r(3),r(4),r(15),r(12)],o=function(e,t,r,i,o){var a,s,l,c,h,u,p,d=!1,f=!1,m=2,v=null,g=null,y=!1,x=null,w=null,b=null,_=[],M=null,S=null,T=null,C=!1,L=!1,A=null,P=null,D=6,F=null,E={tabBoundingBox:[],drawBB:!1,drawBB2:!1,BBCreated:!1,alphaBB:0,heightBB:0,bg:null,BBMesh:null,tAtemp:null,ptBtemp:null,ptCtemp:null,ptDtemp:null,ptA2:null,ptB2:null,ptC2:null,ptD2:null,point2:null,lengthAB:null,lengthAC:null,lengthAPoint:null,nbClassLidar:1,lidarClassDragActive:!1,infoBB:null,tabBB:[],tabLines:[],tabText:[],tabPoints:[],tabPointsImported:[],initSurface:function(){y=!0,this.initSurfacesType(),g=b},initSurfacesType:function(){x=[new e.MeshBasicMaterial({color:16777215,overdraw:!1,depthTest:!1,transparent:!0,opacity:.5}),new e.MeshBasicMaterial({color:16777215,wireframe:!0,depthTest:!1,transparent:!0,opacity:.6})],w=[new e.MeshBasicMaterial({color:16777215,overdraw:!1,transparent:!0,opacity:.3})];var r=new e.PlaneGeometry(4,2,1);b=new e.Mesh(r,new e.MeshBasicMaterial({side:e.DoubleSide,color:16777215,wireframe:!1,depthTest:!1,transparent:!0,opacity:.5}));var i=new e.CircleGeometry(1,32);S=new e.Mesh(i,new e.MeshBasicMaterial({side:e.DoubleSide,color:16777215,overdraw:!1,depthTest:!1,transparent:!0,opacity:.5})),S.position.y=1e4,b.position.y=1e4,t.addToScene(b),t.addToScene(S),T=new e.Mesh(new e.CylinderGeometry(.1,.1,1,12,1),new e.MeshBasicMaterial({color:16777215,overdraw:!1,depthTest:!1,transparent:!0,opacity:.5})),T.position.y=4e4,t.addToScene(T)},setSurfaceType:function(e){"Rectangle"==e?(v="Rectangle",g=b,S.position.y=1e4,g=b,S.position.y=1e4):(v="Circle",g=S,b.position.y=1e4,g=S,b.position.y=1e4)},setSurfaceScaleAndOpacity:function(e){S.scale.x=e,S.scale.y=e,b.scale.x=e,b.scale.y=e,S.material.opacity=e>.5?.5:.8*e,b.material.opacity=e>.5?.5:.8*e},drawSurface:function(i,o){i=t.getPositionCloserToCam(i,.05),y||this.initSurface(),this.setSurfaceVisibility(!0),g.position=i;var n=o.clone(),a=new e.Vector3(0,0,1),s=(new e.Vector3).crossVectors(a,n);(1===n.y||-1===n.y)&&(s=new e.Vector3(1,0,0));var l=Math.acos(n.dot(a)),c=new e.Matrix4;c=r.rotateByAxis(c,s,l),g.rotation.setFromRotationMatrix(c),0==g.rotation.x||g.rotation.x<-3.14?this.setSurfaceType("Rectangle"):this.setSurfaceType("Circle")},setSurfaceColor:function(t){var r=(new e.Color).setHSL(0,t,.5).getHex();g.material=new e.MeshBasicMaterial({side:e.DoubleSide,color:r,overdraw:!1,depthTest:!1,transparent:!0,opacity:.7})},setSurfaceVisibility:function(e){b.visible=S.visible=e},drawSphereAt:function(r,i,o,n){i=i||.5;var a=-1;o=o||"#"+Math.floor(16777215*Math.random()).toString(16);var s=new e.SphereGeometry(i,8,8),l=new e.Mesh(s,new e.MeshBasicMaterial({transparent:!0,depthTest:!1,opacity:.8,color:o}));return l.position=r,t.addToScene(l),n&&(this.tabPointsImported.length>0&&(a=this.searchClosePointsID(r)),this.tabPoints.push(new e.Vector4(r.x,r.y,r.z,a))),a},addPointsFromFile:function(e){this.tabPointsImported.push(e)},searchClosePointsID:function(e){for(var t=!1,r=0,i=-1;!t&&r<this.tabPointsImported.length;){var o=this.tabPointsImported[r];t=e.distanceTo(o)<1,t&&(i=o.w),++r}return i},drawCircleAt:function(e,t,r,i){e.ctxTex.beginPath(),e.ctxTex.fillStyle="#FF4422",e.ctxTex.arc(t,r,4,0,2*Math.PI),e.ctxTex.fill(),e.xmt.map.needsUpdate=!0},drawVerticalShapeAt:function(e,t){T.position=e,T.material.opacity=t/100},drawLine:function(r,i){var o=null,n=null;if(d)o=r,n=i,s.geometry.vertices[0]=o,s.geometry.vertices[1]=n,s.geometry.verticesNeedUpdate=!0;else{d=!0,a=new e.Geometry,o=r,n=i,a.vertices.push(o),a.vertices.push(n);var l=new e.LineBasicMaterial({color:11206415,overdraw:!0,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:4});s=new e.Line(a,l,e.LinePieces),s.dynamic=!0,s.name="lineMes",t.addToScene(s)}this.tabLines.push(s)},drawOneMoreLine:function(r,i){var o=new e.Geometry,n=r,a=i;o.vertices.push(n),o.vertices.push(a);var s=new e.LineBasicMaterial({color:11206415,overdraw:!0,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:4}),l=new e.Line(o,s,e.LinePieces);l.name="lineMesMore"+this.tabLines.length,t.addToScene(l),this.tabLines.push(l)},removeAllMeasures:function(){this.removeAllPoints(),this.removeAllLines(),this.removeAllText()},removeAllLines:function(){for(var e=0;e<this.tabLines.length;++e)t.removeFromScene(this.tabLines[e]);this.tabLines=[]},getAllLines:function(){return this.tabLines},getAllLinesForSHP:function(){for(var e=[],r=t.getZeroAsVec3D(),i=0;i<this.tabLines.length;++i){for(var o=this.tabLines[i].geometry.vertices,n=[],a=0;a<o.length;++a){var s=o[a],l=[];l.push(s.x+r.x,s.z+r.z,s.y+r.y),n.push(l)}e.push(n)}return e},getAllPointsForSHP:function(){for(var e=[],r=t.getZeroAsVec3D(),i=0;i<this.tabPoints.length;++i){var o=this.tabPoints[i],n=[];n.push(o.x+r.x,o.z+r.z,o.y+r.y,o.w),e.push(n)}return e},removeAllText:function(){for(var e=0;e<this.tabText.length;++e)t.removeFromScene(this.tabText[e]);this.tabText=[]},removeAllPoints:function(){for(var e=0;e<this.tabPoints.length;++e)t.removeFromScene(this.tabPoints[e]);this.tabPoints=[]},drawLines:function(r){var i=t.getZero();for(var o in r){var n=r[o],a=new e.Vector3(n.pt1.x-i.x,n.pt1.y-i.y,n.pt1.z-i.z),s=new e.Vector3(n.pt2.x-i.x,n.pt2.y-i.y,n.pt2.z-i.z);this.drawOneMoreLine(a,s);var l=a.distanceTo(s).toFixed(2);this.showTextAtPos3D(l+"m",s,50)}},drawProfiles:function(e,r){var i={x:649e3,y:0,z:684e4},o={x:i.x-t.getZeroAsVec3D().x,y:i.y-t.getZeroAsVec3D().y,z:i.z-t.getZeroAsVec3D().z};for(var n in e){var a=e[n];if(a.gid>r){console.log("profile.gid",a.gid,"new data from algo!");var s=a.pt_trottoirs_gauche,l=a.pt_chaussee,c=a.pt_trottoirs_droite;s=s.substring(s.indexOf("(")+1),l=l.substring(l.indexOf("(")+1),c=c.substring(c.indexOf("(")+1);var h=s.split(","),u=l.split(","),p=c.split(",");this.drawSubProfile(h,11141290,o),this.drawSubProfile(u,696490,o),this.drawSubProfile(p,11141290,o)}}},createMeshFromSelectedPoints:function(r,o){for(var n=new e.Geometry,a=r.length-4;a<r.length;++a)n.vertices.push(r[a]);n.faces.push(new e.Face4(0,1,2,3)),n.computeFaceNormals();var s=i.getShaderMat();A=new e.Mesh(n,s),A.material.side=e.DoubleSide,A.material.transparent=!1,t.addToScene(A)},createMesh:function(r){for(var o={x:649e3,y:0,z:684e4},n={x:o.x-t.getZeroAsVec3D().x,y:o.y-t.getZeroAsVec3D().y,z:o.z-t.getZeroAsVec3D().z},a=new e.Geometry,s=0;s<r.length;s+=1){var l=r[s],c=l.pt_trottoirs_gauche,h=l.pt_chaussee,u=l.pt_trottoirs_droite;c=c.substring(c.indexOf("(")+1),h=h.substring(h.indexOf("(")+1),u=u.substring(u.indexOf("(")+1);var p=c.split(","),d=h.split(","),f=u.split(","),m=p[0].split(" "),v=p[p.length-1].split(" "),g=f[f.length-1].split(" "),y=f[0].split(" ");a.vertices.push(new e.Vector3(parseFloat(g[0])+n.x,parseFloat(g[2])+n.y,parseFloat(g[1])+n.z)),a.vertices.push(new e.Vector3(parseFloat(y[0])+n.x,parseFloat(y[2])+n.y,parseFloat(y[1])+n.z));for(var x=d.length,w=0;x>w;w++){var b=d[w].split(" ");a.vertices.push(new e.Vector3(parseFloat(b[0])+n.x,parseFloat(b[2])+n.y,parseFloat(b[1])+n.z))}if(a.vertices.push(new e.Vector3(parseFloat(m[0])+n.x,parseFloat(m[2])+n.y,parseFloat(m[1])+n.z)),a.vertices.push(new e.Vector3(parseFloat(v[0])+n.x,parseFloat(v[2])+n.y,parseFloat(v[1])+n.z)),s>0)for(var _=x+4,M=a.vertices.length-2*_;M<a.vertices.length-_-1;++M)M+_+1<a.vertices.length&&(a.faces.push(new e.Face3(M,M+_,M+_+1)),a.faces.push(new e.Face3(M,M+_+1,M+1)))}a.computeFaceNormals(),A&&t.removeFromScene(A);var S=i.getShaderMat();A=new e.Mesh(a,S),A.material.side=e.DoubleSide,A.material.transparent=!1,t.addToScene(A)},drawArrPoints:function(r){for(var i=new e.Geometry,o=[],n=0;n<r.length;n++){var a=new e.Color(65280);o.push(a),i.vertices.push(r[n])}i.colors=o;var s=new e.ParticleBasicMaterial({size:.03,vertexColors:!0,transparent:!0}),l=new e.ParticleSystem(i,s);_.push(l),t.addToScene(l)},drawInliersPoints:function(r,i){for(var o=new e.Geometry,n=[],a=0;a<i.length;a++){var s=new e.Color(255);n.push(s),o.vertices.push(r[i[a]])}o.colors=n;var l=new e.ParticleBasicMaterial({size:.03,vertexColors:!0,transparent:!0}),c=new e.ParticleSystem(o,l);_.push(c),t.addToScene(c)},removePtsNeibords:function(){for(var e=0;e<_.length;e++)t.removeFromScene(_[e])},drawSubProfile:function(r,i,o){for(var n=new e.Geometry,a=0;a<r.length-1;a++){var s=r[a].split(" ");n.vertices.push(new e.Vector3(parseFloat(s[0])+o.x,parseFloat(s[2])+o.y,parseFloat(s[1])+o.z)),s=r[a+1].split(" "),n.vertices.push(new e.Vector3(parseFloat(s[0])+o.x,parseFloat(s[2])+o.y,parseFloat(s[1])+o.z))}var l=new e.LineBasicMaterial({color:i,overdraw:!0,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:2}),c=new e.Line(n,l,e.LinePieces);t.addToScene(c)},drawLinesNotConnected:function(r,i){for(var i=i||16711935,o=new e.Geometry,n=0;n<r.length-1;n+=2){var a=r[n];o.vertices.push(a);var s=r[n+1];o.vertices.push(s)}var l=new e.LineBasicMaterial({color:i,overdraw:!0,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:2}),c=new e.Line(o,l,e.LinePieces);t.addToScene(c)},initializeTextCanvas:function(){l=document.createElement("canvas"),l.width=l.height=350,f=!0},setTextToCanvas:function(e,t){c=l.getContext("2d"),c.clearRect(0,0,l.width,l.height),c.shadowColor="#000",c.shadowBlur=7,c.fillStyle="rgba(173,216,230,1)",c.font=t.toString()+"pt arial bold";for(var r=e.split(";"),i=0;i<r.length;++i)c.fillText(r[i],10,(i+1)*t)},setTextMeshPosition:function(e){h.position=e},initializeTextMesh:function(r,i,o){p=new e.MeshBasicMaterial({map:new e.Texture(l),transparent:!0,depthTest:!1}),p.map.needsUpdate=!0,p.side=e.DoubleSide,h=new e.Mesh(new e.PlaneGeometry(m,m),p),h.name="textMes",this.setTextMeshPosition(r,i,o),h.scale.x=h.scale.y=h.scale.z=1,h.quaternion=t.getCamera().quaternion},showTextAtPos3D2:function(r,i,o){if(f)this.setTextMeshPosition(i),this.setTextToCanvas(r,o),u=new e.Texture(l),h.material.map=u,u.needsUpdate=!0,h.updateMatrix();else{this.initializeTextCanvas(),this.setTextToCanvas(r,o),u=new e.Texture(l),u.needsUpdate=!0;var n=new e.MeshBasicMaterial({map:u,transparent:!0});h=new e.Mesh(new e.PlaneGeometry(l.width,l.height),n),h.rotation=t.getCamera().rotation,h.doubleSided=!0,h.position=i,t.addToScene(h)}},showTextAtPos3DSameMesure:function(r,i,o){o=o||50,f?(this.setTextToCanvas(r,o),this.setTextMeshPosition(i),p.map=new e.Texture(l),p.map.needsUpdate=!0,h.updateMatrix()):(this.initializeTextCanvas(),this.setTextToCanvas(r,o),this.initializeTextMesh(i),p.map.needsUpdate=!0,p.side=e.DoubleSide,t.addToScene(h),p.map.needsUpdate=!0,p.side=e.DoubleSide),this.tabText.push(h)},showTextAtPos3D:function(e,r,i){i=i||50,f?(this.setTextToCanvas(e,i),this.initializeTextMesh(r)):(this.initializeTextCanvas(),this.setTextToCanvas(e,i),this.initializeTextMesh(r)),t.addToScene(h),this.tabText.push(h),f=!1},drawBBTemp:function(r,i,o,n,a){this.BBCreated?(this.BBMesh.geometry.vertices[0]=r,this.BBMesh.geometry.vertices[1]=i,this.BBMesh.geometry.vertices[2]=o,this.BBMesh.geometry.vertices[3]=n,this.BBMesh.geometry.vertices[4]=new e.Vector3(r.x,r.y+a,r.z),this.BBMesh.geometry.vertices[5]=new e.Vector3(i.x,i.y+a,i.z),this.BBMesh.geometry.vertices[6]=new e.Vector3(o.x,o.y+a,o.z),this.BBMesh.geometry.vertices[7]=new e.Vector3(n.x,n.y+a,n.z),this.BBMesh.geometry.__dirtyVertices=!0,this.BBMesh.geometry.verticesNeedUpdate=!0):(this.bg=new e.Geometry,this.bg.dynamic=!0,this.bg.vertices.push(r),this.bg.vertices.push(i),this.bg.vertices.push(o),this.bg.vertices.push(n),this.bg.vertices.push(new e.Vector3(r.x,r.y+a,r.z)),this.bg.vertices.push(new e.Vector3(i.x,i.y+a,i.z)),this.bg.vertices.push(new e.Vector3(o.x,o.y+a,o.z)),this.bg.vertices.push(new e.Vector3(n.x,n.y+a,n.z)),this.bg.faces.push(new e.Face3(0,1,3)),this.bg.faces.push(new e.Face3(0,3,2)),this.bg.faces.push(new e.Face3(4,5,7)),this.bg.faces.push(new e.Face3(4,7,6)),this.bg.faces.push(new e.Face3(0,1,5)),this.bg.faces.push(new e.Face3(0,5,4)),this.bg.faces.push(new e.Face3(1,3,7)),this.bg.faces.push(new e.Face3(1,7,5)),this.bg.faces.push(new e.Face3(3,2,6)),this.bg.faces.push(new e.Face3(3,6,7)),this.bg.faces.push(new e.Face3(2,0,4)),this.bg.faces.push(new e.Face3(2,4,6)),this.bg.dynamic=!0,this.BBMesh&&(this.BBMesh.position.y=0),this.BBMesh=new e.Mesh(this.bg,new e.MeshBasicMaterial({wireframe:!0,wireframeLinewidth:3,color:11206415,transparent:!0,depthTest:!1})),this.BBMesh.geometry.dynamic=!0,this.BBMesh.geometry.verticesNeedUpdate=!0,this.BBMesh.dynamic=!0,this.BBCreated=!0,t.addToScene(this.BBMesh))},displayBBInfo:function(r,i,o,n,a,s,l,c,h){this.infoBB&&(this.infoBB.mesh.y-=1),this.infoBB=InfoBox;var u,p,d,f,m,v,g;u=Math.min(Math.abs(r),Math.abs(i)).toFixed(2),d=Math.max(Math.abs(r),Math.abs(i)).toFixed(2),p=Math.abs(c).toFixed(2),f=(u*d*p).toFixed(2),m=o,v=new e.Vector3(parseFloat(n.x)+parseFloat(t.getZero().x),parseFloat(n.y)+parseFloat(t.getZero().y)+.7,parseFloat(n.z)+parseFloat(t.getZero().z)),g="Unknown",.66>d/p?2>d&&(g="Human"):d/u>1.5&&(g=d>3.5&&7>d&&4>p?"Car":"Scooter"),this.infoBB.initialize(h,u,p,d,f,m,v,g),this.infoBB.setPosition(new e.Vector3(n.x,n.y+c,n.z)),this.infoBB.addToScene(),this.tabBB.push(this.infoBB)},addTextPanel:function(e,r,i){r.x+=.5,r.y+=.5,i=i||{};var o=i.style||{},n=i.delimiter||"\n",a=i.name||"",s=document.createElement("canvas"),l=s.getContext("2d"),c=o.fontSize||20;l.font=c+"pt arial bold",e=e.split(n);for(var h=l.measureText(e[0]).width,u=e.length,p=1;u>p;p++){var d=l.measureText(e[p]).width;d>h&&(h=d)}var f=o.padding||10;h+=2*f,s.width=h;var m=o.lineSpace||3;for(s.height=u*c+2*f+(u-1)*m,l.fillStyle="rgba(0,51,102,0.1)",l.fillRect(0,0,h,s.height),l.shadowColor="#000",l.shadowBlur=7,l.fillStyle="rgba(255,255,255,1)",l.font=c+"pt arial bold",p=0;u>p;p++)l.fillText(e[p],f,f+c*(p+1)+p*m);return t.addTextPanel(s,r,a)},getSurfaceType:function(){return v},copyToClipboard:function(e){window.clipboardData&&clipboardData.setData?clipboardData.setData("text",e):console.log("browser does not support clipboard")},setZebraOn:function(e){C=e},getZebraOn:function(){return C},initializeZebra:function(r,i){var o=new e.PlaneGeometry(4,2,1);o.dynamic=!0;var n=e.ImageUtils.loadTexture("images/zebra.png"),a=new e.MeshBasicMaterial({map:n,side:e.DoubleSide,transparent:!0,depthTest:!1});M=new e.Mesh(o,a),t.addToScene(M);var s=(i.z-r.z)/(i.x-r.x),l=new e.Vector3(-s,0,1).normalize(),c=3,h=r.clone().add(l.clone().multiplyScalar(c)),u=i.clone().add(l.clone().multiplyScalar(c)),p=M.geometry.vertices;p[0]=r,p[1]=i,p[2]=h,p[3]=u,L=!0},setZebraPosition:function(t,r,i){if(C)if(L&&"ON"!=i){var o=(r.z-t.z)/(r.x-t.x),n=new e.Vector3(-o,0,1).normalize(),a=3,s=t.clone().add(n.clone().multiplyScalar(a)),l=r.clone().add(n.clone().multiplyScalar(a)),c=M.geometry.vertices;c[0]=t,c[1]=r,c[2]=s,c[3]=l,M.geometry.verticesNeedUpdate=!0}else this.initializeZebra(t,r)},initializeBufferGeometry:function(){this.createShaderLine();F=new e.BufferGeometry,F.dynamic=!0,F.attributes={position:{itemSize:3,array:new Float32Array(3*D),numItems:3*D,dynamic:!0},color:{itemSize:3,array:new Float32Array(3*D),numItems:3*D,dynamic:!0},displacement:{itemSize:3,array:new Float32Array(3*D),numItems:3*D,dynamic:!0}},this.initializeBufferValues()},initializeBufferValues:function(){var t=F.attributes.color.array,r=F.attributes.position.array,i=F.attributes.displacement.array,o=new e.Color;o.setHSL(.2,.5,.7);var a=10;for(n=0;n<D;++n)r[3*n+0]=5,r[3*n+1]=5,r[3*n+2]=5,i[3*n+0]=(2*Math.random()-1)*a,i[3*n+1]=(2*Math.random()-1)*a,i[3*n+2]=(2*Math.random()-1)*a,t[3*n+0]=o.r,t[3*n+1]=o.g,t[3*n+2]=o.b},createShaderLine:function(){var t={displacement:{type:"v3",value:[]},color:{type:"v3",value:[]}},r={alpha:{type:"f",value:.4},point_size:{type:"f",value:10}};P=new e.ShaderMaterial({uniforms:r,attributes:t,vertexShader:o.shaders["shaderLine.vs"],fragmentShader:o.shaders["shaderLine.fs"],vertexColors:e.VertexColors,depthTest:!1,side:e.DoubleSide,transparent:!0})},drawLine3D:function(r,i){null==r&&(r=new e.Vector3(0,0,0),i=new e.Vector3(10,10,10)),this.initializeBufferGeometry();var o=new e.Geometry;o.vertices.push(r),o.vertices.push(i);var n=new e.Line(F,P);t.addToScene(n),e.PiecewiseLinearCurve3=e.Curve.create(function(e){this.points=void 0==e?[]:e},function(t){var r=this.points,i=(r.length-1)*t,o=Math.floor(i),n=o<r.length-1?o+1:o,a=r[o],s=r[n],l=i-o;return(new e.Vector3).copy(a).lerp(s,l)});for(var a=[],s=0;38>s;s++)a.push(new e.Vector3(Math.cos(s*Math.PI/3),s/18-1,Math.sin(s*Math.PI/3)).multiplyScalar(48));var l=new e.PiecewiseLinearCurve3(a),c=1024,h=.2,u=8,p=!1,d=new e.TubeGeometry(l,c,h,u,p),f=new e.MeshBasicMaterial({color:4227327,opacity:.4,transparent:!0,side:e.DoubleSide,depthTest:!1}),m=new e.Mesh(d,f);t.addToScene(m)},drawLine3DTube:function(t){e.PiecewiseLinearCurve3=e.Curve.create(function(e){this.points=void 0==e?[]:e},function(t){var r=this.points,i=(r.length-1)*t,o=Math.floor(i),n=o<r.length-1?o+1:o,a=r[o],s=r[n],l=i-o;return(new e.Vector3).copy(a).lerp(s,l)});var r=new e.PiecewiseLinearCurve3(t),i=1024,o=.5,n=8,a=!1,s=new e.TubeGeometry(r,i,o,n,a),l=new e.MeshBasicMaterial({color:4227327,opacity:.8,transparent:!0,side:e.DoubleSide,depthTest:!0}),c=new e.Mesh(s,l);return c}};return E}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1),r(38),r(5),r(13)],o=function(e,t,r,i){var o={initiated:!1,sensors:[],init:function(){var e=this,t=i.getMetaDataSensorURL();r.getJSON(t,function(r){e.handleDBData(t,r)})},handleDBData:function(e,r){for(var i=0;i<r.length;++i)this.sensors.push(new t(e,r[i]));this.initiated=!0,console.log("Orientation module is loaded")},computeMatOriFromHeadingPitchRoll:function(t,r,i){t=parseFloat(t)/180*Math.PI,r=parseFloat(r)/180*Math.PI,i=parseFloat(i)/180*Math.PI;var o=(new e.Quaternion).setFromEuler(new e.Euler(-r,t,-i,"YXZ"),!0);return(new e.Matrix4).makeRotationFromQuaternion(o)},getPosition:function(){for(var t=new e.Vector3(0,0,0),r=0;r<this.sensors.length;++r)t=t.add(this.sensors[r].position);return t.divideScalar(this.sensors.length)},getDistortion:function(e){return this.sensors[e].distortion},getSommet:function(e){return this.sensors[e].position},getProjCam:function(e){return this.sensors[e].projection},getMatCam:function(e){return this.sensors[e].rotation},getMask:function(e){return this.sensors[e].mask}};return o}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var o,n;o=[r(1),r(8),r(17),r(13),r(19),r(11)],n=function(e,t,r,o,n,a){var s=new e.Object3D,l="",c=!1,h=!0,u={url_format:"",easting:0,northing:0,altitude:0,pan_xml_heading_pp:0,pan_xml_pitch_pp:0,pan_xml_roll_pp:0,pan_time_utc:"",near_address_num:0,near_address_name:"",id_platform:""},p=null,d=15,f={MOVE:function(){r.updateDataFromRGE()}},m={init:function(e,r){p=r,o.init(p),o.getMetaDataFromPos(e.x,e.z,50).then(function(e){u=e[0],c=!0,t.init()}),this.testInitOri()},testInitOri:function(){t.initiated?r.init(u,p):(console.log("Panoramic module is initiated"),setTimeout(m.testInitOri,300))},setInfos:function(e,t){l=e||"",u.url_format=t.url_format||"",u.id_platform=t.id_platform||"",u.easting=parseFloat(t.easting)||0,u.northing=parseFloat(t.northing)||0,u.altitude=parseFloat(t.altitude)||0,u.pan_xml_heading_pp=parseFloat(t.heading)||parseFloat(t.pan_xml_heading_pp)||0,u.pan_xml_pitch_pp=parseFloat(t.pitch)||parseFloat(t.pan_xml_pitch_pp)||0,u.pan_xml_roll_pp=parseFloat(t.roll)||parseFloat(t.pan_xml_roll_pp)||0,u.pan_time_utc=t.time_utc||t.pan_time_utc||"",u.near_address_num=t.near_address_num||0,u.near_address_name=t.near_address_name||""},isInitiated:function(){return c},updateGlobalPano:function(e,t,r,i,o){this.setInfos(e,o),this.updatePanoTextures(e,t),this.updatePanoCoord(r,i)},updatePanoCoord:function(e,t){s.position=e,s.rotation=t},initInfo:function(e,t){l=e,u.filename=t},loadName:function(e){_name=e,this.loadUrl("http://www.itowns.fr/cgi-bin/iipsrv.fcgi?FIF=/iipimages3/"+e+".jp2")},removeFromScene:function(){scene.remove(this.panoGlobale)},setNameForCamera:function(e){var t=new RegExp("-[0-9][0-9]-");return l.replace(t,"-"+e+"-")},rotateImage:function(e,t){var r=this.getTileTexture(e);r.rotate(t)},getPanoGlobale:function(){return s},getPanoInfos:function(){return u},getPanoPos:function(){return new e.Vector3(u.easting,u.altitude,u.northing)},setURLWithPos:function(){var e={},t=window.location.search.substr(1).split("&");for(i=0;i<t.length;i++)data=t[i].split("="),e[data[0].toLowerCase()]=data[1];e.panoname=e.panoname||"TerMob2-130116_0923-00-00002_0000623",e.easting=e.easting,e.northing=e.northing,e.heading=e.heading||0,e.duree=e.duree||"25",e.particlesize=e.particlesize||"0.01",e.mobile="true"==e.mobile||!1,e.nc="true"==e.nc||!1,"undefined"==typeof e.debug||"true"!==e.debug?e.debug=!1:e.debug=!0;var r="?easting="+u.easting+"&northing="+u.northing+"&mobile="+e.mobile+"&nc="+e.nc;window.history.pushState("string test","titre",r)},getPanoName:function(){var e=u.url_format.substring(u.url_format.lastIndexOf("/")+1);return e.replace("{cam_id_pos}","00")},getPanoNameAtIndice:function(e){for(var t=u.filename,r=(parseInt(t.substr(t.length-5))+e).toString();r.length<5;)r="0"+r;return t.substr(0,t.length-5)+r},getPanoUrl:function(){return l},getVisibility:function(){return h},getPanoDate:function(){var e=u.url_format.substr(u.url_format.indexOf("-")+1,6),t="20"+e.substr(0,2)+"_"+e.substr(2,2)+"_"+e.substr(4,2);return t},getPanoHours:function(){var e=u.pan_time_utc.split(":");return parseFloat(e[0])},getPanoSecondsInHour:function(){var e=u.pan_time_utc.split(":");return 60*parseInt(e[1])+parseInt(e[2])},getDecalageUTC:function(){return d},setDecalageUTC:function(){},setPanoInfos:function(e){u=e},setPosition:function(e){u.easting=e.x,u.northing=e.z,u.altitude=e.y},setVisibility:function(e){console.log("panoramic visibility: ",e),null==e&&(e=!0),h=e,r.setVisibility(e)},tweenGeneralOpacityUp:function(){r.tweenGeneralOpacityUp()},jumpTo:function(e){for(var t=l.search(".jp2"),r=(parseInt(l.substr(t-5,5),10)+e).toString();r.length<4;)r="0"+r;var i=new RegExp("_000.*.jp2");_name=l.replace(i,"_000"+r);var o=_name.lastIndexOf("Paris");return _name=_name.substr(o),_name},processEvent:function(e){f[e]&&f[e]()}};return m}.apply(t,o),!(void 0!==n&&(e.exports=n))},function(e,t,r){var i;i=function(){var e={},t={register:function(t,r){e.hasOwnProperty(t)?e[t].push(r):e[t]=[r]},send:function(t){var r=e[t];if(r)for(var i=0,o=r.length;o>i;i++)r[i].processEvent(t)}};return t}.call(t,r,t,e),!(void 0!==i&&(e.exports=i))},function(e,t,r){var i,o;i=[r(1),r(3),r(18),r(6),r(4),r(9),r(13),r(10),r(23),r(17),r(8),r(7),r(14),r(19)],o=function(e,t,r,i,o,n,a,s,l,c,h,u,p,d){var f=null,m={},v=null,g=null,y=null,x=null,w=null,b=!1,_=!1,M=0;_barycentre={x:.025244939999999993,y:.8656037999999999,z:-.14644352},_count=0,_preIntersectionToLook=null;var S={BATI_DISTANCE:200,ROAD_DISTANCE:1e4,ROAD_HEIGHT:-2.5,intersectionToLook:{},clickAndGoActivated:!1,autoPlay:!1,init:function(e){y=e,g=n.getPanoInfos(),x=2,w=.52},moveWithTransition:function(r,i,o,a){if("undefined"==typeof r)throw TypeError("Can't move to undefined panoramic");a=a||0,(Math.abs(parseFloat(r.easting)-t.getZero().x)>2e4||Math.abs(parseFloat(r.northing)-t.getZero().z)>2e4)&&(t.setZero({x:parseFloat(r.easting),y:parseFloat(r.altitude),z:parseFloat(r.northing)}),s.send("CHANGEPIVOT")),n.setInfos(r.url,r);var c=new e.Vector4(parseFloat(r.easting)-t.getZeroAsVec3D().x,parseFloat(r.altitude)-t.getZeroAsVec3D().y,parseFloat(r.northing)-t.getZeroAsVec3D().z,1),u=h.computeMatOriFromHeadingPitchRoll(r.pan_xml_heading_pp,r.pan_xml_pitch_pp,r.pan_xml_roll_pp);_barycentre=h.getPosition(),_barycentre.applyProjection(u),t.translateCameraSmoothly(c.x+_barycentre.x,c.y+_barycentre.y+a,c.z+_barycentre.z);this.getDirectoryFromPanoName(r.filename);l.isInitiated()&&l.changePanoTextureAfterloading(r,c,u),"SkyToGround"==o?(t.setSpeedTurnCam(.04),t.cameraLookHorizontally(),console.log("looook horizontally")):null!=i&&"Rectangle"==o&&(t.cameraLookAtPosition(i.x,i.y,i.z,c.x,c.y+a,c.z),t.setSpeedTurnCam(.04)),s.send("MOVE")},moveWithTransitionTablePositions:function(r,i,o,a){if("undefined"==typeof r)throw TypeError("Can't move to undefined panoramic");var c=new e.Vector4(parseFloat(r.easting)-y.easting,parseFloat(r.altitude)-y.altitude,parseFloat(r.northing)-y.northing,1);t.translateCameraSmoothly(c.x,c.y,c.z),n.setInfos(r.url,r);var h=parseFloat(r.pan_xml_heading_pp)/180*Math.PI,u=Math.cos(h),p=Math.sin(h),d=new e.Matrix4(u,0,-p,0,0,1,0,0,p,0,u,0,0,0,0,1);l.changePanoTextureAfterloading(r,c,d),null!=o&&"Rectangle"==a&&(t.cameraLookAtPosition(o.x,o.y,o.z,c.x,c.y,c.z),t.setSpeedTurnCam(.04)),setTimeout(function(){S.loadTablePositions(i)},1e3),s.send("MOVE")},moveWithTransitionTablePanos:function(r,i){if("undefined"==typeof r)throw TypeError("Can't move to undefined panoramic");(Math.abs(parseFloat(r.easting)-t.getZero().x)>2e4||Math.abs(parseFloat(r.northing)-t.getZero().z)>2e4)&&(t.setZero({x:parseFloat(r.easting),y:parseFloat(r.altitude),z:parseFloat(r.northing)}),s.send("CHANGEPIVOT")),n.setInfos(r.url,r);var o=new e.Vector4(parseFloat(r.easting)-t.getZeroAsVec3D().x,parseFloat(r.altitude)-t.getZeroAsVec3D().y,parseFloat(r.northing)-t.getZeroAsVec3D().z,1),a=h.computeMatOriFromHeadingPitchRoll(r.pan_xml_heading_pp,r.pan_xml_pitch_pp,r.pan_xml_roll_pp),c=this.getCameraVersionFromPanoName(r.filename);2==c?_barycentre=h.getBarycentreV2():_barycentre=h.getBarycentreV1(),_barycentre.applyProjection(a),t.translateCameraSmoothly(o.x+_barycentre.x,o.y+_barycentre.y,o.z+_barycentre.z);this.getDirectoryFromPanoName(r.filename);if(l.isInitiated()&&l.changePanoTextureAfterloading(r,o,a),
i.length>0&&_){var u=new e.Vector3(i[0].easting-t.getZeroAsVec3D().x,i[0].altitude-t.getZeroAsVec3D().y,i[0].northing-t.getZeroAsVec3D().z);t.cameraLookAtPosition(u.x,u.y,u.z,o.x,o.y,o.z),t.setSpeedTurnCam(.04)}this.autoPlay&&setTimeout(function(){S.loadTablePanos(i)},1200),s.send("MOVE")},moveWithTransitionTablePanosAERIAL:function(r,i){if("undefined"==typeof r)throw TypeError("Can't move to undefined panoramic");(Math.abs(parseFloat(r.easting)-t.getZero().x)>2e4||Math.abs(parseFloat(r.northing)-t.getZero().z)>2e4)&&(t.setZero({x:parseFloat(r.easting),y:parseFloat(r.altitude),z:parseFloat(r.northing)}),s.send("CHANGEPIVOT")),n.setInfos(r.url,r);var o=new e.Vector4(parseFloat(r.easting)-t.getZeroAsVec3D().x,parseFloat(r.altitude)-t.getZeroAsVec3D().y,parseFloat(r.northing)-t.getZeroAsVec3D().z,1),a=h.computeMatOriFromHeadingPitchRoll(r.pan_xml_heading_pp,r.pan_xml_pitch_pp,r.pan_xml_roll_pp);_barycentre=h.getPosition(),_barycentre.applyProjection(a),t.translateCameraSmoothly(o.x+_barycentre.x,o.y+_barycentre.y,o.z+_barycentre.z);this.getDirectoryFromPanoName(r.filename);if(l.isInitiated()&&l.changePanoTextureAfterloading(r,o,a),i.length>0&&_){var c=new e.Vector3(i[0].easting-t.getZeroAsVec3D().x,i[0].altitude-t.getZeroAsVec3D().y,i[0].northing-t.getZeroAsVec3D().z);t.cameraLookAtPosition(c.x,c.y,c.z,o.x,o.y,o.z),t.setSpeedTurnCam(.04)}this.autoPlay&&setTimeout(function(){S.loadTablePanos(i)},1200),s.send("MOVE")},moveWithTransitionAerial:function(r,i){(Math.abs(r.x-t.getZero().x)>2e4||Math.abs(r.z-t.getZero().z)>2e4)&&(t.setZero({x:r.x,y:r.y,z:r.z}),s.send("CHANGEPIVOT"));var o=t.getZeroAsVec3D(),a=new e.Vector4(r.x-o.x,r.y-o.y,r.z-o.z,1);n.setPosition(r),c.setRoadOn(!1),Math.abs(r.x-651463)>5e3&&c.setOrthoPhotoOn(!0),t.translateCameraSmoothly(a.x,a.y+200,a.z),console.log("intersectionToLook",i),null!=i&&(t.cameraLookAtPosition(i.x-o.x-30,i.y-o.y,i.z-o.z,a.x,a.y+200,a.z),t.setSpeedTurnCam(.01),t.setSpeedTransCam(.03)),s.send("MOVE"),setTimeout(function(){t.setSpeedTransCam(.04),t.setSpeedTurnCam(.1)},4500)},getCameraVersionFromPanoName:function(e){var t=2;return t},getDirectoryFromPanoName:function(e){var t=e;return t},loadPanoFromNameAndLookAtIntersection:function(e,t){this.intersectionToLook=t;var i=a.getMetaDataPHPFromNameRequest(e);r.sendCommand(i,function(e){e=e[0],e?S.moveWithTransition(e):o.noPanoramic()},!0)},loadNextPanoByName:function(e){var t=a.getMetaDataPHPFromNameRequest(e);r.sendCommand(t,function(e){e=e[0],e?S.moveWithTransition(e):o.noPanoramic()},!0)},goToClosestPosition:function(e,t){t=t||{},t.distance=t.distance||50,t.alti=t.alti||0,a.getMetaDataFromPos(e.x,e.z,t.distance).then(function(e){var r=e[0];r&&S.moveWithTransition(r,t.intersectionToLook,t.surfaceType,t.alti)})},loadTablePositions:function(e){if(e.length>0){var t=e.shift(),i="php/getInfosFromPos.php?easting="+t.x+"&northing="+t.z+"&distneighbours=15";r.sendCommand(i,function(t){t=t[0],t?S.moveWithTransitionTablePositions(t,e):o.noPanoramic()},!0)}},loadTablePanos:function(e){if(e.length>0){var r=e.shift();S.moveWithTransitionTablePanos(r,e)}else setTimeout(function(){t.setSpeedTransCam(.04),t.setSpeedTurnCam(.1)},2e3),$("#b1").animate({height:"0px"},2e3),$("#b2").animate({height:"0px"},2e3)},loadTablePositions2:function(r){var i=80;if(M<r.length){var o=r[M];M++;var n=new e.Vector4(parseFloat(o.x)-t.getZeroAsVec3D().x,i,parseFloat(o.z)-t.getZeroAsVec3D().z,1);if(t.translateCameraSmoothly(n.x,n.y,n.z),M<r.length-2){var a=new e.Vector3(r[M+2].x-t.getZeroAsVec3D().x,r[M+2].y-t.getZeroAsVec3D().y+50,r[M+2].z-t.getZeroAsVec3D().z);a.x!==n.x&&a.z!==n.z?(t.cameraLookAtPosition(a.x,a.y,a.z,n.x,n.y,n.z),_preIntersectionToLook=a):console.log("Conflict, skip this point")}this.autoPlay&&setTimeout(function(){S.loadTablePositions2(r)},1200)}else console.log("Done"),_count=0,M=0,setTimeout(function(){t.setSpeedTransCam(.04),t.setSpeedTurnCam(.1)},2e3)},initialized:function(){return b},isOnArrow:function(){for(var e in m)if(m[e].intersected)return!0;return!1},rotateArrows:function(e){t.rotateY(e,f)},getDistanceToRoadPlane:function(e,r){var i=t.getIntersected(e,r,[v]);if(0!==i.length){var o=i[0].point.x,n=i[0].point.z,a=t.getCameraPosition().x,s=t.getCameraPosition().z;return Math.sqrt((a-o)*(a-o)+(s-n)*(s-n))}return-1},moveOnRoad:function(i,n){var a=t.getIntersected(i,n,[v]);if(0===a.length)o.noPanoramic();else{var s=a[0].point;console.log("intersectedPoint: ",s),"52"===e.REVISION?s.addSelf(t.getZeroAsVec3D()):s.add(t.getZeroAsVec3D());var l="php/getNeighboursAsText.php?easting="+s.x+"&northing="+s.z+"&distneighbours=10";r.sendCommand(l,function(e){if(e.length>2){var t=r.getPanoInfo(e,1)[0];S.move(t)}else o.noPanoramic()})}},toggleRoadPlane:function(){v.visible=!v.visible}};return S}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(5),r(4)],o=function(e,t){var r={shadersURL:null,shaderNum:null,shaders:{},loaded:!1,attributes:{displacementx:{type:"f",value:[]},displacementy:{type:"f",value:[]},displacementz:{type:"f",value:[]},colorattribute:{type:"v3",value:[]},uniqueid:{type:"i",value:[]}},uniformslaser:{indice_time_laser:{type:"f",value:1},currentidwork:{type:"f",value:100},point_size:{type:"f",value:1},alpha:{type:"f",value:.5},colortest:{type:"v3",value:{}},nb_time:{type:"i",value:0}},init:function(e){this.shadersURL=e,this.shaderNum=e.length},loadShaders:function(){function t(e,t){r++,i.shaders[t]=e,r===i.shaderNum&&(i.loaded=!0,console.log("Shaders are loaded"))}for(var r=0,i=this,o=0;o<i.shaderNum;o++){var n=i.shadersURL[o];!function(r){e.ajax({url:r,success:function(i){t(e(i).html(),r.substr(r.lastIndexOf("/")+1))},dataType:"html",error:function(){console.error("Unable to load shader from file"+r)}})}(n)}},shaderTextureProjective5VS:["#ifdef GL_ES","precision  highp float;","#endif","uniform mat4 mvpp0;","uniform mat4 mvpp1;","uniform mat4 mvpp2;","uniform mat4 mvpp3;","uniform mat4 mvpp4;","uniform vec4 translation0;","uniform vec4 translation1;","uniform vec4 translation2;","uniform vec4 translation3;","uniform vec4 translation4;","varying vec4 v_texcoord0;","varying vec4 v_texcoord1;","varying vec4 v_texcoord2;","varying vec4 v_texcoord3;","varying vec4 v_texcoord4;","uniform mat4 mvpp0bis;","uniform mat4 mvpp1bis;","uniform mat4 mvpp2bis;","uniform mat4 mvpp3bis;","uniform mat4 mvpp4bis;","uniform vec4 translation0bis;","uniform vec4 translation1bis;","uniform vec4 translation2bis;","uniform vec4 translation3bis;","uniform vec4 translation4bis;","varying vec4 v_texcoord0bis;","varying vec4 v_texcoord1bis;","varying vec4 v_texcoord2bis;","varying vec4 v_texcoord3bis;","varying vec4 v_texcoord4bis;","vec4 pos;","void main() {","    pos =  vec4(position,1.);","        v_texcoord0 =  mvpp0 * (pos- translation0);","        v_texcoord1 =  mvpp1 * (pos- translation1);","        v_texcoord2 =  mvpp2 * (pos- translation2);","        v_texcoord3 =  mvpp3 * (pos- translation3);","        v_texcoord4 =  mvpp4 * (pos- translation4);","        v_texcoord0bis =  mvpp0bis * (pos- translation0bis);","        v_texcoord1bis =  mvpp1bis * (pos- translation1bis);","        v_texcoord2bis =  mvpp2bis * (pos- translation2bis);","        v_texcoord3bis =  mvpp3bis * (pos- translation3bis);","        v_texcoord4bis =  mvpp4bis * (pos- translation4bis);","    gl_Position  =  projectionMatrix *  modelViewMatrix * pos;","}"],shaderTextureProjective5FS:["#ifdef GL_ES","precision  highp float;","#endif","uniform sampler2D   texture0;","uniform sampler2D   texture1;","uniform sampler2D   texture2;","uniform sampler2D   texture3;","uniform sampler2D   texture4;","varying vec4 v_texcoord0;","varying vec4 v_texcoord1;","varying vec4 v_texcoord2;","varying vec4 v_texcoord3;","varying vec4 v_texcoord4;","uniform sampler2D   texture0bis;","uniform sampler2D   texture1bis;","uniform sampler2D   texture2bis;","uniform sampler2D   texture3bis;","uniform sampler2D   texture4bis;","varying vec4 v_texcoord0bis;","varying vec4 v_texcoord1bis;","varying vec4 v_texcoord2bis;","varying vec4 v_texcoord3bis;","varying vec4 v_texcoord4bis;","vec4 color = vec4(0.,0.,0.,0.);","vec2 corrected0,corrected1,corrected2,corrected3,corrected4;","vec2 corrected0bis,corrected1bis,corrected2bis,corrected3bis,corrected4bis;","float width = 2048.0;","float height = 2048.0;"," vec2 correctDistortionAndCoord(vec4 v_texcoord){","      vec2 normCoord = v_texcoord.xy/(v_texcoord.w);","      return vec2(normCoord.x/width , 1. - normCoord.y/height); ","  }"," void main(void)"," {  "," corrected0 = correctDistortionAndCoord(v_texcoord0);"," corrected1 = correctDistortionAndCoord(v_texcoord1);"," corrected2 = correctDistortionAndCoord(v_texcoord2);"," corrected3 = correctDistortionAndCoord(v_texcoord3);"," corrected4 = correctDistortionAndCoord(v_texcoord4);"," corrected0bis = correctDistortionAndCoord(v_texcoord0bis);"," corrected1bis = correctDistortionAndCoord(v_texcoord1bis);"," corrected2bis = correctDistortionAndCoord(v_texcoord2bis);"," corrected3bis = correctDistortionAndCoord(v_texcoord3bis);"," corrected4bis = correctDistortionAndCoord(v_texcoord4bis);","  if ((corrected0.x>0. && corrected0.x<1. && corrected0.y>0. && corrected0.y<1.) && v_texcoord0.w>0.){","      color = texture2D(texture0,corrected0);","  }else","  if ((corrected1.x>0. && corrected1.x<1. && corrected1.y>0. && corrected1.y<1.) && v_texcoord1.w>0.){","      color = texture2D(texture1,corrected1);","  }else","  if ((corrected2.x>0. && corrected2.x<1. && corrected2.y>0. && corrected2.y<1.) && v_texcoord2.w>0.){","      color = texture2D(texture2,corrected2);","  }else","  if ((corrected3.x>0. && corrected3.x<1. && corrected3.y>0. && corrected3.y<1.) && v_texcoord3.w>0.){","      color = texture2D(texture3,corrected3);","  }else","  if ((corrected4.x>0. && corrected4.x<1. && corrected4.y>0. && corrected4.y<1.) && v_texcoord4.w>0.){","      color = texture2D(texture4,corrected4);","  }","  color.a = 1.0; ","  gl_FragColor = color; ","} "],shaderTextureProjective2VS:["#ifdef GL_ES","precision  highp float;","#endif","uniform mat4 mvpp0;","uniform mat4 mvpp1;","uniform mat4 mvpp2;","uniform mat4 mvpp3;","uniform mat4 mvpp4;","uniform mat4 mvpp0bis;","uniform mat4 mvpp1bis;","uniform mat4 mvpp2bis;","uniform mat4 mvpp3bis;","uniform mat4 mvpp4bis;","uniform vec4 translation0;","uniform vec4 translation1;","uniform vec4 translation2;","uniform vec4 translation3;","uniform vec4 translation4;","uniform vec4 translation0bis;","uniform vec4 translation1bis;","uniform vec4 translation2bis;","uniform vec4 translation3bis;","uniform vec4 translation4bis;","varying vec4 v_texcoord0;","varying vec4 v_texcoord1;","varying vec4 v_texcoord2;","varying vec4 v_texcoord3;","varying vec4 v_texcoord4;","varying vec4 v_texcoord0bis;","varying vec4 v_texcoord1bis;","varying vec4 v_texcoord2bis;","varying vec4 v_texcoord3bis;","varying vec4 v_texcoord4bis;","vec4 pos;","void main() {","    pos =  vec4(position,1.);","    v_texcoord0 =  mvpp0 * (pos- translation0);","    v_texcoord1 =  mvpp1 * (pos- translation1);","    v_texcoord2 =  mvpp2 * (pos- translation2);","    v_texcoord3 =  mvpp3 * (pos- translation3);","    v_texcoord4 =  mvpp4 * (pos- translation4);","    v_texcoord0bis =  mvpp0bis * (pos- translation0bis);","    v_texcoord1bis =  mvpp1bis * (pos- translation1bis);","    v_texcoord2bis =  mvpp2bis * (pos- translation2bis);","    v_texcoord3bis =  mvpp3bis * (pos- translation3bis);","    v_texcoord4bis =  mvpp4bis * (pos- translation4bis);","    gl_Position  =  projectionMatrix *  modelViewMatrix * pos;","}"],shaderTextureProjective2FS:["#ifdef GL_ES","precision  highp float;","#endif","uniform mat4 mvpp0;","uniform mat4 mvpp1;","uniform mat4 mvpp2;","uniform mat4 mvpp3;","uniform mat4 mvpp4;","uniform mat4 mvpp0bis;","uniform mat4 mvpp1bis;","uniform mat4 mvpp2bis;","uniform mat4 mvpp3bis;","uniform mat4 mvpp4bis;","uniform sampler2D   texture0;","uniform sampler2D   texture1;","uniform sampler2D   texture2;","uniform sampler2D   texture3;","uniform sampler2D   texture4;","uniform sampler2D   texture0bis;","uniform sampler2D   texture1bis;","uniform sampler2D   texture2bis;","uniform sampler2D   texture3bis;","uniform sampler2D   texture4bis;","uniform sampler2D   textureMask0;","uniform sampler2D   textureMask1;","uniform sampler2D   textureMask2;","uniform sampler2D   textureMask3;","uniform sampler2D   textureMask4;","uniform vec4 translation;","uniform vec4 translationbis;","varying vec4 v_texcoord0;","varying vec4 v_texcoord1;","varying vec4 v_texcoord2;","varying vec4 v_texcoord3;","varying vec4 v_texcoord4;","varying vec4 v_texcoord0bis;","varying vec4 v_texcoord1bis;","varying vec4 v_texcoord2bis;","varying vec4 v_texcoord3bis;","varying vec4 v_texcoord4bis;","uniform float indice_time0;","uniform float indice_time1;","uniform float indice_time2;","uniform float indice_time3;","uniform float indice_time4;","uniform vec4 distortion0;","uniform vec4 distortion1;","uniform vec4 distortion2;","uniform vec4 distortion3;","uniform vec4 distortion4;","vec2 size = vec2(2048.0,2048.0);","vec2 pps = vec2(1042.178,1020.435);"," vec2 correctDistortionAndCoord(vec4 dist, vec4 texcoord){","      vec2 p = texcoord.xy/texcoord.w;","      vec2 v = p - pps;","      float v2 = dot(v,v);","      if(v2>dist.w || texcoord.w < 0.) return vec2(-1.);","      float r = v2*(dist.x+v2*(dist.y+v2*dist.z));","      return p+r*v; ","  }","vec4 getColor(sampler2D texture, sampler2D mask, vec2 p)"," {  ","   vec2 d2 = min(p.xy,size-p.xy);","   float d = min(d2.x,d2.y);","   if (d<0.) return vec4(0.);","   p /= size;","   p.y = 1. - p.y; ","   vec4 c = texture2D(texture,p);","   float m = min(d*0.1,1.)*(1.-texture2D(mask,p).r);","   return c*m;"," }","vec4 getColor(sampler2D texture, sampler2D mask, vec4 dist, vec4 coord)"," {  ","   return getColor(texture,mask,correctDistortionAndCoord(dist,coord));"," }"," void main(void)"," {  ","  vec4 c0 = indice_time0*getColor(texture0,textureMask0,distortion0,v_texcoord0);","  vec4 c1 = indice_time1*getColor(texture1,textureMask1,distortion1,v_texcoord1);","  vec4 c2 = indice_time2*getColor(texture2,textureMask2,distortion2,v_texcoord2);","  vec4 c3 = indice_time3*getColor(texture3,textureMask3,distortion3,v_texcoord3);","  vec4 c4 = indice_time4*getColor(texture4,textureMask4,distortion4,v_texcoord4);","  vec4 c5 = (1.-indice_time0)*getColor(texture0bis,textureMask0,distortion0,v_texcoord0bis);","  vec4 c6 = (1.-indice_time1)*getColor(texture1bis,textureMask1,distortion1,v_texcoord1bis);","  vec4 c7 = (1.-indice_time2)*getColor(texture2bis,textureMask2,distortion2,v_texcoord2bis);","  vec4 c8 = (1.-indice_time3)*getColor(texture3bis,textureMask3,distortion3,v_texcoord3bis);","  vec4 c9 = (1.-indice_time4)*getColor(texture4bis,textureMask4,distortion4,v_texcoord4bis);","  vec4 color = c0+c1+c2+c3+c4+c5+c6+c7+c8+c9;","  if(color.a>1.) color /= color.a;","  gl_FragColor = color; ","} "],shaderTextureProjective2LightFS:["#ifdef GL_ES","precision highp float;","#endif","uniform float alpha;","uniform mat4 mvpp0;","uniform mat4 mvpp1;","uniform mat4 mvpp2;","uniform mat4 mvpp3;","uniform mat4 mvpp4;","uniform mat4 mvpp0bis;","uniform mat4 mvpp1bis;","uniform mat4 mvpp2bis;","uniform mat4 mvpp3bis;","uniform mat4 mvpp4bis;","uniform sampler2D   texture0;","uniform sampler2D   texture1;","uniform sampler2D   texture2;","uniform sampler2D   texture3;","uniform sampler2D   texture4;","uniform sampler2D   texture0bis;","uniform sampler2D   texture1bis;","uniform sampler2D   texture2bis;","uniform sampler2D   texture3bis;","uniform sampler2D   texture4bis;","uniform sampler2D   textureMask0;","uniform sampler2D   textureMask1;","uniform sampler2D   textureMask2;","uniform sampler2D   textureMask3;","uniform sampler2D   textureMask4;","uniform vec4 translation;	","uniform vec4 translationbis;","varying vec4 v_texcoord0;","varying vec4 v_texcoord1;","varying vec4 v_texcoord2;","varying vec4 v_texcoord3;","varying vec4 v_texcoord4;","varying vec4 v_texcoord0bis;","varying vec4 v_texcoord1bis;","varying vec4 v_texcoord2bis;","varying vec4 v_texcoord3bis;","varying vec4 v_texcoord4bis;","uniform float indice_time0;","uniform float indice_time1;","uniform float indice_time2;","uniform float indice_time3;","uniform float indice_time4;","uniform vec4 intrinsic300;","uniform vec4 intrinsic301;","uniform vec4 intrinsic302;","uniform vec4 intrinsic303;","uniform vec4 intrinsic304;","uniform int blendingOn;","uniform int mobileOn;","uniform int fog;","float width = 2048.0;","float height = 2048.0;","float dist;","float cpps = 1042.178;","float lpps = 1020.435;","vec2 pps = vec2(cpps,lpps);","vec4 color = vec4(0.38,0.34,0.34,0.5);	","vec4 colorbis = vec4(0.,0.,0.,0.);","vec4 saveColor = vec4(0.,0.,0.,0.);","vec2 corrected0, corrected1, corrected2, corrected3, corrected4;","vec2 corrected0bis, corrected1bis, corrected2bis, corrected3bis, corrected4bis;"," vec2 correctDistortionAndCoord(vec4 dist, vec4 v_texcoord){","  vec2 v = v_texcoord.xy/v_texcoord.w - pps;","   float v2 = dot(v,v);","   if(v2>dist.w) return vec2(-2.,-2.); // false;","   float r = v2*(dist.x+v2*(dist.y+v2*dist.z));","   vec2 normCoord = v_texcoord.xy/(v_texcoord.w) + r*v;","  return vec2(normCoord.x/width , 1. - normCoord.y/height); ","   }","  void main(void)","     {	","        bool blending = (blendingOn == 1) && (mobileOn == 0);","   saveColor = color;","     corrected0bis = correctDistortionAndCoord(intrinsic300, v_texcoord0bis);","    corrected1bis = correctDistortionAndCoord(intrinsic301, v_texcoord1bis);","    corrected2bis = correctDistortionAndCoord(intrinsic302, v_texcoord2bis);","    corrected3bis = correctDistortionAndCoord(intrinsic303, v_texcoord3bis);","    corrected4bis = correctDistortionAndCoord(intrinsic304, v_texcoord4bis);","          if ((corrected0bis.x>0. && corrected0bis.x<1. && corrected0bis.y>0. && corrected0bis.y<1.) && v_texcoord0bis.w>0.){","       colorbis = texture2D(texture0bis,corrected0bis);","           if(blending){   ","         if (((corrected1bis.x>=0. && corrected1bis.x<=1. && corrected1bis.y>=0. && corrected1bis.y<=1.) && v_texcoord1bis.w>0.)&& corrected0bis.x < 0.03){ ","            colorbis = colorbis * (corrected0bis.x/ 0.03) +   texture2D(texture1bis,corrected1bis) * (1.- (corrected0bis.x)/ 0.03);","        }","      if (((corrected2bis.x>=0. && corrected2bis.x<=1. && corrected2bis.y>=0. && corrected2bis.y<=1.) && v_texcoord2bis.w>0.)&& corrected0bis.y >0.97){ ","          colorbis = colorbis *  (1. - (corrected0bis.y-0.97)/0.03)  +   texture2D(texture2bis,corrected2bis) * ((corrected0bis.y-0.97)/0.03);","       }","          if (((corrected3bis.x>0. && corrected3bis.x<1. && corrected3bis.y>0. && corrected3bis.y<1.) && v_texcoord3bis.w>0.)&& corrected0bis.x > 0.97){ ","             colorbis = colorbis *  (1. - (corrected0bis.x-0.97)/0.03)   +   texture2D(texture3bis,corrected3bis) * ((corrected0bis.x-0.97)/0.03);","         }","              if (((corrected4bis.x>=0. && corrected4bis.x<=1. && corrected4bis.y>=0. && corrected4bis.y<=1.) && v_texcoord4bis.w>0.)&& corrected0bis.y < 0.03){ ","                colorbis = colorbis *  (corrected0bis.y/0.03)  +   texture2D(texture4bis,corrected4bis) * ( 1. - corrected0bis.y/0.03);","             }","              if (((corrected1bis.x>=0. && corrected1bis.x<=1. && corrected1bis.y>=0. && corrected1bis.y<=1.) && v_texcoord1bis.w>0.)&& corrected0bis.x < 0.03){ ","                colorbis = colorbis * (corrected0bis.x/ 0.03) +   texture2D(texture1bis,corrected1bis) * (1.- (corrected0bis.x)/ 0.03);         ","           }","        }","       color = indice_time0 * (saveColor - colorbis) + colorbis;","  }else","     if ((corrected1bis.x>0. && corrected1bis.x<1. && corrected1bis.y>0. && corrected1bis.y<1.) && v_texcoord1bis.w>0.){","               colorbis =  texture2D(texture1bis,corrected1bis);","              colorbis.a = 1.- texture2D(textureMask1,corrected1bis).a;","             if(blending){","              if (((corrected2bis.x>=0. && corrected2bis.x<=1. && corrected2bis.y>=0. && corrected2bis.y<=1.) && v_texcoord2bis.w>0.)&& corrected1bis.x> .97){ ","                  colorbis = colorbis * (1. - (corrected1bis.x-0.97)/0.03)  +   texture2D(texture2bis,corrected2bis) * ((corrected1bis.x-0.97)/0.03);","              }","            if (((corrected4bis.x>=0. && corrected4bis.x<=1. && corrected4bis.y>=0. && corrected4bis.y<=1.) && v_texcoord4bis.w>0.)&& corrected1bis.x< 0.03){ ","                colorbis = colorbis * (corrected1bis.x/0.03)  +   texture2D(texture4bis,corrected4bis) * (1.- (corrected1bis.x)/0.03);","            }","        }","        color = (1. - colorbis.a) * saveColor + colorbis.a * colorbis;","        color.a = colorbis.a + saveColor.a;","        color = indice_time1 * (saveColor - color) + color;","   }else","     if ((corrected2bis.x>0. && corrected2bis.x<1. && corrected2bis.y>0. && corrected2bis.y<1.) && v_texcoord2bis.w>0.){","         colorbis = texture2D(texture2bis,corrected2bis);","      if(blending){","           if (((corrected3bis.x>=0. && corrected3bis.x<=1. && corrected3bis.y>=0. && corrected3bis.y<=1.) && v_texcoord3bis.w>0.)&& corrected2bis.x>0.97){ ","              colorbis = colorbis * (1. - (corrected2bis.x-0.97)/0.03)  +   texture2D(texture3bis,corrected3bis) * ((corrected2bis.x-0.97)/0.03);","           }","      }","     if(corrected2bis.y>0.97) colorbis = colorbis * (1. - (corrected2bis.y-0.97)/0.03) + saveColor * ((corrected2bis.y-0.97)/0.03);","        color = indice_time2 * (saveColor - colorbis) + colorbis;","   }else","    if ((corrected3bis.x>0.01 && corrected3bis.x<0.99 && corrected3bis.y>0. && corrected3bis.y<1.) && v_texcoord3bis.w>0.){","           colorbis = texture2D(texture3bis,corrected3bis);","           colorbis.a = 1.- texture2D(textureMask3,corrected3bis).a;","           if(blending){","            if (((corrected4bis.x>=0. && corrected4bis.x<=1. && corrected4bis.y>=0. && corrected4bis.y<=1.) && v_texcoord4bis.w>0.)&& corrected3bis.x>0.97){ ","                  colorbis = colorbis * (1. - (corrected3bis.x-0.97)/0.03)   +   texture2D(texture4bis,corrected4bis) * ((corrected3bis.x-0.97)/0.03);","               }","          }","            color = (1. - colorbis.a) * saveColor + colorbis.a * colorbis;","            color.a = colorbis.a + saveColor.a;","            color = indice_time3 * (saveColor - color) + color;","        }else","     if ((corrected4bis.x>0. && corrected4bis.x<1. && corrected4bis.y>0. && corrected4bis.y<1.) && v_texcoord4bis.w>0.){","         colorbis = texture2D(texture4bis,corrected4bis);	","         if(corrected4bis.y>0.97) colorbis = colorbis * (1. - (corrected4bis.y-0.97)/0.03) + saveColor * ((corrected4bis.y-0.97)/0.03);","           color = indice_time4 * (saveColor - colorbis) + colorbis;","     }","     color.a = alpha;","     gl_FragColor = color;"," }"],shaderLaserVS:["    #ifdef GL_ES ","    precision mediump float;","    #endif ","    attribute vec3 displacement; ","    attribute float uniqueid; ","    varying vec3 colorpoint;","    uniform float point_size;","    uniform float indice_time_laser;","    uniform float currentidwork;","    uniform float indice_time_laser_tab[160];","    uniform int movementLocked;","    float getSize(float id){","      return (0.5 -indice_time_laser_tab[int(id)]) * 15.;","    }","    void main()","    {","    vec3 newPosition = position;","    gl_PointSize = point_size;     //2.* clamp(6. - (position.y + 2.), 0., 6.); //getSize(uniqueid);//point_size;","    if(movementLocked!=1)","           newPosition = vec3(position.x+ displacement.x*indice_time_laser_tab[int(uniqueid)],","                              position.y+ displacement.y*indice_time_laser_tab[int(uniqueid)],","                              position.z+ displacement.z*indice_time_laser_tab[int(uniqueid)]);","           gl_Position  =  projectionMatrix *  modelViewMatrix * vec4(newPosition,1.);","          colorpoint = color;","      }"],shaderLaserFS:["      #ifdef GL_ES ","        precision mediump float;","      #endif","       varying vec3 colorpoint;","       uniform float alpha;","       uniform sampler2D texturePoint;","      void main() ","       {","         gl_FragColor = vec4(colorpoint,alpha);","      }	"],shaderBati3DVS:["#ifdef GL_ES","precision mediump float;"," #endif"," uniform int textureJPG;"," attribute float materialindice;"," varying float matindice;"," varying vec2 vUv;"," varying vec3 vNormal;"," varying vec3 pos;","   void main() {"," vNormal = normal;"," vUv = vec2( uv.x, uv.y );"," if(textureJPG ==1) vUv = vec2(vUv.x, 1.- vUv.y);  "," matindice = materialindice;","     pos = position;","   gl_Position  =  projectionMatrix *  modelViewMatrix * vec4( position, 1.0 );","}"],shaderBati3DFS:[" #ifdef GL_ES "," precision highp float;"," #endif"," uniform sampler2D u_textures[16];","  uniform int textureJPG;","  uniform float alpha;"," uniform vec3 light;","  varying float matindice;","  varying vec2 vUv;"," varying vec3 vNormal;","  varying vec3 pos;","  vec4 color = vec4(1.,0.,0.,1.);","  void main(void)"," {	","         vec2 uv = vUv;","         if (matindice<0.9)      color = texture2D(u_textures[0],uv);","         else if (matindice<1.9) color = texture2D(u_textures[1],uv);","         else if (matindice<2.9) color = texture2D(u_textures[2],uv);","         else if (matindice<3.9) color = texture2D(u_textures[3],uv);","         else if (matindice<4.9) color = texture2D(u_textures[4],uv);","         else if (matindice<5.9) color = texture2D(u_textures[5],uv);","         else if (matindice<6.9) color = texture2D(u_textures[6],uv);","         else if (matindice<7.9) color = texture2D(u_textures[7],uv);","         else if (matindice<8.9) color = texture2D(u_textures[8],uv);","         else if (matindice<9.9) color = texture2D(u_textures[9],uv);","         else if (matindice<10.9) color = texture2D(u_textures[10],uv);","         else if (matindice<11.9) color = texture2D(u_textures[11],uv);","         else if (matindice<12.9) color = texture2D(u_textures[12],uv);","         else if (matindice<13.9) color = texture2D(u_textures[13],uv);","         else if (matindice<14.9) color = texture2D(u_textures[14],uv);","         else if (matindice<15.9) color = texture2D(u_textures[15],uv);","         if(color.r == 0. && color.g ==0.) color =  vec4(vUv.x,vUv.x,vUv.x,0.5);","        else","               color.a = alpha;","    gl_FragColor = color; //vec4(1.,1.,0.,1.);//texture2D(u_textures[0],uv);"," }"]};return r}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1),r(4),r(6),r(5),r(19)],o=function(e,t,r,i,o){var n="",a="",s="",l="",c=null,h=!1,u=!1,p=null,d=!1,f={init:function(e){n=e.urlMetaDataProviderPos||r.dataURL.defaultUrlMetaDataProviderPos,a=e.urlMetaDataProviderName||r.dataURL.defaultUrlMetaDataProviderName,s=e.urlImageFile||r.dataURL.defaultUrlImageFile,l=e.urlMetaProviderSensor||r.dataURL.defaultUrlMetaProviderSensor,h=n.indexOf("php")<0,u=s.indexOf("www")<0,d=l.indexOf("php")<0},getMetaDataPHPFromPosRequest:function(e,t,r){return n+"easting="+e+"&northing="+t+"&distneighbours="+r},getMetaDataPHPFromPosJSON:function(e,t,r){var o=this.getMetaDataPHPFromPosRequest(e,t,r);i.getJSON(o,function(e){return c=e[0]})},getMetaDataFromPos:function(e,t,r){if(h){if(null===p){var i=n;return new Promise(function(o,n){var a=new XMLHttpRequest;a.open("GET",i),a.onload=function(){if(200===a.status){p=JSON.parse(a.response);var i=f.getClosestPanoInMemory(e,t,r);o(i)}else n(Error(a.statusText))},a.onerror=function(){n(Error("Network Error"))},a.send()})}var o=f.getClosestPanoInMemory(e,t,r);return new Promise(function(e,t){e(o)})}var i=this.getMetaDataPHPFromPosRequest(e,t,r);return new Promise(function(e,t){var r=new XMLHttpRequest;r.open("GET",i),r.onload=function(){200===r.status?e(JSON.parse(r.response)):t(Error(r.statusText))},r.onerror=function(){t(Error("Network Error"))},r.send()})},getClosestPanoInMemory:function(e,t,r){for(var i=0,o=99999,n=0;n<p.length;++n){var a=p[n],s=Math.sqrt((a.easting-e)*(a.easting-e)+(a.northing-t)*(a.northing-t));o>s&&(i=n,o=s)}return[p[i]]},getUrlImageFile:function(){return s},getImageLocal:function(){return u},getMetaDataSensorURL:function(e){var t="";return t=d?l:l+"?idChantier="+e},getLocalModeProviderSensor:function(){return d}};return f}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(5),r(3),r(1),r(44),r(9),r(10),r(2),r(40),r(12),r(41),r(7),r(4),r(6)],o=function(e,t,r,i,o,a,s,l,c,h,u,p,d){var f={MOVE:function(){b.update()}},m=".dds",v={quadMaterial:new r.QuadMaterialBuilder({onCreate:function(){},buildMaterialForQuad:function(e,t,i,o){var n=new r.Color,a=o/1e11*16777215,s=a%256,l=a/256%256,c=Math.sin(o);return n.r=s,n.g=l,n.b=c,new r.MeshBasicMaterial({wireframe:!0,color:n})}}),quadSphere:null},g=function(){this.dataURL="",this.name="",this.path="",this.pivot=new r.Vector3(0,0,0),this.LOBLevel={level:0,urlDS3:"",urlDDS:"",urlDDS16:""},this.textureType=".dds",this.dalleOpacity=1,this.cachedMaterials={loadMaterials:!0,materials:[],textures:[],imgUrlMaterial:[],urls:[]},this.geometry=new r.Geometry,this.materialsName=[],this.mesh=null,this.globalObject=new r.Object3D,this.shaderMat=null,this.texture1=null,this.racineFile=""};g.prototype.addSubMeshToDalle=function(e){this.dalleObject.add(e)},g.prototype.setDalleZeroPivot=function(e){this.pivot=e},g.prototype.setTextureType=function(e){this.textureType=e},g.prototype.addMaterialsName=function(e){this.materialsName.push(e)},g.prototype.getIndexMaterialName=function(e){return this.materialsName.indexOf(e)},g.prototype.setNamePath=function(e){this.path="EXPORT_"+e+"/export-3DS/",this.name=e},g.prototype.isMaterialsLoaded=function(){return this.cachedMaterials.loadMaterials},g.prototype.setMaterialsLoaded=function(e){this.cachedMaterials.loadMaterials=e},g.prototype.addDalleMaterials=function(e){this.cachedMaterials.materials.push(e)},g.prototype.addTextureURL=function(e){this.cachedMaterials.urls.push(e)},g.prototype.addTextureAlex=function(e){this.cachedMaterials.textures.push(e)},g.prototype.mergeObject=function(e){r.GeometryUtils.merge(this.geometry,e)},g.prototype.mergeGeometry=function(e){r.GeometryUtils.merge(this.geometry,e)},g.prototype.checkDoubleVertices=function(){this.geometry.mergeVertices()},g.prototype.setLoDLevel=function(e){this.LOBLevel.level=e},g.prototype.getLoDLevel=function(){return this.LOBLevel.level},g.prototype.subdivision=function(){this.checkDoubleVertices();var e=new r.SubdivisionModifier(this.LOBLevel);e.modify(this.geometry)},g.prototype.getDalleGemetry=function(){return this.geometry},g.prototype.showDalleInScene=function(){var e=(this.geometry.vertices,this.geometry.faces),i=this.geometry.faceVertexUvs,o=this.cachedMaterials.urls.length,a=16,s=new r.Geometry;for(n=0;n<=o;n+=a){s.vertices=this.geometry.vertices,s.faces=[],s.faceVertexUvs[0]=[];for(var l=0;l<e.length;l++){var c=e[l],h=i[0][l];c.materialIndex>=n&&c.materialIndex<n+a&&(s.faces.push(c),s.faceVertexUvs[0].push(h))}for(var u=r.BufferGeometryUtils.fromGeometry(s,{indice:n}),p=this.createShaderForBati(),d=0;a>d;++d)n+d<o&&this.affectTexture(p,n+d,d);var f=new r.Mesh(u,p);this.globalObject.add(f)}t.addToScene(this.globalObject)},g.prototype.load3DS=function(){new l(this)},g.prototype.affectTexture=function(e,t,i){var o,n=this.cachedMaterials.urls[t];r.ImageUtils.crossOrigin="use-credentials",".dds"==this.textureType?(o=r.ImageUtils.loadDDSTexture(n,null,function(){e.uniforms.u_textures.value[i]=o,o.dispose()}),o.generateMipmaps=!1):(o=r.ImageUtils.loadTexture(n,null,function(){"http://www.itowns.fr/images/textures/quoc.png";e.uniforms.u_textures.value[i]=o,o.dispose()}),o.generateMipmaps=!0),o.minFilter=o.magFilter=r.LinearFilter,o.anisotropy=4,o.needsUpdate=!0,o.name=t},pushTextureToGPU2=function(){console.log("pushTextureToGPU2",this)},g.prototype.pushTextureToGPU=function(e){console.log("pushTextureToGPU",e)},g.prototype.createShaderForBati=function(){var e={alpha:{type:"f",value:this.dalleOpacity},textureJPG:{type:"i",value:".jpg"==this.textureType},u_textures:{
type:"tv",value:[new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture,new r.Texture]},light:{type:"v3",value:b.light}},t={materialindice:{type:"f",value:[]}},i=new r.ShaderMaterial({uniforms:e,attributes:t,vertexShader:c.shaderBati3DVS.join("\n"),fragmentShader:c.shaderBati3DFS.join("\n"),side:r.DoubleSide,transparent:!0});return i},g.prototype.emptyGeometryCache=function(){this.geometry=new r.Geometry},g.prototype.emptyMaterialsCache=function(){this.cachedMaterials.materials=[],this.setMaterialsLoaded(!0)},g.prototype.generateAmbientColor=function(e){var t=(16711680&e)>>16,r=(65280&e)>>8,i=255&e;this.colorMaterial.ambient.setRGB(t,r,i)},g.prototype.generateDidduseColor=function(e){var t=(16711680&e)>>16,r=(65280&e)>>8,i=255&e;this.colorMaterial.diffuse.setRGB(t,r,i)},g.prototype.computeUrlLoBLevel=function(){if(".dds"==this.textureType)switch(this.getLoDLevel()){case 0:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter.3DS",this.LOBLevel.urlDDS=this.textureType;break;case 2:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-0.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;case 4:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-1.b3d",this.LOBLevel.urlDDS="-4"+this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;case 8:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-2.b3d",this.LOBLevel.urlDDS="-8"+this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;case 16:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-3.b3d",this.LOBLevel.urlDDS="-16"+this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;default:console.log("Cartography3D: does not support this level")}else switch(this.getLoDLevel()){case 0:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter.3DS",this.LOBLevel.urlDDS=this.textureType;break;case 2:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-0.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;case 4:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-1.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;case 8:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-2.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;case 16:this.LOBLevel.urlDS3=this.dataURL+this.path+"ZoneAExporter-3.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;default:console.log("Cartography3D: does not support this level")}},g.prototype.computeUrlLoBLevelSAVE=function(){if(".dds"==this.textureType)switch(this.getLoDLevel()){case 0:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter.3DS",this.LOBLevel.urlDDS=this.textureType;break;case 2:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-0.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;case 4:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-1.b3d",this.LOBLevel.urlDDS="-4"+this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;case 8:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-2.b3d",this.LOBLevel.urlDDS="-8"+this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;case 16:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-3.b3d",this.LOBLevel.urlDDS="-16"+this.textureType,this.LOBLevel.urlDDS16="-16"+this.textureType;break;default:console.log("Cartography3D: does not support this level")}else switch(this.getLoDLevel()){case 0:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter.3DS",this.LOBLevel.urlDDS=this.textureType;break;case 2:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-0.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;case 4:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-1.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;case 8:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-2.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;case 16:this.LOBLevel.urlDS3="../Bati3D_LOB/Version4LODS/"+this.path+"ZoneAExporter-3.b3d",this.LOBLevel.urlDDS=this.textureType,this.LOBLevel.urlDDS16=this.textureType;break;default:console.log("Cartography3D: does not support this level")}},g.prototype.getUrlDSFile=function(){return this.LOBLevel.urlDS3},g.prototype.getUrlDDSFile=function(){return this.LOBLevel.urlDDS},g.prototype.getUrlDDS16=function(){return this.LOBLevel.urlDDS16},g.prototype.load=function(){this.computeUrlLoBLevel();new h(this)},g.prototype.setVisible=function(e){this.globalObject.traverse(function(t){t.visible=e}),console.log("Bati3D visibility is ",e)},g.prototype.setOpacity=function(e){this.globalObject.traverse(function(t){t.material&&(t.material.uniforms.alpha.value=e)})},g.prototype.removeFromScene=function(){t.removeFromScene(this.globalObject),this.globalObject.traverse(function(e){t.removeFromScene(e)})},g.prototype.setLightPosition=function(e){this.globalObject.traverse(function(t){t.material&&(t.material.uniforms.light.value=e)})},g.prototype.parseB3DObject=function(e){var r=this,i=e._cur_obj,o=r.getUrlDDSFile();r.getUrlDDS16();if(this.geometry.vertices=i.verts,this.geometry.faces=i.indices,t.isMobileEnvironment()&&(this.racineFile="Version4LODS_o"),r.isMaterialsLoaded()){var n=null;for(var a in e._materials)if(n=e._materials[a],n.colorMap){var s=this.dataURL+this.racineFile+"/"+r.path+n.colorMap.url.split(".")[0]+o;r.addTextureURL(s),r.addMaterialsName(a)}r.setMaterialsLoaded(!1)}for(var l=0;l<i.uvsIndexes.length;l++)this.geometry.faceVertexUvs[0].push([i.uvs[i.uvsIndexes[l].x],i.uvs[i.uvsIndexes[l].y],i.uvs[i.uvsIndexes[l].z]]);var c=i.materialFaces;for(var a in c)for(var h=r.getIndexMaterialName(a),u=c[a],p=0;p<u.length;p++)this.geometry.faces[u[p]].materialIndex=h;this.geometry.computeFaceNormals(),this.geometry.computeVertexNormals()},g.prototype.parseDallePivot=function(e){var t=-this.pivot.x,i=-this.pivot.y,o=-this.pivot.z;this.geometry.applyMatrix((new r.Matrix4).makeTranslation(t,i,o))},g.prototype.parse3DSGeometry=function(e){var t=this,i=e._cur_obj;if(void 0!==i.uvs){var o=new r.Geometry;if(o.vertices=i.verts,o.faces=i.indices,t.isMaterialsLoaded()){var n=null;for(var a in e._materials)n=e._materials[a],n.colorMap&&(t.addDalleMaterials(new r.MeshBasicMaterial({color:16711680,wireframe:!0})),t.addMaterialsName(a));t.setMaterialsLoaded(!1)}for(var s=0;s<i.uvsIndexes.length;s++)o.faceVertexUvs[0].push([i.uvs[i.uvsIndexes[s].x],i.uvs[i.uvsIndexes[s].y],i.uvs[i.uvsIndexes[s].z]]);var l=i.materialFaces;for(var a in l)for(var c=t.getIndexMaterialName(a),h=0;h<o.faces.length;h++)o.faces[h].materialIndex=c;t.mergeGeometry(new r.Mesh(o))}},g.prototype.parseB3DGeometry=function(e){var t=this,i=e._cur_obj;if(void 0!==i.uvs){var o=new r.Geometry;if(o.vertices=i.verts,o.faces=i.indices,t.isMaterialsLoaded()){var n=null;for(var a in e._materials)n=e._materials[a],n.colorMap&&(t.addDalleMaterials(new r.MeshBasicMaterial({color:16711680,wireframe:!0})),t.addMaterialsName(a));t.setMaterialsLoaded(!1)}for(var s=0;s<i.uvsIndexes.length;s++)o.faceVertexUvs[0].push([i.uvs[i.uvsIndexes[s].x],i.uvs[i.uvsIndexes[s].y],i.uvs[i.uvsIndexes[s].z]]);var l=i.materialFaces;for(var a in l)for(var c=t.getIndexMaterialName(a),h=0;h<o.faces.length;h++)o.faces[h].materialIndex=c;t.mergeGeometry(new r.Mesh(o))}};var y={xmin:1286,xmax:1315,ymin:13715,ymax:13734},x={ORIGIN:2,SECOND:4,THIRD:8,FOURTH:16},w=function(e,t,i,o,n){r.Object3D.call(this),this.levels=void 0!==i?i:4,this.scale=void 0!==o?o:1,this.list=[],this.textureType=n;var a=2;".jpg"==this.textureType&&(a=2);for(var s=-a/2+1;a/2+1>s;++s)for(var l=-a/2;a/2>l;++l)".jpg"==this.textureType?this.createTile(e,t,s,l,x.SECOND):Math.abs(s)<1?this.createTile(e,t,s,l,x.ORIGIN):Math.abs(s)<3?this.createTile(e,t,s,l,x.ORIGIN):this.createTile(e,t,s,l,x.THIRD)};w.prototype={hide:function(){this.hidden=!0,this.meshes.forEach(function(e){e.visible=!1})},show:function(){this.hidden=!1,this.meshes.forEach(function(e){e.visible=!0})},createTile:function(e,t,r,i,o){var n=(e+r).toString()+"-"+(t+i).toString(),a=new g;a.dataURL=b.dataURL,a.setNamePath(n),a.setLoDLevel(o),a.setTextureType(this.textureType),this.list.push(a)},createTile2:function(e,t,r,i,o){var n=(e+r).toString()+"-"+(t+i).toString(),a=new g;a.setNamePath(n),a.setLoDLevel(o),a.setTextureType(this.textureType),this.list.push(a)},getListTiles:function(){return this.list}};var b={intialized:!1,opacity:1,carte3Dactivated:!1,grid:[],dalleSet:{},listDalles:[],scale:500,zero:null,paris:{xmin:500*y.xmin,xmax:500*y.xmax,ymin:500*y.ymin,ymax:500*y.ymax},videoGamesOn:!1,dataURL:d.dataURL.defaultUrl3DBuilding,nbSeeds:5,dateNow:null,timeLapse:null,counterAdded:!1,arrTargets:[],iteration:0,light:new r.Vector3(0,-.5,-1).normalize(),gridWeather:[],gridGeometry:null,textureType:"dds",gmap:null,createGMap:function(){var e=new r.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.5,side:r.DoubleSide});this.gmap=new r.Mesh(new r.PlaneGeometry(1e4,1e4),e),this.gmap.rotation.x=.5*-Math.PI,this.gmap.position.y=0,this.gmap.visible=!1,t.addToScene(this.gmap)},projectFrustumOnGMAP:function(){var e=new r.Matrix4,i=new r.Matrix4,o=new r.Frustum;e.copy(t.getCamera().matrixWorldInverse.getInverse(t.getCamera().matrixWorld)),i.multiplyMatrices(t.getCamera().projectionMatrix,e),o.setFromMatrix(i)},generateGrid:function(){var e=new r.Vector3(500*y.xmin,0,500*y.ymin);this.sceneleftBottomCornerGrid=(new r.Vector3).subVectors(e,this.zero),this.grid=new Array;for(var t=y.xmax-y.xmin+1,i=y.ymax-y.ymin+1,o=0;t>o;o++)this.grid[o]=new Array;for(var o=0;t>o;o++)for(var n=0;i>n;n++)this.grid[o][n]=null},getDalleXYFromCamDirection:function(){var e=new r.Vector3(-9999,0,0),i=new r.Vector3(0,0,1),o=new r.Projector,n=o.pickingRay(i,t.getCamera()),a=n.intersectObjects([this.gmap]);if(a[0])if(e=a[0].point,e.distanceTo(t.getCameraPosition())<500){var s=(new r.Vector3).subVectors(e,this.sceneleftBottomCornerGrid),l=Math.floor(s.x/500),c=Math.floor(s.z/500);e.x=l,e.z=c}else e=new r.Vector3(-9999,0,0);return e},checkWhatToLoad:function(){if(this.iteration++,this.iteration%30==0&&1==this.opacity){var e=this.getDalleXYFromCamDirection();if(-9999!=e.x&&null==this.grid[e.x][e.z]){var t=y.xmin+e.x,r=y.ymin+e.z;this.loadDallesAtPosition(t,r)}}requestAnimSelectionAlpha(this.checkWhatToLoad.bind(this))},checkIfTouchTarget:function(){if(this.videoGamesOn){for(var e=this.nbSeeds-this.arrTargets.length,r=0;r<this.arrTargets.length;++r){var i=t.getCameraPosition().distanceTo(this.arrTargets[r].position);50>i&&(console.log("touched!"),t.removeFromScene(this.arrTargets[r]),this.arrTargets.splice(r,1),this.playMP3(e))}this.setMessageDisplay(e,1),requestAnimSelectionAlpha(this.checkIfTouchTarget.bind(this))}},playMP3:function(e){var t="172205__fins__jumping.wav";e>=this.nbSeeds-1&&(t="clap.mp3",p.snd=new Audio("sounds/"+t)),p.snd||(p.snd=new Audio("sounds/"+t)),p.snd.play()},removeDalleFromGrid:function(e,t){var r=this.getDalleXYFromCamDirection();-9999!=r.x&&(console.log("remove dalle",r.x,r.z),console.log(this.grid[r.x][r.z]),this.grid[r.x][r.z].removeFromScene())},initCarto3D:function(e){this.dataURL=e.url3DBuilding||d.dataURL.defaultUrl3DBuilding,this.zero=t.getZeroAsVec3D(),this.textureType=t.isMobileEnvironment()?".jpg":".dds",console.log("this.textureType",this.textureType),m=this.textureType;var r=t.getCameraPosition();this.createGMap(),this.generateGrid(),t.translateCameraSmoothly(-10001,100,0),this.isDataAvailable(r.add(this.zero))&&(this.loadDallesAroundPosition(r,this.zero),this.setInitStatus(!0))},setActivatedCarte3D:function(e){this.carte3Dactivated=e},isActivatedCarte3D:function(){return this.carte3Dactivated},setInitStatus:function(e){this.intialized=e},isCartoInitialized:function(){return this.intialized},createCarteLoD:function(e,t){},removeAllDalles:function(){for(var e in this.dalleSet)this.dalleSet[e].removeFromScene()},setVisibility:function(e){for(var t in this.listDalles)this.listDalles[t].setVisible(e)},removeDalleAt:function(e,t){},setOpacity:function(e){this.opacity=e;for(var t in this.listDalles)this.listDalles[t].setOpacity(e)},setLightPosition:function(e){this.opacity=e;for(var t in this.listDalles)this.listDalles[t].setLightPosition(e)},tweenGeneralOpacity:function(){if(this.intialized){var e=this.opacity;e>0&&(e-=.04*(1-(e-.01)),0>e&&(e=0,this.setVisibility(!1)),this.setOpacity(e),requestAnimSelectionAlpha(this.tweenGeneralOpacity.bind(this)))}},tweenGeneralOpacityUP:function(){if(this.intialized){var e=this.opacity;1>e&&(e+=.04*(e+.01),e>1&&(e=1),this.setOpacity(e),requestAnimSelectionAlpha(this.tweenGeneralOpacity.bind(this)))}},getOpacity:function(){return this.opacity},loadDallesAtPosition:function(e,r){console.log("loadDallesAtPosition",e,r);for(var i=null,o=this.createDalleListAroundPosition(e,r),n=0;n<o.length;n++){var a=o[n];void 0===this.dalleSet[a]&&(i=new g,i.dataURL=this.dataURL,i.textureType=this.textureType,i.setDalleZeroPivot(t.getZeroAsVec3D()),i.setNamePath(a),i.setLoDLevel(2),i.load(),this.grid[e-y.xmin][r-y.ymin]=i,this.dalleSet[a]=i,this.listDalles.push(i))}},loadDallesAroundPosition:function(e,r){console.log("loadDallesAroundPosition",e);var i=Math.floor(e.x/this.scale),o=Math.floor(e.z/this.scale),n=".dds";t.isMobileEnvironment()&&(n=".jpg");var a=new w(i,o,1,1,m);this.listDalles=a.getListTiles();for(var s=0;s<this.listDalles.length;s++)if(void 0===this.dalleSet[this.listDalles[s].name]){var l=this.listDalles[s],c=this.listDalles[s].name.split("-"),h=c[0]-y.xmin,u=c[1]-y.ymin;this.grid[h][u]=l,this.listDalles[s].setDalleZeroPivot(r),this.using3DS||this.listDalles[s].load(),this.listDalles[s].setLoDLevel(0),this.listDalles[s].load3DS()}this.checkWhatToLoad()},usingLayer:function(e){"3DBuilding"===e?this.using3DS=!0:this.using3DS=!1},setVideoGamesOn:function(e){this.videoGamesOn=e},getVideoGamesOn:function(e){return this.videoGamesOn},generateSeeds:function(){console.log("generateSeeds"),this.arrTargets=[],this.dateNow=new Date;for(var e=0;e<this.nbSeeds;++e){var t=new r.Vector3(500*Math.random()-250,20+100*Math.random(),500*Math.random()-250);this.drawTarget(t,25)}this.videoGamesOn=!0,this.checkIfTouchTarget();var i=new Audio("sounds/93076__cgeffex__helicopter.mp3");i.loop=!0,i.play(),this.getTemperatureForGrid()},setMessageDisplay:function(t,r){var i=new Date-this.dateNow;if(t<this.nbSeeds-1&&(this.timeLapse=i),this.counterAdded)e("#loading").html('<font style="font-family: Impact; font-size:8vw; position:absolute; bottom:5%; left: 35%; margin-top: -10vw; margin-left: 0vw; color:white"> '+t+" "+this.timeLapse+" </font>");else{this.counterAdded=!0;var o=document.createElement("div");o.innerHTML='<font style="font-family: Impact; font-size:8vw; position:absolute; bottom:5%; left: 35%; margin-top: -10vw; margin-left: 0vw; color:white"> '+t+" "+this.timeLapse+" </font>",o.id="loading";var n=document.getElementById("dynamicInput");n.appendChild(o)}for(var a=0;a<this.arrTargets.length;++a)this.arrTargets[a].rotation.y+=.01},drawTarget:function(e,i){var o=new r.Mesh(new r.TorusGeometry(20,3,16,100),new r.MeshBasicMaterial({depthTest:!1,transparent:!0,opacity:.8,color:16777215*Math.random()}));o.position=e,t.addToScene(o),this.arrTargets.push(o)},createQuadTreePlanet:function(){var e=t.getCamera(),i=6376136;v.quadSphere=new r.QuadTreeSphere({workerPath:new r.QuadTreeSphereBlobWorker,camera:e,radius:i,patchSize:16,scene:t.getScene(),fov:e.fov,quadMaterial:v.quadMaterial}),e.position.z=4*i,e.lookAt(new r.Vector3(0,0,0)),this.renderQuadTreePlanet()},renderQuadTreePlanet:function(){v.quadSphere.update(),requestAnimationFrame(b.renderQuadTreePlanet)},createDalleListAroundPosition:function(e,t){for(var r=[],i=[0,1],o=[0,1],n=0;n<i.length;n++)for(var a=0;a<o.length;a++)if(null==this.grid[e+i[n]-y.xmin][t+o[a]-y.ymin]){this.grid[e+i[n]-y.xmin][t+o[a]-y.ymin]=={};var s=(e+i[n]).toString()+"-"+(t+o[a]).toString();r.push(s)}return r},isPointInsideDalle:function(e,t){var i=new r.Vector2(e.Xmin,e.Ymin),o=new r.Vector2(e.Xmin,e.Ymax),n=new r.Vector2(e.Xmax,e.Ymax),a=new r.Vector2(e.Xmax,e.Ymin),s=t.isPointInTriange(i,o,n),l=t.isPointInTriange(i,n,a);return s.x||l.x},isDataAvailable:function(e){return e.x>this.paris.xmin&&e.x<this.paris.xmax&&e.z>this.paris.ymin&&e.z<this.paris.ymax},update:function(){if(this.isActivatedCarte3D()){var e=t.getZeroAsVec3D(),r=s.getCurrentPosition();this.isDataAvailable(r)&&this.loadDallesAroundPosition(r,e)}},processEvent:function(e){f[e]&&f[e]()}};return b}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(3),r(1),r(8),r(12),r(13)],o=function(e,t,r,i,o){window.requestAnimSelectionAlpha=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var n,a,s,l,c,h,u,p,d,f,m=!1,v=1,g=null,y=[],x=[],w=[],b=[],_=[],M=new RegExp("-[0-9][0-9]-"),S=0,T=new t.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),C={imgName:"",nbL2Loaded:0,init:function(t){this.localImageFiles=o.getImageLocal(),S=e.isMobileEnvironment()?1:0,this.initOrientationCameraMatrices(),this.setRotationHeading(t),this.initImages(),this.initMatrices(),this.initTranslations(),m=!0},initOrientationCameraMatrices:function(){n=r.getMatCam(0),a=r.getMatCam(1),s=r.getMatCam(2),l=r.getMatCam(3),c=r.getMatCam(4)},initMatrices:function(){h=(new t.Matrix4).multiplyMatrices(n,r.getProjCam(0)),u=(new t.Matrix4).multiplyMatrices(a,r.getProjCam(1)),p=(new t.Matrix4).multiplyMatrices(s,r.getProjCam(2)),d=(new t.Matrix4).multiplyMatrices(l,r.getProjCam(3)),f=(new t.Matrix4).multiplyMatrices(c,r.getProjCam(4)),_.push(h),_.push(u),_.push(p),_.push(d),_.push(f),console.log(h),console.log(u),console.log(p),console.log(d),console.log(f),b.push((new t.Matrix4).multiplyMatrices(T.clone(),h.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),u.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),p.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),d.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),f.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),h.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),u.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),p.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),d.clone()).transpose()),b.push((new t.Matrix4).multiplyMatrices(T.clone(),f.clone()).transpose()),console.log(T),console.log(b[0]),console.log(b[1]),console.log(b[2]),console.log(b[3]),console.log(b[4])},initTranslations:function(){var e=r.getSommet(0).clone().applyProjection(T.clone());e.w=1;var t=r.getSommet(1).clone().applyProjection(T.clone());t.w=1;var i=r.getSommet(2).clone().applyProjection(T.clone());i.w=1;var o=r.getSommet(3).clone().applyProjection(T.clone());o.w=1;var n=r.getSommet(4).clone().applyProjection(T.clone());n.w=1,x.push(e),x.push(t),x.push(i),x.push(o),x.push(n),x.push(e),x.push(t),x.push(i),x.push(o),x.push(n)},initImages:function(){for(var e=0;10>e;++e){var t=new Image;t.crossOrigin="anonymous",y.push(t),w.push(T)}},createShaderForImage:function(n,a){var s=0,l=new RegExp("-[0-9][0-9]-"),c=new RegExp("-[0-9][0-9][0-9][0-9][0-9][0-9]_"),h=n.match(c);h=String(h).substr(1,6)+"/";var u=1920,p=1080,d=1/u,f=1/p,m=r.getDistortion(0),y=r.getDistortion(1),w=r.getDistortion(2),_=r.getDistortion(3),M=r.getDistortion(4),C=r.getMask(0),L=r.getMask(1),A=r.getMask(2),P=r.getMask(3),D=r.getMask(4),F=1==S?512:1024,E=o.getUrlImageFile(),V=this.localImageFiles?".jpg":".jp2&WID="+F/4+"&QLT="+a+"&CVT=JPEG";console.log("localImageFiles: ",this.localImageFiles);var R={intrinsic300:{type:"v4",value:m},intrinsic301:{type:"v4",value:y},intrinsic302:{type:"v4",value:w},intrinsic303:{type:"v4",value:_},intrinsic304:{type:"v4",value:M},kernel:{type:"iv1",value:[-1,-1,-1,-1,17,-1,-1,-1,-1]},offset:{type:"v2v",value:[new t.Vector2(d,f),new t.Vector2(0,f),new t.Vector2(-d,f),new t.Vector2(d,0),new t.Vector2(0,0),new t.Vector2(-d,0),new t.Vector2(d,-f),new t.Vector2(0,-f),new t.Vector2(-d,-f)]},blendingOn:{type:"i",value:1},mobileOn:{type:"i",value:S},alpha:{type:"f",value:v},fog:{type:"i",value:0},indice_time0:{type:"f",value:s},indice_time1:{type:"f",value:s},indice_time2:{type:"f",value:s},indice_time3:{type:"f",value:s},indice_time4:{type:"f",value:s},mvpp_current_0:{type:"m4",value:b[0]},mvpp_current_1:{type:"m4",value:b[1]},mvpp_current_2:{type:"m4",value:b[2]},mvpp_current_3:{type:"m4",value:b[3]},mvpp_current_4:{type:"m4",value:b[4]},mvpp_current_0bis:{type:"m4",value:b[5]},mvpp_current_1bis:{type:"m4",value:b[6]},mvpp_current_2bis:{type:"m4",value:b[7]},mvpp_current_3bis:{type:"m4",value:b[8]},mvpp_current_4bis:{type:"m4",value:b[9]},factorTranslation0:{type:"v4",value:x[0]},factorTranslation1:{type:"v4",value:x[1]},factorTranslation2:{type:"v4",value:x[2]},factorTranslation3:{type:"v4",value:x[3]},factorTranslation4:{type:"v4",value:x[4]},factorTranslation0bis:{type:"v4",value:x[0]},factorTranslation1bis:{type:"v4",value:x[1]},factorTranslation2bis:{type:"v4",value:x[2]},factorTranslation3bis:{type:"v4",value:x[3]},factorTranslation4bis:{type:"v4",value:x[4]},texture0:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-300-")+V)},texture1:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-301-")+V)},texture2:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-302-")+V)},texture3:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-303-")+V)},texture4:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-304-")+V)},texture0bis:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-300-")+V)},texture1bis:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-301-")+V)},texture2bis:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-302-")+V)},texture3bis:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-303-")+V)},texture4bis:{type:"t",value:t.ImageUtils.loadTexture(E+h+n.replace(l,"-304-")+V)},textureMask0:{type:"t",value:C},textureMask1:{type:"t",value:L},textureMask2:{type:"t",value:A},textureMask3:{type:"t",value:P},textureMask4:{type:"t",value:D}},z=e.getRenderer().getContext(),I=z.getParameter(z.MAX_VARYING_VECTORS);console.log("Max Varying Vector on this machine:",I);var U=i.shaderTextureProjective2FS;10>=I&&(U=i.shaderTextureProjective2LightFS),g=new t.ShaderMaterial({uniforms:R,vertexShader:i.shaderTextureProjective2VS.join("\n"),fragmentShader:U.join("\n"),side:t.BackSide,transparent:!0}),this.tweenAllIndiceTimes();var O=r.getPosition();return O.applyProjection(T),this.changePanoTextureAfterloading(h+n,128,50,new t.Vector4(0,0,0,1),T,1),e.translateCameraSmoothly(O.x,O.y,O.z),g},changePanoTextureAfterloading:function(e,t,r,i,o,n){this.imgName=e,this.nbL2Loaded=0,this.chargeOneImageCam(e,"texture1",1,t,r,i,o,6,n),this.chargeOneImageCam(e,"texture2",2,t,r,i,o,7,n),this.chargeOneImageCam(e,"texture3",3,t,r,i,o,8,n),this.chargeOneImageCam(e,"texture4",4,t,r,i,o,9,n),this.chargeOneImageCam(e,"texture0",0,t,r,i,o,5,n)},changePanoTextureAfterloadingTurboTruckMode:function(e,t,r,i,o,n){this.imgName=e,this.nbL2Loaded=0,this.chargeOneImageCam(e,"texture1",1,512,85,i,o,6,0)},chargeOneImageCam:function(i,n,a,s,l,c,h,u,p){0==S&&(g.uniforms[n].value=g.uniforms[n+"bis"].value,g.uniforms["factorTranslation"+a].value=x[u],g.uniforms["mvpp_current_"+a].value=b[u]);var d=c.clone().add(r.getSommet(a).clone().applyProjection(h.clone()));d.w=1,x[u]=d,b[u]=(new t.Matrix4).multiplyMatrices(h.clone(),_[u-5].clone()).transpose();var f=new Image;f.crossOrigin="anonymous";var m=this;f.onload=function(){g.uniforms["indice_time"+a].value=.8,g.uniforms["mvpp_current_"+a+"bis"].value=b[u],g.uniforms["factorTranslation"+a+"bis"].value=d,g.uniforms[n+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),g.uniforms[n+"bis"].value.needsUpdate=!0,1!=p||m.localImageFiles||m.changeQuality(i,n,a,512,l,u),m.localImageFiles&&e.setSpeedTurnCam(.1)};var v=this.localImageFiles?".jpg":".jp2&WID="+s/4+"&QLT="+l+"&CVT=JPEG";f.src=o.getUrlImageFile()+i.replace(M,"-30"+a+"-")+v,console.log(f.src),console.log(d),console.log(b[u])},changeQuality:function(r,i,o,n,a){var s=this,l=new Image;l.crossOrigin="anonymous",l.src="http://www.itowns.fr/cgi-bin/iipsrv.fcgi?FIF=/iipimagesV2/"+r.replace(M,"-30"+o+"-")+".jp2&WID="+n+"&QLT="+a+"&CVT=JPEG",l.onload=function(){g.uniforms[i+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),g.uniforms[i+"bis"].value.needsUpdate=!0,50==a&&s.nbL2Loaded++,.1!=e.getSpeedTurnCam()&&3==o&&e.setSpeedTurnCam(.1)}},changeQualitySerial:function(e,r,i,o){var n=e.shift(),a="texture"+n,s=this,l=new Image;l.crossOrigin="anonymous",l.src="http://www.itowns.fr/cgi-bin/iipsrv.fcgi?FIF=/iipimagesV2/"+r.replace(M,"-30"+n+"-")+".jp2&WID="+i+"&QLT="+o+"&CVT=JPEG",l.onload=function(){s.imgName==r&&(y[parseInt(n)+5]=this,g.uniforms[a+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),g.uniforms[a+"bis"].value.needsUpdate=!0,50==o&&s.nbL2Loaded++,e.length>0&&s.changeQualitySerial(e,r,i,o))}},loadQualityLevel:function(e,t,r){setTimeout(function(){C.loadQualityLevelNowSerial(e,t,r)},2e3)},loadQualityLevelNowSerial:function(e,t,r){if(this.imgName==r){var i=["0","1","2","3","4"];this.changeQualitySerial(i,this.imgName,e,t)}},groundToImage:function(e){var r,i=e.clone().sub(g.uniforms.factorTranslation0bis.value),o=e.clone().sub(g.uniforms.factorTranslation1bis.value),n=e.clone().sub(g.uniforms.factorTranslation2bis.value),a=e.clone().sub(g.uniforms.factorTranslation3bis.value),s=e.clone().sub(g.uniforms.factorTranslation4bis.value),l=g.uniforms.mvpp_current_0bis.value.multiplyVector4(new t.Vector4(i.x,i.y,i.z,1)),c=g.uniforms.mvpp_current_1bis.value.multiplyVector4(new t.Vector4(o.x,o.y,o.z,1)),h=g.uniforms.mvpp_current_2bis.value.multiplyVector4(new t.Vector4(n.x,n.y,n.z,1)),u=g.uniforms.mvpp_current_3bis.value.multiplyVector4(new t.Vector4(a.x,a.y,a.z,1)),p=g.uniforms.mvpp_current_4bis.value.multiplyVector4(new t.Vector4(s.x,s.y,s.z,1)),d=this.correctDistortionAndCoord(g.uniforms.intrinsic300.value,l.clone()),f=this.correctDistortionAndCoord(g.uniforms.intrinsic301.value,c.clone()),m=this.correctDistortionAndCoord(g.uniforms.intrinsic302.value,h.clone()),v=this.correctDistortionAndCoord(g.uniforms.intrinsic303.value,u.clone()),y=this.correctDistortionAndCoord(g.uniforms.intrinsic304.value,p.clone());d.x>0&&d.y>0&&d.z>0?(r=d,r.z=0):f.x>0&&f.y>0&&f.z>0?(r=f,r.z=1):m.x>0&&m.y>0&&m.z>0?(r=m,r.z=2):v.x>0&&v.y>0&&v.z>0?(r=v,r.z=3):y.x>0&&y.y>0&&y.z>0&&(r=y,r.z=4);var x=new RegExp("-[0-9][0-9]-");console.log(this.imgName);var w=this.imgName.replace(x,"-30"+r.z+"-").replace(/^.*[\\\/]/,""),b={i:2048*r.x,j:2048*r.y,imgName:w};return b},correctDistortionAndCoord:function(e,r){var i=1042.178,o=1020.435,n=2048,a=2048,s=new t.Vector3(r.x/r.w-i,r.y/r.w-o,0),l=s.dot(s);if(l>e.w)return new t.Vector3(-2,-2,-2);var c=l*(e.x+l*(e.y+l*e.z)),h=new t.Vector3(r.x/r.w+c*s.x,r.y/r.w+c*s.y,0);return new t.Vector3(h.x/n,1-h.y/a,r.w)},changeDistortion:function(){0!=g.uniforms.r3.value?(g.uniforms.r3.value=0,g.uniforms.r5.value=0,g.uniforms.r7.value=0,g.uniforms.r30.value=0,g.uniforms.r50.value=0,g.uniforms.r70.value=0):(g.uniforms.r3.value=-1.414241e-7,g.uniforms.r5.value=3.56829e-14,g.uniforms.r7.value=-4.239262e-21,g.uniforms.r30.value=-1.335994e-7,g.uniforms.r50.value=3.335513e-14,g.uniforms.r70.value=-3.928705e-21),g.uniforms.r3.value.needsUpdate=!0,g.uniforms.r5.value.needsUpdate=!0,g.uniforms.r7.value.needsUpdate=!0,g.uniforms.r30.value.needsUpdate=!0,g.uniforms.r50.value.needsUpdate=!0,g.uniforms.r70.value.needsUpdate=!0},changeBlending:function(){1==g.uniforms.blendingOn.value?g.uniforms.blendingOn.value=0:g.uniforms.blendingOn.value=1,g.uniforms.blendingOn.value.needsUpdate=!0},getShaderMat:function(){return g},isInitiated:function(){return m},tweenGeneralOpacity:function(){console.log(" tweenGeneralOpacity");var e=g.uniforms.alpha.value;e>0&&(e-=.02*(1-(e-.01)),0>e&&(e=0),g.uniforms.alpha.value=e),requestAnimSelectionAlpha(this.tweenGeneralOpacity.bind(this))},tweenGeneralOpacityUp:function(){var e=g.uniforms.alpha.value;1>e&&(e+=.04*(e+.01),e>1&&(e=1),g.uniforms.alpha.value=e,requestAnimSelectionAlpha(this.tweenGeneralOpacityUp.bind(this)))},setGeneralOpacity:function(e){v=e,g.uniforms.alpha.value=v},setFogValue:function(e){g.uniforms.fog.value=e},tweenAllIndiceTimes:function(){this.tweenIndiceTime(0),this.tweenIndiceTime(1),this.tweenIndiceTime(2),this.tweenIndiceTime(3),this.tweenIndiceTime(4),5==this.nbL2Loaded&&0==S&&(this.nbL2Loaded=0,this.loadQualityLevel(2048,80,this.imgName)),requestAnimSelectionAlpha(this.tweenAllIndiceTimes.bind(this))},tweenIndiceTime:function(e){var t=g.uniforms["indice_time"+e].value;t>0&&(t-=.08*(1-(t-.01)),0>t&&(t=0),g.uniforms["indice_time"+e].value=t)},setIndiceTimeCam:function(e,t){g.uniforms["indice_time"+e].value=t},setRotationHeading:function(e){T=e},getTabMatrices:function(){return b}};return C}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i;i=function(){function e(e,t,r){var i=(e.x-r.x)*(t.y-r.y),o=(e.y-r.y)*(t.x-r.x),n=i-o;return n>-c&&c>n?u.COLLINEAR:n>0?u.CCW:u.CW}function t(e,t,r,i){var o=i.x,n=i.y,a=e.x-o,s=e.y-n,l=t.x-o,h=t.y-n,u=a*h,p=l*s,d=u-p;if(c>=d)return!1;var f=r.x-o,m=r.y-n,v=f*s,g=a*m,y=v-g;return c>=y?!1:!0}var r=r||{REVISION:"1.0.0"};r.epsilon=2.220446049250313e-16,r.Point2D=function(e,t){this.x=e,this.y=t};var i=function(e,t){this.name="PointError",this.points=t=t||[],this.message=e||"Invalid Points!";for(var r=0;r<t.length;r++)this.message+=" "+o.toString(t[r])};i.prototype=new Error,i.prototype.constructor=i;var o=function(e,t){this.x=+e||0,this.y=+t||0,this._p2t_edge_list=null};o.prototype.toString=function(){return"("+this.x+";"+this.y+")"},o.prototype.clone=function(){return new o(this.x,this.y)},o.prototype.set_zero=function(){return this.x=0,this.y=0,this},o.prototype.set=function(e,t){return this.x=+e||0,this.y=+t||0,this},o.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},o.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},o.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},o.prototype.mul=function(e){return this.x*=e,this.y*=e,this},o.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},o.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,e},o.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},o.negate=function(e){return new o(-e.x,-e.y)},o.add=function(e,t){return new o(e.x+t.x,e.y+t.y)},o.sub=function(e,t){return new o(e.x-t.x,e.y-t.y)},o.mul=function(e,t){return new o(e*t.x,e*t.y)},o.cross=function(e,t){return"number"==typeof e?"number"==typeof t?e*t:new o(-e*t.y,e*t.x):"number"==typeof t?new o(t*e.y,-t*e.x):e.x*t.y-e.y*t.x},o.toString=function(e){var t=e.toString();return"[object Object]"===t?o.prototype.toString.call(e):t},o.compare=function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y},o.cmp=o.compare,o.equals=function(e,t){return e.x===t.x&&e.y===t.y},o.dot=function(e,t){return e.x*t.x+e.y*t.y},o.prototype.distanceTo=function(e){var t=this.x-e.x,r=this.y-e.y;return Math.sqrt(t*t+r*r)};var n=function(e,t){if(this.p=e,this.q=t,e.y>t.y)this.q=e,this.p=t;else if(e.y===t.y)if(e.x>t.x)this.q=e,this.p=t;else if(e.x===t.x)throw new i("Invalid Edge constructor: repeated points!",[e]);this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),
this.q._p2t_edge_list.push(this)},a=function(e,t,r){this.points_=[e,t,r],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]};a.prototype.toString=function(){var e=o.toString;return"["+e(this.points_[0])+e(this.points_[1])+e(this.points_[2])+"]"},a.prototype.getPoint=function(e){return this.points_[e]},a.prototype.GetPoint=a.prototype.getPoint,a.prototype.getNeighbor=function(e){return this.neighbors_[e]},a.prototype.containsPoint=function(e){var t=this.points_;return e===t[0]||e===t[1]||e===t[2]},a.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},a.prototype.containsPoints=function(e,t){return this.containsPoint(e)&&this.containsPoint(t)},a.prototype.isInterior=function(){return this.interior_},a.prototype.setInterior=function(e){return this.interior_=e,this},a.prototype.markNeighborPointers=function(e,t,r){var i=this.points_;if(e===i[2]&&t===i[1]||e===i[1]&&t===i[2])this.neighbors_[0]=r;else if(e===i[0]&&t===i[2]||e===i[2]&&t===i[0])this.neighbors_[1]=r;else{if(!(e===i[0]&&t===i[1]||e===i[1]&&t===i[0]))throw new Error("Invalid Triangle.markNeighborPointers() call");this.neighbors_[2]=r}},a.prototype.markNeighbor=function(e){var t=this.points_;e.containsPoints(t[1],t[2])?(this.neighbors_[0]=e,e.markNeighborPointers(t[1],t[2],this)):e.containsPoints(t[0],t[2])?(this.neighbors_[1]=e,e.markNeighborPointers(t[0],t[2],this)):e.containsPoints(t[0],t[1])&&(this.neighbors_[2]=e,e.markNeighborPointers(t[0],t[1],this))},a.prototype.clearNeigbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},a.prototype.clearDelunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},a.prototype.pointCW=function(e){var t=this.points_;return e===t[0]?t[2]:e===t[1]?t[0]:e===t[2]?t[1]:null},a.prototype.pointCCW=function(e){var t=this.points_;return e===t[0]?t[1]:e===t[1]?t[2]:e===t[2]?t[0]:null},a.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},a.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},a.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},a.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},a.prototype.setConstrainedEdgeCW=function(e,t){e===this.points_[0]?this.constrained_edge[1]=t:e===this.points_[1]?this.constrained_edge[2]=t:this.constrained_edge[0]=t},a.prototype.setConstrainedEdgeCCW=function(e,t){e===this.points_[0]?this.constrained_edge[2]=t:e===this.points_[1]?this.constrained_edge[0]=t:this.constrained_edge[1]=t},a.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},a.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},a.prototype.setDelaunayEdgeCW=function(e,t){e===this.points_[0]?this.delaunay_edge[1]=t:e===this.points_[1]?this.delaunay_edge[2]=t:this.delaunay_edge[0]=t},a.prototype.setDelaunayEdgeCCW=function(e,t){e===this.points_[0]?this.delaunay_edge[2]=t:e===this.points_[1]?this.delaunay_edge[0]=t:this.delaunay_edge[1]=t},a.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},a.prototype.oppositePoint=function(e,t){var r=e.pointCW(t);return this.pointCW(r)},a.prototype.legalize=function(e,t){var r=this.points_;if(e===r[0])r[1]=r[0],r[0]=r[2],r[2]=t;else if(e===r[1])r[2]=r[1],r[1]=r[0],r[0]=t;else{if(e!==r[2])throw new Error("Invalid Triangle.legalize() call");r[0]=r[2],r[2]=r[1],r[1]=t}},a.prototype.index=function(e){var t=this.points_;if(e===t[0])return 0;if(e===t[1])return 1;if(e===t[2])return 2;throw new Error("Invalid Triangle.index() call")},a.prototype.edgeIndex=function(e,t){var r=this.points_;if(e===r[0]){if(t===r[1])return 2;if(t===r[2])return 1}else if(e===r[1]){if(t===r[2])return 0;if(t===r[0])return 2}else if(e===r[2]){if(t===r[0])return 1;if(t===r[1])return 0}return-1},a.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},a.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},a.prototype.markConstrainedEdgeByPoints=function(e,t){var r=this.points_;t===r[0]&&e===r[1]||t===r[1]&&e===r[0]?this.constrained_edge[2]=!0:t===r[0]&&e===r[2]||t===r[2]&&e===r[0]?this.constrained_edge[1]=!0:(t===r[1]&&e===r[2]||t===r[2]&&e===r[1])&&(this.constrained_edge[0]=!0)};var s=3*Math.PI/4,l=Math.PI/2,c=1e-12,h=.3,u={CW:1,CCW:-1,COLLINEAR:0},p=function(e,t){this.point=e,this.triangle=t||null,this.next=null,this.prev=null,this.value=e.x},d=function(e,t){this.head_=e,this.tail_=t,this.search_node_=e};d.prototype.head=function(){return this.head_},d.prototype.setHead=function(e){this.head_=e},d.prototype.tail=function(){return this.tail_},d.prototype.setTail=function(e){this.tail_=e},d.prototype.search=function(){return this.search_node_},d.prototype.setSearch=function(e){this.search_node_=e},d.prototype.findSearchNode=function(){return this.search_node_},d.prototype.locateNode=function(e){var t=this.search_node_;if(e<t.value){for(;t=t.prev;)if(e>=t.value)return this.search_node_=t,t}else for(;t=t.next;)if(e<t.value)return this.search_node_=t.prev,t.prev;return null},d.prototype.locatePoint=function(e){var t=e.x,r=this.findSearchNode(t),i=r.point.x;if(t===i){if(e!==r.point)if(e===r.prev.point)r=r.prev;else{if(e!==r.next.point)throw new Error("Invalid AdvancingFront.locatePoint() call");r=r.next}}else if(i>t)for(;(r=r.prev)&&e!==r.point;);else for(;(r=r.next)&&e!==r.point;);return r&&(this.search_node_=r),r};var f=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};f.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var m=function(){this.constrained_edge=null,this.right=!1},v=function(e,t){t=t||{},this.triangles_=[],this.map_=[],this.points_=t.cloneArrays?e.slice(0):e,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new f,this.edge_event=new m,this.initEdges(this.points_)};v.prototype.addHole=function(e){this.initEdges(e);var t,r=e.length;for(t=0;r>t;t++)this.points_.push(e[t]);return this},v.prototype.AddHole=v.prototype.addHole,v.prototype.addPoint=function(e){return this.points_.push(e),this},v.prototype.AddPoint=v.prototype.addPoint,v.prototype.addPoints=function(e){return this.points_=this.points_.concat(e),this},v.prototype.triangulate=function(){return g.triangulate(this),this},v.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},v.prototype.getTriangles=function(){return this.triangles_},v.prototype.GetTriangles=v.prototype.getTriangles,v.prototype.front=function(){return this.front_},v.prototype.pointCount=function(){return this.points_.length},v.prototype.head=function(){return this.head_},v.prototype.setHead=function(e){this.head_=e},v.prototype.tail=function(){return this.tail_},v.prototype.setTail=function(e){this.tail_=e},v.prototype.getMap=function(){return this.map_},v.prototype.initTriangulation=function(){var e,t=this.points_[0].x,r=this.points_[0].x,i=this.points_[0].y,n=this.points_[0].y,a=this.points_.length;for(e=1;a>e;e++){var s=this.points_[e];s.x>t&&(t=s.x),s.x<r&&(r=s.x),s.y>i&&(i=s.y),s.y<n&&(n=s.y)}this.pmin_=new o(r,n),this.pmax_=new o(t,i);var l=h*(t-r),c=h*(i-n);this.head_=new o(t+l,n-c),this.tail_=new o(r-l,n-c),this.points_.sort(o.compare)},v.prototype.initEdges=function(e){var t,r=e.length;for(t=0;r>t;++t)this.edge_list.push(new n(e[t],e[(t+1)%r]))},v.prototype.getPoint=function(e){return this.points_[e]},v.prototype.addToMap=function(e){this.map_.push(e)},v.prototype.locateNode=function(e){return this.front_.locateNode(e.x)},v.prototype.createAdvancingFront=function(){var e,t,r,i=new a(this.points_[0],this.tail_,this.head_);this.map_.push(i),e=new p(i.getPoint(1),i),t=new p(i.getPoint(0),i),r=new p(i.getPoint(2)),this.front_=new d(e,r),e.next=t,t.next=r,t.prev=e,r.prev=t},v.prototype.removeNode=function(e){},v.prototype.mapTriangleToNodes=function(e){for(var t=0;3>t;++t)if(!e.getNeighbor(t)){var r=this.front_.locatePoint(e.pointCW(e.getPoint(t)));r&&(r.triangle=e)}},v.prototype.removeFromMap=function(e){var t,r=this.map_,i=r.length;for(t=0;i>t;t++)if(r[t]===e){r.splice(t,1);break}},v.prototype.meshClean=function(e){for(var t,r,i=[e];t=i.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),r=0;3>r;r++)t.constrained_edge[r]||i.push(t.getNeighbor(r))};var g={};g.triangulate=function(e){e.initTriangulation(),e.createAdvancingFront(),g.sweepPoints(e),g.finalizationPolygon(e)},g.sweepPoints=function(e){var t,r=e.pointCount();for(t=1;r>t;++t)for(var i=e.getPoint(t),o=g.pointEvent(e,i),n=i._p2t_edge_list,a=0;n&&a<n.length;++a)g.edgeEventByEdge(e,n[a],o)},g.finalizationPolygon=function(e){for(var t=e.front().head().next.triangle,r=e.front().head().next.point;!t.getConstrainedEdgeCW(r);)t=t.neighborCCW(r);e.meshClean(t)},g.pointEvent=function(e,t){var r=e.locateNode(t),i=g.newFrontTriangle(e,t,r);return t.x<=r.point.x+c&&g.fill(e,r),g.fillAdvancingFront(e,i),i},g.edgeEventByEdge=function(e,t,r){e.edge_event.constrained_edge=t,e.edge_event.right=t.p.x>t.q.x,g.isEdgeSideOfTriangle(r.triangle,t.p,t.q)||(g.fillEdgeEvent(e,t,r),g.edgeEventByPoints(e,t.p,t.q,r.triangle,t.q))},g.edgeEventByPoints=function(t,r,o,n,a){if(!g.isEdgeSideOfTriangle(n,r,o)){var s=n.pointCCW(a),l=e(o,s,r);if(l===u.COLLINEAR)throw new i("EdgeEvent: Collinear not supported!",[o,s,r]);var c=n.pointCW(a),h=e(o,c,r);if(h===u.COLLINEAR)throw new i("EdgeEvent: Collinear not supported!",[o,c,r]);l===h?(n=l===u.CW?n.neighborCCW(a):n.neighborCW(a),g.edgeEventByPoints(t,r,o,n,a)):g.flipEdgeEvent(t,r,o,n,a)}},g.isEdgeSideOfTriangle=function(e,t,r){var i=e.edgeIndex(t,r);if(-1!==i){e.markConstrainedEdgeByIndex(i);var o=e.getNeighbor(i);return o&&o.markConstrainedEdgeByPoints(t,r),!0}return!1},g.newFrontTriangle=function(e,t,r){var i=new a(t,r.point,r.next.point);i.markNeighbor(r.triangle),e.addToMap(i);var o=new p(t);return o.next=r.next,o.prev=r,r.next.prev=o,r.next=o,g.legalize(e,i)||e.mapTriangleToNodes(i),o},g.fill=function(e,t){var r=new a(t.prev.point,t.point,t.next.point);r.markNeighbor(t.prev.triangle),r.markNeighbor(t.triangle),e.addToMap(r),t.prev.next=t.next,t.next.prev=t.prev,g.legalize(e,r)||e.mapTriangleToNodes(r)},g.fillAdvancingFront=function(e,t){for(var r,i=t.next;i.next&&(r=g.holeAngle(i),!(r>l||-l>r));)g.fill(e,i),i=i.next;for(i=t.prev;i.prev&&(r=g.holeAngle(i),!(r>l||-l>r));)g.fill(e,i),i=i.prev;t.next&&t.next.next&&(r=g.basinAngle(t),s>r&&g.fillBasin(e,t))},g.basinAngle=function(e){var t=e.point.x-e.next.next.point.x,r=e.point.y-e.next.next.point.y;return Math.atan2(r,t)},g.holeAngle=function(e){var t=e.next.point.x-e.point.x,r=e.next.point.y-e.point.y,i=e.prev.point.x-e.point.x,o=e.prev.point.y-e.point.y;return Math.atan2(t*o-r*i,t*i+r*o)},g.legalize=function(e,t){for(var r=0;3>r;++r)if(!t.delaunay_edge[r]){var i=t.getNeighbor(r);if(i){var o=t.getPoint(r),n=i.oppositePoint(t,o),a=i.index(n);if(i.constrained_edge[a]||i.delaunay_edge[a]){t.constrained_edge[r]=i.constrained_edge[a];continue}var s=g.inCircle(o,t.pointCCW(o),t.pointCW(o),n);if(s){t.delaunay_edge[r]=!0,i.delaunay_edge[a]=!0,g.rotateTrianglePair(t,o,i,n);var l=!g.legalize(e,t);return l&&e.mapTriangleToNodes(t),l=!g.legalize(e,i),l&&e.mapTriangleToNodes(i),t.delaunay_edge[r]=!1,i.delaunay_edge[a]=!1,!0}}}return!1},g.inCircle=function(e,t,r,i){var o=e.x-i.x,n=e.y-i.y,a=t.x-i.x,s=t.y-i.y,l=o*s,c=a*n,h=l-c;if(0>=h)return!1;var u=r.x-i.x,p=r.y-i.y,d=u*n,f=o*p,m=d-f;if(0>=m)return!1;var v=a*p,g=u*s,y=o*o+n*n,x=a*a+s*s,w=u*u+p*p,b=y*(v-g)+x*m+w*h;return b>0},g.rotateTrianglePair=function(e,t,r,i){var o,n,a,s;o=e.neighborCCW(t),n=e.neighborCW(t),a=r.neighborCCW(i),s=r.neighborCW(i);var l,c,h,u;l=e.getConstrainedEdgeCCW(t),c=e.getConstrainedEdgeCW(t),h=r.getConstrainedEdgeCCW(i),u=r.getConstrainedEdgeCW(i);var p,d,f,m;p=e.getDelaunayEdgeCCW(t),d=e.getDelaunayEdgeCW(t),f=r.getDelaunayEdgeCCW(i),m=r.getDelaunayEdgeCW(i),e.legalize(t,i),r.legalize(i,t),r.setDelaunayEdgeCCW(t,p),e.setDelaunayEdgeCW(t,d),e.setDelaunayEdgeCCW(i,f),r.setDelaunayEdgeCW(i,m),r.setConstrainedEdgeCCW(t,l),e.setConstrainedEdgeCW(t,c),e.setConstrainedEdgeCCW(i,h),r.setConstrainedEdgeCW(i,u),e.clearNeigbors(),r.clearNeigbors(),o&&r.markNeighbor(o),n&&e.markNeighbor(n),a&&e.markNeighbor(a),s&&r.markNeighbor(s),e.markNeighbor(r)},g.fillBasin=function(t,r){for(e(r.point,r.next.point,r.next.next.point)===u.CCW?t.basin.left_node=r.next.next:t.basin.left_node=r.next,t.basin.bottom_node=t.basin.left_node;t.basin.bottom_node.next&&t.basin.bottom_node.point.y>=t.basin.bottom_node.next.point.y;)t.basin.bottom_node=t.basin.bottom_node.next;if(t.basin.bottom_node!==t.basin.left_node){for(t.basin.right_node=t.basin.bottom_node;t.basin.right_node.next&&t.basin.right_node.point.y<t.basin.right_node.next.point.y;)t.basin.right_node=t.basin.right_node.next;t.basin.right_node!==t.basin.bottom_node&&(t.basin.width=t.basin.right_node.point.x-t.basin.left_node.point.x,t.basin.left_highest=t.basin.left_node.point.y>t.basin.right_node.point.y,g.fillBasinReq(t,t.basin.bottom_node))}},g.fillBasinReq=function(t,r){if(!g.isShallow(t,r)){g.fill(t,r);var i;if(r.prev!==t.basin.left_node||r.next!==t.basin.right_node){if(r.prev===t.basin.left_node){if(i=e(r.point,r.next.point,r.next.next.point),i===u.CW)return;r=r.next}else if(r.next===t.basin.right_node){if(i=e(r.point,r.prev.point,r.prev.prev.point),i===u.CCW)return;r=r.prev}else r=r.prev.point.y<r.next.point.y?r.prev:r.next;g.fillBasinReq(t,r)}}},g.isShallow=function(e,t){var r;return r=e.basin.left_highest?e.basin.left_node.point.y-t.point.y:e.basin.right_node.point.y-t.point.y,e.basin.width>r?!0:!1},g.fillEdgeEvent=function(e,t,r){e.edge_event.right?g.fillRightAboveEdgeEvent(e,t,r):g.fillLeftAboveEdgeEvent(e,t,r)},g.fillRightAboveEdgeEvent=function(t,r,i){for(;i.next.point.x<r.p.x;)e(r.q,i.next.point,r.p)===u.CCW?g.fillRightBelowEdgeEvent(t,r,i):i=i.next},g.fillRightBelowEdgeEvent=function(t,r,i){i.point.x<r.p.x&&(e(i.point,i.next.point,i.next.next.point)===u.CCW?g.fillRightConcaveEdgeEvent(t,r,i):(g.fillRightConvexEdgeEvent(t,r,i),g.fillRightBelowEdgeEvent(t,r,i)))},g.fillRightConcaveEdgeEvent=function(t,r,i){g.fill(t,i.next),i.next.point!==r.p&&e(r.q,i.next.point,r.p)===u.CCW&&e(i.point,i.next.point,i.next.next.point)===u.CCW&&g.fillRightConcaveEdgeEvent(t,r,i)},g.fillRightConvexEdgeEvent=function(t,r,i){e(i.next.point,i.next.next.point,i.next.next.next.point)===u.CCW?g.fillRightConcaveEdgeEvent(t,r,i.next):e(r.q,i.next.next.point,r.p)===u.CCW&&g.fillRightConvexEdgeEvent(t,r,i.next)},g.fillLeftAboveEdgeEvent=function(t,r,i){for(;i.prev.point.x>r.p.x;)e(r.q,i.prev.point,r.p)===u.CW?g.fillLeftBelowEdgeEvent(t,r,i):i=i.prev},g.fillLeftBelowEdgeEvent=function(t,r,i){i.point.x>r.p.x&&(e(i.point,i.prev.point,i.prev.prev.point)===u.CW?g.fillLeftConcaveEdgeEvent(t,r,i):(g.fillLeftConvexEdgeEvent(t,r,i),g.fillLeftBelowEdgeEvent(t,r,i)))},g.fillLeftConvexEdgeEvent=function(t,r,i){e(i.prev.point,i.prev.prev.point,i.prev.prev.prev.point)===u.CW?g.fillLeftConcaveEdgeEvent(t,r,i.prev):e(r.q,i.prev.prev.point,r.p)===u.CW&&g.fillLeftConvexEdgeEvent(t,r,i.prev)},g.fillLeftConcaveEdgeEvent=function(t,r,i){g.fill(t,i.prev),i.prev.point!==r.p&&e(r.q,i.prev.point,r.p)===u.CW&&e(i.point,i.prev.point,i.prev.prev.point)===u.CW&&g.fillLeftConcaveEdgeEvent(t,r,i)},g.flipEdgeEvent=function(r,i,o,n,a){var s=n.neighborAcross(a);if(!s)throw new Error("[BUG:FIXME] FLIP failed due to missing triangle!");var l=s.oppositePoint(n,a);if(t(a,n.pointCCW(a),n.pointCW(a),l))if(g.rotateTrianglePair(n,a,s,l),r.mapTriangleToNodes(n),r.mapTriangleToNodes(s),a===o&&l===i)o===r.edge_event.constrained_edge.q&&i===r.edge_event.constrained_edge.p&&(n.markConstrainedEdgeByPoints(i,o),s.markConstrainedEdgeByPoints(i,o),g.legalize(r,n),g.legalize(r,s));else{var c=e(o,l,i);n=g.nextFlipTriangle(r,c,n,s,a,l),g.flipEdgeEvent(r,i,o,n,a)}else{var h=g.nextFlipPoint(i,o,s,l);g.flipScanEdgeEvent(r,i,o,n,s,h),g.edgeEventByPoints(r,i,o,n,a)}},g.nextFlipTriangle=function(e,t,r,i,o,n){var a;return t===u.CCW?(a=i.edgeIndex(o,n),i.delaunay_edge[a]=!0,g.legalize(e,i),i.clearDelunayEdges(),r):(a=r.edgeIndex(o,n),r.delaunay_edge[a]=!0,g.legalize(e,r),r.clearDelunayEdges(),i)},g.nextFlipPoint=function(t,r,o,n){var a=e(r,n,t);if(a===u.CW)return o.pointCCW(n);if(a===u.CCW)return o.pointCW(n);throw new i("[Unsupported] nextFlipPoint: opposing point on constrained edge!",[r,n,t])},g.flipScanEdgeEvent=function(e,r,i,o,n,a){var s=n.neighborAcross(a);if(!s)throw new Error("[BUG:FIXME] FLIP failed due to missing triangle");var l=s.oppositePoint(n,a);if(t(i,o.pointCCW(i),o.pointCW(i),l))g.flipEdgeEvent(e,i,l,s,l);else{var c=g.nextFlipPoint(r,i,s,l);g.flipScanEdgeEvent(e,r,i,o,s,c)}};var y={_PointError:i,_Point:o,_Triangle:a,_SweepContext:v,_triangulate:g.triangulate,_sweep:{Triangulate:g.triangulate}};return r.newPoint=function(e,t){return new y._Point(e,t)},r.TriangulatePoly=function(e){var t=new y._SweepContext(e);return t.triangulate(),t.getTriangles()},r.initSweepContext=function(e){return new y._SweepContext(e)},r}.call(t,r,t,e),!(void 0!==i&&(e.exports=i))},function(e,t,r){var i,o;i=[r(3),r(5),r(6),r(1),r(4),r(23),r(8),r(24),r(7),r(16),r(2)],o=function(e,t,i,o,n,a,s,l,c,h){var u=null,p={name:"not attributed"},d=null,f=null,m=null,v=!0,g=1,y=0,x=0,w=0,b=0,_=250,M=10,S=null,T=!1,C=new o.Vector3,L=new Array,A=new Array,P=new Array,D=null,F=null,E=null,V=!1,R=0,z={x:-20037508,y:20037508},I=[],U=!0,O="",B="",N=!1,k=!1,G={panoInfo:null,skyBox:null,init:function(t,r){O=r.urlBuildingFootprint||i.dataURL.defaultUrlBuildingFootprint,N=O.indexOf("http")<0,B=r.urlDTM||i.dataURL.defaultUrlDTM,k=B.indexOf("php")<0,e.isMobileEnvironment()&&(_=100),this.panoInfo=t,y=t.easting,x=t.northing,w=y,b=x,this.checkStereopolisVersionFromPosition(),this.loadAndCreateMeshFromDB()},updateDataFromRGE:function(){var e=this.panoInfo;y=e.easting,x=e.northing;var t=Math.sqrt((y-w)*(y-w)+(x-b)*(x-b));t>=.8*_&&(console.log("load NEW RGE DATA"),I.length>0&&this.removeMapMeshes(),this.getDTMFromTrajectory(),w=y,b=x)},checkStereopolisVersionFromPosition:function(){g=1;this.panoInfo.filename},forceUpdateRGE:function(){console.log("forceUpdateRGE");var e=this.panoInfo;y=e.easting,x=e.northing,this.searchPolygonBatiAround(y,x,_),w=y,b=x},loadAndCreateMeshFromDB:function(){console.log("load and create mesh DTM then BATI from footprint"),this.getDTMFromTrajectory()},loadAndCreateMeshFromDBNewCam:function(){this.createGeometry3DfromPoly2([])},searchPolygonBatiAround:function(e,r,i){this.checkStereopolisVersionFromPosition(),console.log("config",g);var n=this;if(N)t.getJSON(O,function(e){n.createGeometry3DfromPoly(e,!0)});else{var a=new o.Vector2(e-i,r-i),s=new o.Vector2(e+i,r+i),l="72hpsel8j8nhb5qgdh07gcyp",c="service=WFS&version=2.0.0&REQUEST=GetFeature&typeName=BDTOPO_BDD_WLD_WGS84G:bati_remarquable,BDTOPO_BDD_WLD_WGS84G:bati_indifferencie",h=O+l+"/geoportail/wfs?"+c+"&srsName=EPSG:2154&bbox="+a.x+","+a.y+","+s.x+","+s.y+",EPSG:2154&outputFormat=json";t.getJSON(h,function(e){n.createGeometry3DfromPoly(e,!0)})}},generatePointOnCircle:function(e,t,r,i,o,n,a){o=o||0,n=n||360,a=a||"clockwise";for(var s=[],l=Math.PI/180,c=0*l,h=n/i,u=h*l;i--;){var p=e+Math.sin(c)*r,d=t+Math.cos(c)*r;s.push({x:p,y:d}),"antiClockwise"==a?c+=u:c-=u}return s},createGeometry3DfromPoly:function(t,r){u=new o.Geometry;var i=new o.Geometry,n=new o.Geometry,l=2,c=e.getZeroAsVec3D(),d=this.panoInfo.altitude-c.y-l,y=_+100,x=10;if(r)for(var w=t.features,b=0;b<w.length;b++){var M=w[b].properties.hauteur+x||0,T=0,L=w[b].geometry.coordinates[0][0];if(L.length>2){for(var P=16777215,D=[],E=0;E<L.length-1;++E){var V=L[E],R=new o.Vector3(parseFloat(V[0])-c.x,0,parseFloat(V[1])-c.z),z=Math.floor((R.x-C.x+y)/10),I=Math.floor((R.z-C.z+y)/10);z>0&&z<A.length&&I>0&&I<A.length&&(T=A[z][I]);var O=new o.Vector3(R.x,T,R.z),B=new o.Vector3(R.x,T+M,R.z);D.push(h.newPoint(R.x,R.z)),u.vertices.push(O,B)}for(var N=u.vertices.length-2*(L.length-1);N<u.vertices.length;N+=2){var k=N;k>u.vertices.length-4&&(k=u.vertices.length-2*(L.length-1)),u.faces.push(new o.Face3(k,k+1,k+3)),u.faces.push(new o.Face3(k,k+3,k+2))}var G=u.vertices.length-2*(L.length-1);u.faces.push(new o.Face3(G,G+1,u.vertices.length-1)),u.faces.push(new o.Face3(G,u.vertices.length-1,u.vertices.length-2))}var j=h.TriangulatePoly(D);j.forEach(function(e){var t=e.getPoint(0),r=e.getPoint(1),n=e.getPoint(2);i.vertices.push(new o.Vector3(t.x,T+M,t.y)),i.vertices.push(new o.Vector3(r.x,T+M,r.y)),i.vertices.push(new o.Vector3(n.x,T+M,n.y));var a=new o.Face3(i.vertices.length-3,i.vertices.length-2,i.vertices.length-1);i.faces.push(a)})}else for(var b=0;b<t.length;b++){var W=t[b],H=W.geom.replace("POLYGON((","").replace("))","");H=H.split("),(");var L=H[0].split(","),M=W.h+x||0,T=W.alti-c.y||d;if(L.length>2){for(var P=16777215,D=[],E=0;E<L.length-1;++E){var V=L[E].split(" "),R=new o.Vector3(parseFloat(V[0])-c.x,0,parseFloat(V[1])-c.z),z=Math.floor((R.x-C.x+y)/10),I=Math.floor((R.z-C.z+y)/10);z>0&&z<A.length&&I>0&&I<A.length&&(T=A[z][I]);var O=new o.Vector3(R.x,T,R.z),B=new o.Vector3(R.x,T+M,R.z);D.push(h.newPoint(R.x,R.z)),u.vertices.push(O,B)}for(var N=u.vertices.length-2*(L.length-1);N<u.vertices.length;N+=2){var k=N;k>u.vertices.length-4&&(k=u.vertices.length-2*(L.length-1)),u.faces.push(new o.Face3(k,k+1,k+3)),u.faces.push(new o.Face3(k,k+3,k+2))}var G=u.vertices.length-2*(L.length-1);u.faces.push(new o.Face3(G,G+1,u.vertices.length-1)),u.faces.push(new o.Face3(G,u.vertices.length-1,u.vertices.length-2))}var j=h.TriangulatePoly(D);j.forEach(function(e){var t=e.getPoint(0),r=e.getPoint(1),n=e.getPoint(2);i.vertices.push(new o.Vector3(t.x,T+M,t.y)),i.vertices.push(new o.Vector3(r.x,T+M,r.y)),i.vertices.push(new o.Vector3(n.x,T+M,n.y));var a=new o.Face3(i.vertices.length-3,i.vertices.length-2,i.vertices.length-1);i.faces.push(a)})}S&&e.removeFromScene(S),S=new o.Mesh(i,new o.MeshBasicMaterial({color:P,transparent:!0,opacity:.6})),S.geometry.verticesNeedUpdate=!0,S.material.side=o.DoubleSide,S.visible=v,e.addToScene(S);var X=this.panoInfo.easting-e.getZeroAsVec3D().x,q=this.panoInfo.altitude-e.getZeroAsVec3D().y,Y=this.panoInfo.northing-e.getZeroAsVec3D().z;if(n=u.clone(),U){var Z=500;n.vertices.push(new o.Vector3(X-Z,d,Y-Z),new o.Vector3(X-Z,d,Y+Z),new o.Vector3(X+Z,d,Y+Z),new o.Vector3(X+Z,d,Y-Z));var K=n.vertices.length;n.faces.push(new o.Face3(K-4,K-3,K-2)),n.faces.push(new o.Face3(K-4,K-2,K-1));for(var K=u.vertices.length,Q=F.geometry,J=0;J<Q.vertices.length;++J)u.vertices.push(Q.vertices[J]);for(J=0;J<Q.faces.length;++J){var $=Q.faces[J];u.faces.push(new o.Face3($.a+K,$.b+K,$.c+K))}var J,ee,te,re,ie,$,oe,ne,ae=5e3;J=new o.Vector3(X-ae,q-ae,Y-ae),ee=new o.Vector3(X-ae,q+ae,Y-ae),te=new o.Vector3(X+ae,q+ae,Y-ae),re=new o.Vector3(X+ae,q-ae,Y-ae),ie=new o.Vector3(X-ae,q+ae,Y+ae),$=new o.Vector3(X+ae,q+ae,Y+ae),oe=new o.Vector3(X+ae,q-ae,Y+ae),ne=new o.Vector3(X-ae,q-ae,Y+ae),u.vertices.push(J,ee,te,re,ie,$,oe,ne),K=u.vertices.length,u.faces.push(new o.Face3(K-1,K-2,K-3)),u.faces.push(new o.Face3(K-1,K-3,K-4)),u.faces.push(new o.Face3(K-6,K-3,K-2)),u.faces.push(new o.Face3(K-6,K-2,K-5)),u.faces.push(new o.Face3(K-8,K-7,K-6)),u.faces.push(new o.Face3(K-8,K-6,K-5)),u.faces.push(new o.Face3(K-8,K-7,K-4)),u.faces.push(new o.Face3(K-8,K-4,K-1)),u.faces.push(new o.Face3(K-7,K-6,K-3)),u.faces.push(new o.Face3(K-7,K-3,K-4)),u.faces.push(new o.Face3(K-8,K-5,K-2)),u.faces.push(new o.Face3(K-8,K-2,K-1))}console.log("RGE Bati loaded and transformed to mesh OK"),console.log("_configStereo: ",g),u.computeFaceNormals(),n.computeFaceNormals();var se=new o.MeshBasicMaterial({color:16711935});if(se.side=o.DoubleSide,m=new o.Mesh(n,se),a.isInitiated()){console.log("ProjectiveTexturing  "),e.removeFromScene(p),console.log("remove old mesh");var le=new o.Mesh(u,a.getShaderMat());le.material.side=o.DoubleSide,le.material.transparent=!1,le.name="RGE",le.visible=v,p=le}else{console.log("ProjectiveTexturing init ");var se=new o.MeshBasicMaterial({color:16711935}),le=new o.Mesh(u,se);se.side=o.DoubleSide,le.name="RGE",p=le;var ce=s.computeMatOriFromHeadingPitchRoll(this.panoInfo.pan_xml_heading_pp,this.panoInfo.pan_xml_pitch_pp,this.panoInfo.pan_xml_roll_pp);a.init(),f=a.createShaderMat(this.panoInfo,ce),le.material=f,le.material.side=o.DoubleSide,le.material.transparent=!1,le.visible=v}e.addToScene(p),this.setRoadOn(!0),allInitialized=!0},initGeometryWithCube:function(t){var r=2,i=this.panoInfo.altitude-e.getZeroAsVec3D().y-r;u=new o.Geometry;var n=this.panoInfo.easting-e.getZeroAsVec3D().x,s=this.panoInfo.altitude-e.getZeroAsVec3D().y,l=this.panoInfo.northing-e.getZeroAsVec3D().z,c=500;u.vertices.push(new o.Vector3(n-c,i,n-c),new o.Vector3(n-c,i,n+c),new o.Vector3(n+c,i,n+c),new o.Vector3(n+c,i,n-c));var h=u.vertices.length;u.faces.push(new o.Face4(h-4,h-3,h-2,h-1));var d,m,g,y,x,w,b,_,M=5e3;if(d=new o.Vector3(n-M,s-M,l-M),m=new o.Vector3(n-M,s+M,l-M),g=new o.Vector3(n+M,s+M,l-M),y=new o.Vector3(n+M,s-M,l-M),x=new o.Vector3(n-M,s+M,l+M),w=new o.Vector3(n+M,s+M,l+M),b=new o.Vector3(n+M,s-M,l+M),_=new o.Vector3(n-M,s-M,l+M),u.vertices.push(d,m,g,y,x,w,b,_),h=u.vertices.length,u.faces.push(new o.Face4(h-1,h-2,h-3,h-4)),u.faces.push(new o.Face4(h-6,h-3,h-2,h-5)),u.faces.push(new o.Face4(h-8,h-7,h-6,h-5)),u.faces.push(new o.Face4(h-8,h-7,h-4,h-1)),u.faces.push(new o.Face4(h-7,h-6,h-3,h-4)),u.faces.push(new o.Face4(h-8,h-5,h-2,h-1)),u.computeFaceNormals(),a.isInitiated()){e.removeFromScene(p),console.log("remove old mesh");var S=new o.Mesh(u,f);S.material.side=o.DoubleSide,S.material.transparent=!0,S.name="RGE",S.visible=v,p=S,e.addToScene(p)}else{var T=new o.MeshBasicMaterial({color:16711935}),S=new o.Mesh(u,T);T.side=o.DoubleSide,S.name="RGE",p=S,a.init(),f=a.createShaderMat(this.panoInfo.filename,50),S.material=f,S.material.side=o.DoubleSide,S.material.transparent=!0,S.visible=v,e.addToScene(p)}},getDTMFromTrajectory:function(){console.log("getDTM");var e=this.panoInfo,r=this,i=k?B:B+"easting="+e.easting+"&northing="+e.northing+"&radius="+_;t.getJSON(i,function(t){r.createDTMFromTrajectory(t,e)})},createDTMFromTrajectory:function(t,r){var i=_+100,n=2.1,a=e.getZeroAsVec3D();C=new o.Vector3(r.easting-a.x,r.altitude-a.y,r.northing-a.z);for(var s=Math.floor(2*i/10),l=0;s>l;++l){A[l]=new Array;for(var c=0;s>c;++c)A[l][c]=0}for(l=0;l<t.length;++l){var h=t[l];h.h-=a.y+n,h.e-=a.x+C.x,h.n-=a.z+C.z,A[Math.floor((h.e+i)/M)][Math.floor((h.n+i)/M)]=h.h}this.smoothGrid(A)},smoothGrid:function(t){console.log("smoothGrid");for(var r=new Array,i=t.length,n=_+100,a=0;i>a;++a){r[a]=new Array;for(var s=0;i>s;++s)r[a][s]=-2}for(var a=3;a<t.length-3;a+=1)for(var s=3;s<t.length-3;s+=1){for(var l=0,c=0,h=-1e3,u=-3;3>=u;++u)for(var p=-3;3>=p;++p){var d=t[a+u][s+p];0!=d&&Math.abs(d-h)>.3&&(l+=d,c++,h=d)}0!=c&&(r[a][s]=l/c)}for(var f=new o.Geometry,a=0;a<t.length;++a)for(var s=0;s<t[0].length;++s){var m=new o.Vector3(a*M-n+C.x,r[a][s],s*M-n+C.z);f.vertices.push(m)}for(var u=0;u<f.vertices.length;++u)u<f.vertices.length-t.length-1&&(u+1)%t.length!=0&&(f.faces.push(new o.Face3(u,u+1,u+t.length)),f.faces.push(new o.Face3(u+1,u+1+t.length,u+t.length)));f.computeFaceNormals();var v=new o.MeshBasicMaterial({color:16777215*Math.random(),wireframe:!0});if(v.side=o.DoubleSide,T?(F&&e.removeFromScene(F),F=new o.Mesh(f.clone(),v),e.addToScene(F)):F=new o.Mesh(f,v),A=r,D=f,this.searchPolygonBatiAround(y,x,_),this.getOrthoPhotoOn()){this.removeMapMeshes();var g="ORTHOIMAGERY.ORTHOPHOTOS.PARIS",w=this.panoInfo;(w.easting>656e3||w.easting<64e4||w.northing>6869e3||w.northing<686e4)&&(g="ORTHOIMAGERY.ORTHOPHOTOS");var b={x:w.easting,z:w.northing};this.generateCartoPlane({x:b.x,y:b.z},18,10,g,"jpeg",128)}},initGridDTM:function(e){for(var t=0;e>t;++t){L[t]=new Array;for(var r=0;e>r;++r)L[t][r]=0}},generateSkyBox:function(){if(null==this.skyBox){var t=["../../images/textures/skybox/px.jpg","../../images/textures/skybox/nx.jpg","../../images/textures/skybox/py.jpg","../../images/textures/skybox/ny.jpg","../../images/textures/skybox/pz.jpg","../../images/textures/skybox/nz.jpg"],r=o.ImageUtils.loadTextureCube(t);r.format=o.RGBFormat;var i=o.ShaderLib.cube;i.uniforms.tCube.value=r;var n=new o.ShaderMaterial({fragmentShader:i.fragmentShader,vertexShader:i.vertexShader,uniforms:i.uniforms});this.skyBox=new o.Mesh(new o.CubeGeometry(8e3,8e3,8e3),n)}e.addToScene(this.skyBox)},removeSkyBox:function(){e.removeFromScene(this.skyBox)},setSkyBoxVisibility:function(e){this.skyBox.visible=e},generateCartoPlane:function(t,r,o,n,a,s){this.removeMapMeshes();var s=s||164,c=8,h=256;t.x-=s*c/2,t.y-=s*c/2;var u=10,p={x:t.x-e.getZero().x,y:t.y-e.getZero().z};console.log(p);var d=new l("name",n,a,p,s,h,c,D,C,A.length,_+100,i.geoAPIKey,u);d.createTilesList(t,s),d.loadTilesFromList(),e.addToScene(d.meshNest),I.push(d.meshNest)},generateCartoPlanePARIS:function(t,r,n,a,s){var c=1e3,h=8,u=256;t.x-=c*h/2,t.y-=c*h/2;var p={x:t.x-e.getZero().x,y:t.y-e.getZero().z};console.log(p);var d=this.panoInfo,f=4500,m=f+100,v=400,g=e.getZeroAsVec3D();C=new o.Vector3(d.easting-g.x,d.altitude-g.y,d.northing-g.z);for(var y=Math.floor(2*m/v),x=0;y>x;++x){P[x]=new Array;for(var w=0;y>w;++w)P[x][w]=-20}for(var b=new o.Geometry,x=0;x<P.length;++x)for(var w=0;w<P.length;++w){var _=new o.Vector3(x*v-m+C.x,P[x][w],w*v-m+C.z);b.vertices.push(_)}for(var M=0;M<b.vertices.length;++M)M<b.vertices.length-P.length-1&&(M+1)%P.length!=0&&(b.faces.push(new o.Face3(M,M+1,M+P.length)),b.faces.push(new o.Face3(M+1,M+1+P.length,M+P.length)));b.computeFaceNormals();var S=new l("name",a,s,p,c,u,h,b,C,P.length,f+100,i.geoAPIKey,v);S.createTilesList(t,c),S.loadTilesFromList(),E=S.meshNest,e.addToScene(E)},setVisibilityParisOrtho:function(e){E.visible=e},getMeshFES:function(){return E},generateCartoPlaneWMTSMercator:function(t,i,n,a,s,h){R=r(2).computeSizeTile(i);var u=r(2).getTileCoordAtPos(t,R),p=u.x*R+z.x,d=-u.y*R+z.y,f=r(2).convertCoord({x:p,y:d},"EPSG:3857","EPSG:2154"),m=p+8*R,v=d-8*R,g=r(2).convertCoord({x:m,y:v},"EPSG:3857","EPSG:2154"),y=g.x-f.x,x=g.y-f.y,w=r(2).convertCoord({x:m,y:d},"EPSG:3857","EPSG:2154"),b=r(2).convertCoord({x:p,y:v},"EPSG:3857","EPSG:2154"),_=e.getZeroAsVec3D(),M=new o.Vector3(f.x-_.x,h,f.y-_.z),S=new o.Vector3(g.x-_.x,h,g.y-_.z),T=new o.Vector3(w.x-_.x,h,w.y-_.z),C=new o.Vector3(b.x-_.x,h,b.y-_.z);c.drawSphereAt(M,15,16711680),c.drawSphereAt(S,15,65280),c.drawSphereAt(C,15,255);var L=new l("ur",a,s,i,y,x,5,5,M,S,C,T,D);L.createTilesList(u.x,u.y),L.loadTilesFromList(),e.addToScene(L.meshNest),I.push(L.meshNest)},setMapOpacity:function(e){I[0].material.opacity=e},getTabMesh:function(){return I},removeMapMeshes:function(){e.removeFromScene(I[0]),I=[]},displayTile:function(t,r){R=50.23516095429659;var i=new o.Texture(t,o.UVMapping,o.RepeatWrapping,o.RepeatWrapping,o.LinearFilter,o.LinearFilter),n=new o.MeshBasicMaterial({map:i,transparent:!1});n.side=o.DoubleSide;var a=new o.Mesh(new o.PlaneGeometry(R,R),n);e.addToScene(a),i.needsUpdate=!0;var s=2,l=e.getZeroAsVec3D(),c=this.panoInfo.altitude-l.y-s;a.rotation.x=Math.PI/2,console.log("posLamb",r),a.position=new o.Vector3(r.x-l.x+R/2,c,r.y-l.z-R/2)},getCurrentObject:function(){return p},getCurrentMeshForClickAndGo:function(){return m},getProjectiveMaterial:function(){return f},getGeometry:function(){return u},getCurrentObjectToDrag:function(){return d},getConfigStereo:function(){return g},setConfigStereo:function(e){
g=e},getOrthoPhotoOn:function(){return V},addAmbientLight:function(){var t=new o.AmbientLight(1052720);e.addToScene(t)},addDirectionalLight:function(){var t=new o.DirectionalLight(16777215);t.position.set(1e3,1e3,0).normalize(),e.addToScene(t)},setVisibility:function(e){v=e,p.visible=e,this.setRoofVisibility(e)},setRoofVisibility:function(e){void 0!=S&&(S.visible=e)},tweenGeneralOpacityUp:function(){console.log("tweenGeneralOpacityUp"),a.isInitiated()&&(a.setGeneralOpacity(0),a.tweenGeneralOpacityUp())},setFogValue:function(e){a.isInitiated()&&a.setFogValue(e)},setRoadOn:function(e){U=e},setOrthoPhotoOn:function(e){V=e},setShowDTM:function(t){if(T=t){F&&e.removeFromScene(F);var r=new o.MeshBasicMaterial({color:16777215*Math.random(),wireframe:!0});r.side=o.DoubleSide,F=new o.Mesh(D.clone(),r),e.addToScene(F)}else F&&e.removeFromScene(F)},getAltiFromDTM:function(e){var t=_+100,r=0,i=Math.floor((e.x-C.x+t)/10),o=Math.floor((e.z-C.z+t)/10);return i>0&&i<A.length&&o>0&&o<A.length&&(r=A[i][o]),r},removeCubeFromMeshFaces:function(){var e=p.geometry.faces.length;console.log(e),p.geometry.faces[e-1]=null,p.geometry.faces[e-2]=null,p.geometry.faces[e-3]=null,p.geometry.faces[e-4]=null,p.geometry.faces[e-5]=null,p.geometry.faces[e-6]=null,p.geometry.faces[e-7]=null,p.geometry.faces[e-8]=null,p.geometry.faces[e-9]=null,p.geometry.faces[e-10]=null,p.geometry.faces[e-11]=null,p.geometry.faces.length=e-2500,p.geometry.elementsNeedUpdate=!0,console.log(e)}};return G}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(5),r(6)],o=function(e,t){function r(e,t,r){msg=t+", "+r,console.error(msg)}var i=!0,o={init:function(){e.ajaxSetup({timeout:t.requestTimeout})},getPanoInfo:function(e,r){r=r||parseInt(e[e.length-1].split("=")[1]);for(var i=parseInt(e[e.length-2].split("=")[1]),o=[],n=0;i>n;n++)o.push(e[n].split("=")[0]);var a=[];for(n=0;r>n;n++){for(var s={},l=n*i,c=0;i>c;c++){var h=o[c],u=e[l+c].split("=")[1];"filename"!==h&&null===h.match(/time/)&&null===h.match(/addr/)&&(u=parseFloat(u)),s[h]=u}s.url=t.server.url+t.server.iipService+"/"+s.filename+".jp2",a.push(s)}return a},sendCommand:function(t,o,n){if(n=n||!1,n===!0)e.getJSON(t,function(e){o(e)}).fail(r);else{var a=e.get(t,function(e){if(e.length>0){var t=e.trim().split("&");o(t)}else i===!0&&console.warn("Result of query is empty")});a.fail(r)}}};return o}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i;/**
	  @license
	  when.js - https://github.com/cujojs/when
	
	  MIT License (c) copyright B Cavalier & J Hann
	
	 * A lightweight CommonJS Promises/A and when() implementation
	 * when is part of the cujo.js family of libraries (http://cujojs.com/)
	 *
	 * Licensed under the MIT License at:
	 * http://www.opensource.org/licenses/mit-license.php
	 *
	 * @version 1.7.1
	 */
!function(o){"use strict";i=function(){function e(e,r,i,o){return t(e).then(r,i,o)}function t(e){var t,r;return e instanceof i?t=e:s(e)?(r=a(),e.then(function(e){r.resolve(e)},function(e){r.reject(e)},function(e){r.progress(e)}),t=r.promise):t=o(e),t}function r(t){return e(t,n)}function i(e){this.then=e}function o(e){var r=new i(function(r){try{return t(r?r(e):e)}catch(i){return n(i)}});return r}function n(e){var r=new i(function(r,i){try{return i?t(i(e)):n(e)}catch(o){return n(o)}});return r}function a(){function e(e,t,r){return p(e,t,r)}function r(e){return f(e)}function o(e){return f(n(e))}function s(e){return d(e)}var l,c,h,u,p,d,f;return c=new i(e),l={then:e,resolve:r,reject:o,progress:s,promise:c,resolver:{resolve:r,reject:o,progress:s}},h=[],u=[],p=function(e,t,r){var i,o;return i=a(),o="function"==typeof r?function(e){try{i.progress(r(e))}catch(t){i.progress(t)}}:function(e){i.progress(e)},h.push(function(r){r.then(e,t).then(i.resolve,i.reject,o)}),u.push(o),i.promise},d=function(e){return m(u,e),e},f=function(e){return e=t(e),p=e.then,f=t,d=g,m(h,e),u=h=b,e},l}function s(e){return e&&"function"==typeof e.then}function l(t,r,i,o,n){return v(2,arguments),e(t,function(t){function s(e){m(e)}function l(e){f(e)}var c,h,u,p,d,f,m,v,y,x;if(y=t.length>>>0,c=Math.max(0,Math.min(r,y)),u=[],h=y-c+1,p=[],d=a(),c)for(v=d.progress,m=function(e){p.push(e),--h||(f=m=g,d.reject(p))},f=function(e){u.push(e),--c||(f=m=g,d.resolve(u))},x=0;y>x;++x)x in t&&e(t[x],l,s,v);else d.resolve(u);return d.then(i,o,n)})}function c(e,t,r,i){function o(e){return t?t(e[0]):e[0]}return l(e,1,o,r,i)}function h(e,t,r,i){return v(1,arguments),p(e,y).then(t,r,i)}function u(){return p(arguments,y)}function p(t,r){return e(t,function(t){var i,o,n,s,l,c;if(n=o=t.length>>>0,i=[],c=a(),n)for(s=function(t,o){e(t,r).then(function(e){i[o]=e,--n||c.resolve(i)},c.reject)},l=0;o>l;l++)l in t?s(t[l],l):--n;else c.resolve(i);return c.promise})}function d(t,r){var i=w.call(arguments,1);return e(t,function(t){var o;return o=t.length,i[0]=function(t,i,n){return e(t,function(t){return e(i,function(e){return r(t,e,n,o)})})},x.apply(t,i)})}function f(t,r,i){var o=arguments.length>2;return e(t,function(e){return e=o?i:e,r.resolve(e),e},function(e){return r.reject(e),n(e)},r.progress)}function m(e,t){for(var r,i=0;r=e[i++];)r(t)}function v(e,t){for(var r,i=t.length;i>e;)if(r=t[--i],null!=r&&"function"!=typeof r)throw new Error("arg "+i+" must be a function")}function g(){}function y(e){return e}var x,w,b;return e.defer=a,e.resolve=t,e.reject=r,e.join=u,e.all=h,e.map=p,e.reduce=d,e.any=c,e.some=l,e.chain=f,e.isPromise=s,i.prototype={always:function(e,t){return this.then(e,e,t)},otherwise:function(e){return this.then(b,e)},"yield":function(e){return this.then(function(){return e})},spread:function(e){return this.then(function(t){return h(t,function(t){return e.apply(b,t)})})}},w=[].slice,x=[].reduce||function(e){var t,r,i,o,n;if(n=0,t=Object(this),o=t.length>>>0,r=arguments,r.length<=1)for(;;){if(n in t){i=t[n++];break}if(++n>=o)throw new TypeError}else i=r[1];for(;o>n;++n)n in t&&(i=e(i,t[n],n,t));return i},e}.call(t,r,t,e),!(void 0!==i&&(e.exports=i))}(r(32))},function(e,t,r){function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function o(e,t,r){if(e&&c(e)&&e instanceof i)return e;var o=new i;return o.parse(e,t,r),o}function n(e){return l(e)&&(e=o(e)),e instanceof i?e.format():i.prototype.format.call(e)}function a(e,t){return o(e,!1,!0).resolve(t)}function s(e,t){return e?o(e,!1,!0).resolveObject(t):t}function l(e){return"string"==typeof e}function c(e){return"object"==typeof e&&null!==e}function h(e){return null===e}function u(e){return null==e}var p=r(31);t.parse=o,t.resolve=a,t.resolveObject=s,t.format=n,t.Url=i;var d=/^([a-z0-9.+-]+:)/i,f=/:[0-9]*$/,m=["<",">",'"',"`"," ","\r","\n","	"],v=["{","}","|","\\","^","`"].concat(m),g=["'"].concat(v),y=["%","/","?",";","#"].concat(g),x=["/","?","#"],w=255,b=/^[a-z0-9A-Z_-]{0,63}$/,_=/^([a-z0-9A-Z_-]{0,63})(.*)$/,M={javascript:!0,"javascript:":!0},S={javascript:!0,"javascript:":!0},T={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},C=r(30);i.prototype.parse=function(e,t,r){if(!l(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e;i=i.trim();var o=d.exec(i);if(o){o=o[0];var n=o.toLowerCase();this.protocol=n,i=i.substr(o.length)}if(r||o||i.match(/^\/\/[^@\/]+@[^@\/]+/)){var a="//"===i.substr(0,2);!a||o&&S[o]||(i=i.substr(2),this.slashes=!0)}if(!S[o]&&(a||o&&!T[o])){for(var s=-1,c=0;c<x.length;c++){var h=i.indexOf(x[c]);-1!==h&&(-1===s||s>h)&&(s=h)}var u,f;f=-1===s?i.lastIndexOf("@"):i.lastIndexOf("@",s),-1!==f&&(u=i.slice(0,f),i=i.slice(f+1),this.auth=decodeURIComponent(u)),s=-1;for(var c=0;c<y.length;c++){var h=i.indexOf(y[c]);-1!==h&&(-1===s||s>h)&&(s=h)}-1===s&&(s=i.length),this.host=i.slice(0,s),i=i.slice(s),this.parseHost(),this.hostname=this.hostname||"";var m="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!m)for(var v=this.hostname.split(/\./),c=0,L=v.length;L>c;c++){var A=v[c];if(A&&!A.match(b)){for(var P="",D=0,F=A.length;F>D;D++)P+=A.charCodeAt(D)>127?"x":A[D];if(!P.match(b)){var E=v.slice(0,c),V=v.slice(c+1),R=A.match(_);R&&(E.push(R[1]),V.unshift(R[2])),V.length&&(i="/"+V.join(".")+i),this.hostname=E.join(".");break}}}if(this.hostname.length>w?this.hostname="":this.hostname=this.hostname.toLowerCase(),!m){for(var z=this.hostname.split("."),I=[],c=0;c<z.length;++c){var U=z[c];I.push(U.match(/[^A-Za-z0-9_-]/)?"xn--"+p.encode(U):U)}this.hostname=I.join(".")}var O=this.port?":"+this.port:"",B=this.hostname||"";this.host=B+O,this.href+=this.host,m&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==i[0]&&(i="/"+i))}if(!M[n])for(var c=0,L=g.length;L>c;c++){var N=g[c],k=encodeURIComponent(N);k===N&&(k=escape(N)),i=i.split(N).join(k)}var G=i.indexOf("#");-1!==G&&(this.hash=i.substr(G),i=i.slice(0,G));var j=i.indexOf("?");if(-1!==j?(this.search=i.substr(j),this.query=i.substr(j+1),t&&(this.query=C.parse(this.query)),i=i.slice(0,j)):t&&(this.search="",this.query={}),i&&(this.pathname=i),T[n]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var O=this.pathname||"",U=this.search||"";this.path=O+U}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=encodeURIComponent(e),e=e.replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",i=this.hash||"",o=!1,n="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&c(this.query)&&Object.keys(this.query).length&&(n=C.stringify(this.query));var a=this.search||n&&"?"+n||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||T[t])&&o!==!1?(o="//"+(o||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):o||(o=""),i&&"#"!==i.charAt(0)&&(i="#"+i),a&&"?"!==a.charAt(0)&&(a="?"+a),r=r.replace(/[?#]/g,function(e){return encodeURIComponent(e)}),a=a.replace("#","%23"),t+o+r+a+i},i.prototype.resolve=function(e){return this.resolveObject(o(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if(l(e)){var t=new i;t.parse(e,!1,!0),e=t}var r=new i;if(Object.keys(this).forEach(function(e){r[e]=this[e]},this),r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol)return Object.keys(e).forEach(function(t){"protocol"!==t&&(r[t]=e[t])}),T[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r;if(e.protocol&&e.protocol!==r.protocol){if(!T[e.protocol])return Object.keys(e).forEach(function(t){r[t]=e[t]}),r.href=r.format(),r;if(r.protocol=e.protocol,e.host||S[e.protocol])r.pathname=e.pathname;else{for(var o=(e.pathname||"").split("/");o.length&&!(e.host=o.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==o[0]&&o.unshift(""),o.length<2&&o.unshift(""),r.pathname=o.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var n=r.pathname||"",a=r.search||"";r.path=n+a}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var s=r.pathname&&"/"===r.pathname.charAt(0),c=e.host||e.pathname&&"/"===e.pathname.charAt(0),p=c||s||r.host&&e.pathname,d=p,f=r.pathname&&r.pathname.split("/")||[],o=e.pathname&&e.pathname.split("/")||[],m=r.protocol&&!T[r.protocol];if(m&&(r.hostname="",r.port=null,r.host&&(""===f[0]?f[0]=r.host:f.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===o[0]?o[0]=e.host:o.unshift(e.host)),e.host=null),p=p&&(""===o[0]||""===f[0])),c)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,f=o;else if(o.length)f||(f=[]),f.pop(),f=f.concat(o),r.search=e.search,r.query=e.query;else if(!u(e.search)){if(m){r.hostname=r.host=f.shift();var v=r.host&&r.host.indexOf("@")>0?r.host.split("@"):!1;v&&(r.auth=v.shift(),r.host=r.hostname=v.shift())}return r.search=e.search,r.query=e.query,h(r.pathname)&&h(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!f.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var g=f.slice(-1)[0],y=(r.host||e.host)&&("."===g||".."===g)||""===g,x=0,w=f.length;w>=0;w--)g=f[w],"."==g?f.splice(w,1):".."===g?(f.splice(w,1),x++):x&&(f.splice(w,1),x--);if(!p&&!d)for(;x--;x)f.unshift("..");!p||""===f[0]||f[0]&&"/"===f[0].charAt(0)||f.unshift(""),y&&"/"!==f.join("/").substr(-1)&&f.push("");var b=""===f[0]||f[0]&&"/"===f[0].charAt(0);if(m){r.hostname=r.host=b?"":f.length?f.shift():"";var v=r.host&&r.host.indexOf("@")>0?r.host.split("@"):!1;v&&(r.auth=v.shift(),r.host=r.hostname=v.shift())}return p=p||r.host&&f.length,p&&!b&&f.unshift(""),f.length?r.pathname=f.join("/"):(r.pathname=null,r.path=null),h(r.pathname)&&h(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},i.prototype.parseHost=function(){var e=this.host,t=f.exec(e);t&&(t=t[0],":"!==t&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},function(e,t,r){var i,o;i=[r(5),r(3),r(1),r(12),r(9),r(10),r(2),r(7),r(16),r(15),r(4),r(36),r(6)],o=function(e,t,i,o,a,s,l,c,h,u,p,d,f){var m,v,g,y,x=null,w=null,b=(new i.Geometry,new i.Geometry),_=[],M=null,S=!1,T=null,C=1,L=.07,A=!1,P=1048576,D=null,F=0,E=0,V=!1,R=null,z="",I=0,U=!1,O=2e8,B=0,N=0,k=1,G=[],j=160,W={x:352e3,y:0,z:6688e3},H={x:339e3,y:0,z:6713e3},X={x:649e3,y:0,z:684e4},q={x:65e4,y:0,z:686e4},Y={x:624e3,y:0,z:685e4},Z={x:57e4,y:0,z:6275e3},K={x:655e3,y:0,z:643e4},Q={x:664e3,y:-43.7,z:685e4},J={},$=0,ee=null,te=!0,re=null;_events={MOVE:function(){te=!0,x.visible&&!V&&ie.launchLaserAroundCurrentTime(10,11)},CHANGEPIVOT:function(){ie.initiated&&ie.emptyBuffer()}},window.requestAnimFrame2=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var ie={initiated:!1,laserCloudMaster:new i.Object3D,nbPointsLoaded:0,indiceLaserFileLoaded:0,indicePacketInBuffer:0,tabLaserFilesToLoad:[],nbSecondsToLoad:0,nbPointsInBB:0,lengthAPoint:0,ptA2:null,ptB2:null,ptC2:null,ptD2:null,point2:null,lengthAB:0,lengthAC:0,lengthAPoint:0,nbPointsInBB:0,animateOn:!1,btnSwitchPoint:!1,btnSwitchLine:!1,btnSwitchVolume:!1,computeNormalOn:!1,annotationOn:!1,init:function(r,o){ee=r,M=o.urlPointCloud||f.dataURL.defaultUrlPointCloud,S=M.indexOf("www")<0,T=new i.WebGLRenderTarget(t.getWinWith(),t.getWinHeight()),this.initiated=!0,this.initializeBufferGeometry(),s.register("MOVE",ie),s.register("CHANGEPIVOT",ie),re=t.getRenderer().getContext(),e(window).resize(function(){T.width=window.innerWidth,T.height=window.innerHeight})},initializeBufferGeometry:function(){for(var e=0;j>e;++e)G[e]=0;this.createShader(),F=0,D=new i.BufferGeometry,D.dynamic=!0,D.attributes={position:{itemSize:3,array:new Float32Array(3*P),numItems:3*P,dynamic:!0},color:{itemSize:3,array:new Float32Array(3*P),numItems:3*P,dynamic:!0},displacement:{itemSize:3,array:new Float32Array(3*P),numItems:3*P,dynamic:!0},uniqueid:{itemSize:1,array:new Float32Array(P),dynamic:!0},classe:{itemSize:1,array:new Float32Array(P),dynamic:!0}},b=new i.Geometry,b.vertices=new Array(P),b.dynamic=!0,this.initializeBufferValues(),x=new i.ParticleSystem(D,y),b.colors=_;var t=new i.ParticleBasicMaterial({size:.1,vertexColors:!0,depthTest:!1});w=new i.ParticleSystem(b,t),m=new i.Scene,m.add(w),this.laserCloudMaster.add(x)},createShader:function(){v={displacement:{type:"v3",value:[]},color:{type:"v3",value:[]},uniqueid:{type:"f",value:[]}},g={indice_time_laser:{type:"f",value:C},currentidwork:{type:"f",value:1e3},point_size:{type:"f",value:1},alpha:{type:"f",value:.6},indice_time_laser_tab:{type:"fv1",value:G},movementLocked:{type:"i",value:k},texturePoint:{type:"t",value:null}},y=new i.ShaderMaterial({uniforms:g,attributes:v,vertexShader:o.shaderLaserVS.join("\n"),fragmentShader:o.shaderLaserFS.join("\n"),vertexColors:i.VertexColors,depthTest:!1,transparent:!0})},initializeBufferValues:function(){var e=D.attributes.color.array,t=D.attributes.position.array,r=D.attributes.displacement.array,o=D.attributes.uniqueid.array,a=D.attributes.classe.array,s=new i.Color;s.setHSL(.2,.5,.7);var l=10;for(n=0;n<P;++n)t[3*n+0]=15e3,t[3*n+1]=15e3,t[3*n+2]=15e3,r[3*n+0]=(2*Math.random()-1)*l,A?r[3*n+1]=Math.random()*l*10:r[3*n+1]=(2*Math.random()-1)*l,r[3*n+2]=(2*Math.random()-1)*l,e[3*n+0]=s.r,e[3*n+1]=s.g,e[3*n+2]=s.b,o[n+0]=this.indiceLaserFileLoaded,a[n+0]=0,_[n]=0,b.vertices[n]=new i.Vector3(0,0,0)},addPointsToBufferGeneric:function(e,t,r,o){var n;switch(r){case 64:n=new Float64Array(e);break;case 32:n=new Float32Array(e);break;case 16:n=new Int16Array(e)}var a,s,l,c,h,u=D.attributes.position.array,p=D.attributes.color.array,d=D.attributes.uniqueid.array,f=new i.Color;F+8*n.length/r>P&&(F=0,this.indicePacketInBuffer=0);for(var m=n.length/t,v=0;v<n.length-t;v+=t){a=n[v]-o.x,s=n[v+1]-o.y,l=n[v+2]-o.z,c=4==t?(n[v+3]+25)/25:6==t?n[v+4]/20:.6+s/80,h=3*F,u[h+0]=a,u[h+1]=s,u[h+2]=l,f.setHSL(c,.5,.8),p[h+0]=f.r,p[h+1]=f.g,p[h+2]=f.b,d[F]=this.indicePacketInBuffer;for(var y=F.toString(16),x=6-y.length,w=0;x>w;++w)y="0"+y;var M="#"+y;_[F]=new i.Color(M),b.vertices[F]=new i.Vector3(a,s,l),F++}g.currentidwork.value=this.indiceLaserFileLoaded,G[this.indicePacketInBuffer]=.15,this.setLockMovement(0),this.updateLaserAttributesSmartly(m),C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indicePacketInBuffer++,this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length?this.readLaserPointsFileFromItownsGeneric(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],r,o):setTimeout(function(){ie.setLockMovement(1)},800)},addPointsToBufferGenericMesh:function(e,t,r,o){var n;switch(r){case 64:n=new Float64Array(e);break;case 32:n=new Float32Array(e);break;case 16:n=new Int16Array(e)}var a,s,l,c,h,u=D.attributes.position.array,p=D.attributes.color.array,d=D.attributes.uniqueid.array,f=new i.Color;0==E&&(E=F),F+8*n.length/r>P&&(F=0,this.indicePacketInBuffer=0);for(var m=n.length/t,v=0;v<n.length-t;v+=t){a=n[v]-o.x,s=n[v+1]-o.y,l=n[v+2]-o.z,c=t>3?(n[v+3]+25)/35:.6+s/80,h=3*F,u[h+0]=a,u[h+1]=s,u[h+2]=l,f.setHSL(c,.5,.8),p[h+0]=f.r,p[h+1]=f.g,p[h+2]=f.b,d[F]=this.indicePacketInBuffer;for(var y=F.toString(16),x=6-y.length,w=0;x>w;++w)y="0"+y;var M="#"+y;_[F]=new i.Color(M),b.vertices[F]=new i.Vector3(a,s,l),F++}g.currentidwork.value=this.indiceLaserFileLoaded,G[this.indicePacketInBuffer]=.15,this.updateLaserAttributesSmartly(m),C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indicePacketInBuffer++,this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length&&this.readLaserPointsFileFromItownsGenericMesh(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],r,o)},triangulateLaserCloudSAVE:function(e){console.log("triangulateLaserCloud ",E,F);for(var r=360,o=3*E,n=o+3*e,a=D.attributes.position.array.subarray(o,n),s=new i.Geometry,l=0;3*e>l;l+=3){var h=new i.Vector3(a[l],a[l+1],a[l+2]);0==l&&c.drawSphereAt(h,.1),s.vertices.push(h)}for(var u=0;u<s.vertices.length-r-1;++u)u%360!=0&&(s.faces.push(new i.Face3(u,u+1,u+r)),s.faces.push(new i.Face3(u+1,u+1+r,u+r)));s.computeFaceNormals();var p=new i.MeshBasicMaterial({color:14477818,wireframe:!0,wireframeLinewidth:1,transparent:!0,opacity:.3});p.side=i.DoubleSide;var d=new i.Mesh(s,p);t.addToScene(d)},triangulateLaserCloud:function(e){var t=.8;console.log("triangulateLaserCloud ",E,F);for(var r=360,o=3*E,n=o+3*e,a=D.attributes.position.array.subarray(o,n),s=new i.Geometry,l=(new i.Vector3(a[0],a[1],a[2]),new Array(e)),c=0;e>c;++c)l[c]=new i.Vector3(a[3*c],a[3*c+1],a[3*c+2]);for(var h=l.slice(0),c=r+1;c<l.length-(r+1);++c)h[c].y>-2&&h[c].y<11&&(h[c]=this.filterLidarMeshUsingRoofLine(l,c,r,t));for(var c=0;e>c;c++)s.vertices.push(h[c]);for(var u=4.5,p=0;p<s.vertices.length-r-1;++p)if(p%360!=0){var d=s.vertices[p],f=s.vertices[p+1],m=s.vertices[p+r],v=s.vertices[p+1+r];d.distanceTo(f)<u&&d.distanceTo(m)<u&&s.faces.push(new i.Face3(p,p+1,p+r)),f.distanceTo(m)<u&&f.distanceTo(v)<u&&s.faces.push(new i.Face3(p+1,p+1+r,p+r))}s.computeFaceNormals();var g=new i.MeshBasicMaterial({color:14477818,wireframe:!0,wireframeLinewidth:1,transparent:!0,opacity:.3});g.side=i.DoubleSide;new i.Mesh(s,g);this.textureMeshLidar(s)},filterLidarMeshUsingRoofLine:function(e,t,r,o){for(var n=t,a=(e[n].y,e[n].y,-20),s=-1,l=-1,c=0;r>c;++c)e[t+c].y>=a&&(a=e[t+c].y,s=t+c);for(var h=new i.Vector2(e[s].x,e[s].z),u=!1,p=0,d=5;!u;){var f=new i.Vector2(e[s+p].x,e[s+p].z),m=new i.Vector2(e[s-p].x,e[s-p].z),v=h.distanceTo(f),g=h.distanceTo(m);(v>d||g>d)&&(u=!0,l=v>g?s+p:s-p),p++}var y,x,w=new i.Vector3(e[t].x,e[s].y,e[t].z),b=new i.Vector3(e[t].x,e[l].y,e[t].z),_=w.distanceTo(e[s]),M=b.distanceTo(e[l]),S=Math.max(_,M);S==_?(y=l,x=s):(y=s,x=l);var T=e[y],C=e[x],L=(16777215*Math.random(),new i.Vector2(T.x,T.z)),A=new i.Vector2(C.x,C.z),P=Math.atan2(A.y-L.y,A.x-L.x),D=-.5,F=D*Math.cos(P),E=D*Math.sin(P),V=new i.Vector3(T.x+F,T.y,T.z+E),R=-1;F=R*Math.cos(P),E=R*Math.sin(P);var z=new i.Vector3(T.x+F,T.y,T.z+E),I=new i.Vector3(e[t].x,T.y,e[t].z),U=I.distanceTo(V),O=e[t];if(U>o){for(var B=0,N=1e3,k=0;10>k;++k){var n=t+r*k;n<e.length&&(B+=e[n].y,e[n].y<N&&(N=e[n].y))}N=1e3==N?e[t].y:N,O=new i.Vector3(z.x,N,z.z)}return O},filterLidarMeshComputingFacadePlan:function(e,t,r,o){for(var n=12,a=t,s=e[t].y-e[t+1].y<0,l=e[a].y>2;!l&&a<e.length;)s?a-=2:a+=2,l=e[a].y>2;for(var c=[],h=[],u=0;n>u;++u)c.push(e[a+u].x),h.push(e[a+u].z);c.sort(function(e,t){return e-t}),h.sort(function(e,t){return e-t});var p=Math.floor((c.length+1)/2),d=new i.Vector3(c[p],e[t].y,h[p]),f=e[t];if(d.distanceTo(e[t])>o){for(var m=[],v=0;n>v;++v){var a=t+v*r;a<e.length&&m.push(e[a].y)}m.sort(function(e,t){return e-t});var g=Math.floor((m.length+1)/2);f=new i.Vector3(d.x,m[g],d.z)}return f},filterLidarMeshUsingRGE:function(){},analyzeNeighbourood:function(e,t,r,i,o){var n=e[r],a=(e[r+1],e[r-1]),s=(e[r+i],e[r-i]),l=0,c="";if(n.y<12){var h=n.distanceTo(a),u=n.distanceTo(s);h>u?(l=h,c="vDown"):(l=u,c="vLeft"),l>o&&("vDown"==c?t[r]=a:t[r]=s)}},textureMeshLidar:function(e){var r=u.getShaderMat(),o=new i.Mesh(e,r);t.addToScene(o)},updateLaserAttributes:function(){D.attributes.position.needsUpdate=!0,D.attributes.color.needsUpdate=!0,D.attributes.uniqueid.needsUpdate=!0,b.verticesNeedUpdate=!0,b.colorsNeedUpdate=!0},updateLaserAttributesSmartly:function(e){var t=12*(F-(e-1)),r=3*(F-(e-1)),i=3*e,o=r+i,n=D.attributes.position.array.subarray(r,o);re.bindBuffer(re.ARRAY_BUFFER,D.attributes.position.buffer),re.bufferSubData(re.ARRAY_BUFFER,t,n),n=D.attributes.color.array.subarray(r,o),re.bindBuffer(re.ARRAY_BUFFER,D.attributes.color.buffer),re.bufferSubData(re.ARRAY_BUFFER,t,n),n=D.attributes.uniqueid.array.subarray(r/3,o/3),re.bindBuffer(re.ARRAY_BUFFER,D.attributes.uniqueid.buffer),re.bufferSubData(re.ARRAY_BUFFER,t/3,n),b.verticesNeedUpdate=!0,b.colorsNeedUpdate=!0},animatePoints2:function(){if(1!=k)for(var e=0;j>e;++e)G[e]>0&&(G[e]-=G[e]*L,G[e]<.001&&(G[e]=0));requestAnimFrame2(ie.animatePoints2)},setLockMovement:function(e){k=e,g.movementLocked.value=k},getLockedMovement:function(){return k},addPointsToBufferIGN:function(e,t,r,o){var n;switch(r){case 64:n=new Float64Array(e);break;case 32:n=new Float32Array(e);break;case 16:n=new Int16Array(e)}var a=D.attributes.position.array,s=D.attributes.color.array,l=D.attributes.uniqueid.array,c=new i.Color;F>P&&(F=0,this.indicePacketInBuffer=0);for(var h=0;h<n.length-t;h+=t){var u=n[h]-o.x,p=n[h+1]-o.z,d=n[h+2]-o.y,f=.5;t>3&&(f=n[h+3]),a[3*F+0]=u,a[3*F+1]=d,a[3*F+2]=p,c.setHSL(f,.5,.8),s[3*F+0]=c.r,s[3*F+1]=c.g,s[3*F+2]=c.b,l[F]=this.indicePacketInBuffer;for(var m=F.toString(16),v=6-m.length,y=0;v>y;++y)m="0"+m;var x="#"+m;_[F]=new i.Color(x);var w=new i.Vector3(u,d,p);b.vertices[F]=w,F++}g.currentidwork.value=this.indiceLaserFileLoaded,G[this.indicePacketInBuffer]=.3,this.updateLaserAttributes(),b.verticesNeedUpdate=!0,b.colorsNeedUpdate=!0,C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indicePacketInBuffer++,this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length&&this.readLaserPointsFileFromItownsBINARY(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],r,o)},readLaserFileLocalPlySAVE:function(e,o,n,a){R=new DataView(e),F>0&&(this.initializeBufferValues(),I=0),F+3e6>P&&(F=0,this.indicePacketInBuffer=0);for(var s=0,l=!0,c=!1,h=0;!c&&8e3>h;)c=100==R.getInt8(h,l)&&101==R.getInt8(h+1,l)&&114==R.getInt8(h+2,l),h++;if(h>=8e3)return void alert("fichier incorrect");console.log("hearder end found at ",h);var s=h+3;28==o&&(s=h+4),N=s;var u=!1,p=86;u||(p=54);for(var d,f,m,v,y,x=(e.byteLength-s)/p*1,w=D.attributes.position.array,M=D.attributes.color.array,S=D.attributes.uniqueid.array,T=D.attributes.classe.array,C=new i.Color,L=0,A=0,E=s;x*p>E;E+=p){d=R.getFloat32(E+8,l)-a.x,m=R.getFloat32(E+12,l)-a.z,f=R.getFloat32(E+16,l)-a.y,v=(R.getFloat32(E+32,l)+25)/35,u?C.setHSL(v,.5,.8):(L=R.getUint32(E+44,l),A=R.getUint32(E+48,l),5e3>E&&console.log("label",L),L>I&&(I=L),L>0?(C.setHSL(L/60,1,.5),15e3>E&&console.log("label",L)):C.setHSL(v,.5,.8)),y=3*F,w[y+0]=d,w[y+1]=f,w[y+2]=m,M[y+0]=C.r,M[y+1]=C.g,M[y+2]=C.b,S[F]=L,T[F]=A;for(var z=F.toString(16),U=6-z.length,h=0;U>h;++h)z="0"+z;var O="#"+z;_[F]=new i.Color(O),b.vertices[F]=new i.Vector3(d,f,m),F++}g.currentidwork.value=this.indiceLaserFileLoaded,G[this.indicePacketInBuffer]=.15,this.updateLaserAttributes(),V=!0;var B=new i.Vector3(w[6e5],w[600001],w[600002]),k={intersectionToLook:B,surfaceType:"Rectangle"};r(11).goToClosestPosition(B.add(t.getZeroAsVec3D()),k),this.indiceLaserFileLoaded++,this.indicePacketInBuffer++,this.setMessageDisplay("",!1),console.log("nb ids: '(label",I)},readLaserFileLocalPly:function(e,t,r,o){R=new DataView(e),F>0&&(this.initializeBufferValues(),I=0),F+3e6>P&&(F=0,this.indicePacketInBuffer=0);for(var n=0,a=!0,s=!1,l=0;!s&&8e3>l;)s=100==R.getInt8(l,a)&&101==R.getInt8(l+1,a)&&114==R.getInt8(l+2,a),l++;if(l>=8e3)return void alert("fichier incorrect");console.log("hearder end found at ",l);var n=l+3;28==t&&(n=l+4),N=n;var c=856==N||922==N,h=86;if(c||(h=94),28==t){var h=82;console.log("PARIS2014")}for(var u,p,d,f,m,v=(e.byteLength-n)/h*1,y=D.attributes.position.array,x=D.attributes.color.array,w=D.attributes.uniqueid.array,M=D.attributes.classe.array,S=new i.Color,T=0,C=0,L=n;v*h>L;L+=h){u=R.getFloat32(L+32,a)-o.x,d=R.getFloat32(L+36,a)-o.z,p=R.getFloat32(L+40,a)-o.y,f=(R.getFloat32(L+70,a)+25)/35,c?S.setHSL(f,.5,.8):(T=R.getFloat32(L+86,!0),C=R.getFloat32(L+90,!0),T>I&&(I=T),0!=C?(f=0,S.setHSL(f,1,.5)):S.setHSL(f,.5,.8)),m=3*F,y[m+0]=u,y[m+1]=p,y[m+2]=d,x[m+0]=S.r,x[m+1]=S.g,x[m+2]=S.b,w[F]=T,M[F]=C;for(var A=F.toString(16),E=6-A.length,l=0;E>l;++l)A="0"+A;var z="#"+A;_[F]=new i.Color(z),b.vertices[F]=new i.Vector3(u,p,d),F++}g.currentidwork.value=this.indiceLaserFileLoaded,G[this.indicePacketInBuffer]=.15,this.updateLaserAttributes(),V=!0;new i.Vector3(y[6e5],y[600001],y[600002]);this.indiceLaserFileLoaded++,this.indicePacketInBuffer++,this.setMessageDisplay("",!1)},readLaserFileXYZAscii:function(e,t,r,o){F>P&&(F=0);var n=D.attributes.position.array,a=D.attributes.color.array,s=D.attributes.uniqueid.array,l=new i.Color;l.setHSL(.4+Math.random(),.5,.8);for(var c,h,u,p,d=e.match(/^.*((\r\n|\n|\r)|$)/gm),f=0;f<d.length;++f){p=d[f].split(" "),c=parseFloat(p[0]-o.x),u=parseFloat(p[1]-o.z),h=parseFloat(p[4]-o.y),n[3*F+0]=c,n[3*F+1]=h,n[3*F+2]=u,a[3*F+0]=l.r,a[3*F+1]=l.g,a[3*F+2]=l.b,s[F]=this.indiceLaserFileLoaded;for(var m=F.toString(16),v=6-m.length,y=0;v>y;++y)m="0"+m;var x="#"+m;_[F]=new i.Color(x);var w=new i.Vector3(c,h,u);b.vertices[F]=w,F++}g.currentidwork.value=this.indiceLaserFileLoaded,this.updateLaserAttributes(),b.verticesNeedUpdate=!0,b.colorsNeedUpdate=!0,C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length&&this.readLaserPointsFileFromItownsBINARY(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded])},readLaserFileLidarFormat:function(e,t,r,o){F>P&&(F=0);var n=D.attributes.position.array,a=D.attributes.color.array,s=D.attributes.uniqueid.array,l=new i.Color;l.setHSL(.4+Math.random(),.5,.8);for(var c,h,u,p,d=e.match(/^.*((\r\n|\n|\r)|$)/gm),f=0;f<d.length;++f){p=d[f].split(" "),c=parseFloat(p[0])/1e3+655e3-o.x,u=parseFloat(p[1])/1e3+686e4-o.z,h=parseFloat(p[2])/1e3-o.y,3>f&&console.log(c,h,u),n[3*F+0]=c,n[3*F+1]=h,n[3*F+2]=u,a[3*F+0]=l.r,a[3*F+1]=l.g,a[3*F+2]=l.b,s[F]=this.indiceLaserFileLoaded;for(var m=F.toString(16),v=6-m.length,y=0;v>y;++y)m="0"+m;var x="#"+m;_[F]=new i.Color(x);var w=new i.Vector3(c,h,u);b.vertices[F]=w,F++}g.currentidwork.value=this.indiceLaserFileLoaded,this.updateLaserAttributes(),b.verticesNeedUpdate=!0,b.colorsNeedUpdate=!0,C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length&&this.readLaserPointsFileFromItownsBINARY(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded])},readLaserFileASCII:function(e,t,r,i){},addPointsToBufferGenericWithConversion:function(e,t,r,o,n,a){var s;switch(r){case 64:s=new Float64Array(e);break;case 32:s=new Float32Array(e);break;case 16:s=new Int16Array(e)}var c,h=D.attributes.position.array,u=D.attributes.color.array,p=D.attributes.uniqueid.array,d=new i.Color;F>P&&(F=0);for(var f=0;f<s.length-t;f+=t){var m=l.convertCoord({x:s[f],y:s[f+2]},n,a),v=m.x-o.x,y=s[f+1]-o.y,x=m.y-o.z;c=t>3?s[f+3]/255:.6+Math.abs(y/80),h[3*F+0]=v,h[3*F+1]=y,h[3*F+2]=x,d.setHSL(c,.5,.8),u[3*F+0]=d.r,u[3*F+1]=d.g,u[3*F+2]=d.b,p[F]=this.indiceLaserFileLoaded;for(var w=F.toString(16),M=6-w.length,S=0;M>S;++S)w="0"+w;var T="#"+w;_[F]=new i.Color(T);var L=new i.Vector3(v,y,x);b.vertices[F]=L,F++}g.currentidwork.value=this.indiceLaserFileLoaded,this.updateLaserAttributes(),b.verticesNeedUpdate=!0,b.colorsNeedUpdate=!0,C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length&&this.readLaserPointsFileFromItownsBINARY(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded])},readLaserPointsFileFromItownsBINARY:function(e){var t=this,r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status){var e=r.response;t.addPointsToBufferIGN(e,4,64,ee)}else console.log("Error",r.statusText),t.indiceLaserFileLoaded++,t.readLaserPointsFileFromItownsBINARY(t.tabLaserFilesToLoad[t.indiceLaserFileLoaded],nbBitsPerAttribute,pivot)},r.open("GET",M+e,!0),r.responseType="arraybuffer",r.send(null)},readLaserPointsFileFromItownsGeneric:function(e,r,i){var o=this,n=new XMLHttpRequest,a=t.getZero();n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var e=n.response;o.addPointsToBufferGeneric(e,4,r,i)}else o.indiceLaserFileLoaded++,o.indiceLaserFileLoaded<o.tabLaserFilesToLoad.length&&o.readLaserPointsFileFromItownsGeneric(o.tabLaserFilesToLoad[o.indiceLaserFileLoaded],32,{x:a.x-J.x,y:a.y-J.y,z:a.z-J.z})};var s=S?M+e.substring(e.indexOf("/")+1):M+e;n.open("GET",s,!0),n.responseType="arraybuffer",n.send(null)},readLaserPointsFileFromItownsGenericMesh:function(e,r,i){var o=this,n=new XMLHttpRequest,a=t.getZero();n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var e=n.response;o.addPointsToBufferGenericMesh(e,4,r,i)}else o.indiceLaserFileLoaded++,o.indiceLaserFileLoaded<o.tabLaserFilesToLoad.length&&o.readLaserPointsFileFromItownsGenericMesh(o.tabLaserFilesToLoad[o.indiceLaserFileLoaded],32,{x:a.x-J.x,y:a.y-J.y,z:a.z-J.z})},n.open("GET",M+e,!0),n.responseType="arraybuffer",n.send(null)},readLaserFileLocalBINARY:function(e,t,r,i){this.addPointsToBufferGeneric(e,t,r,i)},readLaserFileLocalBINARYWithConversion:function(e,t,r,i,o,n){this.addPointsToBufferGenericWithConversion(e,t,r,i,o,n)},emptyBuffer:function(){console.log("emptyBuffer"),this.initializeBufferValues(),this.updateLaserAttributes()},launchLaserAroundCurrentTime:function(e,t){te=!1;var r=a.getPanoHours(),i=a.getPanoSecondsInHour(),o=a.getPanoDate(),n=a.getPanoName(),s=a.getDecalageUTC();if(console.log("laser",n,o,t,r,i,e),"Paris_12"==n.substr(0,8))this.launchLoadingFromSecondsIT(o,t,r,i-s,e);else{var l=n.substr(0,5);"TerMo"==l?J=X:"Nante"==l?J=W:"Halag"==l?J=H:"CASQY"==l?J=Y:"Toulo"==l?J=Z:"Auril"==l?J=K:"Champ"==l?J=Q:("Paris-1405"==n.substr(0,10)||"Basti"==l||"Calib"==l||"Paris-1404"==n.substr(0,10)||"Paris-1406"==n.substr(0,10))&&(J=q);var o=n.substr(n.indexOf("-")+1,6);this.launchLaserNewRieglLOD(o,r,i-s,e/6)}},launchLoadingFromSecondsIT:function(r,i,o,n,a){var s=t.getZero();i=10;for(var l=parseInt(n),c=parseInt(l-a/2);c<parseInt(l+a/2);++c){var h="laser3/"+r+"/"+o+"/"+i+"_"+c+".bin";-1===e.inArray(h,this.tabLaserFilesToLoad)&&this.tabLaserFilesToLoad.push(h)}this.readLaserPointsFileFromItownsBINARY(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],64,s)},launchLaserNewRiegl:function(r,i,o,n){for(var a=3,s=t.getZero(),l=3600*i+o+a,c=10*parseInt(l-n/2);c<10*parseInt(l+n/2);++c){var h="laserNewRiegl/"+r+"/"+c+".bin";-1===e.inArray(h,this.tabLaserFilesToLoad)&&this.tabLaserFilesToLoad.push(h)}this.readLaserPointsFileFromItownsGeneric(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],32,{x:s.x-J.x,y:s.y-J.y,z:s.z-J.z})},launchLaserNewRieglLOD:function(r,i,o,n){var a=t.getZero(),s=3600*i+o,l="",c="";this.tabLaserFilesToLoad=[],this.indiceLaserFileLoaded=0;for(var h=0;1*n>h;h+=.1){var u=10*(s-h),p=10*(s+h);l="laserNewRiegl/"+r+"/LR/"+u+".bin",c="laserNewRiegl/"+r+"/LR/"+p+".bin";var d=e.inArray(l,this.tabLaserFilesToLoad),f=e.inArray(c,this.tabLaserFilesToLoad);(-1===d||this.tabLaserFilesToLoad.length-d>20)&&this.tabLaserFilesToLoad.push(l),h>0&&(-1===f||this.tabLaserFilesToLoad.length-f>20)&&this.tabLaserFilesToLoad.push(c)}for(var h=0;1*n>h;h+=.1){var u=10*(s-h),p=10*(s+h);l="laserNewRiegl/"+r+"/HR/"+u+".bin",c="laserNewRiegl/"+r+"/HR/"+p+".bin";var d=e.inArray(l,this.tabLaserFilesToLoad),f=e.inArray(c,this.tabLaserFilesToLoad);(-1===d||this.tabLaserFilesToLoad.length-d>20)&&this.tabLaserFilesToLoad.push(l),h>0&&(-1===f||this.tabLaserFilesToLoad.length-f>20)&&this.tabLaserFilesToLoad.push(c)}this.indiceLaserFileLoaded<this.tabLaserFilesToLoad.length&&this.readLaserPointsFileFromItownsGeneric(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],32,{x:a.x-J.x,y:a.y-J.y,z:a.z-J.z})},testLaserAngular:function(){console.log("test Angular");for(var r=130,i="131010",o=t.getZero(),n=46087,a="",s="",l=0;2*r>l;l+=.1){var c=10*(n-l),h=10*(n+l);a="laserNewRiegl/"+i+"/LRAngular/"+c+".bin",s="laserNewRiegl/"+i+"/LRAngular/"+h+".bin";var u=e.inArray(a,this.tabLaserFilesToLoad);e.inArray(s,this.tabLaserFilesToLoad);
(-1===u||this.tabLaserFilesToLoad.length-u>200)&&this.tabLaserFilesToLoad.push(a)}this.readLaserPointsFileFromItownsGenericMesh(this.tabLaserFilesToLoad[this.indiceLaserFileLoaded],32,{x:o.x-J.x,y:o.y-J.y,z:o.z-J.z})},loadLasFile:function(e,r){var i=this,o=new XMLHttpRequest;t.getZero();o.onreadystatechange=function(){if(4===o.readyState&&200===o.status){var e=o.response;i.addLasPointsToBuffer(e,r)}},o.open("GET","http://www.itowns.fr/nokiaHere/lidar/"+e,!0),o.responseType="arraybuffer",o.send(null)},addLasPointsToBuffer:function(e,t){var r=new d.LasReader(e);console.log("lasOBJ: ",r);for(var o,n=D.attributes.position.array,a=D.attributes.color.array,s=D.attributes.uniqueid.array,l=new i.Color,c=new i.Geometry,h=r,u=new OpenLayers.Projection("EPSG:2154"),p=new OpenLayers.Projection("EPSG:4326"),f=0;f<h.header.numberOfPointRecords;f++){var m=h.getPointData(f),v=new i.Vector3(h.header.YScaleFactor*m.Y*1+h.header.YOffset,h.header.ZScaleFactor*m.Z*1+h.header.ZOffset,h.header.XScaleFactor*m.X*1+h.header.XOffset),y=new OpenLayers.Geometry.Point(v.z,v.x);y=y.transform(p,u),y.x-=t.x,y.y-=t.z,v.y-=t.y+.6,10>f&&console.log(v.x,v.z,v.y,y),o=3*F,n[o+0]=y.x,n[o+1]=v.y,n[o+2]=y.y,l.setHSL(.5,.5,.8),a[o+0]=l.r,a[o+1]=l.g,a[o+2]=l.b,s[F]=this.indicePacketInBuffer;for(var x=F.toString(16),w=6-x.length,M=0;w>M;++M)x="0"+x;var S="#"+x;_[F]=new i.Color(S),b.vertices[F]=new i.Vector3(y.x,v.y,y.y),F++,c.vertices.push(v)}g.currentidwork.value=this.indiceLaserFileLoaded,G[this.indicePacketInBuffer]=.15,this.setLockMovement(0),console.log("nb points LAS: ",h.header.numberOfPointRecords),this.updateLaserAttributes(),C=.5,this.animateOn||(this.animateOn=!0,this.animatePoints2()),this.indiceLaserFileLoaded++,this.indicePacketInBuffer++,c.las=h},processEvent:function(e){_events[e]&&_events[e]()},setReverseMotion:function(e){C=.5},setPointSize:function(e){this.initiated&&(x.material.uniforms.point_size.value=e)},changeVisibility:function(){this.initiated&&(x.visible=!x.visible)},setVisibility:function(e){this.initiated&&(x.visible=e)},changeAlpha:function(e){this.initiated&&(x.material.uniforms.alpha.value=e)},getXYZFromClick2D:function(e,r,o){var o=(t.getZero(),o||170),n=new Uint8Array(o*o*4);t.renderToTexture(m,t.getCamera(),T,!0);var a=t.getContext();a.readPixels(e-o/2,t.getWinHeight()-r-o/2,o,o,a.RGBA,a.UNSIGNED_BYTE,n);for(var s=1e3,l=new i.Color,c=new i.Vector3(-1,-1,-1),h=[],u=[],d=0,f=0;f<n.length-4;f+=4){var v=f/4%o,g=f/4/o,y=n[f],x=n[f+1],w=n[f+2];if(0!=y||0!=x||0!=w){h.push(new i.Vector2(v,g));var l=new i.Color;l.setRGB(y/255,x/255,w/255),c=this.findXYZFromColorID(l.getHex()),u.push(c);var b=Math.sqrt((v-o/2)*(v-o/2)+(g-o/2)*(g-o/2));s>b&&(s=b,d=h.length-1)}}var _=this.getBestRepresentingNormalFrom(u,d)||new i.Vector3;if(!this.planeLocal){var M=new i.PlaneGeometry(2,2,1);this.planeLocal=new i.Mesh(M,new i.MeshBasicMaterial({side:i.DoubleSide,color:16711935,transparent:!0,opacity:.3})),t.addToScene(this.planeLocal),this.planeLocal.visible=!1}this.planeLocal.position=u[d];var S=_.clone(),C=new i.Vector3(0,0,1),L=(new i.Vector3).crossVectors(C,S);(1===S.y||-1===S.y)&&(L=new i.Vector3(1,0,0));var A=Math.acos(S.dot(C)),P=new i.Matrix4;P=p.rotateByAxis(P,L,A),this.planeLocal.rotation.setFromRotationMatrix(P),t.renderOnce();var D=t.getIntersected(e,r,[this.planeLocal]);if(D[0]){var F=D[0].point;c=F}return c},getBestRepresentingNormalFrom:function(e,t){for(var r,i,o=null,r=void 0!=t?e[t]:e[0],n=0;!o&&n<e.length;){var a=e[n];i?Math.abs(a.z-i.z)>=.04&&(o=a):Math.abs(a.x-r.x)>=.04&&(i=a),n++}return o?this.computeNormalFrom3Points(r,i,o,!1):void 0},getBest3DposFromArray:function(e,t,r){for(var i=0;i<r.length;++i);},getMaxVerticalAccumulationPoint:function(e,t){var r=this.getNeighboursXYZFromClick2D(e,t,40),i=this.analyzeShapeFromNeighbours(r);return i},getNeighboursXYZFromClick2D:function(e,r,o){var n=[],o=(t.getZero(),o||40),a=new Uint8Array(o*o*4);t.renderToTexture(m,t.getCamera(),T,!0);var s=t.getContext();s.readPixels(e-o/2,t.getWinHeight()-r-o/2,o,o,s.RGBA,s.UNSIGNED_BYTE,a);for(var l=0;l<a.length-4;l+=4){var c=a[l],h=a[l+1],u=a[l+2];if(0!=c||0!=h||0!=u){var p=new i.Color;p.setRGB(c/255,h/255,u/255);var d=this.findXYZFromColorID(p.getHex());n.push(d)}}return n},analyzeShapeFromNeighbours:function(e){var t=e.length,r=[];r.length=t;for(var i=0,o=-1,n=.08,a=0;a<e.length;++a)for(var s=e[a],l=0;l<e.length;++l){var c=Math.sqrt((s.x-e[l].x)*(s.x-e[l].x)+(s.z-e[l].z)*(s.z-e[l].z));n>c&&(void 0==r[a]?r[a]=0:r[a]++,r[a]>i&&(i=r[a],o=a))}return{pos:e[o],note:i}},extractPointsFromPCA:function(e,t){var r=[],o=2;r.push(e.m),c.drawSphereAt(new i.Vector3(r[r.length-1][0],r[r.length-1][1],r[r.length-1][2]),.03);for(var n=1;n<t.num;n++){if(r.length===t.num)return r;var a=[0,0,0];a[0]=n*o*Math.sqrt(e.pca.S[0]),a[2]=n*o*Math.sqrt(e.pca.S[2]);var s=h.dotMV(e.pca.U,a);if(r.push(h.addVec(e.m,s)),c.drawSphereAt(new i.Vector3(r[r.length-1][0],r[r.length-1][1],r[r.length-1][2]),.03),t.bidirectional){if(r.length===t.num)return r;r.push(h.subVec(e.m,s)),c.drawSphereAt(new i.Vector3(r[r.length-1][0],r[r.length-1][1],r[r.length-1][2]),.03)}}},computeNormalPointCloud:function(e,t){for(var r=[],i=0,o=0,n=0,a=0;a<t.length;a++)r.push([e[t[a]].x,e[t[a]].y,e[t[a]].z]),i+=e[t[a]].x,o+=e[t[a]].y,n+=e[t[a]].z;var s=[i/t.length,o/t.length,n/t.length],l=h.pca(r,s);return{pca:l,m:s}},fitLineToNeighboursPointFromClick:function(e,r){var o=[],n=[],a=40,s=120,l=new Uint8Array(a*s*4);t.renderToTexture(m,t.getCamera(),T,!0);var u=t.getContext();u.readPixels(e-s/2,t.getWinHeight()-r-a/2,s,a,u.RGBA,u.UNSIGNED_BYTE,l);for(var p=0,d=0,f=0,v=0;v<l.length-4;v+=4){var g=l[v],y=l[v+1],x=l[v+2];if(!(0===g&&0===y&&0===x||g===p&&y===d&&x===f)){var w=new i.Color;w.setRGB(g/255,y/255,x/255);var b=this.findXYZFromColorID(w.getHex());n.push(b),o.push(new h.Point2D(b.x,b.z))}p=g,d=y,f=x}var _=h.RobustLineFitting(o,.03),M=this.computeNormalPointCloud(n,_.inliers),S={num:4,bidirectional:!1};this.extractPointsFromPCA(M,S),this.IsComputeNormalOn()&&(c.drawArrPoints(n),c.drawInliersPoints(n,_.inliers))},getNeighboursReflectanceFromClick2D:function(e,r){var o=[],n=[],a=(t.getZero(),40),s=new Uint8Array(a*a*4);t.renderToTexture(m,t.getCamera(),T,!0);var l=t.getContext();l.readPixels(e-a/2,t.getWinHeight()-r-a/2,a,a,l.RGBA,l.UNSIGNED_BYTE,s);for(var c=0;c<s.length-4;c+=4){var h=s[c],u=s[c+1],p=s[c+2];if(0!=h||0!=u||0!=p){var d=new i.Color;d.setRGB(h/255,u/255,p/255);var f=this.findXYZFromColorID(d.getHex());o.push(f);var v=this.findReflectanceFromColorID(d.getHex());n.push(v)}}var g=this.analyzeShapeFromNeighbours(o);return g},getZebraFromClick2D:function(e,r){var o=(t.getZero(),new Uint8Array(4));t.renderToTexture(m,t.getCamera(),T,!0);var n=t.getContext();n.readPixels(e,t.getWinHeight()-r,1,1,n.RGBA,n.UNSIGNED_BYTE,o);var a=o[0],s=o[1],l=o[2],c=new i.Vector3(-1,-1,-1);if(0!=a||0!=s||0!=l){var h=new i.Color;h.setRGB(a/255,s/255,l/255),c=this.findXYZFromColorID(h.getHex());var u=this.findReflectanceFromColorID(h.getHex());this.analyzeRegionOnReflectance(u,c),console.log(u)}return c},analyzeRegionOnReflectance:function(e,t){for(var r=[],o=0;F>o;++o){var n=new i.Vector3(D.attributes.position.array[3*o],D.attributes.position.array[3*o+1],D.attributes.position.array[3*o+2]),a=new i.Vector3(D.attributes.color.array[3*o],D.attributes.color.array[3*o+1],D.attributes.color.array[3*o+2]);n.distanceTo(t)<.15&&Math.abs(e.z-a.z)<.03&&Math.abs(e.y-a.y)<.03&&Math.abs(t.y-n.y)<.25&&(this.colorizePointAtPos(o,new i.Vector3(1,1,1)),r.push(n))}for(var s=this.extractCorners(r),l=0;l<s.length;++l)c.drawSphereAt(s[l],.05);this.updateLaserAttributes()},findXYZFromColorID:function(e){var t=new i.Vector3(0,0,0),r=3*e;return t=new i.Vector3(D.attributes.position.array[r],D.attributes.position.array[r+1],D.attributes.position.array[r+2])},findReflectanceFromColorID:function(e){var t=new i.Vector3(0,0,0),r=3*e;return t=new i.Vector3(D.attributes.color.array[r],D.attributes.color.array[r+1],D.attributes.color.array[r+2])},colorizePointAtPos:function(e,t){D.attributes.color.array[3*e]=t.x,D.attributes.color.array[3*e+1]=t.y,D.attributes.color.array[3*e+2]=t.z,D.attributes.color.needsUpdate=!0},extractCorners:function(e){for(var t=[],r=0;r<e.length;++r){for(var i=e[r],o=!0,n=!0,a=!0,s=!0,l=0;(1==o||1==n||1==a||1==s)&&l<e.length;){var c=e[l];i.distanceTo(c)<.15&&(o=c.x>=i.x&&o,n=c.x<=i.x&&n,a=c.z<=i.z&&a,s=c.z>=i.z&&s),l++}(1==o||1==n||1==a||1==s)&&t.push(i)}return console.log(e.length),console.log(t.length),t},estimateSlope:function(e,r,o){var n=[],o=(t.getZero(),o||32),a=new Uint8Array(o*o*4);t.renderToTexture(m,t.getCamera(),T,!0);var s=t.getContext();s.readPixels(e-o/2,t.getWinHeight()-r-o/2,o,o,s.RGBA,s.UNSIGNED_BYTE,a);for(var l=0;l<a.length-4;l+=4){var c=a[l],h=a[l+1],u=a[l+2];if(0!=c||0!=h||0!=u){var p=new i.Color;p.setRGB(c/255,h/255,u/255);var d=this.findXYZFromColorID(p.getHex());this.colorizePointAtPos(p.getHex(),new i.Vector3(1,0,0)),n.push(d)}}this.analyzeSlopeFromArr(n)},estimateWidth:function(e,r,o){var n=new Uint8Array(4);t.renderToTexture(m,t.getCamera(),T,!0);var a=t.getContext();a.readPixels(e,t.getWinHeight()-r,1,1,a.RGBA,a.UNSIGNED_BYTE,n);var s=n[0],l=n[1],h=n[2];new i.Vector3(-1,-1,-1);if(255!==s||255!==l||255!==h){var u=new i.Color;u.setRGB(s/255,l/255,h/255);var p=u.getHex(),d=3*p,f=!1,v=!1,g=5e3,y=.01,x=4,w=D.attributes.position.array,b=new i.Vector3(w[d],w[d+1],w[d+2]),_=new i.Vector3(w[d],w[d+1],w[d+2]),M=0,S=d,C=w[S-2]<b.y&&b.y<w[S+4]&&w[S+4]-w[S-2]>2*y,L=w[S-2]>b.y&&b.y>w[S+4]&&w[S-2]-w[S+4]>2*y;if(C||L){var A;A=C?this.searchForPointToward(d,"top"):this.searchForPointToward(d,"bottom"),I=A.posR,V=A.posL,V.x=b.x,V.z=b.z;var P=V.y-I.y;"Stay"==o?(c.drawOneMoreLine(V,I),c.drawSphereAt(V,.05,16711935),c.drawSphereAt(I,.05,16711935),c.showTextAtPos3D(P.toFixed(1)+"m  ",b,50)):(c.drawLine(V,I),c.showTextAtPos3DSameMesure(P.toFixed(1)+"m  ",b))}else{for(;!f&&g>M;){M++;for(var F=0,E=0;x>E;++E){S=d+3*(M+E);var V=new i.Vector3(w[S],w[S+1],w[S+2]),R=V.y-_.y;F+=R,_=V.clone(),E+=3}f=Math.abs(F)>1.5*y}var z=S,V=new i.Vector3(w[z],w[z+1],w[z+2]);for(M=0,_=new i.Vector3(w[d],w[d+1],w[d+2]);!v&&g>M;){M++;for(var F=0,E=0;x>E;++E){S=d-3*(M+E);var I=new i.Vector3(w[S],w[S+1],w[S+2]),U=I.y-_.y;F+=U,_=I.clone(),E+=3}v=Math.abs(F)>1.5*y}var O=S,I=new i.Vector3(w[O],w[O+1],w[O+2]);Math.abs(I.y-V.y)>10*y&&(I.y>V.y?I.y=V.y:V.y=I.y);var B=new i.Vector3((V.x+I.x)/2,(V.y+I.y)/2-.4,(V.z+I.z)/2),P=I.distanceTo(V).toFixed(2),N=Math.sqrt((I.x-V.x)*(I.x-V.x)+(I.z-V.z)*(I.z-V.z)),k=Math.abs(I.y-V.y)/N;"Stay"==o?(c.drawOneMoreLine(V,I),c.showTextAtPos3D(P+"m  "+k.toFixed(1)+"%",B,45),c.drawSphereAt(V,.05,16711935),c.drawSphereAt(I,.05,16711935),c.setZebraPosition(V,I,"ON")):(c.setZebraPosition(V,I),c.drawLine(V,I),c.showTextAtPos3DSameMesure(P+"m  "+k.toFixed(1)+"%",B,45))}}},searchForPointToward:function(e,t){var r,o,n,a,s=D.attributes.position.array,l=new i.Vector3(s[e],s[e+1],s[e+2]),c=new i.Vector3(s[e],s[e+1],s[e+2]),h=0,u=e,p=!1,d=!1,f=8e3,m=.01,v=6,g=4;if("top"==t){for(;!p&&f>h;){h++,u=e+3*h;var y=new i.Vector3(s[u],s[u+1],s[u+2]),x=c.distanceTo(y);c=y.clone(),p=x>v}for(r=u-3,h=0,c=new i.Vector3(s[e],s[e+1],s[e+2]);!d&&f>h;){var w=0;h++;for(var b=0;24*g>b;++b){u=e-3*(h+b),a=new i.Vector3(s[u],s[u+1],s[u+2]);var _=a.y-c.y;w+=_,c=a.clone(),b+=3}d=Math.abs(w)<m/4}o=u-3}else{for(;!p&&f>h;){h++,u=e-3*h;var y=new i.Vector3(s[u],s[u+1],s[u+2]),x=c.distanceTo(y);c=y.clone(),p=x>v}for(r=u+3,h=0,c=new i.Vector3(s[e],s[e+1],s[e+2]);!d&&f>h;){var w=0;h++;for(var b=0;2*g>b;++b){u=e+3*(h+b),a=new i.Vector3(s[u],s[u+1],s[u+2]);var _=a.y-c.y;w+=_,c=a.clone(),b+=3}d=Math.abs(w)<m/3}o=u-3}return n=new i.Vector3(s[o],s[o+1],s[o+2]),a=new i.Vector3(s[r],s[r+1],s[r+2]),n.x=l.x,n.z=l.z,a.x=l.x,a.z=l.z,{posL:a,posR:n}},analyzeSlopeFromArr:function(e){for(var t,r,i=null,t=e[0],o=1;!i&&o<e.length;){var n=e[o];r?Math.abs(n.z-r.z)>.1&&(i=n):Math.abs(n.x-t.x)>.1&&(r=n),o++}i&&this.computeNormalFrom3Points(t,r,i)},computeNormalFrom3Points:function(e,t,r,o){var n=new i.Vector3,a=new i.Vector3;if(n.subVectors(r,t),a.subVectors(e,t),n.cross(a),n.normalize(),o){c.drawLine(e,new i.Vector3(e.x+n.x,e.y+n.y,e.z+n.z)),c.drawSurface(e,n),console.log(n);var s=.3+4*(Math.abs(n.x)+Math.abs(n.z));s>1&&(s=1),c.setSurfaceColor(s)}return n},changeRepere:function(e,t,r,o,n){this.lengthAB=(t.x-e.x)/Math.cos(-n),this.lengthAC=(r.x-e.x)/Math.sin(-n),this.ptA2=e,this.ptB2=new i.Vector3(e.x+this.lengthAB,t.y,e.z),this.ptC2=new i.Vector3(e.x,r.y,e.z+this.lengthAC)},checkAllPointsInBB:function(e,t,r,o,n,a){I++,B=0,O=0,this.changeRepere(e,t,r,o,n),this.nbPointsInBB=0;var s=new i.Color;s.setHSL(.2,.5,1);for(var l=0;F>l;++l){var c=new i.Vector3(D.attributes.position.array[3*l],D.attributes.position.array[3*l+1],D.attributes.position.array[3*l+2]);this.lengthAPoint=Math.sqrt((c.x-e.x)*(c.x-e.x)+(c.z-e.z)*(c.z-e.z));var h=Math.atan2(c.z-e.z,c.x-e.x);this.point2=new i.Vector3(e.x+this.lengthAPoint*Math.cos(h-n),c.y,e.z+this.lengthAPoint*Math.sin(h-n));var u=!1;if(u=this.ptA2.x<this.ptB2.x?this.ptA2.z<this.ptC2.z?this.point2.x>this.ptA2.x&&this.point2.x<this.ptB2.x&&this.point2.z>this.ptA2.z&&this.point2.z<this.ptC2.z:this.point2.x>this.ptA2.x&&this.point2.x<this.ptB2.x&&this.point2.z<this.ptA2.z&&this.point2.z>this.ptC2.z:this.ptA2.z<this.ptC2.z?this.point2.x<this.ptA2.x&&this.point2.x>this.ptB2.x&&this.point2.z>this.ptA2.z&&this.point2.z<this.ptC2.z:this.point2.x<this.ptA2.x&&this.point2.x>this.ptB2.x&&this.point2.z<this.ptA2.z&&this.point2.z>this.ptC2.z,u=u&&this.ptA2.y<=this.point2.y&&this.ptA2.y+a>=this.point2.y,U){var p=D.attributes.classe.array[l];u=u&&(O>p||p>=O+1e8)}u&&(this.nbPointsInBB++,D.attributes.color.array[3*l]=s.r,D.attributes.color.array[3*l+1]=s.g,D.attributes.color.array[3*l+2]=s.b,D.attributes.uniqueid.array[l]=I,D.attributes.classe.array[l]=B)}this.updateLaserAttributes()},specifyClassForPointsSameID:function(e,r){var o=new Uint8Array(4);t.renderToTexture(m,t.getCamera(),T,!0);var n=t.getContext();n.readPixels(e,t.getWinHeight()-r,1,1,n.RGBA,n.UNSIGNED_BYTE,o);var a=o[0],s=o[1],l=o[2];new i.Vector3(-1,-1,-1);if(255!==a||255!==s||255!==l){var c=new i.Color;c.setRGB(a/255,s/255,l/255);var h=c.getHex(),u=(new i.Vector3(0,0,0),h),p=D.attributes.uniqueid.array[u];console.log("id of object selected: ",p);for(var d=0;F>d;++d)D.attributes.uniqueid.array[d]==p&&(D.attributes.classe.array[d]=B,this.colorizePointAtPos(d,new i.Vector3(1,1,1)))}},setFilterSurface:function(e){U=e,console.log(e)},convert:function(e,t){l.convertCoord({x:e,y:t},"EPSG:27561","EPSG:2154")},pairWiseRegistration:function(){for(var e=0;F>e;++e)D.attributes.uniqueid.array[e]==$-1&&(D.attributes.position.array[3*e]=D.attributes.position.array[3*e]+69,D.attributes.position.array[3*e+1]=D.attributes.position.array[3*e+1]+41,D.attributes.position.array[3*e+2]=D.attributes.position.array[3*e+2]+301);g.currentidwork.value=$-1,ie.setReverseMotion,D.attributes.displacement.needsUpdate=!0,this.updateLaserAttributes()},getZero:function(){return ee},getNotLoaded:function(){return te},getNbClassLidar:function(){return $},getShaderMat:function(){return y},getGeometryVertices:function(){return D},savePointInputs:function(t){e.post("php/postUserInputs.php",{inputType:1,p1:[t.x,t.y,t.z]},function(e){console.log("Storing operation : "+e)})},saveLineInputs:function(t,r){e.post("php/postUserInputs.php",{inputType:2,p1:[t.x,t.y,t.z],p2:[r.x,r.y,r.z]},function(e){console.log("Storing operation : "+e)})},saveBBInputs:function(t,r,i,o,n){e.post("php/postUserInputs.php",{inputType:3,p1:[t.x,t.y,t.z],p2:[r.x,r.y,r.z],p3:[i.x,i.y,i.z],p4:[o.x,o.y,o.z],h:n},function(e){console.log("Storing operation : "+e)})},setAnnotationOnOff:function(e){console.log("setAnnotationOnOff"),this.annotationOn=e},getAnnotationOnOff:function(){return this.annotationOn},setComputeNormalOn:function(e){this.computeNormalOn=e},IsComputeNormalOn:function(){return this.computeNormalOn},getLocalMode:function(){return V},setLocalMode:function(e){V=e},setFilename:function(e){z=e},setMessageDisplay:function(t,r){if(r){console.log("loading");var i=document.createElement("div");i.innerHTML='<font style="font-family: Impact; font-size:20vw; position:absolute; top:50%; left: 35%; margin-top: -10vw; margin-left: -10vw; color:white"> LOADING </font>',i.id="loading";var o=document.getElementById("dynamicInput");o.appendChild(i)}else e("#loading").remove()}};return ie}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(5),r(3),r(1),r(9),r(10),r(7),r(11)],o=function(e,t,r,i,o,n,a){var s=null,l=550,c=[],h={},u=null,p=0,d=0,f={},m={MOVE:function(){1==e("#connected").length&&v.updateMeasureAroundPosition()}},v={initiated:!1,init:function(){console.log("Measure initiated"),s=i.getPanoPos(),c=[],this.showUserMeasures(),o.register("MOVE",v),this.initiated=!0},updateMeasureAroundPosition:function(){var e=i.getPanoPos(),t=e.distanceTo(s);t>l&&(n.removeAllMeasures(),console.log("load NEW MEASURES"),this.showUserMeasures(),s=e)},showUserMeasures:function(){if(1==e("#connected").length){console.log("user is connected");var t=i.getPanoInfos(),r="easting="+t.easting+"&northing="+t.northing+"&ray="+l;e.getJSON("php/getUserInputs.php?"+r,function(e){h=e,console.log(e),v.drawUserMeasures()})}},drawUserMeasures:function(){n.drawLines(h.lines),n.drawPOI(h.poi)},drawMeasure:function(e){n.drawPOI([{x:e.x,y:e.y,z:e.z,description:"QT"}])},drawAlgoResults:function(e,t){console.log("Draw algo results"),n.drawProfiles(e,t)},launchAlgoAH:function(){e.getJSON("http://172.20.0.158/cgi-bin/zoo_loader.cgi?ServiceProvider=&metapath=&Service=WPS&Request=Execute&Version=1.0.0&Identifier=totalprofil&DataInputs=x1_1=1904.461792;y1_1=21219.601562;z1_1=37.966621;x1_2=1904.458496;y1_2=21219.748047;z1_2=37.965637;x1_3=1904.447632;y1_3=21219.892578;z1_3=37.969490;x1_4=1904.430542;y1_4=21220.134766;z1_4=37.967007;x2_1=1900.932617;y2_1=21219.376953;z2_1=37.785740;x2_2=1900.92443;y2_2=21219.521484;z2_2=37.777386;x2_3=1900.916260;y2_3=21219.716797;z2_3=37.778072;x2_4=1900.909668;y2_4=21219.861328;z2_4=37.767097",function(){}),this.showAlgoMeasures()},showAlgoMeasures:function(){console.log("showAlgoMeasures");var t=1;e.getJSON("php/getAlgoResults.php?idAlgo="+t,function(e){e.length>p&&(v.drawAlgoResults(e,p),p=e.length),setTimeout(v.showAlgoMeasures,500)})},processEvent:function(e){m[e]&&m[e]()},getMeasures:function(){return h},setMeasures:function(e){h=e},getPoiArray:function(){return u},setPoiArray:function(e){u=e},addPOI:function(e,t){var r={x:parseFloat(e.x),y:parseFloat(e.y),z:parseFloat(e.z),description:t};if(h.poi){var i=Object.keys(h.poi).length,o="p"+i;h.poi[o]=r}else{var o="p0";h.poi={},h.poi[o]=r}console.log(h)},goToPOI:function(e){var i,o=Object.keys(h.poi).length;"next"==e?d++:d--;var n=(o+d)%o;0>n&&(n+=o);var s="p"+n;i=h.poi[s],console.log(i);var l=new r.Vector3(i.x,i.y,i.z),c={intersectionToLook:l.clone().sub(t.getZeroAsVec3D()),surfaceType:"Rectangle"};a.goToClosestPosition(l,c)},getLastMeasure:function(){return f},setLastMeasure:function(e){f=e}};return v}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(3),r(1),r(8),r(12),r(13),r(20)],o=function(e,t,r,i,o,n){window.requestAnimSelectionAlpha=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var a=null,s=!1,l={init:function(){_localImageFiles=o.getImageLocal(),s=!0},isInitiated:function(){return s},createShaderMat:function(e,s){for(var l=0,c=[],h=[],u=[],p=[],d=o.getMetaDataSensorURL(),f=0;f<r.sensors.length;++f){var m=e.url_format.replace("{cam_id_pos}",r.sensors[f].infos.cam_id_pos);c.push(n.resolve(d,m));var v=(new t.Matrix4).multiplyMatrices(r.getMatCam(f),r.getProjCam(f));h.push((new t.Matrix4).multiplyMatrices(s,v.clone()).transpose());var g=r.getSommet(f).clone().applyProjection(s);g.w=1,u.push(g),p.push(r.getDistortion(f))}switch(r.sensors.length){case 5:var y={indice_time0:{type:"f",value:l},indice_time1:{type:"f",value:l},indice_time2:{type:"f",value:l},indice_time3:{type:"f",value:l},indice_time4:{type:"f",value:l},distortion0:{type:"v4",value:p[0]},distortion1:{type:"v4",value:p[1]},distortion2:{type:"v4",value:p[2]},distortion3:{type:"v4",value:p[3]},distortion4:{type:"v4",value:p[4]},mvpp0:{type:"m4",value:h[0]},mvpp1:{type:"m4",value:h[1]},mvpp2:{type:"m4",value:h[2]},mvpp3:{type:"m4",value:h[3]},mvpp4:{type:"m4",value:h[4]},mvpp0bis:{type:"m4",value:h[0]},mvpp1bis:{type:"m4",value:h[1]},mvpp2bis:{type:"m4",value:h[2]},mvpp3bis:{type:"m4",value:h[3]},mvpp4bis:{type:"m4",value:h[4]},translation0:{type:"v4",value:u[0]},translation1:{type:"v4",value:u[1]},translation2:{type:"v4",value:u[2]},translation3:{type:"v4",value:u[3]},translation4:{type:"v4",value:u[4]},translation0bis:{type:"v4",value:u[0]},translation1bis:{type:"v4",value:u[1]},translation2bis:{type:"v4",value:u[2]},translation3bis:{type:"v4",value:u[3]},translation4bis:{type:"v4",value:u[4]},texture0:{type:"t",value:t.ImageUtils.loadTexture(c[0])},texture1:{type:"t",value:t.ImageUtils.loadTexture(c[1])},texture2:{type:"t",value:t.ImageUtils.loadTexture(c[2])},texture3:{type:"t",value:t.ImageUtils.loadTexture(c[3])},texture4:{type:"t",value:t.ImageUtils.loadTexture(c[4])},texture0bis:{type:"t",value:t.ImageUtils.loadTexture(c[0])},texture1bis:{type:"t",value:t.ImageUtils.loadTexture(c[1])},texture2bis:{type:"t",value:t.ImageUtils.loadTexture(c[2])},texture3bis:{type:"t",value:t.ImageUtils.loadTexture(c[3])},texture4bis:{type:"t",value:t.ImageUtils.loadTexture(c[4])},textureMask0:{type:"t",value:r.getMask(0)},textureMask1:{type:"t",value:r.getMask(1)},textureMask2:{type:"t",value:r.getMask(2)},textureMask3:{type:"t",value:r.getMask(3)},textureMask4:{type:"t",value:r.getMask(4)}};a=new t.ShaderMaterial({uniforms:y,vertexShader:i.shaderTextureProjective2VS.join("\n"),fragmentShader:i.shaderTextureProjective2FS.join("\n"),side:t.BackSide,transparent:!0})}return a},tweenIndiceTime:function(e){var t=a.uniforms["indice_time"+e].value;if(t>0){t-=.03,0>t&&(t=0),a.uniforms["indice_time"+e].value=t;var r=this;requestAnimSelectionAlpha(function(){r.tweenIndiceTime(e)})}},changePanoTextureAfterloading:function(e,t,i){for(var o=0;o<r.sensors.length;++o)this.chargeOneImageCam(e,t,i,o)},chargeOneImageCam:function(e,i,s,l){var c=new Image;c.crossOrigin="anonymous";var h=this;c.onload=function(){var e=(new t.Matrix4).multiplyMatrices(r.getMatCam(l),r.getProjCam(l)),o=r.getSommet(l).clone().applyProjection(s);o.w=1,a.uniforms["mvpp"+l].value=a.uniforms["mvpp"+l+"bis"].value,a.uniforms["translation"+l].value=a.uniforms["translation"+l+"bis"].value,a.uniforms["texture"+l].value=a.uniforms["texture"+l+"bis"].value,a.uniforms["mvpp"+l+"bis"].value=(new t.Matrix4).multiplyMatrices(s,e.clone()).transpose(),a.uniforms["translation"+l+"bis"].value=i.clone().add(o),a.uniforms["texture"+l+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),a.uniforms["texture"+l+"bis"].value.needsUpdate=!0,a.uniforms["indice_time"+l].value=1,h.tweenIndiceTime(l)};var u=o.getMetaDataSensorURL(),p=e.url_format.replace("{cam_id_pos}",r.sensors[l].infos.cam_id_pos);c.src=n.resolve(u,p)}};return l}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1)],o=function(e){return TileTexture=function(t,r,i,o,n,a,s,l,c,h,u,p,d){var f=s*n,m=s*n;this.canvasTex=document.createElement("canvas"),this.canvasTex.width=2048,this.canvasTex.height=2048,this.ctxTex=this.canvasTex.getContext("2d"),this.opacity=1,this.xmt=new e.MeshBasicMaterial({map:new e.Texture(this.canvasTex),transparent:!1,opacity:this.opacity}),this.xmt.side=e.DoubleSide,this.xmt.map.needsUpdate=!0,this.key=p;var v;if(l){console.log("Tile texture using DTM",l),v=l.clone(),v.faceVertexUvs[0]=[];for(var g=0;h-1>g;++g)for(var y=0;h-1>y;++y){var x=new e.Vector3(g*d-u+c.x,0,y*d-u+c.z),w=new e.Vector3((g+1)*d-u+c.x,0,y*d-u+c.z),b=new e.Vector3(g*d-u+c.x,0,(y+1)*d-u+c.z),_=new e.Vector3((g+1)*d-u+c.x,0,(y+1)*d-u+c.z),M=new e.Vector3(x.x-o.x,0,x.z-o.y),S=new e.Vector3(w.x-o.x,0,w.z-o.y),T=new e.Vector3(b.x-o.x,0,b.z-o.y),C=new e.Vector3(_.x-o.x,0,_.z-o.y);M.x/=f,M.z/=m,S.x/=f,S.z/=m,T.x/=f,T.z/=m,C.x/=f,C.z/=m,M.x=M.x<0||M.x>1?0:M.x,M.z=M.z<0||M.z>1?0:M.z,S.x=S.x<0||S.x>1?0:S.x,S.z=S.z<0||S.z>1?0:S.z,T.x=T.x<0||T.x>1?0:T.x,T.z=T.z<0||T.z>1?0:T.z,C.x=C.x<0||C.x>1?0:C.x,C.z=C.z<0||C.z>1?0:C.z,v.faceVertexUvs[0].push([new e.Vector2(M.x,M.z),new e.Vector2(T.x,T.z),new e.Vector2(S.x,S.z)]),v.faceVertexUvs[0].push([new e.Vector2(T.x,T.z),new e.Vector2(C.x,C.z),new e.Vector2(S.x,S.z)])}v.computeFaceNormals()}else console.log("Create new Geometry"),v=new e.Geometry,v.vertices.push(new e.Vector3(0,0,0),new e.Vector3(0,0,2048),new e.Vector3(2048,0,2048),new e.Vector3(2048,0,0)),v.faces.push(new e.Face3(0,1,3)),v.faces.push(new e.Face3(1,2,3)),v.faceVertexUvs[0].push([new e.Vector2(0,0),new e.Vector2(0,1),new e.Vector2(1,0)]),v.faceVertexUvs[0].push([new e.Vector2(0,1),new e.Vector2(1,1),new e.Vector2(1,0)]),v.computeFaceNormals();this.meshNest=new e.Mesh(v,this.xmt),this.meshNest.position.y-=5,this.formatImage=i,this.url=t,this.layer=r,this.nbLoaded=0,this.tilesList=[],console.log(l)},TileTexture.prototype.addTileToTextureNow=function(e,t,r){var i=256,o=8,n=256*(o-1);this.nbLoaded++,this.ctxTex.drawImage(r,e*i,n-t*i),this.xmt.map.needsUpdate=!0,this.loadTilesFromList()},TileTexture.prototype.loadTilesFromList=function(){if(this.tilesList.length>0){var e=this.tilesList.shift(),t=this,r=new Image;r.crossOrigin="Anonymous",function(e,r,i){i.onload=function(){t.addTileToTextureNow(e,r,i)},i.onerror=function(){console.error("Image server screwed up for this tile")}}(e.x,e.y,r),r.src=e.url}},TileTexture.prototype.createTilesList=function(e,t){for(var r=8,i=0;r>i;++i)for(var o=0;r>o;++o){var n="http://wxs.ign.fr/"+this.key,a=e.x+i*t,s=e.y+o*t,l=a+t,c=s+t;n+="/geoportail/r/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&CRS=IGNF:LAMB93&LAYERS="+this.layer,n+="&STYLES=normal&WIDTH=256&HEIGHT=256&BBOX="+a+","+s+","+l+","+c,n+="&FORMAT=image%2F"+this.formatImage,this.tilesList.push({url:n,x:i,y:o})}},TileTexture}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[],o=function(){var e=function(e,t){if(t)throw"BinaryStream constructor failed: Big endian is not supported yet!";this.data=e,this.offset=0};return e.prototype.size=function(){return this.data.length},e.prototype.tell=function(){return this.offset},e.prototype.seek=function(e){return 0>e||e>=this.data.length?!1:(this.offset=e,!0)},e.prototype.reset=function(){this.offset=0},e.prototype.skip=function(e){this.offset+e>this.data.length?this.offset=this.data.length:this.offset+=e},e.prototype.available=function(){return this.data.length-this.offset},e.prototype.eof=function(){return!(this.offset<this.data.length)},e.prototype.readUInt8=function(){return this.decodeInt(1,!1)},e.prototype.readInt8=function(){return this.decodeInt(1,!0)},e.prototype.readUInt16=function(){return this.decodeInt(2,!1)},e.prototype.readInt16=function(){return this.decodeInt(2,!0)},e.prototype.readUInt32=function(){return this.decodeInt(4,!1)},e.prototype.readInt32=function(){return this.decodeInt(4,!0)},e.prototype.readFloat32=function(){return this.decodeFloat(4,23)},e.prototype.readFloat64=function(){return this.decodeFloat(8,52)},e.prototype.readBytes=function(e,t){var r=t;this.offset+t>this.data.length&&(r=this.data.length-this.offset);for(var i=0;r>i;i++)e[i]=255&this.data[this.offset++].charCodeAt(0);return r},e.prototype.decodeInt=function(e,t){if(this.offset+e>this.data.length)return this.offset=this.data.length,NaN;for(var r=0,i=1,o=0;e>o;o++)r+=(255&this.data[this.offset++].charCodeAt(0))*i,i*=256;return t&&r&Math.pow(2,8*e-1)&&(r-=Math.pow(2,8*e)),r},e.prototype.decodeFloat=function(e,t){if(this.offset+e>this.data.length)return this.offset=this.data.length,NaN;var r=t,i=8*e-r-1,o=(1<<i)-1,n=o>>1,a=e-1,s=-1,l=255&this.data[this.offset+a].charCodeAt(0);a+=s;var c=-7,h=l&(1<<-c)-1;for(l>>=-c,c+=i;c>0;)h=256*h+(255&this.data[this.offset+a].charCodeAt(0)),a+=s,c-=8;var u=h&(1<<-c)-1;for(h>>=-c,c+=r;c>0;)u=256*u+(255&this.data[this.offset+a].charCodeAt(0)),a+=s,c-=8;switch(this.offset+=e,h){case 0:h=1-n;break;case o:return u?NaN:(l?-1:1)*(1/0);default:u+=Math.pow(2,r),h-=n}return(l?-1:1)*u*Math.pow(2,h-r)},e}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[],o=function(){var e=function(){for(var e,t={browser:"other",version:"0.0.0",isTouchDevice:void 0!==document.createTouch},r=[["firefox",/Firefox[\/\s](\d+(?:.\d+)*)/],["chrome",/Chrome[\/\s](\d+(?:.\d+)*)/],["opera",/Opera[\/\s](\d+(?:.\d+)*)/],["safari",/Safari[\/\s](\d+(?:.\d+)*)/],["webkit",/AppleWebKit[\/\s](\d+(?:.\d+)*)/],["ie",/MSIE[\/\s](\d+(?:.\d+)*)/]],i=0;i<r.length;i++)if(e=r[i][1].exec(window.navigator.userAgent)){t.browser=r[i][0],t.version=e[1];break}return t}();return e}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,r){e.exports=t},function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,i,o){t=t||"&",i=i||"=";var n={};if("string"!=typeof e||0===e.length)return n;var a=/\+/g;e=e.split(t);var s=1e3;o&&"number"==typeof o.maxKeys&&(s=o.maxKeys);var l=e.length;s>0&&l>s&&(l=s);for(var c=0;l>c;++c){var h,u,p,d,f=e[c].replace(a,"%20"),m=f.indexOf(i);m>=0?(h=f.substr(0,m),u=f.substr(m+1)):(h=f,u=""),p=decodeURIComponent(h),d=decodeURIComponent(u),r(n,p)?Array.isArray(n[p])?n[p].push(d):n[p]=[n[p],d]:n[p]=d}return n}},function(e,t){"use strict";var r=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,i,o){return t=t||"&",i=i||"=",null===e&&(e=void 0),"object"==typeof e?Object.keys(e).map(function(o){var n=encodeURIComponent(r(o))+i;return Array.isArray(e[o])?e[o].map(function(e){return n+encodeURIComponent(r(e))}).join(t):n+encodeURIComponent(r(e[o]))}).join(t):o?encodeURIComponent(r(o))+i+encodeURIComponent(r(e)):""}},function(e,t,r){"use strict";t.decode=t.parse=r(28),t.encode=t.stringify=r(29)},function(e,t,r){var i;(function(e,o){!function(n){function a(e){throw RangeError(E[e])}function s(e,t){for(var r=e.length,i=[];r--;)i[r]=t(e[r]);return i}function l(e,t){var r=e.split("@"),i="";r.length>1&&(i=r[0]+"@",e=r[1]),e=e.replace(F,".");var o=e.split("."),n=s(o,t).join(".");return i+n}function c(e){for(var t,r,i=[],o=0,n=e.length;n>o;)t=e.charCodeAt(o++),t>=55296&&56319>=t&&n>o?(r=e.charCodeAt(o++),56320==(64512&r)?i.push(((1023&t)<<10)+(1023&r)+65536):(i.push(t),o--)):i.push(t);return i}function h(e){return s(e,function(e){var t="";return e>65535&&(e-=65536,t+=z(e>>>10&1023|55296),e=56320|1023&e),t+=z(e)}).join("")}function u(e){return 10>e-48?e-22:26>e-65?e-65:26>e-97?e-97:b}function p(e,t){return e+22+75*(26>e)-((0!=t)<<5)}function d(e,t,r){var i=0;for(e=r?R(e/T):e>>1,e+=R(e/t);e>V*M>>1;i+=b)e=R(e/V);return R(i+(V+1)*e/(e+S))}function f(e){var t,r,i,o,n,s,l,c,p,f,m=[],v=e.length,g=0,y=L,x=C;for(r=e.lastIndexOf(A),0>r&&(r=0),i=0;r>i;++i)e.charCodeAt(i)>=128&&a("not-basic"),m.push(e.charCodeAt(i));for(o=r>0?r+1:0;v>o;){for(n=g,s=1,l=b;o>=v&&a("invalid-input"),c=u(e.charCodeAt(o++)),(c>=b||c>R((w-g)/s))&&a("overflow"),g+=c*s,p=x>=l?_:l>=x+M?M:l-x,!(p>c);l+=b)f=b-p,s>R(w/f)&&a("overflow"),s*=f;t=m.length+1,x=d(g-n,t,0==n),R(g/t)>w-y&&a("overflow"),y+=R(g/t),g%=t,m.splice(g++,0,y)}return h(m)}function m(e){var t,r,i,o,n,s,l,h,u,f,m,v,g,y,x,S=[];for(e=c(e),v=e.length,t=L,r=0,n=C,s=0;v>s;++s)m=e[s],128>m&&S.push(z(m));for(i=o=S.length,o&&S.push(A);v>i;){for(l=w,s=0;v>s;++s)m=e[s],m>=t&&l>m&&(l=m);for(g=i+1,l-t>R((w-r)/g)&&a("overflow"),r+=(l-t)*g,t=l,s=0;v>s;++s)if(m=e[s],t>m&&++r>w&&a("overflow"),m==t){for(h=r,u=b;f=n>=u?_:u>=n+M?M:u-n,!(f>h);u+=b)x=h-f,y=b-f,S.push(z(p(f+x%y,0))),h=R(x/y);S.push(z(p(h,0))),n=d(r,g,i==o),r=0,++i}++r,++t}return S.join("")}function v(e){return l(e,function(e){return P.test(e)?f(e.slice(4).toLowerCase()):e})}function g(e){return l(e,function(e){return D.test(e)?"xn--"+m(e):e;
})}var y=("object"==typeof t&&t&&!t.nodeType&&t,"object"==typeof e&&e&&!e.nodeType&&e,"object"==typeof o&&o);(y.global===y||y.window===y||y.self===y)&&(n=y);var x,w=2147483647,b=36,_=1,M=26,S=38,T=700,C=72,L=128,A="-",P=/^xn--/,D=/[^\x20-\x7E]/,F=/[\x2E\u3002\uFF0E\uFF61]/g,E={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},V=b-_,R=Math.floor,z=String.fromCharCode;x={version:"1.3.2",ucs2:{decode:c,encode:h},decode:f,encode:m,toASCII:g,toUnicode:v},i=function(){return x}.call(t,r,t,e),!(void 0!==i&&(e.exports=i))}(this)}).call(t,r(33)(e),function(){return this}())},function(e,t){e.exports=function(){throw new Error("define cannot be used indirect")}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,t,r){var i,o;i=[r(5),r(3),r(11),r(9),r(21),r(22),r(10),r(2),r(14),r(6)],o=function(e,t,r,i,o,n,a,s,l,c){API=function(e){this.dataURL=e.dataURL||c.dataURL,this.positionInit=e.positionInit||{x:651182.91,y:39.6,z:6861343.03},t.setZero(this.positionInit),i.init(this.positionInit,this.dataURL),a.register("MOVE",i),e.usingBati3D&&this.addLayer("3DBuilding",this.dataURL),e.usingLaserCloud&&this.addLayer("pointCloud",this.dataURL),this.version=.1,a.register("MOVE",API),a.register("ZOOM",API),a.register("ORIENTATION",API),a.register("MEASURE",API),this.initialized=!0};var h={MOVE:function(){},ZOOM:function(){},ORIENTATION:function(){},MEASURE:function(){console.log(n.getLastMeasure())}};return API.processEvent=function(e){h[e]&&h[e]()},API.prototype.setInitialized=function(e){this.initialized=e},API.prototype.isInitialized=function(){return this.initialized},API.prototype.setPanoramicPosition=function(e){console.log("setPanoramicPosition to",e),r.goToClosestPosition(e)},API.prototype.getPanoramicPosition=function(){var e=i.getPanoPos();return{easting:e.x,northing:e.z,hauteur:e.y}},API.prototype.setPanoramicOrientation=function(e){t.cameraLookAtHeading(0,0,0,e)},API.prototype.setPanoramicOrientationYawPitch=function(e,r){t.cameraLookAtYawPitch(0,0,0,e,r)},API.prototype.getPanoramicOrientationgetCameraYawPitch=function(){return t.getCameraYawPitch()},API.prototype.setCameraFOV=function(e){t.setCameraFov(e)},API.prototype.getCameraFOV=function(){return t.getCameraFov()},API.prototype.getLastMeasure=function(){return n.getLastMeasure()},API.prototype.addMeasure=function(e){n.drawMeasure(e)},API.prototype.setPanoramicVisible=function(e){i.setVisibility(e)},API.prototype.setLowResolution=function(e){t.setLowReso(e)},API.prototype.addLayer=function(e,r){"pointCloud"==e&&(i.isInitiated()?(o.initiated?o.getNotLoaded()&&!o.getLocalMode()&&o.launchLaserAroundCurrentTime(10,11):(n.init(),o.init(t.getZero(),r),t.addToScene(o.laserCloudMaster),o.launchLaserAroundCurrentTime(10,11)),o.setVisibility(!0),o.btnSwitchPoint=!0):setTimeout(function(){API.prototype.addLayer("pointCloud",r)},150)),"3DBuilding"==e&&(l.isCartoInitialized()||(l.initCarto3D(r),i.setVisibility(!1)))},API.prototype.removeLayer=function(e){console.log("removeLayer",e),"pointCloud"==e&&o.setVisibility(!1),"3DBuilding"==e&&l.removeAllDalles()},API.prototype.setLayerVisibility=function(e,t){console.log("removeLayer",e),"pointCloud"==e&&o.setVisibility(t),"3DBuilding"==e&&l.setVisibility(t)},API.prototype.addListener=function(e,t,r){"MOVE"==t?h.MOVE=r:"ZOOM"==t?h.ZOOM=r:"ORIENTATION"==t?h.ORIENTATION=r:"MEASURE"==t&&(h.MEASURE=r)},API.prototype.createSearchInput=function(){$containerSE=e(t.getContainerID()),$containerSE.append('<div id="divSearchInput"> <input  name="myfieldname" id="searchInput" value="Adresse, Ville..." style="background-color: rgba(0,0,0,0.5); position:absolute;  right: 50px; width: 250px; top:50px;  z-index: 99;" /> </div>'),e("#divSearchInput").mousedown(this.textInputClick),e("#divSearchInput").mouseup(this.textInputClick),e("#divSearchInput").mousemove(this.textInputClick),e("#divSearchInput").click(this.textInputClick),e("#divSearchInput").keyup(this.textInputChange)},API.prototype.textInputClick=function(e){console.log("click"),e.stopPropagation()},API.prototype.textInputChange=function(t){if(13==t.keyCode){var i=e("#searchInput").val();if(parseFloat(i.substring(3,4))>=0){var o=i.split(" ");r.goToClosestPosition({x:o[0],y:0,z:o[1]},{distance:250})}else i.indexOf("_")>0?r.loadPanoFromNameAndLookAtIntersection(i):s.sendOLSRequest(i,!1)}},API}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(2),r(11),r(3),r(21),r(5),r(1),r(7),r(17),r(15),r(37),r(8),r(22),r(9),r(43),r(4),r(39),r(10)],o=function(e,t,i,o,n,a,s,l,c,h,u,p,d,f,m,v,g){function y(e){S[e.button]=!0,A=e.clientX,P=e.clientY,T=e.clientX,C=e.clientY,onPointerDownPointerX=e.clientX,onPointerDownPointerY=e.clientY;1==S[2];if(!e.ctrlKey&&o.btnSwitchPoint&&2===e.button||o.btnSwitchPoint&&e.shiftKey){var t=i.getZero(),r=o.getXYZFromClick2D(A,P);N.push(r);var n=s.drawSphereAt(r,.04,16442209,!0),a=r.x+parseFloat(t.x),l=r.y+parseFloat(t.y),c=r.z+parseFloat(t.z),h="E:"+a.toFixed(2)+",N:"+c.toFixed(2)+",h:"+l.toFixed(2)+",id:"+n,u={x:r.x,y:r.y+.25,z:r.z};s.addTextPanel(h,u,G),p.setLastMeasure({x:a,y:l,z:c}),g.send("MEASURE")}(o.btnSwitchLine&&2===e.button&&!e.shiftKey||o.btnSwitchLine&&0===e.button&&e.shiftKey)&&(U=o.getXYZFromClick2D(A,P)),e.altKey||(e.ctrlKey&&2===e.button?o.btnSwitchVolume||o.estimateWidth(A,P,"Move"):o.btnSwitchVolume&&(2===e.button||e.shiftKey)&&(0==s.tabBoundingBox.length?(U=o.getXYZFromClick2D(A,P),s.tabBoundingBox.push(U)):2!=s.tabBoundingBox.length||s.drawBB?1==s.drawBB&&(s.drawBB2=!0):s.drawBB=!0))}function x(t){var r=1==S[2];if(S[t.button]=!1,s.drawBB2)s.BBCreated=!1,s.drawBB2=!1,s.drawBB=!1,s.tabBoundingBox=[],o.checkAllPointsInBB(s.ptAtemp,s.ptBtemp,s.ptCtemp,s.ptDtemp,s.alphaBB,s.heightBB),s.ptAtemp.add(i.getZeroAsVec3D()),s.ptBtemp.add(i.getZeroAsVec3D()),s.ptCtemp.add(i.getZeroAsVec3D()),s.ptDtemp.add(i.getZeroAsVec3D());else{if(o.btnSwitchLine&&!t.ctrlKey&&null!==U&&null!==O){if(-1!==O.y&&-1!==U.y&&O.y&&U.y){var n=U.distanceTo(O).toFixed(2);if(80>n){s.drawOneMoreLine(U,O);var c=100*Math.abs(O.y-U.y)/Math.sqrt((O.x-U.x)*(O.x-U.x)+(O.z-U.z)*(O.z-U.z));c>200&&(c=200),s.showTextAtPos3D(n+"m "+c.toFixed(1)+"%",O,40);var h=i.getZero(),u=new a.Vector3(U.x+parseFloat(h.x),U.y+parseFloat(h.y),U.z+parseFloat(h.z)),p=new a.Vector3(O.x+parseFloat(h.x),O.y+parseFloat(h.y),O.z+parseFloat(h.z));e.showLineMeasureOnMap(u,p,e.getLaserLayer(),"EPSG:2154",{strokeWidth:1.5,strokeColor:"#aaff0f"})}}U=null,O=null}mouseXOnMouseUp=t.clientX,mouseYOnMouseUp=t.clientY,"RGE"!=l.getCurrentObject().name||r||mouseXOnMouseUp!=A||mouseYOnMouseUp!=P||t.shiftKey||(d.getVisibility()?M(s.getSurfaceType()):(M("Circle"==s.getSurfaceType()?"SkyToGround":s.getSurfaceType()),i.setBase3DGlasses(6),d.tweenGeneralOpacityUp(),d.setVisibility(!0),l.setSkyBoxVisibility(!1)))}t.ctrlKey&&2===t.button&&!o.btnSwitchVolume&&o.estimateWidth(mouseXOnMouseUp,mouseYOnMouseUp,"Stay"),z=!1}function w(e){e.preventDefault(),console.log(e.originalEvent.wheelDelta,e.originalEvent.detail);var t=e.originalEvent.wheelDelta/120,r=-1!=navigator.userAgent.indexOf("Firefox");if(r&&(t=-e.originalEvent.detail/3),i.cameraZoom(-5*t),g.send("ZOOM"),s.setSurfaceScaleAndOpacity(i.getCameraFov()/120),null!==W&&e.shiftKey){var o=.12,n=e.originalEvent.wheelDeltaX/12e3;W.fontPlane.scale.x+=n,W.fontPlane.scale.y+=n,W.cssPlane.scale.x+=n-n*o,W.cssPlane.scale.y+=n-n*o}}function b(e){var t=e.clientX,r=e.clientY;if(S[0]!==!0||e.shiftKey){if("RGE"==l.getCurrentObject().name&&F&&!e.ctrlKey){var n=l.getCurrentMeshForClickAndGo(),c=l.getMeshFES();E=i.getIntersected(e.clientX,e.clientY,[n,c]),E[0]&&(D=new a.Vector3(E[0].point.x,E[0].point.y,E[0].point.z),s.drawSurface(D,E[0].face.normal))}}else if(z=!0,e.altKey){var h=(t-T)*I,u=-(r-C)*I;i.getCamera().translateOnAxis(new a.Vector3(1,0,0),h),i.getCamera().translateOnAxis(new a.Vector3(0,0,1),u);var p=i.getCamera().position.x,d=i.getCamera().position.z;i.getCamera().translateOnAxis(new a.Vector3(1,0,0),-h),i.getCamera().translateOnAxis(new a.Vector3(0,0,1),-u),i.translateCameraSmoothly(p,i.getTranslatCam().y,d)}else{var f=i.getAngleCameraLat(),m=i.getAngleCameraLon(),v=f+(C-e.clientY)*L,y=m+(T-e.clientX)*L;v>-1.57&&1.57>v&&(f=v),m=y,i.setCameraLonLatAngle(m,f);var x=i.getTargetDist(),w=-x*Math.sin(m),b=-x*Math.cos(m),_=x*Math.tan(f);i.setWantedCamRotation(w,_,b),g.send("ORIENTATION"),T=e.clientX,C=e.clientY}if(o.btnSwitchLine&&2===e.button&&!e.shiftKey||o.btnSwitchLine&&0===e.button&&e.shiftKey)if(O=o.getXYZFromClick2D(t,r),-1!==O.y&&-1!==U.y&&O.y&&U.y){var M=U.distanceTo(O).toFixed(2);if(80>M){s.drawLine(U,O);var A=100*Math.abs(O.y-U.y)/Math.sqrt((O.x-U.x)*(O.x-U.x)+(O.z-U.z)*(O.z-U.z));A>200&&(A=200),s.showTextAtPos3DSameMesure(M+"m "+A.toFixed(1)+"%",O,40),B=O}}else null!=B&&(O=B);if(e.ctrlKey&&2===e.button&&!o.btnSwitchVolume&&o.estimateWidth(t,r,"Move"),o.btnSwitchVolume&&2===e.button||o.btnSwitchVolume&&e.shiftKey)if(s.drawBB)if(s.drawBB2)s.heightBB=(onPointerDownPointerY-r)/10,s.drawBBTemp(s.ptAtemp,s.ptBtemp,s.ptCtemp,s.ptDtemp,s.heightBB);else{var P=(t-onPointerDownPointerX)/10,V=s.tabBoundingBox[0],R=s.tabBoundingBox[1],N=V.x+Math.cos(s.alphaBB+1.57)*P,k=V.z+Math.sin(s.alphaBB+1.57)*P,G=V.y,j=new a.Vector3(N,G,k),W=R.x+Math.cos(s.alphaBB+1.57)*P,H=R.z+Math.sin(s.alphaBB+1.57)*P,X=R.y,q=new a.Vector3(W,X,H);s.ptAtemp=V,s.ptBtemp=R,s.ptCtemp=j,s.ptDtemp=q,s.drawBBTemp(V,R,j,q,0)}else 1==s.tabBoundingBox.length?s.tabBoundingBox.push(o.getXYZFromClick2D(t,r)):2==s.tabBoundingBox.length&&(s.tabBoundingBox[1]=o.getXYZFromClick2D(t,r),s.drawBBTemp(s.tabBoundingBox[0],s.tabBoundingBox[1],s.tabBoundingBox[0],s.tabBoundingBox[1],0)),s.alphaBB=Math.atan2(s.tabBoundingBox[1].z-s.tabBoundingBox[0].z,s.tabBoundingBox[1].x-s.tabBoundingBox[0].x);if(!(e.ctrlKey||e.altKey||2!==e.button||o.btnSwitchVolume||o.btnSwitchLine)){var h=-(t-T)*I*2*i.getCamera().position.y/10,u=(r-C)*I*6*i.getCamera().position.y/10;i.getCamera().translateOnAxis(new a.Vector3(1,0,0),h),i.getCamera().translateOnAxis(new a.Vector3(0,0,1),u);var p=i.getCamera().position.x,d=i.getCamera().position.z;i.getCamera().translateOnAxis(new a.Vector3(1,0,0),-h),i.getCamera().translateOnAxis(new a.Vector3(0,0,1),-u),i.translateCameraSmoothly(p,i.getTranslatCam().y,d)}}function _(e){switch(console.log("key Down"),e.keyCode){case 38:i.getTranslatCam().y+=1*I*33;break;case 40:i.getTranslatCam().y-=1*I*33}}function M(e){var r=D.clone().add(i.getZeroAsVec3D());t.goToClosestPosition(r,{intersectionToLook:D.clone(),surfaceType:e,distance:30})}var S={0:!1,1:!1,2:!1},T=null,C=null,L=null,A=null,P=null,D=null,F=!0,E=null,V=!1,R=!1,z=!1,I=.03,U=null,O=null,B=null,N=[],k=null,G={style:{fontSize:76},delimiter:",",name:"geoLocation"},j=new a.Vector3(0,0,0),W=null,H={init:function(e,t,r,o){function a(e,t){R||(R=!0,H.moveTowardDirection()),H.deviceOrientationHandler(t.LR,t.FB,t.DIR)}var s=n(i.getContainerID());n(s).mousedown(y),n(s).mousemove(b),n(s).mouseup(x),n(s).bind("mousewheel onwheel DOMMouseScroll ",w),n(s).bind("contextmenu",function(e){return!1}),n(s).keydown(_),L=r||.002,I=o||I,k=i.getZero(),i.getNodeControllerOn()&&(_socketIO=io.connect("http://labuat.homepc.it:8088"),_socketIO.on("user message",a)),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(console.log("You're on a mobile"),window.DeviceOrientationEvent&&(console.log("DeviceOrientation is supported"),window.addEventListener("deviceorientation",function(e){var t=e.gamma,r=e.beta,i=e.alpha;H.deviceOrientationHandlerSAVE(t,r,i)},!1)))},deviceOrientationHandler:function(t,r,o){if(777!=t){Math.abs(t)<5&&(t=0),Math.abs(r)<5&&(r=0);var n=i.getAngleCameraLat(),a=i.getAngleCameraLon(),s=n-r/180*Math.PI*2*L*27,l=a+t/360*Math.PI*2*L*75;s>-1.57&&1.57>s&&(n=s),a=l,i.setCameraLonLatAngle(a,n);var c=i.getTargetDist(),h=-c*Math.sin(a),u=-c*Math.cos(a),p=c*Math.tan(n);i.setWantedCamRotation(h,p,u),e.rotatePositionMarker(a),V=o}},moveTowardDirection:function(){if(V){var e=14,t=0,r=e,o=e;i.getCamera().translateOnAxis(new a.Vector3(1,0,0),t),i.getCamera().translateOnAxis(new a.Vector3(0,0,1),r),i.getCamera().translateOnAxis(new a.Vector3(0,1,0),o);var n=i.getCamera().position.x,s=i.getCamera().position.z,l=i.getCamera().position.y;i.getCamera().translateOnAxis(new a.Vector3(1,0,0),-t),i.getCamera().translateOnAxis(new a.Vector3(0,0,1),-r),i.getCamera().translateOnAxis(new a.Vector3(0,1,0),-o),i.translateCameraSmoothly(n,l,s)}requestAnimSelectionAlpha(this.moveTowardDirection.bind(this))},deviceOrientationHandlerSAVE:function(t,r,o){if(window.innerWidth>window.innerHeight&&window.innerWidth<1200){var n=t;t=r,r=-n}Math.abs(t+4)<5&&(t=-4),Math.abs(54-r)<5&&(r=54);var a=i.getAngleCameraLat(),s=i.getAngleCameraLon(),l=a+(54-r)/180*Math.PI*2*L*18,c=s+(t+4)/360*Math.PI*2*L*50;l>-1.57&&1.57>l&&(a=l),s=c,i.setCameraLonLatAngle(s,a);var h=i.getTargetDist(),u=-h*Math.sin(s),p=-h*Math.cos(s),d=h*Math.tan(a);i.setWantedCamRotation(u,d,p),T=event.clientX,C=event.clientY,e.rotatePositionMarker(s)},setSensitivy:function(e){L=e},setMoveSpeed:function(e){I=e},setPointLineMesure:function(e,t){U=e,O=t},playWithLight:function(){j.x<1?(j.x+=.01,j.z+=.02):(j.x=0,j.z=0),r(14).setLightPosition(j),requestAnimSelectionAlpha(this.playWithLight.bind(this))}};return H}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[],o=function(){var e=function(e,r,i){var o=new FileReader;o.onload=function(e){var i=new t(o.result);r(i)},o.readAsArrayBuffer(e)},t=function(e){this.rawData=e,this.header=this.loadHeaderFromFile()};return t.prototype={loadHeaderFromFile:function(){var e=this.rawData,t=function(){var t=new DataView(e,0,90);return u.sourceId=t.getUint16(4),u.globalEncoding=t.getUint16(6),u.id_guid_data1=t.getUint32(8),u.id_guid_data2=t.getUint16(12),u.id_guid_data3=t.getUint16(14),u.versionMajor=t.getUint8(24),u.versionMinor=t.getUint8(25),u.systemId="",u.generatingSoftware="",90},r=function(t){var r=new DataView(e,t,4);return u.fileCreationDayOfYear=r.getUint16(0,!0),u.fileCreationYear=r.getUint16(2,!0),t+4},i=function(t){var r=new DataView(e,t,13);return u.headerSize=r.getUint16(0,!0),u.offsetToPointData=r.getUint32(2,!0),u.numberOfVLR=r.getUint32(6,!0),u.pointDataRecordFormat=r.getUint8(10,!0),u.pointDataRecordLength=r.getUint16(11,!0),t+13},o=function(t,r){for(var i=new DataView(e,t,24),o=i.getUint32(0,!0),n=[],a=4,s=0;5>s;s++)n.push(i.getUint32(a,!0)),a+=4;return r?(u.numberOfPointRecords=o,u.numberOfPointsByReturn=n):(u.legacyNumberOfPointRecords=o,u.legacyNumberOfPointsByReturn=n),t+a},n=function(t){var r=new DataView(e,t,96);return u.XScaleFactor=r.getFloat64(0,!0),u.YScaleFactor=r.getFloat64(8,!0),u.ZScaleFactor=r.getFloat64(16,!0),u.XOffset=r.getFloat64(24,!0),u.YOffset=r.getFloat64(32,!0),u.ZOffset=r.getFloat64(40,!0),u.maxX=r.getFloat64(48,!0),u.minX=r.getFloat64(56,!0),u.maxY=r.getFloat64(64,!0),u.minY=r.getFloat64(72,!0),u.maxZ=r.getFloat64(80,!0),u.minZ=r.getFloat64(88,!0),t+96},a=function(t){var r=new DataView(e,t,124);u.startOfEVLR=r.getUint32(t+8,!0),u.numberOfPointByRecord=[];for(var i=4,o=0;15>o;o++)u.numberOfPointByRecord.push(r.getUint32(i,!0)*Math.pow(2,32)+r.getUint32(i+4,!0)),i+=8;return t+i},s=function(e){return e=r(e),e=i(e),e=o(e,!0),e=n(e)},l=function(e){e=s(e)},c=function(t){t=l(t);var r=new DataView(e,t,8);return u.startOfWaveFormDataPacketRecord=r.getUint32(t,!0)*Math.pow(2,32)+r.getUint32(t+4,!0),t+8},h=function(t){t=r(t),t=i(t),t=o(t,!1),t=n(t);var s=new DataView(e,t,8);return u.startOfWaveFormDataPacketRecord=s.getUint32(t,!0)*Math.pow(2,32)+s.getUint32(t+4,!0),t+=8,t=a(t)},u={},p=t();if(1===u.versionMajor)switch(u.versionMinor){case 0:p=getHeaderRevision1_0(p);break;case 1:p=s(p);break;case 2:p=l(p);break;case 3:p=c(p);break;case 4:p=h(p)}return u},getRawPointData:function(e){var t=this.header.offsetToPointData+e*this.header.pointDataRecordLength,r={};return r.X=t,r.Y=t+4,r.Z=t+8,r.intensity=t+12,r},getPointData:function(e){function t(e){return c.red=l.getUint16(e,!0),c.green=l.getUint16(e+2,!0),c.blue=l.getUint16(e+4,!0),e+6}function r(e){return c.wavePacketDescriptorIdx=l.getInt8(e,!0),c.byteOffsetToWaveFormData1=l.getUint32(e+1,!0),c.byteOffsetToWaveFormData2=l.getUint32(e+5,!0),c.waveFormPacketSizeInBytes=l.getUint32(e+9,!0),c.returnPointWaveformLocation=l.getFloat32(e+13,!0),c.Xt=l.getFloat32(e+17,!0),c.Yt=l.getFloat32(e+21,!0),c.Zt=l.getFloat32(e+25,!0),e+29}var i=this.header.offsetToPointData+e*this.header.pointDataRecordLength,o=1,n=2,a=4,s=8,l=new DataView(this.rawData,i,this.header.pointDataRecordLength),c={},h=function(){c.X=l.getInt32(0,!0),c.Y=l.getInt32(4,!0),c.Z=l.getInt32(8,!0),c.intensity=l.getUint16(12,!0);var e=l.getUint8(14,!0);return c.returnNumber=e&(o|n|a),c.numberOfReturns=e>>3&(o|n|a),c.scanDirectionFlag=e>>6&o,c.edgeOfFlightLine=e>>7&o,c.classification=l.getUint8(15,!0),c.scanAngleRank=l.getInt8(16,!0),c.userData=l.getUint8(17,!0),c.pointSourceID=l.getUint16(18,!0),20},u=function(){var e=h();return c.gpsTime=l.getFloat64(e,!0),e+8},p=function(){var e=h();return e=t(e)},d=function(){var e=h();return c.gpsTime=l.getFloat64(e,!0),e=t(e+8)},f=function(){var e=u();return e=r(e)},m=function(){var e=d();return e=r(e)},v=function(){c.X=l.getInt32(0,!0),c.Y=l.getInt32(4,!0),c.Z=l.getInt32(8,!0),c.intensity=l.getUint16(12,!0);var e=l.getUint8(14,!0);c.returnNumber=e&(o|n|a|s),c.numberOfReturns=e>>4&(o|n|a|s);var t=l.getUint8(15,!0);return c.classificationFlags=t&(o|n|a|s),c.scannerChannel=t>>4&(o|n),c.scanDirectionFlag=t>>6&o,c.edgeOfFlightLine=t>>7&o,c.classification=l.getUint8(16,!0),c.userData=l.getUint8(17,!0),c.scanAngleRank=l.getInt16(18,!0),c.pointSourceID=l.getUint16(20,!0),c.gpsTime=l.getFloat64(22,!0),30},g=function(){var e=v();return e=t(e)},y=function(){var e=g();return c.nir=l.getUint16(e,!0),e+2},x=function(){var e=v();return e=r(e)},w=function(){var e=y();return e=r(e)},b={0:h,1:u,2:p,3:d,4:f,5:m,6:v,7:g,8:y,9:x,10:w};return b[this.header.pointDataRecordFormat](),c}},{LasReader:t,lasLoader:e}}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(3),r(1),r(8),r(12),r(4),r(7)],o=function(e,t,i,o,n,a){window.requestAnimSelectionAlpha=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var s=!1,l=1,c=null,h=[],u=[],p=[],d=[],f=[],m=new RegExp("-[0-9][0-9]-"),v=0,g=new t.Vector4(0,0,0,1),y=null,x=new t.Matrix4(1129.284,0,0,0,0,1129.284,0,0,1042.178,1020.435,0,1,0,0,0,0),w=null,b=new t.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),_={imgName:"",nbL2Loaded:0,init:function(r){v=e.isMobileEnvironment()?1:0;var i=new t.Vector3(1621404.789,8173125.316,2295.63),o=.145,n=.157,a=-32.5938,l=new OpenLayers.Projection("EPSG:2154"),c=new OpenLayers.Projection("EPSG:3949"),h=new OpenLayers.Geometry.Point(i.x,i.y);h=h.transform(c,l),console.log(h),this.initPosOrientationCameraMatrice(0,0,0,o,n,a),this.initMatrices(),this.initTranslations(h,i.z),s=!0,this.createShaderForImage()},initPosOrientationCameraMatrice:function(e,r,i,o,n,a){o=parseFloat(o)/180*Math.PI,n=parseFloat(n)/180*Math.PI,a=parseFloat(a)/180*Math.PI;var s=new t.Matrix4;s.makeRotationFromEuler(new t.Euler(a,0,0,"ZYX")),y=s},computeMatOriFromHeadingPitchRoll:function(e,r,i){e=parseFloat(e)/180*Math.PI,r=parseFloat(r)/180*Math.PI,i=parseFloat(i)/180*Math.PI,console.log("heading,pitch,roll ",e,r,i);var o=new t.Quaternion;o.setFromEuler(new t.Euler(i,e,r,"YXZ"),!0);var n=(new t.Matrix4).makeRotationFromQuaternion(o);return n},getProjCam:function(e){x=new t.Matrix4(200,0,0,0,0,200,0,0,200,200,0,1,0,0,0,0)},initMatrices:function(){w=(new t.Matrix4).multiplyMatrices(y,x).transpose(),console.log("_matMVP",w)},initTranslations:function(r,i){var o=e.getZeroAsVec3D();g=new t.Vector4(r.x-o.x,i-o.y,r.y-o.z),console.log(g),a.drawSphereAt(g,20)},initImages:function(){for(var e=0;10>e;++e){var t=new Image;t.crossOrigin="anonymous",h.push(t),p.push(b)}},createShaderForImage:function(e,r){var i=new t.Vector4(0,0,0,0),n={intrinsic300:{type:"v4",value:i},alpha:{type:"f",value:l},fog:{type:"i",value:0},mvpp_current_0:{type:"m4",value:w},factorTranslation0:{type:"v4",value:g},texture0:{type:"t",value:t.ImageUtils.loadTexture("http://www.itowns.fr/casqy/obliques/499_1286S.jpg")}};return c=new t.ShaderMaterial({uniforms:n,vertexShader:o.shaders["shaderTextureProjectivePhoto.vs"],fragmentShader:o.shaders["shaderTextureProjectivePhoto.fs"],side:t.BackSide,transparent:!0})},changePanoTextureAfterloading:function(e,t,i,o,n,a){this.imgName=e,this.nbL2Loaded=0,r(14).tweenGeneralOpacity(),this.chargeOneImageCam(e,"texture1",1,t,i,o,n,6,a),this.chargeOneImageCam(e,"texture2",2,t,i,o,n,7,a),this.chargeOneImageCam(e,"texture3",3,t,i,o,n,8,a),this.chargeOneImageCam(e,"texture4",4,t,i,o,n,9,a),this.chargeOneImageCam(e,"texture0",0,t,i,o,n,5,a)},changePanoTextureAfterloadingTurboTruckMode:function(e,t,r,i,o,n){this.imgName=e,this.nbL2Loaded=0,this.chargeOneImageCam(e,"texture1",1,512,85,i,o,6,0)},chargeOneImageCam:function(e,r,o,n,a,s,l,h,p){0==v&&(c.uniforms[r].value=c.uniforms[r+"bis"].value,c.uniforms["factorTranslation"+o].value=u[h],c.uniforms["mvpp_current_"+o].value=d[h]);var g=s.clone().add(i.getSommet(300+o).clone().applyProjection(l.clone()));g.w=1,u[h]=g,d[h]=(new t.Matrix4).multiplyMatrices(l.clone(),f[h-5].clone()).transpose();var y=new Image;y.crossOrigin="anonymous";var x=this;y.onload=function(){c.uniforms["indice_time"+o].value=.8,c.uniforms["mvpp_current_"+o+"bis"].value=d[h],c.uniforms["factorTranslation"+o+"bis"].value=g,c.uniforms[r+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),c.uniforms[r+"bis"].value.needsUpdate=!0,1==p&&x.changeQuality(e,r,o,512,a,h)},y.src="http://www.itowns.fr/cgi-bin/iipsrv.fcgi?FIF=/iipimagesV2/"+e.replace(m,"-30"+o+"-")+".jp2&WID="+n+"&QLT="+a+"&CVT=JPEG"},changeQuality:function(r,i,o,n,a){var s=this,l=new Image;l.crossOrigin="anonymous",l.src="http://www.itowns.fr/cgi-bin/iipsrv.fcgi?FIF=/iipimagesV2/"+r.replace(m,"-30"+o+"-")+".jp2&WID="+n+"&QLT="+a+"&CVT=JPEG",l.onload=function(){c.uniforms[i+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),c.uniforms[i+"bis"].value.needsUpdate=!0,50==a&&s.nbL2Loaded++,.1!=e.getSpeedTurnCam()&&3==o&&e.setSpeedTurnCam(.1)}},changeQualitySerial:function(e,r,i,o){var n=e.shift(),a="texture"+n,s=this,l=new Image;l.crossOrigin="anonymous",l.src="http://www.itowns.fr/cgi-bin/iipsrv.fcgi?FIF=/iipimagesV2/"+r.replace(m,"-30"+n+"-")+".jp2&WID="+i+"&QLT="+o+"&CVT=JPEG",l.onload=function(){s.imgName==r&&(h[parseInt(n)+5]=this,c.uniforms[a+"bis"].value=new t.Texture(this,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBFormat),c.uniforms[a+"bis"].value.needsUpdate=!0,50==o&&s.nbL2Loaded++,e.length>0&&s.changeQualitySerial(e,r,i,o))}},loadQualityLevel:function(e,t,r){setTimeout(function(){ProjectiveTexturing2.loadQualityLevelNowSerial(e,t,r)},2e3)},loadQualityLevelNowSerial:function(e,t,r){if(this.imgName==r){console.log(this.imgName),console.log("load level3");var i=["0","1","2","3","4"];this.changeQualitySerial(i,this.imgName,e,t)}},groundToImage:function(e){var r,i=e.clone().sub(c.uniforms.factorTranslation0bis.value),o=e.clone().sub(c.uniforms.factorTranslation1bis.value),n=e.clone().sub(c.uniforms.factorTranslation2bis.value),a=e.clone().sub(c.uniforms.factorTranslation3bis.value),s=e.clone().sub(c.uniforms.factorTranslation4bis.value),l=c.uniforms.mvpp_current_0bis.value.multiplyVector4(new t.Vector4(i.x,i.y,i.z,1)),h=c.uniforms.mvpp_current_1bis.value.multiplyVector4(new t.Vector4(o.x,o.y,o.z,1)),u=c.uniforms.mvpp_current_2bis.value.multiplyVector4(new t.Vector4(n.x,n.y,n.z,1)),p=c.uniforms.mvpp_current_3bis.value.multiplyVector4(new t.Vector4(a.x,a.y,a.z,1)),d=c.uniforms.mvpp_current_4bis.value.multiplyVector4(new t.Vector4(s.x,s.y,s.z,1)),f=this.correctDistortionAndCoord(c.uniforms.intrinsic300.value,l.clone()),m=this.correctDistortionAndCoord(c.uniforms.intrinsic301.value,h.clone()),v=this.correctDistortionAndCoord(c.uniforms.intrinsic302.value,u.clone()),g=this.correctDistortionAndCoord(c.uniforms.intrinsic303.value,p.clone()),y=this.correctDistortionAndCoord(c.uniforms.intrinsic304.value,d.clone());f.x>0&&f.y>0&&f.z>0?(r=f,r.z=0):m.x>0&&m.y>0&&m.z>0?(r=m,r.z=1):v.x>0&&v.y>0&&v.z>0?(r=v,r.z=2):g.x>0&&g.y>0&&g.z>0?(r=g,r.z=3):y.x>0&&y.y>0&&y.z>0&&(r=y,r.z=4);var x=new RegExp("-[0-9][0-9]-");console.log(this.imgName);var w=this.imgName.replace(x,"-30"+r.z+"-").replace(/^.*[\\\/]/,""),b={i:2048*r.x,j:2048*r.y,imgName:w};return b},correctDistortionAndCoord:function(e,r){var i=1042.178,o=1020.435,n=2048,a=2048,s=new t.Vector3(r.x/r.w-i,r.y/r.w-o,0),l=s.dot(s);if(l>e.w)return new t.Vector3(-2,-2,-2);var c=l*(e.x+l*(e.y+l*e.z)),h=new t.Vector3(r.x/r.w+c*s.x,r.y/r.w+c*s.y,0);return new t.Vector3(h.x/n,1-h.y/a,r.w)},changeDistortion:function(){0!=c.uniforms.r3.value?(c.uniforms.r3.value=0,c.uniforms.r5.value=0,c.uniforms.r7.value=0,c.uniforms.r30.value=0,c.uniforms.r50.value=0,c.uniforms.r70.value=0):(c.uniforms.r3.value=-1.414241e-7,c.uniforms.r5.value=3.56829e-14,c.uniforms.r7.value=-4.239262e-21,c.uniforms.r30.value=-1.335994e-7,c.uniforms.r50.value=3.335513e-14,c.uniforms.r70.value=-3.928705e-21),c.uniforms.r3.value.needsUpdate=!0,c.uniforms.r5.value.needsUpdate=!0,c.uniforms.r7.value.needsUpdate=!0,c.uniforms.r30.value.needsUpdate=!0,c.uniforms.r50.value.needsUpdate=!0,c.uniforms.r70.value.needsUpdate=!0},changeBlending:function(){1==c.uniforms.blendingOn.value?c.uniforms.blendingOn.value=0:c.uniforms.blendingOn.value=1,c.uniforms.blendingOn.value.needsUpdate=!0},getShaderMat:function(){return c},isInitiated:function(){return s},tweenGeneralOpacity:function(){console.log(" tweenGeneralOpacity");var e=c.uniforms.alpha.value;e>0&&(e-=.02*(1-(e-.01)),0>e&&(e=0),c.uniforms.alpha.value=e),requestAnimSelectionAlpha(this.tweenGeneralOpacity.bind(this))},tweenGeneralOpacityUp:function(){var e=c.uniforms.alpha.value;1>e&&(e+=.04*(e+.01),e>1&&(e=1),c.uniforms.alpha.value=e,requestAnimSelectionAlpha(this.tweenGeneralOpacityUp.bind(this)))},setGeneralOpacity:function(e){l=e,c.uniforms.alpha.value=l},setFogValue:function(e){c.uniforms.fog.value=e},tweenAllIndiceTimes:function(){this.tweenIndiceTime(0),this.tweenIndiceTime(1),this.tweenIndiceTime(2),this.tweenIndiceTime(3),this.tweenIndiceTime(4),5==this.nbL2Loaded&&0==v&&(this.nbL2Loaded=0,this.loadQualityLevel(2048,80,this.imgName)),requestAnimSelectionAlpha(this.tweenAllIndiceTimes.bind(this))},tweenIndiceTime:function(e){var t=c.uniforms["indice_time"+e].value;t>0&&(t-=.08*(1-(t-.01)),0>t&&(t=0),c.uniforms["indice_time"+e].value=t)},setIndiceTimeCam:function(e,t){c.uniforms["indice_time"+e].value=t},setRotationHeading:function(e){b=e}};return _}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1),r(4),r(20)],o=function(e,t,r){return Sensor=function(t,i){this.infos=i,this.position=(new e.Vector3).fromArray(i.position),this.rotation=(new e.Matrix4).fromArray(i.rotation).transpose(),this.projection=(new e.Matrix4).fromArray(i.projection).transpose(),this.pps=(new e.Vector2).fromArray(i.distortion.pps);var o=(new e.Vector3).fromArray(i.distortion.poly357),n=this.getDistortion_r2max(o);this.distortion=new e.Vector4(o.x,o.y,o.z,n),this.mask=i.mask?e.ImageUtils.loadTexture(r.resolve(t,i.mask)):void 0,this.orientation=i.orientation,this._itownsWay=new e.Matrix4(0,1,0,0,0,0,-1,0,1,0,0,0,0,0,0,1),this.Photogram_JMM=new e.Matrix4(0,0,-1,0,-1,0,0,0,0,1,0,0,0,0,0,1),this.photgramme_image=new e.Matrix4(1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1),this.rotation=this.getMatOrientationTotal(),this.position.applyProjection(this._itownsWay)},Sensor.prototype.getDistortion_r2max=function(e){var r=t.cardan_cubic_roots(7*e.z,5*e.y,3*e.x,1),i=-1;for(var o in r)r[o]>0&&(-1==i||r[i]>r[o])&&(i=o);return-1==i?1/0:r[i]},Sensor.prototype.getMatOrientationTotal=function(){var t=new e.Matrix4;return t=this.rotation.clone(),t=(new e.Matrix4).multiplyMatrices(t.clone(),this.Photogram_JMM.clone()),t=(new e.Matrix4).multiplyMatrices(t.clone(),this.getMatOrientationCapteur().clone()),t=(new e.Matrix4).multiplyMatrices(t.clone(),this.photgramme_image.clone()),t=(new e.Matrix4).multiplyMatrices(this._itownsWay,t.clone())},Sensor.prototype.getMatOrientationCapteur=function(){var t=new e.Matrix4(0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1),r=new e.Matrix4(0,1,0,0,-1,0,0,0,0,0,1,0,0,0,0,1),i=new e.Matrix4(-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),o=new e.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);switch(this.orientation){case 0:return t;case 1:return r;case 2:return i;case 3:return o}},Sensor}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(3),r(5),r(6),r(1),r(4),r(8),r(24),r(7),r(16),r(2)],o=function(e,t,r,i,o,n,a,s,l){var c,h,u,p={init:function(t){t=t||"http://www.itowns.fr/nokiaHere/images/pano1.jpg",c=new i.SphereGeometry(500,32,32),h=new i.MeshBasicMaterial({map:i.ImageUtils.loadTexture(t)}),h.side=i.DoubleSide,u=new i.Mesh(c,h),e.addToScene(u)},setEquirectangularImage:function(e){h.map=i.ImageUtils.loadTexture(e)},setOrientation:function(e){},setHeading:function(e){u.rotation.y=e/180*Math.PI-Math.PI/2},setPitch:function(e){u.rotation.x=e/180*Math.PI},setRoll:function(e){u.rotation.z=e/180*Math.PI},computeSpecificMatOriFromHeadingPitchRoll:function(e,t,r){e=parseFloat(e)/180*Math.PI-Math.PI/2-.025,t=parseFloat(t)/180*Math.PI,r=parseFloat(r)/180*Math.PI,console.log("heading,pitch,roll ",e,t,r);var o=new i.Quaternion;o.setFromEuler(new i.Euler(r,e,t,"YXZ"),!0);var n=(new i.Matrix4).makeRotationFromQuaternion(o);return u.setRotationFromMatrix(n),n},computeSpecificMatOriFromHeadingPitchRollSAVE:function(e,t,r){e=parseFloat(e)/180*Math.PI-Math.PI/2,t=parseFloat(t)/180*Math.PI,r=parseFloat(r)/180*Math.PI;var o=new i.Quaternion;o.setFromEuler(new i.Euler(t,e,r,"YXZ"),!0);var n=(new i.Matrix4).makeRotationFromQuaternion(o);return u.setRotationFromMatrix(n),n}};return p}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1),r(25),r(26)],o=function(e,t,r){var i=function(t){this.decimalPrecision=3,this._materials={},this._unfinalized_objects={},this._textures={},this._cur_obj_end=0,this._cur_obj,this._cur_mat_end=0,this._cur_mat,this.totalFaces=0,this.pivot=new e.Vector3(0,0,0),this.dalle=t;var i=this,o=new XMLHttpRequest,n=t.getUrlDSFile();o.open("GET",n,!0),"ie"===r.browser&&r.version>="10"?o.responseType="blob":o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4===this.readyState)if(200===this.status||0===this.status)if("ie"===r.browser&&r.version>="10"){var e=new FileReader;e.onload=function(e){i.parse3DS(e.target.result)},e.readAsText(this.response,"x-user-defined")}else i.parse3DS(this.responseText);else console.log('Failed to load 3DS file "'+n+'".')},o.send()};return i.prototype.setDecimalPrecision=function(e){this.decimalPrecision=e},i.prototype.parseMaterial=function(e,t){for(var r={};e.tell()<t;){var i,o,n;switch(i=e.readUInt16(),o=e.readUInt32(),n=e.tell()+(o-6),i){case 40960:r.name=this.readNulTermString(e);break;case 40976:r.ambientColor=this.readColor(e);break;case 40992:r.diffuseColor=this.readColor(e);break;case 41008:r.specularColor=this.readColor(e);break;case 41040:r.transparency=this.readAmount(e,n);break;case 41089:r.twoSided=!0;break;case 41472:r.colorMap=this.parseTexture(e,n);break;case 41476:r.specularMap=this.parseTexture(e,n);break;default:e.seek(n)}}return r},i.prototype.readAmount=function(e,t){var r,i,o=0;switch(r=e.readUInt16(),i=e.readUInt32(),r){case 48:o=e.readUInt16()}return e.seek(t),o},i.prototype.readColor=function(e){var t,r,i,o,n;switch(t=e.readUInt16(),r=e.readUInt32(),t){case 16:i=255*e.readFloat32(),o=255*e.readFloat32(),n=255*e.readFloat32();break;case 17:i=e.readUInt8(),o=e.readUInt8(),n=e.readUInt8();break;default:e.skip(r-6)}return i<<16|o<<8|n;
},i.prototype.parseTexture=function(e,t){for(var r={};e.tell()<t;){var i,o;switch(i=e.readUInt16(),o=e.readUInt32(),i){case 41728:r.url=this.readNulTermString(e);break;default:e.skip(o-6)}}return this._textures[r.url]=r,r},i.prototype.readNulTermString=function(e){for(var t,r="";(t=e.readUInt8())>0;)r+=String.fromCharCode(t);return r},i.prototype.parseVertexList=function(t){var r=0,i=t.readUInt16();for(this._cur_obj.verts=new Array(i);i>r;){var o,n,a;o=t.readFloat32(),n=t.readFloat32(),a=t.readFloat32(),this._cur_obj.verts[r]=new e.Vector3(o,a,n),r++}},i.prototype.parseFaceList=function(t){var r=0,i=t.readUInt16();for(this._cur_obj.facesCount=i,this._cur_obj.indices=[],this._cur_obj.uvsIndexes=[];i>r;){var o,n,a;o=t.readUInt16(),n=t.readUInt16(),a=t.readUInt16(),this._cur_obj.indices.push(new e.Face3(o,a,n)),this._cur_obj.uvsIndexes.push(new e.Vector3(o,a,n)),r++,t.skip(2)}this._cur_obj.smoothingGroups=[];for(var s=0;s<this._cur_obj.facesCount;s++)this._cur_obj.smoothingGroups[s]=0},i.prototype.parseUVList=function(t){var r=0,i=t.readUInt16();for(this._cur_obj.uvs=[];i>r;){var o,n;o=t.readFloat32(),n=1-t.readFloat32(),this._cur_obj.uvs.push(new e.Vector2(o,n)),r+=1}},i.prototype.parseFaceMaterialList=function(e){for(var t=this.readNulTermString(e),r=e.readUInt16(),i=0,o=[],n=0;r>n;n++)o[n]=0;for(;i<o.length;)o[i++]=e.readUInt16();this._cur_obj.materials.push(t),this._cur_obj.materialFaces[t]=o},i.prototype.readTransform=function(t){var r,i,o,n,a,s,l,c,h,u,p,d,f,m,v,g;return r=t.readFloat32(),h=t.readFloat32(),a=t.readFloat32(),f=0,o=t.readFloat32(),p=t.readFloat32(),l=t.readFloat32(),v=0,i=t.readFloat32(),u=t.readFloat32(),s=t.readFloat32(),m=0,n=t.readFloat32(),d=t.readFloat32(),c=t.readFloat32(),g=1,new e.Matrix4(r,i,o,n,a,s,l,c,h,u,p,d,f,m,v,g)},i.prototype.parseObjectAnimation=function(e,t){for(var r,i,o,n,a,s;e.tell()<t;){var l,c;switch(l=e.readUInt16(),c=e.readUInt32(),l){case 45072:i=this.readNulTermString(e),e.skip(4),o=e.readInt16();break;case 45075:n=e.readFloat32(),s=e.readFloat32(),a=e.readFloat32(),0!==n&&0!==s&&this.pivot.set(n,a,s);break;default:e.skip(c-6)}}"$$$DUMMY"!=i&&this._unfinalized_objects.hasOwnProperty(i)&&(r=this._unfinalized_objects[i],delete this._unfinalized_objects[i])},i.prototype.parseSmoothingGroups=function(e){for(var t=this._cur_obj.facesCount,r=0;t>r;)this._cur_obj.smoothingGroups[r]=e.readUInt32(),r++},i.prototype.finalizeCurrentMaterial=function(){this._materials[this._cur_mat.name]=this._cur_mat,this._cur_mat=null},i.prototype.parse3DS=function(e){var r=new t(e);for(r.reset();!r.eof();){this._cur_mat&&r.tell()>=this._cur_mat_end?this.finalizeCurrentMaterial():this._cur_obj&&r.tell()>=this._cur_obj_end&&(this.dalle.parse3DSGeometry(this),this.totalFaces+=this._cur_obj.facesCount,this._unfinalized_objects[this._cur_obj.name]=this._cur_obj,this._cur_obj_end=Number.MAX_VALUE,this._cur_obj=null);var i,o,n;switch(i=r.readUInt16(),o=r.readUInt32(),n=r.tell()+(o-6),i){case 19789:continue;case 15677:continue;case 45056:continue;case 45055:this._cur_mat_end=n,this._cur_mat=this.parseMaterial(r,n);break;case 16384:this._cur_obj_end=n,this._cur_obj={},this._cur_obj.name=this.readNulTermString(r),this._cur_obj.materials=[],this._cur_obj.materialFaces=[];break;case 16640:this._cur_obj.type="mesh";break;case 16656:this.parseVertexList(r);break;case 16704:this.parseUVList(r);break;case 16672:this.parseFaceList(r);break;case 16688:this.parseFaceMaterialList(r);break;case 16736:this._cur_obj.transform=this.readTransform(r);break;case 45058:this.parseObjectAnimation(r,n);break;case 16720:this.parseSmoothingGroups(r);break;default:r.skip(o-6)}}r.eof()&&(this.dalle.parseDallePivot(this.pivot),this.dalle.showDalleInScene(),this.dalle.emptyGeometryCache(),this.dalle.emptyMaterialsCache(),console.log("3DS object was loaded !"),console.log(" totalFaces="+this.totalFaces))},i.prototype.decimalPrecision=3,i}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1),r(25),r(26)],o=function(e,t,r){var i=function(t){this.decimalPrecision=3,this._materials={},this._unfinalized_objects={},this._textures={},this._cur_obj_end=0,this._cur_obj,this._cur_mat_end=0,this._cur_mat,this.totalFaces=0,this.pivot=new e.Vector3(0,0,0),this.dalle=t;var i=this,o=new XMLHttpRequest,n=t.getUrlDSFile();o.open("GET",n,!0),"ie"===r.browser&&r.version>="10"?o.responseType="blob":o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4===this.readyState)if(200===this.status||0===this.status)if("ie"===r.browser&&r.version>="10"){var e=new FileReader;e.onload=function(e){i.parseB3D(e.target.result)},e.readAsText(this.response,"x-user-defined")}else i.parseB3D(this.responseText);else console.log('Failed to load B3D file "'+n+'".')},o.send()};return i.prototype.setDecimalPrecision=function(e){this.decimalPrecision=e},i.prototype.parseMaterial=function(e,t){for(var r={};e.tell()<t;){var i,o,n;switch(i=e.readUInt16(),o=e.readUInt32(),n=e.tell()+(o-6),i){case 40960:r.name=this.readNulTermString(e);break;case 40976:r.ambientColor=this.readColor(e);break;case 40992:r.diffuseColor=this.readColor(e);break;case 41008:r.specularColor=this.readColor(e);break;case 41040:r.transparency=this.readAmount(e,n);break;case 41089:r.twoSided=!0;break;case 41472:r.colorMap=this.parseTexture(e,n);break;case 41476:r.specularMap=this.parseTexture(e,n);break;default:e.seek(n)}}return r},i.prototype.readAmount=function(e,t){var r,i,o=0;switch(r=e.readUInt16(),i=e.readUInt32(),r){case 48:o=e.readUInt16()}return e.seek(t),o},i.prototype.readColor=function(e){var t,r,i,o,n;switch(t=e.readUInt16(),r=e.readUInt32(),t){case 16:i=255*e.readFloat32(),o=255*e.readFloat32(),n=255*e.readFloat32();break;case 17:i=e.readUInt8(),o=e.readUInt8(),n=e.readUInt8();break;default:e.skip(r-6)}return i<<16|o<<8|n},i.prototype.parseTexture=function(e,t){for(var r={};e.tell()<t;){var i,o;switch(i=e.readUInt16(),o=e.readUInt32(),i){case 41728:r.url=this.readNulTermString(e);break;default:e.skip(o-6)}}return this._textures[r.url]=r,r},i.prototype.readNulTermString=function(e){for(var t,r="";(t=e.readUInt8())>0;)r+=String.fromCharCode(t);return r},i.prototype.parseVertexList=function(t){var r=0,i=t.readUInt16();for(this._cur_obj.verts=new Array(i);i>r;){var o,n,a;o=t.readFloat32(),n=t.readFloat32(),a=t.readFloat32(),this._cur_obj.verts[r]=new e.Vector3(o,a,n),r++}},i.prototype.parseFaceList=function(t){var r=0,i=t.readUInt16();for(this._cur_obj.facesCount=i,this._cur_obj.indices=[],this._cur_obj.uvsIndexes=[];i>r;){var o,n,a;o=t.readUInt16(),n=t.readUInt16(),a=t.readUInt16(),this._cur_obj.indices.push(new e.Face3(o,a,n)),this._cur_obj.uvsIndexes.push(new e.Vector3(o,a,n)),r++,t.skip(2)}this._cur_obj.smoothingGroups=[];for(var s=0;s<this._cur_obj.facesCount;s++)this._cur_obj.smoothingGroups[s]=0},i.prototype.parseUVList=function(t){var r=0,i=t.readUInt16();for(this._cur_obj.uvs=[];i>r;){var o,n;o=t.readFloat32(),n=1-t.readFloat32(),this._cur_obj.uvs.push(new e.Vector2(o,n)),r+=1}},i.prototype.parseFaceMaterialList=function(e){for(var t=this.readNulTermString(e),r=e.readUInt16(),i=0,o=[],n=0;r>n;n++)o[n]=0;for(;i<o.length;)o[i++]=e.readUInt16();this._cur_obj.materials.push(t),this._cur_obj.materialFaces[t]=o},i.prototype.finalizeCurrentMaterial=function(){this._materials[this._cur_mat.name]=this._cur_mat,this._cur_mat=null},i.prototype.parseB3D=function(e){var r=new t(e);for(r.reset();!r.eof();){this._cur_mat&&r.tell()>=this._cur_mat_end?this.finalizeCurrentMaterial():this._cur_obj&&r.tell()>=this._cur_obj_end&&(this.dalle.parseB3DObject(this),this.totalFaces+=this._cur_obj.facesCount,this._unfinalized_objects[this._cur_obj.name]=this._cur_obj,this._cur_obj_end=Number.MAX_VALUE,this._cur_obj=null);var i,o,n;switch(i=r.readUInt16(),o=r.readUInt32(),n=r.tell()+(o-6),i){case 19789:continue;case 15677:continue;case 45056:continue;case 45055:this._cur_mat_end=n,this._cur_mat=this.parseMaterial(r,n);break;case 16384:this._cur_obj_end=n,this._cur_obj={},this._cur_obj.name=this.readNulTermString(r),this._cur_obj.materials=[],this._cur_obj.materialFaces=[];break;case 16640:this._cur_obj.type="mesh";break;case 16656:this.parseVertexList(r);break;case 16704:this.parseUVList(r);break;case 16672:this.parseFaceList(r);break;case 16688:this.parseFaceMaterialList(r);break;default:r.skip(o-6)}}r.eof()&&(this.dalle.parseDallePivot(this.pivot),this.dalle.showDalleInScene(),this.dalle.emptyGeometryCache(),this.dalle.emptyMaterialsCache(),console.log("B3D object was loaded !"),console.log(" totalFaces="+this.totalFaces,"Dalle Name="+this.dalle.name))},i.prototype.decimalPrecision=3,i}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1)],o=function(e){e.EffectComposer=function(t,r){if(this.renderer=t,void 0===r){var i=window.innerWidth||1,o=window.innerHeight||1,n={minFilter:e.LinearMipMapLinear,magFilter:e.LinearMipMapLinear,format:e.RGBAFormat,stencilBuffer:!1,antialias:!0};r=new e.WebGLRenderTarget(i,o,n)}this.renderTarget1=r,this.renderTarget2=r.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===e.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new e.ShaderPass(e.CopyShader)},e.EffectComposer.prototype={swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e)},insertPass:function(e,t){this.passes.splice(t,0,e)},removePass:function(e){e=e||this.passes.length-1,this.passes.splice(e,1)},render:function(t){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;var r,i,o=!1,n=this.passes.length;for(i=0;n>i;i++)if(r=this.passes[i],r.enabled){if(r.render(this.renderer,this.writeBuffer,this.readBuffer,t,o),r.needsSwap){if(o){var a=this.renderer.context;a.stencilFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),a.stencilFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}r instanceof e.MaskPass?o=!0:r instanceof e.ClearMaskPass&&(o=!1)}},reset:function(e){void 0===e&&(e=this.renderTarget1.clone(),e.width=window.innerWidth,e.height=window.innerHeight),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){var r=this.renderTarget1.clone();r.width=e,r.height=t,this.reset(r)}},e.MaskPass=function(e,t){this.scene=e,this.camera=t,this.enabled=!0,this.clear=!0,this.needsSwap=!1,this.inverse=!1},e.MaskPass.prototype={render:function(e,t,r,i){var o=e.context;o.colorMask(!1,!1,!1,!1),o.depthMask(!1);var n,a;this.inverse?(n=0,a=1):(n=1,a=0),o.enable(o.STENCIL_TEST),o.stencilOp(o.REPLACE,o.REPLACE,o.REPLACE),o.stencilFunc(o.ALWAYS,n,4294967295),o.clearStencil(a),e.render(this.scene,this.camera,r,this.clear),e.render(this.scene,this.camera,t,this.clear),o.colorMask(!0,!0,!0,!0),o.depthMask(!0),o.stencilFunc(o.EQUAL,1,4294967295),o.stencilOp(o.KEEP,o.KEEP,o.KEEP)}},e.ClearMaskPass=function(){this.enabled=!0},e.ClearMaskPass.prototype={render:function(e,t,r,i){var o=e.context;o.disable(o.STENCIL_TEST)}},e.CopyShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},e.ShaderPass=function(t,r){this.textureID=void 0!==r?r:"tDiffuse",this.uniforms=e.UniformsUtils.clone(t.uniforms),this.material=new e.ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1},e.ShaderPass.prototype={render:function(t,r,i,o){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i),e.EffectComposer.quad.material=this.material,this.renderToScreen?t.render(e.EffectComposer.scene,e.EffectComposer.camera):t.render(e.EffectComposer.scene,e.EffectComposer.camera,r,this.clear)}},e.SSAOShader={uniforms:{tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},size:{type:"v2",value:new e.Vector2(512,512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},fogNear:{type:"f",value:5},fogFar:{type:"f",value:100},fogEnabled:{type:"i",value:0},onlyAO:{type:"i",value:0},aoClamp:{type:"f",value:.3},lumInfluence:{type:"f",value:.9}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform float fogNear;","uniform float fogFar;","uniform bool fogEnabled;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","const int samples = 8;","const float radius = 5.0;","const bool useNoise = false;","const float noiseAmount = 0.0003;","const float diffArea = 0.4;","const float gDisplace = 0.4;","const vec3 onlyAOColor = vec3( 1.0, 0.7, 0.5 );","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float doFog() {","float zdepth = unpackDepth( texture2D( tDepth, vUv ) );","float depth = -cameraFar * cameraNear / ( zdepth * cameraFarMinusNear - cameraFar );","return smoothstep( fogNear, fogFar, depth );","}","float readDepth( const in vec2 coord ) {","return cameraCoef / ( cameraFarPlusNear - unpackDepth( texture2D( tDepth, coord ) ) * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 2.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw;","float ph;","float ao;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","if ( fogEnabled ) {","ao = mix( ao, 1.0, doFog() );","}","vec3 color = texture2D( tDiffuse, vUv ).rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = onlyAOColor * vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, 1.0 );","}"].join("\n")},e.RenderPass=function(t,r,i,o,n){this.scene=t,this.camera=r,this.overrideMaterial=i,this.clearColor=o,this.clearAlpha=void 0!==n?n:1,this.oldClearColor=new e.Color,this.oldClearAlpha=1,this.enabled=!0,this.clear=!0,this.needsSwap=!1},e.RenderPass.prototype={render:function(e,t,r,i){this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.render(this.scene,this.camera,r,this.clear),this.clearColor&&e.setClearColor(this.oldClearColor,this.oldClearAlpha),this.scene.overrideMaterial=null}},e.CloudShader=function(){var t=new e.ShaderMaterial({uniforms:{map:{type:"t",value:e.ImageUtils.loadTexture("images/cloud10.png")},fogColor:{type:"v3",value:new e.Vector3(.27,.5,.7)},fogNear:{type:"f",value:-100},fogFar:{type:"f",value:3e3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D map;","uniform vec3 fogColor;","uniform float fogNear;","uniform float fogFar;","varying vec2 vUv;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = smoothstep( fogNear, fogFar, depth );","gl_FragColor = texture2D( map, vUv );","gl_FragColor.w *= pow( gl_FragCoord.z, 20.0 );","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}"].join("\n")});this.showClouds=function(){console.log("showClouds");var r=new e.Geometry,i=e.ImageUtils.loadTexture("images/cloud10.png",null);i.magFilter=e.LinearMipMapLinearFilter,i.minFilter=e.LinearMipMapLinearFilter;for(var o=new e.Mesh(new e.PlaneGeometry(64,64)),n=0;8e3>n;n++)o.position.x=1e3*Math.random()-500,o.position.y=Math.random()*Math.random()*200+15,o.position.z=1e3*Math.random()-500,o.rotation.z=Math.random()*Math.PI,o.scale.x=o.scale.y=Math.random()*Math.random()*1.5+.5,e.GeometryUtils.merge(r,o);t.depthWrite=!1,t.depthTest=!1,t.transparent=!0,t.side=e.DoubleSide;var a=new e.Mesh(r,t);return a}},e.DotScreenShader={uniforms:{tDiffuse:{type:"t",value:null},tSize:{type:"v2",value:new e.Vector2(256,256)},center:{type:"v2",value:new e.Vector2(.5,.5)},angle:{type:"f",value:1.57},scale:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},e.RGBShiftShader={uniforms:{tDiffuse:{type:"t",value:null},amount:{type:"f",value:.005},angle:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","}"].join("\n")},e.BleachBypassShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 base = texture2D( tDiffuse, vUv );","vec3 lumCoeff = vec3( 0.25, 0.65, 0.1 );","float lum = dot( lumCoeff, base.rgb );","vec3 blend = vec3( lum );","float L = min( 1.0, max( 0.0, 10.0 * ( lum - 0.45 ) ) );","vec3 result1 = 2.0 * base.rgb * blend;","vec3 result2 = 1.0 - 2.0 * ( 1.0 - blend ) * ( 1.0 - base.rgb );","vec3 newColor = mix( result1, result2, L );","float A2 = opacity * base.a;","vec3 mixRGB = A2 * newColor.rgb;","mixRGB += ( ( 1.0 - A2 ) * base.rgb );","gl_FragColor = vec4( mixRGB, base.a );","}"].join("\n")},e.HueSaturationShader={uniforms:{tDiffuse:{type:"t",value:null},hue:{type:"f",value:0},saturation:{type:"f",value:0},brightness:{type:"f",value:1},contrast:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float hue;","uniform float saturation;","uniform float brightness;","uniform float contrast;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","float angle = hue * 3.14159265;","float s = sin(angle), c = cos(angle);","vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","float len = length(gl_FragColor.rgb);","gl_FragColor.rgb = vec3(","dot(gl_FragColor.rgb, weights.xyz),","dot(gl_FragColor.rgb, weights.zxy),","dot(gl_FragColor.rgb, weights.yzx)",");","float average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","if (saturation > 0.0) {","gl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - saturation));","} else {","gl_FragColor.rgb += (average - gl_FragColor.rgb) * (-saturation);","}","gl_FragColor.rgb = ((gl_FragColor.rgb - 0.5) * max(contrast, 0.)) + 0.5;","gl_FragColor.rgb *= brightness;","}"].join("\n")},e.FocusShader={uniforms:{tDiffuse:{type:"t",value:null},screenWidth:{type:"f",value:1024},screenHeight:{type:"f",value:1024},sampleDistance:{type:"f",value:.94},waveFactor:{type:"f",value:.00125}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float screenWidth;","uniform float screenHeight;","uniform float sampleDistance;","uniform float waveFactor;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color, org, tmp, add;","float sample_dist, f;","vec2 vin;","vec2 uv = vUv;","add = color = org = texture2D( tDiffuse, uv );","vin = ( uv - vec2( 0.5 ) ) * vec2( 1.4 );","sample_dist = dot( vin, vin ) * 2.0;","f = ( waveFactor * 100.0 + sample_dist ) * sampleDistance * 4.0;","vec2 sampleSize = vec2(  1.0 / screenWidth, 1.0 / screenHeight ) * vec2( f );","add += tmp = texture2D( tDiffuse, uv + vec2( 0.111964, 0.993712 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.846724, 0.532032 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.943883, -0.330279 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.330279, -0.943883 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.532032, -0.846724 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.993712, -0.111964 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.707107, 0.707107 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","color = color * vec4( 2.0 ) - ( add / vec4( 8.0 ) );","color = color + ( add / vec4( 8.0 ) - color ) * ( vec4( 1.0 ) - vec4( sample_dist * 0.5 ) );","gl_FragColor = vec4( color.rgb * color.rgb * vec3( 0.95 ) + color.rgb, 1.0 );","}"].join("\n")},e.BokehShader={uniforms:{tColor:{type:"t",value:null},tDepth:{type:"t",value:null},focus:{type:"f",value:1},aspect:{type:"f",value:1},aperture:{type:"f",value:.0025},maxblur:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float maxblur;","uniform float aperture;","uniform float focus;","uniform float aspect;","void main() {","vec2 aspectcorrect = vec2( 1.0, aspect );","vec4 depth1 = texture2D( tDepth, vUv );","float factor = depth1.x - focus;","vec2 dofblur = vec2 ( clamp( factor * aperture, -maxblur, maxblur ) );","vec2 dofblur9 = dofblur * 0.9;","vec2 dofblur7 = dofblur * 0.7;","vec2 dofblur4 = dofblur * 0.4;","vec4 col = vec4( 0.0 );","col += texture2D( tColor, vUv.xy );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur4 );","gl_FragColor = col / 41.0;","gl_FragColor.a = 1.0;","}"].join("\n")},e.blurTriangleXDepth={info:{name:"triangle blur (pass 1)",author:"Evan Wallace",link:"https://github.com/evanw/glfx.js"},uniforms:{tDepth:{type:"t",value:0,texture:null},radius:{type:"f",value:0},resolutionW:{type:"f",value:1920}},controls:{radius:{min:0,max:200,step:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDepth;","uniform float radius;","uniform float resolutionW;","float random(vec3 scale, float seed) {","/* use the fragment position for a different seed per-pixel */","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","void main() {","vec4 color = vec4(0.0);","float total = 0.0;","vec2 delta = vec2(radius / resolutionW, 0);","/* randomize the lookup values to hide the fixed number of samples */","float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);","for (float t = -30.0; t <= 30.0; t++) {","float percent = (t + offset - 0.5) / 30.0;","float weight = 1.0 - abs(percent);","color += texture2D(tDepth, vUv + delta * percent) * weight;","total += weight;","}","gl_FragColor = color / total;","}"].join("\n")},e.blurTriangleX={info:{name:"triangle blur (pass 1)",author:"Evan Wallace",link:"https://github.com/evanw/glfx.js"},uniforms:{tDiffuse:{type:"t",value:0,texture:null},radius:{type:"f",value:0},resolutionW:{type:"f",value:1920}},controls:{radius:{min:0,max:200,step:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform float radius;","uniform float resolutionW;","float random(vec3 scale, float seed) {","/* use the fragment position for a different seed per-pixel */","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","void main() {","vec4 color = vec4(0.0);","float total = 0.0;","vec2 delta = vec2(radius / resolutionW, 0);","/* randomize the lookup values to hide the fixed number of samples */","float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);","for (float t = -30.0; t <= 30.0; t++) {","float percent = (t + offset - 0.5) / 30.0;","float weight = 1.0 - abs(percent);","color += texture2D(tDiffuse, vUv + delta * percent) * weight;","total += weight;","}","gl_FragColor = color / total;","}"].join("\n")},e.blurTriangleY={info:{name:"triangle blur (pass 2)",author:"Evan Wallace",link:"https://github.com/evanw/glfx.js"},uniforms:{tDiffuse:{type:"t",value:0,texture:null},radius:{type:"f",value:0},resolutionH:{type:"f",value:1080}},controls:{radius:{min:0,max:200,step:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform float radius;","uniform float resolutionH;","float randomy(vec3 scale, float seed) {","/* use the fragment position for a different seed per-pixel */","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","void main() {","vec4 color = vec4(0.0);","float total = 0.0;","vec2 delta = vec2(0, radius / resolutionH);","/* randomize the lookup values to hide the fixed number of samples */","float offset = randomy(vec3(12.9898, 78.233, 151.7182), 0.0);","for (float t = -30.0; t <= 30.0; t++) {","float percent = (t + offset - 0.5) / 30.0;","float weight = 1.0 - abs(percent);","color += texture2D(tDiffuse, vUv + delta * percent) * weight;","total += weight;","}","gl_FragColor = color / total;","}"].join("\n")
},e.itownsMask={uniforms:{tDiffuse:{type:"t",value:1,texture:null},textureIn:{type:"t",value:0,texture:null},bias:{type:"f",value:-2}},controls:{bias:{min:-10,max:10,step:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform float bias;","uniform sampler2D tDiffuse;","uniform sampler2D textureIn;","void main() {","vec4 tex_blur = texture2D( tDiffuse, vUv );","vec4 tex_color = texture2D( textureIn, vUv );","gl_FragColor = tex_color - 0.2*(vec4(1.) - tex_blur);","gl_FragColor.a = 1.;","}"].join("\n")},distw=1/1920,disth=1/1080,e.ItownsSharpening={info:{name:"sharpen",author:"AD"},uniforms:{tDiffuse:{type:"t",value:0,texture:null},bias:{type:"f",value:-2},kernel:{type:"iv1",value:[-1,-1,-1,-1,17,-1,-1,-1,-1]},screenWidth:{type:"i",value:1920},screenHeight:{type:"i",value:1080},offset:{type:"v2v",value:[new e.Vector2(distw,disth),new e.Vector2(0,disth),new e.Vector2(-distw,disth),new e.Vector2(distw,0),new e.Vector2(0,0),new e.Vector2(-distw,0),new e.Vector2(distw,-disth),new e.Vector2(0,-disth),new e.Vector2(-distw,-disth)]}},controls:{bias:{min:-10,max:10,step:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform float bias;","uniform sampler2D tDiffuse;","uniform int kernel[ 9 ];","uniform vec2 offset[ 9 ];","void main() {","vec4 sum = vec4(0.0);","for(int i = 0; i < 9; i++) {","  vec4 color = texture2D(tDiffuse, vUv + offset[i]);","  sum += color * float(kernel[i]);","}","gl_FragColor = sum/9.;","}"].join("\n")},e.unsharpMasking={info:{name:"unsharp masking",author:"ported by thierry tranchina aka @rDad",link:"http://graphics.uni-konstanz.de/publikationen/2006/unsharp_masking/webseite/"},uniforms:{tDepth:{type:"t",value:2,texture:null},tDiffuse:{type:"t",value:1,texture:null},textureIn:{type:"t",value:0,texture:null},bias:{type:"f",value:-2}},controls:{bias:{min:-10,max:10,step:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform float bias;","uniform sampler2D tDepth;","uniform sampler2D tDiffuse;","uniform sampler2D textureIn;","void main() {","vec4 tex_depth = texture2D( tDepth, vUv );","vec4 tex_blur = texture2D( tDiffuse, vUv );","vec4 tex_color = texture2D( textureIn, vUv );","vec3 spatial_imp = tex_blur.rgb - tex_depth.rgb;","vec3 final = vec3(1.,1.,1.);","if(spatial_imp.r>=0.0  &&  spatial_imp.r<0.9/*tex_depth.r >0.2*/)","{"," final += spatial_imp * bias;","}","gl_FragColor = vec4(final, 0.2);","}"].join("\n")},e.ItownsToneMapping={uniforms:{tColor:{type:"t",value:null},tDiffuse:{type:"t",value:null},exposure:{type:"f",value:.125},brightMax:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D   tColor;","uniform sampler2D   tDiffuse;","uniform float       exposure;","uniform float       brightMax;","varying vec2  vUv;","void main() {","	vec4 colorOriginal =  texture2D( tColor, vUv );","	vec4 colorBlurred  =  texture2D( tDiffuse, vUv );","       vec4 newColor = colorOriginal/(colorBlurred+0.2);","	gl_FragColor = vec4( newColor.xyz, 1 );","}"].join("\n")},e.ItownsDepthShader={uniforms:{tColor:{type:"t",value:null},tDepth:{type:"t",value:null},focus:{type:"f",value:1},maxblur:{type:"f",value:1.8},effectIntensity:{type:"f",value:0},indice_time:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float focus;","uniform float maxblur;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float effectIntensity;","uniform float indice_time;","varying vec2 vUv;","float cameraFar = 10000.;","float cameraNear = 0.2;","float fogFar = 200.;","float fogNear = 5.;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;"," vec3 fogColor = vec3(0.9725,0.896,0.7598);"," vec3 skyColor = vec3(0.613,0.758,0.947);"," const float LOG2 = 1.442695;"," float fogDensity = 0.0025;","void main() {"," vec4 depth = texture2D( tDepth, vUv );"," float factor = depth.x - focus;"," vec4 col = texture2D( tColor, vUv);//, 2.0 * maxblur * abs( focus - depth.x ) ); "," gl_FragColor = col; "," float depth2 = (1.-depth.x);"," vec4 newAmbientColor = mix( vec4(skyColor,1.), vec4(fogColor, 1. ), effectIntensity / 100. );","float coefMix = depth2/1.1;"," gl_FragColor = mix( col, newAmbientColor, coefMix);","gl_FragColor.rgb += 0.1 - effectIntensity/1000.;","if (( effectIntensity == 100. && mod(indice_time,50.) >= 0. && mod(indice_time,50.) <= 0.2)","  || ( effectIntensity == 100. && mod(indice_time,49.) >= 0. && mod(indice_time,49.) <= 0.2)) "," gl_FragColor = mix( col, vec4( 1.,1.,1.,1. ), depth2/1.1);","}"].join("\n")},e.BufferGeometryUtils={fromGeometry:function(t,r){if(t instanceof e.BufferGeometry)return t;r=r||{vertexColors:e.NoColors};var i=t.vertices,o=t.faces,n=t.faceVertexUvs,a=r.vertexColors,s=n[0].length>0,l=new e.BufferGeometry;l.attributes={position:{itemSize:3,array:new Float32Array(3*o.length*3)},normal:{itemSize:3,array:new Float32Array(3*o.length*3)},materialindice:{itemSize:1,array:new Float32Array(3*o.length)}};var c=l.attributes.position.array,h=l.attributes.normal.array,u=l.attributes.materialindice.array;if(a!==e.NoColors){l.attributes.color={itemSize:3,array:new Float32Array(3*o.length*3)};var p=l.attributes.color.array}if(s===!0){l.attributes.uv={itemSize:2,array:new Float32Array(3*o.length*2)};var d=l.attributes.uv.array}for(var f=0,m=0,v=0;v<o.length;v++){var g=o[v],y=g.materialIndex,x=y-r.indice;u[3*v]=x,u[3*v+1]=x,u[3*v+2]=x;var w=i[g.a],b=i[g.b],_=i[g.c];c[m]=w.x,c[m+1]=w.y,c[m+2]=w.z,c[m+3]=b.x,c[m+4]=b.y,c[m+5]=b.z,c[m+6]=_.x,c[m+7]=_.y,c[m+8]=_.z;var M=g.vertexNormals[0],S=g.vertexNormals[1],T=g.vertexNormals[2];if(h[m]=M.x,h[m+1]=M.y,h[m+2]=M.z,h[m+3]=S.x,h[m+4]=S.y,h[m+5]=S.z,h[m+6]=T.x,h[m+7]=T.y,h[m+8]=T.z,a===e.FaceColors){var C=g.color;p[m]=C.r,p[m+1]=C.g,p[m+2]=C.b,p[m+3]=C.r,p[m+4]=C.g,p[m+5]=C.b,p[m+6]=C.r,p[m+7]=C.g,p[m+8]=C.b}else if(a===e.VertexColors){var L=g.vertexColors[0],A=g.vertexColors[1],P=g.vertexColors[2];p[m]=L.r,p[m+1]=L.g,p[m+2]=L.b,p[m+3]=A.r,p[m+4]=A.g,p[m+5]=A.b,p[m+6]=P.r,p[m+7]=P.g,p[m+8]=P.b}if(s===!0){var D=n[0][v][0],F=n[0][v][1],E=n[0][v][2];d[f]=D.x,d[f+1]=D.y,d[f+2]=F.x,d[f+3]=F.y,d[f+4]=E.x,d[f+5]=E.y}m+=9,f+=6}return l.computeBoundingSphere(),l}},e.AnaglyphEffect=function(t,r,i,o){var n,a,s,l,c=new e.Matrix4,h=new e.Matrix4,u=r,p=0,d=new e.PerspectiveCamera;d.matrixAutoUpdate=!1;var f=new e.PerspectiveCamera;f.matrixAutoUpdate=!1;var m=new e.OrthographicCamera(-1,1,1,-1,0,1),v=new e.Scene,g={minFilter:e.LinearFilter,magFilter:e.NearestFilter,format:e.RGBAFormat};void 0===i&&(i=512),void 0===o&&(o=512);var y=new e.WebGLRenderTarget(i,o,g),x=new e.WebGLRenderTarget(i,o,g),w=new e.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:y},mapRight:{type:"t",value:x}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = vec2( uv.x, uv.y );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","	vec4 colorL, colorR;","	vec2 uv = vUv;","	colorL = texture2D( mapLeft, uv );","	colorR = texture2D( mapRight, uv );","	gl_FragColor = vec4( colorL.g * 0.7 + colorL.b * 0.3, colorR.g, colorR.b, colorL.a + colorR.a ) * 1.1;","}"].join("\n")}),b=new e.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:y},mapRight:{type:"t",value:x}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = vec2( uv.x, uv.y );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","	vec2 uv = vUv;","	if ( ( mod( gl_FragCoord.y, 2.0 ) ) > 1.00 ) {","		gl_FragColor = texture2D( mapLeft, uv );","	} else {","		gl_FragColor = texture2D( mapRight, uv );","	}","}"].join("\n")}),_=new e.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:y},mapRight:{type:"t",value:x}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = vec2( uv.x, uv.y );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","	if ( gl_FragCoord.x  < 960. ) {","		gl_FragColor = texture2D( mapLeft, vec2(vUv.x *2., vUv.y) );","	} else {","		gl_FragColor = texture2D( mapRight, vec2((vUv.x - 0.5) *2., vUv.y) );","	}","}"].join("\n")});_material=w;var M=new e.Mesh(new e.PlaneGeometry(2,2),_material);v.add(M),this.switchMaterial=function(){switch(p=(p+1)%3){case 0:_material=w;break;case 1:_material=b;break;case 2:_material=_}_material.uniforms.mapLeft.value=y,_material.uniforms.mapRight.value=x,M.material=_material},this.setFocalLength=function(t,r){u=t,n=r.aspect,a=r.near,s=r.far,l=r.fov;var i,o,p=r.projectionMatrix.clone(),m=u/30*.5,v=m*a/u,g=a*Math.tan(e.Math.degToRad(.5*l));c.elements[12]=m,h.elements[12]=-m,i=-g*n+v,o=g*n+v,p.elements[0]=2*a/(o-i),p.elements[8]=(o+i)/(o-i),d.projectionMatrix.copy(p),i=-g*n-v,o=g*n-v,p.elements[0]=2*a/(o-i),p.elements[8]=(o+i)/(o-i),f.projectionMatrix.copy(p)},this.setSize=function(r,i){y&&y.dispose(),x&&x.dispose(),y=new e.WebGLRenderTarget(r,i,g),x=new e.WebGLRenderTarget(r,i,g),_material.uniforms.mapLeft.value=y,_material.uniforms.mapRight.value=x,t.setSize(r,i)},this.render=function(r,i){r.updateMatrixWorld(),void 0===i.parent&&i.updateMatrixWorld();var o=n!==i.aspect||a!==i.near||s!==i.far||l!==i.fov;if(o){n=i.aspect,a=i.near,s=i.far,l=i.fov;var p,g,w=i.projectionMatrix.clone(),b=u/30*.5,_=b*a/u,M=a*Math.tan(e.Math.degToRad(.5*l));c.elements[12]=b,h.elements[12]=-b,p=-M*n+_,g=M*n+_,w.elements[0]=2*a/(g-p),w.elements[8]=(g+p)/(g-p),d.projectionMatrix.copy(w),p=-M*n-_,g=M*n-_,w.elements[0]=2*a/(g-p),w.elements[8]=(g+p)/(g-p),f.projectionMatrix.copy(w)}d.matrixWorld.copy(i.matrixWorld).multiply(h),d.position.copy(i.position),d.near=i.near,d.far=i.far,t.render(r,d,y,!0),f.matrixWorld.copy(i.matrixWorld).multiply(c),f.position.copy(i.position),f.near=i.near,f.far=i.far,t.render(r,f,x,!0),t.render(v,m)},this.dispose=function(){y&&y.dispose(),x&&x.dispose()}},e.ShaderLib.water={uniforms:{normalSampler:{type:"t",value:null},mirrorSampler:{type:"t",value:null},alpha:{type:"f",value:1},time:{type:"f",value:0},distortionScale:{type:"f",value:20},noiseScale:{type:"f",value:1},textureMatrix:{type:"m4",value:new e.Matrix4},sunColor:{type:"c",value:new e.Color(8355711)},sunDirection:{type:"v3",value:new e.Vector3(.70707,.70707,0)},eye:{type:"v3",value:new e.Vector3(0,0,0)},waterColor:{type:"c",value:new e.Color(5592405)},betaVersion:{type:"i",value:0}},vertexShader:["uniform mat4 textureMatrix;","uniform float time;","uniform float noiseScale;","uniform sampler2D normalSampler;","uniform int betaVersion;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","float getHeight(in vec2 uv)","{","	vec2 uv0 = uv / (103.0 * noiseScale) + vec2(time / 17.0, time / 29.0);","	vec2 uv1 = uv / (107.0 * noiseScale) - vec2(time / -19.0, time / 31.0);","	vec2 uv2 = uv / (vec2(8907.0, 9803.0) * noiseScale) + vec2(time / 101.0, time /  097.0);","	vec2 uv3 = uv / (vec2(1091.0, 1027.0) * noiseScale) - vec2(time / 109.0, time / -113.0);","	float v0 = texture2D(normalSampler, uv0).y;","	float v1 = texture2D(normalSampler, uv1).y;","	float v2 = texture2D(normalSampler, uv2).y;","	float v3 = texture2D(normalSampler, uv3).y;","	return v0 * 103.0 + v1 * 107.0 + v2 * 9000.0 + v3 * 1000.0 + 20000.0;","}","void main()","{","	mirrorCoord = modelMatrix * vec4(position, 1.0);","	worldPosition = mirrorCoord.xyz;","	mirrorCoord = textureMatrix * mirrorCoord;","	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float distortionScale;","uniform float noiseScale;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","void sunLight(const vec3 surfaceNormal, const vec3 eyeDirection, in float shiny, in float spec, in float diffuse, inout vec3 diffuseColor, inout vec3 specularColor)","{","	vec3 reflection = normalize(reflect(-sunDirection, surfaceNormal));","	float direction = max(0.0, dot(eyeDirection, reflection));","	specularColor += pow(direction, shiny) * sunColor * spec;","	diffuseColor += max(dot(sunDirection, surfaceNormal), 0.0) * sunColor * diffuse;","}","vec3 getNoise(in vec2 uv)","{","	vec2 uv0 = uv / (103.0 * noiseScale) + vec2(time / 17.0, time / 29.0);","	vec2 uv1 = uv / (107.0 * noiseScale) - vec2(time / -19.0, time / 31.0);","	vec2 uv2 = uv / (vec2(8907.0, 9803.0) * noiseScale) + vec2(time / 101.0, time /   97.0);","	vec2 uv3 = uv / (vec2(1091.0, 1027.0) * noiseScale) - vec2(time / 109.0, time / -113.0);","	vec4 noise = (texture2D(normalSampler, uv0)) +","		(texture2D(normalSampler, uv1)) +","		(texture2D(normalSampler, uv2)) +","		(texture2D(normalSampler, uv3));","	return noise.xzy * 0.5 - 1.0;","}","void main()","{","	vec3 surfaceNormal = (getNoise(worldPosition.xz));","   if( eye.y < worldPosition.y )","		surfaceNormal = surfaceNormal * -1.0;","	vec3 diffuseLight = vec3(0.0);","	vec3 specularLight = vec3(0.0);","	vec3 worldToEye = eye - worldPosition;","	vec3 eyeDirection = normalize(worldToEye);","	sunLight(surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight);","	float distance = length(worldToEye);","	vec2 distortion = surfaceNormal.xz * distortionScale * sqrt(distance) * 0.07;","   vec3 mirrorDistord = mirrorCoord.xyz + vec3(distortion.x, distortion.y, 1.0);","   vec3 reflectionSample = texture2DProj(mirrorSampler, mirrorDistord).xyz;","	float theta = max(dot(eyeDirection, surfaceNormal), 0.0);","	const float rf0 = 0.3;","	float reflectance = 0.3 + (1.0 - 0.3) * pow((1.0 - theta), 5.0);","	vec3 scatter = max(0.0, dot(surfaceNormal, eyeDirection)) * waterColor;","	vec3 albedo = mix(sunColor * diffuseLight * 0.3 + scatter, (vec3(0.1) + reflectionSample * 0.9 + reflectionSample * specularLight), reflectance);","   vec2 tmp = mirrorCoord.xy / mirrorCoord.z + distortion;","	gl_FragColor = vec4(albedo, alpha);","}"].join("\n")},e.Water=function(t,r,i,o){function n(e){return 0===(e&e-1)}function a(e,t){return void 0!==e?e:t}e.Object3D.call(this),this.name="water_"+this.id,o=o||{},this.matrixNeedsUpdate=!0;var s=a(o.textureWidth,512),l=a(o.textureHeight,512);this.clipBias=a(o.clipBias,-1e-4),this.alpha=a(o.alpha,1),this.time=a(o.time,0),this.normalSampler=a(o.waterNormals,null),this.sunDirection=a(o.sunDirection,new e.Vector3(.70707,.70707,0)),this.sunColor=new e.Color(a(o.sunColor,16777215)),this.waterColor=new e.Color(a(o.waterColor,8355711)),this.eye=a(o.eye,new e.Vector3(0,0,0)),this.distortionScale=a(o.distortionScale,20),this.noiseScale=a(o.noiseScale,1),this.betaVersion=a(o.betaVersion,0),this.side=a(o.side,e.FrontSide),this.renderer=t,this.scene=i,this.mirrorPlane=new e.Plane,this.normal=new e.Vector3(0,0,1),this.mirrorWorldPosition=new e.Vector3,this.cameraWorldPosition=new e.Vector3,this.rotationMatrix=new e.Matrix4,this.lookAtPosition=new e.Vector3(0,0,-1),this.clipPlane=new e.Vector4,r instanceof e.PerspectiveCamera?this.camera=r:(this.camera=new e.PerspectiveCamera,console.log(this.name+": camera is not a Perspective Camera!")),this.textureMatrix=new e.Matrix4,this.mirrorCamera=this.camera.clone(),this.texture=new e.WebGLRenderTarget(s,l),this.tempTexture=new e.WebGLRenderTarget(s,l);var c=e.ShaderLib.water,h=e.UniformsUtils.clone(c.uniforms);this.material=new e.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:h,transparent:!0,side:this.side}),this.material.uniforms.mirrorSampler.value=this.texture,this.material.uniforms.textureMatrix.value=this.textureMatrix,this.material.uniforms.alpha.value=this.alpha,this.material.uniforms.time.value=this.time,this.material.uniforms.normalSampler.value=this.normalSampler,this.material.uniforms.sunColor.value=this.sunColor,this.material.uniforms.waterColor.value=this.waterColor,this.material.uniforms.sunDirection.value=this.sunDirection,this.material.uniforms.distortionScale.value=this.distortionScale,this.material.uniforms.noiseScale.value=this.noiseScale,this.material.uniforms.betaVersion.value=this.betaVersion,this.material.uniforms.eye.value=this.eye,n(s)&&n(l)||(this.texture.generateMipmaps=!1,this.tempTexture.generateMipmaps=!1),this.updateTextureMatrix(),this.render()},e.Water.prototype=Object.create(e.Object3D.prototype),e.Water.prototype.renderWithMirror=function(e){this.updateTextureMatrix(),this.matrixNeedsUpdate=!1;var t=e.camera;e.camera=this.mirrorCamera,e.renderTemp(),e.material.uniforms.mirrorSampler.value=e.tempTexture,this.render(),this.matrixNeedsUpdate=!0,e.material.uniforms.mirrorSampler.value=e.texture,e.camera=t,e.updateTextureMatrix()},e.Water.prototype.updateTextureMatrix=function(){function t(e){return e?0>e?-1:1:0}this.updateMatrixWorld(),this.camera.updateMatrixWorld(),this.mirrorWorldPosition=(new e.Vector3).getPositionFromMatrix(this.matrixWorld),this.cameraWorldPosition=(new e.Vector3).getPositionFromMatrix(this.camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.mirrorWorldPosition.y>this.cameraWorldPosition.y?this.normal.set(0,0,-1):this.normal.set(0,0,1),this.normal.applyMatrix4(this.rotationMatrix);var r=this.mirrorWorldPosition.clone().sub(this.cameraWorldPosition);r.reflect(this.normal).negate(),r.add(this.mirrorWorldPosition),this.rotationMatrix.extractRotation(this.camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition);var i=this.mirrorWorldPosition.clone().sub(this.lookAtPosition);i.reflect(this.normal).negate(),i.add(this.mirrorWorldPosition),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(r),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(i),this.mirrorCamera.aspect=this.camera.aspect,this.mirrorCamera.updateProjectionMatrix(),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.matrixWorldInverse.getInverse(this.mirrorCamera.matrixWorld),this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mirrorWorldPosition),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);var o=new e.Vector4,n=this.mirrorCamera.projectionMatrix;o.x=(t(this.clipPlane.x)+n.elements[8])/n.elements[0],o.y=(t(this.clipPlane.y)+n.elements[9])/n.elements[5],o.z=-1,o.w=(1+n.elements[10])/n.elements[14];var a=new e.Vector4;a=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(o)),n.elements[2]=a.x,n.elements[6]=a.y,n.elements[10]=a.z+1-this.clipBias,n.elements[14]=a.w;var s=new e.Vector3;s=(new e.Vector3).getPositionFromMatrix(this.camera.matrixWorld),this.eye=s,this.material.uniforms.eye.value=this.eye},e.Water.prototype.render=function(){this.matrixNeedsUpdate&&this.updateTextureMatrix(),this.matrixNeedsUpdate=!0,void 0!==this.scene&&this.scene instanceof e.Scene&&this.renderer.render(this.scene,this.mirrorCamera,this.texture,!0)},e.Water.prototype.renderTemp=function(){this.matrixNeedsUpdate&&this.updateTextureMatrix(),this.matrixNeedsUpdate=!0,void 0!==this.scene&&this.scene instanceof e.Scene&&this.renderer.render(this.scene,this.mirrorCamera,this.tempTexture,!0)},e.Water.prototype.update=function(){this.ms_Water.material.uniforms.time.value+=1/60},e.EffectComposer.camera=new e.OrthographicCamera(-1,1,1,-1,0,1),e.EffectComposer.quad=new e.Mesh(new e.PlaneGeometry(2,2),null),e.EffectComposer.scene=new e.Scene,e.EffectComposer.scene.add(e.EffectComposer.quad)}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(5),r(3),r(1),r(12),r(9),r(10),r(2),r(7),r(15),r(4)],o=function(e,t,r,i,o,a,s,l,c,h){var u,p=null,d=null,f=0,m=1e4,v=4e3,g=null,y=null,x=null,w=null,b=null,_=0,M=0,S=.1,T=100;window.requestAnimFrameW=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var C={initiated:!1,init:function(){this.initializeBufferGeometry(),this.initiated=!0,this.animateTime(),this.setClimate(90)},addToScene:function(){t.addToScene(w),t.addToScene(b)},removeFromScene:function(){t.removeFromScene(w),t.removeFromScene(b)},animateTime:function(){f+=S,w.material.uniforms.indice_time.value=f,b.material.uniforms.indice_time.value=f,t.setTimeEffect(f),requestAnimFrameW(C.animateTime)},initializeBufferGeometry:function(){this.createShader(),this.createShaderCloud(),g=new r.BufferGeometry,g.dynamic=!0,u=new r.BufferGeometry,u.dynamic=!0,g.attributes={position:{itemSize:3,array:new Float32Array(3*m),numItems:3*m,dynamic:!0},color:{itemSize:3,array:new Float32Array(3*m),numItems:3*m,dynamic:!0},displacement:{itemSize:3,array:new Float32Array(3*m),numItems:3*m,dynamic:!0},size:{itemSize:1,array:new Float32Array(m),numItems:m,dynamic:!1}},u.attributes={position:{itemSize:3,array:new Float32Array(3*v),numItems:3*v,dynamic:!0},color:{itemSize:3,array:new Float32Array(3*v),numItems:3*v,dynamic:!0},displacement:{itemSize:3,array:new Float32Array(3*v),numItems:3*v,dynamic:!0},size:{itemSize:1,array:new Float32Array(v),numItems:v,dynamic:!1}},this.initializeBufferValues(),this.initializeBufferValuesCloud(),w=new r.ParticleSystem(g,y),b=new r.ParticleSystem(u,x)},createShader:function(){p={displacement:{type:"v3",value:[]},color:{type:"v3",value:[]},size:{type:"f",value:[]}},d={indice_time:{type:"f",value:f},point_size:{type:"f",value:1},alpha:{type:"f",value:.7},textureSnow:{type:"t",value:r.ImageUtils.loadTexture("images/textures/snowflake.png")},textureDrop:{type:"t",value:r.ImageUtils.loadTexture("images/textures/raindrop2flip.png")},textureCloud:{type:"t",value:r.ImageUtils.loadTexture("images/textures/smoke_particle.png")},effectNum:{type:"i",value:_},effectIntensity:{type:"f",value:M},farFog:{type:"f",value:T}},y=new r.ShaderMaterial({uniforms:d,attributes:p,vertexShader:i.shaders["shaderWeather.vs"],fragmentShader:i.shaders["shaderWeather.fs"],vertexColors:r.VertexColors,depthTest:!1,transparent:!0})},createShaderCloud:function(){p={displacement:{type:"v3",value:[]},color:{type:"v3",value:[]},size:{type:"f",value:[]}},d={indice_time:{type:"f",value:f},point_size:{type:"f",value:1},alpha:{type:"f",value:.7},textureSnow:{type:"t",value:r.ImageUtils.loadTexture("images/textures/snowflake.png")},textureDrop:{type:"t",value:r.ImageUtils.loadTexture("images/textures/raindrop2flip.png")},textureCloud:{type:"t",value:r.ImageUtils.loadTexture("images/textures/smoke_particle.png")},effectNum:{type:"i",value:5},effectIntensity:{type:"f",value:M},farFog:{type:"f",value:T}},x=new r.ShaderMaterial({uniforms:d,attributes:p,vertexShader:i.shaders["shaderWeather.vs"],fragmentShader:i.shaders["shaderWeather.fs"],vertexColors:r.VertexColors,depthTest:!0,depthWrite:!1,transparent:!0})},initializeBufferValues:function(){var e=g.attributes.position.array,t=g.attributes.color.array,i=g.attributes.displacement.array,o=g.attributes.size.array,a=new r.Color;a.setHSL(.2,.5,.7);var s=100;for(n=0;n<m;++n)e[3*n+0]=(2*Math.random()-1)*s-s/2,e[3*n+1]=Math.random()*s*3,e[3*n+2]=(2*Math.random()-1)*s-s/2,i[3*n+0]=(2*Math.random()-1)*s,i[3*n+1]=-Math.random()*s*3,i[3*n+2]=(2*Math.random()-1)*s,t[3*n+0]=a.r,t[3*n+1]=a.g,t[3*n+2]=a.b,o[3*n]=10*Math.random()},initializeBufferValuesCloud:function(){var e=u.attributes.position.array,t=u.attributes.color.array,i=u.attributes.displacement.array,o=u.attributes.size.array,a=new r.Color;a.setHSL(.2,.5,.7);var s=50;for(n=0;n<m;++n)e[3*n+0]=(2*Math.random()-1)*s,e[3*n+1]=30+Math.random()*s/2,e[3*n+2]=(2*Math.random()-1)*s,i[3*n+0]=(2*Math.random()-1)*s,i[3*n+1]=(2*Math.random()-1)*s,i[3*n+2]=(2*Math.random()-1)*s,t[3*n+0]=a.r,t[3*n+1]=a.g,t[3*n+2]=a.b,o[3*n]=10*Math.random()},changeEffect:function(e){_=(e||_+1)%2,w.material.uniforms.effectNum.value=_},setClimate:function(e){M=e,t.setFarFog(2400-23.5*M),t.setIntensityEffect(M)},setClimateALLSAVEWITHSNOWANDRAIN:function(e){M=e,w.material.uniforms.effectIntensity.value=M,b.material.uniforms.effectIntensity.value=M,50>=e?this.setTimeStep(e/100):this.setTimeStep((e-50)/200),t.setFarFog(2400-23.5*M),t.setIntensityEffect(M),h.snd2&&(h.snd2.volume=1-M/100),h.snd2&&(h.snd.volume=M/100),t.setLensFlareIntensity(M)},setTimeStep:function(e){S=e},setEffectsClimateOn:function(e){t.setEffectsClimateOn(e)},setEffectsClimateOnSAVEWITHALLEFFECTS:function(e){this.initiated||(this.init(),this.addToScene()),e?(this.initiated||this.init(),this.addToScene(),this.playRain("100431__2hear__rain-thunder-roll.mp3"),this.playSummer("156894__ramston__spring-ambience-city-horizon-birds-light-traffic-car-01.mp3")):(this.removeFromScene(),this.stopCurrentMP3()),t.setEffectsClimateOn(e)},playRain:function(e){e=e||this.mp3Name,h.snd&&h.snd.pause(),h.snd=new Audio("sounds/"+e),h.snd.loop=!0,h.snd.play(),h.snd.volume=.9},playSummer:function(e){e=e||this.mp3Name,h.snd2&&h.snd2.pause(),h.snd2=new Audio("sounds/"+e),h.snd2.loop=!0,h.snd2.play(),h.snd2.volume=.1},stopCurrentMP3:function(){h.snd&&h.snd.pause(),h.snd2&&h.snd2.pause()}};return C}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,r){var i,o;i=[r(1)],o=function(e){function t(e,t,r){var i=Math.min(e,t),o=Math.max(e,t),n=i+"_"+o;return r[n]}function r(e,t,r,i,o,n){var a,s=Math.min(e,t),l=Math.max(e,t),c=s+"_"+l;if(c in i)a=i[c];else{var h=r[s],u=r[l];a={a:h,b:u,newEdge:null,faces:[]},i[c]=a}a.faces.push(o),n[e].edges.push(a),n[t].edges.push(a)}function i(e,t,i,o){var n,a,s;for(n=0,a=e.length;a>n;n++)i[n]={edges:[]};for(n=0,a=t.length;a>n;n++)s=t[n],r(s.a,s.b,e,o,s,i),r(s.b,s.c,e,o,s,i),r(s.c,s.a,e,o,s,i)}function o(t,r,i,o){t.push(new e.Face3(r,i,o))}e.Vector3.prototype.toLonLat=function(){return new e.Vector2(this.x,this.z)},e.Vector2.prototype.vec=function(t,r){return new e.Vector2(r.x-t.x,r.y-t.y)},e.Vector2.prototype.dot=function(e,t){return e.x*t.x+e.y*t.y},e.Vector2.prototype.isPointInTriange=function(t,r,i){var o=this.vec(t,i),n=this.vec(t,r),a=this.vec(t,this),s=this.dot(n,n),l=this.dot(n,o),c=this.dot(n,a),h=this.dot(o,o),u=this.dot(o,a),p=1/(s*h-l*l),d=(h*c-l*u)*p,f=(s*u-l*c)*p,m=1-d-f;return new e.Vector3(m>=0&&d>=0&&1>m+d,m,d)},e.Triangle2D=function(t,r,i){this.a=void 0!==t?t:new e.Vector2,this.b=void 0!==r?r:new e.Vector2,this.c=void 0!==i?i:new e.Vector2},e.Triangle2D.prototype={constructor:e.Triangle2D,set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this},setFromPointsAndIndices:function(e,t,r,i){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[i]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},clone:function(){return(new e.Triangle2D).copy(this)}},e.Edge2D=function(e,t){e.y<t.y?(this.pStart=e.clone(),this.pEnd=t.clone()):(this.pStart=t.clone(),this.pEnd=e.clone())},e.SubdivisionModifier=function(e){this.subdivisions=void 0===e?1:e},e.SubdivisionModifier.prototype.modify=function(e){for(var t=this.subdivisions;t-- >0;)this.smooth(e);delete e.__tmpVertices,e.computeCentroids(),e.computeFaceNormals(),e.computeVertexNormals()};var n=!1,a=["a","b","c"];e.SubdivisionModifier.prototype.smooth=function(r){var s,l,c,h,u,p,d,f,m,v,g,g,y,x,w=new e.Vector3;s=r.vertices,l=r.faces,v=new Array(s.length),g={},i(s,l,v,g),y=[];var b,_,M,S,T,C,L;for(p in g){for(_=g[p],M=new e.Vector3,T=3/8,C=1/8,L=_.faces.length,2!=L&&(T=.5,C=0,1!=L&&n&&console.warn("Subdivision Modifier: Number of connected faces != 2, is: ",L,_)),M.addVectors(_.a,_.b).multiplyScalar(T),w.set(0,0,0),f=0;L>f;f++){for(S=_.faces[f],m=0;3>m&&(b=s[S[a[m]]],b===_.a||b===_.b);m++);w.add(b)}w.multiplyScalar(C),M.add(w),_.newEdge=y.length,y.push(M)}var A,P,D,F,E,V,R;for(x=[],p=0,d=s.length;d>p;p++){for(V=s[p],E=v[p].edges,u=E.length,3==u?A=3/16:u>3&&(A=3/(8*u)),P=1-u*A,D=A,2>=u&&(2==u?(n&&console.warn("2 connecting edges",E),P=.75,D=1/8):1==u?n&&console.warn("only 1 connecting edge"):0==u&&n&&console.warn("0 connecting edges")),R=V.clone().multiplyScalar(P),w.set(0,0,0),f=0;u>f;f++)F=E[f],b=F.a!==V?F.a:F.b,w.add(b);w.multiplyScalar(D),R.add(w),x.push(R)}c=x.concat(y);var z,I,U,O=x.length;for(h=[],p=0,d=l.length;d>p;p++)S=l[p],z=t(S.a,S.b,g).newEdge+O,I=t(S.b,S.c,g).newEdge+O,U=t(S.c,S.a,g).newEdge+O,o(h,z,I,U),o(h,S.a,z,U),o(h,S.b,I,z),o(h,S.c,U,I);r.vertices=c,r.faces=h},e.QuadTree=function(t){this.name=t.name,this.position=t.corner,this.widthDir=t.widthDir,this.heightDir=t.heightDir,this.planet=t.planet,this.rootNode=new e.TreeNode({parent:void 0,level:0,tree:this,position:this.position})},e.QuadTree.prototype.update=function(){this.rootNode.update()},e.QuadTree.prototype.AssignNeighbors=function(e,t,r,i){this.rootNode.leftNeighbor=e,this.rootNode.topNeighbor=t,this.rootNode.rightNeighbor=r,this.rootNode.bottomNeighbor=i},e.TreeNode=function(e){this.level=e.level,this.parent=e.parent,this.tree=e.tree,this.position=e.position,this.width=2*this.tree.planet.radius/Math.pow(2,this.level),this.halfWidth=this.width/2,this.arcLength=this.width/this.tree.planet.radius,this.center=this.FindCenter(),this.name=this.center.x+":"+this.center.y+":"+this.center.z,this.isSplit=!1,this.isDrawn=!1,this.isOccluded=!1},e.TreeNode.prototype={update:function(){this.OccludedByHorizon()?this.isDrawn&&(this.isOccluded=!0,this.UnDraw()):(this.isOccluded=!1,this.InCameraFrustum()&&(this.GetDistanceFromCamera(),this.isSplit?this.ShouldUnSplit()?(this.UnSplit(),this.update()):this.updateChildren():this.ShouldSplit()&&(this.isDrawn&&this.UnDraw(),this.Split(),this.updateChildren())))},checkNeighbors:function(){this.topNeighbor&&this.topNeighbor.isSplit&&(this.topNeighbor.bottomLeftChild.isSplit||this.topNeighbor.bottomRightChild.isSplit)&&this.Split(),this.rightNeighbor&&this.rightNeighbor.isSplit&&(this.rightNeighbor.bottomLeftChild.isSplit||this.rightNeighbor.topLeftChild.isSplit)&&this.Split(),this.bottomNeighbor&&this.bottomNeighbor.isSplit&&(this.bottomNeighbor.topLeftChild.isSplit||this.bottomNeighbor.topRightChild.isSplit)&&this.Split(),this.leftNeighbor&&this.leftNeighbor.isSplit&&(this.leftNeighbor.topRightChild.isSplit||this.leftNeighbor.bottomRightChild.isSplit)&&this.Split(),this.isSplit&&(this.topNeighbor&&this.topNeighbor.isSplit&&(this.topLeftChild.topNeighbor=this.topNeighbor.bottomLeftChild,this.topRightChild.topNeighbor=this.topNeighbor.bottomRightChild),this.rightNeighbor&&this.rightNeighbor.isSplit&&(this.topRightChild.rightNeighbor=this.rightNeighbor.topLeftChild,this.bottomRightChild.rightNeighbor=this.rightNeighbor.bottomLeftChild),this.bottomNeighbor&&this.bottomNeighbor.isSplit&&(this.bottomLeftChild.bottomNeighbor=this.bottomNeighbor.topLeftChild,this.bottomRightChild.bottomNeighbor=this.bottomNeighbor.topRightChild),this.leftNeighbor&&this.leftNeighbor.isSplit&&(this.topLeftChild.leftNeighbor=this.leftNeighbor.topRightChild,this.bottomLeftChild.leftNeighbor=this.leftNeighbor.bottomRightChild),this.topLeftChild.rightNeighbor=this.topRightChild,
this.topLeftChild.bottomNeighbor=this.bottomLeftChild,this.topRightChild.bottomNeighbor=this.bottomRightChild,this.topRightChild.leftNeighbor=this.topLeftChild,this.bottomLeftChild.topNeighbor=this.topLeftChild,this.bottomLeftChild.rightNeighbor=this.bottomRightChild,this.bottomRightChild.topNeighbor=this.topRightChild,this.bottomRightChild.leftNeighbor=this.bottomLeftChild,(!this.leftNeighbor||this.leftNeighbor&&!this.leftNeighbor.isSplit)&&(this.topLeftChild.checkNeighbors(),this.topRightChild.checkNeighbors(),this.bottomLeftChild.checkNeighbors(),this.bottomRightChild.checkNeighbors()))},Draw:function(){var e;return function(){"use strict";if(this.isSplit)return this.topLeftChild.Draw(),this.topRightChild.Draw(),this.bottomLeftChild.Draw(),void this.bottomRightChild.Draw();if(!this.isDrawn&&!this.isOccluded){this.tree.planet.RemoveFromDeletedMeshes(this.name);for(var t=new Float32Array(this.tree.planet.patchSize*this.tree.planet.patchSize*6*3),r=new Float32Array(this.tree.planet.patchSize*this.tree.planet.patchSize*6*3),i=new Float32Array(this.tree.planet.patchSize*this.tree.planet.patchSize*6*2),o=0,n=0,a=this.tree.planet.patchSize,s=0;a>s;s++)for(var l=0;a>l;l++)e=this.SolvePoint(s/a,l/a),t[o++]=e.x,r[o-1]=t[o-1],t[o++]=e.y,r[o-1]=t[o-1],t[o++]=e.z,r[o-1]=t[o-1],i[n++]=s/a,i[n++]=l/a,e=this.SolvePoint((s+1)/a,l/a),t[o++]=e.x,t[o++]=e.y,t[o++]=e.z,i[n++]=(s+1)/a,i[n++]=l/a,e=this.SolvePoint(s/a,(l+1)/a),t[o++]=e.x,t[o++]=e.y,t[o++]=e.z,i[n++]=s/a,i[n++]=(l+1)/a,t[o++]=t[o-4],t[o++]=t[o-4],t[o++]=t[o-4],i[n++]=s/a,i[n++]=(l+1)/a,t[o++]=t[o-10],t[o++]=t[o-10],t[o++]=t[o-10],i[n++]=(s+1)/a,i[n++]=l/a,e=this.SolvePoint((s+1)/a,(l+1)/a),t[o++]=e.x,t[o++]=e.y,t[o++]=e.z,i[n++]=(s+1)/a,i[n++]=(l+1)/a;this.tree.planet.meshesToAdd.push(t.buffer),this.tree.planet.meshesToAdd.push(r.buffer),this.tree.planet.meshesToAdd.push(i.buffer),this.tree.planet.returnObject.newMeshes.push({name:this.name,width:this.width,center:this.center,positions:t,uvs:i}),this.isDrawn=!0}}}(),SolvePoint:function(){var e,t,r,i;return function(o,n){"use strict";return e=(this.tree.widthDir.x*o+this.tree.heightDir.x*n)*this.width+this.position.x,t=(this.tree.widthDir.y*o+this.tree.heightDir.y*n)*this.width+this.position.y,r=(this.tree.widthDir.z*o+this.tree.heightDir.z*n)*this.width+this.position.z,i=Math.sqrt(e*e+t*t+r*r),e=e/i*this.tree.planet.radius-this.center.x,t=t/i*this.tree.planet.radius-this.center.y,r=r/i*this.tree.planet.radius-this.center.z,{x:e,y:t,z:r}}}(),UnDraw:function(){this.tree.planet.returnObject.deletedMeshes.push(this.name),this.isDrawn=!1},GetDistanceFromCamera:function(){return function(){this.distance=this.tree.planet.localCameraPosition.distanceTo(this.center)}}(),ShouldSplit:function(){return this.tree.planet.log(this.level+" < "+this.tree.planet.maxLevel),this.level<this.tree.planet.maxLevel&&this.tree.planet.splitTable[this.level]>=this.distance},ShouldUnSplit:function(){return this.level>=0&&this.tree.planet.splitTable[this.level]<this.distance},InCameraFrustum:function(){return!0},OccludedByHorizon:function(){var e=this.tree.planet.localCameraPlanetProjectionPosition.angleTo(this.center);return e-=this.arcLength,e>this.tree.planet.localCameraMaxAngle?!0:!1},Split:function(){var t;return function(){this.isSplit||(t={level:this.level+1,parent:this,tree:this.tree},t.position=this.position.clone().add(this.tree.heightDir.clone().multiplyScalar(this.halfWidth)),this.topLeftChild=new e.TreeNode(t),t.position=this.position.clone().add(this.tree.heightDir.clone().multiplyScalar(this.halfWidth)),t.position.add(this.tree.widthDir.clone().multiplyScalar(this.halfWidth)),this.topRightChild=new e.TreeNode(t),t.position=this.position.clone(),this.bottomLeftChild=new e.TreeNode(t),t.position=this.position.clone().add(this.tree.widthDir.clone().multiplyScalar(this.halfWidth)),this.bottomRightChild=new e.TreeNode(t),this.isSplit=!0)}}(),Die:function(){this.isDrawn?this.UnDraw():this.isSplit&&this.UnSplit()},UnSplit:function(){this.isSplit&&(this.topLeftChild.Die(),this.topRightChild.Die(),this.bottomLeftChild.Die(),this.bottomRightChild.Die(),delete this.topLeftChild,delete this.topRightChild,delete this.bottomLeftChild,delete this.bottomRightChild),this.isSplit=!1},updateChildren:function(){this.topLeftChild.update(),this.topRightChild.update(),this.bottomLeftChild.update(),this.bottomRightChild.update()},FindCenter:function(){var t,r,i,o,n,a;return function(){return t=this.position.x,r=this.position.y,i=this.position.z,n=this.tree.widthDir,a=this.tree.heightDir,o=this.halfWidth,t=t+n.x*o+a.x*o,r=r+n.y*o+a.y*o,i=i+n.z*o+a.z*o,new e.Vector3(t,r,i).normalize().multiplyScalar(this.tree.planet.radius)}}()},e.QuadTreeSphere=function(t){e.Object3D.call(this),this.isInitialized=!1,this.pause=!1,this.meshes={},this.meshBuildTimeAvg=0,this.initializeOptions(t),this.initializeWorker(),this.updateCounter=0,this.avg=0},e.QuadTreeSphere.prototype=Object.create(e.Object3D.prototype),e.QuadTreeSphere.prototype.initializeOptions=function(e,t){this.workerPath=e.workerPath||"QuadTreeSphereWorker.min.js",this.configureCamera(e.camera),this.scene=e.scene,this.radius=e.radius,this.patchSize=e.patchSize,this.fov=e.fov,this.quadMaterial=e.quadMaterial},e.QuadTreeSphere.prototype.configureCamera=function(e){this.camera=e,this.cameraHeight=0},e.QuadTreeSphere.prototype.initializeWorker=function(){this.worker=new Worker(this.workerPath),this.worker.onmessage=this.onWorkerMessage.bind(this),this.worker.postMessage({Init:{radius:this.radius,patchSize:this.patchSize,fov:this.fov,screenWidth:screen.width}})},e.QuadTreeSphere.prototype.update=function(){return function(){var e;this.isInitialized&&(e=this.worldToLocal(this.camera.position.clone()),this.cameraHeight=e.length()-this.radius,this.pause||this.worker.postMessage({update:{localCameraPosition:e,started:performance.now()}}))}}(),e.QuadTreeSphere.prototype.onWorkerMessage=function(e){var t=e.data;return t.isInitialized?void(this.isInitialized=!0):void(t.log||(t.deletedMeshes&&t.deletedMeshes.forEach(this.removeMesh.bind(this)),t.newMeshes&&(t.newMeshes.length>0&&(this.updateCounters+=1,this.avg+=performance.now()-t.started,this.meshBuildTimeAvg=this.avg/this.updateCounters,this.updateCounters%10==0&&(this.avg=0,this.updateCounters=0)),t.newMeshes.forEach(this.buildNewMesh.bind(this)))))},e.QuadTreeSphere.prototype.removeMesh=function(e){this.scene.remove(this.meshes[e]),delete this.meshes[e]},e.QuadTreeSphere.prototype.buildNewMesh=function(t){var r=new e.BufferGeometry;r.attributes.position={},r.attributes.position.array=t.positions,r.attributes.position.itemSize=3,r.attributes.uv={},r.attributes.uv.array=t.uvs,r.attributes.uv.itemSize=2,r.computeBoundingSphere();var i=new e.Mesh(r,this.quadMaterial.buildMaterial(new e.Vector3(t.center.x,t.center.y,t.center.z),this.position,this.radius,t.width));i.position.x=t.center.x,i.position.y=t.center.y,i.position.z=t.center.z,i.position.add(this.position),this.scene.add(i),this.meshes[t.name]=i,delete t};var s=function(){self.onmessage=this.handleMessage.bind(this)};s.prototype={handleMessage:function(e){e.data.Init&&this.Init(e.data.Init),e.data.update&&this.update(e.data.update)},log:function(e){self.postMessage({log:e})},update:function(t){this.log("Worker says update called"),this.returnObject={started:t.started,newMeshes:[],deletedMeshes:[]},this.meshesToAdd=[],this.localCameraPosition=new e.Vector3(t.localCameraPosition.x,t.localCameraPosition.y,t.localCameraPosition.z),this.localCameraPlanetProjectionPosition=this.localCameraPosition.clone().normalize().multiplyScalar(this.radius),this.cameraHeight=this.localCameraPosition.length()-this.radius,this.localCameraMaxAngle=Math.acos(this.radius/(this.cameraHeight+this.radius)),this.cameraHeight=this.cameraHeight>0?this.cameraHeight:this.radius+1,this.quadTrees.forEach(function(e){e.rootNode.update()}),this.quadTrees.forEach(function(e){e.rootNode.checkNeighbors()}),this.quadTrees.forEach(function(e){e.rootNode.Draw()}),self.postMessage(this.returnObject,this.meshesToAdd)},RemoveFromDeletedMeshes:function(e){for(var t=0,r=this.returnObject.deletedMeshes;r>t;t++)if(this.returnObject.deletedMeshes[t]==e)return void this.returnObject.deletedMeshes.splice(t,1)},Init:function(e){this.log("Worker says Init called"),this.radius=e.radius,this.patchSize=e.patchSize,this.fov=e.fov,this.vs=Math.tan(this.fov/e.screenWidth),this.quadTrees=[],this.splitTable=[],this.BuildSplitTable(),this.InitQuadTrees(),this.AssignNeighbors(),self.postMessage({isInitialized:!0})},BuildSplitTable:function(){for(var e,t=0,r=this.patchSize;200>t;){if(e=Math.PI*this.radius*2/(6*r),this.splitTable[t]=e/this.vs,r=2*r,this.splitTable[t]<3){this.maxLevel=t;break}t++}},InitQuadTrees:function(){var t=new e.Vector3(1,1,1).multiplyScalar(this.radius),r=t.clone().multiplyScalar(-1);this.quadTrees.push(new e.QuadTree({name:"Bottom",corner:t,widthDir:new e.Vector3(0,0,-1),heightDir:new e.Vector3(-1,0,0),planet:this})),this.quadTrees.push(new e.QuadTree({name:"Front",corner:t,widthDir:new e.Vector3(-1,0,0),heightDir:new e.Vector3(0,-1,0),planet:this})),this.quadTrees.push(new e.QuadTree({name:"Left",corner:t,widthDir:new e.Vector3(0,-1,0),heightDir:new e.Vector3(0,0,-1),planet:this})),this.quadTrees.push(new e.QuadTree({name:"Top",corner:r,widthDir:new e.Vector3(1,0,0),heightDir:new e.Vector3(0,0,1),planet:this})),this.quadTrees.push(new e.QuadTree({name:"Back",corner:r,widthDir:new e.Vector3(0,1,0),heightDir:new e.Vector3(1,0,0),planet:this})),this.quadTrees.push(new e.QuadTree({name:"Right",corner:r,widthDir:new e.Vector3(0,0,1),heightDir:new e.Vector3(0,1,0),planet:this}))},AssignNeighbors:function(){var e=this.quadTrees[0].rootNode,t=this.quadTrees[1].rootNode,r=this.quadTrees[2].rootNode,i=this.quadTrees[3].rootNode,o=this.quadTrees[4].rootNode,n=this.quadTrees[5].rootNode;this.quadTrees[0].AssignNeighbors(r,o,n,t),this.quadTrees[1].AssignNeighbors(r,i,n,e),this.quadTrees[2].AssignNeighbors(e,o,i,t),this.quadTrees[3].AssignNeighbors(n,t,r,o),this.quadTrees[4].AssignNeighbors(i,r,e,n),this.quadTrees[5].AssignNeighbors(o,e,t,i)}},e.QuadTreeSphereBlobWorker=function(){var e=new s,t=URL.createObjectURL(new Blob(["(",e.toString(),")()"],{type:"application/javascript"}));return t};var l=function(){};l.prototype={BuildQuadForGrid:function(){var t,r,i,o,n,a=new e.Vector3(0,0,1);return function(s,l,c,h,u,p){s.vertices.push(l),s.faceVertexUvs.push(c),h&&(t=s.vertices.length-1,r=t,i=t-1,o=t-u,n=t-u-1,p?(s.faces.push(new e.Face3(r,i,n,[a,a,a])),s.faces.push(new e.Face3(r,n,o,[a,a,a]))):(s.faces.push(new e.Face3(o,i,n,[a,a,a])),s.faces.push(new e.Face3(r,i,o,[a,a,a]))))}}()},e.QuadMaterialBuilder=function(e){this.config=e;try{this.config.onCreate()}catch(t){console.error("QuadMaterial onCreate had an error.",t)}},e.QuadMaterialBuilder.prototype={buildMaterial:function(t,r,i,o){try{return this.config.buildMaterialForQuad(t,r,i,o)}catch(n){console.error("Unable to build quad material.",n);var a=new e.Color;return a.r=a.g=a.b=255,new e.MeshBasicMaterial({wireframe:!0,color:a})}}},e.Terrain=function(t,r,i){e.Object3D.call(this),this.radius=r,this.resolution=t,this.clipMapCount=i,this.geometry=new e.PlaneGeometry(1,1,t,t),this.position=new e.Vector3(0,0,0),this.clipMaps=[],this.terrainCamera=new TerrainCamera(r,settings.fov,t,Window.innerWidth),this.clipMapCount=this.terrainCamera.getViewTheta(settings.minPossibleHeight),this.clipMapCount=Math.floor(Math.log(1/(this.clipMapCount/Math.PI))/Math.log(2)),this.createClipMaps()},e.Terrain.prototype=Object.create(e.Object3D.prototype),e.Terrain.prototype={update:function(e){this.updateCameraPosition(e),this.updateClipMaps()},updateCameraPosition:function(e){localCameraPosition.copy(e),this.worldToLocal(localCameraPosition),this.terrainCamera.update(localCameraPosition)},updateClipMaps:function(){for(var e=(this.getViewTheta(this.terrainCamera.height),this.terrainCamera.viewTheta),t=0;t<this.clipMapCount;t++)this.clipMaps[t].theta>e||this.clipMaps[t].theta<e?this.clipMaps[t].hidden||this.clipMaps[t].hide():(this.clipMaps[t].hidden&&this.clipMaps[t].show(),this.clipMaps[t].theta=this.terrainCamera.theta,this.clipMaps[t].phi=this.terrainCamera.phi)},createClipMaps:function(){for(var e=this.radius,t=0;t<this.clipMapCount;t++)this.clipMaps[t]=new ClipMap(e,this.geometry),this.clipMaps[t].theta=this.getViewTheta(e/2),this.children.concat(this.clipMaps[t].meshes),e/=2},getViewTheta:function(e){return Math.acos(this.radius/(this.radius+e))}};var c=function(e,t,r,i){this.fov=t,this.resolution=r,this.pixels=i,this.phi=0,this.theta=0,this.viewTheta=0,this.height=0,this.position=0,this.radius=e};c.prototype={update:function(e){this.phi=Math.atan2(this.localCameraPosition.x,this.localCameraPosition.x),this.theta=Math.acos(this.localCameraPosition.y),this.height=e.length()-this.radius,this.position=e,this.viewTheta=this.getViewTheta(this.height)},getViewTheta:function(e){var t=Math.tan(this.fov/this.pixels),r=e*t/this.radius*this.resolution;return r}};var h={NONE:0,TOP:1,LEFT:2,BOTTOM:4,RIGHT:8},u=function(e,t){this.hidden=!1,this.geo=t,this.meshes=[],this.phi=0,this.theta=0,this.createTile(-e,-e,e,h.NONE),this.createTile(-e,0,e,h.NONE),this.createTile(0,0,e,h.NONE),this.createTile(0,-e,e,h.NONE),this.createTile(-2*e,-2*e,e,h.BOTTOM|h.LEFT),this.createTile(-2*e,-e,e,h.LEFT),this.createTile(-2*e,0,e,h.LEFT),this.createTile(-2*e,e,e,h.TOP|h.LEFT),this.createTile(-e,-2*e,e,h.BOTTOM),this.createTile(-e,e,e,h.TOP),this.createTile(0,-2*e,e,h.BOTTOM),this.createTile(0,e,e,h.TOP),this.createTile(e,-2*e,e,h.BOTTOM|h.RIGHT),this.createTile(e,-e,e,h.RIGHT),this.createTile(e,0,e,h.RIGHT),this.createTile(e,e,e,h.TOP|h.RIGHT)};u.prototype={hide:function(){this.hidden=!0,this.meshes.forEach(function(e){e.visible=!1})},show:function(){this.hidden=!1,this.meshes.forEach(function(e){e.visible=!0})},createTile:function(t,r,i,o){var n=new e.MeshBasicMaterial;this.meshes.push(new e.Mesh(this.geo,n))}}}.apply(t,i),!(void 0!==o&&(e.exports=o))}])});
//# sourceMappingURL=itowns.js.map